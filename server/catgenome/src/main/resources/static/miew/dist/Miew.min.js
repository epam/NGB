/** Miew - 3D Molecular Viewer v0.9.0+20230822.103925.6b542ed Copyright (c) 2015-2023 EPAM Systems, Inc. */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("lodash"),require("three")):"function"==typeof define&&define.amd?define(["lodash","three"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).Miew=t(e._,e.THREE)}(this,function(e,ae){"use strict";function t(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function n(n){if(n&&n.__esModule)return n;var r=Object.create(null);return n&&Object.keys(n).forEach(function(e){var t;"default"!==e&&(t=Object.getOwnPropertyDescriptor(n,e),Object.defineProperty(r,e,t.get?t:{enumerable:!0,get:function(){return n[e]}}))}),r.default=n,Object.freeze(r)}var b=t(e),r=n(ae);var i=function(e){if(Array.isArray(e))return e};var o=function(e,t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e)){var n=[],r=!0,i=!1,o=void 0;try{for(var s,a=e[Symbol.iterator]();!(r=(s=a.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(e){i=!0,o=e}finally{try{r||null==a.return||a.return()}finally{if(i)throw o}}return n}};var s=function(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r};var a=function(e,t){if(e){if("string"==typeof e)return s(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?s(e,t):void 0}};var c=function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")};var m=function(e,t){return i(e)||o(e,t)||a(e,t)||c()},l=function(){return(l=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},u={lines:12,length:7,width:5,radius:10,scale:1,corners:1,color:"#000",fadeColor:"transparent",animation:"spinner-line-fade-default",rotate:0,direction:1,speed:1,zIndex:2e9,className:"spinner",top:"50%",left:"50%",shadow:"0 0 1px transparent",position:"absolute"},h=(f.prototype.spin=function(e){return this.stop(),this.el=document.createElement("div"),this.el.className=this.opts.className,this.el.setAttribute("role","progressbar"),d(this.el,{position:this.opts.position,width:0,zIndex:this.opts.zIndex,left:this.opts.left,top:this.opts.top,transform:"scale("+this.opts.scale+")"}),e&&e.insertBefore(this.el,e.firstChild||null),function(e,t){var n=Math.round(t.corners*t.width*500)/1e3+"px",r="none";!0===t.shadow?r="0 2px 4px #000":"string"==typeof t.shadow&&(r=t.shadow);for(var i=function(e){for(var t=/^\s*([a-zA-Z]+\s+)?(-?\d+(\.\d+)?)([a-zA-Z]*)\s+(-?\d+(\.\d+)?)([a-zA-Z]*)(.*)$/,n=[],r=0,i=e.split(",");r<i.length;r++){var o,s,a,c,l=i[r].match(t);null!==l&&(o=+l[2],s=+l[5],a=l[4],c=l[7],0!=o||a||(a=c),0!=s||c||(c=a),a===c&&n.push({prefix:l[1]||"",x:o,y:s,xUnits:a,yUnits:c,end:l[8]}))}return n}(r),o=0;o<t.lines;o++){var s=~~(360/t.lines*o+t.rotate),a=d(document.createElement("div"),{position:"absolute",top:-t.width/2+"px",width:t.length+t.width+"px",height:t.width+"px",background:p(t.fadeColor,o),borderRadius:n,transformOrigin:"left",transform:"rotate("+s+"deg) translateX("+t.radius+"px)"}),c=o*t.direction/t.lines/t.speed;c-=1/t.speed;c=d(document.createElement("div"),{width:"100%",height:"100%",background:p(t.color,o),borderRadius:n,boxShadow:function(e,t){for(var n=[],r=0,i=e;r<i.length;r++){var o=i[r],s=function(e,t,n){var r=n*Math.PI/180,n=Math.sin(r),r=Math.cos(r);return[Math.round(1e3*(e*r+t*n))/1e3,Math.round(1e3*(-e*n+t*r))/1e3]}(o.x,o.y,t);n.push(o.prefix+s[0]+o.xUnits+" "+s[1]+o.yUnits+o.end)}return n.join(", ")}(i,s),animation:1/t.speed+"s linear "+c+"s infinite "+t.animation});a.appendChild(c),e.appendChild(a)}}(this.el,this.opts),this},f.prototype.stop=function(){return this.el&&(("undefined"!=typeof requestAnimationFrame?cancelAnimationFrame:clearTimeout)(this.animateId),this.el.parentNode&&this.el.parentNode.removeChild(this.el),this.el=void 0),this},f);function f(e){void 0===e&&(e={}),this.opts=l(l({},u),e)}function d(e,t){for(var n in t)e.style[n]=t[n];return e}function p(e,t){return"string"==typeof e?e:e[t%e.length]}var j=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")};function y(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var _=function(e,t,n){return t&&y(e.prototype,t),n&&y(e,n),e},v=function(){function n(){j(this,n),this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}return _(n,[{key:"start",value:function(){this.startTime=n.now(),this.oldTime=this.startTime,this.running=!0}},{key:"stop",value:function(){this.getElapsedTime(),this.running=!1}},{key:"getElapsedTime",value:function(){return this.update(),this.elapsedTime}},{key:"update",value:function(){var e,t=0;return this.running&&(t=.001*((e=n.now())-this.oldTime),this.oldTime=e,this.elapsedTime+=t),t}}]),n}();v.now=(Ks="undefined"!=typeof window&&window.performance)&&Ks.now?Ks.now.bind(Ks):Date.now;var g=v.now;function x(e,t,n){e=document.createElement(e);return e.id=t,e.style.cssText=n,e}var w=function(){function e(){j(this,e),this.domElement=x("div","stats","padding:8px"),this._text=x("p","fps","margin:0;color:silver;font-size:large"),this.domElement.appendChild(this._text),this._startTime=g(),this._prevTime=this._startTime,this._deltas=new Array(20),this._index=0,this._total=0,this._count=0}return _(e,[{key:"end",value:function(){var e=g(),t=e-this._startTime;return this._count<this._deltas.length?this._count++:this._total-=this._deltas[this._index],this._total+=t,this._deltas[this._index]=t,this._index=(this._index+1)%this._deltas.length,this.ms=this._total/this._count,this.fps=1e3/this.ms,e>this._prevTime+1e3&&(this._text.textContent=this.fps.toPrecision(2),this._prevTime=e),e}},{key:"update",value:function(){this._startTime=this.end()}},{key:"show",value:function(e){void 0===e&&(e=!0),this.domElement.style.display=e?"block":"none"}}]),e}(),S="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function R(e,t){return e(t={exports:{}},t.exports),t.exports}var C=R(function(n){function r(e,t){return n.exports=r=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},r(e,t)}n.exports=r});var A=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&C(e,t)},E=R(function(t){function n(e){return"function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?t.exports=n=function(e){return typeof e}:t.exports=n=function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}t.exports=n});var k=function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e};var T=function(e,t){return!t||"object"!==E(t)&&"function"!=typeof t?k(e):t},P=R(function(t){function n(e){return t.exports=n=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},n(e)}t.exports=n});var M=function(e){return-1!==Function.toString.call(e).indexOf("[native code]")};var N=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}},I=R(function(r){function i(e,t,n){return N()?r.exports=i=Reflect.construct:r.exports=i=function(e,t,n){var r=[null];r.push.apply(r,t);r=new(Function.bind.apply(e,r));return n&&C(r,n.prototype),r},i.apply(null,arguments)}r.exports=i}),L=R(function(t){function r(e){var n="function"==typeof Map?new Map:void 0;return t.exports=r=function(e){if(null===e||!M(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==n){if(n.has(e))return n.get(e);n.set(e,t)}function t(){return I(e,arguments,P(this).constructor)}return t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),C(t,e)},r(e)}t.exports=r});function D(e,t){return!e||e===t}function O(){this._handlers={}}O.prototype.addEventListener=function(e,t,n){var r=this._handlers[e];r||(this._handlers[e]=[],r=this._handlers[e]);var i=[t,n];void 0===b.default.find(r,function(e){return e[0]===i[0]&&e[1]===i[1]})&&r.push(i)},O.prototype.removeEventListener=function(n,r,i){var o=this;b.default.forEach(o._handlers,function(e,t){b.default.remove(e,function(e){return D(n,t)&&D(r,e[0])&&D(i,e[1]||o)})}),this._handlers=b.default.omitBy(o._handlers,function(e){return 0===e.length})},O.prototype.dispatchEvent=function(n){var r=this;b.default.forEach(this._handlers[n.type],function(e){var t=e[1]||r;e[0].apply(t,[n])})};var V={debug:0,info:1,report:2,warn:3,error:4};function z(){O.call(this),this.console=!1,this._priority=V.warn}function F(e){if(!b.default.isNumber(e))throw new Error("Wrong log level specified!");return e}((z.prototype=Object.create(O.prototype)).constructor=z).prototype.instantiate=function(){return new z},Object.defineProperty(z.prototype,"level",{get:function(){var t=this;return b.default.findKey(V,function(e){return e===t._priority})},set:function(e){this._priority=F(V[e])}}),z.prototype.levels=function(){return Object.keys(V)},z.prototype.message=function(e,t){e=F(V[e]);this._message(e,t)},z.prototype.debug=function(e){this._message(V.debug,e)},z.prototype.info=function(e){this._message(V.info,e)},z.prototype.report=function(e){this._message(V.report,e)},z.prototype.warn=function(e){this._message(V.warn,e)},z.prototype.error=function(e){this._message(V.error,e)},z.prototype._message=function(t,e){var n;t<this._priority||(n=b.default.findKey(V,function(e){return e===t}),e=String(e),this.console&&"miew:".concat(n,": ").concat(e),this.dispatchEvent({type:"message",level:n,message:e}))};var B=new z;function U(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var G={DEFAULT:0,SAFARI:1};function H(e){return decodeURIComponent(e.replace(/\+/g," "))}function W(e){for(var t,n=(e=e||window.location.search).substring(e.indexOf("?")+1),r=/([^&=]+)=?([^&]*)/g,i=[];null!==(t=r.exec(n));)i.push([H(t[1]),H(t[2])]);return i}function Y(e){var a=!1;this.enable=function(e){a=e};var c=0,t=Object.keys(e);for(var n=0,r=t.length;n<r;++n){var i=t[n],o=e[i];o instanceof Function&&"constructor"!==i&&(e[i]=function(o,s){return function(){var e=Y.spaces.substr(0,2*c);a&&B.debug("".concat(e+s," {")),c++;for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];var i=o.apply(this,n);return c--,a&&B.debug("".concat(e,"} // ").concat(s)),i}}(o,i))}}Y.spaces="                                                                                          ";var X=function(e){A(r,e);var n=U(r);function r(e){var t;return j(this,r),(t=n.call(this)).name="OutOfMemoryError",t.message=e,t}return r}(L(Error));function q(e){for(var t=new Uint8Array(e),n="",r=0;r<t.byteLength;r++)n+=String.fromCharCode(t[r]);return window.btoa(n)}function $(e){for(var t=window.atob(e),n=new Uint8Array(t.length),r=0;r<n.length;++r)n[r]=t[r].charCodeAt(0);return n.buffer}function Z(e){if(b.default.isPlainObject(e))return!0;e=e&&Object.getPrototypeOf(e);return!!e&&!e.hasOwnProperty("constructor")&&Z(e)}function K(e){return e.slice(Math.max(0,e.lastIndexOf("."))||1/0)}function Q(e){var t=e.split(/[:;,]/),e=t.length;return 3<=e&&"base64"===t[e-2]?new Blob([$(t[e-1])]):null}var J=/^[a-zA-Z0-9_]*$/,ee=['"',"",'"'];var ce={browserType:G,encodeQueryComponent:function(e,t){return encodeURIComponent(e).replace(t,function(e){return String.fromCharCode(parseInt(e.substr(1),16))}).replace(/%20/g,"+")},decodeQueryComponent:H,getUrlParameters:W,getUrlParametersAsDict:function(e){for(var t={},n=W(e),r=0;r<n.length;++r){var i=m(n[r],2),o=i[0],i=i[1];t[o]=i}return t},resolveURL:function(e){if("undefined"!=typeof URL)try{return"undefined"!=typeof window?new URL(e,window.location).href:new URL(e).href}catch(e){}if("undefined"==typeof document)return e;var t=document.createElement("a");return t.href=e,t.href},generateRegExp:function(e){for(var t=[],n=0,r=e.length;n<r;++n)t[t.length]=e[n].charCodeAt(0).toString(16);var i=t.join("|");return new RegExp("%(?:".concat(i,")"),"gi")},createElement:function(e,t,n){var r=document.createElement(e);if(t)for(var i=Object.keys(t),o=0,s=i.length;o<s;++o){var a=i[o];r.setAttribute(a,t[a])}if(n)for(n instanceof Array||(n=[n]),o=0,s=n.length;o<s;++o){var c=n[o];"string"==typeof c?r.appendChild(document.createTextNode(c)):c instanceof HTMLElement&&r.appendChild(c)}return r},deriveClass:function(e,t,n,r){return e.prototype=b.default.assign(Object.create(t.prototype),{constructor:e},n),r&&b.default.assign(e,r),e},deriveDeep:function e(t,n){var r=t;if(t instanceof Array)for(r=new Array(t.length),o=0,s=t.length;o<s;++o)r[o]=e(t[o]);else if(t instanceof Object){r=Object.create(t);for(var i=Object.keys(t),o=0,s=i.length;o<s;++o){var a=i[o],c=t[a],l=e(c);l!==c&&(r[a]=l)}n&&0<Object.keys(r).length&&(r=Object.create(r))}return r},hexColor:function(e){return e="0000000".concat(e.toString(16)).substr(-6),"#".concat(e)},DebugTracer:Y,OutOfMemoryError:X,allocateTyped:function(e,t){var n=null;try{n=new e(t)}catch(e){throw e instanceof RangeError?new X(e.message):e}return n},bytesFromBase64:$,bytesToBase64:q,arrayFromBase64:function(e,t){return Array.prototype.slice.call(new t($(e)))},arrayToBase64:function(e,t){return q(new t(e).buffer)},compareOptionsWithDefaults:function(e,t){var n=[];if(t&&e){for(var r=Object.keys(e),i=0;i<r.length;++i){var o=r[i],s=e[o];s instanceof Object||void 0===t[o]||t[o]===s||n.push("".concat(o,":").concat(s))}if(0<n.length)return"!".concat(n.join())}return""},objectsDiff:function i(e,o){var s={};return b.default.forIn(e,function(e,t){var n,r=o[t];Z(e)&&Z(r)?(n=i(e,r),b.default.isEmpty(n)||(s[t]=n)):b.default.isEqual(e,r)||(s[t]=e)}),s},forInRecursive:function(e,o){!function r(e,i){b.default.forIn(e,function(e,t){var n=i+(0<i.length?".":"");e instanceof Object?r(e,n+t):void 0!==e&&o(e,n+t)})}(e,"")},enquoteString:function(e){return b.default.isString(e)?'"'.concat(e.replace(/"/g,'\\"'),'"'):e},unquoteString:function(e){if(!b.default.isString(e))return e;if('"'===e[0]&&'"'===e[e.length-1])return(e=e.slice(1,e.length-1)).replace(/\\"/g,'"');if("'"===e[0]&&"'"===e[e.length-1])return(e=e.slice(1,e.length-1)).replace(/\\'/g,"'");throw new SyntaxError("Incorrect string format, can't unqute it")},getBrowser:function(){return navigator.vendor&&-1<navigator.vendor.indexOf("Apple")&&navigator.userAgent&&-1===navigator.userAgent.indexOf("CriOS")&&-1===navigator.userAgent.indexOf("FxiOS")?G.SAFARI:G.DEFAULT},shotOpen:function(e){"undefined"!=typeof window&&window.open().document.write('<body style="margin:0"><img src="'.concat(e,'" /></body>'))},shotDownload:function(e,t){var n;e&&"data:"===e.substr(0,5)&&(t=t||["screenshot-",+new Date,".png"].join(""),"undefined"!=typeof window&&window.navigator&&window.navigator.msSaveBlob?window.navigator.msSaveBlob(Q(e),t):"undefined"!=typeof document&&((n=document.createElement("a")).download=t,n.innerHTML="download",n.href=window.URL.createObjectURL(Q(e)),document.body.appendChild(n),n.click(),document.body.removeChild(n)))},copySubArrays:function(e,t,n,r){for(var i=0,o=n.length;i<o;++i)for(var s=0;s<r;++s)t[i*r+s]=e[n[i]*r+s]},shallowCloneNode:function(e){var t=e.cloneNode(!0);return t.worldPos=e.worldPos,t},correctSelectorIdentifier:function(e){return J.test(e)?e:(ee[1]=e,ee.join(""))},getFileExtension:K,splitFileName:function(e){var t=K(e);return[e.slice(0,e.length-t.length),t]},download:function(e,t,n){e=new Blob([e]),t=t||["data",+new Date].join(""),t+=n?".".concat(n):e.type||".bin","undefined"!=typeof window&&window.navigator&&window.navigator.msSaveBlob?window.navigator.msSaveBlob(e,t):"undefined"!=typeof document&&((n=document.createElement("a")).download=t,n.innerHTML="download",n.href=window.URL.createObjectURL(e),document.body.appendChild(n),n.click(),document.body.removeChild(n))},concatTypedArraysUnsafe:function(e,t){var n=new e.constructor(e.length+t.length);return n.set(e),n.set(t,e.length),n},mergeTypedArraysUnsafe:function(e){if(e.length<=0)return null;for(var t=e.reduce(function(e,t){return e+t.length},0),n=new e[0].constructor(t),r=0,i=0;r<e.length;r++){var o=e[r].length;n.set(e[r],i),i+=o}return n}};function te(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var ne=function(){A(n,O);var t=te(n);function n(){var e;return j(this,n),(e=t.call(this))._shouldCancel=!1,e}return _(n,[{key:"cancel",value:function(){this._shouldCancel=!0,this.dispatchEvent({type:"cancel"})}},{key:"shouldCancel",value:function(){return this._shouldCancel}},{key:"notify",value:function(e){this.dispatchEvent({type:"notification",slaveEvent:e})}}]),n}(),re={modes:{BS:{atom:.23,bond:.15,space:.5,multibond:!0,aromrad:.1,showarom:!0,polyComplexity:{poor:3,low:4,medium:6,high:12,ultra:32}},VW:{polyComplexity:{poor:4,low:6,medium:8,high:16,ultra:32}},LN:{multibond:!0,showarom:!0,offsarom:.2,chunkarom:10,atom:.23,lineWidth:2},LC:{bond:.2,space:0,multibond:!0,aromrad:.1,showarom:!0,polyComplexity:{poor:3,low:4,medium:6,high:12,ultra:32}},SA:{zClip:!1,probeRadius:1.5,subset:"",wireframe:!1,polyComplexity:{poor:6,low:8,medium:16,high:30,ultra:60}},SE:{zClip:!1,probeRadius:1.5,subset:"",wireframe:!1,polyComplexity:{poor:6,low:8,medium:16,high:30,ultra:60}},QS:{isoValue:.5,gaussLim:{poor:1.5,low:2,medium:2.5,high:3,ultra:4},scale:1,wireframe:!1,gridSpacing:{poor:2,low:1.5,medium:1,high:.5,ultra:.25},subset:"",zClip:!1},CS:{probeRadius:1.4,isoValue:1.5,wireframe:!1,probePositions:30,polyComplexity:{poor:.5,low:1,medium:1.5,high:1.75,ultra:2},subset:"",zClip:!1},TR:{radius:.3,polyComplexity:{poor:12,low:16,medium:32,high:64,ultra:64}},TU:{radius:.3,heightSegmentsRatio:1.5,tension:-.7,polyComplexity:{poor:4,low:6,medium:10,high:18,ultra:34}},CA:{radius:.3,depth:.25,ss:{helix:{width:1,arrow:2},strand:{width:1,arrow:2}},heightSegmentsRatio:1.5,tension:-.7,polyComplexity:{poor:4,low:6,medium:10,high:18,ultra:34}},TX:{template:"{{Chain}}.{{Residue}}{{Sequence}}.{{Name}}",horizontalAlign:"center",verticalAlign:"middle",dx:0,dy:0,dz:1,fg:"none",bg:"0x202020",showBg:!0},VD:{kSigma:1,kSigmaMed:2,kSigmaMax:4,frame:!0,isoMode:!1,polyComplexity:{poor:2,low:3,medium:4,high:8,ultra:10}}},colorers:{EL:{carbon:-1},UN:{color:16777215},CO:{subset:"charged",color:16711680,baseColor:16777215},CB:{color:9474192,factor:.6},SQ:{gradient:"rainbow"},TM:{gradient:"temp",min:5,max:40},OC:{gradient:"reds"},HY:{gradient:"blue-red"},MO:{gradient:"rainbow"}},antialias:!0,camFov:45,camNear:.5,camFar:100,camDistance:2.5,radiusToFit:1,fogNearFactor:.5,fogFarFactor:1,fogAlpha:1,fogColor:0,fogColorEnable:!1,palette:"JM",resolution:"medium",autoResolution:!1,autoPreset:!0,preset:"default",presets:{default:[{mode:"BS",colorer:"EL",selector:"all",material:"SF"}],empty:[],wire:[{mode:"LN",colorer:"EL",selector:"all",material:"SF"}],small:[{mode:"BS",colorer:"EL",selector:"all",material:"SF"}],macro:[{mode:"CA",colorer:"SS",selector:"not hetatm",material:"SF"},{mode:"BS",colorer:"EL",selector:"hetatm and not water",material:"SF"}]},objects:{line:{color:4294967295,dashSize:.3,gapSize:.05}},bg:{color:2105376,transparent:!1},draft:{clipPlane:!1,clipPlaneFactor:.5,clipPlaneSpeed:3e-5},plugins:{},axes:!0,fog:!0,fps:!0,zSprites:!0,isoSurfaceFakeOpacity:!0,suspendRender:!0,nowater:!1,autobuild:!0,fxaa:!0,outline:{on:!1,color:0,threshold:.1,thickness:1},ao:!1,shadow:{on:!1,type:"random",radius:1},autoRotation:0,maxfps:30,fbxprec:4,autoRotationAxisFixed:!0,zooming:!0,picking:!0,pick:"atom",editing:!1,aromatic:!1,singleUnit:!0,stereo:"NONE",interpolateViews:!0,transparency:"prepass",translationSpeed:2,debug:{example:3.5,text:"hello!",good:!0,ssaoKernelRadius:.7,ssaoFactor:.7,stereoBarrel:.25},use:{multiFile:!1}};function ie(){O.call(this),this.old=null,this.now={},this._changed={},this.reset()}ce.deriveClass(ie,O,{defaults:re,set:function(e,t){b.default.isString(e)?b.default.get(this.now,e)!==t&&(b.default.set(this.now,e,t),this._notifyChange(e,t)):(e=ce.objectsDiff(e,this.now),b.default.isEmpty(e)||(b.default.merge(this.now,e),this._notifyChanges(e)))},get:function(e,t){return b.default.get(this.now,e,t)},reset:function(){var e=ce.objectsDiff(re,this.now);this.now=b.default.cloneDeep(re),this.old=null,this._notifyChanges(e),this._changed={}},checkpoint:function(){this.old=b.default.cloneDeep(this.now),this._changed={}},_notifyChange:function(e,t){this._changed[e]=!0,this.dispatchEvent({type:"change:".concat(e),value:t})},_notifyChanges:function(e){var n=this;ce.forInRecursive(e,function(e,t){n._notifyChange(t,e)})},changed:function(){if(!this.old)return[];var t=this.old,n=this.now;return b.default.filter(Object.keys(this._changed),function(e){return b.default.get(t,e)!==b.default.get(n,e)})},applyDiffs:function(e){if(e.hasOwnProperty("VERSION")&&0!==e.VERSION)throw new Error("Settings version does not match!");delete e.VERSION,this.reset(),this.set(e)},getDiffs:function(e){var t=ce.objectsDiff(this.now,re);return e&&(t.VERSION=0),t},setPluginOpts:function(e,t){re.plugins[e]=b.default.cloneDeep(t),this.now.plugins[e]=b.default.cloneDeep(t)}});var oe=new ie,se=0;function le(e){return!(!e||"0"===e||b.default.isString(e)&&"false"===e.toLowerCase())}var ue={string:String,number:Number,boolean:le},he="!",fe=":",de=",";var pe=ce.generateRegExp("$;@/?:,");function me(e){return ce.encodeQueryComponent(e,pe)}var ye=ce.generateRegExp("$;@/? ");function _e(e){return ce.encodeQueryComponent(e,ye)}function ve(e){var t,n,r,i=e.reps;i||((i=(t=oe.now.presets)[r=e.preset||oe.now.preset])||(B.warn('Unknown preset "'.concat(r,'"')),n=Object.keys(t),i=t[r=m(n,1)[0]]),e.preset=r,e.reps=ce.deriveDeep(i,!0))}function ge(e,t,n){ve(e);var r=e.reps[se];r.hasOwnProperty(t)&&(se=e.reps.length,e.reps[se]=ce.deriveDeep(r,!0)),void 0!==n&&(e.reps[se][t]=n)}function xe(r,e,t){var n,i,o,s,a;return r&&(n=r.indexOf(he),s=r.substr(0,0<=n?n:void 0),a=t,s=0<=(t=s.indexOf(","))?(a.push(s.substr(t+1).split(",")),s.substr(0,t)):s,0<=n?(n=r.substr(n+1).split(de),r=s,e&&(i=e[r],o=ce.deriveDeep(i,!0),n.forEach(function(e){var t=e.split(fe,2),n=decodeURIComponent(t[0]),e=decodeURIComponent(t[1]),t=ue[E(b.default.get(i,n))];t?b.default.set(o,n,t(e)):B.warn('Unknown argument "'.concat(n,'" for option "').concat(r,'"'))}),0<Object.keys(o).length&&(r=[r,o]))):r=s),r}var be={l:"load",load:String,t:"type",type:String,v:"view",view:String,u:"unit",unit:Number,menu:le,o:"object",object:function(e,t){var n=[],e=xe(e,oe.defaults.objects,n);Array.isArray(e)||(e=[e]),function(e,t,n){void 0===e._objects&&(e._objects=[]);var n=(r=m(n,2))[0],r=r[1],t={type:n,params:t};void 0!==r&&(t.opts=r),e._objects[e._objects.length]=t}(t,n[0],e)},p:"preset",preset:function(e,t){t.preset=e,t.reps=null,ve(t)},r:"rep",rep:function(e,t){ve(t),(se=(se=Number(e))<=t.reps.length?se<0?0:se:t.reps.length)===t.reps.length&&(t.reps[se]=0<se?ce.deriveDeep(t.reps[se-1],!0):ce.deriveDeep(oe.defaults.presets.default[0],!0))},s:"select",select:function(e,t){ge(t,"selector",e)},m:"mode",mode:function(e,t){ge(t,"mode",xe(e,oe.defaults.modes))},c:"color",color:function(e,t){ge(t,"colorer",xe(e,oe.defaults.colorers))},mt:"material",material:function(e,t){ge(t,"material",xe(e,oe.defaults.materials))},dup:function(e,t){ve(t);var n=t.reps,t=n[se];n[se=n.length]=ce.deriveDeep(t,!0)},ar:"autoResolution"};function we(e){for(var t={},n=se=0,r=e.length;n<r;++n){for(var i,o=e[n],s=o[0],o=o[1],a=be[s];b.default.isString(a);)a=be[s=a];a?!b.default.isFunction(a)||void 0!==(i=a(o,t))&&(t[s]=i):(i=ue[E(b.default.get(oe.defaults,s))])?b.default.set(t,"settings.".concat(s),i(o)):B.warn('Unknown option "'.concat(s,'"'))}return t}function Se(e){var n=[],r=0;return ce.forInRecursive(e,function(e,t){n[r++]=_e(t)+fe+_e(e)}),n.join(de)}function Re(e){return b.default.isArray(e)?e.length<2?e[0]:"".concat(e[0]).concat(he).concat(Se(e[1])):e}function Ce(e){var n=[],r=0;return ce.forInRecursive(e,function(e,t){n[r++]="".concat(t,"=").concat(ce.enquoteString(e))}),n.join(" ")}function Ae(e){return b.default.isArray(e)?e.length<2?e[0]:"".concat(e[0]," ").concat(Ce(e[1])):e}var Ee={fromURL:function(e){return we(ce.getUrlParameters(e))},fromAttr:function(e){return we(ce.getUrlParameters("?".concat(e||"")))},adapters:ue,toURL:function(e){var n=[],r=0;function i(e,t){null!=t&&(n[r++]=me(e)+"="+me(t))}i("l",e.load),i("u",e.unit),i("p",e.preset),function(e){if(e)for(var t=0,n=e.length;t<n;++t)b.default.isEmpty(e[t])||(i("r",t),i("s",e[t].selector),i("m",Re(e[t].mode)),i("c",Re(e[t].colorer)),i("mt",Re(e[t].material)))}(e.reps),function(e){if(e)for(var t=0,n=e.length;t<n;++t)i("o",function(e){if(e&&e.type){var t=e.type;return b.default.isArray(e.params)&&0<e.params.length&&(t+=",".concat(e.params.join(","))),e.opts&&(t+=he+Se(e.opts)),t}}(e[t]))}(e._objects),i("v",e.view),ce.forInRecursive(e.settings,function(e,t){"preset"!==t&&i(t,e)});var t="";return"undefined"!=typeof window&&(t="".concat((e=window.location).protocol,"//").concat(e.host).concat(e.pathname)),0<n.length&&(t+="?".concat(n.join("&"))),t},toScript:function(e){var r=[],i=0;function o(e,t,n){null!=t&&(n="string"==typeof t&&n?'"':"",r[i++]="".concat(e," ").concat(n).concat(t).concat(n).trim())}return o("set","autobuild false"),o("load",e.load,!0),o("unit",e.unit),o("preset",e.preset),function(e){if(e)for(var t=0,n=e.length;t<n;++t)o("rep",function(e,t){var n=[],r=0;function i(e,t){null!=t&&(n[r++]=e+t)}return b.default.isEmpty(e)?null:(i("",t),i("s=",ce.enquoteString(e.selector)),i("m=",Ae(e.mode)),i("c=",Ae(e.colorer)),i("mt=",Ae(e.material)),n.join(" "))}(e[t],t))}(e.reps),function(e){if(e)for(var t=0,n=e.length;t<n;++t)o("",function(e){if(e&&e.type){var t=e.type;return b.default.isArray(e.params)&&0<e.params.length&&(t+=" ".concat(e.params.map(ce.enquoteString).join(" "))),e.opts&&(t+=" ".concat(Ce(e.opts))),t}}(e[t]))}(e._objects),ce.forInRecursive(e.settings,function(e,t){"preset"!==t&&o("set ".concat(t),e,!0)}),o("view",e.view),o("set","autobuild true"),r.join("\n")}};var ke=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e},Te=function(){function h(e,t,n,r,i,o,s,a,c,l,u){j(this,h),this.index=-1,this.residue=e,this.name=t,this.element=n,this.position=r,this.role=i,this.mask=1,this.het=o,this.serial=s,this.location=(a||" ").charCodeAt(0),this.occupancy=c||1,this.temperature=l,this.charge=u,this.hydrogenCount=-1,this.radicalCount=0,this.valence=-1,this.bonds=[],this.flags=0,"H"===n.name?this.flags|=h.Flags.HYDROGEN:"C"===n.name&&(this.flags|=h.Flags.CARBON)}return _(h,[{key:"isHet",value:function(){return this.het}},{key:"isHydrogen",value:function(){return 1===this.element.number}},{key:"getVisualName",value:function(){var e=this.name;return 0<e.length?e:this.element.name.trim()}},{key:"forEachBond",value:function(e){for(var t=this.bonds,n=0,r=t.length;n<r;++n)e(t[n])}},{key:"getFullName",value:function(){var e="";return null!==this.residue&&(null!==this.residue._chain&&(e+="".concat(this.residue._chain.getName(),".")),e+="".concat(this.residue._sequence,".")),e+=this.name}}]),h}();ke(Te,"Flags",{CARBON:1,HYDROGEN:8,NONPOLARH:4104});function Pe(e,t,n,r,i,o,s){j(this,Pe),this.number=e,this.name=t,this.fullName=n,this.weight=r,this.radius=i,this.radiusBonding=o,this.hydrogenValency=s}ke(Pe,"Constants",{U1:1,Lead:2,U2:3,Wing:4,U18:18}),ke(Pe,"Role",{N:Pe.Constants.U1,CA:Pe.Constants.Lead,C:Pe.Constants.U2,O:Pe.Constants.Wing,SG:Pe.Constants.U18}),ke(Pe,"ByAtomicNumber",[null,new Pe(1,"H","Hydrogen",1.008,1.2,.23,[1]),new Pe(2,"HE","Helium",4.003,1.4,.93,[0]),new Pe(3,"LI","Lithium",6.941,1.82,.68,[1]),new Pe(4,"BE","Beryllium",9.012,1.7,.35,[2]),new Pe(5,"B","Boron",10.81,2.08,.83,[3]),new Pe(6,"C","Carbon",12.011,1.95,.68,[4]),new Pe(7,"N","Nitrogen",14.007,1.85,.68,[3,5]),new Pe(8,"O","Oxygen",15.999,1.7,.68,[2,4]),new Pe(9,"F","Fluorine",18.998,1.73,.64,[1]),new Pe(10,"NE","Neon",20.18,1.54,1.12,[0]),new Pe(11,"NA","Sodium",22.99,2.27,.97,[1]),new Pe(12,"MG","Magnesium",24.305,1.73,1.1,[2]),new Pe(13,"AL","Aluminum",26.981,2.05,1.35,[3]),new Pe(14,"SI","Silicon",28.086,2.1,1.2,[4]),new Pe(15,"P","Phosphorus",30.974,2.08,.75,[3,5]),new Pe(16,"S","Sulfur",32.07,2,1.02,[2,4,6]),new Pe(17,"CL","Chlorine",35.453,1.97,.99,[1,3,5,7]),new Pe(18,"AR","Argon",39.948,1.88,1.57,[0]),new Pe(19,"K","Potassium",39.1,2.75,1.33,[1]),new Pe(20,"CA","Calcium",40.08,1.973,.99,[2]),new Pe(21,"SC","Scandium",44.956,1.7,1.44,[0]),new Pe(22,"TI","Titanium",47.88,1.7,1.47,[0]),new Pe(23,"V","Vanadium",50.941,1.7,1.33,[0]),new Pe(24,"CR","Chromium",52,1.7,1.35,[0]),new Pe(25,"MN","Manganese",54.938,1.7,1.35,[0]),new Pe(26,"FE","Iron",55.847,1.7,1.34,[0]),new Pe(27,"CO","Cobalt",58.93,1.7,1.33,[0]),new Pe(28,"NI","Nickel",58.69,1.63,1.5,[0]),new Pe(29,"CU","Copper",63.55,1.4,1.52,[0]),new Pe(30,"ZN","Zinc",65.39,1.39,1.45,[0]),new Pe(31,"GA","Gallium",69.72,1.87,1.22,[3]),new Pe(32,"GE","Germanium",72.61,1.7,1.17,[4]),new Pe(33,"AS","Arsenic",74.92,1.85,1.21,[3,5]),new Pe(34,"SE","Selenium",78.96,1.9,1.22,[2,4,6]),new Pe(35,"BR","Bromine",79.9,2.1,1.21,[1,3,5,7]),new Pe(36,"KR","Krypton",83.8,2.02,1.91,[0]),new Pe(37,"RB","Rubidium",85.47,1.7,1.47,[1]),new Pe(38,"SR","Strontium",87.62,1.7,1.12,[2]),new Pe(39,"Y","Yttrium",88.91,1.7,1.78,[0]),new Pe(40,"ZR","Zirconium",91.22,1.7,1.56,[0]),new Pe(41,"NB","Niobium",92.91,1.7,1.48,[0]),new Pe(42,"MO","Molybdenum",95.94,1.7,1.47,[0]),new Pe(43,"TC","Technetium",98.91,1.7,1.35,[0]),new Pe(44,"RU","Ruthenium",101.07,1.7,1.4,[0]),new Pe(45,"RH","Rhodium",102.91,1.7,1.45,[0]),new Pe(46,"PD","Palladium",106.42,1.63,1.5,[0]),new Pe(47,"AG","Silver",107.87,1.72,1.59,[0]),new Pe(48,"CD","Cadmium",112.41,1.58,1.69,[0]),new Pe(49,"IN","Indium",114.82,1.93,1.63,[3]),new Pe(50,"SN","Tin",118.71,2.17,1.46,[2,4]),new Pe(51,"SB","Antimony",121.75,2.2,1.46,[3,5]),new Pe(52,"TE","Tellurium",127.6,2.06,1.47,[2,4,6]),new Pe(53,"I","Iodine",126.91,2.15,1.4,[1,3,5,7]),new Pe(54,"XE","Xenon",131.29,2.16,1.98,[0]),new Pe(55,"CS","Cesium",132.91,1.7,1.67,[1]),new Pe(56,"BA","Barium",137.33,1.7,1.34,[2]),new Pe(57,"LA","Lanthanum",138.91,1.7,1.87,[0]),new Pe(58,"CE","Cerium",140.12,1.7,1.83,[0]),new Pe(59,"PR","Praseodymium",140.91,1.7,1.82,[0]),new Pe(60,"ND","Neodymium",144.24,1.7,1.81,[0]),new Pe(61,"PM","Promethium",144.9,1.7,1.8,[0]),new Pe(62,"SM","Samarium",150.36,1.7,1.8,[0]),new Pe(63,"EU","Europium",151.96,1.7,1.99,[0]),new Pe(64,"GD","Gadolinium",157.25,1.7,1.79,[0]),new Pe(65,"TB","Terbium",158.93,1.7,1.76,[0]),new Pe(66,"DY","Dysprosium",162.5,1.7,1.75,[0]),new Pe(67,"HO","Holmium",164.93,1.7,1.74,[0]),new Pe(68,"ER","Erbium",167.26,1.7,1.73,[0]),new Pe(69,"TM","Thulium",168.93,1.7,1.72,[0]),new Pe(70,"YB","Ytterbium",173.04,1.7,1.94,[0]),new Pe(71,"LU","Lutetium",174.97,1.7,1.72,[0]),new Pe(72,"HF","Hafnium",178.49,1.7,1.57,[0]),new Pe(73,"TA","Tantalum",180.95,1.7,1.43,[0]),new Pe(74,"W","Tungsten",183.85,1.7,1.37,[0]),new Pe(75,"RE","Rhenium",186.21,1.7,1.35,[0]),new Pe(76,"OS","Osmium",190.2,1.7,1.37,[0]),new Pe(77,"IR","Iridium",192.22,1.7,1.32,[0]),new Pe(78,"PT","Platinum",195.08,1.72,1.5,[0]),new Pe(79,"AU","Gold",196.97,1.66,1.5,[0]),new Pe(80,"HG","Mercury",200.59,1.55,1.7,[0]),new Pe(81,"TL","Thallium",204.38,1.96,1.55,[1,3]),new Pe(82,"PB","Lead",207.2,2.02,1.54,[2,4]),new Pe(83,"BI","Bismuth",208.98,1.7,1.54,[3,5]),new Pe(84,"PO","Polonium",210,1.7,1.68,[2,4,6]),new Pe(85,"AT","Astatine",210,1.7,1.7,[1,3,5,7]),new Pe(86,"RN","Radon",222,1.7,2.4,[0]),new Pe(87,"FR","Francium",223,1.7,2,[1]),new Pe(88,"RA","Radium",226.03,1.7,1.9,[2]),new Pe(89,"AC","Actinium",227.03,1.7,1.88,[0]),new Pe(90,"TH","Thorium",232.04,1.7,1.79,[0]),new Pe(91,"PA","Protactinium",231.04,1.7,1.61,[0]),new Pe(92,"U","Uranium",238.03,1.86,1.58,[0]),new Pe(93,"NP","Neptunium",237.05,1.7,1.55,[0]),new Pe(94,"PU","Plutonium",239.1,1.7,1.53,[0]),new Pe(95,"AM","Americium",243.1,1.7,1.51,[0]),new Pe(96,"CM","Curium",247.1,1.7,1.5,[0]),new Pe(97,"BK","Berkelium",247.1,1.7,1.5,[0]),new Pe(98,"CF","Californium",252.1,1.7,1.5,[0]),new Pe(99,"ES","Einsteinium",252.1,1.7,1.5,[0]),new Pe(100,"FM","Fermium",257.1,1.7,1.5,[0]),new Pe(101,"MD","Mendelevium",256.1,1.7,1.5,[0]),new Pe(102,"NO","Nobelium",259.1,1.7,1.5,[0]),new Pe(103,"LR","Lawrencium",260.1,1.7,1.5,[0]),new Pe(104,"RF","Rutherfordium",261,1.7,1.6,[0]),new Pe(105,"DB","Dubnium",262,1.7,1.6,[0]),new Pe(106,"SG","Seaborgium",263,1.7,1.6,[0]),new Pe(107,"BH","Bohrium",262,1.7,1.6,[0]),new Pe(108,"HS","Hassium",265,1.7,1.6,[0]),new Pe(109,"MT","Meitnerium",268,1.7,1.6,[0])]),ke(Pe,"ByName",{D:new Pe(1,"D","Deuterium",2.014,1.2,.23,[1]),T:new Pe(1,"T","Tritium",3.016,1.2,.23,[1])}),function(){for(var e=Pe.ByAtomicNumber,t=Pe.ByName,n=0,r=e.length;n<r;++n){var i=e[n];i&&(t[i.name]=i)}}(),Pe.getByName=function(e){return Pe.ByName[e]||(Pe.ByName[e]=new Pe(0,e,"Unknown",0,1,.01,[0]))};var Me={UNKNOWN:0,COVALENT:1,AROMATIC:2};function Ne(e){return e.position}var Ie=function(){function o(e,t,n,r,i){if(j(this,o),this._left=e,this._right=t,this._fixed=i,this._index=-1,t<e)throw new Error("In a bond atom indices must be in increasing order");this._order=n,this._type=r}return _(o,[{key:"getLeft",value:function(){return this._left}},{key:"getRight",value:function(){return this._right}},{key:"getOrder",value:function(){return this._order}},{key:"calcLength",value:function(){return this._left.position.distanceTo(this._right.position)}},{key:"_forEachNeighbour",value:function(e,t){for(var n=e.bonds,r=0,i=n.length;r<i;++r)t(n[r]._left!==e?n[r]._left:n[r]._right)}},{key:"forEachLevelOne",value:function(t){var n=this._left,r=this._right;this._forEachNeighbour(n,function(e){e!==r&&t(e)}),this._forEachNeighbour(r,function(e){e!==n&&t(e)})}},{key:"forEachLevelTwo",value:function(t){var n=this._left,r=this._right,i=this;i._forEachNeighbour(n,function(e){e!==r&&i._forEachNeighbour(e,function(e){e!==n&&t(e)})}),i._forEachNeighbour(r,function(e){e!==n&&i._forEachNeighbour(e,function(e){e!==r&&t(e)})})}},{key:"_fixDir",value:function(t,n,r){var i=0,o=0,s=t.clone();function a(e){s.copy(r(e)),s.sub(t),0<n.dot(s)?++i:++o}function e(e){"C"===e.element.name&&a(e)}for(var c=[[this.forEachLevelOne,e],[this.forEachLevelOne,a],[this.forEachLevelTwo,e],[this.forEachLevelTwo,a]],l=0;l<c.length;++l){if(c[l][0].call(this,c[l][1]),i<o)return n.multiplyScalar(-1);if(o<i)return n}return n}},{key:"calcNormalDir",value:function(e){var t=this._left,n=this._right,r=t,i=n;e=void 0===e?Ne:e,t.bonds.length>n.bonds.length&&(r=n,i=t);for(var o=r,s=0,a=i.bonds,c=0,l=a.length;c<l;++c){var u=a[c]._left;a[c]._left===i&&(u=a[c]._right),u.bonds.length>s&&u!==r&&(s=(o=u).bonds.length)}var h=e(i),n=e(r).clone().sub(h),t=e(o).clone().sub(h);return t.crossVectors(n,t),t.lengthSq()<1e-4&&t.set(0,1,0),n.normalize(),t.normalize(),n.crossVectors(t,n),n.lengthSq()<1e-4&&n.set(0,1,0),n.normalize(),this._fixDir(h,n,e)}}]),o}();ke(Ie,"BondType",Me),Ie.prototype.BondType=Me;var Le=["C3'","C3*","P","H5T","H3T"],De=["OP1","O1P"],Oe=["OP2","O2P"],Ve=["C3'","C3*","C1","C1'","C1*","P"],ze=[{types:["A","DA","G","DG"],atoms:["N1"]},{types:["C","DC"],atoms:["N3"]},{types:["T","DT","U","DU"],atoms:["O4"]}],Fe=function(){function i(e,t,n,r){j(this,i),this._chain=e,this._component=null,this._type=t,this._sequence=n,this._icode=r,this._mask=1,this._index=-1,this._atoms=[],this._secondary=null,this._firstAtom=null,this._leadAtom=null,this._wingAtom=null,this._lastAtom=null,this._controlPoint=null,this._midPoint=null,this._wingVector=null,this._cylinders=null,this._isValid=!0,this._het=!1,this._molecule=null,this.temperature=null,this.occupancy=null}return _(i,[{key:"getChain",value:function(){return this._chain}},{key:"getMolecule",value:function(){return this._molecule}},{key:"getType",value:function(){return this._type}},{key:"getSequence",value:function(){return this._sequence}},{key:"getSecondary",value:function(){return this._secondary}},{key:"getICode",value:function(){return this._icode}},{key:"addAtom",value:function(e,t,n,r,i,o,s,a,c,l){l=new Te(this,e,t,n,r,i,o,s,a,c,l);return this._chain.getComplex().addAtom(l),this._atoms.push(l),this._het=this._het||i,l}},{key:"getAtomCount",value:function(){return this._atoms.length}},{key:"forEachAtom",value:function(e){for(var t=this._atoms,n=0,r=t.length;n<r&&!e(t[n]);++n);}},{key:"_findAtomByName",value:function(t){var n=null;return this.forEachAtom(function(e){return e.name===t&&(n=e,!0)}),n}},{key:"_findFirstAtomInList",value:function(e){for(var t=null,n=0;n<e.length;++n)if(null!==(t=this._findAtomByName(e[n])))return t;return t}},{key:"collectMask",value:function(){for(var e=4294967295,t=this._atoms,n=0,r=t.length;n<r;++n)e&=t[n].mask;this._mask=e}},{key:"getCylinderTargetList",value:function(){for(var e=this._type._name,t=0,n=ze.length;t<n;++t)for(var r=0,i=ze[t].types.length;r<i;++r)if(e===ze[t].types[r])return ze[t].atoms;return null}},{key:"_detectLeadWing",value:function(e,t,n){var r=this._findFirstAtomInList(Le),i=this._findFirstAtomInList(De),o=this._findFirstAtomInList(Oe);null===i&&null!==t&&(i=t._findFirstAtomInList(De)),null===o&&null!==t&&(o=t._findFirstAtomInList(Oe)),null!==r&&null!==i&&null!==o&&(e._leadAtom=r,e._controlPoint=n(r),e._wingVector=n(o).clone().sub(n(i)),e._isValid=!0,o=this._findFirstAtomInList(Ve),i=null!==(i=this.getCylinderTargetList())?this._findFirstAtomInList(i):null,null!==o&&null!==i&&(e._cylinders=[n(o),n(i)]))}},{key:"calcWing",value:function(e,t,n,r){t=t.clone().sub(e),n=e.clone().sub(n);return n.crossVectors(t,n),n.crossVectors(t,n).normalize(),null!==r&&1e-4<r.length()&&1e-4<n.length()&&Math.abs(r.angleTo(n))>Math.PI/2&&n.negate(),n}},{key:"_innerFinalize",value:function(e,t,n,r,i,o){var s=null===t,a=o(this._leadAtom),a=new ae.Vector3(a.x,a.y,a.z);i?this._detectLeadWing(r,n,o):(s?r._midPoint=o(this._firstAtom).clone():(s=t._controlPoint,r._midPoint=s.clone().lerp(a,.5),r._wingVector=this.calcWing(s,a,o(e._wingAtom),t._wingVector)),r._controlPoint=a)}},{key:"_finalize2",value:function(e,t,n){this._innerFinalize(e,e,t,this,n,function(e){return e.position})}},{key:"isConnected",value:function(o){if(this._chain!==o._chain)return!1;if(this===o)return!0;var s=!1;return this.forEachAtom(function(e){for(var t=e.bonds,n=0,r=t.length;n<r;++n){var i=t[n];if(i._left.residue===o||i._right.residue===o)return s=!0}return!1}),s}},{key:"_finalize",value:function(){var t=this,e=m(this._atoms,1);this._firstAtom=e[0],this._lastAtom=this._atoms[this._atoms.length-1],this._leadAtom=null,this._wingAtom=null;var n=0,r=0,i=0,o=0;this.forEachAtom(function(e){return null===t._leadAtom&&e.role===Pe.Constants.Lead&&(t._leadAtom=e),null===t._wingAtom&&e.role===Pe.Constants.Wing&&(t._wingAtom=e),e.temperature&&(r+=e.temperature,n++),e.occupancy&&(o+=e.occupancy,i++),null!==t._leadAtom&&null!==t._wingAtom}),0<n&&(this.temperature=r/n),0<i&&(this.occupancy=o/i),null!==this._leadAtom&&null!==this._wingAtom||(this._isValid=!1),null===this._leadAtom&&(this._leadAtom=this._firstAtom),null===this._wingAtom&&(this._wingAtom=this._lastAtom)}}]),i}(),Be=function(){function r(e,t,n){j(this,r),this._name=e,this._fullName=t,this.letterCode=n,this.flags=0}return _(r,[{key:"getName",value:function(){return this._name}}]),r}();function Ue(e,t){for(var n=0,r=t.length;n<r;++n){var i=Be.StandardTypes[t[n]];i&&(i.flags|=e)}}ke(Be,"StandardTypes",{ALA:new Be("ALA","Alanine","A"),ARG:new Be("ARG","Arginine","R"),ASN:new Be("ASN","Asparagine","N"),ASP:new Be("ASP","Aspartic Acid","D"),CYS:new Be("CYS","Cysteine","C"),GLN:new Be("GLN","Glutamine","Q"),GLU:new Be("GLU","Glutamic Acid","E"),GLY:new Be("GLY","Glycine","G"),HIS:new Be("HIS","Histidine","H"),ILE:new Be("ILE","Isoleucine","I"),LEU:new Be("LEU","Leucine","L"),LYS:new Be("LYS","Lysine","K"),MET:new Be("MET","Methionine","M"),PHE:new Be("PHE","Phenylalanine","F"),PRO:new Be("PRO","Proline","P"),PYL:new Be("PYL","Pyrrolysine","O"),SEC:new Be("SEC","Selenocysteine","U"),SER:new Be("SER","Serine","S"),THR:new Be("THR","Threonine","T"),TRP:new Be("TRP","Tryptophan","W"),TYR:new Be("TYR","Tyrosine","Y"),VAL:new Be("VAL","Valine","V"),A:new Be("A","Adenine","A"),C:new Be("C","Cytosine","C"),G:new Be("G","Guanine","G"),I:new Be("I","Inosine","I"),T:new Be("T","Thymine","T"),U:new Be("U","Uracil","U"),DA:new Be("DA","Adenine","A"),DC:new Be("DC","Cytosine","C"),DG:new Be("DG","Guanine","G"),DI:new Be("DI","Inosine","I"),DT:new Be("DT","Thymine","T"),DU:new Be("DU","Uracil","U"),"+A":new Be("+A","Adenine","A"),"+C":new Be("+C","Cytosine","C"),"+G":new Be("+G","Guanine","G"),"+I":new Be("+I","Inosine","I"),"+T":new Be("+T","Thymine","T"),"+U":new Be("+U","Uracil","U"),WAT:new Be("WAT","Water",""),H2O:new Be("H2O","Water",""),HOH:new Be("HOH","Water",""),DOD:new Be("DOD","Water",""),UNK:new Be("UNK","Unknown",""),UNL:new Be("UNL","Unknown Ligand","")}),ke(Be,"Flags",{PROTEIN:1,BASIC:2,ACIDIC:4,POLAR:8,NONPOLAR:16,AROMATIC:32,NUCLEIC:256,PURINE:512,PYRIMIDINE:1024,DNA:2048,RNA:4096,WATER:65536});var Ge=Be.Flags;Ue(Ge.WATER,["WAT","H2O","HOH","DOD"]),Ue(Ge.PROTEIN,["ALA","ARG","ASN","ASP","CYS","GLY","GLU","GLN","HIS","ILE","LEU","LYS","MET","PHE","PRO","PYL","SEC","SER","THR","TRP","TYR","VAL"]),Ue(Ge.BASIC,["ARG","HIS","LYS"]),Ue(Ge.ACIDIC,["ASP","GLU"]),Ue(Ge.POLAR,["ASN","CYS","GLN","SER","THR","TYR"]),Ue(Ge.NONPOLAR,["ALA","ILE","LEU","MET","PHE","PRO","TRP","VAL","GLY"]),Ue(Ge.AROMATIC,["PHE","TRP","TYR"]),Ue(Ge.NUCLEIC,["A","G","I","DA","DG","DI","+A","+G","+I","C","T","U","DC","DT","DU","+C","+T","+U"]),Ue(Ge.PURINE,["A","G","I","DA","DG","DI","+A","+G","+I"]),Ue(Ge.PYRIMIDINE,["C","T","U","DC","DT","DU","+C","+T","+U"]),Ue(Ge.DNA,["DA","DG","DI","DC","DT","DU"]),Ue(Ge.RNA,["A","G","I","C","T","U"]);!function(e,t){for(var n=Object.keys(t),r=0,i=n.length;r<i;++r){var o=n[r],s=t[o];Be.StandardTypes[o][e]=s}}("hydrophobicity",{ILE:4.5,VAL:4.2,LEU:3.8,PHE:2.8,CYS:2.5,MET:1.9,ALA:1.8,GLY:-.4,THR:-.7,SER:-.8,TRP:-.9,TYR:-1.3,PRO:-1.6,HIS:-3.2,GLU:-3.5,GLN:-3.5,ASP:-3.5,ASN:-3.5,LYS:-3.9,ARG:-4.5});var je=0,He=1,We=2,Ye=function(){function n(e,t){j(this,n),this._complex=e,this._name=t,this._mask=1,this._index=-1,this._residues=[],this.minSequence=Number.POSITIVE_INFINITY,this.maxSequence=Number.NEGATIVE_INFINITY}return _(n,[{key:"getComplex",value:function(){return this._complex}},{key:"getName",value:function(){return this._name}},{key:"getResidues",value:function(){return this._residues}},{key:"_determineType",value:function(){var e=this._residues,t=Be.Flags,n=t.PROTEIN,r=t.NUCLEIC;this.type=je;for(var i=0,o=e.length;i<o;++i){var s=e[i]._type.flags;if(0!=(s&r)){this.type=We;break}if(0!=(s&n)){this.type=He;break}}}},{key:"findResidue",value:function(e,t){for(var n=this._residues,r=0,i=n.length;r<i;++r){var o=n[r];if(o._sequence===e&&o._icode===t)return[o,r]}return null}},{key:"_finalize",value:function(){this._determineType();for(var e,t=this._residues,n=null,r=0,i=t.length;r<i;++r){var o=r+1<i?t[r+1]:null,s=t[r];s._finalize2(n,o,this.type===We),n=s}1<t.length&&t[1]._wingVector?(e=t[1]._wingVector,t[0]._wingVector=new ae.Vector3(e.x,e.y,e.z)):0<t.length&&(t[0]._wingVector=new ae.Vector3(1,0,0))}},{key:"updateToFrame",value:function(t){var e=this._residues,n=null,r=null,i=t._residues,o=e.length;function s(e){return t.getAtomPos(e.index)}for(var a=0;a<o;++a){var c=e[a],l=i[c._index],u=a+1<o?e[a+1]:null;c._innerFinalize(n,r,u,l,this.type===We,s),n=c,r=l}i[e[0]._index]._wingVector=1<o?i[e[1]._index]._wingVector:new ae.Vector3(1,0,0)}},{key:"addResidue",value:function(e,t,n){var r=this._complex.getResidueType(e);null===r&&(r=this._complex.addResidueType(e));n=new Fe(this,r,t,n);return this._complex.addResidue(n),this._residues.push(n),r.flags&(Be.Flags.NUCLEIC|Be.Flags.PROTEIN)&&(this.maxSequence<t&&(this.maxSequence=t),this.minSequence>t&&(this.minSequence=t)),n}},{key:"getResidueCount",value:function(){return this._residues.length}},{key:"forEachResidue",value:function(e){for(var t=this._residues,n=0,r=t.length;n<r;++n)e(t[n])}},{key:"collectMask",value:function(){for(var e=4294967295,t=this._residues,n=0,r=t.length;n<r;++n)e&=t[n]._mask;this._mask=e}}]),n}(),Xe=function(){function r(e,t,n){j(this,r),this.type=e,this.generic=r.genericByType[this.type]||"loop",this.init=t,this.term=n}return _(r,[{key:"_finalize",value:function(e,t,n){if(!(this.init instanceof Fe&&this.term instanceof Fe)){for(var r=n.splitUnifiedSerial(this.init),i=n.splitUnifiedSerial(this.term),o=r.chain;o<=i.chain;o++)for(var s=r.serial;s<=i.serial;s++)for(var a=r.iCode;a<=i.iCode;a++){var c=n.getUnifiedSerial(o,s,a);t[c]&&(t[c]._secondary=this)}this.init=t[this.init],this.term=t[this.term]}}}]),r}();Xe.Type={STRAND:"E",BRIDGE:"B",HELIX_310:"G",HELIX_ALPHA:"H",HELIX_PI:"I",HELIX:"X",TURN_310:"3",TURN_ALPHA:"4",TURN_PI:"5",TURN:"T",BEND:"S",COIL:"C"},Xe.Generic={STRAND:"strand",HELIX:"helix",LOOP:"loop"};var qe=Xe.Type,$e=Xe.Generic;function Ze(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}Xe.genericByType=(ke(la={},qe.STRAND,$e.STRAND),ke(la,qe.HELIX_310,$e.HELIX),ke(la,qe.HELIX_ALPHA,$e.HELIX),ke(la,qe.HELIX_PI,$e.HELIX),ke(la,qe.HELIX,$e.HELIX),la);var Ke=Xe.Type,Qe={1:Ke.HELIX_ALPHA,3:Ke.HELIX_PI,5:Ke.HELIX_310},Je=function(){A(c,Xe);var a=Ze(c);function c(e,t,n,r,i,o,s){return j(this,c),(n=a.call(this,Qe[e]||Xe.Type.HELIX,t,n)).serial=r,n.name=i,n.comment=o,n.length=s,n}return c}();var et=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=P(e)););return e},tt=R(function(r){function i(e,t,n){return"undefined"!=typeof Reflect&&Reflect.get?r.exports=i=Reflect.get:r.exports=i=function(e,t,n){e=et(e,t);if(e){t=Object.getOwnPropertyDescriptor(e,t);return t.get?t.get.call(n):t.value}},i(e,t,n||e)}r.exports=i});function nt(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var rt=function(){A(a,Xe);var s=nt(a);function a(e,t,n,r,i,o){return j(this,a),(n=s.call(this,Xe.Type.STRAND,t,n)).sheet=e,n.sense=r,n.atomCur=i,n.atomPrev=o,n}return _(a,[{key:"_finalize",value:function(e,t,n){tt(P(a.prototype),"_finalize",this).call(this,e,t,n);n=this.atomCur;null===n||Number.isNaN(n)||(this.atomCur=e[n]),null===(n=this.atomPrev)||Number.isNaN(n)||(this.atomPrev=e[n])}}]),a}(),it=function(){function n(e,t){j(this,n),this._name=e,this._width=t,this._strands=[]}return _(n,[{key:"getName",value:function(){return this._name}},{key:"getWidth",value:function(){return this._width}},{key:"addStrand",value:function(e){this._strands.push(e),this._width=this._strands.length}},{key:"addEmptyStrand",value:function(){this._strands.push(new rt(null,null,null,null,null,null))}},{key:"_finalize",value:function(e,t,n){for(var r=this._strands,i=0,o=r.length;i<o;++i)r[i]._finalize(e,t,n);if(this._width||(this._width=r.length),r.length!==this._width)throw new Error("Sheet ".concat(this._name," is inconsistent."))}}]),n}(),ot=function(){function o(e,t,n,r,i){j(this,o),this._id=e,this._name=t,this._position=n||new ae.Vector3,this._atoms=r||[],this._charge=0,this._repeat=1,this._center=null,this.xmlNodeRef=i||null}return _(o,[{key:"getName",value:function(){return this._name}},{key:"getPosition",value:function(){return this._position}},{key:"getCentralPoint",value:function(){return this._center}},{key:"_rebuildSGroupOnAtomChange",value:function(){if(null!==this._center){for(var e=new ae.Vector3(1e8,1e8,1e8),t=new ae.Vector3(-1e8,-1e8,-1e8),n=0,r=this._atoms.length;n<r;n++){var i=this._atoms[n].position;e.set(Math.min(e.x,i.x),Math.min(e.y,i.y),Math.min(e.z,i.z)),t.set(Math.max(t.x,i.x),Math.max(t.y,i.y),Math.max(t.z,i.z))}this._center.addVectors(e,t),this._center.multiplyScalar(.5)}}}]),o}();function st(){this.yy={}}var at={parser:(Ta=[1,17],Ma=[1,22],Ia=[1,20],Va=[1,21],Fa=[5,7,8,11,19],Ua={trace:function(){},yy:{},symbols_:{error:2,Program:3,Expression:4,EOF:5,Selector:6,OR:7,AND:8,NOT:9,"(":10,")":11,SELECTOR:12,NAMED_SELECTOR:13,SELECTOR_RANGED:14,RangeList:15,SELECTOR_NAMED:16,NameList:17,Range:18,",":19,NUMBER:20,":":21,Name:22,IDENTIFIER:23,STRING:24,$accept:0,$end:1},terminals_:{2:"error",5:"EOF",7:"OR",8:"AND",9:"NOT",10:"(",11:")",12:"SELECTOR",13:"NAMED_SELECTOR",14:"SELECTOR_RANGED",16:"SELECTOR_NAMED",19:",",20:"NUMBER",21:":",23:"IDENTIFIER",24:"STRING"},productions_:[0,[3,2],[4,1],[4,3],[4,3],[4,2],[4,3],[6,1],[6,1],[6,2],[6,2],[15,1],[15,3],[18,1],[18,3],[17,1],[17,3],[22,1],[22,1],[22,1]],performAction:function(e,t,n,r,i,o){var s=o.length-1;switch(i){case 1:return o[s-1];case 3:this.$=r.keyword("or")(o[s-2],o[s]);break;case 4:this.$=r.keyword("and")(o[s-2],o[s]);break;case 5:this.$=r.keyword("not")(o[s]);break;case 6:this.$=o[s-1];break;case 7:this.$=r.keyword(o[s])();break;case 8:this.$=r.GetSelector(o[s].toLowerCase().slice(1,o[s].length));break;case 9:case 10:this.$=r.keyword(o[s-1])(o[s]);break;case 11:this.$=new r.RangeList(o[s]);break;case 12:case 16:this.$=o[s-2].append(o[s]);break;case 13:this.$=new r.Range(Number(o[s]));break;case 14:this.$=new r.Range(Number(o[s-2]),Number(o[s]));break;case 15:this.$=new r.ValueList(o[s])}},table:[{3:1,4:2,6:3,9:fa=[1,4],10:ga=[1,5],12:xa=[1,6],13:ba=[1,7],14:sd=[1,8],16:wa=[1,9]},{1:[3]},{5:[1,10],7:Sa=[1,11],8:ad=[1,12]},(Ua=function(e,t,n,r){for(n=n||{},r=e.length;r--;n[e[r]]=t);return n})(Ea=[5,7,8,11],[2,2]),{4:13,6:3,9:fa,10:ga,12:xa,13:ba,14:sd,16:wa},{4:14,6:3,9:fa,10:ga,12:xa,13:ba,14:sd,16:wa},Ua(Ea,[2,7]),Ua(Ea,[2,8]),{15:15,18:16,20:Ta},{17:18,20:Ma,22:19,23:Ia,24:Va},{1:[2,1]},{4:23,6:3,9:fa,10:ga,12:xa,13:ba,14:sd,16:wa},{4:24,6:3,9:fa,10:ga,12:xa,13:ba,14:sd,16:wa},Ua(Ea,[2,5]),{7:Sa,8:ad,11:[1,25]},Ua(Ea,[2,9],{19:[1,26]}),Ua(Fa,[2,11]),Ua(Fa,[2,13],{21:[1,27]}),Ua(Ea,[2,10],{19:[1,28]}),Ua(Fa,[2,15]),Ua(Fa,[2,17]),Ua(Fa,[2,18]),Ua(Fa,[2,19]),Ua([5,7,11],[2,3],{8:ad}),Ua(Ea,[2,4]),Ua(Ea,[2,6]),{18:29,20:Ta},{20:[1,30]},{20:Ma,22:31,23:Ia,24:Va},Ua(Fa,[2,12]),Ua(Fa,[2,14]),Ua(Fa,[2,16])],defaultActions:{10:[2,1]},parseError:function(e,t){if(!t.recoverable){var n=new Error(e);throw n.hash=t,n}this.trace(e)},parse:function(e){var t,n=this,r=[0],i=[],o=[null],s=[],a=this.table,c="",l=0,u=0,h=1,f=s.slice.call(arguments,1),d=Object.create(this.lexer),p={yy:{}};for(t in this.yy)Object.prototype.hasOwnProperty.call(this.yy,t)&&(p.yy[t]=this.yy[t]);d.setInput(e,p.yy),p.yy.lexer=d,p.yy.parser=this,void 0===d.yylloc&&(d.yylloc={});var m=d.yylloc;s.push(m);var y=d.options&&d.options.ranges;"function"==typeof p.yy.parseError?this.parseError=p.yy.parseError:this.parseError=Object.getPrototypeOf(this).parseError;for(var _,v,g,x,b,w,S,R={};;){if(v=r[r.length-1],void 0===(g=this.defaultActions[v]||(null==_&&(S=void 0,"number"!=typeof(S=i.pop()||d.lex()||h)&&(S instanceof Array&&(S=(i=S).pop()),S=n.symbols_[S]||S),_=S),a[v]&&a[v][_]))||!g.length||!g[0]){var C="",A=[];for(b in a[v])this.terminals_[b]&&2<b&&A.push("'"+this.terminals_[b]+"'");C=d.showPosition?"Parse error on line "+(l+1)+":\n"+d.showPosition()+"\nExpecting "+A.join(", ")+", got '"+(this.terminals_[_]||_)+"'":"Parse error on line "+(l+1)+": Unexpected "+(_==h?"end of input":"'"+(this.terminals_[_]||_)+"'"),this.parseError(C,{text:d.match,token:this.terminals_[_]||_,line:d.yylineno,loc:m,expected:A})}if(g[0]instanceof Array&&1<g.length)throw new Error("Parse Error: multiple actions possible at state: "+v+", token: "+_);switch(g[0]){case 1:r.push(_),o.push(d.yytext),s.push(d.yylloc),r.push(g[1]),_=null,u=d.yyleng,c=d.yytext,l=d.yylineno,m=d.yylloc;break;case 2:if(w=this.productions_[g[1]][1],R.$=o[o.length-w],R._$={first_line:s[s.length-(w||1)].first_line,last_line:s[s.length-1].last_line,first_column:s[s.length-(w||1)].first_column,last_column:s[s.length-1].last_column},y&&(R._$.range=[s[s.length-(w||1)].range[0],s[s.length-1].range[1]]),void 0!==(x=this.performAction.apply(R,[c,u,l,p.yy,g[1],o,s].concat(f))))return x;w&&(r=r.slice(0,-1*w*2),o=o.slice(0,-1*w),s=s.slice(0,-1*w)),r.push(this.productions_[g[1]][0]),o.push(R.$),s.push(R._$),w=a[r[r.length-2]][r[r.length-1]],r.push(w);break;case 3:return!0}}return!0}},Fa={EOF:1,parseError:function(e,t){if(!this.yy.parser)throw new Error(e);this.yy.parser.parseError(e,t)},setInput:function(e,t){return this.yy=t||this.yy||{},this._input=e,this._more=this._backtrack=this.done=!1,this.yylineno=this.yyleng=0,this.yytext=this.matched=this.match="",this.conditionStack=["INITIAL"],this.yylloc={first_line:1,first_column:0,last_line:1,last_column:0},this.options.ranges&&(this.yylloc.range=[0,0]),this.offset=0,this},input:function(){var e=this._input[0];return this.yytext+=e,this.yyleng++,this.offset++,this.match+=e,this.matched+=e,e.match(/(?:\r\n?|\n).*/g)?(this.yylineno++,this.yylloc.last_line++):this.yylloc.last_column++,this.options.ranges&&this.yylloc.range[1]++,this._input=this._input.slice(1),e},unput:function(e){var t=e.length,n=e.split(/(?:\r\n?|\n)/g);this._input=e+this._input,this.yytext=this.yytext.substr(0,this.yytext.length-t),this.offset-=t;var r=this.match.split(/(?:\r\n?|\n)/g);this.match=this.match.substr(0,this.match.length-1),this.matched=this.matched.substr(0,this.matched.length-1),n.length-1&&(this.yylineno-=n.length-1);e=this.yylloc.range;return this.yylloc={first_line:this.yylloc.first_line,last_line:this.yylineno+1,first_column:this.yylloc.first_column,last_column:n?(n.length===r.length?this.yylloc.first_column:0)+r[r.length-n.length].length-n[0].length:this.yylloc.first_column-t},this.options.ranges&&(this.yylloc.range=[e[0],e[0]+this.yyleng-t]),this.yyleng=this.yytext.length,this},more:function(){return this._more=!0,this},reject:function(){return this.options.backtrack_lexer?(this._backtrack=!0,this):this.parseError("Lexical error on line "+(this.yylineno+1)+". You can only invoke reject() in the lexer when the lexer is of the backtracking persuasion (options.backtrack_lexer = true).\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},less:function(e){this.unput(this.match.slice(e))},pastInput:function(){var e=this.matched.substr(0,this.matched.length-this.match.length);return(20<e.length?"...":"")+e.substr(-20).replace(/\n/g,"")},upcomingInput:function(){var e=this.match;return e.length<20&&(e+=this._input.substr(0,20-e.length)),(e.substr(0,20)+(20<e.length?"...":"")).replace(/\n/g,"")},showPosition:function(){var e=this.pastInput(),t=new Array(e.length+1).join("-");return e+this.upcomingInput()+"\n"+t+"^"},test_match:function(e,t){var n,r;if(this.options.backtrack_lexer&&(r={yylineno:this.yylineno,yylloc:{first_line:this.yylloc.first_line,last_line:this.last_line,first_column:this.yylloc.first_column,last_column:this.yylloc.last_column},yytext:this.yytext,match:this.match,matches:this.matches,matched:this.matched,yyleng:this.yyleng,offset:this.offset,_more:this._more,_input:this._input,yy:this.yy,conditionStack:this.conditionStack.slice(0),done:this.done},this.options.ranges&&(r.yylloc.range=this.yylloc.range.slice(0))),(n=e[0].match(/(?:\r\n?|\n).*/g))&&(this.yylineno+=n.length),this.yylloc={first_line:this.yylloc.last_line,last_line:this.yylineno+1,first_column:this.yylloc.last_column,last_column:n?n[n.length-1].length-n[n.length-1].match(/\r?\n?/)[0].length:this.yylloc.last_column+e[0].length},this.yytext+=e[0],this.match+=e[0],this.matches=e,this.yyleng=this.yytext.length,this.options.ranges&&(this.yylloc.range=[this.offset,this.offset+=this.yyleng]),this._more=!1,this._backtrack=!1,this._input=this._input.slice(e[0].length),this.matched+=e[0],t=this.performAction.call(this,this.yy,this,t,this.conditionStack[this.conditionStack.length-1]),this.done&&this._input&&(this.done=!1),t)return t;if(this._backtrack){for(var i in r)this[i]=r[i];return!1}return!1},next:function(){if(this.done)return this.EOF;var e,t,n,r;this._input||(this.done=!0),this._more||(this.yytext="",this.match="");for(var i=this._currentRules(),o=0;o<i.length;o++)if((n=this._input.match(this.rules[i[o]]))&&(!t||n[0].length>t[0].length))if(t=n,r=o,this.options.backtrack_lexer){if(!1!==(e=this.test_match(n,i[o])))return e;if(!this._backtrack)return!1;t=!1}else if(!this.options.flex)break;return t?!1!==(e=this.test_match(t,i[r]))&&e:""===this._input?this.EOF:this.parseError("Lexical error on line "+(this.yylineno+1)+". Unrecognized text.\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},lex:function(){var e=this.next();return e||this.lex()},begin:function(e){this.conditionStack.push(e)},popState:function(){return 0<this.conditionStack.length-1?this.conditionStack.pop():this.conditionStack[0]},_currentRules:function(){return(this.conditionStack.length&&this.conditionStack[this.conditionStack.length-1]?this.conditions[this.conditionStack[this.conditionStack.length-1]]:this.conditions.INITIAL).rules},topState:function(e){return 0<=(e=this.conditionStack.length-1-Math.abs(e||0))?this.conditionStack[e]:"INITIAL"},pushState:function(e){this.begin(e)},stateStackSize:function(){return this.conditionStack.length},options:{"case-insensitive":!0},performAction:function(e,t,n){switch(n){case 0:break;case 1:return 20;case 2:return 7;case 3:return 8;case 4:return 9;case 5:return 12;case 6:return 16;case 7:return 14;case 8:return 10;case 9:return 11;case 10:return 19;case 11:return 21;case 12:return"<=";case 13:return">=";case 14:return"<";case 15:return">";case 16:return t.yytext=t.yytext.substr(1,t.yyleng-2),24;case 17:return 13;case 18:return 23;case 19:return 5;case 20:return"INVALID"}},rules:[/^(?:\s+)/i,/^(?:(-?(?:[1-9][0-9]+|[0-9]))\b)/i,/^(?:OR\b)/i,/^(?:AND\b)/i,/^(?:NOT\b)/i,/^(?:((ALL|NONE|HETATM|PROTEIN|BASIC|ACIDIC|CHARGED|POLAR|NONPOLAR|AROMATIC|NUCLEIC|PURINE|PYRIMIDINE|WATER|POLARH|NONPOLARH))\b)/i,/^(?:((NAME|ELEM|TYPE|RESIDUE|ICODE|CHAIN|ALTLOC))\b)/i,/^(?:((SERIAL|SEQUENCE|RESIDX))\b)/i,/^(?:\()/i,/^(?:\))/i,/^(?:,)/i,/^(?::)/i,/^(?:<=)/i,/^(?:>=)/i,/^(?:<)/i,/^(?:>)/i,/^(?:((?:"(?:\\.|[^\\"])*"|'(?:\\.|[^\\'])*')))/i,/^(?:(@[_A-Z0-9]+))/i,/^(?:([_A-Z0-9]+))/i,/^(?:$)/i,/^(?:.)/i],conditions:{INITIAL:{rules:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20],inclusive:!0}}},Ua.lexer=Fa,new((st.prototype=Ua).Parser=st))}.parser;function ct(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var lt=function(){function n(e,t){j(this,n),this.min=e,this.max=void 0===t?e:t}return _(n,[{key:"includes",value:function(e){return this.min<=e&&e<=this.max}},{key:"toString",value:function(){var e=this.min,t=this.max;return e===t?String(e):[e,t].join(":")}},{key:"toJSON",value:function(){return[this.min,this.max]}}]),n}(),ut=function(){function t(e){if(j(this,t),e instanceof this.constructor)return e;e instanceof Array?this._values=e.slice(0):this._values=e?[e]:[]}return _(t,[{key:"append",value:function(e){var t=this._values;return t[t.length]=e,this}},{key:"remove",value:function(e){var t=this._values,e=t.indexOf(e);return 0<=e&&t.splice(e,1),this}},{key:"toString",value:function(){return this._values.join(",")}},{key:"toJSON",value:function(){for(var e=this._values,t=[],n=0,r=e.length;n<r;++n){var i=e[n];t[n]=i.toJSON?i.toJSON():i}return t}}]),t}(),ht=function(){A(t,ut);var e=ct(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"includes",value:function(e){for(var t=this._values,n=0,r=t.length;n<r;++n)if(t[n].includes(e))return!0;return!1}}]),t}(),ft=[],dt=function(){A(c,ut);var a=ct(c);function c(e,t){var n;j(this,c);e=n=a.call(this,e);if(t){n.upperOnly=!0;for(var r=e._values,i=0,o=r.length;i<o;++i){var s=r[i];"string"==typeof s&&(r[i]=s.toUpperCase())}}else n.upperOnly=!1;return T(n,e)}return _(c,[{key:"includes",value:function(e){return-1!==this._values.indexOf(e)}},{key:"toString",value:function(){for(var e=this._values,t=ft.length=0,n=e.length;t<n;++t)ft[t]=ce.correctSelectorIdentifier(String(e[t]));return ft.join(",")}},{key:"_validate",value:function(e){return this.upperOnly&&"string"==typeof e?e.toUpperCase():e}},{key:"append",value:function(e){return tt(P(c.prototype),"append",this).call(this,this._validate(e)),this}},{key:"remove",value:function(e){return tt(P(c.prototype),"remove",this).call(this,this._validate(e)),this}}]),c}();function pt(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var mt=function(){function e(){j(this,e)}return _(e,[{key:"toString",value:function(){return this.keyword}},{key:"toJSON",value:function(){return[this.name]}}]),e}();mt.prototype.name="Error",mt.prototype.keyword="error";var yt=function(){A(r,mt);var n=pt(r);function r(e){var t;return j(this,r),(t=n.call(this)).list=e,t}return _(r,[{key:"toString",value:function(){return"".concat(this.keyword," ").concat(this.list)}},{key:"toJSON",value:function(){return[this.name,this.list.toJSON()]}}]),r}(),_t=function(){A(n,yt);var t=pt(n);function n(e){return j(this,n),t.call(this,new ht(e))}return n}(),vt=function(){A(r,yt);var n=pt(r);function r(e,t){return j(this,r),n.call(this,new dt(e,!t))}return r}(),gt=function(){A(t,mt);var e=pt(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"includesAtom",value:function(){return!1}}]),t}();gt.prototype.name="None",gt.prototype.keyword="none";var xt=function(){A(t,mt);var e=pt(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"includesAtom",value:function(){return!0}}]),t}();function bt(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}xt.prototype.name="All",xt.prototype.keyword="all";var wt=new gt,St=function(){A(r,mt);var n=bt(r);function r(e){var t;return j(this,r),(t=n.call(this)).rhs=e||wt,t}return _(r,[{key:"toString",value:function(){var e=this.rhs.priority&&this.rhs.priority>this.priority?"(".concat(this.rhs,")"):this.rhs;return"".concat(this.keyword," ").concat(e)}},{key:"toJSON",value:function(){return[this.name,this.rhs.toJSON()]}}]),r}();St.prototype.priority=1;var Rt=function(){A(i,mt);var r=bt(i);function i(e,t){var n;return j(this,i),(n=r.call(this)).lhs=e||wt,n.rhs=t||wt,n}return _(i,[{key:"toString",value:function(){var e=this.lhs.priority&&this.lhs.priority>this.priority?"(".concat(this.lhs,")"):this.lhs,t=this.rhs.priority&&this.rhs.priority>this.priority?"(".concat(this.rhs,")"):this.rhs;return"".concat(e," ").concat(this.keyword," ").concat(t)}},{key:"toJSON",value:function(){return[this.name,this.lhs.toJSON(),this.rhs.toJSON()]}}]),i}();function Ct(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}Rt.prototype.priority=1e3;var At={};function Et(e,r){var t=e.toLowerCase();r.prototype.keyword=t,r.prototype.name=e;e=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return I(r,t)};return e.SelectorClass=r,At[t]=e,r}Et("Serial",function(){A(t,_t);var e=Ct(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"includesAtom",value:function(e){return this.list.includes(e.serial)}}]),t}()),Et("Name",function(){A(t,vt);var e=Ct(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"includesAtom",value:function(e){return this.list.includes(e.name)}}]),t}()),Et("AltLoc",function(){A(t,vt);var e=Ct(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"includesAtom",value:function(e){return this.list.includes(String.fromCharCode(e.location))}}]),t}()),Et("Elem",function(){A(t,vt);var e=Ct(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"includesAtom",value:function(e){return this.list.includes(e.element.name)}}]),t}()),Et("Residue",function(){A(t,vt);var e=Ct(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"includesAtom",value:function(e){return this.list.includes(e.residue._type._name)}}]),t}()),Et("Sequence",function(){A(t,_t);var e=Ct(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"includesAtom",value:function(e){return this.list.includes(e.residue._sequence)}}]),t}()),Et("ICode",function(){A(n,vt);var t=Ct(n);function n(e){return j(this,n),t.call(this,e,!0)}return _(n,[{key:"includesAtom",value:function(e){return this.list.includes(e.residue._icode)}}]),n}()),Et("ResIdx",function(){A(t,_t);var e=Ct(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"includesAtom",value:function(e){return this.list.includes(e.residue._index)}}]),t}()),Et("Chain",function(){A(n,vt);var t=Ct(n);function n(e){return j(this,n),t.call(this,e,!0)}return _(n,[{key:"includesAtom",value:function(e){return this.list.includes(e.residue._chain._name)}}]),n}()),Et("Hetatm",function(){A(t,mt);var e=Ct(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"includesAtom",value:function(e){return e.het}}]),t}()),Et("PolarH",function(){A(t,mt);var e=Ct(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"includesAtom",value:function(e){return(e.flags&Te.Flags.NONPOLARH)===Te.Flags.HYDROGEN}}]),t}()),Et("NonPolarH",function(){A(t,mt);var e=Ct(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"includesAtom",value:function(e){return(e.flags&Te.Flags.NONPOLARH)===Te.Flags.NONPOLARH}}]),t}()),Et("All",xt),Et("None",gt);var kt=At.none();function Tt(e,t,n){return n.prototype.priority=t,Et(e,n)}function Pt(n,e){return Et(e,function(){A(t,mt);var e=Ct(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"includesAtom",value:function(e){return 0!=(e.residue._type.flags&n)}}]),t}())}Tt("Not",1,function(){A(t,St);var e=Ct(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"includesAtom",value:function(e){return!this.rhs.includesAtom(e)}}]),t}()),Tt("And",2,function(){A(t,Rt);var e=Ct(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"includesAtom",value:function(e){return this.lhs.includesAtom(e)&&this.rhs.includesAtom(e)}}]),t}()),Tt("Or",3,function(){A(t,Rt);var e=Ct(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"includesAtom",value:function(e){return this.lhs.includesAtom(e)||this.rhs.includesAtom(e)}}]),t}()),Pt(Be.Flags.PROTEIN,"Protein"),Pt(Be.Flags.BASIC,"Basic"),Pt(Be.Flags.ACIDIC,"Acidic"),Pt(Be.Flags.BASIC|Be.Flags.ACIDIC,"Charged"),Pt(Be.Flags.POLAR,"Polar"),Pt(Be.Flags.NONPOLAR,"NonPolar"),Pt(Be.Flags.AROMATIC,"Aromatic"),Pt(Be.Flags.NUCLEIC,"Nucleic"),Pt(Be.Flags.PURINE,"Purine"),Pt(Be.Flags.PYRIMIDINE,"Pyrimidine"),Pt(Be.Flags.WATER,"Water");var Mt=Object.create(At);Mt.Selector=mt,Mt.RangeListSelector=_t,Mt.ValueListSelector=vt,Mt.Range=lt,Mt.RangeList=ht,Mt.ValueList=dt,Mt.PrefixOperator=St,Mt.InfixOperator=Rt,Mt.Context=Object.create({}),Mt.GetSelector=function(e){if(Mt.Context.hasOwnProperty(e))return Mt.Context[e]||kt;throw{message:"selector ".concat(e," is not registered")}},Mt.ClearContext=function(){Object.keys(Mt.Context).forEach(function(e){delete Mt.Context[e]})},Mt.keyword=function(e){return At[e.toLowerCase()]||At.none},Mt.parse=function(e){var t={};try{t.selector=at.parse(e)}catch(e){t.selector=kt,t.error=e.message}return t},at.yy=Mt,at.yy.parseError=at.parseError;var Nt=function(){function t(e){j(this,t),this._complex=e,this._selector=Mt.keyword("All")(),this._boundaries={boundingBox:new ae.Box3,boundingSphere:new ae.Sphere}}return _(t,[{key:"computeBoundaries",value:function(){var e=this._complex._atoms,t=e.length,n=this._selector,r=this._boundaries.boundingBox;if(r.makeEmpty(),1===t){r.expandByPoint(e[0].position);var i=new ae.Vector3;r.getCenter(i);var o=2*e[0].element.radius;r.setFromCenterAndSize(i,new ae.Vector3(o,o,o))}else for(var s=0;s<t;++s)n.includesAtom(e[s])&&r.expandByPoint(e[s].position);var a=0,c=new ae.Vector3;if(r.getCenter(c),1===t)this._boundaries.boundingSphere.set(c,e[0].element.radius);else{for(var l,u=0;u<t;++u)n.includesAtom(e[u])&&(l=e[u].position,a<(l=c.distanceToSquared(l))&&(a=l));this._boundaries.boundingSphere.set(c,Math.sqrt(a))}}},{key:"getTransforms",value:function(){return[]}},{key:"getSelector",value:function(){return this._selector}},{key:"getBoundaries",value:function(){return this._boundaries}},{key:"finalize",value:function(){}}]),t}();function It(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var Lt=function(){A(c,Nt);var t=It(c);function c(e){return j(this,c),(e=t.call(this,e)).chains=[],e.matrices=[],e}return _(c,[{key:"computeBoundaries",value:function(){tt(P(c.prototype),"computeBoundaries",this).call(this);var e=this.matrices,t=this._boundaries.boundingSphere.center,n=this._boundaries.boundingSphere.radius,r=this._boundaries.boundingBox=new ae.Box3;r.makeEmpty();for(var i=0,o=e.length;i<o;++i)r.expandByPoint(t.clone().applyMatrix4(e[i]));var s=r.max.distanceTo(r.min)/2+n,a=new ae.Vector3;r.getCenter(a),this._boundaries.boundingSphere=(new ae.Sphere).set(a,s),r.max.addScalar(n),r.min.subScalar(n)}},{key:"addChain",value:function(e){this.chains[this.chains.length]=e}},{key:"addMatrix",value:function(e){this.matrices[this.matrices.length]=e}},{key:"getTransforms",value:function(){return this.matrices}},{key:"finalize",value:function(){0<this.chains.length?this._selector=Mt.keyword("Chain")(this.chains):this._selector=Mt.keyword("None")()}}]),c}(),Dt=function(){function t(e){j(this,t),this._complex=e,this._index=-1,this._residueIndices=[],this._cycles=[],this._subDivs=[],this._residueCount=0}return _(t,[{key:"getResidues",value:function(){return this._complex._residues}},{key:"getResidueCount",value:function(){return this._residueCount}},{key:"forEachResidue",value:function(e){for(var t=this._complex._residues,n=this._residueIndices,r=0,i=n.length;r<i;++r)for(var o=n[r].start,s=n[r].end;o<=s;++o)e(t[o])}},{key:"setSubDivs",value:function(e){for(var t,n,r=0,i=[],o=0,s=0,a=(this._subDivs=e).length;s<a;++s)s!==a-1&&e[s].end+1===e[s+1].start||(t=e[r].start,n=e[s].end,i[i.length]={start:t,end:n},o+=n-t+1,r=s+1);this._residueIndices=i,this._residueCount=o}},{key:"getComplex",value:function(){return this._complex}},{key:"forEachBond",value:function(e){for(var t=this._complex._bonds,n=0,r=t.length;n<r;++n){var i=t[n];i._left.residue._component===this&&e(i)}}},{key:"update",value:function(){this.forEachCycle(function(e){e.update()})}},{key:"forEachAtom",value:function(t){this.forEachResidue(function(e){e.forEachAtom(t)})}},{key:"addCycle",value:function(e){this._cycles.push(e)}},{key:"forEachCycle",value:function(e){for(var t=this._cycles,n=0,r=t.length;n<r;++n)e(t[n])}},{key:"markResidues",value:function(){var t=this;t.forEachResidue(function(e){e._component=t})}},{key:"_forEachSubChain",value:function(e,t){for(var n=this._complex._residues,r=this._subDivs,i=0,o=r.length;i<o;++i)for(var s=r[i].start,a=r[i].end;s<=a;++s){var c=n[s];if(e&c._mask&&c._isValid){for(var l=s+1;l<=a;++l){var u=n[l];if(!(e&u._mask&&u._isValid))break}t(i,s,l-1),s=l}}}},{key:"getMaskedSequences",value:function(e){var r=[],i=0;return this._forEachSubChain(e,function(e,t,n){r[i++]={start:t,end:n}}),r}},{key:"getMaskedSubdivSequences",value:function(e){var r=[],i=-1,o=-1,s=this._subDivs;return this._forEachSubChain(e,function(e,t,n){o!==e&&(r[++i]={arr:[],boundaries:s[e]},o=e),r[i].arr[r[i].arr.length]={start:t,end:n}}),r}}]),t}(),Ot=32,Vt=1048576,zt=4,Ft=-1,Bt=function(){function r(e){j(this,r),this.numPairs=0,this.numMaxPairs=e,this.intBuffer=ce.allocateTyped(Int32Array,e*zt);for(var t=0;t<e*zt;t++)this.intBuffer[t]=Ft;this.hashBuffer=ce.allocateTyped(Int32Array,Vt*Ot);for(var n=0;n<Vt*Ot;n++)this.hashBuffer[n]=Ft}return _(r,[{key:"destroy",value:function(){this.intBuffer=null,this.hashBuffer=null}},{key:"addPair",value:function(e,t){for(var n=e<t?e:t,t=t<e?e:t,r=n+(t<<14),i=(n+89237*t&Vt-1)*Ot,o=0;o<Ot;o++){var s=this.hashBuffer[i+o];if(s===Ft)break;if(s===r)return!1}if(Ot<=o)throw new Error("addPair: increase cMaxPairsForHashCode");if(this.hashBuffer[i+o]=r,this.numPairs>=this.numMaxPairs)throw new Error("addPair: increase num pairs");return i=this.numPairs*zt,this.intBuffer[i]=n,this.intBuffer[i+1]=t,this.intBuffer[i+2]=r,this.numPairs++,!0}}]),r}();function Ut(e){e=e.element;if(e)return e.radiusBonding;throw new Error("_getBondingRadius: Logic error.")}var Gt,jt,Ht,Wt=function(){function t(e){j(this,t),this._complex=e,this._maxRad=1.8;e=this._complex.getDefaultBoundaries().boundingBox;this._vBoxMin=e.min.clone(),this._vBoxMax=e.max.clone(),this._pairCollection=null}return _(t,[{key:"_addExistingPairs",value:function(){for(var e=this._complex.getAtoms(),t=e.length,n=0,r=this._pairCollection;n<t;n++)for(var i=e[n].bonds,o=i.length,s=0;s<o;s++){var a=i[s];a._left.index===n&&r.addPair(n,a._right.index)}return 0}},{key:"_findPairs",value:function(){var e=this._complex.getVoxelWorld();if(null!==e)for(var r,i,o,s,a,t,n=this._complex._atoms,c=n.length,l=this,u=function(e){var t,n;i&&e.isHydrogen()||(n=e.location,32!==s&&32!==n&&s!==n||(t=o.distanceToSquared(e.position),n=e.element.radiusBonding,(n=r+n+.45)*n<t||t<.001||l._pairCollection.addPair(a.index,e.index)))},h=0;h<c;++h)a=n[h],(!(t=a).isHet()||t.bonds&&0===t.bonds.length)&&(r=a.element.radiusBonding,i=a.isHydrogen(),o=a.position,s=a.location,e.forEachAtomWithinRadius(o,2*this._maxRad+.45,u))}},{key:"_addPairs",value:function(){for(var e=this._complex._atoms,t=0,n=0;t<this._pairCollection.numPairs;t++,n+=4){var r=this._pairCollection.intBuffer[n],i=this._pairCollection.intBuffer[n+1];this._addPair(e[r],e[i])}}},{key:"_addPair",value:function(e,t){for(var n=e.bonds,r=e.index,i=t.index,o=0,s=n.length;o<s;++o){var a=n[o];if(a._left.index===i||a._right.index===i)return}var c=r<i?e:t,e=r<i?t:e,e=this._complex.addBond(c,e,0,Ie.BondType.UNKNOWN,!1);n.push(e),t.bonds.push(e)}},{key:"build",value:function(){this._buildInner()}},{key:"_buildInner",value:function(){var e=this._complex._atoms;if(!(e.length<2)){if(e[0].index<0)throw new Error("AutoBond: Atoms in complex were not indexed.");this._calcBoundingBox(),this._pairCollection=new Bt(4*e.length),this._addExistingPairs(),this._findPairs(),this._addPairs()}}},{key:"_calcBoundingBox",value:function(){for(var e=this._complex._atoms,t=e.length,n=Ut(e[0]),r=1;r<t;++r)n=Math.max(n,Ut(e[r]));this._vBoxMax.addScalar(n),this._vBoxMin.addScalar(-n),this._maxRad=1.2*n}},{key:"destroy",value:function(){this._pairCollection&&this._pairCollection.destroy()}}]),t}(),Yt=Ie.BondType.AROMATIC,Xt=[Pe.ByName.C.number,Pe.ByName.N.number],qt=(Gt=new ae.Vector3,jt=new ae.Vector3,Ht=new ae.Vector3,function(e,t){return Gt.copy(e).normalize(),jt.copy(t).normalize(),Ht.crossVectors(Gt,jt),!(.1<Ht.length())&&0<=Gt.dot(jt)});function $t(e,t){for(var n=0;n<e.length&&e[n]<t;)++n;e.splice(n,0,t)}function Zt(e,t){return e._left===t?e._right:e._left}function Kt(e){e._type=Yt}var Qt=function(){function t(e){j(this,t),this.atoms=e,this.update()}return _(t,[{key:"update",value:function(){for(var e=this.atoms,t=new ae.Vector3,n=e.length,r=0;r<n;++r)t.add(e[r].position);t.multiplyScalar(1/n),this.center=t,this.radius=t.distanceTo(e[0].position.clone().lerp(e[1].position,.5))}},{key:"forEachBond",value:function(t){var n,e=this.atoms,r=e.length,i=e[0];function o(e){e._left!==n&&e._right!==n||t(e)}for(var s=0;s<r;++s)n=e[(s+1)%r],i.forEachBond(o),i=n}}]),t}();function Jt(e){return e._type===Yt}function en(e){if(e.type===Yt)return!0;var t=Xt.indexOf(e._right.element.number),e=Xt.indexOf(e._left.element.number);return-1!==t&&-1!==e}function tn(e){return 3<e.length}function nn(e){return!0}var rn=function(){function o(e){j(this,o),this._complex=e;for(var t=new Array(e._bonds.length),n=new Array(e._bonds.length),r=0,i=t.length;r<i;++r)t[r]=[],n[r]=!1;this._bondsData=t,this._bondMarks=n,this._resetCycles()}return _(o,[{key:"_resetCycles",value:function(){this._cycles=[],this._currIdx=-1}},{key:"_haveSameCycle",value:function(e,t,n){for(var r=e[t._index],i=e[n._index],o=r.length,s=i.length,a=0,c=0;a<o&&c<s;){if(r[a]===i[c])return!0;r[a]>i[c]?++c:++a}return!1}},{key:"_tryBond",value:function(s,a,c){var l=[],u=this._bondsData,e=Zt(s,a),h=a.position.clone().sub(e.position),f=this._currStart,d=this,p=this._bondMarks,m=this._checkBond;p[s._index]=!0,m=void 0===m?Jt:m,a.forEachBond(function(e){if(m(e)&&e!==s&&!p[e._index]&&!d._haveSameCycle(u,s,e)){var t,n=Zt(e,a),r=n.position.clone().sub(a.position),i=n===f?-2:1-(t=r,t=(n=h).dot(t)/Math.sqrt(n.lengthSq()*t.lengthSq()),ae.MathUtils.clamp(t,-1,1)),r=r.cross(h);if(qt(r,c)){for(var o=0;o<l.length&&l[o].val<i;)++o;l.splice(o,0,{bond:e,val:i,dir:r})}}});for(var t=0,n=l.length;t<n;++t){var r=l[t].bond,i=r._left===a?r._right:r._left;if(i===f)return++this._currIdx,this._cycles.push([a]),!(p[s._index]=!1);if(this._tryBond(r,i,l[t].dir))return $t(u[r._index],this._currIdx),this._cycles[this._currIdx].push(a),!(p[s._index]=!1)}return p[s._index]=!1}},{key:"_startCycle",value:function(e){this._currStart=e._left,this._tryBond(e,e._right,new ae.Vector3)&&($t(this._bondsData[e._index],this._currIdx),this._cycles[this._currIdx].push(e._left))}},{key:"_findLoops",value:function(o,s){this._checkBond=o;var e=this._complex,a=this;e.forEachComponent(function(e){a._resetCycles(),e.forEachBond(function(e){o(e)&&a._startCycle(e)});for(var t=a._cycles,n=0,r=t.length;n<r;++n){var i=t[n];s(i)&&((i=new Qt(i)).forEachBond(Kt),e.addCycle(i))}})}},{key:"markCycles",value:function(){this._findLoops(Jt,tn)}},{key:"detectCycles",value:function(){this._findLoops(en,nn)}}]),o}();var on=function(){function k(e,t){j(this,k),this._box=e.clone();var n=new ae.Vector3;e.getSize(n),this._count=n.clone().divide(t).floor().max(new ae.Vector3(1,1,1)),this._last=this._count.clone().subScalar(1),this._cellSize=n.clone().divide(this._count),this._cellInnerR=.5*Math.min(Math.min(this._cellSize.x,this._cellSize.y),this._cellSize.z),this._cellOuterR=.5*Math.sqrt(this._cellSize.dot(this._cellSize));var r=this._count.x*this._count.y*this._count.z;this._voxels=ce.allocateTyped(Int32Array,r);for(var i=0;i<r;++i)this._voxels[i]=-1;this._atoms=[]}return _(k,[{key:"addAtoms",value:function(e){var n=this,r=this._atoms.length;this._atoms.length+=2*e.getAtomCount(),e.forEachAtom(function(e){var t=n._findVoxel(e.position);n._atoms[r]=e,n._atoms[r+1]=n._voxels[t],n._voxels[t]=r,r+=2})}},{key:"_findVoxel",value:function(e){var t=k._zero,n=k._voxel;return n.copy(e).sub(this._box.min).divide(this._cellSize).floor().clamp(t,this._last),n.x+this._count.x*(n.y+this._count.y*n.z)}},{key:"_forEachAtomInVoxel",value:function(e,t){for(var n=this._voxels[e];0<=n;n=this._atoms[n+1])t(this._atoms[n])}},{key:"_forEachVoxelWithinRadius",value:function(e,t,n){var r,i,o,s,a,c=k._xRange,l=k._yRange,u=k._zRange;if(t/this._cellInnerR<10)this._forEachVoxelWithinRadiusSimple(e,t,n);else{u.set(e.z-t,e.z+t),u.subScalar(this._box.min.z).divideScalar(this._cellSize.z).floor().clampScalar(0,this._count.z-1);for(var h,f,d,p,m,y,_,v,g,x,b,w,S,R,C=u.x;C<=u.y;++C){v=[this._box.min.z+C*this._cellSize.z,this._box.min.z+(C+1)*this._cellSize.z],a=e.z-t<=v[0]&&v[1]<=e.z+t,g=t,b=v[1],w=S=w=R=S=w=void 0,w=(x=v[0])-(v=e).z,S=b-v.z,R=Math.sqrt(Math.max(g*g-w*w,0)),w=Math.sqrt(Math.max(g*g-S*S,0)),S=Math.min(R,w),w=x<=v.z&&b>=v.z?g:Math.max(R,w),r=[S,w],l.set(e.y-r[1],e.y+r[1]),l.subScalar(this._box.min.y).divideScalar(this._cellSize.y).floor().clampScalar(0,this._count.y-1);for(var A=l.x;A<=l.y;++A){h=[this._box.min.y+A*this._cellSize.y,this._box.min.y+(A+1)*this._cellSize.y],s=e.y-r[0]<=h[0]&&h[1]<=e.y+r[0],f=r[1],p=h[1],m=y=m=_=y=m=void 0,m=(d=h[0])-(h=e).y,y=p-h.y,_=Math.sqrt(Math.max(f*f-m*m,0)),m=Math.sqrt(Math.max(f*f-y*y,0)),y=Math.min(_,m),m=d<=h.y&&p>=h.y?f:Math.max(_,m),i=[y,m],c.set(e.x-i[1],e.x+i[1]),c.subScalar(this._box.min.x).divideScalar(this._cellSize.x).floor().clampScalar(0,this._count.x-1);for(var E=c.x;E<=c.y;++E)o=[this._box.min.x+E*this._cellSize.x,this._box.min.x+(E+1)*this._cellSize.x],o=e.x-i[0]<=o[0]&&o[1]<=e.x+i[0],n(E+this._count.x*(A+this._count.y*C),o&&s&&a)}}}}},{key:"_forEachVoxelWithinRadiusSimple",value:function(e,t,n){var r=k._xRange,i=k._yRange,o=k._zRange,s=k._vCenter,a=(t+this._cellOuterR)*(t+this._cellOuterR),c=-1;t>this._cellOuterR&&(c=(t-this._cellOuterR)*(t-this._cellOuterR)),r.set(e.x-t,e.x+t),r.subScalar(this._box.min.x).divideScalar(this._cellSize.x).floor(),r.x=Math.min(Math.max(r.x,0),this._count.x-1),r.y=Math.min(Math.max(r.y,0),this._count.x-1),i.set(e.y-t,e.y+t),i.subScalar(this._box.min.y).divideScalar(this._cellSize.y).floor(),i.x=Math.min(Math.max(i.x,0),this._count.y-1),i.y=Math.min(Math.max(i.y,0),this._count.y-1),o.set(e.z-t,e.z+t),o.subScalar(this._box.min.z).divideScalar(this._cellSize.z).floor(),o.x=Math.min(Math.max(o.x,0),this._count.z-1),o.y=Math.min(Math.max(o.y,0),this._count.z-1);for(var l=o.x;l<=o.y;++l){var u=[this._box.min.z+l*this._cellSize.z,this._box.min.z+(l+1)*this._cellSize.z];s.z=.5*(u[0]+u[1]);for(var h=i.x;h<=i.y;++h){var f=[this._box.min.y+h*this._cellSize.y,this._box.min.y+(h+1)*this._cellSize.y];s.y=.5*(f[0]+f[1]);for(var d=r.x;d<=r.y;++d){var p=[this._box.min.x+d*this._cellSize.x,this._box.min.x+(d+1)*this._cellSize.x];s.x=.5*(p[0]+p[1]);p=e.distanceToSquared(s);p<=a&&n(d+this._count.x*(h+this._count.y*l),p<=c)}}}}},{key:"forEachAtomWithinRadius",value:function(n,e,r){var i=this,o=e*e;i._forEachVoxelWithinRadius(n,e,function(e,t){t?i._forEachAtomInVoxel(e,r):i._forEachAtomInVoxel(e,function(e){n.distanceToSquared(e.position)<=o&&r(e)})})}},{key:"forEachAtomWithinDistFromMasked",value:function(e,n,t,r){this._forEachAtomWithinDistFromGroup(function(t){e.forEachAtom(function(e){0!=(e.mask&n)&&t(e)})},t,r)}},{key:"forEachAtomWithinDistFromSelected",value:function(e,n,t,r){this._forEachAtomWithinDistFromGroup(function(t){e.forEachAtom(function(e){n.includesAtom(e)&&t(e)})},t,r)}},{key:"_forEachAtomWithinDistFromGroup",value:function(e,t,n){var r,i=this,o=t*t,s=[],a=[],c=0;e(function(n){i._forEachVoxelWithinRadius(n.position,t,function(e,t){t?s[e]=-1:void 0===s[e]?(a.push(n),a.push(-1),s[e]=c,c+=2):-1!==s[e]&&(a.push(n),a.push(s[e]),s[e]=c,c+=2)})});function l(e){if(void 0!==s[r])if(-1!==(c=s[r])){for(;0<=c;c=a[c+1])if(e.position.distanceToSquared(a[c].position)<o){n(e);break}}else n(e)}for(r in s)s.hasOwnProperty(r)&&i._forEachAtomInVoxel(r,l)}}]),k}();ke(on,"_zero",new ae.Vector3(0,0,0)),ke(on,"_voxel",new ae.Vector3),ke(on,"_xRange",new ae.Vector2),ke(on,"_yRange",new ae.Vector2),ke(on,"_zRange",new ae.Vector2),ke(on,"_vCenter",new ae.Vector3);var sn=-27.888,an=1e3,cn=function(){function t(e){j(this,t),this._complex=e,this._hbonds=[],this._complex._residues.length>an?this._buildVW():this._build()}return _(t,[{key:"isBond",value:function(e,t){if(this._hbonds[e]){var n=m(this._hbonds[e].acceptor,2),e=n[0],n=n[1];if(e&&e.residue===t&&e.energy<-.5)return!0;if(n&&n.residue===t&&n.energy<-.5)return!0}return!1}},{key:"_build",value:function(){for(var e=0;e<this._complex._residues.length-1;++e){var t=this._complex._residues[e];if(0!=(t.getType().flags&Be.Flags.PROTEIN)){var n=null;0<e&&this._complex._residues[e-1].getType().flags&Be.Flags.PROTEIN&&t._sequence===this._complex._residues[e-1]._sequence+1&&(n=this._complex._residues[e-1]);for(var r=e+1;r<this._complex._residues.length;++r){var i,o=this._complex._residues[r];0!=(o.getType().flags&Be.Flags.PROTEIN)&&(i=null,this._complex._residues[r-1].getType().flags&Be.Flags.PROTEIN&&o._sequence===this._complex._residues[r-1]._sequence+1&&(i=this._complex._residues[r-1]),this._calcHBondEnergy(n,t,o),r!==e+1&&this._calcHBondEnergy(i,o,t))}}}}},{key:"_buildVW",value:function(){var n,r,i=this,o=this._complex._residues,e=this._complex.getVoxelWorld();if(null!==e)for(var s=new Bt(this._complex._residues.length*this._complex._residues.length/2),t=0;t<o.length-1;++t)0!=((n=o[t]).getType().flags&Be.Flags.PROTEIN)&&(!(r=0<t?o[t-1]:null)||0!=(r.getType().flags&Be.Flags.PROTEIN)&&n._sequence===r._sequence+1||(r=null),e.forEachAtomWithinRadius(this._residueGetCAlpha(n),5,a));function a(e){var t=e.residue;t._index!==n._index&&0!=(t.getType().flags&Be.Flags.PROTEIN)&&s.addPair(n._index,t._index)&&(!(e=0<t._index?o[t._index-1]:null)||0!=(e.getType().flags&Be.Flags.PROTEIN)&&t._sequence===e._sequence+1||(e=null),i._calcHBondEnergy(r,n,t),t._index!==n._index+1&&i._calcHBondEnergy(e,t,n))}}},{key:"_residueGetCAlpha",value:function(e){for(var t=0;t<e._atoms.length;++t){var n=e._atoms[t].name;if("CA"===n||"C1"===n)return e._atoms[t].position}return null}},{key:"_residueGetCO",value:function(e){var t=null,n=null;return e.forEachAtom(function(e){"C"===e.name?t=e.position:"O"===e.name&&(n=e.position)}),[t,n]}},{key:"_residueGetNH",value:function(e,t){var n,r=this._residueGetCO(e),e=m(r,2),r=e[0],e=e[1];if(t.forEachAtom(function(e){"N"===e.name&&(n=e.position)}),r&&e&&n){r=r.clone();return r.sub(e),r.multiplyScalar(1/r.length()),r.add(n),[n,r]}return[null,null]}},{key:"_calcHBondEnergy",value:function(e,t,n){var r=0;if(null===e)return r;if("PRO"!==t.getType().getName()){var i=this._residueGetNH(e,t),o=m(i,2),s=o[0],e=o[1],a=this._residueGetCO(n),i=m(a,2),o=i[0],a=i[1];if(null===s||null===e||null===o||null===a)return r;i=e.distanceTo(a),e=e.distanceTo(o),o=s.distanceTo(o),a=s.distanceTo(a),r=i<.5||e<.5||o<.5||a<.5?-9.9:sn/i-sn/e+sn/o-sn/a;(r=Math.round(1e3*r)/1e3)<-9.9&&(r=-9.9)}void 0===this._hbonds[t._index]&&(this._hbonds[t._index]={donor:[],acceptor:[]});a=this._hbonds[t._index];a.acceptor.length<2&&a.acceptor.push({residue:n._index,energy:r}),1<a.acceptor.length&&(r<a.acceptor[0].energy?(a.acceptor[1].residue=a.acceptor[0].residue,a.acceptor[1].energy=a.acceptor[0].energy,a.acceptor[0].residue=n._index,a.acceptor[0].energy=r):r<a.acceptor[1].energy&&(a.acceptor[1].residue=n._index,a.acceptor[1].energy=r)),void 0===this._hbonds[n._index]&&(this._hbonds[n._index]={donor:[],acceptor:[]});n=this._hbonds[n._index];return n.donor.length<2&&n.donor.push({residue:t._index,energy:r}),1<n.donor.length&&(r<n.donor[0].energy?(n.donor[1].residue=n.donor[0].residue,n.donor[1].energy=n.donor[0].energy,n.donor[0].residue=t._index,n.donor[0].energy=r):r<n.donor[1].energy&&(n.donor[1].residue=t._index,n.donor[1].energy=r)),r}}]),t}();function ln(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return un(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return un(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,t=function(){};return{s:t,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:t}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,o=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,i=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw i}}}}function un(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var hn=Object.freeze({NO_BRIDGE:0,PARALLEL:1,ANTI_PARALLEL:2}),fn=Object.freeze({START:1,MIDDLE:2,END:3,START_AND_END:4}),dn=Object.freeze({STRAND:"E",BRIDGE:"B",HELIX_310:"G",HELIX_ALPHA:"H",HELIX_PI:"I",TURN:"T",BEND:"S",LOOP:" "}),pn=function(){function t(e){j(this,t),this._complex=e,this._build()}return _(t,[{key:"_build",value:function(){this._hbonds=new cn(this._complex),this._ss=[],this._sheet=[],this._betaPartners=[],this._bend=[];for(var e=0;e<this._complex.getResidues().length;++e)this._betaPartners[e]=[];this._helixFlags=[],this._helixFlags[3]=[],this._helixFlags[4]=[],this._helixFlags[5]=[],this._chainLengths=[];for(var t=0;t<this._complex._chains.length;++t){for(var n=this._complex._chains[t].getResidues(),r=0;r<n.length&&0!=(n[r].getType().flags&Be.Flags.PROTEIN);++r);this._chainLengths[t]=r}this._buildBetaSheets();for(var i=0;i<this._complex._chains.length;++i)this._buildAlphaHelices(this._complex._chains[i].getResidues(),this._chainLengths[i],!1)}},{key:"_buildAlphaHelices",value:function(e,t,n){for(var r=3;r<=5&&!(e.length<r);++r)for(var i=0;i+r<t;++i)if(this._hbonds.isBond(e[i+r]._index,e[i]._index)){this._helixFlags[r][e[i+r]._index]=fn.END;for(var o=i+1;o<i+r;++o)void 0===this._helixFlags[r][e[o]._index]&&(this._helixFlags[r][e[o]._index]=fn.MIDDLE);this._helixFlags[r][e[i]._index]===fn.END?this._helixFlags[r][e[i]._index]=fn.START_AND_END:this._helixFlags[r][e[i]._index]=fn.START}for(var s=2;s<t-2;++s){var a=this._kappa(e[s-2],e[s],e[s+2]);this._bend[e[s]._index]=360!==a&&70<a}for(var c=1;c+4<t;++c)if(this._isHelixStart(e[c]._index,4)&&this._isHelixStart(e[c-1]._index,4))for(var l=c;l<=c+3;++l)this._ss[e[l]._index]=dn.HELIX_ALPHA;for(var u=1;u+3<t;++u)if(this._isHelixStart(e[u]._index,3)&&this._isHelixStart(e[u-1]._index,3)){for(var h=!0,f=u;h&&f<=u+2;++f)h=void 0===this._ss[e[f]._index]||this._ss[e[f]._index]===dn.HELIX_310;if(h)for(var d=u;d<=u+2;++d)this._ss[e[d]._index]=dn.HELIX_310}for(var p=1;p+5<t;++p)if(this._isHelixStart(e[p]._index,5)&&this._isHelixStart(e[p-1]._index,5)){for(var m=!0,y=p;m&&y<=p+4;++y)m=void 0===this._ss[e[y]._index]||this._ss[e[y]._index]===dn.HELIX_PI||n&&this._ss[e[y]._index]===dn.HELIX_ALPHA;if(m)for(var _=p;_<=p+4;++_)this._ss[e[_]._index]=dn.HELIX_PI}for(var v=1;v+1<t;++v)if(void 0===this._ss[e[v]._index]){for(var g=!1,x=3;x<=5&&!g;++x)for(var b=1;b<x&&!g;++b)g=b<=v&&this._isHelixStart(e[v-b]._index,x);g?this._ss[e[v]._index]=dn.TURN:this._bend[e[v]._index]&&(this._ss[e[v]._index]=dn.BEND)}}},{key:"_residueGetCAlpha",value:function(e){for(var t=0;t<e._atoms.length;++t){var n=e._atoms[t].name;if("CA"===n||"C1"===n)return e._atoms[t].position}return null}},{key:"_cosinusAngle",value:function(e,t,n,r){e=e.clone().sub(t),t=n.clone().sub(r),n=0,r=e.dot(e)*t.dot(t);return 0<r&&(n=e.dot(t)/Math.sqrt(r)),n}},{key:"_kappa",value:function(e,t,n){t=this._residueGetCAlpha(t),e=this._residueGetCAlpha(e),n=this._residueGetCAlpha(n);if(null===t||null===e||null===n)return 180;n=this._cosinusAngle(t,e,n,t),t=Math.sqrt(1-n*n);return 180*Math.atan2(t,n)/Math.PI}},{key:"_isHelixStart",value:function(e,t){return this._helixFlags[t][e]===fn.START||this._helixFlags[t][e]===fn.START_AND_END}},{key:"_buildBetaSheets",value:function(){for(var e=[],t=0;t<this._complex._chains.length;++t){var n=this._chainLengths[t];if(!(n<=4))for(var r=this._complex._chains[t].getResidues(),i=t;i<this._complex._chains.length;++i){var o=this._chainLengths[i];if(!(o<=4))for(var s=this._complex._chains[i].getResidues(),a=1;a+1<n;++a){var c=r[a],l=1;for(i===t&&(l=a+3);l+1<o;++l){var u=s[l],h=this._testBridge(r,a,s,l);if(h!==hn.NO_BRIDGE){var f=!1,d=ln(e);try{for(d.s();!(p=d.n()).done;){var p=p.value;if(h===p.type&&c._index===p.i[p.i.length-1]+1){if(h===hn.PARALLEL&&p.j[p.j.length-1]+1===u._index){p.i.push(c._index),p.j.push(u._index),f=!0;break}if(h===hn.ANTI_PARALLEL&&p.j[0]-1===u._index){p.i.push(c._index),p.j.unshift(u._index),f=!0;break}}}}catch(e){d.e(e)}finally{d.f()}f||e.push({type:h,i:[c._index],chainI:c.getChain()._index,j:[u._index],chainJ:u.getChain()._index})}}}}}e.sort(function(e,t){return e.chainI<t.chainI||e.chainI===t.chainI&&e.i[0]<t.i[0]?-1:1});for(var m=0;m<e.length;++m)for(var y=m+1;y<e.length;++y){var _=e[m].i[0],v=e[m].i[e[m].i.length-1],g=e[m].j[0],x=e[m].j[e[m].j.length-1],b=e[y].i[0],w=e[y].i[e[y].i.length-1],S=e[y].j[0],R=e[y].j[e[y].j.length-1];e[m].type!==e[y].type||this._hasChainBreak(Math.min(_,b),Math.max(v,w))||this._hasChainBreak(Math.min(g,S),Math.max(x,R))||6<=b-v||b<=v&&_<=w||(e[m].type===hn.PARALLEL?S-x<6&&b-v<3||S-x<3:g-R<6&&b-v<3||g-R<3)&&(e[m].i=e[m].i.concat(e[y].i),e[m].type===hn.PARALLEL?e[m].j=e[m].j.concat(e[y].j):e[m].j=e[y].j.concat(e[m].j),e.splice(y--,1))}for(var C=new Set,A=0;A<e.length;++A)C.add(e[A]);for(var E=1,k=0;0<C.size;){var T=C.values().next().value;C.delete(T);var P=new Set;P.add(T);var M=void 0;do{M=new Set;var N,I=ln(P.values());try{for(I.s();!(N=I.n()).done;){var L=N.value,D=ln(C.values());try{for(D.s();!(O=D.n()).done;){var O=O.value;this._areBridgesLinked(L,O)&&M.add(O)}}catch(e){D.e(e)}finally{D.f()}}}catch(e){I.e(e)}finally{I.f()}var V,z=ln(M.values());try{for(z.s();!(V=z.n()).done;)T=V.value,P.add(T),C.delete(T)}catch(e){z.e(e)}finally{z.f()}}while(0<M.size);var F,B=ln(P.values());try{for(B.s();!(F=B.n()).done;)(T=F.value).ladder=k,T.sheet=E,T.link=P,++k}catch(e){B.e(e)}finally{B.f()}++E}for(var U=0;U<e.length;++U){for(var G=e[U],j=0,H=0,W=0;W<G.i.length;++W)if(this._betaPartners[G.i[W]][0]){j=1;break}for(var Y=0;Y<G.j.length;++Y)if(this._betaPartners[G.j[Y]][0]){H=1;break}var X=dn.BRIDGE;if(1<G.i.length&&(X=dn.STRAND),G.type===hn.PARALLEL){for(var q=0,$=0;$<G.i.length;++$)this._betaPartners[G.i[$]][j]={residue:G.j[q++],ladder:G.ladder,parallel:!0};for(var Z=q=0;Z<G.j.length;++Z)this._betaPartners[G.j[Z]][H]={residue:G.i[q++],ladder:G.ladder,parallel:!0}}else{for(var K=G.j.length-1,Q=0;Q<G.i.length;++Q)this._betaPartners[G.i[Q]][j]={residue:G.j[K--],ladder:G.ladder,parallel:!1};K=G.i.length-1;for(var J=0;J<G.j.length;++J)this._betaPartners[G.j[J]][H]={residue:G.i[K--],ladder:G.ladder,parallel:!1}}for(var ee=G.i[0];ee<=G.i[G.i.length-1];++ee)this._ss[ee]!==dn.STRAND&&(this._ss[ee]=X,this._sheet[ee]=G.sheet);for(var te=G.j[0];te<=G.j[G.j.length-1];++te)this._ss[te]!==dn.STRAND&&(this._ss[te]=X,this._sheet[te]=G.sheet)}}},{key:"_testBridge",value:function(e,t,n,r){var i=hn.NO_BRIDGE,o=e[t-1]._index,s=e[t]._index,a=e[t+1]._index,e=n[r-1]._index,t=n[r]._index,n=n[r+1]._index,r=this._hbonds.isBond.bind(this._hbonds);return r(a,t)&&r(t,o)||r(n,s)&&r(s,e)?i=hn.PARALLEL:(r(a,e)&&r(n,o)||r(t,s)&&r(s,t))&&(i=hn.ANTI_PARALLEL),i}},{key:"_areBridgesLinked",value:function(e,t){var n=new Set(e.i),r=new Set(e.j),i=ln(t.i);try{for(i.s();!(o=i.n()).done;){var o=o.value;if(n.has(o)||r.has(o))return!0}}catch(e){i.e(e)}finally{i.f()}var s=ln(t.j);try{for(s.s();!(a=s.n()).done;){var a=a.value;if(n.has(a)||r.has(a))return!0}}catch(e){s.e(e)}finally{s.f()}return!1}},{key:"_hasChainBreak",value:function(e,t){for(var n=e+1;n<=t;++n)if(this._complex._residues[n]._sequence!==this._complex._residues[n-1]._sequence+1)return!0;return!1}}]),t}();pn.StructureType=dn;var mn=pn.StructureType,yn=Xe.Type,_n=(ke(Ya={},mn.HELIX_ALPHA,1),ke(Ya,mn.HELIX_PI,3),ke(Ya,mn.HELIX_310,5),Ya),vn=(ke(Sc={},mn.BRIDGE,yn.BRIDGE),ke(Sc,mn.TURN,yn.TURN),ke(Sc,mn.BEND,yn.BEND),ke(Sc,mn.LOOP,yn.COIL),Sc),gn=function(){function e(){j(this,e),this._chains=[],this._components=[],this._helices=[],this._sheets=[],this.structures=[],this._residueTypes=Object.create(Be.StandardTypes),this._atoms=[],this._residues=[],this._bonds=[],this._sgroups=[],this._molecules=[],this._maskNeedsUpdate=!1,this.metadata={},this.symmetry=[],this.units=[new Nt(this)],this._currentUnit=0}return _(e,[{key:"addAtom",value:function(e){var t=this._atoms.length;return this._atoms.push(e),t}},{key:"addSheet",value:function(e){var t=this._sheets.length;return this._sheets.push(e),t}},{key:"addHelix",value:function(e){var t=this._helices.length;return this._helices.push(e),t}},{key:"getAtoms",value:function(){return this._atoms}},{key:"getBonds",value:function(){return this._bonds}},{key:"getAtomCount",value:function(){return this._atoms.length}},{key:"addResidue",value:function(e){var t=this._residues.length;return this._residues.push(e),t}},{key:"updateToFrame",value:function(t){this.forEachChain(function(e){e.updateToFrame(t)})}},{key:"addResidueType",value:function(e){return this._residueTypes[e]=new Be(e,"Unknown","")}},{key:"getResidueCount",value:function(){return this._residues.length}},{key:"getResidues",value:function(){return this._residues}},{key:"getSGroupCount",value:function(){return this._sgroups.length}},{key:"getSGroups",value:function(){return this._sgroups}},{key:"getAtomByFullname",value:function(e){e=e.split(".");if(3!==e.length)return null;var t=e[0],n=parseInt(e[1],10);if(Number.isNaN(n))return null;var r=e[2].toUpperCase(),i=null;return this.forEachChain(function(e){i||0===e._name.localeCompare(t)&&e.forEachResidue(function(e){i||e._sequence===n&&e.forEachAtom(function(e){i||0===r.localeCompare(e.name)&&(i=e)})})}),i}},{key:"addChain",value:function(e){e=new Ye(this,e);return this._chains.push(e),e}},{key:"getChain",value:function(e){for(var t=0,n=this._chains.length;t<n;++t){var r=this._chains[t];if(r.getName()===e)return r}return null}},{key:"getChainCount",value:function(){return this._chains.length}},{key:"getMolecules",value:function(){return this._molecules}},{key:"getMoleculeCount",value:function(){return this._molecules.length}},{key:"forEachAtom",value:function(e){for(var t=this._atoms,n=0,r=t.length;n<r;++n)e(t[n])}},{key:"forEachBond",value:function(e){for(var t=this._bonds,n=0,r=t.length;n<r;++n)e(t[n])}},{key:"forEachResidue",value:function(e){for(var t=this._residues,n=0,r=t.length;n<r;++n)e(t[n])}},{key:"forEachChain",value:function(e){for(var t=this._chains,n=0,r=t.length;n<r;++n)e(t[n])}},{key:"forEachMolecule",value:function(e){for(var t=this._molecules,n=t.length,r=0;r<n;++r)e(t[r])}},{key:"forEachSGroup",value:function(e){for(var t=this._sgroups,n=0,r=t.length;n<r;++n)e(t[n])}},{key:"forEachComponent",value:function(e){for(var t=this._components,n=0,r=t.length;n<r;++n)e(t[n])}},{key:"forEachVisibleComponent",value:function(e){for(var t=this._components,n=0,r=t.length;n<r;++n)e(t[n])}},{key:"addBond",value:function(e,t,n,r,i){i=new Ie(e,t,n,r,i);return this._bonds.push(i),i}},{key:"getBondCount",value:function(){return this._bonds.length}},{key:"getResidueType",value:function(e){return this._residueTypes[e]||null}},{key:"getUnifiedSerial",value:function(e,t,n){return t+65536*n+16777216*e}},{key:"splitUnifiedSerial",value:function(e){var t=Math.floor(e/16777216),n=e-16777216*t,e=Math.floor(n/65536);return{chain:t,serial:n-65536*e,iCode:e}}},{key:"_fillCmpEdit",value:function(){var t=this,n=this._components;function c(){var e=new Dt(t);return e._index=n.length,n[e._index]=e}this.forEachChain(function(e){var t=e._residues,n=t.length;if(!(n<1))for(var r=c(),i=t[0]._index,o=0;o<n;++o){var s=t[o];s._component=r;var a=o===n-1?null:t[o+1];a&&s.isConnected(a)&&s._index===a._index-1||(r.setSubDivs([{start:i,end:s._index}]),a&&(i=a._index,r=c()))}})}},{key:"_fillCmpNoedit",value:function(){var e=new Dt(this);e._index=0;var t=this._residues,n=t.length;if(0!==n){for(var r=[],i=0,o=0;o<n;++o){var s=t[o];s._component=e;var a=o===n-1?null:t[o+1];a&&s.isConnected(a)||(r[r.length]={start:i,end:o},a&&(i=o+1))}e.setSubDivs(r),this._components[e._index]=e}}},{key:"_fillComponents",value:function(e){e?this._fillCmpEdit():this._fillCmpNoedit()}},{key:"getCurrentUnit",value:function(){return this._currentUnit}},{key:"getDefaultBoundaries",value:function(){return this.units[0].getBoundaries()}},{key:"getBoundaries",value:function(){return this.units[this._currentUnit].getBoundaries()}},{key:"getTransforms",value:function(){return this.units[this._currentUnit].getTransforms()}},{key:"getSelector",value:function(){return this.units[this._currentUnit].getSelector()}},{key:"resetCurrentUnit",value:function(){this._currentUnit=0,this.setCurrentUnit(1)}},{key:"setCurrentUnit",value:function(e){return null!=e&&e!==this._currentUnit&&0<=e&&e<this.units.length&&(this._currentUnit=e,!0)}},{key:"_computeBounds",value:function(){for(var e=this.units,t=0,n=e.length;t<n;++t)e[t].computeBoundaries()}},{key:"onAtomPositionChanged",value:function(){this.forEachChain(function(e){e._finalize()}),this.forEachComponent(function(e){e.update()}),this._computeBounds(),this._finalizeBonds(),this.forEachSGroup(function(e){e._rebuildSGroupOnAtomChange()})}},{key:"update",value:function(){this._maskNeedsUpdate&&(this.updateStructuresMask(),this._maskNeedsUpdate=!1)}},{key:"_finalizeBonds",value:function(){for(var e=this.getBonds(),t=e.length,n=0;n<t;++n)e[n]._index=n}},{key:"finalize",value:function(e){e=e||{};for(var t,n=this._bonds,r=n.length-1;0<=r;r--){var i=n[r];null===i._left||null===i._right?n.splice(r,1):(i._left.bonds.push(i),i._right.bonds.push(i))}var o=this._residues;for(r=0,t=o.length;r<t;++r)o[r]._finalize();this.forEachChain(function(e){e._finalize()});var s=this.units;for(r=0,t=s.length;r<t;++r)s[r].finalize();this.setCurrentUnit(1);var a={};for(r=0,t=o.length;r<t;++r){var c=o[r];a[this.getUnifiedSerial(c.getChain().getName().charCodeAt(0),c.getSequence(),c.getICode().charCodeAt(0))]=c}var l=this.structures;for(r=0,t=l.length;r<t;++r)l[r]._finalize(e.serialAtomMap,a,this);var u=this._helices;for(r=0,t=u.length;r<t;++r)u[r]._finalize(e.serialAtomMap,a,this);var h=this._sheets;for(r=0,t=h.length;r<t;++r)h[r]._finalize(e.serialAtomMap,a,this);this._computeBounds();var f=this._atoms;for(r=0,t=f.length;r<t;++r)f[r].index=r;e.needAutoBonding&&((y=new Wt(this)).build(),y.destroy());var d=this._chains;for(r=0,t=d.length;r<t;++r)d[r]._index=r;for(r=0,t=o.length;r<t;++r)o[r]._index=r;for(r=0,t=f.length;r<t;++r){var p,m=f[r];m.flags&Te.Flags.HYDROGEN&&1===m.bonds.length&&(((p=m.bonds[0])._left!==m&&p._left||p._right).flags&Te.Flags.CARBON&&(m.flags|=Te.Flags.NONPOLARH))}this._finalizeBonds(),this._fillComponents(e.enableEditing);var y=new rn(this);y.markCycles(),e.detectAromaticLoops&&y.detectCycles(),this._finalizeMolecules()}},{key:"_finalizeMolecules",value:function(){for(var e=0;e<this._molecules.length;e++)for(var t=this._molecules[e],n=t.residues.length,r=0;r<n;r++)t.residues[r]._molecule=t}},{key:"updateStructuresMask",value:function(){function e(e){return e.collectMask()}this.forEachResidue(e),this.forEachChain(e),this.forEachMolecule(e)}},{key:"countAtomsByMask",value:function(t){var n=0;return this.forEachAtom(function(e){0!=(e.mask&t)&&n++}),n}},{key:"getNumAtomsBySelector",value:function(t){var n=0;return this.forEachAtom(function(e){t.includesAtom(e)&&n++}),n}},{key:"resetAtomMask",value:function(t){this.forEachAtom(function(e){e.mask=t})}},{key:"markAtoms",value:function(e,t){var n=t,r=~n,i=0,o=Mt.keyword("And")(e,this.getSelector());return this.forEachAtom(function(e){o.includesAtom(e)?(e.mask|=n,i++):e.mask&=r}),this._maskNeedsUpdate=!0,i}},{key:"markAtomsAdditionally",value:function(t,n){var r=n,i=0;return this.forEachAtom(function(e){t.includesAtom(e)&&(e.mask&n)!==n&&(e.mask|=r,i++)}),i}},{key:"clearAtomBits",value:function(e){var t=~e;this.forEachAtom(function(e){e.mask&=t});e=function(e){e._mask&=t};this.forEachAtom(e),this.forEachResidue(e),this.forEachChain(e),this.forEachMolecule(e)}},{key:"getAtomNames",value:function(){if(this.hasOwnProperty("_atomNames"))return this._atomNames;var t={};return this.forEachAtom(function(e){t[e.name]=1}),this._atomNames=Object.keys(t),this._atomNames}},{key:"getElements",value:function(){if(this.hasOwnProperty("_elements"))return this._elements;var t={};return this.forEachAtom(function(e){t[e.element.name]=1}),this._elements=Object.keys(t),this._elements}},{key:"getResidueNames",value:function(){if(this.hasOwnProperty("_residueNames"))return this._residueNames;var t={};return this.forEachResidue(function(e){t[e._type._name]=1}),this._residueNames=Object.keys(t),this._residueNames}},{key:"getChainNames",value:function(){if(this.hasOwnProperty("_chainNames"))return this._chainNames;var t={};return this.forEachChain(function(e){t[e._name]=1}),this._chainNames=Object.keys(t),this._chainNames}},{key:"getAltLocNames",value:function(){if(this.hasOwnProperty("_altlocNames"))return this._altlocNames;var t={};return this.forEachAtom(function(e){t[String.fromCharCode(e.location)]=1}),this._altlocNames=Object.keys(t),this._altlocNames}},{key:"getVoxelWorld",value:function(){if(!this.hasOwnProperty("_voxelWorld"))try{this._voxelWorld=new on(this.getDefaultBoundaries().boundingBox,new ae.Vector3(5,5,5)),this._voxelWorld.addAtoms(this)}catch(e){B.warn("Unable to create voxel world"),this._voxelWorld=null}return this._voxelWorld}},{key:"addElement",value:function(e,t,n,r){for(var i=e.length,o=0;o<i;++o){var s=e[o];r(s,n),t.push(s)}}},{key:"joinComplexes",value:function(e){this._chains=[],this._components=[],this._helices=[],this._sheets=[],this.structures=[],this._atoms=[],this._residues=[],this._bonds=[],this._sgroups=[];var n=this,t=0,r=0,i=0,o=0,s=0;function a(e,t){e.serial+=t,e.index+=t}function c(e,t){e._index+=t}function l(e,t){e._index+=t}function u(e,t){e._complex=n,e._index+=t}function h(e,t){e._complex=n,e._index+=t}function f(){}for(var d=0;d<e.length;++d){var p,m=e[d];for(p in this.addElement(m._atoms,this._atoms,t,a),this.addElement(m._bonds,this._bonds,r,c),this.addElement(m._residues,this._residues,i,l),this.addElement(m._chains,this._chains,o,u),this.addElement(m._sheets,this._sheets,0,f),this.addElement(m._helices,this._helices,0,f),this.addElement(m._sgroups,this._sgroups,0,f),this.addElement(m._components,this._components,s,h),this.addElement(m.structures,this.structures,0,f),m._residueTypes)m._residueTypes.hasOwnProperty(p)&&(this._residueTypes[p]=m._residueTypes[p]);t+=m._atoms.length,r+=m._bonds.length,i+=m._residues.length,o+=m._chains.length,s+=m._components.length}this._computeBounds()}},{key:"dssp",value:function(){for(var e,t,n,r=new pn(this),i=this.structures=[],o=this._helices=[],s=this._sheets=[],a=0,c=null,l=0,u=this._residues.length;l<u;++l){var h,f,d,p=r._ss[l],m=this._residues[l],y=r._sheet[l];p!==e||y!==t?(h=_n[p],f=vn[p],p===mn.STRAND?(d=s[n=y]||(s[n]=new it(String(n),0)),c=new rt(d,m,m,0,null,null),d.addStrand(c)):void 0!==h?(c=new Je(h,m,m,++a,String(a),"",1),o.push(c)):c=void 0!==f?new Xe(f,m,m):null,c&&i.push(c),m._secondary=c,e=p,t=y):((m._secondary=c)&&(c.term=m),c instanceof Je&&c.length++)}this._sheets=s.filter(function(e){return!0})}}]),e}();function xn(e){var t=2;for(e=e-1>>1;e;)t<<=1,e>>=1;return t}gn.prototype.id="Complex",gn.prototype.name="";var bn=function(){function v(e,t,n,r,i,o){switch(j(this,v),this._box=n.clone(),this._dimVec=Math.max(Math.floor(r||1),1),this._volumeInfo=o,t instanceof Array?(o=m(t,3),this._dimX=o[0],this._dimY=o[1],this._dimZ=o[2]):(this._dimX=t.x,this._dimY=t.y,this._dimZ=t.z),this._dimX=Math.max(Math.floor(this._dimX),1),this._dimY=Math.max(Math.floor(this._dimY),1),this._dimZ=Math.max(Math.floor(this._dimZ),1),this._rowElements=this._dimVec*this._dimX,this._planeElements=this._rowElements*this._dimY,this._totalElements=this._planeElements*this._dimZ,this._data=i||ce.allocateTyped(e,this._totalElements),this._dimVec){case 1:break;case 2:this.getValue=function(e,t,n){n=e*this._dimVec+t*this._rowElements+n*this._planeElements;return[this._data[n],this._data[1+n]]},this.setValue=function(e,t,n,r,i){n=e*this._dimVec+t*this._rowElements+n*this._planeElements;this._data[n]=r,this._data[1+n]=i},this.addValue=function(e,t,n,r,i){n=e*this._dimVec+t*this._rowElements+n*this._planeElements;this._data[n]+=r,this._data[1+n]+=i};break;case 3:this.getValue=function(e,t,n){n=e*this._dimVec+t*this._rowElements+n*this._planeElements;return[this._data[n],this._data[1+n],this._data[2+n]]},this.setValue=function(e,t,n,r,i,o){n=e*this._dimVec+t*this._rowElements+n*this._planeElements;this._data[n]=r,this._data[1+n]=i,this._data[2+n]=o},this.addValue=function(e,t,n,r,i,o){n=e*this._dimVec+t*this._rowElements+n*this._planeElements;this._data[n]+=r,this._data[1+n]+=i,this._data[2+n]+=o};break;default:throw new Error("Volume: invalid vector dimension")}}return _(v,[{key:"getValue",value:function(e,t,n){return this._data[e+t*this._rowElements+n*this._planeElements]}},{key:"setValue",value:function(e,t,n,r){this._data[e+t*this._rowElements+n*this._planeElements]=r}},{key:"addValue",value:function(e,t,n,r){this._data[e+t*this._rowElements+n*this._planeElements]+=r}},{key:"getDimensions",value:function(){return[this._dimX,this._dimY,this._dimZ]}},{key:"getBox",value:function(){return this._box}},{key:"getVolumeInfo",value:function(){return this._volumeInfo}},{key:"getCellSize",value:function(){var e=new ae.Vector3;this._box.getSize(e);var t=new ae.Vector3;return t.x=1<this._dimX?e.x/(this._dimX-1):0,t.y=1<this._dimY?e.y/(this._dimY-1):0,t.z=1<this._dimZ?e.z/(this._dimZ-1):0,t}},{key:"computeGradient",value:function(){if(1!==this._dimVec)return null;var e=new v(Float32Array,[this._dimX,this._dimY,this._dimZ],this._box,3),t=this.getCellSize(),n=new ae.Vector3(-.5/t.x,-.5/t.y,-.5/t.z);function r(e,t,n){return Math.min(n,Math.max(t,e))}var i=this._dimX,o=this._dimY,s=this._dimZ,a=this._data;function c(e,t,n){return a[n*i*o+t*i+e]}for(var l=0;l<s;++l)for(var u=r(l-1,0,s-1),h=r(l+1,0,s-1),f=0;f<o;++f)for(var d=r(f-1,0,o-1),p=r(f+1,0,o-1),m=0;m<i;++m){var y=r(m-1,0,i-1),_=r(m+1,0,i-1);e.setValue(m,f,l,(c(_,f,l)-c(y,f,l))*n.x,(c(m,p,l)-c(m,d,l))*n.y,(c(m,f,h)-c(m,f,u))*n.z)}return e}},{key:"normalize",value:function(){for(var e=this._data,t=e[0],n=e[0],r=1;r<e.length;++r)t=Math.min(t,e[r]),n=Math.max(n,e[r]);var i=1/(n-t);if(0!=i)for(var o=0;o<e.length;++o)e[o]=i*(e[o]-t)}},{key:"getTiledTextureStride",value:function(){return[this._dimX+2,this._dimY+2]}},{key:"buildTiledTexture",value:function(){for(var e,t,n=xn(n=(r=Math.ceil(Math.sqrt(this._dimZ*this._dimY/this._dimX)))*(this._dimX+2)-1),r=Math.floor(n/(this._dimX+2)),i=Math.ceil(this._dimZ/r),o=xn(o=i*(this._dimY+2)-1),s=new Uint8Array(n*o),a=0;a<i;++a)for(var c=0;c<this._dimY;++c){e=a*r*this._planeElements+c*this._rowElements,t=n*(a*(this._dimY+2)+c);for(var l=0;l<r;++l){for(var u=0;u<this._dimX;++u)s[t++]=255*this._data[e++];s[t++]=255*this._data[e-1],l<r-1&&(e+=this._planeElements-this._rowElements,s[t++]=255*this._data[e])}}for(var h=0;h<i;++h){t=(e=n*(h*(this._dimY+2)+this._dimY-1))+n;for(var f=0;f<n;++f)s[t++]=s[e++];if(h<i-1){t=(e=n*(h+1)*(this._dimY+2))-n;for(var d=0;d<n;++d)s[t++]=s[e++]}}o=new ae.DataTexture(s,n,o,ae.LuminanceFormat,ae.UnsignedByteType,ae.UVMapping,ae.ClampToEdgeWrapping,ae.ClampToEdgeWrapping,ae.LinearFilter,ae.LinearFilter);return o.needsUpdate=!0,o}},{key:"getData",value:function(){return this._data}},{key:"getDirectIdx",value:function(e,t,n){return e*this._dimVec+t*this._rowElements+n*this._planeElements}},{key:"getStrideX",value:function(){return this._dimVec}},{key:"getStrideY",value:function(){return this._rowElements}},{key:"getStrideZ",value:function(){return this._planeElements}}]),v}();bn.prototype.id="Volume";var wn={Atom:Te,Element:Pe,Bond:Ie,Residue:Fe,ResidueType:Be,Chain:Ye,Helix:Je,Strand:rt,Sheet:it,SGroup:ot,Assembly:Lt,Complex:gn,Volume:bn,VoxelWorld:on,selectors:Mt,Molecule:function(){function r(e,t,n){j(this,r),this.complex=e,this.name=t||"",this.residues=[],this.mask=1,this.index=n||-1}return _(r,[{key:"forEachResidue",value:function(e){for(var t=this.residues,n=0,r=t.length;n<r;++n)e(t[n])}},{key:"collectMask",value:function(){for(var e=4294967295,t=this.residues,n=0,r=t.length;n<r;++n)e&=t[n]._mask;this.mask=e}}]),r}()};function Sn(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var Rn=function(e){A(i,e);var r=Sn(i);function i(e){var t;j(this,i),t=r.call(this);var n=k(t);return t._element=e,t._element.style.position="absolute",t.addEventListener("removed",function(){null!==n._element.parentNode&&n._element.parentNode.removeChild(n._element)}),t}return _(i,[{key:"getElement",value:function(){return this._element}},{key:"setTransparency",value:function(e){var t,n=this.getElement();null!==n&&(1!==e?(n.style.display="inline",e=(t=1-e).toString(),t=100*t,n.style.opacity=e,n.style.filter="alpha(opacity=".concat(t,")")):n.style.display="none")}},{key:"clone",value:function(){var e=new i(this._element);return e.copy(this),e}}]),i}(ae.Object3D);function Cn(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var An=function(e){A(n,e);var t=Cn(n);function n(){return j(this,n),t.apply(this,arguments)}return _(n,[{key:"raycast",value:function(e,t){if(this.visible)for(var n=this.children,r=0,i=n.length;r<i;++r)n[r].raycast(e,t)}},{key:"enableSubset",value:function(e,t){for(var n=this.children,r=0,i=n.length;r<i;++r)n[r].enableSubset&&n[r].enableSubset(e,t)}},{key:"disableSubset",value:function(e,t){for(var n=this.children,r=0,i=n.length;r<i;++r)n[r].disableSubset&&n[r].disableSubset(e,t)}},{key:"isEmpty",value:function(){return 0===this.children.length}},{key:"updateToFrame",value:function(e){for(var t=this.children,n=0,r=t.length;n<r;++n)t[n].updateToFrame&&t[n].updateToFrame(e)}},{key:"getSubset",value:function(e,t){for(var n=[],r=this.children,i=0,o=r.length;i<o;++i)r[i].getSubset&&Array.prototype.push.apply(n,r[i].getSubset(e,t));return n}}]),n}(ae.Group),En="uniform mat4 projectionMatrix;\nuniform mat4 modelViewMatrix;\n\nattribute vec2 uv;\nattribute vec3 position;\n\nvarying vec2 vUv;\n\nvoid main() {\n  vUv = uv;\n  gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}\n";function kn(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var Tn,Pn,Mn={DEFAULT:0,VOLUME:1,TRANSPARENT:2,PREPASS_TRANSPARENT:3,VOLUME_BFPLANE:4,COLOR_FROM_POSITION:5,SHADOWMAP:6},Nn=[Mn.DEFAULT,Mn.TRANSPARENT];ae.Object3D.prototype.resetTransform=function(){this.position.set(0,0,0),this.quaternion.set(0,0,0,1),this.scale.set(1,1,1)},ae.Object3D.prototype.updateMatrixWorldRecursive=function(){null!=this.parent&&this.parent.updateMatrixWorldRecursive(),this.updateMatrixWorld()},ae.Object3D.prototype.addSavingWorldTransform=(Tn=new ae.Matrix4,function(e){e instanceof ae.Object3D&&(Tn.copy(this.matrixWorld).invert(),Tn.multiply(e.matrixWorld),e.matrix.copy(Tn),e.matrix.decompose(e.position,e.quaternion,e.scale),this.add(e))}),ae.WebGLRenderer.prototype.renderDummyQuad=function(){var e=new ae.MeshBasicMaterial({transparent:!0,opacity:0,depthWrite:!1}),t=new ae.Scene,e=new ae.Mesh(new ae.PlaneBufferGeometry(.01,.01),e);t.add(e);var n=new ae.OrthographicCamera(-.5,.5,.5,-.5,-1e4,1e4);return n.position.z=100,function(){this.render(t,n)}}(),ae.WebGLRenderer.prototype.renderScreenQuad=function(){var t=new ae.Scene,n=new ae.Mesh(new ae.PlaneBufferGeometry(1,1));t.add(n);var r=new ae.OrthographicCamera(-.5,.5,.5,-.5,-1e4,1e4);return r.position.z=100,function(e){n.material=e,this.render(t,r)}}(),ae.Matrix4.prototype.isIdentity=(Pn=new ae.Matrix4,function(){return Pn.equals(this)}),ae.Matrix4.prototype.applyToPointsArray=function(e,t,n){if(!e||!t||t<3)return e;n=n||0;for(var r=this.elements,i=0;i<e.length;i+=t){var o=e[i],s=e[i+1],a=e[i+2],c=1/(r[3]*o+r[7]*s+r[11]*a+r[15]);e[i]=(r[0]*o+r[4]*s+r[8]*a+r[12]*n)*c,e[i+1]=(r[1]*o+r[5]*s+r[9]*a+r[13]*n)*c,e[i+2]=(r[2]*o+r[6]*s+r[10]*a+r[14]*n)*c}return e};var In,Ln,Dn,On=function(e){A(n,e);var t=kn(n);function n(e){return j(this,n),void 0===e.uniforms&&(e.uniforms={}),e.uniforms.srcTex={type:"t",value:null},e.vertexShader=En,e.transparent=!1,e.depthTest=!1,e.depthWrite=!1,t.call(this,e)}return n}(ae.RawShaderMaterial);function Vn(e){e.traverse(function(e){(e instanceof ae.Mesh||e instanceof ae.LineSegments||e instanceof ae.Line)&&e.geometry.dispose()}),function(e){for(var t=e.children,n=0,r=t.length;n<r;++n){var i=t[n];i.parent=null,i.dispatchEvent({type:"removed"})}e.children=[]}(e)}ae.WebGLRenderer.prototype.renderScreenQuadFromTex=(In=new On({uniforms:{opacity:{type:"f",value:1}},fragmentShader:"precision highp float;\n\nvarying vec2 vUv;\nuniform sampler2D srcTex;\nuniform float opacity;\n\nvoid main() {\n  vec4 color = texture2D(srcTex, vUv);\n  gl_FragColor = vec4(color.xyz, color.a * opacity);\n}\n",transparent:!0}),function(e,t){In.uniforms.srcTex.value=e,In.transparent=t<1,In.uniforms.opacity.value=t,this.renderScreenQuad(In)}),ae.WebGLRenderer.prototype.renderScreenQuadFromTexWithDistortion=(Ln=new On({uniforms:{coef:{type:"f",value:1}},fragmentShader:"precision highp float;\n\nvarying vec2 vUv;\nuniform sampler2D srcTex;\nuniform float coef;\n\nvoid main() {\n  vec2 uv = vUv * 2.0 - 1.0;\n  float r2 = dot(uv, uv);\n  vec2 tc = uv * (1.0 + coef * r2);\n  if (!all(lessThan(abs(tc), vec2(1.0))))\n    discard;\n  tc = 0.5 * (tc + 1.0);\n  gl_FragColor = texture2D(srcTex, tc);\n}\n"}),function(e,t){Ln.uniforms.srcTex.value=e,Ln.uniforms.coef.value=t,this.renderScreenQuad(Ln)}),ae.PerspectiveCamera.prototype.setMinimalFov=function(e){1<=this.aspect?this.fov=e:this.fov=ae.MathUtils.radToDeg(2*Math.atan(Math.tan(.5*ae.MathUtils.degToRad(e))/this.aspect))},ae.StereoCamera.prototype.updateHalfSized=function(e,t){var n=e.aspect,r=e.fov;e.aspect=n/2,e.setMinimalFov(t),e.updateProjectionMatrix(),this.update(e),e.aspect=n,e.fov=r,e.updateProjectionMatrix()},ae.PerspectiveCamera.prototype.setDistanceToFit=function(e,t){this.position.z=e/Math.sin(.5*ae.MathUtils.degToRad(t))},ae.Raycaster.prototype.intersectVisibleObject=function(e,t,n,r){var i=this.intersectObject(e,!1);if(0===i.length)return null;for(var o=Math.min(t.near,n),s=i[0],a=new ae.Vector3,c=0;c<i.length&&(s=i[c],a.copy(s.point),a.applyMatrix4(t.matrixWorldInverse),!(a.z<=-o));++c);if(c===i.length)return null;r=Math.min(t.far,r);return a.copy(s.point),a.applyMatrix4(t.matrixWorldInverse),a.z<=-r?null:s},ae.Matrix4.prototype.extractScale=(Dn=new ae.Vector3,function(e){void 0===e&&(B.debug("extractScale(): new is too expensive operation to do it on-the-fly"),e=Dn.clone());var t=this.elements;return e.x=Dn.set(t[0],t[1],t[2]).length(),e.y=Dn.set(t[4],t[5],t[6]).length(),e.z=Dn.set(t[8],t[9],t[10]).length(),this.determinant()<0&&(e.x=-e.x),e}),ae.BufferAttribute.prototype.copyAtList=function(e,t){for(var n=this.itemSize,r=0,i=t.length;r<i;++r)for(var o=0;o<n;++o)this.array[r*n+o]=e.array[t[r]*n+o];return this};var zn=ae.InstancedBufferGeometry.prototype.copy;ae.InstancedBufferGeometry.prototype.copy=function(e){zn.call(this,e),void 0===this.instanceCount&&(this.instanceCount=1/0)};var Fn={calcCylinderMatrix:function(e,t,n){var r=e.clone().lerp(t,.5),i=new ae.Matrix4;i.makeScale(n,e.distanceTo(t),n);var o=new ae.Matrix4;return o.makeRotationX(Math.PI/2),e=new ae.Matrix4,n=new ae.Vector3(0,1,0),e.lookAt(r,t,n),e.multiply(o),e.multiply(i),e.setPosition(r),e},calcChunkMatrix:function(e,t,n,r){var i=new ae.Matrix4;return i.makeScale(r.x,r.y,0),(r=new ae.Matrix4).lookAt(e,t,n),r.multiply(i),r.setPosition(e),r},groupHasGeometryToRender:function(e){var t=!1;return e.traverse(function(e){(e.hasOwnProperty("geometry")||e instanceof Rn)&&(t=!0)}),t},buildDistorionMesh:function(e,t,i){for(var n=(t=new ae.PlaneBufferGeometry(2,2,e,t)).getAttribute("position"),r=0;r<n.count;++r){var o=n.array[3*r],s=n.array[3*r+1],a=function(e){for(var t=0,n=e,r=1;1e-5<Math.abs(n-t);)n=e/((r=1+i*(t=n))*r);return 1/r}(o*o+s*s);n.setXY(r,a*o,a*s)}return t},RCGroup:An,fillArray:function(e,t,n,r){n=void 0!==n?n:0,r=void 0!==r?r:e.length;for(var i=n;i<r;++i)e[i]=t},clearTree:Vn,destroyObject:function(e){Vn(e),e.parent?e.parent.remove(e):e.dispatchEvent({type:"removed"})},belongToSelectLayers:function(e){for(var t=0;t<Nn.length;t++)if(1==(e.layers.mask>>Nn[t]&1))return!0;return!1},processObjRenderOrder:function(e,t){var n=+("BA"!==t);e.traverse(function(e){e.isGroup&&(e.renderOrder=n)})},applySelectionMaterial:function(e){e.traverse(function(e){"material"in e&&(e.material=e.material.clone(!0),e.material.setValues({depthFunc:ae.LessEqualDepth,overrideColor:!0,fog:!1,lights:!1,shadowmap:!1}),e.material.setUberOptions({fixedColor:new ae.Color(16776960),zOffset:-1e-6}))})},getMiddlePoint:function(e,t,n){return(n=n||new ae.Vector3).set(0,0,0),n.addScaledVector(e,.5),n.addScaledVector(t,.5),n},LAYERS:Mn};function Bn(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var Un={boundingBox:new ae.Box3(new ae.Vector3(-1,-1,-1),new ae.Vector3(1,1,1)),boundingSphere:new ae.Sphere(new ae.Vector3(0,0,0),1)},Gn=function(e){A(i,e);var r=Bn(i);function i(e,t){var n;return j(this,i),(n=r.call(this,e,t)).name=e,n._dataSource=t,n}return _(i,[{key:"release",value:function(){this.parent&&this.parent.remove(this)}},{key:"getDataSource",value:function(){return this._dataSource}},{key:"getBoundaries",value:function(){return Un}}]),i}(Fn.RCGroup);var jn=function(e){if(Array.isArray(e))return s(e)};var Hn=function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)};var Wn=function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")};var Yn=function(e){return jn(e)||Hn(e)||a(e)||Wn()};function Xn(e){return null==e||Array.isArray(e)?e:[e]}var qn=function(){function r(){var t=this,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:["id"];j(this,r),this._list=[],this._dict={},this._indices=Yn(n),this._indices.forEach(function(e){t._dict[e]={}}),e.forEach(function(e){return t.register(e)})}return _(r,[{key:"register",value:function(t){var n=this;r.registerInList(this._list,t),this._indices.forEach(function(e){r.registerInDict(n._dict[e],Xn(t[e]),t)})}},{key:"unregister",value:function(t){var n=this;r.unregisterFromList(this._list,t),this._indices.forEach(function(e){r.unregisterFromDict(n._dict[e],Xn(t[e]),t)})}},{key:"keys",value:function(e){return Object.keys(this._dict[e||this._indices[0]])}},{key:"get",value:function(e,t){t=this._dict[t||this._indices[0]];if(t){e=t[e&&e.toLowerCase()];return e&&0<e.length?e[0]:void 0}}},{key:"all",get:function(){return Yn(this._list)}},{key:"first",get:function(){return this._list[0]}}],[{key:"registerInList",value:function(e,t){e.includes(t)||e.push(t)}},{key:"unregisterFromList",value:function(e,t){t=e.indexOf(t);-1!==t&&e.splice(t,1)}},{key:"registerInDict",value:function(t,e,n){e.forEach(function(e){e=e.toLowerCase();e=t[e]=t[e]||[];e.includes(n)||e.push(n)})}},{key:"unregisterFromDict",value:function(r,e,i){e.forEach(function(e){e=e.toLowerCase();var t,n=r[e];n&&(-1!==(t=n.indexOf(i))&&n.splice(t,1),0===n.length&&delete r[e])})}}]),r}();function $n(e){Object.defineProperties(e,{logger:{get:function(){return this.context&&this.context.logger?this.context.logger:B}},settings:{get:function(){return this.context&&this.context.settings?this.context.settings:oe}}})}function Zn(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var Kn=function(){function r(e,t){j(this,r),this._position=e,this._radius=t}return _(r,[{key:"raycast",value:function(e){var t=r._sphere;t.set(this._position,this._radius);var n=new ae.Vector3;return e.ray.intersectSphere(t,n)?{distance:e.ray.origin.distanceTo(n),point:n}:null}}]),r}();ke(Kn,"_sphere",new ae.Sphere);var Qn=function(e){return function(){A(s,e);var o=Zn(s);function s(e){var t;j(this,s);for(var n=arguments.length,r=new Array(1<n?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];return(t=o.call.apply(o,[this].concat(r)))._objects=new Array(e),t.boundingSphere=null,t.boundingBox=null,t}return _(s,[{key:"setSphere",value:function(e,t,n){this._objects[e]=new Kn(t,n)}},{key:"raycast",value:function(e,t){for(var n=0,r=this._objects.length;n<r;++n){var i=this._objects[n].raycast(e);i&&(i.chunkIdx=n,t.push(i))}}},{key:"computeBoundingBox",value:function(){var e=this._objects,t=this.boundingBox;null===t&&(this.boundingBox=t=new ae.Box3),t.makeEmpty();for(var n=0,r=e.length;n<r;++n)t.expandByPoint(e[n]._position)}},{key:"computeBoundingSphere",value:function(){this.computeBoundingBox();var e=this._objects,t=this.boundingBox,n=0,r=new ae.Vector3;t.getCenter(r);for(var i=0,o=e.length;i<o;++i){var s=e[i]._position,s=r.distanceToSquared(s);n<s&&(n=s)}null===this.boundingSphere&&(this.boundingSphere=new ae.Sphere),this.boundingSphere.set(r,Math.sqrt(n))}}]),s}()};function Jn(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var er=new ae.Color,tr=ce.copySubArrays;var nr=function(e){A(o,e);var i=Jn(o);function o(e,t,n){var r;return j(this,o),(r=i.call(this,e))._sphGeometry=n?new ae.PlaneBufferGeometry(2,2,1,1):new ae.SphereBufferGeometry(1,2*t,t,0,2*Math.PI,0,Math.PI),r._init(e,r._sphGeometry),r}return _(o,[{key:"setItem",value:function(e,t,n){var r,i,o,s,a,c;r=this._offsets,i=4*e,o=t.x,s=t.y,a=t.z,c=n,r[i]=o,r[i+1]=s,r[i+2]=a,r[i+3]=c,this.setSphere(e,t,n)}},{key:"setColor",value:function(e,t){var n,r,i;er.set(t),n=this._colors,r=3*e,i=er.r,t=er.g,e=er.b,n[r]=i,n[r+1]=t,n[r+2]=e}},{key:"startUpdate",value:function(){return!0}},{key:"finishUpdate",value:function(){this.getAttribute("offset").needsUpdate=!0,this.getAttribute("color").needsUpdate=!0}},{key:"finalize",value:function(){this.finishUpdate(),this.computeBoundingSphere()}},{key:"setOpacity",value:function(e,t){for(var n=this._alpha,r=0,i=e.length;r<i;++r)n[e[r]]=t;this.getAttribute("alphaColor").needsUpdate=!0}},{key:"getSubset",value:function(e){var t=e.length,n=new ae.InstancedBufferGeometry;return this._init.call(n,t,this._sphGeometry),tr(this._offsets,n._offsets,e,4),tr(this._colors,n._colors,e,3),n.boundingSphere=this.boundingSphere,n.boundingBox=this.boundingBox,[n]}},{key:"_init",value:function(e,t){this.copy(t),this._offsets=ce.allocateTyped(Float32Array,4*e),this._colors=ce.allocateTyped(Float32Array,3*e);e=this._alpha=ce.allocateTyped(Float32Array,e);b.default.fill(e,1),this.setAttribute("offset",new ae.InstancedBufferAttribute(this._offsets,4,!1,1)),this.setAttribute("color",new ae.InstancedBufferAttribute(this._colors,3,!1,1)),this.setAttribute("alphaColor",new ae.InstancedBufferAttribute(e,1,!1,1))}}]),o}(Qn(ae.InstancedBufferGeometry));function rr(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var ir=function(e){A(d,e);var t=rr(d);function d(){return j(this,d),t.apply(this,arguments)}return _(d,[{key:"uvIntersection",value:function(e,t,n,r,i,o,s){var a=d._barycoord;return ae.Triangle.barycoordFromPoint(e,t,n,r,a),i.multiplyScalar(a.x),o.multiplyScalar(a.y),s.multiplyScalar(a.z),i.add(o).add(s),i.clone()}},{key:"checkIntersection",value:function(e,t,n,r,i,o,s){return null===n.intersectTriangle(r,i,o,!1,s)?null:{point:s.clone()}}},{key:"checkBufferGeometryIntersection",value:function(e,t,n,r,i,o,s,a){var c=d._vA,l=d._vB,u=d._vC,h=d._intersectionPoint;c.fromBufferAttribute(r,o),l.fromBufferAttribute(r,s),u.fromBufferAttribute(r,a);var f,e=this.checkIntersection(e,t,n,c,l,u,h);return e&&(i&&(t=d._uvB,f=d._uvC,(n=d._uvA).fromBufferAttribute(i,o),t.fromBufferAttribute(i,s),f.fromBufferAttribute(i,a),e.uv=this.uvIntersection(h,c,l,u,n,t,f)),f=new ae.Vector3,ae.Triangle.getNormal(c,l,u,f),e.face=new ae.Face3(o,s,a,f),e.faceIndex=o),e}},{key:"raycast",value:function(e,t){var n=e.ray;if(null===this.boundingSphere&&this.computeBoundingSphere(),!1!==e.ray.intersectsSphere(this.boundingSphere)&&(null===this.boundingBox||!1!==n.intersectsBox(this.boundingBox))){var r,i,o=this.index,s=this.attributes,a=s.position,c=s.uv;if(null!==o)for(var l=0,u=o.count;l<u;l+=3){r=o.getX(l),i=o.getX(l+1),h=o.getX(l+2);var h=this.checkBufferGeometryIntersection(this,e,n,a,c,r,i,h);h&&(h.faceIndex=Math.floor(l/3),t.push(h))}}}}]),d}(ae.BufferGeometry);function or(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}ke(ir,"_vA",new ae.Vector3),ke(ir,"_vB",new ae.Vector3),ke(ir,"_vC",new ae.Vector3),ke(ir,"_uvA",new ae.Vector2),ke(ir,"_uvB",new ae.Vector2),ke(ir,"_uvC",new ae.Vector2),ke(ir,"_barycoord",new ae.Vector3),ke(ir,"_intersectionPoint",new ae.Vector3);var sr=new ae.Color,ar=function(){A(s,ir);var r=or(s);function s(e,t){var n;if(j(this,s),(n=r.call(this)).constructor===s)throw new Error("Can not instantiate abstract class!");return n._chunkGeo=e,n._init(e,t),n}return _(s,[{key:"startUpdate",value:function(){return!0}},{key:"finishUpdate",value:function(){this.getAttribute("position").needsUpdate=!0,this.getAttribute("normal").needsUpdate=!0,this.getAttribute("color").needsUpdate=!0}},{key:"setColor",value:function(e,t){sr.set(t);for(var n=this._colors,t=this._chunkSize,r=e*t,i=r+t;r<i;++r){var o=3*r;n[o]=sr.r,n[1+o]=sr.g,n[2+o]=sr.b}}},{key:"finalize",value:function(){this.finishUpdate(),this.computeBoundingSphere()}},{key:"setOpacity",value:function(e,t){for(var n=this._alpha,r=this._chunkSize,i=0,o=e.length;i<o;++i){var s=e[i]*r;b.default.fill(n,t,s,s+r)}this.getAttribute("alphaColor").needsUpdate=!0}},{key:"raycast",value:function(e,t){var n=[];tt(P(s.prototype),"raycast",this).call(this,e,n);for(var r=this._chunkGeo.index.count/3,i=0,o=n.length;i<o;++i)n[i].hasOwnProperty("faceIndex")&&(n[i].chunkIdx=Math.floor(n[i].faceIndex/r),t.push(n[i]))}},{key:"getSubset",value:function(e){var t=e.length,n=new ae.BufferGeometry;this._init.call(n,this._chunkGeo,t);for(var r=this._positions,i=this._normals,o=this._colors,s=n._positions,a=n._normals,c=n._colors,l=3*this._chunkSize,u=0,h=e.length;u<h;++u){var f=u*l,d=e[u]*l,p=d+l;s.set(r.subarray(d,p),f),a.set(i.subarray(d,p),f),c.set(o.subarray(d,p),f)}return n.boundingSphere=this.boundingSphere,n.boundingBox=this.boundingBox,[n]}},{key:"_init",value:function(e,t){var n=this._chunkSize=e.attributes.position.count,r=e.index.array,i=r.length,o=this._chunkSize*t,s=65535<o,e=i*t,a=this._index=ce.allocateTyped(s?Uint32Array:Uint16Array,e);this._positions=ce.allocateTyped(Float32Array,3*o),this._normals=ce.allocateTyped(Float32Array,3*o),this._colors=ce.allocateTyped(Float32Array,3*o);o=this._alpha=ce.allocateTyped(Float32Array,o);b.default.fill(o,1);for(var c=0;c<t;++c){var l=c*i,u=c*n;a.set(r,l);for(var h=0;h<i;++h)a[l+h]+=u}this.setIndex(new ae.BufferAttribute(this._index,1)),this.setAttribute("position",new ae.BufferAttribute(this._positions,3)),this.setAttribute("normal",new ae.BufferAttribute(this._normals,3)),this.setAttribute("color",new ae.BufferAttribute(this._colors,3)),this.setAttribute("alphaColor",new ae.BufferAttribute(o,1))}}]),s}();function cr(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var lr=3,ur=function(e){A(c,e);var a=cr(c);function c(e,t){j(this,c);var n=new ae.SphereBufferGeometry(1,2*t,t,0,2*Math.PI,0,Math.PI),r=(t=a.call(this,e,n,e))._normals,i=n.attributes.normal.array,o=t._chunkSize;t._chunkPos=t._chunkGeo.attributes.position.array,t._tmpPositions=ce.allocateTyped(Float32Array,o*lr);for(var s=0;s<e;++s)r.set(i,o*lr*s);return t}return _(c,[{key:"setItem",value:function(e,t,n){for(var r=this._tmpPositions,i=this._chunkSize,o=this._chunkPos,s=0;s<i;++s){var a=3*s;r[a]=t.x+o[a]*n,r[1+a]=t.y+o[1+a]*n,r[2+a]=t.z+o[2+a]*n}this._positions.set(r,i*e*lr),this.setSphere(e,t,n)}}]),c}(Qn(ar));function hr(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var fr=3,dr=new ae.Vector3,pr=new ae.Vector3,mr=new ae.Matrix3,yr=function(){A(r,ar);var n=hr(r);function r(e,t){j(this,r);var t=new ae.CylinderBufferGeometry(1,1,1,Math.max(3,t),2,!0),e=(t=n.call(this,t,2*e))._chunkSize;return t._chunkPos=t._chunkGeo.attributes.position.array,t._chunkNorms=t._chunkGeo.attributes.normal.array,t._tmpVector=ce.allocateTyped(Float32Array,e*fr),t}return _(r,[{key:"setItem",value:function(e,t,n,r){var i=this._chunkSize,o=2*i*e*fr,e=o+i*fr,s=this._tmpVector,a=this._chunkPos,c=this._chunkNorms;dr.lerpVectors(t,n,.5);var l,u=Fn.calcCylinderMatrix(t,dr,r);mr.getNormalMatrix(u);for(var h=0;h<i;++h)l=h*fr,pr.fromArray(a,l),pr.applyMatrix4(u),pr.toArray(s,l);this._positions.set(s,o),dr.sub(t);for(var f=0;f<i;++f)s[l=f*fr]+=dr.x,s[l+1]+=dr.y,s[l+2]+=dr.z;this._positions.set(s,e);for(var d=0;d<i;++d)l=d*fr,pr.fromArray(c,l),pr.applyMatrix3(mr),pr.toArray(s,l);this._normals.set(s,o),this._normals.set(s,e)}},{key:"setColor",value:function(e,t,n){e*=2;tt(P(r.prototype),"setColor",this).call(this,e,t);e=1+e;tt(P(r.prototype),"setColor",this).call(this,e,n)}}]),r}();function _r(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var vr=3,gr=function(e){A(G,e);var U=_r(G);function G(e,t,n,r,i,o){var s;j(this,G),s=U.call(this);var a=2*Math.PI;s.type="CylinderBufferGeometry";for(var c=!(s.parameters={radiusTop:e,radiusBottom:t,height:n,radialSegments:r,heightSegments:i,openEnded:o})===o&&0<e,l=!1===o&&0<t,u=(i+1)*r+c*(r+1)+l*(r+1),o=(2*i+c+l)*r,h=n/2,f=new ae.BufferAttribute(ce.allocateTyped(Float32Array,3*u),3),d=new ae.BufferAttribute(ce.allocateTyped(Float32Array,3*u),3),p=new ae.Uint16BufferAttribute(ce.allocateTyped(Uint16Array,o*vr),1),m=new ae.BufferAttribute(ce.allocateTyped(Float32Array,2*u),2),y=0,_=0,v=-(t-e)/n,g=0;g<=i;g++){if(g!==i)for(var x=0;x<r;x++){var b=y+x,w=y+r+x,S=y+r+(x+1)%r,R=y+(x+1)%r;p.setXYZ(_*vr,b,R,w),_++,p.setXYZ(_*vr,w,R,S),_++}for(var C=g/i,A=C*(t-e)+e,E=0;E<r;E++){var k=E/r,T=A*Math.sin(k*a+0),P=C*n-h,M=A*Math.cos(k*a+0),N=new ae.Vector3(T,Math.sqrt(T*T+M*M)*v,M).normalize();f.setXYZ(y,T,P,M),d.setXYZ(y,N.x,N.y,N.z),m.setXY(y,k,C),++y}}if(c){for(var I=y,L=y+r,D=0;D<r;++D){var O=y-r;f.setXYZ(y,f.getX(O),f.getY(O),f.getZ(O)),d.setXYZ(y,0,1,0),m.setXY(y,1,1);O=I+(D+1)%r;p.setXYZ(_*vr,y,O,L),_++,y++}f.setXYZ(y,0,h,0),d.setXYZ(y,0,1,0),m.setXY(y,1,1),++y}if(l){for(var V=y,z=y+r,F=0;F<r;++F){var B=F;f.setXYZ(y,f.getX(B),f.getY(B),f.getZ(B)),d.setXYZ(y,0,-1,0),m.setXY(y,0,0);B=V+(F+1)%r;p.setXYZ(_*vr,B,y,z),_++,y++}f.setXYZ(y,0,-h,0),d.setXYZ(y,0,-1,0),m.setXY(y,0,0)}return s.setIndex(p),s.setAttribute("position",f),s.setAttribute("normal",d),s.setAttribute("uv",m),s}return _(G,[{key:"clone",value:function(){var e=this.parameters;return new G(e.radiusTop,e.radiusBottom,e.height,e.radialSegments,e.heightSegments,e.openEnded)}}]),G}(ae.BufferGeometry);function xr(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var br=new ae.Color,wr=new ae.Matrix4,Sr=ce.copySubArrays;function Rr(e,t,n,r,i){e[t]=n,e[t+1]=r,e[t+2]=i}function Cr(e,t,n,r,i,o){e[t]=n,e[t+1]=r,e[t+2]=i,e[t+3]=o}function Ar(e,t){return e-t}var Er=function(e){A(s,e);var o=xr(s);function s(e,t,n,r){var i;return j(this,s),(i=o.call(this))._useZSprites=n,i._cylGeometry=n?new ae.PlaneBufferGeometry(2,2,1,1):new gr(1,1,1,Math.max(3,t),2,r),i._init(e,i._cylGeometry,i._useZSprites),i._collisionGeo=new yr(e,3),i}return _(s,[{key:"setItem",value:function(e,t,n,r){var i=Fn.calcCylinderMatrix(t,n,r),o=i.elements,s=4*e;this._collisionGeo.setItem(e,t,n,r),Cr(this._matVector1,s,o[0],o[4],o[8],o[12]),Cr(this._matVector2,s,o[1],o[5],o[9],o[13]),Cr(this._matVector3,s,o[2],o[6],o[10],o[14]),this._useZSprites&&(wr.copy(i).invert(),o=wr.elements,Cr(this._invmatVector1,s,o[0],o[4],o[8],o[12]),Cr(this._invmatVector2,s,o[1],o[5],o[9],o[13]),Cr(this._invmatVector3,s,o[2],o[6],o[10],o[14]))}},{key:"setColor",value:function(e,t,n){e*=3;br.set(t),Rr(this._color1,e,br.r,br.g,br.b),br.set(n),Rr(this._color2,e,br.r,br.g,br.b)}},{key:"computeBoundingSphere",value:function(){this._collisionGeo.computeBoundingSphere(),this.boundingSphere=this._collisionGeo.boundingSphere}},{key:"computeBoundingBox",value:function(){this._collisionGeo.computeBoundingBox(),this.boundingBox=this._collisionGeo.boundingBox}},{key:"raycast",value:function(e,t){this._collisionGeo.raycast(e,t)}},{key:"startUpdate",value:function(){return!0}},{key:"finishUpdate",value:function(){this.getAttribute("matVector1").needsUpdate=!0,this.getAttribute("matVector2").needsUpdate=!0,this.getAttribute("matVector3").needsUpdate=!0,this.getAttribute("color").needsUpdate=!0,this.getAttribute("color2").needsUpdate=!0,this.getAttribute("alphaColor").needsUpdate=!0,this._useZSprites&&(this.getAttribute("invmatVector1").needsUpdate=!0,this.getAttribute("invmatVector2").needsUpdate=!0,this.getAttribute("invmatVector3").needsUpdate=!0),this._collisionGeo.finishUpdate()}},{key:"finalize",value:function(){this.finishUpdate(),this.computeBoundingSphere()}},{key:"setOpacity",value:function(e,t){for(var n=this._alpha,r=0,i=e.length;r<i;++r)n[Math.floor(e[r]/2)]=t;this.getAttribute("alphaColor").needsUpdate=!0}},{key:"getSubset",value:function(e){var t=function(e){e.sort(Ar);for(var t=[],n=[],r=0,i=e.length;r<i;++r){var o=e[r],s={first:!1,second:!1};(0|o)%2==0?(s.first=!0,s.second=r+1<i&&e[r+1]===e[r]+1,s.second&&++r):s.second=!0,t.push(Math.floor(o/2)),n.push(s)}return{indices:t,cylinderInfo:n}}(e),n=t.indices,r=n.length,e=new ae.InstancedBufferGeometry;return this._init.call(e,r,this._cylGeometry,this._useZSprites),Sr(this._matVector1,e._matVector1,n,4),Sr(this._matVector2,e._matVector2,n,4),Sr(this._matVector3,e._matVector3,n,4),this._useZSprites&&(Sr(this._invmatVector1,e._invmatVector1,n,4),Sr(this._invmatVector2,e._invmatVector2,n,4),Sr(this._invmatVector3,e._invmatVector3,n,4)),Sr(this._color1,e._color1,n,3),Sr(this._color2,e._color2,n,3),function(e,t,n){for(var r=0,i=e.length;r<i;++r){var o=e[r];o.first||(t[3*r]=-.5),o.second||(n[3*r]=-.5)}}(t.cylinderInfo,e._color1,e._color2),e.boundingSphere=this.boundingSphere,e.boundingBox=this.boundingBox,[e]}},{key:"getGeoParams",value:function(){return this._cylGeometry.parameters}},{key:"_init",value:function(e,t,n){this.copy(t),this._matVector1=ce.allocateTyped(Float32Array,4*e),this._matVector2=ce.allocateTyped(Float32Array,4*e),this._matVector3=ce.allocateTyped(Float32Array,4*e),this._color1=ce.allocateTyped(Float32Array,3*e),this._color2=ce.allocateTyped(Float32Array,3*e);t=this._alpha=ce.allocateTyped(Float32Array,e);b.default.fill(t,1),this.setAttribute("matVector1",new ae.InstancedBufferAttribute(this._matVector1,4,!1,1)),this.setAttribute("matVector2",new ae.InstancedBufferAttribute(this._matVector2,4,!1,1)),this.setAttribute("matVector3",new ae.InstancedBufferAttribute(this._matVector3,4,!1,1)),this.setAttribute("color",new ae.InstancedBufferAttribute(this._color1,3,!1,1)),this.setAttribute("color2",new ae.InstancedBufferAttribute(this._color2,3,!1,1)),this.setAttribute("alphaColor",new ae.InstancedBufferAttribute(this._alpha,1,!1,1)),n&&(this._invmatVector1=ce.allocateTyped(Float32Array,4*e),this._invmatVector2=ce.allocateTyped(Float32Array,4*e),this._invmatVector3=ce.allocateTyped(Float32Array,4*e),this.setAttribute("invmatVector1",new ae.InstancedBufferAttribute(this._invmatVector1,4,!1,1)),this.setAttribute("invmatVector2",new ae.InstancedBufferAttribute(this._invmatVector2,4,!1,1)),this.setAttribute("invmatVector3",new ae.InstancedBufferAttribute(this._invmatVector3,4,!1,1)))}}]),s}(ae.InstancedBufferGeometry);function kr(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var Tr=3,Pr=3,Mr=new ae.Vector3,Nr=new ae.Vector3,Ir=new ae.Vector3,Lr=new ae.Vector3(1,0,0),Dr=new ae.Vector3,Or=new ae.Vector3;var Vr=function(){A(a,ar);var s=kr(a);function a(e,t,n){j(this,a);var r=function(e,t){for(var n=new ae.BufferGeometry,r=e.length,i=r*t,o=i<=65536?Uint16Array:Uint32Array,s=(t-1)*r*2,a=new ae.BufferAttribute(ce.allocateTyped(o,s*Pr),1),c=0,l=0,u=0;u<t;u++){if(u!==t-1)for(var h=0;h<r;h++){var f=c+h,d=c+r+h,p=c+r+(h+1)%r,m=c+(h+1)%r;a.setXYZ(l*Pr,f,m,d),l++,a.setXYZ(l*Pr,d,m,p),l++}c+=r}return n.setIndex(a),i=ce.allocateTyped(Float32Array,i*Tr),n.setAttribute("position",new ae.BufferAttribute(i,Tr)),n._positions=e,n}(e,t);(n=s.call(this,r,n))._ringsCount=t;for(var i=n._tmpShape=[],o=0;o<e.length;++o)i[o]=new ae.Vector3;return n}return _(a,[{key:"setItem",value:function(e,t,n,r){var i=2<arguments.length&&void 0!==n&&n,o=3<arguments.length&&void 0!==r&&r,n=this._chunkGeo._positions.length,r=this._ringsCount,e=n*this._ringsCount*e*Tr;this._setPoints(t,n,r,e),i?this._setSlopeNormals(n,r,e):this._setBaseNormals(n,r,e),o&&this._addCut(n,r,e)}},{key:"_setPoints",value:function(e,t,n,r){for(var i=this._tmpShape,o=this._positions,s=this._chunkGeo._positions,a=0,c=r;a<n;++a)for(var l=e[a],u=0;u<t;++u,c+=Tr)i[u].copy(s[u]).applyMatrix4(l).toArray(o,c)}},{key:"_setBaseNormals",value:function(e,t,n){for(var r=e*Tr,i=0,o=n;i<t;++i,o+=r)this._countNormalsInRing(e,o,!1)}},{key:"_setSlopeNormals",value:function(e,t,n){for(var r=this._normals,i=e*Tr,o=n,s=0;s<e;++s,o+=Tr)Lr.toArray(r,o);if(0<o-2*i)for(var a=0;a<e;++a,o+=Tr)Ir.fromArray(r,o-2*i).toArray(r,o);else this._countNormalsInRing(e,o,!0,+i),o+=i;for(var c=2;c<t;++c,o+=i)this._countNormalsInRing(e,o,!0,-i)}},{key:"_countNormalsInRing",value:function(e,t,n,r){var i=this._tmpShape,o=this._normals;i[0].fromArray(this._positions,t),i[e-1].fromArray(this._positions,t+(e-1)*Tr);for(var s=0;s<e;++s,t+=Tr)s<e-1&&i[s+1].fromArray(this._positions,t+Tr),n?(Or.fromArray(this._positions,t+r),Mr.subVectors(i[(s+e-1)%e],i[(s+1)%e]).normalize(),Nr.subVectors(i[s],Or).normalize(),Ir.crossVectors(Nr,Mr).normalize().toArray(o,t)):(Mr.subVectors(i[s],i[(s+e-1)%e]).normalize(),Nr.subVectors(i[s],i[(s+1)%e]).normalize(),Ir.addVectors(Mr,Nr).normalize().toArray(o,t))}},{key:"_addCut",value:function(e,t,n){if(!(e<3||t<2)){var r=this._positions,i=this._normals,o=this._tmpShape,s=e*Tr;o[0].fromArray(r,n),o[1].fromArray(r,n+Tr),o[2].fromArray(r,n+2*Tr),Mr.subVectors(o[1],o[0]).normalize(),Nr.subVectors(o[1],o[2]).normalize(),Dr.crossVectors(Mr,Nr).normalize();for(var a=n,c=0;c<2*e;++c,a+=Tr)Dr.toArray(i,a);if(2<t)for(var l=0;l<e;++l,a+=Tr)Ir.fromArray(r,a-s).toArray(r,a)}}}]),a}();function zr(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var Fr=new ae.Color,Br=new ae.Vector3;function Ur(e,t,n,r,i){e[t]=n,e[t+1]=r,e[t+2]=i}function Gr(e,t,n,r,i,o){e[t]=n,e[t+1]=r,e[t+2]=i,e[t+3]=o}function jr(e,t,n,r){t*=4,n=t+4*n;return e.subarray(t*r,n*r)}var Hr=function(e){A(r,e);var n=zr(r);function r(e){var t;return j(this,r),(t=n.call(this))._initVertices(e),t}return _(r,[{key:"startUpdate",value:function(){return!0}},{key:"finishUpdate",value:function(){this.getAttribute("position").needsUpdate=!0,this.getAttribute("color").needsUpdate=!0,this.getAttribute("alphaColor").needsUpdate=!0,this.getAttribute("direction").needsUpdate=!0}},{key:"setColor",value:function(e,t){Fr.set(t);e=4*e*3;Ur(this._colors,e,Fr.r,Fr.g,Fr.b),e+=3,Ur(this._colors,e,Fr.r,Fr.g,Fr.b),e+=3,Ur(this._colors,e,Fr.r,Fr.g,Fr.b),e+=3,Ur(this._colors,e,Fr.r,Fr.g,Fr.b)}},{key:"setSegment",value:function(e,t,n){Br.subVectors(t,n),Br.normalize();var r=this._positions,i=this._directions,o=4*e*4,e=4*e*3;Gr(r,o,t.x,t.y,t.z,.5),Ur(i,e,Br.x,Br.y,Br.z),e+=3,Gr(r,o+=4,t.x,t.y,t.z,-.5),Ur(i,e,Br.x,Br.y,Br.z),e+=3,Gr(r,o+=4,n.x,n.y,n.z,.5),Ur(i,e,Br.x,Br.y,Br.z),e+=3,Gr(r,o+=4,n.x,n.y,n.z,-.5),Ur(i,e,Br.x,Br.y,Br.z)}},{key:"setOpacity",value:function(e,t,n){e*=4,t*=4;b.default.fill(this.alpha,n,t,e),this.getAttribute("alphaColor").needsUpdate=!0}},{key:"getSubsetSegments",value:function(e,t){return[jr(this._positions,e,t,4),jr(this._directions,e,t,3)]}},{key:"getSubsetColors",value:function(e,t){return jr(this._colors,e,t,3)}},{key:"getSubsetOpacities",value:function(e,t){return jr(this._alpha,e,t,1)}},{key:"getNumVertexPerSegment",value:function(){return 4}},{key:"getPositionSize",value:function(){return 4}},{key:"setSegments",value:function(e,t){var n=4*e*4;t instanceof Array&&2===t.length?(this._positions.set(t[0],n),e=4*e*3,this._directions.set(t[1],e)):this._positions.set(t,n)}},{key:"setColors",value:function(e,t){e=4*e*3;this._colors.set(t,e)}},{key:"_initVertices",value:function(e){this._buffersSize=4*e;var t=this._buffersSize,n=65535<t;this._index=ce.allocateTyped(n?Uint32Array:Uint16Array,6*e),this._positions=ce.allocateTyped(Float32Array,4*t),this._colors=ce.allocateTyped(Float32Array,3*t),this._directions=ce.allocateTyped(Float32Array,3*t);t=this._alpha=ce.allocateTyped(Float32Array,t);b.default.fill(t,1);for(var r=this._index,i=0,o=0,s=0;s<e;s++,i+=6,o+=4)r[i]=o,r[i+1]=o+1,r[i+2]=o+3,r[i+3]=o,r[i+4]=o+2,r[i+5]=o+3;this.setIndex(new ae.BufferAttribute(this._index,1)),this.setAttribute("position",new ae.BufferAttribute(this._positions,4)),this.setAttribute("color",new ae.BufferAttribute(this._colors,3)),this.setAttribute("alphaColor",new ae.BufferAttribute(t,1)),this.setAttribute("direction",new ae.BufferAttribute(this._directions,3))}}]),r}(ae.BufferGeometry);function Wr(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var Yr=function(){A(t,Hr);var e=Wr(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"startUpdate",value:function(){return!0}},{key:"computeBoundingSphere",value:function(){var e=this.boundingBox,t=0,n=new ae.Vector3;e&&e.getCenter(n);for(var r=this._positions,e=this.boundingSphere||new ae.Sphere,i=this._positions.length,o=new ae.Vector3,s=this.getPositionSize(),a=0;a<i;a+=s){o.set(r[a],r[a+1],r[a+2]);var c=n.distanceToSquared(o);t<c&&(t=c)}e.set(n,Math.sqrt(t)),this.boundingSphere=e}},{key:"computeBoundingBox",value:function(){for(var e=this._positions,t=new ae.Box3,n=this._positions.length,r=new ae.Vector3,i=this.getPositionSize(),o=0;o<n;o+=i)r.set(e[o],e[o+1],e[o+2]),t.expandByPoint(r);this.boundingBox=t}},{key:"finalize",value:function(){this.finishUpdate(),this.computeBoundingSphere()}}]),t}();function Xr(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var qr=3,$r=new ae.Vector3,Zr=new ae.Matrix3,Kr=function(){A(r,ar);var n=Xr(r);function r(e,t){j(this,r);var t=new ae.CylinderBufferGeometry(1,1,1,Math.max(3,t),2,!0),e=(t=n.call(this,t,e))._chunkSize;return t._chunkPos=t._chunkGeo.attributes.position.array,t._chunkNorms=t._chunkGeo.attributes.normal.array,t._tmpVector=ce.allocateTyped(Float32Array,e*qr),t}return _(r,[{key:"setItem",value:function(e,t,n,r){var i,o=this._chunkSize,e=o*e*qr,s=this._tmpVector,a=this._chunkPos,c=this._chunkNorms,l=Fn.calcCylinderMatrix(t,n,r);Zr.getNormalMatrix(l);for(var u=0;u<o;++u)i=u*qr,$r.fromArray(a,i),$r.applyMatrix4(l),$r.toArray(s,i);this._positions.set(s,e);for(var h=0;h<o;++h)i=h*qr,$r.fromArray(c,i),$r.applyMatrix3(Zr),$r.toArray(s,i);this._normals.set(s,e)}}]),r}();function Qr(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var Jr=function(){A(c,Yr);var i=Qr(c);function c(e,t,n){var r;return j(this,c),(r=i.call(this,e*t))._init(t),r._collisionGeo=n?new Kr(e*t,3):null,r}return _(c,[{key:"startUpdate",value:function(){return!0}},{key:"computeBoundingSphere",value:function(){var e=this._collisionGeo;if(e)return e.computeBoundingSphere(),void(this.boundingSphere=e.boundingSphere);tt(P(c.prototype),"computeBoundingSphere",this).call(this)}},{key:"computeBoundingBox",value:function(){var e=this._collisionGeo;if(e)return e.computeBoundingBox(),void(this.boundingBox=e.boundingBox);tt(P(c.prototype),"computeBoundingBox",this).call(this)}},{key:"raycast",value:function(e,t){if(this._collisionGeo){var n=this._chunkSize;this._collisionGeo.raycast(e,t);for(var r=0,i=t.length;r<i;++r){var o=t[r].chunkIdx;void 0!==o&&(o=o/n|0,t[r].chunkIdx=o)}}}},{key:"setColor",value:function(e,t){for(var n=this._chunkSize,r=e*n,i=r+n;r<i;++r)tt(P(c.prototype),"setColor",this).call(this,r,t)}},{key:"setSegment",value:function(e,t,n,r){var i=this._chunkSize,o=e*i+t;tt(P(c.prototype),"setSegment",this).call(this,o,n,r),this._collisionGeo&&this._collisionGeo.setItem(e*i+t,n,r,.1)}},{key:"finalize",value:function(){this.finishUpdate(),this.computeBoundingSphere()}},{key:"setOpacity",value:function(e,t){for(var n=this._chunkSize,r=0,i=e.length;r<i;++r){var o=e[r]*n;tt(P(c.prototype),"setOpacity",this).call(this,o,o+n-1,t)}}},{key:"getSubset",value:function(e){for(var t=e.length,n=this._chunkSize,r=new c(t,n,!1),i=0,o=e.length;i<o;++i){var s=i*n,a=e[i]*n;r.setSegments(s,this.getSubsetSegments(a,n)),r.setColors(s,this.getSubsetColors(a,n))}return r.boundingSphere=this.boundingSphere,r.boundingBox=this.boundingBox,[r]}},{key:"_init",value:function(e){this._chunkSize=e}}]),c}();function ei(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var ti=new ae.Vector3,ni=function(){A(s,Yr);var n=ei(s);function s(e){var t;return j(this,s),(t=n.call(this,2*e))._init(e),t._collisionGeo=new yr(e,3),t}return _(s,[{key:"setItem",value:function(e,t,n){this._collisionGeo.setItem(e,t,n,.3);e*=2;ti.lerpVectors(t,n,.5),tt(P(s.prototype),"setSegment",this).call(this,e,t,ti),tt(P(s.prototype),"setSegment",this).call(this,1+e,ti,n)}},{key:"setColor",value:function(e,t,n){e*=2;tt(P(s.prototype),"setColor",this).call(this,e,t),tt(P(s.prototype),"setColor",this).call(this,1+e,n)}},{key:"raycast",value:function(e,t){this._collisionGeo&&this._collisionGeo.raycast(e,t)}},{key:"getSubset",value:function(e){for(var t=e.length,n=new s(t),r=0,i=t;r<i;++r){var o=e[r];n.setSegments(r,this.getSubsetSegments(o,1)),n.setColors(r,this.getSubsetColors(o,1))}return n.boundingSphere=this.boundingSphere,n.boundingBox=this.boundingBox,[n]}},{key:"_init",value:function(e){this._segCounts=2*e}}]),s}();function ri(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var ii=[new ae.Vector3(1,0,0),new ae.Vector3(-1,0,0),new ae.Vector3(0,1,0),new ae.Vector3(0,-1,0),new ae.Vector3(0,0,1),new ae.Vector3(0,0,-1)],oi=ii.length,si=new ae.Vector3,ai=new ae.Vector3,ci=function(e){A(n,e);var t=ri(n);function n(e){return j(this,n),t.call(this,e,e,oi/2|0,!1)}return _(n,[{key:"setItem",value:function(e,t,n){this.setSphere(e,t,n);for(var r=0;r<oi/2;++r){var i=2*r;si.x=t.x+ii[i].x*n,si.y=t.y+ii[i].y*n,si.z=t.z+ii[i].z*n;i=1+i;ai.x=t.x+ii[i].x*n,ai.y=t.y+ii[i].y*n,ai.z=t.z+ii[i].z*n,this.setSegment(e,r,si,ai)}}}]),n}(Qn(Jr));function li(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var ui=4,hi=3,fi=new ae.Color,di=function(){A(i,ir);var r=li(i);function i(e,t){var n;return j(this,i),(n=r.call(this))._opts=t,n.zClip=n._opts.zClip,n._posRad=ce.allocateTyped(Float32Array,e*ui),n._colors=ce.allocateTyped(Float32Array,e*hi),n}return _(i,[{key:"setItem",value:function(e,t,n){var r=this._posRad,e=ui*e;r[e++]=t.x,r[e++]=t.y,r[e++]=t.z,r[e]=n}},{key:"setColor",value:function(e,t){fi.set(t);t=this._colors,e*=hi;t[e++]=fi.r,t[e++]=fi.g,t[e]=fi.b}},{key:"finalize",value:function(){this.finishUpdate(),this.computeBoundingSphere()}},{key:"finishUpdate",value:function(){this._build()}},{key:"setOpacity",value:function(){}},{key:"raycast",value:function(){}},{key:"getSubset",value:function(){return[]}}]),i}(),pi=function(){function e(){j(this,e),this.pointsValuesLinear=null,this.hasIntersection=null,this.bitsInside=null}return _(e,[{key:"create",value:function(e){e*=e*e;if(117440512<e)throw new Error("Too large cube dimension: lead to memory huge uasge");return this.pointsValuesLinear=ce.allocateTyped(Float32Array,32*e),this.hasIntersection=ce.allocateTyped(Int32Array,e),this.bitsInside=ce.allocateTyped(Int32Array,e),0}},{key:"destroy",value:function(){this.bitsInside=null,this.hasIntersection=null,this.pointsValuesLinear=null}}]),e}();pi.prototype.striIndicesMarchCube=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,8,3,9,8,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,2,10,0,2,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,8,3,2,10,8,10,9,8,-1,-1,-1,-1,-1,-1,-1,3,11,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,11,2,8,11,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,9,0,2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,11,2,1,9,11,9,8,11,-1,-1,-1,-1,-1,-1,-1,3,10,1,11,10,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,10,1,0,8,10,8,11,10,-1,-1,-1,-1,-1,-1,-1,3,9,0,3,11,9,11,10,9,-1,-1,-1,-1,-1,-1,-1,9,8,10,10,8,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,7,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,3,0,7,3,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,8,4,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,1,9,4,7,1,7,3,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,8,4,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,4,7,3,0,4,1,2,10,-1,-1,-1,-1,-1,-1,-1,9,2,10,9,0,2,8,4,7,-1,-1,-1,-1,-1,-1,-1,2,10,9,2,9,7,2,7,3,7,9,4,-1,-1,-1,-1,8,4,7,3,11,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,4,7,11,2,4,2,0,4,-1,-1,-1,-1,-1,-1,-1,9,0,1,8,4,7,2,3,11,-1,-1,-1,-1,-1,-1,-1,4,7,11,9,4,11,9,11,2,9,2,1,-1,-1,-1,-1,3,10,1,3,11,10,7,8,4,-1,-1,-1,-1,-1,-1,-1,1,11,10,1,4,11,1,0,4,7,11,4,-1,-1,-1,-1,4,7,8,9,0,11,9,11,10,11,0,3,-1,-1,-1,-1,4,7,11,4,11,9,9,11,10,-1,-1,-1,-1,-1,-1,-1,9,5,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,5,4,0,8,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,5,4,1,5,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,5,4,8,3,5,3,1,5,-1,-1,-1,-1,-1,-1,-1,1,2,10,9,5,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,8,1,2,10,4,9,5,-1,-1,-1,-1,-1,-1,-1,5,2,10,5,4,2,4,0,2,-1,-1,-1,-1,-1,-1,-1,2,10,5,3,2,5,3,5,4,3,4,8,-1,-1,-1,-1,9,5,4,2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,11,2,0,8,11,4,9,5,-1,-1,-1,-1,-1,-1,-1,0,5,4,0,1,5,2,3,11,-1,-1,-1,-1,-1,-1,-1,2,1,5,2,5,8,2,8,11,4,8,5,-1,-1,-1,-1,10,3,11,10,1,3,9,5,4,-1,-1,-1,-1,-1,-1,-1,4,9,5,0,8,1,8,10,1,8,11,10,-1,-1,-1,-1,5,4,0,5,0,11,5,11,10,11,0,3,-1,-1,-1,-1,5,4,8,5,8,10,10,8,11,-1,-1,-1,-1,-1,-1,-1,9,7,8,5,7,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,3,0,9,5,3,5,7,3,-1,-1,-1,-1,-1,-1,-1,0,7,8,0,1,7,1,5,7,-1,-1,-1,-1,-1,-1,-1,1,5,3,3,5,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,7,8,9,5,7,10,1,2,-1,-1,-1,-1,-1,-1,-1,10,1,2,9,5,0,5,3,0,5,7,3,-1,-1,-1,-1,8,0,2,8,2,5,8,5,7,10,5,2,-1,-1,-1,-1,2,10,5,2,5,3,3,5,7,-1,-1,-1,-1,-1,-1,-1,7,9,5,7,8,9,3,11,2,-1,-1,-1,-1,-1,-1,-1,9,5,7,9,7,2,9,2,0,2,7,11,-1,-1,-1,-1,2,3,11,0,1,8,1,7,8,1,5,7,-1,-1,-1,-1,11,2,1,11,1,7,7,1,5,-1,-1,-1,-1,-1,-1,-1,9,5,8,8,5,7,10,1,3,10,3,11,-1,-1,-1,-1,5,7,0,5,0,9,7,11,0,1,0,10,11,10,0,-1,11,10,0,11,0,3,10,5,0,8,0,7,5,7,0,-1,11,10,5,7,11,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,6,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,5,10,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,0,1,5,10,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,8,3,1,9,8,5,10,6,-1,-1,-1,-1,-1,-1,-1,1,6,5,2,6,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,6,5,1,2,6,3,0,8,-1,-1,-1,-1,-1,-1,-1,9,6,5,9,0,6,0,2,6,-1,-1,-1,-1,-1,-1,-1,5,9,8,5,8,2,5,2,6,3,2,8,-1,-1,-1,-1,2,3,11,10,6,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,0,8,11,2,0,10,6,5,-1,-1,-1,-1,-1,-1,-1,0,1,9,2,3,11,5,10,6,-1,-1,-1,-1,-1,-1,-1,5,10,6,1,9,2,9,11,2,9,8,11,-1,-1,-1,-1,6,3,11,6,5,3,5,1,3,-1,-1,-1,-1,-1,-1,-1,0,8,11,0,11,5,0,5,1,5,11,6,-1,-1,-1,-1,3,11,6,0,3,6,0,6,5,0,5,9,-1,-1,-1,-1,6,5,9,6,9,11,11,9,8,-1,-1,-1,-1,-1,-1,-1,5,10,6,4,7,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,3,0,4,7,3,6,5,10,-1,-1,-1,-1,-1,-1,-1,1,9,0,5,10,6,8,4,7,-1,-1,-1,-1,-1,-1,-1,10,6,5,1,9,7,1,7,3,7,9,4,-1,-1,-1,-1,6,1,2,6,5,1,4,7,8,-1,-1,-1,-1,-1,-1,-1,1,2,5,5,2,6,3,0,4,3,4,7,-1,-1,-1,-1,8,4,7,9,0,5,0,6,5,0,2,6,-1,-1,-1,-1,7,3,9,7,9,4,3,2,9,5,9,6,2,6,9,-1,3,11,2,7,8,4,10,6,5,-1,-1,-1,-1,-1,-1,-1,5,10,6,4,7,2,4,2,0,2,7,11,-1,-1,-1,-1,0,1,9,4,7,8,2,3,11,5,10,6,-1,-1,-1,-1,9,2,1,9,11,2,9,4,11,7,11,4,5,10,6,-1,8,4,7,3,11,5,3,5,1,5,11,6,-1,-1,-1,-1,5,1,11,5,11,6,1,0,11,7,11,4,0,4,11,-1,0,5,9,0,6,5,0,3,6,11,6,3,8,4,7,-1,6,5,9,6,9,11,4,7,9,7,11,9,-1,-1,-1,-1,10,4,9,6,4,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,10,6,4,9,10,0,8,3,-1,-1,-1,-1,-1,-1,-1,10,0,1,10,6,0,6,4,0,-1,-1,-1,-1,-1,-1,-1,8,3,1,8,1,6,8,6,4,6,1,10,-1,-1,-1,-1,1,4,9,1,2,4,2,6,4,-1,-1,-1,-1,-1,-1,-1,3,0,8,1,2,9,2,4,9,2,6,4,-1,-1,-1,-1,0,2,4,4,2,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,3,2,8,2,4,4,2,6,-1,-1,-1,-1,-1,-1,-1,10,4,9,10,6,4,11,2,3,-1,-1,-1,-1,-1,-1,-1,0,8,2,2,8,11,4,9,10,4,10,6,-1,-1,-1,-1,3,11,2,0,1,6,0,6,4,6,1,10,-1,-1,-1,-1,6,4,1,6,1,10,4,8,1,2,1,11,8,11,1,-1,9,6,4,9,3,6,9,1,3,11,6,3,-1,-1,-1,-1,8,11,1,8,1,0,11,6,1,9,1,4,6,4,1,-1,3,11,6,3,6,0,0,6,4,-1,-1,-1,-1,-1,-1,-1,6,4,8,11,6,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,10,6,7,8,10,8,9,10,-1,-1,-1,-1,-1,-1,-1,0,7,3,0,10,7,0,9,10,6,7,10,-1,-1,-1,-1,10,6,7,1,10,7,1,7,8,1,8,0,-1,-1,-1,-1,10,6,7,10,7,1,1,7,3,-1,-1,-1,-1,-1,-1,-1,1,2,6,1,6,8,1,8,9,8,6,7,-1,-1,-1,-1,2,6,9,2,9,1,6,7,9,0,9,3,7,3,9,-1,7,8,0,7,0,6,6,0,2,-1,-1,-1,-1,-1,-1,-1,7,3,2,6,7,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,11,10,6,8,10,8,9,8,6,7,-1,-1,-1,-1,2,0,7,2,7,11,0,9,7,6,7,10,9,10,7,-1,1,8,0,1,7,8,1,10,7,6,7,10,2,3,11,-1,11,2,1,11,1,7,10,6,1,6,7,1,-1,-1,-1,-1,8,9,6,8,6,7,9,1,6,11,6,3,1,3,6,-1,0,9,1,11,6,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,8,0,7,0,6,3,11,0,11,6,0,-1,-1,-1,-1,7,11,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,6,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,8,11,7,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,11,7,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,1,9,8,3,1,11,7,6,-1,-1,-1,-1,-1,-1,-1,10,1,2,6,11,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,10,3,0,8,6,11,7,-1,-1,-1,-1,-1,-1,-1,2,9,0,2,10,9,6,11,7,-1,-1,-1,-1,-1,-1,-1,6,11,7,2,10,3,10,8,3,10,9,8,-1,-1,-1,-1,7,2,3,6,2,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,0,8,7,6,0,6,2,0,-1,-1,-1,-1,-1,-1,-1,2,7,6,2,3,7,0,1,9,-1,-1,-1,-1,-1,-1,-1,1,6,2,1,8,6,1,9,8,8,7,6,-1,-1,-1,-1,10,7,6,10,1,7,1,3,7,-1,-1,-1,-1,-1,-1,-1,10,7,6,1,7,10,1,8,7,1,0,8,-1,-1,-1,-1,0,3,7,0,7,10,0,10,9,6,10,7,-1,-1,-1,-1,7,6,10,7,10,8,8,10,9,-1,-1,-1,-1,-1,-1,-1,6,8,4,11,8,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,6,11,3,0,6,0,4,6,-1,-1,-1,-1,-1,-1,-1,8,6,11,8,4,6,9,0,1,-1,-1,-1,-1,-1,-1,-1,9,4,6,9,6,3,9,3,1,11,3,6,-1,-1,-1,-1,6,8,4,6,11,8,2,10,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,3,0,11,0,6,11,0,4,6,-1,-1,-1,-1,4,11,8,4,6,11,0,2,9,2,10,9,-1,-1,-1,-1,10,9,3,10,3,2,9,4,3,11,3,6,4,6,3,-1,8,2,3,8,4,2,4,6,2,-1,-1,-1,-1,-1,-1,-1,0,4,2,4,6,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,9,0,2,3,4,2,4,6,4,3,8,-1,-1,-1,-1,1,9,4,1,4,2,2,4,6,-1,-1,-1,-1,-1,-1,-1,8,1,3,8,6,1,8,4,6,6,10,1,-1,-1,-1,-1,10,1,0,10,0,6,6,0,4,-1,-1,-1,-1,-1,-1,-1,4,6,3,4,3,8,6,10,3,0,3,9,10,9,3,-1,10,9,4,6,10,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,9,5,7,6,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,4,9,5,11,7,6,-1,-1,-1,-1,-1,-1,-1,5,0,1,5,4,0,7,6,11,-1,-1,-1,-1,-1,-1,-1,11,7,6,8,3,4,3,5,4,3,1,5,-1,-1,-1,-1,9,5,4,10,1,2,7,6,11,-1,-1,-1,-1,-1,-1,-1,6,11,7,1,2,10,0,8,3,4,9,5,-1,-1,-1,-1,7,6,11,5,4,10,4,2,10,4,0,2,-1,-1,-1,-1,3,4,8,3,5,4,3,2,5,10,5,2,11,7,6,-1,7,2,3,7,6,2,5,4,9,-1,-1,-1,-1,-1,-1,-1,9,5,4,0,8,6,0,6,2,6,8,7,-1,-1,-1,-1,3,6,2,3,7,6,1,5,0,5,4,0,-1,-1,-1,-1,6,2,8,6,8,7,2,1,8,4,8,5,1,5,8,-1,9,5,4,10,1,6,1,7,6,1,3,7,-1,-1,-1,-1,1,6,10,1,7,6,1,0,7,8,7,0,9,5,4,-1,4,0,10,4,10,5,0,3,10,6,10,7,3,7,10,-1,7,6,10,7,10,8,5,4,10,4,8,10,-1,-1,-1,-1,6,9,5,6,11,9,11,8,9,-1,-1,-1,-1,-1,-1,-1,3,6,11,0,6,3,0,5,6,0,9,5,-1,-1,-1,-1,0,11,8,0,5,11,0,1,5,5,6,11,-1,-1,-1,-1,6,11,3,6,3,5,5,3,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,9,5,11,9,11,8,11,5,6,-1,-1,-1,-1,0,11,3,0,6,11,0,9,6,5,6,9,1,2,10,-1,11,8,5,11,5,6,8,0,5,10,5,2,0,2,5,-1,6,11,3,6,3,5,2,10,3,10,5,3,-1,-1,-1,-1,5,8,9,5,2,8,5,6,2,3,8,2,-1,-1,-1,-1,9,5,6,9,6,0,0,6,2,-1,-1,-1,-1,-1,-1,-1,1,5,8,1,8,0,5,6,8,3,8,2,6,2,8,-1,1,5,6,2,1,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,3,6,1,6,10,3,8,6,5,6,9,8,9,6,-1,10,1,0,10,0,6,9,5,0,5,6,0,-1,-1,-1,-1,0,3,8,5,6,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,5,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,5,10,7,5,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,5,10,11,7,5,8,3,0,-1,-1,-1,-1,-1,-1,-1,5,11,7,5,10,11,1,9,0,-1,-1,-1,-1,-1,-1,-1,10,7,5,10,11,7,9,8,1,8,3,1,-1,-1,-1,-1,11,1,2,11,7,1,7,5,1,-1,-1,-1,-1,-1,-1,-1,0,8,3,1,2,7,1,7,5,7,2,11,-1,-1,-1,-1,9,7,5,9,2,7,9,0,2,2,11,7,-1,-1,-1,-1,7,5,2,7,2,11,5,9,2,3,2,8,9,8,2,-1,2,5,10,2,3,5,3,7,5,-1,-1,-1,-1,-1,-1,-1,8,2,0,8,5,2,8,7,5,10,2,5,-1,-1,-1,-1,9,0,1,5,10,3,5,3,7,3,10,2,-1,-1,-1,-1,9,8,2,9,2,1,8,7,2,10,2,5,7,5,2,-1,1,3,5,3,7,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,7,0,7,1,1,7,5,-1,-1,-1,-1,-1,-1,-1,9,0,3,9,3,5,5,3,7,-1,-1,-1,-1,-1,-1,-1,9,8,7,5,9,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,5,8,4,5,10,8,10,11,8,-1,-1,-1,-1,-1,-1,-1,5,0,4,5,11,0,5,10,11,11,3,0,-1,-1,-1,-1,0,1,9,8,4,10,8,10,11,10,4,5,-1,-1,-1,-1,10,11,4,10,4,5,11,3,4,9,4,1,3,1,4,-1,2,5,1,2,8,5,2,11,8,4,5,8,-1,-1,-1,-1,0,4,11,0,11,3,4,5,11,2,11,1,5,1,11,-1,0,2,5,0,5,9,2,11,5,4,5,8,11,8,5,-1,9,4,5,2,11,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,5,10,3,5,2,3,4,5,3,8,4,-1,-1,-1,-1,5,10,2,5,2,4,4,2,0,-1,-1,-1,-1,-1,-1,-1,3,10,2,3,5,10,3,8,5,4,5,8,0,1,9,-1,5,10,2,5,2,4,1,9,2,9,4,2,-1,-1,-1,-1,8,4,5,8,5,3,3,5,1,-1,-1,-1,-1,-1,-1,-1,0,4,5,1,0,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,4,5,8,5,3,9,0,5,0,3,5,-1,-1,-1,-1,9,4,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,11,7,4,9,11,9,10,11,-1,-1,-1,-1,-1,-1,-1,0,8,3,4,9,7,9,11,7,9,10,11,-1,-1,-1,-1,1,10,11,1,11,4,1,4,0,7,4,11,-1,-1,-1,-1,3,1,4,3,4,8,1,10,4,7,4,11,10,11,4,-1,4,11,7,9,11,4,9,2,11,9,1,2,-1,-1,-1,-1,9,7,4,9,11,7,9,1,11,2,11,1,0,8,3,-1,11,7,4,11,4,2,2,4,0,-1,-1,-1,-1,-1,-1,-1,11,7,4,11,4,2,8,3,4,3,2,4,-1,-1,-1,-1,2,9,10,2,7,9,2,3,7,7,4,9,-1,-1,-1,-1,9,10,7,9,7,4,10,2,7,8,7,0,2,0,7,-1,3,7,10,3,10,2,7,4,10,1,10,0,4,0,10,-1,1,10,2,8,7,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,9,1,4,1,7,7,1,3,-1,-1,-1,-1,-1,-1,-1,4,9,1,4,1,7,0,8,1,8,7,1,-1,-1,-1,-1,4,0,3,7,4,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,8,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,10,8,10,11,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,9,3,9,11,11,9,10,-1,-1,-1,-1,-1,-1,-1,0,1,10,0,10,8,8,10,11,-1,-1,-1,-1,-1,-1,-1,3,1,10,11,3,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,11,1,11,9,9,11,8,-1,-1,-1,-1,-1,-1,-1,3,0,9,3,9,11,1,2,9,2,11,9,-1,-1,-1,-1,0,2,11,8,0,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,2,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,8,2,8,10,10,8,9,-1,-1,-1,-1,-1,-1,-1,9,10,2,0,9,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,8,2,8,10,0,1,8,1,10,8,-1,-1,-1,-1,1,10,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,3,8,9,1,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,9,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,3,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];var mi=[0,265,515,778,1030,1295,1541,1804,2060,2309,2575,2822,3082,3331,3593,3840,400,153,915,666,1430,1183,1941,1692,2460,2197,2975,2710,3482,3219,3993,3728,560,825,51,314,1590,1855,1077,1340,2620,2869,2111,2358,3642,3891,3129,3376,928,681,419,170,1958,1711,1445,1196,2988,2725,2479,2214,4010,3747,3497,3232,1120,1385,1635,1898,102,367,613,876,3180,3429,3695,3942,2154,2403,2665,2912,1520,1273,2035,1786,502,255,1013,764,3580,3317,4095,3830,2554,2291,3065,2800,1616,1881,1107,1370,598,863,85,348,3676,3925,3167,3414,2650,2899,2137,2384,1984,1737,1475,1226,966,719,453,204,4044,3781,3535,3270,3018,2755,2505,2240,2240,2505,2755,3018,3270,3535,3781,4044,204,453,719,966,1226,1475,1737,1984,2384,2137,2899,2650,3414,3167,3925,3676,348,85,863,598,1370,1107,1881,1616,2800,3065,2291,2554,3830,4095,3317,3580,764,1013,255,502,1786,2035,1273,1520,2912,2665,2403,2154,3942,3695,3429,3180,876,613,367,102,1898,1635,1385,1120,3232,3497,3747,4010,2214,2479,2725,2988,1196,1445,1711,1958,170,419,681,928,3376,3129,3891,3642,2358,2111,2869,2620,1340,1077,1855,1590,314,51,825,560,3728,3993,3219,3482,2710,2975,2197,2460,1692,1941,1183,1430,666,915,153,400,3840,3593,3331,3082,2822,2575,2309,2060,1804,1541,1295,1030,778,515,265,0];function yi(){j(this,yi),this._arrSize=8,this.p=new Array(this._arrSize),this.g=new Array(this._arrSize),this.val=new Array(this._arrSize);for(var e=0;e<this._arrSize;++e)this.p[e]=new ae.Vector3,this.g[e]=new ae.Vector3;this.cubeIndex=0}function _i(){j(this,_i),this.a={p:new ae.Vector3,n:new ae.Vector3},this.b={p:new ae.Vector3,n:new ae.Vector3},this.c={p:new ae.Vector3,n:new ae.Vector3}}function vi(e){for(var t=new Array(e),n=0;n<e;++n)t[n]=new ae.Vector3;return t}var gi=function(){function d(){j(this,d),this._numTriangles=0,this._numVertices=0,this._position=[],this._normals=[],this._colors=null,this._indices=[],this._volumetricData=null,this._xAxis=new ae.Vector3,this._yAxis=new ae.Vector3,this._zAxis=new ae.Vector3,this._xDir=new ae.Vector3,this._yDir=new ae.Vector3,this._zDir=new ae.Vector3}return _(d,[{key:"_prepareAxesAndDirs",value:function(){var e=this._volumetricData.getCellSize(),t=this._xAxis,n=this._yAxis,r=this._zAxis,i=this._xDir,o=this._yDir,s=this._zDir;t.set(e.x,0,0),n.set(0,e.y,0),r.set(0,0,e.z),i.set(1,0,0),o.set(0,1,0),s.set(0,0,1);e=new ae.Vector3;if(e.crossVectors(i,o),e.dot(s)<0&&(i.negate(),o.negate(),s.negate()),i.x<0||i.y<0||i.z<0||o.x<0||o.y<0||o.z<0||s.x<0||s.y<0||s.z<0)return!1;s=function(e){return Math.abs(e)>Number.EPSILON};return!(s(t.y)||s(t.z)||s(n.x)||s(n.z)||s(r.x)||s(r.y))}},{key:"_vertexInterp",value:function(e,t,n,r,i,o){var s=t.p[n],a=t.p[r],c=t.g[n],l=t.g[r],n=t.val[n],e=e-n,r=t.val[r]-n,n=0;0<Math.abs(r)&&(n=e/r),n=1<n?1:n,i.lerpVectors(s,a,n),o.lerpVectors(c,l,n)}},{key:"_polygonize",value:function(e,t,n){for(var r=e.cubeIndex,i=0,o=d._arrSize,s=d._firstIndices,a=d._secondIndices,c=d._vertexList,l=d._normalList;i<o;++i)mi[r]&1<<i&&this._vertexInterp(t,e,s[i],a[i],c[i],l[i]);for(var u=0,h=16*r,f=d._triTable,i=0;-1!==f[h+i];i+=3)n[u].a.p.copy(c[f[h+i]]),n[u].a.n.copy(l[f[h+i]]),n[u].b.p.copy(c[f[h+i+1]]),n[u].b.n.copy(l[f[h+i+1]]),n[u].c.p.copy(c[f[h+i+2]]),n[u].c.n.copy(l[f[h+i+2]]),++u;return u}},{key:"_doGridPosNorms",value:function(e,t,n){for(var r=this._volumetricData,i=this._volumetricData.getData(),o=r.getDimensions(),s=o[0],a=o[1],c=o[2],l=t*r.getStrideX(),u=t*r.getStrideY(),h=t*r.getStrideZ(),f=new yi,d=f.val,p=f.val.length,m=[new ae.Vector3(0,0,0),new ae.Vector3(t,0,0),new ae.Vector3(t,t,0),new ae.Vector3(0,t,0),new ae.Vector3(0,0,t),new ae.Vector3(t,0,t),new ae.Vector3(t,t,t),new ae.Vector3(0,t,t)],y=new Array(5),_=0;_<5;++_)y[_]=new _i;for(var v,g,x,b,w=this,S=this._position,R=this._normals,C=n?(v=new ae.Vector3(w._xAxis.x,w._yAxis.y,w._zAxis.z),function(e){var t=e.p.clone();t.multiply(v),S.push(t.add(w._origin)),R.push(e.n.clone())}):function(){var t=new ae.Matrix3;t.set(w._xAxis.x,w._yAxis.x,w._zAxis.x,w._xAxis.y,w._yAxis.y,w._zAxis.y,w._xAxis.z,w._yAxis.z,w._zAxis.z);var n=new ae.Matrix3;return n.set(w._xDir.x,w._yDir.x,w._zDir.x,w._xDir.y,w._yDir.y,w._zDir.y,w._xDir.z,w._yDir.z,w._zDir.z),function(e){S.push(e.p.clone().applyMatrix3(t).add(w._origin)),R.push(e.n.clone().applyMatrix3(n))}}(),A=this._indices,E=0,k=0;k<c-t;k+=t)for(var T=0;T<a-t;T+=t)for(var P=r.getDirectIdx(0,T,k),M=0;M<s-t;M+=t,P+=l){d[0]=i[P],d[1]=i[P+l],d[3]=i[P+u],d[2]=i[P+l+u],d[4]=i[P+h],d[5]=i[P+l+h],d[7]=i[P+u+h],d[6]=i[P+l+u+h];for(var N=0,I=0;I<p;++I)d[I]<e&&(N|=1<<I);if(0!==mi[N]){for(f.cubeIndex=N,I=0;I<p;++I)f.p[I].set(M+m[I].x,T+m[I].y,k+m[I].z),g=this._gradient,x=f.p[I],b=f.g[I],x=g.getValue(x.x,x.y,x.z),b.set(x[0],x[1],x[2]);var L=this._polygonize(f,e,y);for(E+=L,I=0;I<L;++I)A.push(3*this._numTriangles),A.push(3*this._numTriangles+1),A.push(3*this._numTriangles+2),++this._numTriangles,C(y[I].a),C(y[I].b),C(y[I].c)}}return E}},{key:"compute",value:function(e,t,n,r){this._volumetricData=e,this._origin=t,this._gradient=e.computeGradient(),this._doGridPosNorms(n,r,this._prepareAxesAndDirs())}},{key:"_remapIndices",value:function(e,t){for(var n=this._indices,r=ce.allocateTyped(Uint32Array,t),i=0;i<t;++i)n[i]=e[n[i]],r[i]=n[i];this._indices=r}},{key:"_remapVertices",value:function(e,t,n){for(var r=ce.allocateTyped(Float32Array,3*n),i=ce.allocateTyped(Float32Array,3*n),o=0;o<n;++o){var s=e[o];r[3*o]=s.x,r[3*o+1]=s.y,r[3*o+2]=s.z;s=t[o].normalize();i[3*o]=s.x,i[3*o+1]=s.y,i[3*o+2]=s.z}this._position=r,this._normals=i}},{key:"vertexFusion",value:function(e,t){var n=this._indices.length,r=this._position,i=this._normals,o=0|r.length;if(0!==n&&0!=o){var s=ce.allocateTyped(Uint32Array,o);s[0]=0;for(var a=1,c=1;c<o;++c){for(var l=a-e<0?0:a-e,u=a<l+t?a:l+t,h=-1,f=l;f<u;++f)if(Math.abs(r[c]-r[f])<Number.EPSILON){h=f;break}-1!==h?s[c]=h:(r[a].copy(r[c]),i[a].copy(i[c]),s[c]=a,++a)}this._remapIndices(s,n),this._remapVertices(r,i,a)}}},{key:"setColorVolTex",value:function(e,o,t,n){var s,r,i,a,c=this._position.length/3,l=this._position,u=this._origin,h=this._volumetricData.getDimensions(),f=h[0]-1,d=h[1]-1,p=h[2]-1,m=e.getData(),y=e.getStrideX(),_=e.getStrideY(),v=e.getStrideZ();null!==n&&(s=t.getData(),r=t.getStrideX(),i=t.getStrideY(),a=t.getStrideZ());var g=1/this._xAxis.x,x=1/this._yAxis.y,b=1/this._zAxis.z,w=[],S=[],R=ce.allocateTyped(Float32Array,3*c);function C(e,t,n,r){r[0]=(1-e)*m[t]+e*m[n],r[1]=(1-e)*m[t+1]+e*m[n+1],r[2]=(1-e)*m[t+2]+e*m[n+2]}function A(e,t,n,r){var i=o[e];null!=i&&(w[i.index]=i,e=t*n*r*s[e],void 0===S[i.index]?S[i.index]=e:S[i.index]+=e)}var E=ce.allocateTyped(Int32Array,c),k=0;for(Z=0;Z<c;Z++){var T=3*Z,P=(l[T]-u.x)*g,M=(l[1+T]-u.y)*x,N=(l[2+T]-u.z)*b,I=0|Math.min(Math.max(P,0),f),L=0|Math.min(Math.max(M,0),d),D=0|Math.min(Math.max(N,0),p),O=P-I,V=M-L,z=N-D;if(null!=n){w=[],S=[],A(G=t.getDirectIdx(I,L,D),1-O,1-V,1-z),A(G+r,O,1-V,1-z),A(G+i,1-O,V,1-z),A(G+r+i,O,V,1-z),A(G+a,1-O,1-V,z),A(G+r+a,O,1-V,z),A(G+i+a,1-O,V,z),A(G+r+i+a,O,V,z);var F,B=0,U=-1;for(F in S)S[F]>B&&(B=S[U=F]);if(U<0||!n.includesAtom(w[U])){E[Z]=-1;continue}}E[Z]=k++;var G,j=I<f?y:0,H=L<d?_:0,W=D<p?v:0,Y=[0,0,0],P=[0,0,0],M=[0,0,0],N=[0,0,0];C(O,G=e.getDirectIdx(I,L,D),G+j,Y),C(O,G+H,G+j+H,P),C(O,G+W,G+j+W,M),C(O,G+H+W,G+j+H+W,N);W=[0,0,0];W[0]=(1-V)*Y[0]+V*P[0],W[1]=(1-V)*Y[1]+V*P[1],W[2]=(1-V)*Y[2]+V*P[2];P=[0,0,0];P[0]=(1-V)*M[0]+V*N[0],P[1]=(1-V)*M[1]+V*N[1],P[2]=(1-V)*M[2]+V*N[2],R[T]=(1-z)*W[0]+z*P[0],R[1+T]=(1-z)*W[1]+z*P[1],R[2+T]=(1-z)*W[2]+z*P[2]}if(this._colors=R,null!=n){for(Z=0;Z<c;++Z){var X=E[Z];X<0||(this._position[3*X]=this._position[3*Z],this._position[3*X+1]=this._position[3*Z+1],this._position[3*X+2]=this._position[3*Z+2],this._normals[3*X]=this._normals[3*Z],this._normals[3*X+1]=this._normals[3*Z+1],this._normals[3*X+2]=this._normals[3*Z+2],this._colors[3*X]=this._colors[3*Z],this._colors[3*X+1]=this._colors[3*Z+1],this._colors[3*X+2]=this._colors[3*Z+2])}for(var q=this._indices.length/3,$=0,Z=0;Z<q;++Z){var K=E[this._indices[3*Z]],Q=E[this._indices[3*Z+1]],J=E[this._indices[3*Z+2]];0<=K&&0<=Q&&0<=J&&(this._indices[3*$]=K,this._indices[3*$+1]=Q,this._indices[3*$+2]=J,++$)}this._position=new Float32Array(this._position.buffer.slice(0,3*k*4)),this._normals=new Float32Array(this._normals.buffer.slice(0,3*k*4)),this._colors=new Float32Array(this._colors.buffer.slice(0,3*k*4)),this._indices=new Uint32Array(this._indices.buffer.slice(0,3*$*4))}}},{key:"toMesh",value:function(){var e=new ae.BufferGeometry;return e.setIndex(new ae.BufferAttribute(this._indices,1)),e.setAttribute("position",new ae.BufferAttribute(this._position,3)),e.setAttribute("normal",new ae.BufferAttribute(this._normals,3)),e.setAttribute("color",new ae.BufferAttribute(this._colors,3)),e.computeBoundingSphere(),e}}]),d}();function xi(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}ke(gi,"_triTable",pi.prototype.striIndicesMarchCube),ke(gi,"_arrSize",12),ke(gi,"_firstIndices",[0,1,2,3,4,5,6,7,0,1,2,3]),ke(gi,"_secondIndices",[1,2,3,0,5,6,7,4,4,5,6,7]),ke(gi,"_vertexList",vi(gi._arrSize)),ke(gi,"_normalList",vi(gi._arrSize));var bi=function(){A(t,di);var e=xi(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"_build",value:function(){var e=this._opts;this.numVoxels=[128,128,128],this.xAxis=new ae.Vector3(1,0,0),this.yAxis=new ae.Vector3(0,1,0),this.zAxis=new ae.Vector3(0,0,1),this.origin=new ae.Vector3(0,0,0),this._visibilitySelector=e.visibilitySelector,this._calcSurface(e)}},{key:"_findMinMax",value:function(e){for(var t=e.length/4,n=[e[0],e[1],e[2],e[3]],r=[e[0],e[1],e[2],e[3]],i=1;i<t;++i)for(var o=4*i,s=0;s<4;++s){var a=e[o+s];n[s]=Math.max(a,n[s]),r[s]=Math.min(a,r[s])}return{maxPosRad:n,minPosRad:r}}},{key:"_findNumVoxels",value:function(e,t){var n=this.numVoxels,r=this._findMinMax(e),i=r.minPosRad,o=r.maxPosRad;4<i[3]&&(t.gridSpacing*=i[3]);for(var e=s=t.radScale*o[3]*1.7,e=.65*Math.sqrt(4/3*Math.PI*e*e*e),s=Math.max(s,e),a=0;a<3;++a)i[a]-=s,o[a]+=s;for(a=0;a<3;++a)n[a]=Math.ceil((o[a]-i[a])/t.gridSpacing);this.xAxis.x=(n[0]-1)*t.gridSpacing,this.yAxis.y=(n[1]-1)*t.gridSpacing,this.zAxis.z=(n[2]-1)*t.gridSpacing;e=m(i,3);return this.origin.x=e[0],this.origin.y=e[1],this.origin.z=e[2],{bbox:r,dim:n}}},{key:"_makeSurface",value:function(e,t){var n=new gi;n.compute(e.volMap,this.origin,t.isoValue,1),n.vertexFusion(9,9),0<n._numTriangles?(n.setColorVolTex(e.volTexMap,e.atomMap,e.atomWeightMap,this._visibilitySelector),this.setIndex(new ae.BufferAttribute(n._indices,1)),this.setAttribute("position",new ae.BufferAttribute(n._position,3)),this.setAttribute("normal",new ae.BufferAttribute(n._normals,3)),this.setAttribute("color",new ae.BufferAttribute(n._colors,3))):this.setAttribute("position",new ae.BufferAttribute(ce.allocateTyped(Float32Array,0),3))}},{key:"_calcSurface",value:function(e){var t,n,r={posRad:this._posRad,colors:this._colors,atoms:this._opts.atoms};0!==r.posRad.length&&(n=this._findNumVoxels(r.posRad,e),t=new ae.Box3(this.origin,new ae.Vector3(this.xAxis.x,this.yAxis.y,this.zAxis.z).add(this.origin)),n=this._computeSurface(r,t,n,e),this._makeSurface(n,e))}}]),t}();function wi(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var Si=wn.Volume,Ri=function(){A(t,bi);var e=wi(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"_computeSurface",value:function(e,t,n,r){this._shiftByOrigin(e.posRad);var i={volMap:new Si(Float32Array,this.numVoxels,t),volTexMap:new Si(Float32Array,this.numVoxels,t,3)};return null!=this._visibilitySelector&&(i.atomMap=[],i.atomWeightMap=new Si(Float32Array,this.numVoxels,t)),this.gaussdensity(i,e,null,r),i}},{key:"gaussdensity",value:function(e,t,n,r){var i,o=t.posRad.length/4,s=t.posRad,a=t.colors,c=this.numVoxels,l=r.radScale,u=r.gaussLim,h=r.gridSpacing,f=1/r.isoValue,d=1/h,p=c[0]-1,m=c[1]-1,y=c[2]-1,_=e.volMap,v=e.volTexMap,g=_.getData(),x=_.getStrideX(),b=v.getData(),w=v.getStrideX();null!=this._visibilitySelector&&(i=e.atomWeightMap.getData());for(var S=e.atomMap,R=0;R<o;++R){var C=4*R,A=s[3+C]*l,E=null===n?1:n[R],k=1/(2*A*A),T=u*A,P=T*T;T*=d;var M=s[C]*d,N=Math.max(M-T|0,0),I=Math.min(M+T|0,p),M=s[1+C]*d,L=Math.max(M-T|0,0),D=Math.min(M+T|0,m);M=s[2+C]*d;for(var A=Math.max(M-T|0,0),O=Math.min(M+T|0,y),V=A*h-s[2+C],z=A;z<=O;++z,V+=h)for(var F=L*h-s[1+C],B=L;B<=D;++B,F+=h){var U=F*F+V*V;if(!(P<=U))for(var G=_.getDirectIdx(N,B,z),j=v.getDirectIdx(N,B,z),H=N*h-s[C],W=N;W<=I;++W,H+=h,G+=x,j+=w){var Y=-(H*H+U)*k,X=Math.exp(Y)*E;null!=this._visibilitySelector&&X>i[G]&&(i[G]=X,S[G]=t.atoms[R]),g[G]+=X,X*=f;Y=3*R;b[j]+=X*a[Y],b[j+1]+=X*a[1+Y],b[j+2]+=X*a[2+Y]}}}}},{key:"_shiftByOrigin",value:function(e){for(var t=this.origin.x,n=this.origin.y,r=this.origin.z,i=e.length/4,o=0;o<i;++o){var s=4*o;e[s]-=t,e[1+s]-=n,e[2+s]-=r}}}]),t}();function Ci(C,e,t,n){var r=C.length/4,A=e[0],E=e[1],k=e[2],i=t[0],e=t[1],t=t[2];function T(e,t){return Math.floor((e-t)/n)}for(var P,o,s,a,M=T(i,A)+1,N=T(e,E)+1,I=T(t,k)+1,c=M*N*I,L=N*I,l=[],D=0;D<r;D++){var u=4*D;o=C[u],s=C[1+u],a=C[2+u],void 0===l[P=(T(o,A)*N+T(s,E))*I+T(a,k)]?l[P]=[D]:l[P].push(D)}var O,V=ce.allocateTyped(Uint32Array,c),z=ce.allocateTyped(Uint16Array,c),F=ce.allocateTyped(Uint32Array,r),h=0,f=0;for(D=0;D<c;D++){var d=V[D]=h,p=l[D];if(void 0!==p)for(O=0;O<p.length;O++)F[h]=p[O],h++;d=h-d;f<(z[D]=d)&&(f=d)}this.neighbourListLength=27*f+1,this.withinRadii=function(e,t,n,r,i){var o=0,s=T(e,A),a=T(t,E),c=T(n,k),l=Math.max(0,s-1),u=Math.max(0,a-1),h=Math.max(0,c-1),f=Math.min(M-1,s+1),d=Math.min(N-1,a+1),p=Math.min(I-1,c+1);for(D=l;D<=f;++D){var m=D*L;for(O=u;O<=d;++O)for(var y=O*I,_=h;_<=p;++_)for(var v=V[P=m+y+_],g=v+z[P],x=v;x<g;x++){var b=4*F[x],w=C[b]-e,S=C[1+b]-t,R=C[2+b]-n,b=C[3+b]+r;w*w+S*S+R*R<=b*b&&(i[o++]=F[x])}}i[o]=-1}}function Ai(e,t,n,r){var N,i,o,D,O,V,z,I,L,F,B,U,G,j,H,W,Y,X=4,q=e.posRad,$=e.colors,Z=e.atoms,K=q.length/X,e=t.bbox,Q=e.minPosRad,s=e.maxPosRad,J=-1,ee=null,te=null,ne=null,re=new ae.Vector3(0,0,0),ie=new ae.Vector3(0,0,0),oe=new ae.Vector3(0,0,0);function a(e,t,n){for(var r=0;r<e.length;r++)e[r]=t+n*r}function c(){D=n.scaleFactor,V=t.dim,Y=Math.min(5,2+Math.floor(o*D));var e=V[0]*V[1]*V[2];z=function(e,t,n){for(var r=ce.allocateTyped(e,t),i=0;i<t;++i)r[i]=n;return r}(Float32Array,e,-1001),I=ce.allocateTyped(Float32Array,3*e),L=ce.allocateTyped(Float32Array,e),ne&&(ee=ce.allocateTyped(Float32Array,e),te=[]),F=ce.allocateTyped(Float32Array,V[0]),B=ce.allocateTyped(Float32Array,V[1]),U=ce.allocateTyped(Float32Array,V[2]),a(F,Q[0],1/D),a(B,Q[1],1/D),a(U,Q[2],1/D)}function l(){o=n.probeRadius,D=n.scaleFactor,O=n.probePositions,ne=n.visibilitySelector,N=ce.allocateTyped(Float32Array,K);for(var e=i=0;e<K;++e){var t=q[e*X+3]+=o;i<t&&(i=t),N[e]=t*t}c(),function(){var e=0,t=2*Math.PI/O;j=ce.allocateTyped(Float32Array,O),G=ce.allocateTyped(Float32Array,O);for(var n=0;n<O;n++)j[n]=Math.cos(e),G[n]=Math.sin(e),e+=t}(),H=new Ci(q,Q,s,2.01*i),W=new Int32Array(H.neighbourListLength),J=-1}function u(e,t,n,r){var i=X*e,e=N[e],t=q[i]-t,n=q[1+i]-n,r=q[2+i]-r;return t*t+n*n+r*r<e}function se(e,t,n,r,i){if(-1!==J){if((s=J)!==r&&s!==i&&u(s,e,t,n))return s;J=-1}for(var o=0,s=W[o];0<=s;){if(s!==r&&s!==i&&u(s,e,t,n))return J=s;s=W[++o]}return J=-1}function h(){for(var e=0;e<K;e++){var t=X*e;H.withinRadii(q[t],q[1+t],q[2+t],q[3+t],W);for(var n=0,r=W[n];0<=r;)e<r&&function(e,t){var n=X*t,r=q[f=X*e],i=q[1+f],o=q[2+f],s=q[3+f],a=re.x=q[n]-r,c=re.y=q[1+n]-i,l=re.z=q[2+n]-o,u=q[3+n],h=a*a+c*c+l*l,f=Math.sqrt(h),n=s*((s*s+f*f-u*u)/(2*s*f));re.normalize(),u=re,(f=ie).x=f.y=f.z=1,0!==u.x?f.x=(u.y+u.z)/-u.x:0!==u.y?f.y=(u.x+u.z)/-u.y:0!==u.z&&(f.z=(u.x+u.y)/-u.z),ie.normalize(),oe.crossVectors(re,ie),oe.normalize(),s=Math.sqrt(s*s-n*n),ie.multiplyScalar(s),oe.multiplyScalar(s),re.multiplyScalar(n),re.x+=r,re.y+=i,re.z+=o,J=-1;for(var d=Y,p=0;p<O;p++){var m=j[p],y=G[p],_=re.x+m*ie.x+y*oe.x,v=re.y+m*ie.y+y*oe.y,g=re.z+m*ie.z+y*oe.z;if(-1===se(_,v,g,e,t))for(var x=Math.floor(D*(_-Q[0])),b=Math.floor(D*(v-Q[1])),m=Math.floor(D*(g-Q[2])),w=Math.max(0,x-d),S=Math.max(0,b-d),y=Math.max(0,m-d),R=Math.min(V[0],x+d+2),C=Math.min(V[1],b+d+2),A=Math.min(V[2],m+d+2),E=y;E<A;E++){l=g-U[E];for(var k=V[1]*V[0]*E,T=S;T<C;T++)for(var P=l*l+(c=v-B[T])*c,M=k+V[0]*T,N=w;N<R;N++){h=P+(a=_-F[N])*a;var I=N+M,L=z[I];0<L&&h<L*L&&(z[I]=Math.sqrt(h))}}}}(e,r),r=W[++n]}}function f(){l(),function(){for(var e=0;e<K;e++){var t=X*e,n=q[t],r=q[1+t],i=q[2+t],o=q[3+t],s=N[e];H.withinRadii(n,r,i,o,W);for(var a=Math.ceil(o*D),c=Math.floor(D*(n-Q[0])),l=Math.floor(D*(r-Q[1])),u=Math.floor(D*(i-Q[2])),h=Math.max(0,c-a),f=Math.max(0,l-a),t=Math.max(0,u-a),d=Math.min(V[0],c+a+2),p=Math.min(V[1],l+a+2),m=Math.min(V[2],u+a+2),a=3*e,y=$[a],_=$[1+a],v=$[2+a],g=t;g<m;g++)for(var x=U[g]-i,b=V[1]*V[0]*g,w=f;w<p;w++)for(var S=B[w]-r,R=x*x+S*S,C=b+V[0]*w,A=h;A<d;A++){var E,k,T=A+C,P=F[A]-n,M=R+P*P;M<s&&(E=Math.exp(.28125*-M),I[k=3*T]+=y*E,I[1+k]+=_*E,I[2+k]+=v*E,L[T]+=E,null!==ne&&E>ee[T]&&(ee[T]=E,te[T]=Z[e]),z[T]<0&&(z[T]=-z[T]),P=P*(E=o/(k=Math.sqrt(M))),M=S*E,E=x*E,-1!==se(P+=n,M+=r,E+=i,e,-1)||(k=o-k)<z[T]&&(z[T]=k))}}}(),h(),function(){for(var e=0,t=z.length;e<t;e++){z[e]<0&&(z[e]=0);var n,r=L[e];0<r&&(r=1/r,I[n=3*e]*=r,I[1+n]*=r,I[2+n]*=r)}}()}this.build=function(){f(),this.volTexMap=I,this.weightsMap=ee,this.atomMap=te,this.volMap=z}}function Ei(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}function ki(e,t){j(this,ki),this.coord=new ae.Vector3,this.coord.copy(e),this.radius=t,this.colorX=.99999,this.colorY=0,this.colorZ=0,this.atomType=0,this.srcAtom=null}var Ti=wn.Volume,Pi=function(){A(t,bi);var e=Ei(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"_computeSurface",value:function(e,t,n,r){r=new Ai(e,n,r);return r.build(),{volMap:new Ti(Float32Array,this.numVoxels,t,1,r.volMap),volTexMap:new Ti(Float32Array,this.numVoxels,t,3,r.volTexMap),atomMap:r.atomMap,atomWeightMap:new Ti(Float32Array,this.numVoxels,t,1,r.weightsMap)}}}]),t}(),Mi=function(){function o(e,t,n,r,i){j(this,o),this._numAtoms=e,this._atoms=t,this._vBoxMin=new ae.Vector3,this._vBoxMax=new ae.Vector3,this._vBoxMin.copy(n),this._vBoxMax.copy(r),this._probeRadius=i,this._atomsList=null,this._voxelList=null}return _(o,[{key:"createVoxels",value:function(){for(var e,t,n=0|this._numAtoms,r=this._atoms,i=this._vBoxMax.x-this._vBoxMin.x,o=this._vBoxMax.y-this._vBoxMin.y,s=this._vBoxMax.z-this._vBoxMin.z,o=s<(o=i<o?i:o)?s:o,a=0,c=0,l=0;l<n;l++)a=a<(t=2*(r[l].radius+this._probeRadius))?t:a,c+=t;var u=Math.floor(o/a);u<2&&(u=2),c/=n,this._numCells=u,this._aveRad=c,this._maxRad=a;var h=u,f=u*u,d=u*u*u,p=this._xScale=1/(this._vBoxMax.x-this._vBoxMin.x),m=this._yScale=1/(this._vBoxMax.y-this._vBoxMin.y),y=this._zScale=1/(this._vBoxMax.z-this._vBoxMin.z),_=0,v=p*u,g=m*u,x=y*u;for(l=0;l<n;l++){var b=2*(4.5*(r[l].radius+this._probeRadius)),w=Math.floor(v*b+.8),S=Math.floor(g*b+.8),b=Math.floor(x*b+.8);_+=++w*++S*++b}this._voxelList=ce.allocateTyped(Int32Array,d);var R=[];if(R.length=_,null===this._voxelList||null===R)return-1;for(l=0;l<d;l++)this._voxelList[l]=-1;for(l=e=0;l<n;l++){t=4.5*(r[l].radius+this._probeRadius);for(var C=Math.floor((r[l].coord.x-this._vBoxMin.x-t)*u*p),A=Math.floor((r[l].coord.y-this._vBoxMin.y-t)*u*m),E=Math.floor((r[l].coord.z-this._vBoxMin.z-t)*u*y),C=0<=C?C:0,A=0<=A?A:0,k=(k=Math.floor((r[l].coord.x-this._vBoxMin.x+t)*u*p))<u?k:u-1,T=(T=Math.floor((r[l].coord.y-this._vBoxMin.y+t)*u*m))<u?T:u-1,P=(P=Math.floor((r[l].coord.z-this._vBoxMin.z+t)*u*y))<u?P:u-1,M=E=0<=E?E:0;M<=P;M++)for(var N=A;N<=T;N++)for(var I=C;I<=k;I++){var L,D=I+N*h+M*f;this._voxelList[D]<0?(R[2*e+0]=l,R[2*e+1]=-1,this._voxelList[D]=e,e++):(L=this._voxelList[D],R[2*(this._voxelList[D]=e)+0]=l,R[2*e+1]=L,e++)}}return this._atomsList=Int32Array.from(R),0}},{key:"destroyVoxels",value:function(){this._atomsList=null,this._voxelList=null,this._atoms=null,this._vertices=null,this._vBoxMin=null,this._vBoxMax=null}},{key:"forEachRelatedAtom",value:function(e,t){for(var n=Math.floor((e.x-this._vBoxMin.x)*this._numCells*this._xScale),r=Math.floor((e.y-this._vBoxMin.y)*this._numCells*this._yScale),e=Math.floor((e.z-this._vBoxMin.z)*this._numCells*this._zScale),e=n+r*this._numCells+e*this._numCells*this._numCells,i=this._atoms,o=this._voxelList[e];0<=o;o=this._atomsList[2*o+1])t(i[this._atomsList[2*o]])}},{key:"getClosestAtom",value:function(n){var r=null,i=Number.MAX_VALUE;return this.forEachRelatedAtom(n,function(e){var t=n.distanceToSquared(e.coord);t<i&&(i=t,r=e)}),r}},{key:"buildNormals",value:function(e,t,n){for(var i,o,s=this,a=0,c=0,l=0,u=0,h=0,f=0,d=0,p=0,r=2.5*this._aveRad,m=r*r,y=.1*-this._aveRad,_=function(e){var t=c-e.coord.x,n=l-e.coord.y,r=u-e.coord.z;m<(i=t*t+n*n+r*r)||(e=e.radius+s._probeRadius,(p=i-e*e)<0&&(p=-p),o=Math.exp(y*p),h+=t*o,f+=n*o,d+=r*o,a++)},v=0;v<e;v++)c=t[v].x,l=t[v].y,u=t[v].z,h=f=d=a=0,this.forEachRelatedAtom(t[v],_),i=h*h+f*f+d*d,0<a&&(p=1/Math.sqrt(i),h*=p,f*=p,d*=p),n[v].x=h,n[v].y=f,n[v].z=d;return 0}},{key:"buildColors",value:function(e,t,n,r){for(var i,o=this,s=0,a=0,c=0,l=0,u=r*r,h=[],f=[],d=0,p=function(e){var t=s-e.coord.x,n=a-e.coord.y,r=c-e.coord.z,n=t*t+n*n+r*r;u<n||(r=e.radius+o._probeRadius,(l=n-r*r)<0&&(l=-l),i=1/(.8+l),h.push([e.colorX,e.colorY,e.colorZ]),f.push(i),d+=i)},m=0;m<e;m++){s=t[m].x,a=t[m].y,c=t[m].z,h=[],f=[],d=0,this.forEachRelatedAtom(t[m],p);for(var y=0;y<h.length;++y){var _=f[y]/d;n[m].x+=h[y][0]*_,n[m].y+=h[y][1]*_,n[m].z+=h[y][2]*_}}return 0}}]),o}(),Ni=function(){function i(e,t,n){var r;for(j(this,i),this._maxNumVertices=e,this._maxNumTriangles=t,this._vertices=new Array(e),this._normals=new Array(e),this._colors=null,n&&(this._colors=new Array(e)),this._indices=new Array(3*t),this._numVertices=0,r=this._numTriangles=0;r<e;r++)this._vertices[r]=new ae.Vector3,this._normals[r]=new ae.Vector3;for(r=0;r<3*t;r++)this._indices[r]=-1;if(n)for(r=0;r<e;r++)this._colors[r]=new ae.Vector3}return _(i,[{key:"destroy",value:function(){this._vertices=null,this._normals=null,this._indices=null}}]),i}();function Ii(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var Li=wn.Element;function Di(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var Oi={InstancedSpheresGeometry:nr,SimpleSpheresGeometry:ur,Simple2CCylindersGeometry:yr,Instanced2CCylindersGeometry:Er,ExtrudedObjectsGeometry:Vr,ChunkedLinesGeometry:Jr,TwoColorLinesGeometry:ni,CrossGeometry:ci,QuickSurfGeometry:Ri,ContactSurfaceGeometry:Pi,SSIsosurfaceGeometry:function(){A(t,di);var e=Ii(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"_build",value:function(){this._innerBuild();var e=this.getGeo();this.destroy(),this._fromGeo(e)}},{key:"_fromGeo",value:function(e){var t=null,n=ce.allocateTyped(Float32Array,3*e._numVertices),r=ce.allocateTyped(Float32Array,3*e._numVertices);null!==e._colors&&(t=ce.allocateTyped(Float32Array,3*e._numVertices));for(var i=ce.allocateTyped(Uint32Array,3*e._numTriangles),o=0,s=0;o<e._numVertices;o++)n[s+0]=e._vertices[o].x,n[s+1]=e._vertices[o].y,n[s+2]=e._vertices[o].z,r[s+0]=e._normals[o].x,r[s+1]=e._normals[o].y,r[s+2]=e._normals[o].z,s+=3;if(null!==t)for(var a=0,c=0;a<e._numVertices;a++,c+=3)t[c+0]=e._colors[a].x,t[c+1]=e._colors[a].y,t[c+2]=e._colors[a].z;for(var l=3*e._numTriangles,u=0;u<l;u++)i[u]=e._indices[u];this.setIndex(new ae.BufferAttribute(i,1)),this.setAttribute("position",new ae.BufferAttribute(n,3)),this.setAttribute("normal",new ae.BufferAttribute(r,3)),this.setAttribute("color",new ae.BufferAttribute(t,3)),this.computeBoundingBox(),this.computeBoundingSphere(),e.destroy()}},{key:"convertToAtomsColored",value:function(e,t){for(var n=e.atoms,r=e.colors,i=0,o=n.length;i<o;i++){var s=n[i].position,a=n[i].element.radius;t[i]=new ki(s,a);a=n[i].element.number;t[i].atomType=this.getType(a);a=3*i;t[i].colorX=r[a++],t[i].colorY=r[a++],t[i].colorZ=r[a],t[i].srcAtom=n[i]}}},{key:"getGeo",value:function(){return this.geoOut}},{key:"destroy",value:function(){this.atoms=null,this.hashLines=null,this.hashEntries=null}},{key:"getBoundingBox",value:function(e,t,n){t.x=t.y=t.z=1e7,n.x=n.y=n.z=-1e7;for(var r=this.probeRadius*this.atomRadiusScale,i=0,o=0,s=e.length;o<s;o++){var a=e[o].coord,c=e[o].radius+r,i=i<c?c:i;a.x-c<t.x&&(t.x=a.x-c),a.y-c<t.y&&(t.y=a.y-c),a.z-c<t.z&&(t.z=a.z-c),a.x+c>n.x&&(n.x=a.x+c),a.y+c>n.y&&(n.y=a.y+c),a.z+c>n.z&&(n.z=a.z+c)}t.x-=i,t.y-=i,t.z-=i,n.x+=i,n.y+=i,n.z+=i}},{key:"getCornerCoord",value:function(e,t,n,r,i,o,s){o=1/(o-1),n*=o,r*=o,o*=i;s.x=e.x*(1-n)+t.x*n,s.y=e.y*(1-r)+t.y*r,s.z=e.z*(1-o)+t.z*o}},{key:"buildEdgePoint",value:function(e,t,n,r,i,o){var s,a,c,l;n[e]^n[t]&&(s=(0-r.pointsValuesLinear[i+24+e])/(r.pointsValuesLinear[i+24+t]-r.pointsValuesLinear[i+24+e]),a=r.pointsValuesLinear[i+3*e+0],c=r.pointsValuesLinear[i+3*e+1],l=r.pointsValuesLinear[i+3*e+2],n=r.pointsValuesLinear[i+3*t+0],e=r.pointsValuesLinear[i+3*t+1],t=r.pointsValuesLinear[i+3*t+2],o.x=a*(1-s)+n*s,o.y=c*(1-s)+e*s,o.z=l*(1-s)+t*s)}},{key:"isTriangleVisible",value:function(e,t,n){e=this.voxelWorld.getClosestAtom(e),t=this.voxelWorld.getClosestAtom(t),n=this.voxelWorld.getClosestAtom(n);return null!==e&&null!==t&&null!==n&&null!==e.srcAtom&&null!==t.srcAtom&&null!==n.srcAtom&&(this.visibilitySelector.includesAtom(e.srcAtom)&&this.visibilitySelector.includesAtom(t.srcAtom)&&this.visibilitySelector.includesAtom(n.srcAtom))}},{key:"addTriangle",value:function(e,t,n){if(this.visibilitySelector&&!this.isTriangleVisible(e,t,n))return!0;var r=this.geoOut;if(r._numTriangles>=this.maxNumTriangles)return!1;var i=this.addVertexToGeo(r,e),e=this.addVertexToGeo(r,t),t=this.addVertexToGeo(r,n);if((i|e|t)<0)return!1;n=3*r._numTriangles;return r._indices[0+n]=i,r._indices[1+n]=e,r._indices[2+n]=t,r._numTriangles++,!0}},{key:"buildGeoFromCorners",value:function(e,t,n,r,i,o){for(var s=e-1,a=new Array(12),c=0;c<12;c++)a[c]=new ae.Vector3;for(var l=[],u=0;u<8;u++)l[u]=1;for(var h=new ae.Vector3,f=0,d=0;d<s;d++,0)for(var p=0;p<s;p++,0)for(var m=0;m<s;m++)if(o.hasIntersection[f]){var y=o.bitsInside[f];this.getCornerCoord(t,n,m,d,p,e,h);for(var _=32*f,v=0,g=0;v<8;v++)o.pointsValuesLinear[_+g++]=h.x,o.pointsValuesLinear[_+g++]=h.y,o.pointsValuesLinear[_+g++]=h.z;o.pointsValuesLinear[3+_]+=i.x,o.pointsValuesLinear[6+_]+=i.x,o.pointsValuesLinear[15+_]+=i.x,o.pointsValuesLinear[18+_]+=i.x,o.pointsValuesLinear[6+_+2]+=i.z,o.pointsValuesLinear[9+_+2]+=i.z,o.pointsValuesLinear[18+_+2]+=i.z,o.pointsValuesLinear[21+_+2]+=i.z,o.pointsValuesLinear[12+_+1]+=i.y,o.pointsValuesLinear[15+_+1]+=i.y,o.pointsValuesLinear[18+_+1]+=i.y,o.pointsValuesLinear[21+_+1]+=i.y;for(var x=24+_,b=0;b<8;++b)l[b]=o.pointsValuesLinear[x+b]<0?1:0;this.buildEdgePoint(0,1,l,o,_,a[0]),this.buildEdgePoint(1,2,l,o,_,a[1]),this.buildEdgePoint(2,3,l,o,_,a[2]),this.buildEdgePoint(3,0,l,o,_,a[3]),this.buildEdgePoint(4,5,l,o,_,a[4]),this.buildEdgePoint(5,6,l,o,_,a[5]),this.buildEdgePoint(6,7,l,o,_,a[6]),this.buildEdgePoint(7,4,l,o,_,a[7]),this.buildEdgePoint(0,4,l,o,_,a[8]),this.buildEdgePoint(1,5,l,o,_,a[9]),this.buildEdgePoint(2,6,l,o,_,a[10]),this.buildEdgePoint(3,7,l,o,_,a[11]);for(var w=16*y,S=0,R=0;S<6;S++,R+=3){var C=o.striIndicesMarchCube[w+R];if(C<0)break;var A=o.striIndicesMarchCube[w+R+1],E=o.striIndicesMarchCube[w+R+2];if(!this.addTriangle(a[C],a[A],a[E]))return-2}f++}else f++;return 0}},{key:"getNumIntersectedCells",value:function(e,t,n,r){for(var i=e*e,o=0,s=0,a=0,c=0;c<t;c++,a+=i)for(var l=0,u=0;u<t;u++,l+=e)for(var h=0;h<t;h++){var f=32*s+24,d=h+l+a;r.pointsValuesLinear[f]=n[d],r.pointsValuesLinear[1+f]=n[d+1],r.pointsValuesLinear[2+f]=n[d+e+1],r.pointsValuesLinear[3+f]=n[d+e],r.pointsValuesLinear[4+f]=n[i+d],r.pointsValuesLinear[5+f]=n[i+d+1],r.pointsValuesLinear[6+f]=n[i+d+e+1],r.pointsValuesLinear[7+f]=n[i+d+e];for(var p=0,m=0;m<8;++m)r.pointsValuesLinear[f+m]<0&&(p|=1<<m);0===p||255===p?r.hasIntersection[s]=!1:(r.hasIntersection[s]=!0,o++),r.bitsInside[s]=p,s++}return o}},{key:"getType",value:function(e){var t=[0,0,1,1,2,6,3,6,4,6,5,6,6,0,7,3,8,2,9,6,10,6,11,6,12,6,13,6,14,6,15,4,16,5,17,6,18,6,19,6,20,6,21,6,22,6,23,6,24,6,25,6,26,6,27,6,28,6,29,6,30,6,31,6,32,6,33,6,34,6,35,6,36,6,37,6,38,6,39,6,40,6,41,6,42,6,43,6,44,6,45,6,46,6,47,6,48,6,49,6,50,6,51,6,52,6,53,6,54,6,55,6,56,6,57,6,58,6,59,6,60,6,61,6,62,6,63,6,64,6,65,6,66,6,67,6,68,6,69,6,70,6,71,6,72,6,73,6,74,6,75,6,76,6,77,6,78,6,79,6,80,6,81,6,82,6,83,6,84,6,85,6,86,6,87,6,88,6,89,6,90,6,91,6,92,6,93,6,94,6,95,6,96,6,97,6,98,6,99,6,100,6,101,6,102,6,103,6,104,6,105,6,106,6,107,6,108,6,109,6];if(e<1||t.length/2<e||2*Object.keys(Li.ByAtomicNumber).length!==t.length)throw new Error("atomT.length  should be equal Element.ByAtomicNumber.length * 2");return t[2*e]}},{key:"calculateGridCorners",value:function(e,t,n,r,i,o){for(var s=t*t,a=s*t,c=new ae.Vector3,l=new ae.Vector3,u=0;u<a;u++)e[u]=1e12;for(var h=(t-1)/(r.x-n.x),f=(t-1)/(r.y-n.y),d=(t-1)/(r.z-n.z),p=0,m=i.length;p<m;p++)for(var y=i[p],_=y.radius+o,v=(y.coord.x-_-n.x)*h,g=(y.coord.y-_-n.y)*f,x=(y.coord.z-_-n.z)*d,b=Math.floor(v),g=Math.floor(g),w=Math.floor(x),S=Math.floor((y.coord.x+_-n.x)*h),R=Math.floor((y.coord.y+_-n.y)*f),C=Math.floor((y.coord.z+_-n.z)*d),S=++S<=t-1?S:t-1,R=++R<=t-1?R:t-1,C=++C<=t-1?C:t-1,A=g;A<=R;A++)for(var E=A*s,k=w;k<=C;k++)for(var T=k*t,P=b;P<=S;P++){var M=E+T+P;this.getCornerCoord(n,r,P,A,k,t,c),l.x=c.x-y.coord.x,l.y=c.y-y.coord.y,l.z=c.z-y.coord.z;var N=Math.sqrt(l.x*l.x+l.y*l.y+l.z*l.z)-_;N<e[M]&&(e[M]=N)}}},{key:"createVertexHash",value:function(e,t){if(this.hashLines=ce.allocateTyped(Int32Array,65536),null===this.hashLines)return-1;for(var n=0,r=0;n<32768;n++)this.hashLines[r++]=0,this.hashLines[r++]=-1;if(this.maxNumVertices=e,this.maxNumTriangles=t,this.numHashEtriesAllocated=e,this.hashEntries=ce.allocateTyped(Int32Array,2*this.numHashEtriesAllocated),null===this.hashEntries)return-1;for(var i=0,o=0;i<this.numHashEtriesAllocated;i++)this.hashEntries[o++]=-1,this.hashEntries[o++]=-1;return this.numHashEntryIndex=0}},{key:"getNewHashEntry",value:function(){if(this.numHashEntryIndex<this.numHashEtriesAllocated){var e=this.numHashEntryIndex;return this.numHashEntryIndex++,e}return-1}},{key:"addVertexToGeo",value:function(e,t){var n,r=this.marCubeResoultion<<2,i=new ae.Vector3,o=Math.floor(r*(t.x-this.vBoxMin.x)/(this.vBoxMax.x+.01-this.vBoxMin.x)),s=Math.floor(r*(t.y-this.vBoxMin.y)/(this.vBoxMax.y+.01-this.vBoxMin.y)),o=815851*o+37633*Math.floor(r*(t.z-this.vBoxMin.z)/(this.vBoxMax.z+.01-this.vBoxMin.z))+2453543*s,r=(o&=32767)+o;if(null!==this.vBoxMin&&null!==this.vBoxMax)for(n=this.hashLines[1+r];0<=n;n=this.hashEntries[2*n+1]){var a=this.hashEntries[2*n+0];if(i.copy(e._vertices[a]),i.x-=t.x,i.y-=t.y,i.z-=t.z,i.x*i.x+i.y*i.y+i.z*i.z<1e-6)return a}if(e._numVertices>=this.maxNumVertices)return-1;s=e._numVertices;if(e._vertices[s].copy(t),null!==this.vBoxMin&&null!==this.vBoxMax){if((n=this.getNewHashEntry())<0)return-1;o=this.hashLines[1+r];this.hashLines[1+r]=n,this.hashEntries[2*n+0]=s,this.hashEntries[2*n+1]=o,this.hashLines[r]++}return e._numVertices++,s}},{key:"modifyExcludedFromGeo",value:function(e,t,n,r,i,o){var s,a;for(var c=e*e,l=(e-1)/(r.x-n.x),u=(e-1)/(r.y-n.y),h=(e-1)/(r.z-n.z),f=2*t*(2*t),d=1/(e-1),p=0;p<i._numVertices;p++)for(var m=i._vertices[p],y=1.1*t,_=Math.floor((m.x-y-n.x)*l),v=Math.floor((m.y-y-n.y)*u),_=0<=_?_:0,g=0<=(g=Math.floor((m.z-y-n.z)*h))?g:0,x=(x=Math.floor((m.x+y-n.x)*l))<=e-1?x:e-1,b=(b=Math.floor((m.y+y-n.y)*u))<=e-1?b:e-1,w=(w=Math.floor((m.z+y-n.z)*h))<=e-1?w:e-1,S=v=0<=v?v:0;S<=b;S++)for(var R=S*c,C=g;C<=w;C++)for(var A=C*e,E=_;E<=x;E++){s=R+A+E;var k=E*d,T=n.x*(1-k)+r.x*k,k=S*d,P=n.y*(1-k)+r.y*k;k=C*d;k=n.z*(1-k)+r.z*k,T=T-m.x,P=P-m.y,k=k-m.z,k=T*T+P*P+k*k;k<f&&(k=Math.sqrt(k),0<(a=-(k-t))&&o[s]<0&&(o[s]=a),a>o[s]&&(o[s]=a))}return 0}},{key:"_innerBuild",value:function(){var e={posRad:this._posRad,colors:this._colors,atoms:this._opts.atoms};this.complex=this._opts.parent,this.atoms=e.atoms,this.meshResolution=this._opts.gridSpacing,this.atomRadiusScale=this._opts.radScale,this.colorMode=this._opts.colorMode,this.probeRadius=this._opts.probeRadius,this.useVertexColors=!0,this.excludeProbe=this._opts.excludeProbe,this.visibilitySelector=this._opts.visibilitySelector,this.geoOut=null,this.hashLines=null,this.hashEntries=null,this.numHashEtriesAllocated=0,this.numHashEntryIndex=0,this.maxNumVertices=0,this.maxNumTriangles=0;var t=new Array(this.atoms.length);this.convertToAtomsColored(e,t);var n=this.vBoxMin=new ae.Vector3,r=this.vBoxMax=new ae.Vector3;this.getBoundingBox(t,n,r);var i=this.marCubeResoultion=4*this.meshResolution,o=i,s=o*o*o,a=ce.allocateTyped(Float32Array,s),c=this.probeRadius*this.atomRadiusScale;this.calculateGridCorners(a,o,n,r,t,c);var l,u=i-1,h=new pi;if((l=h.create(u))<0)return l;var f=new ae.Vector3;f.x=(r.x-n.x)/u,f.y=(r.y-n.y)/u,f.z=(r.z-n.z)/u;var d=this.getNumIntersectedCells(o,u,a,h),p=Math.floor(1.2*d),e=Math.floor(1.2*d*2);if(this.geoOut=new Ni(p,e,this.useVertexColors),(l=this.createVertexHash(p,e))<0)return l;s=c;if(this.excludeProbe&&(s=.01),this.voxelWorld=new Mi(t.length,t,n,r,s),this.voxelWorld.createVoxels(),l=this.buildGeoFromCorners(i,n,r,a,f,h),this.excludeProbe){if(this.modifyExcludedFromGeo(o,c,n,r,this.geoOut,a),this.geoOut._vertices=null,this.geoOut._colors=null,this.geoOut._indices=null,this.geoOut._normals=null,this.geoOut._numVertices=0,this.geoOut._numTriangles=0,this.geoOut=null,d=this.getNumIntersectedCells(o,u,a,h),p=Math.floor(1.2*d),e=Math.floor(1.2*d*2),this.geoOut=new Ni(p,e,this.useVertexColors),(l=this.createVertexHash(p,e))<0)return l;l=this.buildGeoFromCorners(o,n,r,a,f,h)}this.voxelWorld.buildNormals(this.geoOut._vertices.length,this.geoOut._vertices,this.geoOut._normals);f=6.5;return this.excludeProbe&&(f-=1.5),this.useVertexColors&&this.voxelWorld.buildColors(this.geoOut._vertices.length,this.geoOut._vertices,this.geoOut._colors,f),this.voxelWorld.destroyVoxels(),this.voxelWorld=null,h.destroy(),l}}]),t}(),LabelsGeometry:function(){A(s,O);var o=Di(s);function s(e,t){var n;j(this,s),(n=o.call(this))._opts=t,n.items=[],n.needsUpdate=!1;var r=-50,i=-50;switch(t.horizontalAlign){case"left":r=0;break;case"right":r=-100}switch(t.verticalAlign){case"top":i=-100;break;case"bottom":i=0}t=new ae.Vector3(t.dx||0,t.dy||0,t.dz||0);return n.userData={translation:"translate(".concat(r,"%, ").concat(i,"%)"),offset:t},n}return _(s,[{key:"setItem",value:function(e,t,n){var r=this._opts,n=this.items[e]||function(e,t){var n=document.createElement("div");if(n.className=t,"string"==typeof e){var r=document.createElement("span");r.style.fontSize="150%";for(var i=e.split("\n"),o=0,s=i.length;o<s;++o){var a=document.createElement("span"),c=document.createTextNode(i[o]);a.appendChild(c),r.appendChild(a),o<s-1&&r.appendChild(document.createElement("br"))}n.appendChild(r)}else n.appendChild(e);return n.worldPos=new ae.Vector3,n}(n,"label");n.worldPos.copy(t),n.style.textAlign=r.horizontalAlign,n.style.verticalAlign=r.verticalAlign,this.items[e]=n}},{key:"setColor",value:function(e,t,n){this.items[e].opts={color:t,background:n}}},{key:"startUpdate",value:function(){return!0}},{key:"finishUpdate",value:function(){this.needsUpdate=!0,this.dispatchEvent({type:"update"})}},{key:"finalize",value:function(){this.finishUpdate()}},{key:"raycast",value:function(){}},{key:"setOpacity",value:function(){}},{key:"getSubset",value:function(){return[]}}]),s}()},Vi="float INSTANCED_SPRITE_OVERSCALE = 1.3;\n\nattribute vec3 normal;\n\n#ifdef NORMALS_TO_G_BUFFER\n  varying vec3 viewNormal;\n#endif\n#if !defined (SPHERE_SPRITE) && !defined (CYLINDER_SPRITE)\n  varying vec3 vNormal;\n#endif\n\n#ifdef THICK_LINE\n  attribute vec4 position; // W contains vert pos or neg offset\n#else\n  attribute vec3 position;\n#endif\n\nvarying vec3 vWorldPosition;\nvarying vec3 vViewPosition;\n\n#ifdef ATTR_ALPHA_COLOR\n  attribute float alphaColor;\n  varying float alphaCol;\n#endif\n\n#if defined(USE_LIGHTS) && defined(SHADOWMAP)\n\t#if NUM_DIR_LIGHTS > 0\n\t\tuniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHTS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHTS ];\n\t\tvarying vec3 vDirectionalShadowNormal[ NUM_DIR_LIGHTS ];\n\t#endif\n#endif\n\n#ifdef ATTR_COLOR\n  attribute vec3 color;\n  varying vec3 vColor;\n#endif\n\n#ifdef ATTR_COLOR2\n  attribute vec3 color2;\n  varying vec3 vColor2;\n  attribute vec2 uv;\n  #ifndef CYLINDER_SPRITE\n    varying vec2 vUv;\n  #endif\n#endif\n\n#ifdef INSTANCED_POS\n  attribute vec4 offset;\n  #ifdef SPHERE_SPRITE\n    varying vec4 instOffset;\n  varying vec4 spritePosEye;\n  #endif\n#endif\n\n#ifdef INSTANCED_MATRIX\n  attribute vec4 matVector1;\n  attribute vec4 matVector2;\n  attribute vec4 matVector3;\n  attribute vec4 invmatVector1;\n  attribute vec4 invmatVector2;\n  attribute vec4 invmatVector3;\n\n  #ifdef CYLINDER_SPRITE\n    varying vec4 matVec1;\n    varying vec4 matVec2;\n    varying vec4 matVec3;\n    varying vec4 invmatVec1;\n    varying vec4 invmatVec2;\n    varying vec4 invmatVec3;\n    varying vec4 spritePosEye;\n  #endif\n#endif\n\nuniform mat4 modelViewMatrix; // optional\nuniform mat4 projectionMatrix; // optional\nuniform mat3 normalMatrix; // optional\nuniform mat4 modelMatrix; // optional\n\n#ifdef DASHED_LINE\n  attribute float lineDistance;\n  varying float vLineDistance;\n#endif\n\n#ifdef THICK_LINE\n  attribute vec3 direction;\n  uniform mat4 projMatrixInv;\n  uniform vec2 viewport;\n  uniform float lineWidth;\n\n  vec4 transform(vec4 coord){\n    return projectionMatrix * modelViewMatrix * coord;\n  }\n\n  vec2 project(vec4 device){\n    vec3 device_normal = device.xyz/device.w;\n    vec2 clip_pos = (device_normal*0.5+0.5).xy;\n    return clip_pos * viewport;\n  }\n\n  vec4 unproject(vec2 screen, float z, float w){\n    vec2 clip_pos = screen/viewport;\n    vec2 device_normal = clip_pos*2.0-1.0;\n    return vec4(device_normal*w, z, w);\n  }\n#endif\n\n\n/////////////////////////////////////////// Main ///////////////////////////////////////////////\nvoid main() {\n\n#ifdef ATTR_ALPHA_COLOR\n  alphaCol = alphaColor;\n#endif\n\n#ifdef INSTANCED_MATRIX\n  vec3 objectNormal = vec3(\n    dot(normal, matVector1.xyz),\n    dot(normal, matVector2.xyz),\n    dot(normal, matVector3.xyz));\n#else\n  vec3 objectNormal = vec3( normal );\n#endif\n\nvec3 transformedNormal = normalMatrix * objectNormal;\n\n#if !defined (SPHERE_SPRITE) && !defined (CYLINDER_SPRITE)\n  vNormal = normalize(transformedNormal);\n#endif\n\n#ifdef NORMALS_TO_G_BUFFER\n  viewNormal = normalize(mat3(modelViewMatrix)*objectNormal);\n#endif\n\n  vec4 localPos = vec4(position.xyz, 1.0);\n  vec4 worldPos = modelMatrix * localPos;\n  vec4 mvPosition = modelViewMatrix * localPos;\n\n// make thick line offset\n#ifdef THICK_LINE\n   // get screen pos\n   vec4 dPos = transform(vec4(position.xyz, 1.0));\n   vec2 sPos = project(dPos);\n   // move pos forward\n   vec3 position2 = position.xyz + direction.xyz * 0.5;\n   // get screen offset pos\n   vec4 dPos2 = transform(vec4(position2.xyz, 1.0));\n   vec2 sPos2 = project(dPos2);\n   // screen line direction\n   vec2 sDir = normalize(sPos2 - sPos);\n   // vertex offset (orthogonal to line direction)\n   vec2 offset1 = vec2(-sDir.y, sDir.x);\n   // move screen vertex\n   vec2 newPos = sPos + offset1 * position.w * lineWidth;\n   // get moved pos in view space\n   vec4 dNewPos =  unproject(newPos, dPos.z, dPos.w);\n   mvPosition.xyz = (projMatrixInv * dNewPos).xyz;\n#endif // THICK_LINE\n\n#ifdef INSTANCED_POS\n  #ifdef SPHERE_SPRITE\n    instOffset = offset;\n\n    vec4 posEye = modelViewMatrix * vec4( offset.xyz, 1.0 );\n    float scale = length(modelViewMatrix[0]);\n    mvPosition = posEye + vec4( position.xyz * offset.w * scale * INSTANCED_SPRITE_OVERSCALE, 0.0 );\n    posEye.w = offset.w * scale;\n\n    spritePosEye = posEye;\n #else\n    localPos = vec4( offset.xyz + position.xyz * offset.w, 1.0 );\n    worldPos = modelMatrix * localPos;\n    mvPosition = modelViewMatrix * localPos;\n  #endif\n#endif\n\n#ifdef INSTANCED_MATRIX\n  #ifdef CYLINDER_SPRITE\n    matVec1 = matVector1;\n    matVec2 = matVector2;\n    matVec3 = matVector3;\n    invmatVec1 = invmatVector1;\n    invmatVec2 = invmatVector2;\n    invmatVec3 = invmatVector3;\n\n    // calculate eye coords of cylinder endpoints\n    vec4 v = vec4(0, -0.5, 0, 1);\n    vec4 p1 = modelViewMatrix * vec4(dot(v, matVector1), dot(v, matVector2), dot(v, matVector3), 1.0);\n    v.y = 0.5;\n    vec4 p2 = modelViewMatrix * vec4(dot(v, matVector1), dot(v, matVector2), dot(v, matVector3), 1.0);\n\n    // sprite is placed at the center of cylinder\n    vec4 posEye;\n    posEye.xyz = mix(p1.xyz, p2.xyz, 0.5);\n    posEye.w = 1.0;\n    spritePosEye = posEye;\n\n    // cylinder radius in eye space\n    float rad = length(modelViewMatrix[0]) * length(vec3(matVector1.x, matVector2.x, matVector3.x));\n    vec2 spriteSize;\n    #ifdef ORTHOGRAPHIC_CAMERA\n      // In ortho projection we skip z coordinate\n      // basic sprite size at screen plane (covers only cylinder axis)\n      vec2 spriteSizeScreen = abs(p2.xy - p1.xy);\n\n      spriteSize = vec2(1.0, 1.0) * INSTANCED_SPRITE_OVERSCALE * (spriteSizeScreen + 2.0 * rad);\n    #else\n      // basic sprite size at screen plane (covers only cylinder axis)\n      vec2 spriteSizeScreen = abs(p2.xy / p2.z - p1.xy / p1.z);\n\n      // full sprite size in eye coords\n      float minZ = min(abs(p1.z), abs(p2.z));\n      spriteSize = vec2(1.0, 1.0) * INSTANCED_SPRITE_OVERSCALE * abs(posEye.z) * (spriteSizeScreen + 2.0 * rad / minZ);\n    #endif\n\n    mvPosition = posEye + vec4( position.xy * 0.5 * spriteSize, 0, 0 );\n  #else\n    localPos = vec4(dot(localPos, matVector1), dot(localPos, matVector2), dot(localPos, matVector3), 1.0);\n    worldPos = modelMatrix * localPos;\n    mvPosition = modelViewMatrix * localPos;\n  #endif\n#endif\n\n  gl_Position = projectionMatrix * mvPosition;\n\n  vWorldPosition = worldPos.xyz;\n  vViewPosition = - mvPosition.xyz;\n\n#if defined(USE_LIGHTS) && defined(SHADOWMAP)\n\t#if NUM_DIR_LIGHTS > 0\n\t  vec4 worldPosition;\n\t  // see THREE.WebGLProgram.unrollLoops\n\t  #pragma unroll_loop_start\n\t  for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n      vDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * vec4(vWorldPosition, 1.0);\n      vDirectionalShadowNormal[ i ] = (directionalShadowMatrix[ i ] * (modelMatrix * vec4(objectNormal, 0.0))).xyz;\n\t  }\n\t  #pragma unroll_loop_end\n\t#endif\n#endif\n\n#ifdef ATTR_COLOR\n  vColor = color.xyz;\n#endif\n\n#ifdef ATTR_COLOR2\n  vColor2 = color2;\n  #ifndef CYLINDER_SPRITE\n    vUv = uv;\n  #endif\n#endif\n\n#ifdef DASHED_LINE\n  vLineDistance = lineDistance;\n#endif\n}\n",zi="#if defined (NORMALS_TO_G_BUFFER)\n  #define fragColor gl_FragData[0]\n#else\n  #define fragColor gl_FragColor\n#endif\n\n#ifdef ATTR_ALPHA_COLOR\n  varying float alphaCol;\n#endif\n\n#ifdef COLOR_FROM_POS\n  uniform mat4 world2colorMatrix;\n#endif\n\n#if defined(USE_LIGHTS) && defined(SHADOWMAP)\n\t#if NUM_DIR_LIGHTS > 0\n\t\tuniform sampler2D directionalShadowMap[ NUM_DIR_LIGHTS ];\n    uniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHTS ]; //only for sprites\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHTS ];\n\t\tvarying vec3 vDirectionalShadowNormal[ NUM_DIR_LIGHTS ];\n    vec4 vDirLightWorldCoord[ NUM_DIR_LIGHTS ];\n    vec3 vDirLightWorldNormal[ NUM_DIR_LIGHTS ];\n\n    #ifdef SHADOWMAP_PCF_RAND\n      // We use 4 instead uniform variable or define because this value is used in for(... i < value; ...) with\n      // unroll_loop and unroll_loop has pattern:\n      // /#pragma unroll_loop[\\s]+?for \\( int i \\= (\\d+)\\; i < (\\d+)\\; i \\+\\+ \\) \\{([\\s\\S]+?)(?=\\})\\}/g\n      uniform vec2 samplesKernel[4]; // 4 is length of _samplesKernel which is defined in UberMaterial.js\n      uniform sampler2D noiseTex;\n      uniform vec2 noiseTexelSize;\n      uniform vec2 srcTexelSize;\n      uniform mat4 projectionMatrix;\n    #endif\n\t#endif\n#endif\n\n#ifdef ATTR_COLOR\n  varying vec3 vColor;\n#endif\n\n#ifdef ATTR_COLOR2\n  varying vec3 vColor2;\n  #ifndef CYLINDER_SPRITE\n    varying vec2 vUv;\n  #endif\n#endif\n\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;\nuniform vec3 fixedColor;\nuniform float opacity;\nuniform float zClipValue;\nuniform float clipPlaneValue;\n\n#ifdef NORMALS_TO_G_BUFFER\n  varying vec3 viewNormal;\n#endif\n\n#define PI 3.14159265359\n#define RECIPROCAL_PI 0.31830988618\n#define saturate(a) clamp( a, 0.0, 1.0 )\n\n#ifdef USE_FOG\n  uniform vec3 fogColor;\n  uniform float fogAlpha;\n  uniform float fogNear;\n  uniform float fogFar;\n#endif\n\nvarying vec3 vWorldPosition; // world position of the pixel (invalid when INSTANCED_SPRITE is defined)\nvarying vec3 vViewPosition;\n\n#if !defined (SPHERE_SPRITE) && !defined (CYLINDER_SPRITE)\n  varying vec3 vNormal;\n#endif\n\n/////////////////////////////////////////// ZSprites ////////////////////////////////////////////////\n#if defined (SPHERE_SPRITE) || defined (CYLINDER_SPRITE)\n  uniform float nearPlaneValue;\n#endif\n\n#ifdef SPHERE_SPRITE\n  varying vec4 spritePosEye;\n#endif\n\n#if defined(SPHERE_SPRITE) || defined(CYLINDER_SPRITE)\n  uniform float zOffset;\n\n  #if !defined(USE_LIGHTS) || !defined(SHADOWMAP) || !defined(SHADOWMAP_PCF_RAND) || !(NUM_DIR_LIGHTS > 0)\n    uniform mat4 projectionMatrix;\n  #endif\n\n  float calcDepthForSprites(vec4 pixelPosEye, float zOffset, mat4 projMatrix) {\n    vec4 pixelPosScreen = projMatrix * pixelPosEye;\n    return 0.5 * (pixelPosScreen.z / pixelPosScreen.w + 1.0) + zOffset;\n  }\n#endif\n\n#ifdef SPHERE_SPRITE\n  varying vec4 instOffset;\n  uniform mat4 modelMatrix;\n  uniform mat4 modelViewMatrix;\n  uniform mat4 invModelViewMatrix;\n  uniform mat3 normalMatrix;\n\n\n  bool intersect_ray_sphere(in vec3 origin, in vec3 ray, out vec3 point, out float frontFaced) {\n\n    // intersect XZ-projected ray with circle\n    float a = dot(ray, ray);\n    float b = dot(ray, origin);\n    float c = dot(origin, origin) - 1.0;\n    float det = b * b - a * c;\n    if (det < 0.0) return false;\n    float t1 = (-b - sqrt(det)) / a;\n    float t2 = (-b + sqrt(det)) / a;\n\n    // calculate both intersection points\n    vec3 p1 = origin + ray * t1;\n    vec3 p2 = origin + ray * t2;\n\n    // choose nearest point inside frustum\n    #ifdef ORTHOGRAPHIC_CAMERA\n      // orthografic camera is used for dirLight sources. So in it for all spheres the point with smaller 't' is visible\n      // t1 is always smaller than t2 (from calculations)\n      point = p1;\n      frontFaced = 1.0;\n      return true;\n    #else\n      // for perspective camera first intersection can be in front of near plane. If not intersection is p1 else - p2\n      // t* = 0.0 corresponds to point of intersection near plane by the ray from camera to curPixel\n      if (t1 >= 0.0) {\n        point = p1;\n        frontFaced = 1.0;\n        return true;\n      }\n      if (t2 >= 0.0) {\n        point = p2;\n        frontFaced = -1.0;\n        return true;\n      }\n    #endif\n\n    return false;\n  }\n\n  bool get_sphere_point(in vec3 pixelPosEye, out vec3 point, out float frontFaced) {\n    vec3 origin, ray;\n\n    #ifdef ORTHOGRAPHIC_CAMERA\n      // transform vector from sprite center to curPixel into sphere local coords\n      origin = pixelPosEye.xyz - spritePosEye.xyz;\n      origin = (invModelViewMatrix * vec4(origin, 0.0)).xyz / instOffset.w;\n\n      // transform camera orientation vector into sphere local coords\n      ray = (invModelViewMatrix * vec4(0.0, 0.0, -1.0, 0.0)).xyz;\n    #else\n      // find point of intersection near plane by the ray from camera to curPixel\n      vec4 v = vec4(-(nearPlaneValue / pixelPosEye.z) * pixelPosEye, 1.0);\n\n      // transform intersection point into sphere local coords\n      v = invModelViewMatrix * v;\n      origin = (v.xyz - instOffset.xyz) / instOffset.w;\n\n      // transform vector from camera pos to curPixel into sphere local coords\n      ray = (invModelViewMatrix * vec4(pixelPosEye, 0.0)).xyz;\n    #endif\n    ray = normalize(ray);\n\n    return intersect_ray_sphere(origin, ray, point, frontFaced);\n  }\n#endif\n\n#ifdef CYLINDER_SPRITE\n  varying vec4 matVec1;\n  varying vec4 matVec2;\n  varying vec4 matVec3;\n  varying vec4 invmatVec1;\n  varying vec4 invmatVec2;\n  varying vec4 invmatVec3;\n\n  uniform mat4 modelMatrix;\n  uniform mat4 modelViewMatrix;\n  uniform mat4 invModelViewMatrix;\n  uniform mat3 normalMatrix;\n\n  varying vec4 spritePosEye;\n\n  bool intersect_ray_cylinder(in vec3 origin, in vec3 ray, out vec3 point, out float frontFaced) {\n\n    // intersect XZ-projected ray with circle\n    float a = dot(ray.xz, ray.xz);\n    float b = dot(ray.xz, origin.xz);\n    float c = dot(origin.xz, origin.xz) - 1.0;\n    float det = b * b - a * c;\n    if (det < 0.0) return false;\n    float t1 = (-b - sqrt(det)) / a;\n    float t2 = (-b + sqrt(det)) / a;\n\n    // calculate both intersection points\n    vec3 p1 = origin + ray * t1;\n    vec3 p2 = origin + ray * t2;\n\n    float halfHeight = 0.5;\n\n    // choose nearest point\n    #ifdef ORTHOGRAPHIC_CAMERA\n      // orthografic camera is used for dirLight sources. So in it for all cylinders the point with smaller 't' is visible\n      // if it is not outside of cylinnder (t1 is always smaller than t2).\n      if (p1.y >= -halfHeight && p1.y <= halfHeight) {\n        point = p1;\n        frontFaced = 1.0;\n        return true;\n      }\n      if (p2.y >= -halfHeight && p2.y <= halfHeight) {\n        point = p2;\n        frontFaced = -1.0;\n        return true;\n      }\n    #else\n      // for perspective camera first intersection can be in front of near plane. If not intersection is p1 else - p2\n      // t* = 0.0 corresponds to point of intersection near plane by the ray from camera to curPixel\n      if (t1 >= 0.0 && p1.y >= -halfHeight && p1.y <= halfHeight) {\n        point = p1;\n        frontFaced = 1.0;\n        return true;\n      }\n      if (t2 >= 0.0 && p2.y >= -halfHeight && p2.y <= halfHeight) {\n        point = p2;\n        frontFaced = -1.0;\n        return true;\n      }\n    #endif\n\n    return false;\n  }\n\n  bool get_cylinder_point(in vec3 pixelPosEye, out vec3 point, out float frontFaced) {\n    vec3 origin, ray;\n    vec4 v;\n\n    #ifdef ORTHOGRAPHIC_CAMERA\n      // transform vector from sprite center to curPixel into cylinder local coords\n      v = invModelViewMatrix * vec4(pixelPosEye.xyz - spritePosEye.xyz, 0.0);\n      origin = vec3(dot(v, invmatVec1), dot(v, invmatVec2), dot(v, invmatVec3));\n\n      // transform camera orientation vector into cylinder local coords\n      v = invModelViewMatrix * vec4(0.0, 0.0, -1.0, 0.0);\n      ray = vec3(dot(v, invmatVec1), dot(v, invmatVec2), dot(v, invmatVec3));\n    #else\n      // find point of intersection near plane by the ray from camera to curPixel\n      v = vec4(-(nearPlaneValue / pixelPosEye.z) * pixelPosEye, 1.0);\n\n      // transform intersection point into cylinder local coords\n      v = invModelViewMatrix * v;\n      origin = vec3(dot(v, invmatVec1), dot(v, invmatVec2), dot(v, invmatVec3));\n\n      // transform vector from camera pos to curPixel into cylinder local coords\n      v = invModelViewMatrix * vec4(pixelPosEye, 0.0);\n      ray = vec3(dot(v, invmatVec1), dot(v, invmatVec2), dot(v, invmatVec3));\n    #endif\n    ray = normalize(ray);\n\n    return intersect_ray_cylinder(origin, ray, point, frontFaced);\n  }\n#endif\n\n///////////////////////////////////// Pack and unpack ///////////////////////////////////////////////\nconst float PackUpscale = 256. / 255.; // fraction -> 0..1 (including 1)\nconst float UnpackDownscale = 255. / 256.; // 0..1 -> fraction (excluding 1)\n\nconst vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );\nconst vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\n\n\nconst float ShiftRight8 = 1. / 256.;\n\nvec4 packDepthToRGBA( const in float v ) {\n  vec4 r = vec4( fract( v * PackFactors ), v );\n  r.yzw -= r.xyz * ShiftRight8; // tidy overflow\n  return r * PackUpscale;\n}\n\nfloat unpackRGBAToDepth( const in vec4 v ) {\n  return dot( v, UnpackFactors );\n}\n\n////////////////////////////////////////// All Lighting /////////////////////////////////////////////////\n#ifdef TOON_SHADING\n  #define LOW_TOON_BORDER 0.0\n  #define MEDIUM_TOON_BORDER 0.7\n  #define HIGH_TOON_BORDER 1.0\n\n  #define MEDIUM_TOON_RANGE 0.5\n  #define HIGH_TOON_RANGE 0.95\n#endif\n#if defined(USE_LIGHTS) && NUM_DIR_LIGHTS > 0\n  struct ReflectedLight {\n    vec3 directDiffuse;\n    vec3 directSpecular;\n    vec3 indirectDiffuse;\n  };\n\n  struct BlinnPhongMaterial {\n    vec3  diffuseColor;\n    vec3  specularColor;\n    float specularShininess;\n  };\n\n  struct GeometricContext {\n    vec3 normal;\n    vec3 viewDir;\n  };\n\n  struct DirectionalLight {\n    vec3 direction;\n    vec3 color;\n  };\n  uniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];\n\n  struct DirectionalLightShadow {\n     vec2 shadowMapSize;\n     float shadowBias;\n     float shadowRadius;\n   };\n  uniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHTS ];\n\n  uniform vec3 ambientLightColor;\n\n  /////////////////////////////////////////// Shadowmap ////////////////////////////////////////////////\n\n  #if defined(SHADOWMAP)\n  \tfloat texture2DCompare( sampler2D depths, vec2 uv, float compare ) {\n  \t\treturn step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );\n  \t}\n\n    float getShadow( sampler2D shadowMap, DirectionalLightShadow dirLight, vec4 shadowCoord, vec3 vViewPosition, vec3 vNormal ) {\n   \t  float shadow = 0.0;\n\n      // When shadows for sprites will appear use here for them normals as it done for G-buffer\n      shadowCoord.xyz += dirLight.shadowBias * vNormal;\n      shadowCoord.xyz /= shadowCoord.w;\n\n      bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );\n      bool inFrustum = all( inFrustumVec );\n      bvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );\n      bool frustumTest = all( frustumTestVec );\n\n      if ( frustumTest ) {\n        #ifdef SHADOWMAP_BASIC\n      \t  shadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );\n      \t#endif\n\n      \t#ifdef SHADOWMAP_PCF_SHARP\n      \t  vec2 texelSize = vec2( 1.0 ) / dirLight.shadowMapSize;\n\n            float dx0 = - texelSize.x * dirLight.shadowRadius;\n            float dy0 = - texelSize.y * dirLight.shadowRadius;\n            float dx1 = + texelSize.x * dirLight.shadowRadius;\n            float dy1 = + texelSize.y * dirLight.shadowRadius;\n\n            shadow = (\n            \ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n            \ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n            \ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n            \ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n            \ttexture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +\n            \ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n            \ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n            \ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n            \ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n            ) * ( 1.0 / 9.0 );\n        #endif\n\n        #ifdef SHADOWMAP_PCF_RAND\n          vec2 texelSize = vec2( 1.0 ) / dirLight.shadowMapSize;\n\n          vec4 vUv = ((projectionMatrix * vec4(vViewPosition, 1.0)) + 1.0) / 2.0;\n          vec2 vUvNoise = vUv.xy / srcTexelSize * noiseTexelSize;\n\n          vec2 noiseVec = normalize(texture2D(noiseTex, vUvNoise).rg);\n          mat2 mNoise = mat2(noiseVec.x, noiseVec.y, -noiseVec.y, noiseVec.x);\n\n          vec2 offset;\n          #pragma unroll_loop_start\n          for ( int i = 0; i < 4; i ++ ) { // 4 is length of _samplesKernel which is defined in UberMaterial.js\n            offset = mNoise * ( normalize( samplesKernel[ i ]) * texelSize * dirLight.shadowRadius );\n            shadow +=  texture2DCompare( shadowMap, shadowCoord.xy + offset, shadowCoord.z );\n          }\n          #pragma unroll_loop_end\n          shadow /= float( 4 ); // 4 is length of _samplesKernel which is defined in UberMaterial.js\n        #endif\n      }\n      return shadow;//(shadow != 1.0) ? 0.5 : 1.0;//vec4(shadow, shadow, shadow, 1.0);\n   }\n  #endif\n\n  /////////////////////////////////////////// Lighting /////////////////////////////////////////////////\n\n  vec3 BRDF_Diffuse_Lambert( const in vec3 diffuseColor ) {\n    return RECIPROCAL_PI * diffuseColor;\n  } // validated\n\n  vec3 F_Schlick( const in vec3 specularColor, const in float dotLH ) {\n    // Original approximation by Christophe Schlick '94\n    //;float fresnel = pow( 1.0 - dotLH, 5.0 );\n    // Optimized variant (presented by Epic at SIGGRAPH '13)\n    float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );\n    return ( 1.0 - specularColor ) * fresnel + specularColor;\n  } // validated\n\n  float G_BlinnPhong_Implicit( /* const in float dotNL, const in float dotNV */ ) {\n    // geometry term is (n dot l)(n dot v) / 4(n dot l)(n dot v)\n    return 0.25;\n  }\n\n  float D_BlinnPhong( const in float shininess, const in float dotNH ) {\n    return RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );\n  }\n\n  vec3 BRDF_Specular_BlinnPhong( const in DirectionalLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float shininess ) {\n    vec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );\n    float dotNH = saturate(dot( geometry.normal, halfDir ));\n    float dotLH = saturate(dot( incidentLight.direction, halfDir ));\n\n    vec3 F = F_Schlick( specularColor, dotLH );\n    float G = G_BlinnPhong_Implicit( /* dotNL, dotNV */ );\n    float D = D_BlinnPhong( shininess, dotNH );\n\n    return F * ( G * D );\n  } // validated\n\n  void RE_Direct_BlinnPhong( const in DirectionalLight directLight, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight, float penumbra ) {\n\n    float dotNL = saturate( dot( geometry.normal, directLight.direction ));\n    #ifdef TOON_SHADING\n      if(dotNL < MEDIUM_TOON_RANGE){\n        dotNL = LOW_TOON_BORDER;\n      }\n      else if(dotNL < HIGH_TOON_RANGE){\n        dotNL = MEDIUM_TOON_BORDER;\n      }\n      else{\n        dotNL = HIGH_TOON_BORDER;\n      }\n    #endif\n\n    vec3 irradiance = dotNL * directLight.color * PI;\n    reflectedLight.directDiffuse += penumbra * irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n    reflectedLight.directSpecular += penumbra * irradiance * BRDF_Specular_BlinnPhong( directLight, geometry, material.specularColor, material.specularShininess );\n  }\n\n  void RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n    reflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n  }\n\n  vec3 calcLighting(const in GeometricContext geometry, const in BlinnPhongMaterial material, vec3 vViewPosition) {\n    ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ));\n    vec3 irradiance = ambientLightColor * PI;\n\n    float shadowMask = 1.0;\n    // see THREE.WebGLProgram.unrollLoops\n  \t#pragma unroll_loop_start\n  \t  for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n  \t    #ifdef SHADOWMAP\n  \t      shadowMask = getShadow( directionalShadowMap[ i ], directionalLightShadows[ i ], vDirLightWorldCoord[ i ], vViewPosition, vDirLightWorldNormal[ i ] );\n        #endif\n\n  \t\t  if ( shadowMask > 0.0 ) RE_Direct_BlinnPhong( directionalLights[ i ], geometry, material, reflectedLight, shadowMask );\n  \t\t}\n  \t\t#pragma unroll_loop_end\n\n    RE_IndirectDiffuse_BlinnPhong(irradiance, material, reflectedLight);\n\n    return saturate(reflectedLight.indirectDiffuse + reflectedLight.directDiffuse + reflectedLight.directSpecular);\n  }\n#endif\n\n/////////////////////////////////////////// Dashed Line ///////////////////////////////////////////////\n#ifdef DASHED_LINE\n  uniform float dashedLineSize;\n  uniform float dashedLinePeriod;\n  varying float vLineDistance;\n#endif\n\n/////////////////////////////////////////// Main ///////////////////////////////////////////////\nvoid main() {\n\n#ifdef CLIP_PLANE\n  if (vViewPosition.z < clipPlaneValue) discard;\n#endif\n\n#ifdef ZCLIP\n  if (vViewPosition.z < zClipValue) discard;\n#endif\n\n#if defined(USE_LIGHTS) && defined(SHADOWMAP)\n  #if NUM_DIR_LIGHTS > 0\n    // see THREE.WebGLProgram.unrollLoops\n    #pragma unroll_loop_start\n    for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n      vDirLightWorldCoord[ i ] = vDirectionalShadowCoord[ i ];\n      vDirLightWorldNormal[ i ] = vDirectionalShadowNormal[ i ];\n    }\n    #pragma unroll_loop_end\n  #endif\n#endif\n\n  vec4 pixelPosWorld = vec4(vWorldPosition, 1.0);\n  vec4 pixelPosEye;\n\n#ifdef SPHERE_SPRITE\n\n  vec3 viewNormalSprites;\n  float frontFaced = 1.0;\n  vec3 normal;\n\n/* quick-and-dirty method\n  normal.xy = ' + INSTANCED_SPRITE_OVERSCALE + ' * (2.0 * vUv - 1.0);\n  float r2 = dot(normal.xy, normal.xy);\n  if (r2 > 1.0) discard;\n  float normalZ = sqrt(1.0 - r2);\n  normal.z = normalZ;\n  normal = normal * ( -1.0 + 2.0 * float( gl_FrontFacing ) );\n  pixelPosEye = vec4(spritePosEye.xyz, 1.0);\n  pixelPosEye.z += spritePosEye.w * normalZ;\n*/\n\n  // ray-trace sphere surface\n  {\n    vec3 p;\n    if (!get_sphere_point(-vViewPosition, p, frontFaced)) discard;\n    vec4 v = vec4(instOffset.xyz + p * instOffset.w, 1.0);\n    pixelPosWorld = modelMatrix * v;\n    pixelPosEye = modelViewMatrix * v;\n    normal = normalize(normalMatrix * p);\n    #ifdef NORMALS_TO_G_BUFFER\n      viewNormalSprites = normalize(mat3(modelViewMatrix)*p);\n    #endif\n\n    #if defined(USE_LIGHTS) && defined(SHADOWMAP)\n      #if NUM_DIR_LIGHTS > 0\n        // see THREE.WebGLProgram.unrollLoops\n        #pragma unroll_loop_start\n          for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n            vDirLightWorldCoord[ i ] = directionalShadowMatrix[ i ] * pixelPosWorld;\n            vDirLightWorldNormal[ i ] = (directionalShadowMatrix[ i ] * (modelMatrix * vec4(p, 0.0))).xyz;\n          }\n        #pragma unroll_loop_end\n      #endif\n    #endif\n  }\n#endif\n\n#ifdef CYLINDER_SPRITE\n  vec3 normal;\n  vec3 viewNormalSprites;\n  float frontFaced = 1.0;\n  float cylinderY = 0.0;\n\n  // ray-trace cylinder surface\n  {\n    vec3 p;\n    if (!get_cylinder_point(-vViewPosition, p, frontFaced)) discard;\n\n    cylinderY = 0.5 * (p.y + 1.0);\n\n    vec4 v = vec4(p, 1.0);\n    v = vec4(dot(v, matVec1), dot(v, matVec2), dot(v, matVec3), 1.0);\n    pixelPosWorld = modelMatrix * v;\n    pixelPosEye = modelViewMatrix * v;\n\n    vec3 localNormal = normalize(vec3(p.x, 0.0, p.z));\n    normal = vec3(\n      dot(localNormal, matVec1.xyz),\n      dot(localNormal, matVec2.xyz),\n      dot(localNormal, matVec3.xyz));\n    #ifdef NORMALS_TO_G_BUFFER\n      viewNormalSprites = normalize(mat3(modelViewMatrix)*normal);\n    #endif\n\n    #if defined(USE_LIGHTS) && defined(SHADOWMAP)\n      #if NUM_DIR_LIGHTS > 0\n        // see THREE.WebGLProgram.unrollLoops\n        #pragma unroll_loop_start\n          for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n            vDirLightWorldCoord[ i ] = directionalShadowMatrix[ i ] * pixelPosWorld;\n            vDirLightWorldNormal[ i ] = (directionalShadowMatrix[ i ] * (modelMatrix * vec4(normal, 0.0))).xyz;\n          }\n        #pragma unroll_loop_end\n      #endif\n    #endif\n\n    normal = normalize(normalMatrix * normal);\n  }\n#endif\n\n  #ifdef ATTR_COLOR\n    vec3 vertexColor = vColor;\n  #else\n    vec3 vertexColor = vec3(1.0, 1.0, 1.0);\n  #endif\n\n  #ifdef ATTR_COLOR2\n    #ifdef CYLINDER_SPRITE\n      float colorCoef = cylinderY; // cylinder parameter is calculated from ray-tracing\n    #else\n      float colorCoef = vUv.y; // cylinder parameter is interpolated as tex coord\n    #endif\n      // choose either color or color2\n    vertexColor = mix(vColor2, vColor, step(0.5, colorCoef));\n  #endif\n\n  // negative red component is a special condition\n  if (vertexColor.x < 0.0) discard;\n\n  #ifdef DASHED_LINE\n    if ( mod( vLineDistance, dashedLinePeriod ) > dashedLineSize ) discard;\n  #endif\n\n  // transparency prepass writes only z, so we don't need to calc the color\n  #ifdef PREPASS_TRANSP\n    fragColor = vec4(1.0, 1.0, 1.0, 1.0);\n    #if defined(SPHERE_SPRITE) || defined(CYLINDER_SPRITE)\n      gl_FragDepthEXT = calcDepthForSprites(pixelPosEye, zOffset, projectionMatrix);\n    #endif\n    return;\n  #endif\n\n    float totalOpacity = opacity;\n\n  #ifdef ATTR_ALPHA_COLOR\n    totalOpacity *= alphaCol;\n  #endif\n\n  // discard fully transparent pixels\n  if (totalOpacity == 0.0) discard;\n\n  #ifdef FAKE_OPACITY\n    // discard pixels in checker pattern\n    vec2 dm_coord = floor(gl_FragCoord.xy);\n    dm_coord = fract(dm_coord * 0.5);\n    if (totalOpacity < 1.0 && (dm_coord.x < 0.5 ^^ dm_coord.y < 0.5)) discard;\n    vec4 diffuseColor = vec4(diffuse, 1.0);\n  #else\n    vec4 diffuseColor = vec4(diffuse, totalOpacity);\n  #endif\n\n  float flipNormal;\n  #if !defined (SPHERE_SPRITE) && !defined (CYLINDER_SPRITE)\n    flipNormal = 1.0;\n    #ifdef DOUBLE_SIDED\n      flipNormal = float( gl_FrontFacing );\n    #endif\n    vec3 normal = normalize( vNormal ) * flipNormal;\n  #endif\n\n    diffuseColor.rgb *= vertexColor;\n\n  #if defined(SPHERE_SPRITE) || defined(CYLINDER_SPRITE)\n    gl_FragDepthEXT = calcDepthForSprites(pixelPosEye, zOffset, projectionMatrix);\n  #endif\n\n  #ifdef NORMALS_TO_G_BUFFER\n    #if defined (SPHERE_SPRITE) || defined (CYLINDER_SPRITE)\n      vec3 viewNormaInColor = viewNormalSprites;\n    #else\n      vec3 viewNormaInColor = viewNormal;\n      float frontFaced = float( gl_FrontFacing );\n    #endif\n    // [-1, 1] -> [0, 1]\n    viewNormaInColor = 0.5 * viewNormaInColor + 0.5;\n    gl_FragData[1] = vec4(viewNormaInColor, frontFaced);\n  #endif\n\n  #if defined(USE_LIGHTS) && NUM_DIR_LIGHTS > 0\n    vec3 viewDir;\n    #if defined(SPHERE_SPRITE) || defined(CYLINDER_SPRITE)\n      viewDir = -pixelPosEye.xyz;\n    #else\n      viewDir = vViewPosition;\n    #endif\n    GeometricContext geometry = GeometricContext(normal, normalize( viewDir ));\n    BlinnPhongMaterial material = BlinnPhongMaterial(diffuseColor.rgb, specular, shininess);\n    vec3 outgoingLight = calcLighting(geometry, material, viewDir);\n  #else\n    vec3 outgoingLight = diffuseColor.rgb;\n  #endif\n\n  #ifdef COLOR_FROM_DEPTH\n    float depth = 0.0;\n    #if defined(SPHERE_SPRITE) || defined(CYLINDER_SPRITE)\n      gl_FragDepthEXT = calcDepthForSprites(pixelPosEye, zOffset, projectionMatrix);\n      depth = gl_FragDepthEXT;\n    #else\n      depth = gl_FragCoord.z;\n    #endif\n    fragColor = packDepthToRGBA(depth);\n    return;\n  #endif\n\n  #ifdef COLOR_FROM_POS\n    fragColor = world2colorMatrix * pixelPosWorld;\n  #else\n    #ifdef OVERRIDE_COLOR\n      fragColor = vec4(fixedColor, diffuseColor.a);\n    #else\n      fragColor = vec4(outgoingLight, diffuseColor.a);//vec4(vNormal, 1.0);\n    #endif\n\n    #ifdef USE_FOG\n      float viewDistance;\n      #if defined(SPHERE_SPRITE) || defined(CYLINDER_SPRITE)\n        viewDistance = abs(pixelPosEye.z);\n      #else\n        viewDistance = vViewPosition.z;\n      #endif\n      float fogFactor = smoothstep( fogNear, fogFar, viewDistance) * fogAlpha;\n      #ifdef FOG_TRANSPARENT\n        fragColor.a = fragColor.a * (1.0 - fogFactor);\n      #else\n        fragColor.rgb = mix( fragColor.rgb, fogColor, fogFactor );\n      #endif\n    #endif\n\n  #endif\n}\n",Fi={precision:"mediump",init:function(e){this.precision=e.capabilities.getMaxPrecision("highp")}},Bi=new Uint8Array([24,52,0,254,145,0,122,0,0,7,170,0,34,214,0,173,8,0,86,249,0,160,4,0,226,46,0,224,211,0,3,157,0,174,247,0,12,182,0,220,216,0,1,109,0,253,154,0]),Ui=ae.RepeatWrapping,Gi=ae.RepeatWrapping,ji=ae.NearestFilter,Hi=ae.NearestFilter,Wi=ae.UVMapping,Yi=new ae.DataTexture(Bi,4,4,ae.RGBFormat,ae.UnsignedByteType,Wi,Ui,Gi,Hi,ji,1);Yi.needsUpdate=!0;var Xi={noiseWidth:4,noiseHeight:4,noiseTexture:Yi};function qi(t,e){var n,r=Object.keys(t);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(t),e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,n)),r}var $i=[new ae.Vector2(-.541978,.840393),new ae.Vector2(.125533,-.992089),new ae.Vector2(.374329,.927296),new ae.Vector2(-.105475,.994422)],Zi=ae.UniformsUtils.merge([ae.UniformsLib.fog,ae.UniformsLib.lights,{diffuse:{value:new ae.Color(15658734)},opacity:{value:1},specular:{type:"c",value:new ae.Color(1118481)},shininess:{type:"f",value:30},fixedColor:{type:"c",value:new ae.Color(16777215)},zOffset:{type:"f",value:0},zClipValue:{type:"f",value:0},clipPlaneValue:{type:"f",value:0},nearPlaneValue:{type:"f",value:-.5},invModelViewMatrix:{type:"4fv",value:new ae.Matrix4},world2colorMatrix:{type:"4fv",value:new ae.Matrix4},dashedLineSize:{type:"f",value:.1},dashedLinePeriod:{type:"f",value:.2},projMatrixInv:{type:"4fv",value:new ae.Matrix4},viewport:{type:"v2",value:new ae.Vector2},lineWidth:{type:"f",value:2},fogAlpha:{type:"f",value:1},samplesKernel:{type:"v2v",value:null},noiseTex:{type:"t",value:null},noiseTexelSize:{type:"v2",value:null},srcTexelSize:{type:"v2",value:null}}]),Ki=["shininess","opacity","zOffset","diffuse","specular","fixedColor","zClipCoef","zClipValue","clipPlaneValue","world2colorMatrix","dashedLineSize","dashedLinePeriod","projMatrixInv","viewport","lineWidth","fogAlpha","samplesKernel","noiseTex","noiseTexelSize","srcTexelSize"];function Qi(e){ae.RawShaderMaterial.call(this),this.fog=!0,this.instancedPos=!1,this.instancedMatrix=!1,this.attrColor=!1,this.attrColor2=!1,this.attrAlphaColor=!1,this.overrideColor=!1,this.sphereSprite=!1,this.cylinderSprite=!1,this.zClip=!1,this.clipPlane=!1,this.fakeOpacity=!1,this.prepassTransparancy=!1,this.colorFromPos=!1,this.shadowmap=!1,this.shadowmapType="random",this.colorFromDepth=!1,this.orthoCam=!1,this.dashedLine=!1,this.transparent=!0,this.thickLine=!1,this.fogTransparent=!1,this.normalsToGBuffer=!1,this.toonShading=!1,this.uberOptions=Object.create(Qi.prototype.uberOptions),ae.RawShaderMaterial.prototype.setValues.call(this,{uniforms:ae.UniformsUtils.clone(Zi),vertexShader:this.precisionString()+Vi,fragmentShader:this.precisionString()+zi,lights:!0,fog:!0,side:ae.DoubleSide}),this.setValues(e)}function Ji(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}function eo(e){return function(){A(o,e);var i=Ji(o);function o(){var e;j(this,o);for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return(e=i.call.apply(i,[this].concat(n))).onBeforeRender=o.prototype.onBeforeRender,e}return _(o,[{key:"onBeforeRender",value:function(e,t,n,r,i,o){this._onBeforeRender(e,t,n,r,i,o),this._update()}},{key:"_onBeforeRender",value:function(){}},{key:"_update",value:function(){var e=this.material;e&&e instanceof Qi&&e.updateUniforms()}}]),o}()}function to(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}((Qi.prototype=Object.create(ae.RawShaderMaterial.prototype)).constructor=Qi).prototype.precisionString=function(){var e=Fi.precision;return"precision ".concat(e," float;\n")+"precision ".concat(e," int;\n\n")},Qi.prototype.uberOptions={diffuse:new ae.Color(16777215),specular:new ae.Color(1118481),shininess:30,opacity:1,fixedColor:new ae.Color(16777215),zOffset:0,zClipCoef:2,zClipValue:0,clipPlaneValue:0,world2colorMatrix:new ae.Matrix4,dashedLineSize:.1,dashedLinePeriod:.3,projMatrixInv:new ae.Matrix4,viewport:new ae.Vector2(800,600),lineWidth:2,fogAlpha:1,samplesKernel:$i,noiseTex:Xi.noiseTexture,noiseTexelSize:new ae.Vector2(1/Xi.noiseWidth,1/Xi.noiseHeight),srcTexelSize:new ae.Vector2(1/800,1/600),copy:function(e){this.diffuse.copy(e.diffuse),this.specular.copy(e.specular),this.shininess=e.shininess,this.opacity=e.opacity,this.fixedColor.copy(e.fixedColor),this.zOffset=e.zOffset,this.zClipCoef=e.zClipCoef,this.zClipValue=e.zClipValue,this.clipPlaneValue=e.clipPlaneValue,this.world2colorMatrix.copy(e.world2colorMatrix),this.dashedLineSize=e.dashedLineSize,this.dashedLinePeriod=e.dashedLinePeriod,this.projMatrixInv=e.projMatrixInv,this.viewport=e.viewport,this.lineWidth=e.lineWidth,this.toonShading=e.toonShading,this.fogAlpha=e.fogAlpha,this.samplesKernel=e.samplesKernel,this.noiseTex=e.noiseTex,this.noiseTexelSize=e.noiseTexelSize,this.srcTexelSize=e.srcTexelSize}},Qi.prototype.copy=function(e){return ae.RawShaderMaterial.prototype.copy.call(this,e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=ae.UniformsUtils.clone(e.uniforms),this.defines=function(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?qi(Object(n),!0).forEach(function(e){ke(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):qi(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}({},e.defines),this.extensions=e.extensions,this.fog=e.fog,this.instancedPos=e.instancedPos,this.instancedMatrix=e.instancedMatrix,this.attrColor=e.attrColor,this.attrColor2=e.attrColor2,this.attrAlphaColor=e.attrAlphaColor,this.overrideColor=e.overrideColor,this.sphereSprite=e.sphereSprite,this.cylinderSprite=e.cylinderSprite,this.zClip=e.zClip,this.clipPlane=e.clipPlane,this.fakeOpacity=e.fakeOpacity,this.colorFromPos=e.colorFromPos,this.shadowmap=e.shadowmap,this.shadowmapType=e.shadowmapType,this.colorFromDepth=e.colorFromDepth,this.orthoCam=e.orthoCam,this.prepassTransparancy=e.prepassTransparancy,this.dashedLine=e.dashedLine,this.thickLine=e.thickLine,this.fogTransparent=e.fogTransparent,this.normalsToGBuffer=e.normalsToGBuffer,this.toonShading=e.toonShading,this.uberOptions.copy(e.uberOptions),this},Qi.prototype.createInstance=function(){var e=new Qi;return e.copy(this),e.uberOptions=Object.create(this.uberOptions),e},Qi.prototype.setValues=function(e){var t;void 0!==e&&(ae.RawShaderMaterial.prototype.setValues.call(this,e),t={},e={},this.fog&&(t.USE_FOG=1),this.instancedPos&&(t.INSTANCED_POS=1),this.instancedMatrix&&(t.INSTANCED_MATRIX=1),this.attrColor&&(t.ATTR_COLOR=1),this.attrColor2&&(t.ATTR_COLOR2=1),this.attrAlphaColor&&(t.ATTR_ALPHA_COLOR=1),this.overrideColor&&(t.OVERRIDE_COLOR=1),this.sphereSprite&&(t.SPHERE_SPRITE=1,e.fragDepth=1),this.cylinderSprite&&(t.CYLINDER_SPRITE=1,e.fragDepth=1),this.zClip&&(t.ZCLIP=1),this.clipPlane&&(t.CLIP_PLANE=1),this.fakeOpacity&&(t.FAKE_OPACITY=1),this.lights&&(t.USE_LIGHTS=1),this.colorFromPos&&(t.COLOR_FROM_POS=1),this.shadowmap&&(t.SHADOWMAP=1,"pcf"===this.shadowmapType?t.SHADOWMAP_PCF_SHARP=1:"random"===this.shadowmapType?t.SHADOWMAP_PCF_RAND=1:t.SHADOWMAP_BASIC=1),this.colorFromDepth&&(t.COLOR_FROM_DEPTH=1),this.orthoCam&&(t.ORTHOGRAPHIC_CAMERA=1),this.prepassTransparancy&&(t.PREPASS_TRANSP=1),this.dashedLine&&(t.DASHED_LINE=1),this.thickLine&&(t.THICK_LINE=1),this.fogTransparent&&(t.FOG_TRANSPARENT=1),this.normalsToGBuffer&&(e.drawBuffers=1,t.NORMALS_TO_G_BUFFER=1),this.toonShading&&(t.TOON_SHADING=1),this.defines=t,this.extensions=e)},Qi.prototype.setUberOptions=function(e){if(void 0!==e)for(var t in e)e.hasOwnProperty(t)&&(this.uberOptions[t]instanceof ae.Color?this.uberOptions[t]=e[t].clone():this.uberOptions[t]=e[t])},Qi.prototype.clone=function(e){return e?this.createInstance():ae.Material.prototype.clone.call(this)},Qi.prototype.updateUniforms=function(){var t=this;Ki.forEach(function(e){t.uniforms.hasOwnProperty(e)&&(t.uberOptions[e]instanceof ae.Color||t.uberOptions[e]instanceof ae.Matrix4?t.uniforms[e].value=t.uberOptions[e].clone():t.uniforms[e].value=t.uberOptions[e])})};var no=eo(ae.Mesh),ro=function(){A(o,no);var i=to(o);function o(){var e;j(this,o);for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return(e=i.call.apply(i,[this].concat(n))).castShadow=!0,e.receiveShadow=!0,e}return _(o,[{key:"_onBeforeRender",value:function(e,t,n){no.prototype._onBeforeRender.call(this,e,t,n);t=this.material;t&&t.uniforms.invModelViewMatrix&&(this.modelViewMatrix.multiplyMatrices(n.matrixWorldInverse,this.matrixWorld),t.uniforms.invModelViewMatrix.value.copy(this.modelViewMatrix).invert(),t.uniforms.nearPlaneValue.value=n.near,t.uniformsNeedUpdate=!0)}}]),o}();function io(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var oo=eo(ae.Mesh),so=function(){A(s,oo);var n=io(s);function s(e,t){return j(this,s),(t=n.call(this,e,t)).castShadow=!0,t.receiveShadow=!0,t}return _(s,[{key:"_onBeforeRender",value:function(e,t,n){oo.prototype._onBeforeRender.call(this,e,t,n);var r,i=this.geometry,o=this.material;i.zClip&&o.uberOptions&&(r=s._mvLength,e=s._center,(t=s._modelView).multiplyMatrices(this.matrixWorld,n.matrixWorldInverse),t=r.setFromMatrixColumn(t,0).length(),e.copy(i.boundingSphere.center),this.localToWorld(e),o.uberOptions.zClipValue=n.position.z-e.z-t*(.5*i.boundingSphere.radius))}}]),s}();function ao(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}ke(so,"_mvLength",new ae.Vector3),ke(so,"_center",new ae.Vector3),ke(so,"_modelView",new ae.Matrix4);var co=function(e){A(o,e);var i=ao(o);function o(e,t){var n;j(this,o),(n=i.call(this)).geometry=e;var r=k(n);return r.initialized=!1,n.geometry.addEventListener("update",function(){r.update()}),n}return _(o,[{key:"init",value:function(){for(var e=this.children,t=e.length-1;0<=t;--t)this.remove(e[t]);for(var n=this.geometry,r=n.items,i=n.userData,o=0,s=r.length;o<s;++o){var a,c=r[o];c&&(a=ce.shallowCloneNode(c),(a=new Rn(a)).userData=b.default.clone(i),a.getElement().style.visibility="visible",a.source=c,this.add(a))}this.initialized=!0}},{key:"update",value:function(){if(this.geometry.needsUpdate){var e=this.children;this.initialized||this.init();for(var t=0,n=e.length;t<n;++t){var r=e[t],i=r.source;r.position.copy(i.worldPos),r.userData.color=i.opts.color,r.userData.background=i.opts.background}}}}]),o}(ae.Group);function lo(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var uo=eo(ae.Mesh),ho=function(){A(r,uo);var n=lo(r);function r(e,t){return j(this,r),(t=n.call(this,e,t)).castShadow=!0,t.receiveShadow=!0,t}return r}();function fo(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var po=eo(ae.Mesh),mo=new ae.Vector2,yo=function(){A(t,po);var e=fo(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"_onBeforeRender",value:function(e,t,n){var r=this.material;r.uberOptions&&(r.uberOptions.projMatrixInv.copy(n.projectionMatrix).invert(),e.getSize(mo),r.uberOptions.viewport.set(mo.width,mo.height))}}]),t}();function _o(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var vo=eo(ae.Mesh),go=function(){A(o,vo);var i=_o(o);function o(){var e;j(this,o);for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return(e=i.call.apply(i,[this].concat(n))).castShadow=!0,e.receiveShadow=!0,e}return o}(),xo={ZClipped:so,ZSprite:ro,Text:co,Line:eo(ae.Line),LineSegments:eo(ae.LineSegments),Mesh:ho,ThickLineMesh:yo,Instanced:go};function bo(t,n){return function(e){e.setValues(t),e.setUberOptions(n)}}function wo(n,r){return{Geometry:function(e,t){return new Oi.Instanced2CCylindersGeometry(e,t,n,r)},Object:n?xo.ZSprite:xo.Instanced,initMaterial:bo({instancedMatrix:!0,attrColor:!0,attrColor2:!0,attrAlphaColor:!0,cylinderSprite:n})}}function So(e,t){var n=e.prototype instanceof Hr,t=t.lineWidth||0;return{Geometry:e,Object:n?xo.ThickLineMesh:xo.LineSegments,initMaterial:bo({lights:!1,attrColor:!0,attrAlphaColor:!0,thickLine:n},{lineWidth:t})}}function Ro(e,t,n,r){r={wireframe:!!r.wireframe,fakeOpacity:n.now.isoSurfaceFakeOpacity,zClip:r.zClip};return{Geometry:e,Object:xo.ZClipped,initMaterial:bo({attrColor:!0,attrAlphaColor:!1,wireframe:r.wireframe,fakeOpacity:r.fakeOpacity,zClip:r.zClip})}}var Co=function(){function e(){j(this,e)}return _(e,null,[{key:"createSpheres",value:function(e,t){var n=t.now.zSprites;return{Geometry:function(e,t){return new Oi.InstancedSpheresGeometry(e,t,n)},Object:n?xo.ZSprite:xo.Instanced,initMaterial:bo({instancedPos:!0,attrColor:!0,attrAlphaColor:!0,sphereSprite:n})}}},{key:"create2CClosedCylinders",value:function(){return wo(!1,!1)}},{key:"create2CCylinders",value:function(e,t){return wo(t.now.zSprites,!0)}},{key:"create2CLines",value:function(e,t,n){return So(Oi.TwoColorLinesGeometry,n)}},{key:"createCrosses",value:function(e,t,n){return So(Oi.CrossGeometry,n)}},{key:"createExtrudedChains",value:function(){return{Geometry:Oi.ExtrudedObjectsGeometry,Object:xo.Mesh,initMaterial:bo({attrColor:!0,attrAlphaColor:!0})}}},{key:"createChunkedLines",value:function(e,t,n){return So(Oi.ChunkedLinesGeometry,n)}},{key:"createQuickSurface",value:function(e,t,n){return Ro(Oi.QuickSurfGeometry,0,t,n)}},{key:"createContactSurface",value:function(e,t,n){return Ro(Oi.ContactSurfaceGeometry,0,t,n)}},{key:"createSASSES",value:function(e,t,n){return Ro(Oi.SSIsosurfaceGeometry,0,t,n)}},{key:"createLabels",value:function(){return{Geometry:Oi.LabelsGeometry,Object:xo.Text,initMaterial:function(){}}}}]),e}();function Ao(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var Eo=function(e){A(d,e);var c=Ao(d);function d(e,t,n,r){var i;j(this,d),(i=c.call(this))._geometry=e,i._geoParams=t;n=n.createInstance();t.initMaterial(n),i._material=n,i._transforms=0<r.length?r:[new ae.Matrix4];for(var o=i._createMeshes(e),s=0,a=o.length;s<a;++s)i.add(o[s]);return i}return _(d,[{key:"raycast",value:function(e,t){var n=d._ray,r=d._inverseMatrix,i=this.children;n.copy(e.ray);for(var o=0,s=i.length;o<s;++o){var a=i[o];if(Fn.belongToSelectLayers(a)){a.updateMatrixWorld();var c=a.matrixWorld;r.copy(c).invert(),e.ray.copy(n).applyMatrix4(r);var l=[];this._geometry.raycast(e,l);for(var u=0,h=l.length;u<h;++u){var f=l[u];f.point&&(f.point.applyMatrix4(c),f.distance=n.origin.distanceTo(f.point)),f.object=a,t[t.length]=f}}}e.ray.copy(n)}},{key:"getSubset",value:function(e){for(var t=this._geometry.getSubset(e),n=[],r=0,i=0,o=t.length;i<o;++i)for(var s=this._createMeshes(t[i]),a=0,c=s.length;a<c;++a)n[r++]=s[a];return n}},{key:"_createMeshes",value:function(e){for(var t=this._transforms,n=this._geoParams.Object,r=this._material,i=[],o=0,s=t.length;o<s;++o){var a=new n(e,r);a.applyMatrix4(t[o]),i[o]=a}return i}}]),d}(ae.Object3D);function ko(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}ke(Eo,"_inverseMatrix",new ae.Matrix4),ke(Eo,"_ray",new ae.Ray);var To=function(){A(l,An);var c=ko(l);function l(e,t,n,r,i,o,s){var a;if(j(this,l),(a=c.call(this)).constructor===l)throw new Error("Can not instantiate abstract class!");return a._selection=t,a._mode=r,a._colorer=n,a._chunksIdc=t.chunks,a._polyComplexity=o,a._geo=(t=e.Geometry,o=a._makeGeoArgs(),o=[t].concat(o),new(t.bind.apply(t,Yn(o)))),a._mesh=new Eo(a._geo,e,s,i),a.add(a._mesh),a._build(),a}return _(l,[{key:"_makeGeoArgs",value:function(){throw new Error("ChemGroup subclass must override _makeGeoArgs() method")}},{key:"getSubset",value:function(e,t){t=void 0!==t&&t;t=this._calcChunksList(e,t);return 0===t.length?[]:this._mesh.getSubset(t)}},{key:"_changeSubsetOpacity",value:function(e,t,n){n=this._calcChunksList(e,n);0!==n.length&&this._geo.setOpacity(n,t)}},{key:"enableSubset",value:function(e,t){t=void 0===t||t,this._changeSubsetOpacity(e,1,t)}},{key:"disableSubset",value:function(e,t){t=void 0===t||t,this._changeSubsetOpacity(e,0,t)}}]),l}();function Po(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var Mo=function(){A(t,To);var e=Po(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"raycast",value:function(e,t){var n=this._selection.atoms,r=[];this._mesh.raycast(e,r);for(var i,o=this._chunksIdc,s=0,a=r.length;s<a;++s)r[s].hasOwnProperty("chunkIdx")&&((i=o[r[s].chunkIdx])<n.length&&(r[s].atom=n[i],t.push(r[s])))}},{key:"_calcChunksList",value:function(e){for(var t=[],n=this._selection.atoms,r=this._chunksIdc,i=0,o=r.length;i<o;++i)0!=(n[r[i]].mask&e)&&t.push(i);return t}}]),t}();function No(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var Io=function(){A(t,Mo);var e=No(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"_makeGeoArgs",value:function(){return[this._selection.chunks.length,this._polyComplexity]}},{key:"_build",value:function(){for(var e=this._selection.chunks,t=this._selection,n=t.atoms,r=t.parent,i=this._mode,o=this._colorer,s=this._geo,a=0,c=e.length;a<c;++a){var l=n[e[a]];s.setItem(a,l.position,i.calcAtomRadius(l)),s.setColor(a,o.getAtomColor(l,r))}s.finalize()}},{key:"updateToFrame",value:function(e){for(var t=this._selection.chunks,n=this._selection.atoms,r=this._mode,i=this._colorer,o=e.needsColorUpdate(i),s=this._geo,a=0,c=t.length;a<c;++a){var l=n[t[a]];s.setItem(a,e.getAtomPos(t[a]),r.calcAtomRadius(l)),o&&s.setColor(a,e.getAtomColor(i,l))}s.finalize()}}]),t}();function Lo(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var Do=function(){A(t,Io);var e=Lo(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"_makeGeoArgs",value:function(){for(var e=[],t=this._selection,n=t.atoms,r=t.chunks,i=r.length,o=0;o<i;++o)e[o]=n[r[o]];t=this._mode.getSurfaceOpts();return t.atoms=e,[i,t]}}]),t}();function Oo(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var Vo=function(){A(t,Io);var e=Oo(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"_makeGeoArgs",value:function(){for(var e=[],t=this._selection,n=t.atoms,r=t.chunks,i=r.length,o=0;o<i;++o)e[o]=n[r[o]];t=this._mode.getSurfaceOpts();return t.atoms=e,t.selection=this._selection,t.colorMode=this._colorer,[i,t]}}]),t}();function zo(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}function Fo(e){return null!==e.name.getNode()?e.name.getNode():e.getVisualName()}var Bo={none:function(e){return e},adjust:function(e){var t=e>>16&255,n=e>>8&255,e=127<.2126*t+.7152*n+.0722*(e=255&e)?(t=3*t/10,n=3*n/10,3*e/10):(t=255-3*(255-t)/10,n=255-3*(255-n)/10,255-3*(255-e)/10);return t<<16|n<<8|e},inverse:function(e){return 255-(e>>16&255)<<16|255-(e>>8&255)<<8|255-(255&e)}};function Uo(e,t){return Bo.hasOwnProperty(t)?ce.hexColor(Bo[t](e)):(e=parseInt(t,16),!Number.isNaN(e)&&t.toLowerCase().startsWith("0x")?ce.hexColor(e):"#000000")}function Go(t,e){return e.replace(/\{\{(\s*\w+\s*)\}\}/g,function(e){e=(e=e.replace(/\s+/g,"")).substring(2,e.length-2).toLowerCase();return jo.hasOwnProperty(e)?jo[e](t):"null"})}var jo={serial:function(e){return e.serial},name:function(e){return e.getVisualName()},elem:function(e){return e.element.name},residue:function(e){return e.residue.getType().getName()},sequence:function(e){return e.residue.getSequence()},chain:function(e){return e.residue.getChain().getName()},hetatm:function(e){return e.isHet()},water:function(e){return"HOH"===e.residue.getType().getName()||"WAT"===e.residue.getType().getName()}},Ho=function(){A(t,Mo);var e=zo(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"_makeGeoArgs",value:function(){var e=this._mode.getLabelOpts();return[this._selection.chunks.length,e]}},{key:"_build",value:function(){for(var e=this._mode.getLabelOpts(),t=this._selection.chunks,n=this._selection,r=n.atoms,i=n.parent,o=this._colorer,s=this._geo,a=0,c=t.length;a<c;++a){var l,u,h=r[t[a]],f=e.template?Go(h,e.template):Fo(h);f&&(u=o.getAtomColor(h,i),l=parseInt(Uo(u,e.fg).substring(1),16),u=e.showBg?parseInt(Uo(u,e.bg).substring(1),16):"transparent",s.setItem(a,h.position,f),s.setColor(a,l,u))}s.finalize()}},{key:"updateToFrame",value:function(e){for(var t=this._mode.getLabelOpts(),n=this._selection.chunks,r=this._selection.atoms,i=this._colorer,o=this._geo,s=e.needsColorUpdate(i),a=0,c=n.length;a<c;++a){var l,u=r[n[a]],h=t.template?Go(u,t.template):Fo(u);h&&(l=e.getAtomColor(i,u),u=parseInt(Uo(l,t.fg).substring(1),16),l=t.showBg?parseInt(Uo(l,t.bg).substring(1),16):"transparent",o.setItem(a,e.getAtomPos(n[a]),h),s&&o.setColor(a,u,l))}o.finalize()}}]),t}();function Wo(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}function Yo(e,t,n,r){var i=Math.sin(e);return t.clone().multiplyScalar(Math.sin((1-r)*e)/i).addScaledVector(n,Math.sin(r*e)/i)}var Xo=function(){A(t,Mo);var e=Wo(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"_buildInner",value:function(e,t){for(var n=this._selection.chunks,r=new ae.Vector3,i=new ae.Vector3,o=this._segmentsHeight,s=1/o,a=this._colorer,c=this._selection,l=c.cycles,u=c.parent,h=0,f=n[h],d=0,p=l.length;d<p;++d){var m=l[d],y=m.atoms,_=[],v=[],g=m.center,x=m.radius-e,b=y.length,w=0,m=y[b-1].position,S=y[w].position;r.subVectors(m,g),i.subVectors(S,g);for(var R=i.clone().cross(r).normalize();w<b;++w){var C=r.angleTo(i);v[w]=Yo(C,r,i,.5).normalize(),S=y[(w+1)%b].position,r.copy(i),i.subVectors(S,g)}for(w=0;w<b;++w)if(y[w].index===f){for(var A=v[w],E=v[(w+1)%b],k=a.getAtomColor(y[w],u),T=A.angleTo(E),P=0;P<=o;++P)_[P]=Yo(T,A,E,P*s).multiplyScalar(x).add(g);t(h++,k,_,g,R),f=n[h]}}}}]),t}();function qo(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var $o=Fn.calcChunkMatrix,Zo=function(){A(t,Xo);var e=qo(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"_build",value:function(){var c=this._segmentsHeight,e=this._mode.getAromRadius(),l=new ae.Vector2(e,e),e=this._mode.calcStickRadius()+2*e,u=new ae.Vector3,h=[],f=this._geo;this._buildInner(e,function(e,t,n,r,i){for(var o=0;o<=c;++o){var s=n[o],a=s.clone().sub(r).cross(i);u.addVectors(s,a),h[o]=$o(s,u,i,l)}f.setItem(e,h),f.setColor(e,t)}),f.finalize()}},{key:"_makeGeoArgs",value:function(){return this._segmentsHeight=this._polyComplexity,[function(e,t){for(var n=[],r=0;r<t;++r){var i=-2*r/t*Math.PI;n.push(new ae.Vector3(Math.cos(i)*e,Math.sin(i)*e,0))}return n}(1,this._polyComplexity),this._segmentsHeight+1,this._selection.chunks.length]}}]),t}();function Ko(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var Qo=function(){A(t,Xo);var e=Ko(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"_build",value:function(){var s=this,a=this._geo,e=this._mode.getAromaticOffset();this._buildInner(e,function(e,t,n){for(var r=n[0],i=1;i<=s._segmentsHeight;++i){var o=n[i];a.setSegment(e,i-1,r,o),r=o}a.setColor(e,t)}),a.finalize()}},{key:"_makeGeoArgs",value:function(){return this._segmentsHeight=this._mode.getAromaticArcChunks(),[this._selection.chunks.length,this._segmentsHeight,!0]}}]),t}();function Jo(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var es=function(){A(t,To);var e=Jo(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"raycast",value:function(e,t){var n=this._selection.residues,r=[];this._mesh.raycast(e,r);for(var i,o=this._chunksIdc,s=0,a=r.length;s<a;++s)r[s].hasOwnProperty("chunkIdx")&&((i=o[r[s].chunkIdx])<n.length&&(r[s].residue=n[i],t.push(r[s])))}},{key:"_calcChunksList",value:function(e){for(var t=[],n=this._selection.residues,r=this._chunksIdc,i=0,o=r.length;i<o;++i)0!=(n[r[i]]._mask&e)&&t.push(i);return t}}]),t}();function ts(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var ns=function(){A(t,es);var e=ts(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"raycast",value:function(e,t){var n=this._selection.residues,r=[];this._mesh.raycast(e,r);for(var i,o=this._chunksIdc,s=0,a=r.length;s<a;++s)r[s].hasOwnProperty("chunkIdx")&&((i=o[Math.floor(r[s].chunkIdx/2)])<n.length&&(r[s].residue=n[i],t.push(r[s])))}},{key:"_build",value:function(){for(var e=this._selection,t=e.residues,n=e.parent,r=this._colorer,e=this._geo,i=this._mode.calcStickRadius(),o=0,s=this._selection.chunks,a=0,c=s.length;a<c;++a){var l=t[s[a]],u=r.getResidueColor(l,n);this._processItem(o++,l._cylinders[0],l._cylinders[1],i,u)}e.finalize()}},{key:"_calcChunksList",value:function(e){for(var t=[],n=0,r=this._selection.residues,i=this._chunksIdc,o=0,s=i.length;o<s;++o)0!=(r[i[o]]._mask&e)&&(t[n++]=2*o,t[n++]=2*o+1);return t}},{key:"updateToFrame",value:function(e){for(var t=e.getResidues(),n=this._selection.parent,r=this._colorer,e=this._geo,i=this._mode.calcStickRadius(),o=0,s=this._selection.chunks,a=0,c=s.length;a<c;++a){var l=t[s[a]],u=r.getResidueColor(l,n);this._processItem(o++,l._cylinders[0],l._cylinders[1],i,u)}e.finishUpdate()}}]),t}();function rs(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var is=function(){A(t,ns);var e=rs(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"_makeGeoArgs",value:function(){return[this._selection.chunks.length,this._polyComplexity]}},{key:"_processItem",value:function(e,t,n,r,i){var o=this._geo;o.setItem(e,t,n,r),o.setColor(e,i,i)}}]),t}();function os(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var ss=function(){A(t,ns);var e=os(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"_makeGeoArgs",value:function(){return[2*this._selection.chunks.length,this._polyComplexity]}},{key:"_processItem",value:function(e,t,n,r,i){var o=this._geo,e=2*e;o.setItem(e,t,r),o.setColor(e,i),e++,o.setItem(e,n,r),o.setColor(e,i)}}]),t}(),as=R(function(e,I){
/*
  Smooth.js version 0.1.7

  Turn arrays into smooth functions.

  Copyright 2012 Spencer Cohen
  Licensed under MIT license (see "Smooth.js MIT license.txt")
  */
(function(){function e(e,t){for(var n in t)E.call(t,n)&&(e[n]=t[n]);function r(){this.constructor=e}return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e}var t,r,n,p,m,i,y,_,o,s,a,v,g,x,c,l,b,w,u,S,R,h,f,d,C,A,E=Object.prototype.hasOwnProperty;function k(e,t){if(this.array=e.slice(0),this.length=this.array.length,!(this.clipHelper={clamp:this.clipHelperClamp,zero:this.clipHelperZero,periodic:this.clipHelperPeriodic,mirror:this.clipHelperMirror}[t.clip]))throw"Invalid clip: "+t.clip}function T(){T.__super__.constructor.apply(this,arguments)}function P(){P.__super__.constructor.apply(this,arguments)}function M(e,t){this.tangentFactor=1-Math.max(-1,Math.min(1,t.cubicTension)),M.__super__.constructor.apply(this,arguments)}function N(e,t){if(N.__super__.constructor.apply(this,arguments),this.a=t.sincFilterSize,!t.sincWindow)throw"No sincWindow provided";this.kernel=u(t.sincWindow)}for(l in v={method:(n={METHOD_NEAREST:"nearest",METHOD_LINEAR:"linear",METHOD_CUBIC:"cubic",METHOD_LANCZOS:"lanczos",METHOD_SINC:"sinc",CLIP_CLAMP:"clamp",CLIP_ZERO:"zero",CLIP_PERIODIC:"periodic",CLIP_MIRROR:"mirror",CUBIC_TENSION_DEFAULT:0,CUBIC_TENSION_CATMULL_ROM:0}).METHOD_CUBIC,cubicTension:n.CUBIC_TENSION_DEFAULT,clip:n.CLIP_CLAMP,scaleTo:0,sincFilterSize:2,sincWindow:void 0},o=function(e,t){return Math.max(0,Math.min(e,t-1))},a=function(e,t){return(e%=t)<0&&(e+=t),e},s=function(e,t){var n=2*(t-1);return t-1<(e=a(e,n))&&(e=n-e),e},k.prototype.getClippedInput=function(e){return 0<=e&&e<this.length?this.array[e]:this.clipHelper(e)},k.prototype.clipHelperClamp=function(e){return this.array[o(e,this.length)]},k.prototype.clipHelperZero=function(e){return 0},k.prototype.clipHelperPeriodic=function(e){return this.array[a(e,this.length)]},k.prototype.clipHelperMirror=function(e){return this.array[s(e,this.length)]},k.prototype.interpolate=function(e){throw"Subclasses of AbstractInterpolator must override the interpolate() method."},e(T,t=k),T.prototype.interpolate=function(e){return this.getClippedInput(Math.round(e))},m=T,e(P,t),P.prototype.interpolate=function(e){var t=Math.floor(e);return(1-(e-=t))*this.getClippedInput(t)+e*this.getClippedInput(t+1)},p=P,e(M,t),M.prototype.getTangent=function(e){return this.tangentFactor*(this.getClippedInput(e+1)-this.getClippedInput(e-1))/2},M.prototype.interpolate=function(e){var t,n=Math.floor(e),r=[this.getTangent(n),this.getTangent(n+1)],i=[this.getClippedInput(n),this.getClippedInput(n+1)];return(2*(n=(e-=n)*(t=e*e))-3*t+1)*i[0]+(n-2*t+e)*r[0]+(-2*n+3*t)*i[1]+(n-t)*r[1]},r=M,h=Math.sin,i=Math.PI,f=function(e){return 0===e?1:h(i*e)/(i*e)},b=function(t){return function(e){return f(e/t)}},u=function(t){return function(e){return f(e)*t(e)}},e(N,t),N.prototype.interpolate=function(e){for(var t,n=Math.floor(e),r=0,i=t=n-this.a+1,o=n+this.a;t<=o?i<=o:o<=i;t<=o?i++:i--)r+=this.kernel(e-i)*this.getClippedInput(i);return r},y=N,g=function(e,t){for(var n,r=[],i=0,o=e.length;i<o;i++)n=e[i],r.push(n[t]);return r},w=function(t,e,n){var r,i;return"0,1"===n.join?t:(r=e/(n[1]-n[0]),i=n[0],function(e){return t(r*(e-i))})},x=function(e){return Object.prototype.toString.call(e).slice("[object ".length,-1)},C=function(e){if(isNaN(e))throw"NaN in Smooth() input";if("Number"!==x(e))throw"Non-number in Smooth() input";if(!isFinite(e))throw"Infinity in Smooth() input"},A=function(e,t){var n,r,i;if("Array"!==x(e))throw"Non-vector in Smooth() input";if(e.length!==t)throw"Inconsistent dimension in Smooth() input";for(r=0,i=e.length;r<i;r++)n=e[r],C(n)},c=function(e){return"Number"===x(e)&&isFinite(e)&&!isNaN(e)},S=function(e){var t="scaleTo param must be number or array of two numbers";switch(x(e)){case"Number":if(!c(e))throw t;e=[0,e];break;case"Array":if(2!==e.length)throw t;if(!c(e[0])||!c(e[1]))throw t;break;default:throw t}return e},R=function(e){var t,n,r={};for(t in e)E.call(e,t)&&(n=e[t],r[t]=n);return r},_=function(i,o){var e,s,a,c,l,u,t,h,f,n,d;for(t in null==o&&(o={}),f={},o=R(o),f.config=R(o),null==o.scaleTo&&(o.scaleTo=o.period),null==o.sincFilterSize&&(o.sincFilterSize=o.lanczosFilterSize),v)E.call(v,t)&&(d=v[t],null==o[t]&&(o[t]=d));if(!(l={nearest:m,linear:p,cubic:r,lanczos:y,sinc:y}[o.method]))throw"Invalid method: "+o.method;if("lanczos"===o.method&&(o.sincWindow=b(o.sincFilterSize)),i.length<2)throw"Array must have at least two elements";for(t in f.count=i.length,n=function(){var e,t,n,r;switch(x(i[0])){case"Number":if(f.dimension="scalar",_.deepValidation)for(e=0,n=i.length;e<n;e++)h=i[e],C(h);return c=new l(i,o),function(e){return c.interpolate(e)};case"Array":if(f.dimension=s=i[0].length,!s)throw"Vectors must be non-empty";if(_.deepValidation)for(t=0,r=i.length;t<r;t++)d=i[t],A(d,s);return u=function(){var e=[];for(a=0;0<=s?a<s:s<a;0<=s?a++:a--)e.push(new l(g(i,a),o));return e}(),function(e){for(var t,n=[],r=0,i=u.length;r<i;r++)t=u[r],n.push(t.interpolate(e));return n};default:throw"Invalid element type: "+x(i[0])}}(),e="periodic"===o.clip?i.length:i.length-1,o.scaleTo||(o.scaleTo=e),f.domain=S(o.scaleTo),n=w(n,e,f.domain),f.domain.sort(),f)E.call(f,t)&&(d=f[t],n[t]=d);return n},n)E.call(n,l)&&(d=n[l],_[l]=d);_.deepValidation=!0,(null!==I?I:window).Smooth=_}).call(S)}).Smooth,cs=wn.ResidueType,ls=Fn.calcChunkMatrix;function us(n,e){var r=as(n,{method:as.METHOD_CUBIC,clip:as.CLIP_CLAMP,cubicTension:e,scaleTo:1});return function(e,t){null===t&&(t=function(e){return(e*(n.length-1-2)+1)/(n.length-1)});e=t(e),e=r(e);return new ae.Vector3(e[0],e[1],e[2])}}function hs(e,t,n,r){if(!r._isValid)return e[n]=e[n-1],void(t[n]=t[n-1]);var i=r._controlPoint;e[n]=[i.x,i.y,i.z];r=i.clone().add(r._wingVector);t[n]=[r.x,r.y,r.z]}function fs(n,e,t,r){var i=r.start,o=r.end;function s(e){return i<e&&n[e-1]._isValid?e-1:e}function a(e){return e<o&&n[e+1]._isValid?e+1:e}var c=[],l=[],u=0;function h(e,t){t=n[e]._controlPoint.clone().lerp(n[t]._controlPoint,-.25),e=t.clone().add(n[e]._wingVector);l[u]=[t.x,t.y,t.z],c[u++]=[e.x,e.y,e.z],l[u]=[t.x,t.y,t.z],c[u++]=[e.x,e.y,e.z]}var f,d,p,m,y,_,v,g,x,b,w,S,R=s(e),C=a(t);if(R===C)return f=l,d=c,p=u,m=n[e],b=0!=(m._type.flags&cs.Flags.NUCLEIC),w=b?"C5'":"N",S=b?"C3'":"C",m.forEachAtom(function(e){var t=e.getVisualName();y||t!==w?_||t!==S||(_=e.position):y=e.position}),y&&_||(y=m._firstAtom.position,_=m._lastAtom.position),y&&_&&(g=_.clone().sub(y),x=m._wingVector,r=(v=m._controlPoint).clone().add(x),m=(b=v.clone().sub(g)).clone().add(x),f[p]=[b.x,b.y,b.z],d[p]=[m.x,m.y,m.z],f[++p]=[b.x,b.y,b.z],d[p]=[m.x,m.y,m.z],f[++p]=[v.x,v.y,v.z],d[p]=[r.x,r.y,r.z],++p,x=(g=v.clone().add(g)).clone().add(x),f[p]=[g.x,g.y,g.z],d[p]=[x.x,x.y,x.z],f[++p]=[g.x,g.y,g.z],d[p]=[x.x,x.y,x.z]),{centerPoints:l,topPoints:c};e===R?h(e,a(e)):(hs(l,c,u++,n[s(R)]),hs(l,c,u++,n[R]));for(var A=e;A<=t;++A)hs(l,c,u++,n[A]);return C===a(C)?h(t,s(t)):(hs(l,c,u++,n[C]),hs(l,c,u,n[a(C)])),{centerPoints:l,topPoints:c}}var ds=function(){function s(e,t,n,r,i,o){j(this,s);o=fs(e,t,n,o);this._topInterp=us(o.topPoints,i),this._centerInterp=us(o.centerPoints,i),this._shift=.5/(n-t+2),this._valueStep=(1-2*this._shift)/(2*(n-t+1)*(r-1)),this._segmentsCount=r}return _(s,[{key:"prepareMatrices",value:function(e,t,n){for(var r=this._segmentsCount,i=new Array(r),o=new ae.Vector2(0,0),s=this._topInterp,a=this._centerInterp,c=this._shift+this._valueStep*(r-1)*e,l=0;l<r;++l){var u=Math.min(1,l/(r-1));o.lerpVectors(t,n,u);var h=s(c,null),f=a(c,null),u=a(c+=this._valueStep,null);i[l]=ls(f.clone(),u.clone(),h.clone().sub(f),o)}return i}}]),s}();function ps(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}function ms(e,t,n,r,i,o){for(var s=0,a=e.length;s<a;++s)for(var c=e[s].arr,l=e[s].boundaries,u=0,h=c.length;u<h;++u)for(var f=[c[u].start,c[u].end],d=new ds(t,f[0],f[1],n,r,l),p=null,m=2*c[u].start,y=2*c[u].end+1,_=i.getResidueRadius(t[0],0),v=m;v<=y;++v){var g=t[v/2|0],x=i.getResidueRadius(g,v%2),b=i.getResidueRadius(g,1+v%2),w=d.prepareMatrices(v-2*f[0],x,b);w.unshift(null===p?w[0]:p),o(g,w,x.x!==b.x||x.y!==b.y,x.x!==_.x||x.y!==_.y),p=w[n],_=b}}var ys=function(){A(t,es);var e=ps(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"_makeGeoArgs",value:function(){var e=this._mode.getHeightSegmentsRatio();return this._segmentsHeight=this._polyComplexity*e|0,[function(e,t){for(var n=[],r=0;r<t;++r){var i=Math.PI/2-2*Math.PI*r/t;n.push(new ae.Vector3(Math.cos(i)*e,Math.sin(i)*e,0))}return n}(1,this._polyComplexity),this._segmentsHeight+1,2*this._selection.chunks.length]}},{key:"_build",value:function(){var e=this._selection,t=e.residues,o=e.parent,n=this._mode,s=this._colorer,e=n.getTension(),a=this._geo,c=0,l=[];ms(this._selection.subdivs,t,this._segmentsHeight,e,n,function(e,t){var n=2<arguments.length&&void 0!==arguments[2]&&arguments[2],r=3<arguments.length&&void 0!==arguments[3]&&arguments[3],i=s.getResidueColor(e,o);l[c]=e._index,a.setItem(c,t,n,r),a.setColor(c++,i)}),this._chunksIdc=l,a.finalize()}},{key:"updateToFrame",value:function(e){var n=this._selection.parent,t=this._mode,r=this._colorer,i=t.getTension(),o=this._geo,s=e.getResidues(),a=0,c=e.needsColorUpdate(r);ms(this._selection.subdivs,s,this._segmentsHeight,i,t,function(e,t){o.setItem(a,t),c&&o.setColor(a,r.getResidueColor(e,n)),a++}),o.finalize()}}]),t}();function _s(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var vs=function(){A(t,To);var e=_s(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"_makeGeoArgs",value:function(){for(var e=this._selection.subdivs,t=0,n=0,r=e.length;n<r;++n)for(var i=e[n].arr,o=0,s=i.length;o<s;++o)t+=i[o].end-i[o].start;return[t,this._polyComplexity]}},{key:"_build",value:function(){for(var e=this._selection,t=e.residues,n=e.parent,e=this._mode,r=this._colorer,i=this._geo,o=0,s=[],a=this._selection.subdivs,c=e.calcStickRadius(),l=0,u=a.length;l<u;++l)for(var h=a[l].arr,f=0,d=h.length;f<d;++f)for(var p=h[f].start,m=h[f].end,y=t[p],_=p+1;_<=m;++_){var v=t[_];s[o]={first:y._index,second:v._index},i.setItem(o,y._controlPoint,v._controlPoint,c),i.setColor(o,r.getResidueColor(y,n),r.getResidueColor(v,n)),o++,y=v}this._chunksIdc=s,i.finalize()}},{key:"updateToFrame",value:function(e){for(var t=e.getResidues(),n=this._selection.parent,r=this._mode,i=this._colorer,o=this._geo,s=0,a=this._selection.subdivs,c=r.calcStickRadius(),l=e.needsColorUpdate(i),u=0,h=a.length;u<h;++u)for(var f=a[u].arr,d=0,p=f.length;d<p;++d)for(var m=f[d].start,y=f[d].end,_=t[m],v=m+1;v<=y;++v){var g=t[v];o.setItem(s,_._controlPoint,g._controlPoint,c),l&&o.setColor(s,i.getResidueColor(_,n),i.getResidueColor(g,n)),s++,_=g}o.finalize()}},{key:"raycast",value:function(e,t){var n=[],r=this._selection.residues;this._mesh.raycast(e,n);for(var i,o,s=this._chunksIdc,a=0,c=n.length;a<c;++a)n[a].hasOwnProperty("chunkIdx")&&(i=n[a].chunkIdx,o=s[Math.floor(i/2)],(o=i%2==0?o.first:o.second)<r.length&&(n[a].residue=r[o],t.push(n[a])))}},{key:"_calcChunksList",value:function(e){for(var t=[],n=this._chunksIdc,r=this._selection.residues,i=0,o=n.length;i<o;++i){var s=n[i];r[s.first]._mask&e&&t.push(2*i),r[s.second]._mask&e&&t.push(2*i+1)}return t}}]),t}();function gs(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var xs=function(){A(t,To);var e=gs(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"_makeGeoArgs",value:function(){for(var e=this._mode.drawMultiorderBonds(),t=this._mode.showAromaticLoops(),n=this._selection.chunks,r=this._selection.bonds,i=0,o=0,s=n.length;o<s;++o)i+=this.getBondOrder(r[n[o]],e,t);return[i,this._polyComplexity]}},{key:"getBondOrder",value:function(e,t,n){var r=1;return!t||n&&e._type===Ie.BondType.AROMATIC||(r=(e=e._order)<2?1:e),r}},{key:"raycast",value:function(e,t){var n=this._selection.bonds,r=[];this._mesh.raycast(e,r);for(var i,o,s=this._chunksIdc,a=0,c=r.length;a<c;++a)r[a].hasOwnProperty("chunkIdx")&&(i=r[a].chunkIdx,(o=s[Math.floor(i/2)])<n.length&&(o=n[o],r[a].atom=i%2==0?o._left:o._right,t.push(r[a])))}},{key:"_calcChunksList",value:function(e,t){for(var n=[],r=this._selection.bonds,i=this._chunksIdc,o=0,s=i.length;o<s;++o){var a=r[i[o]];a._left.mask&e&&(!t||a._right.mask&e)&&n.push(2*o),a._right.mask&e&&(!t||a._left.mask&e)&&n.push(2*o+1)}return n}}]),t}();function bs(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}function ws(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var Ss={AtomsSphereGroup:Io,AtomsSurfaceGroup:Do,AtomsSASSESGroupStub:Vo,AtomsTextGroup:Ho,AromaticTorusGroup:Zo,AromaticLinesGroup:Qo,NucleicCylindersGroup:is,NucleicSpheresGroup:ss,ResiduesSubseqGroup:ys,ResiduesTraceGroup:vs,BondsCylinderGroup:function(){A(t,xs);var e=bs(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"_build",value:function(){for(var e=this._selection.chunks,t=this._selection,n=t.bonds,r=t.parent,i=this._mode,o=this._colorer,s=this._geo,a=i.drawMultiorderBonds(),c=i.showAromaticLoops(),l=i.calcStickRadius(),u=i.calcSpaceFraction(),h=new ae.Vector3,f=new ae.Vector3,d=0,p=[],m=0,y=e.length;m<y;++m)for(var _=n[e[m]],v=_._left,g=_._right,x=v.position,b=g.position,w=_.calcNormalDir(),S=this.getBondOrder(_,a,c),R=2*Math.min(i.calcAtomRadius(v),i.calcAtomRadius(g))/S,C=a?Math.min(l,.5*R*(1-u)):l,A=0;A<S;++A){var E=R*(S%2==0?(.5+(A/2|0))*(1-A%2*2):((A+1)/2|0)*(A%2*2-1));p[d]=_._index,h.copy(x),h.addScaledVector(w,E),f.copy(b),f.addScaledVector(w,E),s.setItem(d,h,f,C),s.setColor(d++,o.getAtomColor(v,r),o.getAtomColor(g,r))}s.finalize(),this._chunksIdc=p}},{key:"updateToFrame",value:function(e){for(var t=this._selection.chunks,n=this._selection.bonds,r=this._mode,i=this._colorer,o=this._geo,s=r.drawMultiorderBonds(),a=r.showAromaticLoops(),c=r.calcStickRadius(),l=r.calcSpaceFraction(),u=new ae.Vector3,h=new ae.Vector3,f=0,d=e.needsColorUpdate(i),p=0,m=t.length;p<m;++p)for(var y=n[t[p]],_=y._left,v=y._right,g=e.getAtomPos(_.index).clone(),x=e.getAtomPos(v.index),b=y.calcNormalDir(),w=this.getBondOrder(y,s,a),S=2*Math.min(r.calcAtomRadius(_),r.calcAtomRadius(v))/w,R=s?Math.min(c,.5*S*(1-l)):c,C=0;C<w;++C){var A=S*(w%2==0?(.5+(C/2|0))*(1-C%2*2):((C+1)/2|0)*(C%2*2-1));u.copy(g),u.addScaledVector(b,A),h.copy(x),h.addScaledVector(b,A),o.setItem(f,u,h,R),d&&o.setColor(f,e.getAtomColor(i,_),e.getAtomColor(i,v)),f++}o.finalize()}}]),t}(),BondsLinesGroup:function(){A(t,xs);var e=ws(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"_build",value:function(){for(var e=this._selection.chunks,t=this._selection,n=t.bonds,r=t.parent,t=this._mode,i=this._colorer,o=this._geo,s=t.drawMultiorderBonds(),a=t.showAromaticLoops(),c=new ae.Vector3,l=new ae.Vector3,u=new ae.Vector3,h=0,f=[],d=0,p=e.length;d<p;++d){var m=n[e[d]],y=m._left,_=m._right,v=y.position,g=_.position,x=1===y.bonds.length,b=1===_.bonds.length;c.subVectors(g,v);for(var w=c.length(),S=m.calcNormalDir(),R=this.getBondOrder(m,s,a),C=0;C<R;++C){l.copy(v),u.copy(g);var A=R%2==0?(.5+(C/2|0))*(1-C%2*2):((C+1)/2|0)*(C%2*2-1);f[h]=m._index,2!==R||x||b||(A-=.5,A*=-1),!x&&!b&&1<R&&0!==A&&(l.lerpVectors(v,g,.15/w),u.lerpVectors(v,g,1-.15/w)),A*=.15,l.addScaledVector(S,A),u.addScaledVector(S,A),o.setItem(h,l,u),o.setColor(h++,i.getAtomColor(y,r),i.getAtomColor(_,r))}}o.finalize(),this._chunksIdc=f}},{key:"updateToFrame",value:function(e){for(var t=this._selection.chunks,n=this._selection.bonds,r=this._mode,i=this._colorer,o=this._geo,s=r.drawMultiorderBonds(),a=r.showAromaticLoops(),c=new ae.Vector3,l=new ae.Vector3,u=new ae.Vector3,h=0,f=e.needsColorUpdate(i),d=0,p=t.length;d<p;++d){var m=n[t[d]],y=m._left,_=m._right,v=e.getAtomPos(y.index).clone(),g=e.getAtomPos(_.index),x=1===y.bonds.length,b=1===_.bonds.length;c.subVectors(g,v);for(var w=c.length(),S=m.calcNormalDir(),R=this.getBondOrder(m,s,a),C=0;C<R;++C){l.copy(v),u.copy(g);var A=R%2==0?(.5+(C/2|0))*(1-C%2*2):((C+1)/2|0)*(C%2*2-1);2!==R||x||b||(A-=.5,A*=-1),!x&&!b&&1<R&&0!==A&&(l.lerpVectors(v,g,.15/w),u.lerpVectors(v,g,1-.15/w)),A*=.15,l.addScaledVector(S,A),u.addScaledVector(S,A),o.setItem(h,l,u),f&&o.setColor(h,e.getAtomColor(i,y),e.getAtomColor(i,_)),h++}}o.finalize()}}]),t}()};function Rs(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var Cs=function(){A(n,An);var t=Rs(n);function n(i,o,s,a,c,l,u,h){var e;j(this,n),e=t.call(this);var f=k(e);e._complex=s,e._mode=c;var d=s.getAtoms(),p=s.getTransforms();return s.forEachComponent(function(e){var t,n=[],r=0;e.forEachAtom(function(e){f._checkAtom(e,u)&&(n[r++]=e.index)}),0!==r&&((t=new i(o,{atoms:d,chunks:n,parent:s},a,c,p,l,h))._component=e,f.add(t))}),e}return _(n,[{key:"_checkAtom",value:function(e,t){return e.mask&t}},{key:"getSubset",value:function(e,t){for(var n=[],r=this.children,i=0,o=0,s=r.length;o<s;++o)if(r[o].getSubset)for(var a=r[o].getSubset(e,t),c=0,l=a.length;c<l;++c){var u=a[c];u._component=r[o]._component,n[i++]=u}return n}}]),n}();function As(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var Es=function(){A(t,Cs);var e=As(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"_checkAtom",value:function(e,t){if(!(e.mask&t))return!1;for(var n=e.bonds,r=0,i=n.length;r<i;++r)if(n[r]._left.mask&t&&n[r]._right.mask&t)return!1;return!0}}]),t}();function ks(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var Ts=function(){A(n,An);var t=ks(n);function n(i,o,s,a,c,l,u,h){var e;j(this,n),e=t.call(this);var f=k(e),d=(e._complex=s).getResidues(),p=s.getTransforms();return s.forEachComponent(function(e){var t,n=0,r=[];e.forEachResidue(function(e){f._checkResidue(e,u)&&(r[n++]=e._index)}),0!==n&&((t=new i(o,{residues:d,chunks:r,parent:s},a,c,p,l,h))._component=e,f.add(t))}),e}return _(n,[{key:"checkResidue",value:function(e,t){return e._mask&t}},{key:"getSubset",value:function(e,t){for(var n=[],r=this.children,i=0,o=0,s=r.length;o<s;++o)if(r[o].getSubset)for(var a=r[o].getSubset(e,t),c=0,l=a.length;c<l;++c){var u=a[c];u._component=r[o]._component,n[i++]=u}return n}}]),n}();function Ps(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}function Ms(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}function Ns(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}function Is(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var Ls={Atoms:Cs,OrphanAtoms:Es,Residues:Ts,Nucleic:function(){A(t,Ts);var e=Ps(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"_checkResidue",value:function(e,t){return t&e._mask&&null!==e._cylinders}}]),t}(),Subseqs:function(){A(n,An);var t=Ms(n);function n(f,d,p,m,y,_,v,g){var e;j(this,n),e=t.call(this);var x=k(e),b=(e._complex=p).getResidues(),w=p.getTransforms();return p.forEachComponent(function(e){for(var t,n=e.getMaskedSubdivSequences(v),r=0,i=[],o=0,s=n.length;o<s;++o)for(var a=n[o].arr,c=0,l=a.length;c<l;++c)for(var u=a[c].start,h=a[c].end;u<=h;++u)i[r++]=b[u]._index;0!==r&&((t=new f(d,{residues:b,chunks:i,subdivs:n,parent:p},m,y,w,_,g))._component=e,x.add(t))}),e}return _(n,[{key:"getSubset",value:function(e,t){for(var n=[],r=this.children,i=0,o=0,s=r.length;o<s;++o)if(r[o].getSubset)for(var a=r[o].getSubset(e,t),c=0,l=a.length;c<l;++c){var u=a[c];u._component=r[o]._component,n[i++]=u}return n}}]),n}(),Bonds:function(){A(r,An);var t=Ns(r);function r(n,o,s,a,c,l,u,h){var e;j(this,r),e=t.call(this);var f=k(e),d=(e._complex=s).getBonds(),p=s.getTransforms();return s.forEachComponent(function(e){var t,r=[],i=0;e.forEachBond(function(e){var t=e._left,n=e._right;t.mask&u&&n.mask&u&&(r[i++]=e._index)}),0!==i&&((t=new n(o,{bonds:d,chunks:r,parent:s},a,c,p,l,h))._component=e,f.add(t))}),e}return _(r,[{key:"getSubset",value:function(e,t){for(var n=[],r=this.children,i=0,o=0,s=r.length;o<s;++o)if(r[o].getSubset)for(var a=r[o].getSubset(e,t),c=0,l=a.length;c<l;++c){var u=a[c];u._component=r[o]._component,n[i++]=u}return n}}]),r}(),Aromatic:function(){A(o,An);var t=Is(o);function o(n,r,i,l,u,h,f,d){var e;j(this,o),e=t.call(this);var p=k(e),m=(e._complex=i).getAtoms(),y=i.getTransforms();return u.showAromaticLoops()?(i.forEachComponent(function(e){var o=[],s=0,a=[],c=0;e.forEachCycle(function(e){for(var t=e.atoms,n=0,r=0,i=t.length;r<i;++r)0!=(t[r].mask&f)&&(++n,o[s++]=t[r].index);0<n&&(a[c++]=e)});var t=new n(r,{cycles:a,atoms:m,chunks:o,parent:i},l,u,y,h,d);t._component=e,p.add(t)}),e):T(e)}return _(o,[{key:"getSubset",value:function(e,t){for(var n=[],r=this.children,i=0,o=0,s=r.length;o<s;++o)if(r[o].getSubset)for(var a=r[o].getSubset(e,t),c=0,l=a.length;c<l;++c){var u=a[c];u._component=r[o]._component,n[i++]=u}return n}}]),o}()};function Ds(s,a,c){return function(e,t,n,r,i,o){return new a(c,s,e,t,n,r,i,o)}}var Os=function(){function e(){j(this,e)}return _(e,null,[{key:"AtomsSpheres",value:function(e,t){return Ds(Co.createSpheres(e,t),Ls.Atoms,Ss.AtomsSphereGroup)}},{key:"OrphanedAtomsCrosses",value:function(e,t,n){return Ds(Co.createCrosses(e,t,n),Ls.OrphanAtoms,Ss.AtomsSphereGroup)}},{key:"BondsCylinders",value:function(e,t){return Ds(Co.create2CCylinders(e,t),Ls.Bonds,Ss.BondsCylinderGroup)}},{key:"BondsLines",value:function(e,t,n){return Ds(Co.create2CLines(e,t,n),Ls.Bonds,Ss.BondsLinesGroup)}},{key:"CartoonChains",value:function(e,t){return Ds(Co.createExtrudedChains(e,t),Ls.Subseqs,Ss.ResiduesSubseqGroup)}},{key:"TraceChains",value:function(e,t){return Ds(Co.create2CClosedCylinders(e,t),Ls.Subseqs,Ss.ResiduesTraceGroup)}},{key:"NucleicSpheres",value:function(e,t){return Ds(Co.createSpheres(e,t),Ls.Nucleic,Ss.NucleicSpheresGroup)}},{key:"NucleicCylinders",value:function(e,t){return Ds(Co.create2CCylinders(e,t),Ls.Nucleic,Ss.NucleicCylindersGroup)}},{key:"ALoopsTorus",value:function(e,t){return Ds(Co.createExtrudedChains(e,t),Ls.Aromatic,Ss.AromaticTorusGroup)}},{key:"ALoopsLines",value:function(e,t,n){return Ds(Co.createChunkedLines(e,t,n),Ls.Aromatic,Ss.AromaticLinesGroup)}},{key:"QuickSurfGeo",value:function(e,t,n){return Ds(Co.createQuickSurface(e,t,n),Ls.Atoms,Ss.AtomsSurfaceGroup)}},{key:"ContactSurfaceGeo",value:function(e,t,n){return Ds(Co.createContactSurface(e,t,n),Ls.Atoms,Ss.AtomsSurfaceGroup)}},{key:"SASSESSurfaceGeo",value:function(e,t,n){return Ds(Co.createSASSES(e,t,n),Ls.Atoms,Ss.AtomsSASSESGroupStub)}},{key:"TextLabelsGeo",value:function(e,t){return Ds(Co.createLabels(e,t),Ls.Atoms,Ss.AtomsTextGroup)}}]),e}(),Vs=function(){function t(e){if(j(this,t),this.constructor===t)throw new Error("Can not instantiate abstract class!");this.opts=b.default.merge(ce.deriveDeep(this.settings.now.modes[this.id],!0),e)}return _(t,[{key:"identify",value:function(){var e=ce.objectsDiff(this.opts,this.settings.now.modes[this.id]);return b.default.isEmpty(e)?this.id:[this.id,e]}},{key:"buildGeometry",value:function(e,t,n,r){for(var i=this.opts.polyComplexity?this.opts.polyComplexity[this.settings.now.resolution]:0,o=this.depGroups,s=o.length,a=new Fn.RCGroup,c=0;c<s;++c){var l=o[c],u={};b.default.isArray(l)&&(u=l[1].call(this),l=m(l,1)[0]);u=new(Os[l](null,this.settings,u))(e,t,this,i,n,r);0<u.children.length&&a.add(u)}return a}}]),t}();function zs(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}function Fs(){return{lineWidth:this.opts.lineWidth}}$n(Vs.prototype),Vs.prototype.id="__",Vs.prototype.depGroups=[];var Bs=function(){A(o,Vs);var i=zs(o);function o(e){j(this,o),(e=i.call(this,e)).depGroups=e.depGroups.slice(0);for(var t=e.depGroups,n=0,r=t.length;n<r;++n)t[n]=[t[n],Fs];return e}return _(o,[{key:"drawMultiorderBonds",value:function(){return this.opts.multibond}},{key:"calcAtomRadius",value:function(){return this.opts.atom}},{key:"getAromaticOffset",value:function(){return this.opts.offsarom}},{key:"getAromaticArcChunks",value:function(){return this.opts.chunkarom}},{key:"showAromaticLoops",value:function(){return this.opts.showarom}}]),o}();function Us(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}ke(Bs,"id","LN"),Bs.prototype.id="LN",Bs.prototype.name="Lines",Bs.prototype.shortName="Lines",Bs.prototype.depGroups=["ALoopsLines","BondsLines","OrphanedAtomsCrosses"];var Gs=function(){A(t,Vs);var e=Us(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"calcAtomRadius",value:function(){return this.opts.bond}},{key:"calcStickRadius",value:function(){return this.opts.bond}},{key:"calcSpaceFraction",value:function(){return this.opts.space}},{key:"getAromRadius",value:function(){return this.opts.aromrad}},{key:"showAromaticLoops",value:function(){return this.opts.showarom}},{key:"drawMultiorderBonds",value:function(){return this.opts.multibond}}]),t}();function js(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}ke(Gs,"id","LC"),Gs.prototype.id="LC",Gs.prototype.name="Licorice",Gs.prototype.shortName="Licorice",Gs.prototype.depGroups=["AtomsSpheres","BondsCylinders","ALoopsTorus"];var Hs=function(){A(t,Vs);var e=js(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"calcAtomRadius",value:function(e){return e.element.radius*this.opts.atom}},{key:"calcStickRadius",value:function(){return this.opts.bond}},{key:"getAromRadius",value:function(){return this.opts.aromrad}},{key:"showAromaticLoops",value:function(){return this.opts.showarom}},{key:"calcSpaceFraction",value:function(){return this.opts.space}},{key:"drawMultiorderBonds",value:function(){return this.opts.multibond}}]),t}();function Ws(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}ke(Hs,"id","BS"),Hs.prototype.id="BS",Hs.prototype.name="Balls and Sticks",Hs.prototype.shortName="Balls",Hs.prototype.depGroups=["AtomsSpheres","BondsCylinders","ALoopsTorus"];var Ys=function(){A(t,Vs);var e=Ws(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"calcAtomRadius",value:function(e){return e.element.radius}}]),t}();function Xs(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}ke(Ys,"id","VW"),Ys.prototype.id="VW",Ys.prototype.name="Van der Waals",Ys.prototype.shortName="VDW",Ys.prototype.depGroups=["AtomsSpheres"];var qs=function(){A(t,Vs);var e=Xs(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"calcStickRadius",value:function(){return this.opts.radius}}]),t}();function $s(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}ke(qs,"id","TR"),qs.prototype.id="TR",qs.prototype.name="Trace",qs.prototype.shortName="Trace",qs.prototype.depGroups=["TraceChains"];e=function(){A(t,Vs);var e=$s(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"getResidueRadius",value:function(){return this.TUBE_RADIUS}},{key:"getHeightSegmentsRatio",value:function(){return this.opts.heightSegmentsRatio}},{key:"getTension",value:function(){return this.opts.tension}},{key:"buildGeometry",value:function(e,t,n,r){var i=this.opts.radius;return this.TUBE_RADIUS=new ae.Vector2(i,i),Vs.prototype.buildGeometry.call(this,e,t,n,r)}}]),t}();function Zs(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}ke(e,"id","TU"),e.prototype.id="TU",e.prototype.name="Tube",e.prototype.shortName="Tube",e.prototype.depGroups=["CartoonChains"];var Ks=function(){A(n,Vs);var t=Zs(n);function n(e){return j(this,n),(e=t.call(this,e)).secCache={},e}return _(n,[{key:"getResidueStartRadius",value:function(e){var t=e.getSecondary();if(!t||!t.generic)return this.TUBE_RADIUS;var n=this.secCache[t.generic];return n?t.term===e?n.start:n.center:this.TUBE_RADIUS}},{key:"getResidueEndRadius",value:function(e){var t=e.getSecondary();if(null===t||!t.generic)return this.TUBE_RADIUS;var n=this.secCache[t.generic];return n?t.term===e?this.ARROW_END:n.center:this.TUBE_RADIUS}},{key:"getResidueRadius",value:function(e,t){var n=this.getResidueStartRadius(e);if(0===t)return n;e=this.getResidueEndRadius(e);return 2===t?e:n.clone().lerp(e,t/2)}},{key:"calcStickRadius",value:function(){return this.opts.radius}},{key:"getHeightSegmentsRatio",value:function(){return this.opts.heightSegmentsRatio}},{key:"getTension",value:function(){return this.opts.tension}},{key:"buildGeometry",value:function(e,t,n,r){var i=this.opts.radius,o=this.opts.depth;this.TUBE_RADIUS=new ae.Vector2(i,i),this.ARROW_END=new ae.Vector2(o,i);var s,a={},c=this.opts.ss;for(s in c)a[s]={center:new ae.Vector2(o,c[s].width),start:new ae.Vector2(o,c[s].arrow)};return this.secCache=a,Vs.prototype.buildGeometry.call(this,e,t,n,r)}}]),n}();function Qs(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}ke(Ks,"id","CA"),Ks.prototype.id="CA",Ks.prototype.name="Cartoon",Ks.prototype.shortName="Cartoon",Ks.prototype.depGroups=["CartoonChains","NucleicSpheres","NucleicCylinders"];var Js=wn.selectors;function ea(){return{wireframe:this.opts.wireframe,zClip:this.opts.zClip}}var ta=function(){A(s,Vs);var o=Qs(s);function s(e){j(this,s),(e=o.call(this,e)).depGroups=e.depGroups.slice(0);for(var t=e.surfaceNames,n=e.depGroups,r=0,i=t.length;r<i;++r)n[n.length]=[t[r],ea];return e}return _(s,[{key:"calcAtomRadius",value:function(e){return e.element.radius}},{key:"getVisibilitySelector",value:function(){var e,t=null;return""!==this.opts.subset&&((e=Js.parse(this.opts.subset)).error||(t=e.selector)),t}}]),s}();function na(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}ta.prototype.isSurface=!0,ta.prototype.surfaceNames=[];Me=function(){A(t,ta);var e=na(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"getSurfaceOpts",value:function(){return{useBeads:!1,isoValue:this.opts.isoValue,gaussLim:this.opts.gaussLim[this.settings.now.resolution],radScale:this.opts.scale,gridSpacing:this.opts.gridSpacing[this.settings.now.resolution],zClip:this.opts.zClip,visibilitySelector:this.getVisibilitySelector()}}}]),t}();function ra(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}ke(Me,"id","QS"),Me.prototype.id="QS",Me.prototype.name="Quick Surface",Me.prototype.shortName="Quick Surf",Me.prototype.surfaceNames=["QuickSurfGeo"];var ia=function(){A(r,ta);var n=ra(r);function r(e,t){return j(this,r),(t=n.call(this,t))._excludeProbe=e,t}return _(r,[{key:"calcAtomRadius",value:function(e){return e.element.radius}},{key:"getSurfaceOpts",value:function(){return{gridSpacing:this.opts.polyComplexity[this.settings.now.resolution],radScale:this._radScale,zClip:this.opts.zClip,visibilitySelector:this.getVisibilitySelector(),probeRadius:this.opts.probeRadius,excludeProbe:this._excludeProbe}}}]),r}();function oa(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}ia.prototype.id="SU",ia.prototype.name="Surface",ia.prototype.shortName="Surface",ia.prototype.surfaceNames=["SASSESSurfaceGeo"],ia.prototype._radScale=1,ia.prototype._excludeProbe=!1;Ge=function(){A(n,ia);var t=oa(n);function n(e){return j(this,n),t.call(this,!1,e)}return n}();function sa(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}ke(Ge,"id","SA"),Ge.prototype.id="SA",Ge.prototype.name="Solvent Accessible Surface",Ge.prototype.shortName="SAS";qe=function(){A(n,ia);var t=sa(n);function n(e){return j(this,n),t.call(this,!0,e)}return n}();function aa(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}ke(qe,"id","SE"),qe.prototype.id="SE",qe.prototype.name="Solvent Excluded Surface",qe.prototype.shortName="SES";$e=function(){A(t,ta);var e=aa(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"getSurfaceOpts",value:function(){return{probeRadius:this.opts.probeRadius,radScale:this.opts.polyComplexity[this.settings.now.resolution],scaleFactor:this.opts.polyComplexity[this.settings.now.resolution],gridSpacing:1/this.opts.polyComplexity[this.settings.now.resolution],isoValue:this.opts.isoValue,probePositions:this.opts.probePositions,zClip:this.opts.zClip,visibilitySelector:this.getVisibilitySelector()}}}]),t}();function ca(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}ke($e,"id","CS"),$e.prototype.id="CS",$e.prototype.name="Contact Surface",$e.prototype.shortName="Contact Surf",$e.prototype.isSurface=!0,$e.prototype.surfaceNames=["ContactSurfaceGeo"];var la=function(){A(t,Vs);var e=ca(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"getTemplateOptions",value:function(){return this.opts.template}},{key:"getLabelOpts",value:function(){return b.default.merge(this.opts,{colors:!0,adjustColor:!0,transparent:!0})}}]),t}();ke(la,"id","TX"),la.prototype.id="TX",la.prototype.name="Text mode",la.prototype.shortName="Text",la.prototype.depGroups=["TextLabelsGeo"];var ua=new qn([Bs,Gs,Hs,Ys,qs,e,Ks,Me,Ge,qe,$e,la]);function ha(e,t,n){return e<=n?e<0?0:e:n}Ke=function(){function n(e,t){j(this,n),this.name=e||"Custom",this.id=t||"CP"}return _(n,[{key:"getElementColor",value:function(e,t){t=1<arguments.length&&void 0!==t&&t,e=this.elementColors[e];return void 0!==e||t?e:this.defaultElementColor}},{key:"getResidueColor",value:function(e,t){t=1<arguments.length&&void 0!==t&&t,e=this.residueColors[e];return void 0!==e||t?e:this.defaultResidueColor}},{key:"getChainColor",value:function(e){e=(31&((e=e.charCodeAt(0))<0?0:256<=e?e-256:e))%this.chainColors.length;return this.chainColors[e]}},{key:"getSecondaryColor",value:function(e,t){t=1<arguments.length&&void 0!==t&&t,e=this.secondaryColors[e];return void 0!==e||t?e:this.defaultSecondaryColor}},{key:"getSequentialColor",value:function(e){var t=this.colors,n=t.length;return e<0?t[e%n+n]:t[e%n]}},{key:"getGradientColor",value:function(e,t){var n=this.gradients[t];if(!n)return this.defaultNamedColor;var r=n.length,i=e*(r-1),e=ha((t=Math.floor(i))+1,0,r-1),t=ha(t,0,r-1);return r=n[t],e=n[e],(t=1-(i=i-t))*(r>>16&255)+i*(e>>16&255)<<16|t*(r>>8&255)+i*(e>>8&255)<<8|t*(255&r)+i*(255&e)}},{key:"getNamedColor",value:function(e,t){t=1<arguments.length&&void 0!==t&&t,e=this.namedColors[e];return void 0!==e||t?e:this.defaultNamedColor}}]),n}();b.default.assign(Ke.prototype,{colors:[16777215,16711680,65280,255,8421504],minRangeColor:0,midRangeColor:8355711,maxRangeColor:16777215,defaultElementColor:16777215,elementColors:{},defaultResidueColor:16777215,residueColors:{},chainColors:[16777215],defaultSecondaryColor:16777215,secondaryColors:{},defaultGradientColor:0,defaultNamedColor:16777215,namedColorsArray:[["indianred",13458524],["lightcoral",15761536],["salmon",16416882],["darksalmon",15308410],["lightsalmon",16752762],["crimson",14423100],["red",16711680],["firebrick",11674146],["darkred",9109504],["pink",16761035],["lightpink",16758465],["hotpink",16738740],["deeppink",16716947],["mediumvioletred",13047173],["palevioletred",14381203],["coral",16744272],["tomato",16737095],["orangered",16729344],["darkorange",16747520],["orange",16753920],["gold",16766720],["yellow",16776960],["lightyellow",16777184],["lemonchiffon",16775885],["lightgoldenrodyellow",16448210],["papayawhip",16773077],["moccasin",16770229],["peachpuff",16767673],["palegoldenrod",15657130],["khaki",15787660],["darkkhaki",12433259],["lavender",15132410],["thistle",14204888],["plum",14524637],["violet",15631086],["orchid",14315734],["fuchsia",16711935],["magenta",16711935],["mediumorchid",12211667],["mediumpurple",9662683],["rebeccapurple",6697881],["blueviolet",9055202],["darkviolet",9699539],["darkorchid",10040012],["darkmagenta",9109643],["purple",8388736],["indigo",4915330],["slateblue",6970061],["mediumslateblue",8087790],["darkslateblue",4734347],["greenyellow",11403055],["chartreuse",8388352],["lawngreen",8190976],["lime",65280],["limegreen",3329330],["palegreen",10025880],["lightgreen",9498256],["mediumspringgreen",64154],["springgreen",65407],["mediumseagreen",3978097],["seagreen",3050327],["forestgreen",2263842],["green",32768],["darkgreen",25600],["yellowgreen",10145074],["olivedrab",7048739],["olive",8421376],["darkolivegreen",5597999],["mediumaquamarine",6737322],["darkseagreen",9419919],["lightseagreen",2142890],["darkcyan",35723],["teal",32896],["aqua",65535],["cyan",65535],["lightcyan",14745599],["paleturquoise",11529966],["aquamarine",8388564],["turquoise",4251856],["mediumturquoise",4772300],["darkturquoise",52945],["cadetblue",6266528],["steelblue",4620980],["lightsteelblue",11584734],["powderblue",11591910],["lightblue",11393254],["skyblue",8900331],["lightskyblue",8900346],["deepskyblue",49151],["dodgerblue",2003199],["cornflowerblue",6591981],["royalblue",4286945],["blue",255],["mediumblue",205],["darkblue",139],["navy",128],["midnightblue",1644912],["cornsilk",16775388],["blanchedalmond",16772045],["bisque",16770244],["navajowhite",16768685],["wheat",16113331],["burlywood",14596231],["tan",13808780],["rosybrown",12357519],["sandybrown",16032864],["goldenrod",14329120],["darkgoldenrod",12092939],["peru",13468991],["chocolate",13789470],["saddlebrown",9127187],["sienna",10506797],["brown",10824234],["maroon",8388608],["white",16777215],["snow",16775930],["honeydew",15794160],["mintcream",16121850],["azure",15794175],["aliceblue",15792383],["ghostwhite",16316671],["whitesmoke",16119285],["seashell",16774638],["beige",16119260],["oldlace",16643558],["floralwhite",16775920],["ivory",16777200],["antiquewhite",16444375],["linen",16445670],["lavenderblush",16773365],["mistyrose",16770273],["gainsboro",14474460],["lightgray",13882323],["silver",12632256],["darkgray",11119017],["gray",8421504],["dimgray",6908265],["lightslategray",7833753],["slategray",7372944],["darkslategray",3100495],["black",0]],namedColors:{},gradients:{rainbow:[255,65535,65280,16776960,16711680],temp:[255,32767,16777215,16744192,16711680],hot:[16777215,16744192,16711680],cold:[16777215,32767,255],"blue-red":[255,16777215,16711680],reds:[16777215,16711680],blues:[16777215,255]}});for(var fa=Ke.prototype,da=fa.namedColorsArray,pa=fa.namedColors,ma=0,ya=da.length;ma<ya;++ma){var _a=m(da[ma],2),va=_a[0],_a=_a[1];pa[va]=_a}var ga=new Ke("CPK","CP");ga.elementColors={H:16777215,C:2105376,N:2121983,O:15605776,F:65280,P:8397055,S:16776960,CL:47872,FE:13684944,CO:13684944,NI:13684944,CU:13684944,BR:34816,I:21760};var xa=new Ke("Jmol","JM");xa.colors=[255,22015,44031,65535,65451,65365,65280,5635840,11271936,16776960,16755456,16733440,16711680,16711765,16711851,16711935,11206911,5570815],xa.elementColors={H:16777215,D:16777152,T:16777120,HE:14286847,LI:13402367,BE:12779264,B:16758197,C:9474192,N:3166456,O:16715021,F:9494608,NE:11789301,NA:11230450,MG:9109248,AL:12560038,SI:1578e4,P:16744448,S:16777008,CL:2093087,AR:8442339,K:9388244,CA:4062976,SC:15132390,TI:12567239,V:10921643,CR:9083335,MN:10255047,FE:14706227,CO:15765664,NI:5296208,CU:13140019,ZN:8224944,GA:12750735,GE:6721423,AS:12419299,SE:16752896,BR:10889513,KR:6076625,RB:7351984,SR:65280,Y:9764863,ZR:9756896,NB:7586505,MO:5551541,TC:3907230,RU:2396047,RH:687500,PD:27013,AG:12632256,CD:16767375,IN:10909043,SN:6717568,SB:10380213,TE:13924864,I:9699476,XE:4366e3,CS:5707663,BA:51456,LA:7394559,CE:16777159,PR:14286791,ND:13107143,PM:10747847,SM:9437127,EU:6422471,GD:4587463,TB:3211207,DY:2097095,HO:65436,ER:58997,TM:54354,YB:48952,LU:43812,HF:5096191,TA:5089023,W:2200790,RE:2522539,OS:2516630,IR:1528967,PT:13684960,AU:16765219,HG:12105936,TL:10900557,PB:5724513,BI:10375093,PO:11230208,AT:7688005,RN:4358806,FR:4325478,RA:32e3,AC:7384058,TH:47871,PA:41471,U:36863,NP:33023,PU:27647,AM:5528818,CM:7888099,BK:9064419,CF:10565332,ES:11739092,FM:11739066,MD:11734438,NO:12389767,LR:13041766,RF:13369433,DB:13697103,SG:14221381,BH:14680120,HS:15073326,MT:15400998},xa.defaultResidueColor=12492910,xa.residueColors={ALA:13158600,ARG:1334015,ASN:56540,ASP:15075850,CYS:15132160,GLN:56540,GLU:15075850,GLY:15461355,HIS:8553170,ILE:1016335,LEU:1016335,LYS:1334015,MET:15132160,PHE:3289770,PRO:14456450,SER:16422400,THR:16422400,TRP:11819700,TYR:3289770,VAL:1016335,A:10526975,C:16747595,G:16740464,I:8454143,T:10551200,U:16744576,DA:10526975,DC:16747595,DG:16740464,DI:8454143,DT:10551200,DU:16744576,"+A":10526975,"+C":16747595,"+G":16740464,"+I":8454143,"+T":10551200,"+U":16744576},xa.chainColors=[4294967295,4290826495,4289789872,4294951112,4294967168,4294951167,4289786096,4294955120,4293951616,4294303411,4278239231,4291648604,4284927402,4288335154,4293821166,4278243025,4278255487,4282168177,4278190219,4290623339,4278215680,4286578688,4286611456,4286578816,4278222976,4290283019,4289864226];var ba=Xe.Type;xa.secondaryColors=(ke(sd={},ba.HELIX_ALPHA,16711808),ke(sd,ba.HELIX_PI,6291584),ke(sd,ba.HELIX_310,10485888),ke(sd,ba.STRAND,16762880),ke(sd,ba.TURN,6324479),ke(sd,"dna",11403518),ke(sd,"rna",16580962),sd);var wa=new Ke("VMD","VM");wa.colors=[255,16711680,6316128,16744448,16776960,8421427,10066329,65280,16777215,16751001,4243648,10879142,8447590,15099571,8408320,8421568],wa.defaultElementColor=8408320,wa.elementColors={H:16777215,C:4243391,N:255,O:16711680,P:8421427,S:16776960},wa.defaultResidueColor=4243648,wa.residueColors={ALA:255,ARG:16777215,ASN:8421427,ASP:16711680,CYS:16776960,GLN:16744448,GLU:16751001,GLY:16777215,HIS:4243648,ILE:65280,LEU:16751001,LYS:4243648,MET:16776960,PHE:10879142,PRO:8408064,SER:16776960,THR:15099571,TRP:10066329,TYR:65280,VAL:8421427,A:255,C:16744448,G:16776960,T:10879142,U:65280,DA:255,DC:16744448,DG:16776960,DT:10879142,DU:65280,"+A":255,"+C":16744448,"+G":16776960,"+T":10879142,"+U":65280,WAT:4243648,H2O:4243648,HOH:4243648},wa.chainColors=[16777215].concat(wa.colors);var Sa=Xe.Type;wa.secondaryColors=(ke(ad={},Sa.HELIX_ALPHA,10879142),ke(ad,Sa.HELIX_310,255),ke(ad,Sa.HELIX_PI,16711680),ke(ad,Sa.STRAND,16776960),ke(ad,Sa.BRIDGE,8421427),ke(ad,Sa.TURN,4243648),ad);var Ra=new qn([ga,xa,wa]),Ca=function(){function t(e){if(j(this,t),this.constructor===t)throw new Error("Can not instantiate abstract class!");this.opts=b.default.merge(ce.deriveDeep(oe.now.colorers[this.id],!0),e),this.palette=Ra.first}return _(t,[{key:"identify",value:function(){var e=ce.objectsDiff(this.opts,oe.now.colorers[this.id]);return b.default.isEmpty(e)?this.id:[this.id,e]}}]),t}();function Aa(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}Ca.prototype.id="__";var Ea=function(){A(t,Ca);var e=Aa(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"getAtomColor",value:function(e){e=e.element.name;return"C"===e&&0<=this.opts.carbon?this.opts.carbon:this.palette.getElementColor(e)}},{key:"getResidueColor",value:function(){return this.palette.defaultResidueColor}}]),t}();function ka(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}ke(Ea,"id","EL"),Ea.prototype.id="EL",Ea.prototype.name="Element",Ea.prototype.shortName="Element";var Ta=function(){A(t,Ca);var e=ka(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"getAtomColor",value:function(e,t){return this.getResidueColor(e.residue,t)}},{key:"getResidueColor",value:function(e){return this.palette.getResidueColor(e._type._name)}}]),t}();function Pa(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}ke(Ta,"id","RT"),Ta.prototype.id="RT",Ta.prototype.name="Residue Type",Ta.prototype.shortName="Residue";var Ma=function(){A(t,Ca);var e=Pa(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"getAtomColor",value:function(e,t){return this.getResidueColor(e.residue,t)}},{key:"getResidueColor",value:function(e){var t=e._chain;if(t.minSequence===Number.POSITIVE_INFINITY&&t.maxSequence===Number.NEGATIVE_INFINITY)return this.palette.defaultNamedColor;var n=t.minSequence,t=t.maxSequence>n?t.maxSequence:n+1;return this.palette.getGradientColor((e._sequence-n)/(t-n),this.opts.gradient)}}]),t}();function Na(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}ke(Ma,"id","SQ"),Ma.prototype.id="SQ",Ma.prototype.name="Sequence",Ma.prototype.shortName="Sequence";var Ia=function(){A(t,Ca);var e=Na(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"getAtomColor",value:function(e,t){return this.getResidueColor(e.residue,t)}},{key:"getResidueColor",value:function(e){return this.palette.getChainColor(e.getChain()._name)}}]),t}();function La(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}ke(Ia,"id","CH"),Ia.prototype.id="CH",Ia.prototype.name="Chain",Ia.prototype.shortName="Chain";var Da=function(){A(t,Ca);var e=La(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"getAtomColor",value:function(e,t){return this.getResidueColor(e.residue,t)}},{key:"getResidueColor",value:function(e){if(e._type.flags&Be.Flags.DNA)return this.palette.getSecondaryColor("dna");if(e._type.flags&Be.Flags.RNA)return this.palette.getSecondaryColor("rna");var t=e.getSecondary();if(t){e=this.palette.getSecondaryColor(t.type,!0);return void 0===e&&(e=this.palette.getSecondaryColor(t.generic)),e}return this.palette.defaultSecondaryColor}}]),t}();function Oa(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}ke(Da,"id","SS"),Da.prototype.id="SS",Da.prototype.name="Secondary Structure",Da.prototype.shortName="Structure";var Va=function(){A(t,Ca);var e=Oa(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"getAtomColor",value:function(){return this.opts.color}},{key:"getResidueColor",value:function(){return this.opts.color}}]),t}();function za(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}ke(Va,"id","UN"),Va.prototype.id="UN",Va.prototype.name="Uniform",Va.prototype.shortName="Uniform";var Fa=function(){A(r,Ca);var n=za(r);function r(e){var t;j(this,r),t=n.call(this,e);e=Mt.parse(t.opts.subset);return t._subsetCached=e.error?Mt.none():e.selector,t}return _(r,[{key:"getAtomColor",value:function(e){return this._subsetCached.includesAtom(e)?this.opts.color:this.opts.baseColor}},{key:"getResidueColor",value:function(e){for(var t=this._subsetCached,n=e._atoms,r=0,i=n.length;r<i;++r)if(!t.includesAtom(n[r]))return this.opts.baseColor;return this.opts.color}}]),r}();function Ba(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}ke(Fa,"id","CO"),Fa.prototype.id="CO",Fa.prototype.name="Conditional",Fa.prototype.shortName="Conditional";var Ua=function(){A(t,Ca);var e=Ba(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"getAtomColor",value:function(e){return this.palette.getChainColor(String.fromCharCode(e.location))}},{key:"getResidueColor",value:function(){return this.palette.defaultResidueColor}}]),t}();function Ga(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}ke(Ua,"id","CF"),Ua.prototype.id="CF",Ua.prototype.name="Conformation",Ua.prototype.shortName="Conformation";xt=function(){A(t,Ca);var e=Ga(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"getAtomColor",value:function(e){var t=this.opts,n=1;return e.temperature&&t?(n=t.min===t.max?e.temperature>t.max?1:0:(e.temperature-t.min)/(t.max-t.min),this.palette.getGradientColor(n,t.gradient)):this.palette.defaultGradientColor}},{key:"getResidueColor",value:function(e){var t=this.opts;if(!t)return this.palette.defaultGradientColor;if(e.temperature){var n=0,n=t.min===t.max?e.temperature>t.max?1:0:(e.temperature-t.min)/(t.max-t.min);return this.palette.getGradientColor(n,t.gradient)}return this.palette.defaultGradientColor}}]),t}();function ja(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}ke(xt,"id","TM"),xt.prototype.id="TM",xt.prototype.name="Temperature",xt.prototype.shortName="Temperature";gt=function(){A(t,Ca);var e=ja(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"_getColorByOccupancy",value:function(e,t){if(void 0===e)return this.palette.defaultGradientColor;e=1-e;return this.palette.getGradientColor(e,t.gradient)}},{key:"getAtomColor",value:function(e){var t=this.opts;return this._getColorByOccupancy(e.occupancy,t)}},{key:"getResidueColor",value:function(e){var t=this.opts;return this._getColorByOccupancy(e.occupancy,t)}}]),t}();function Ha(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}ke(gt,"id","OC"),gt.prototype.id="OC",gt.prototype.name="Occupancy",gt.prototype.shortName="Occupancy";lt=function(){A(t,Ca);var e=Ha(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"getAtomColor",value:function(e,t){return this.getResidueColor(e.residue,t)}},{key:"getResidueColor",value:function(e){var t=this.palette.defaultResidueColor;return void 0!==e._type.hydrophobicity&&(t=this.palette.getGradientColor((e._type.hydrophobicity- -4.5)/9,this.opts.gradient)),t}}]),t}();function Wa(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}ke(lt,"id","HY"),lt.prototype.id="HY",lt.prototype.name="Hydrophobicity",lt.prototype.shortName="Hydrophobicity";var Ya=function(){A(t,Ca);var e=Wa(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"getAtomColor",value:function(e,t){return this.getResidueColor(e.residue,t)}},{key:"getResidueColor",value:function(e,t){e=e._molecule,t=t.getMoleculeCount();return 1<t?this.palette.getGradientColor((e.index-1)/(t-1),this.opts.gradient):this.palette.getGradientColor(0,this.opts.gradient)}}]),t}();function Xa(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}ke(Ya,"id","MO"),Ya.prototype.id="MO",Ya.prototype.name="Molecule",Ya.prototype.shortName="Molecule";yn=function(){A(t,Ca);var e=Xa(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"getAtomColor",value:function(e){var t,n,r=this.opts.color,t=(t=r,(n=this.opts.factor)*(t>>16&255)<<16|n*(t>>8&255)<<8|n*(255&t));return e.flags&Te.Flags.CARBON?r:t}},{key:"getResidueColor",value:function(){return this.opts.color}}]),t}();ke(yn,"id","CB"),yn.prototype.id="CB",yn.prototype.name="Carbon",yn.prototype.shortName="Carbon";var qa=new qn([Ea,Ta,Ma,Ia,Da,Va,Fa,Ua,xt,gt,lt,Ya,yn]);function $a(e){return new ae.Color(e,e,e)}var Za,Ka,Qa,Ja=new qn([{id:"DF",name:"Diffuse",shortName:"Diffuse",uberOptions:{diffuse:$a(1),specular:$a(0),shininess:1,opacity:1},values:{lights:!0,fog:!0,depthWrite:!0,transparent:!1,toonShading:!1}},{id:"SF",name:"Soft Plastic",shortName:"Soft",uberOptions:{diffuse:$a(1),specular:$a(.1),shininess:30,opacity:1},values:{lights:!0,fog:!0,depthWrite:!0,transparent:!1,toonShading:!1}},{id:"PL",name:"Glossy Plastic",shortName:"Glossy",uberOptions:{diffuse:$a(.56),specular:$a(.28),shininess:100,opacity:1},values:{lights:!0,fog:!0,depthWrite:!0,transparent:!1,toonShading:!1}},{id:"ME",name:"Metal",shortName:"Metal",uberOptions:{diffuse:$a(.56),specular:$a(.55),shininess:30,opacity:1},values:{lights:!0,fog:!0,depthWrite:!0,transparent:!1,toonShading:!1}},{id:"TR",name:"Transparent",shortName:"Transparent",uberOptions:{diffuse:$a(1),specular:$a(0),shininess:1,opacity:.5},values:{lights:!0,fog:!0,depthWrite:!0,transparent:!0,toonShading:!1}},{id:"GL",name:"Glass",shortName:"Glass",uberOptions:{diffuse:$a(.5),specular:$a(.65),shininess:100,opacity:.5},values:{lights:!0,fog:!0,depthWrite:!0,transparent:!0,toonShading:!1}},{id:"BA",name:"Backdrop",shortName:"Backdrop",uberOptions:{diffuse:$a(1),specular:$a(0),shininess:1,opacity:1},values:{lights:!1,fog:!1,depthWrite:!1,transparent:!1,toonShading:!1}},{id:"TN",name:"Toon",shortName:"Toon",uberOptions:{diffuse:$a(1),specular:$a(0),shininess:1,opacity:1},values:{lights:!0,fog:!0,depthWrite:!0,transparent:!1,toonShading:!0}},{id:"FL",name:"Flat",shortName:"Flat",uberOptions:{diffuse:$a(1),specular:$a(0),shininess:0,opacity:1},values:{lights:!1,fog:!0,depthWrite:!0,transparent:!1}}]);function ec(e,t,n){var r=e.material.createInstance();r.setValues(t);r=new e.constructor(e.geometry,r);return r.material.needsUpdate=!0,r.applyMatrix4(e.matrix),r.layers.set(n),r}function tc(e,t,n){for(var r,i,o=(r=t,i=[],e.traverse(function(e){for(var t=0;t<r.length;t++)if(e instanceof r[t]){i[i.length]=e;break}}),i),s=0,a=o.length;s<a;++s){var c=o[s];c.parent&&n(c)}}function nc(e,i){!function e(t){t instanceof ae.Mesh&&i(t);for(var n=0,r=t.children.length;n<r;n++)e(t.children[n])}(e)}var rc={applyTransformsToMeshes:function(e,r){var i=r.length;i<1||tc(e,[ae.Mesh,ae.LineSegments,ae.Line],function(e){e.applyMatrix4(r[0]);for(var t=1;t<i;++t){var n=new e.constructor(e.geometry,e.material);e.parent.add(n),n.applyMatrix4(r[t])}})},processTransparentMaterial:function(e,t){t instanceof Qi&&tc(e,[ae.Mesh,ae.LineSegments],function(e){e.material.setValues({prepassTransparancy:!1,fakeOpacity:!1}),e.material.needsUpdate=!0,e.layers.set(Fn.LAYERS.TRANSPARENT);var t=ec(e,Za,Fn.LAYERS.PREPASS_TRANSPARENT);e.parent.add(t)})},processColFromPosMaterial:function(e,t){t instanceof Qi&&tc(e,[ae.Mesh,ae.LineSegments],function(e){var t=ec(e,Ka,Fn.LAYERS.COLOR_FROM_POSITION);e.parent.add(t)})},createShadowmapMaterial:(Qa={colorFromDepth:!0,orthoCam:!0,lights:!(Ka={colorFromPos:!0,transparent:!(Za={prepassTransparancy:!0,fakeOpacity:!1,transparent:!1,colorFromDepth:!1,lights:!1,shadowmap:!1,fog:!1}),colorFromDepth:!1,lights:!1,shadowmap:!1,fog:!1,overrideColor:!1,fogTransparent:!1,attrColor:!1,attrColor2:!1,attrAlphaColor:!1,fakeOpacity:!1}),shadowmap:!1,fog:!1},function(e,t){t instanceof Qi&&tc(e,[ae.Mesh,ae.LineSegments],function(e){var t;!e.receiveShadow&&e.material.shadowmap&&e.material.setValues({shadowmap:!1}),e.material.lights&&e.castShadow&&Fn.belongToSelectLayers(e)&&((t=ec(e,Qa,Fn.LAYERS.SHADOWMAP)).isShadowmapMesh=!0,e.parent.add(t))})}),removeShadowmapMaterial:function(e,t){t instanceof Qi&&tc(e,[ae.Mesh,ae.LineSegments],function(e){e.isShadowmapMesh&&e.parent.remove(e)})},forEachMeshInGroup:nc,countTriangles:function(e){var t=0;return nc(e,function(e){t+=function(e){var t=e.geometry;if(t instanceof ae.InstancedBufferGeometry){var n,r=t.attributes;for(n in r)if(r.hasOwnProperty(n)&&r[n]instanceof ae.InstancedBufferAttribute){var i=r[n];return(t.index?t.index.array.length/3:0)*i.array.length/i.itemSize}return 0}return t instanceof ae.BufferGeometry?t.index?t.index.array.length/3:0:t.faces?t.faces.length:0}(e)}),t}},ic=wn.selectors,oc=function(){function o(e,t,n,r){j(this,o);var i={clipPlane:oe.now.draft.clipPlane,fogTransparent:oe.now.bg.transparent,shadowmap:oe.now.shadow.on,shadowmapType:oe.now.shadow.type};this.index=e,this.mode=t,this.colorer=n,this.selector=r,this.selectorString="",this.count=0,this.material=new Qi,this.material.setValues(i),this.material.setUberOptions({fogAlpha:oe.now.fogAlpha}),this.materialPreset=Ja.first,this.needsRebuild=!0,this.visible=!0,this.setMode(t)}return _(o,[{key:"markAtoms",value:function(e){return this.count=e.markAtoms(this.selector,1<<this.index),this.needsRebuild=!0,this.count}},{key:"unmarkAtoms",value:function(e){e.clearAtomBits(1<<this.index),this.count=0}},{key:"setMode",value:function(e){this.mode=e}},{key:"setMaterialPreset",value:function(e){this.materialPreset=e,this.material.setUberOptions(e.uberOptions),this.material.setValues(e.values)}},{key:"reset",value:function(){this.geo=null,this.selectionGeo=null}},{key:"buildGeometry",value:function(e){return this.reset(),this.needsRebuild=!1,oe.now.ao&&this.material.setValues({normalsToGBuffer:oe.now.ao}),this.geo=this.mode.buildGeometry(e,this.colorer,1<<this.index,this.material),this.material.uberOptions.opacity<.99&&"prepass"===oe.now.transparency&&rc.processTransparentMaterial(this.geo,this.material),this.geo.visible=this.visible,Fn.processObjRenderOrder(this.geo,this.materialPreset.id),rc.processColFromPosMaterial(this.geo,this.material),oe.now.shadow.on&&rc.createShadowmapMaterial(this.geo,this.material),this.geo}},{key:"buildSelectionGeometry",value:function(e){var t=null;if(this.geo&&"getSubset"in this.geo){var n=this.geo.getSubset(e);if(n&&0<n.length){(t=new ae.Group).matrixAutoUpdate=!1,t.matrix=this.geo.matrix;for(var r=0;r<n.length;r++){var i=n[r];t.add(i)}}}return t&&(t.visible=this.visible),this.selectionGeo=t,this.selectionGeo}},{key:"compare",value:function(e){var t={},n=String(this.selector);e&&n.valueOf()===String(e.selector).valueOf()||(t.selector=n);n=this.mode.identify();e&&!Array.isArray(n)&&n===e.mode||(t.mode=n);n=this.colorer.identify();return e&&!Array.isArray(n)&&n===e.colorer||(t.colorer=n),e&&this.materialPreset.id===e.material||(t.material=this.materialPreset.id),t}},{key:"change",value:function(e,t,n,r){var i,o,s={};return e.selector&&(i=ic.parse(e.selector).selector,o=String(i),this.selectorString!==o&&(s.selector=o,this.selectorString=o,this.selector=i,this.markAtoms(t))),e.mode&&(t=e.mode,b.default.isEqual(this.mode.identify(),t)||(s.mode=t,this.setMode(n))),e.colorer&&(n=e.colorer,b.default.isEqual(this.colorer.identify(),n)||(s.colorer=n,this.colorer=r)),e.material&&(r=e.material,b.default.isEqual(this.materialPreset.id,r)||(s.material=r,this.setMaterialPreset(Ja.get(e.material)))),s}},{key:"show",value:function(e){this.visible=e,this.geo&&(this.geo.visible=e),this.selectionGeo&&(this.selectionGeo.visible=e)}}]),o}();function sc(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}function ac(){}var cc={ComponentEditor:function(){A(r,ac);var n=sc(r);function r(e){var t;return j(this,r),(t=n.call(this))._complexVisual=e,t._inProgress=!1,t}return _(r,[{key:"begin",value:function(){var e=this._complexVisual.getComplex();this._componentTransforms=[];for(var t=0;t<e._components.length;++t){var n=e._components[t];this._componentTransforms[n._index]=new ae.Object3D}return this._inProgress=!0}},{key:"apply",value:function(){if(this._inProgress){for(var e=this._complexVisual.getComplex(),t=0;t<e._components.length;++t)this._bakeComponentTransform(e._components[t]);e.onAtomPositionChanged(),this._resetComponentTransform(),this._complexVisual.finalizeEdit()}}},{key:"discard",value:function(){this._inProgress&&(this._resetComponentTransform(),this._complexVisual.finalizeEdit())}},{key:"getAltObj",value:function(){var t={objects:[],pivot:new ae.Vector3(0,0,0)},e=this._complexVisual,n=e.getSelectedComponent();if(null===n)return t;var r,i,o,s,a=this._complexVisual.getSelectionGeo(),c=1<<e.getSelectionBit();for(!function e(t,n,r){var i=t.children;if(i)for(var o=0,s=i.length;o<s;++o){var a=i[o];a._component===n&&r(a),a instanceof Fn.RCGroup&&e(a,n,r)}}(e,n,function(e){t.objects.push(e)}),r=0;r<a.children.length;++r)for(o=a.children[r],i=0;i<o.children.length;++i)(s=o.children[i]).hasOwnProperty("_component")&&s._component===n&&t.objects.push(s);t.objects.push(this._componentTransforms[n._index]);var l=new ae.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),u=new ae.Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return n.forEachResidue(function(e){var t=e._atoms;for(i=0;i<t.length;++i)t[i].mask&c&&(l.min(t[i].position),u.max(t[i].position))}),t.pivot.lerpVectors(l,u,.5),t}},{key:"_bakeComponentTransform",value:function(e){var r=this._componentTransforms[e._index];!r||0===r.position.x&&0===r.position.y&&0===r.position.z&&0===r.quaternion.x&&0===r.quaternion.y&&0===r.quaternion.z&&1===r.quaternion.w||(r.updateMatrix(),e.forEachResidue(function(e){for(var t=e._atoms,n=0;n<t.length;++n)t[n].position.applyMatrix4(r.matrix)}))}},{key:"_resetComponentTransform",value:function(){for(var e,t,n,r=this._complexVisual,i=this._complexVisual.getSelectionGeo(),o=0;o<this._componentTransforms.length;++o)(n=this._componentTransforms[o]).position.set(0,0,0),n.quaternion.set(0,0,0,1);for(o=0;o<r.children.length;++o)for(t=r.children[o],e=0;e<t.children.length;++e)(n=t.children[e]).hasOwnProperty("_component")&&(n.position.set(0,0,0),n.quaternion.set(0,0,0,1));for(o=0;o<i.children.length;++o)for(t=i.children[o],e=0;e<t.children.length;++e)(n=t.children[e]).hasOwnProperty("_component")&&(n.position.set(0,0,0),n.quaternion.set(0,0,0,1))}}]),r}(),FragmentEditor:function(){A(r,ac);var n=sc(r);function r(e){var t;return j(this,r),(t=n.call(this))._complexVisual=e,t._inProgress=!1,t}return _(r,[{key:"begin",value:function(){var e=this._complexVisual,t=this._complexVisual.getSelectionGeo(),n=this._getSelectionBorderAtoms();if(n.length<1||2<n.length)return B.error("Can only edit fragments with one or two bound atoms."),!1;this._fragmentBoundAtoms=n;var r=1<<e.getSelectionBit();e.disableSubset(r,!0);for(var i=0;i<t.children.length;++i)t.children[i].visible=!1;var o=n[0].position.clone();2===n.length&&o.lerp(n[1].position,.5),this._fragmentGeo=new ae.Group,e.add(this._fragmentGeo),this._fragmentGeo.position.copy(o),this._fragmentSelectionGeo=new ae.Group,t.add(this._fragmentSelectionGeo),this._fragmentSelectionGeo.position.copy(o);var s=o.clone();s.negate();for(var a=0;a<e.children.length;++a){var c=e.children[a];if("getSubset"in c){var l=new ae.Group;this._fragmentGeo.add(l);var u=new ae.Group;this._fragmentSelectionGeo.add(u);for(var h=c.getSubset(r,!0),f=0;f<h.length;f++){var d=h[f];l.add(d),d.position.copy(s)}for(var p=c.getSubset(r,!0),m=0;m<p.length;m++){var y=p[m];u.add(y),y.position.copy(s)}}}return Fn.applySelectionMaterial(this._fragmentSelectionGeo),this._inProgress=!0}},{key:"apply",value:function(){var e,t,n,r;this._inProgress&&(t=(e=this._complexVisual).getSelectionBit(),n=this._fragmentGeo.position,(r=this._fragmentGeo.matrix.clone()).multiply((new ae.Matrix4).makeTranslation(-n.x,-n.y,-n.z)),this._bakeAtomTransform(r,1<<t),e.enableSubset(1<<t,!0),e.getComplex().onAtomPositionChanged(),e.finalizeEdit())}},{key:"discard",value:function(){if(this._inProgress){var e=this._complexVisual,t=this._complexVisual.getSelectionGeo();this._fragmentGeo.parent.remove(this._fragmentGeo),e.enableSubset(1<<e.getSelectionBit(),!0);for(var n=0;n<t.children.length;++n){var r=t.children[n];r.visible?t.remove(r):r.visible=!0}e.finalizeEdit()}}},{key:"isFreeRotationAllowed",value:function(){return this._fragmentBoundAtoms.length<2}},{key:"getAltObj",value:function(){var e={objects:[],pivot:new ae.Vector3(0,0,0)};e.objects.push(this._fragmentGeo,this._fragmentSelectionGeo);var t,n=this._fragmentBoundAtoms;return 1===n.length?1===n[0].bonds.length&&(t=n[0].bonds[0],e.axis=(new ae.Vector3).subVectors(t._right.position,t._left.position),e.axis.normalize(),e.axis.transformDirection(this._complexVisual.matrixWorld)):2===n.length&&(e.axis=(new ae.Vector3).subVectors(n[1].position,n[0].position),e.axis.normalize(),e.axis.transformDirection(this._complexVisual.matrixWorld)),e}},{key:"_getSelectionBorderAtoms",value:function(){var e=this._complexVisual.getComplex(),t=1<<this._complexVisual.getSelectionBit(),n={};e.forEachBond(function(e){e._left.mask&t?0==(e._right.mask&t)&&(n[e._left.index]=1):e._right.mask&t&&(n[e._right.index]=1)});for(var r=[],i=Object.keys(n),o=0,s=i.length;o<s;++o){var a=i[o];r.push(e._atoms[a])}return r}},{key:"_bakeAtomTransform",value:function(t,n){this._complexVisual.getComplex().forEachAtom(function(e){e.mask&n&&e.position.applyMatrix4(t)})}}]),r}()};function lc(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var uc=wn.selectors;function hc(e,t){Array.isArray(t)||(t=[t]);var n=m(t,2),t=n[0],n=n[1];return new(e.get(t)||e.first)(n)}var fc=function(){A(o,Gn);var n=lc(o);function o(e,t){return j(this,o),(e=n.call(this,e,t))._complex=t,e._reprList=[],e._repr=null,e._reprListChanged=!0,e._selectionBit=0,e._reprUsedBits=0,e._selectionCount=0,e._selectionGeometry=new ae.Group,e}return _(o,[{key:"getBoundaries",value:function(){return this._complex.getBoundaries()}},{key:"release",value:function(){this._selectionGeometry.parent&&this._selectionGeometry.remove(this._selectionGeometry),Gn.prototype.release.call(this)}},{key:"getComplex",value:function(){return this._complex}},{key:"getSelectionCount",value:function(){return this._selectionCount}},{key:"getSelectionGeo",value:function(){return this._selectionGeometry}},{key:"getSelectionBit",value:function(){return this._selectionBit}},{key:"getEditor",value:function(){return this._editor}},{key:"resetReps",value:function(e){this._complex&&this._complex.clearAtomBits(-1),this._reprListChanged=!0,this._reprUsedBits=0,this._reprList.length=e.length;for(var t=0,n=e.length;t<n;++t){var r=e[t],i=void 0,o=void 0;"string"==typeof r.selector?(o=r.selector,i=uc.parse(o).selector):void 0===r.selector?(o=oe.now.presets.default[0].selector,i=uc.parse(o).selector):o=(i=r.selector).toString();var s=hc(ua,r.mode),a=hc(qa,r.colorer),r=Ja.get(r.material)||Ja.first;this._reprList[t]=new oc(t,s,a,i),this._reprList[t].setMaterialPreset(r),this._reprList[t].selectorString=o,this._complex&&this._complex.markAtoms(i,1<<t),this._reprUsedBits|=1<<t}this._repr=0<e.length?this._reprList[0]:null,this._selectionBit=e.length,this._reprUsedBits|=1<<this._selectionBit,this._selectionCount=0,this._complex&&this._complex.update()}},{key:"repCount",value:function(){return this._reprList.length}},{key:"repCurrent",value:function(e){return 0<=e&&e<this._reprList.length?this._repr=this._reprList[e]:e=this._reprList.indexOf(this._repr),e}},{key:"rep",value:function(e,t){if(!t&&(void 0===e||e instanceof Object)&&(t=e,e=this.repCurrent()),e<0||e>this._reprList.length)return B.error("Rep ".concat(e," does not exist!")),null;if(e===this._reprList.length){var n=this.repAdd(t);return B.warn("Rep ".concat(e," does not exist! New representation was created.")),{desc:n.desc,index:e,status:"created"}}var n=this._reprList[e],r={selector:n.selectorString,mode:n.mode.identify(),colorer:n.colorer.identify(),material:n.materialPreset.id};if(t){var i=n.change(t,this._complex,hc(ua,t.mode),hc(qa,t.colorer));if(!b.default.isEmpty(i)){for(var o in n.needsRebuild=!0,i)i.hasOwnProperty(o)&&(r[o]=i[o],B.debug("rep[".concat(e,"].").concat(o," changed to ").concat(i[o])));return i.mode&&n.mode.isSurface&&("ultra"===oe.now.resolution||"high"===oe.now.resolution)&&(B.report('Surface resolution was changed to "medium" to avoid hang-ups.'),oe.set("resolution","medium")),{desc:r,index:e,status:"changed"}}}return{desc:r,index:e,status:""}}},{key:"repGet",value:function(e){return(void 0===e||e instanceof Object)&&(e=this.repCurrent()),e<0||e>=this._reprList.length?null:this._reprList[e]}},{key:"_getFreeReprIdx",value:function(){for(var e=this._reprUsedBits,t=0;t<=o.NUM_REPRESENTATION_BITS;++t,e>>=1)if(0==(1&e))return t;return-1}},{key:"repAdd",value:function(e){if(this._reprList.length>=o.NUM_REPRESENTATION_BITS)return null;var t=this._getFreeReprIdx();if(t<0)return null;var n=this.buildSelectorFromMask(1<<this._selectionBit),r=oe.now.presets.default[0],i=b.default.merge({selector:r.selector,mode:r.mode,colorer:r.colorer,material:r.material},e),r=("string"==typeof i.selector?uc.parse(i.selector):i).selector,e=new oc(this._selectionBit,hc(ua,i.mode),hc(qa,i.colorer),r);return e.selectorString=r.toString(),e.setMaterialPreset(Ja.get(i.material)),e.markAtoms(this._complex),this._reprList.push(e),this._selectionBit=t,this._reprUsedBits|=1<<this._selectionBit,this._complex.markAtoms(n,1<<this._selectionBit),{desc:i,index:this._reprList.length-1}}},{key:"repRemove",value:function(e){void 0===e&&(e=this.repCurrent());var t,n=this._reprList.length;e<0||n<=e||n<=1||((t=this._reprList[e]).unmarkAtoms(this._complex),this._reprUsedBits&=~(1<<t.index),this._reprList.splice(e,1),t===this._repr&&(e=e<--n?e:n-1,this._repr=this._reprList[e]),this._reprListChanged=!0)}},{key:"repHide",value:function(e,t){void 0===t&&(t=!0),e<0||e>=this._reprList.length||this._reprList[e].show(!t)}},{key:"select",value:function(e,t){t?this._selectionCount+=this._complex.markAtomsAdditionally(e,1<<this._selectionBit):this._selectionCount=this._complex.markAtoms(e,1<<this._selectionBit),this._complex.updateStructuresMask(),this.rebuildSelectionGeometry()}},{key:"resetSelectionMask",value:function(){0!==this._selectionCount&&(this._selectionCount=0,this._complex&&this._complex.clearAtomBits(1<<this._selectionBit))}},{key:"updateSelectionMask",value:function(e){var t=this,n=e.atom,r=e.residue,i=e.chain,e=e.molecule,o=1<<this._selectionBit,s=~o;n?(r=n.residue,i=r._chain,e=r._molecule,n.mask&o?(n.mask&=s,r._mask&=s,i._mask&=s,e&&(e.mask&=s),this._selectionCount--):(n.mask|=o,this._selectionCount++,r.collectMask(),i.collectMask(),e&&e.collectMask())):r?(i=r._chain,e=r._molecule,r._mask&o?(r._mask&=s,i._mask&=s,r.forEachAtom(function(e){e.mask&o&&(e.mask&=s,t._selectionCount--)})):(r._mask|=o,r.forEachAtom(function(e){e.mask&o||(e.mask|=o,t._selectionCount++)}),i.collectMask(),e&&e.collectMask())):i||e?(e=i||e)._mask&o?(e._mask&=s,e.forEachResidue(function(e){e._mask&o&&(e._mask&=s,e.forEachAtom(function(e){e.mask&o&&(e.mask&=s,t._selectionCount--)}),e._mask&=s)})):(e._mask|=o,e.forEachResidue(function(e){e._mask&o||(e._mask|=o,e.forEachAtom(function(e){e.mask&o||(e.mask|=o,t._selectionCount++)}),(e=i?e.getMolecule():e.getChain())&&e.collectMask())})):this.resetSelectionMask()}},{key:"expandSelection",value:function(){var t=this,n=1<<this._selectionBit;this._complex.forEachBond(function(e){e._left.mask&n?0==(e._right.mask&n)&&(e._right.mask|=1<<31):e._right.mask&n&&(e._left.mask|=1<<31)});this._complex.forEachAtom(function(e){e.mask&1<<31&&(e.mask=e.mask&~(1<<31)|n,++t._selectionCount)}),this._complex.updateStructuresMask()}},{key:"shrinkSelection",value:function(){var t=this,n=1<<this._selectionBit;this._complex.forEachBond(function(e){e._left.mask&n?0==(e._right.mask&n)&&(e._left.mask|=1<<31):e._right.mask&n&&(e._right.mask|=1<<31)}),this._complex.forEachAtom(function(e){e.mask&n&&1===e.bonds.length&&(e.mask|=1<<31)});var r=~(n|1<<31);this._complex.forEachAtom(function(e){e.mask&1<<31&&(e.mask&=r,--t._selectionCount)}),this._complex.updateStructuresMask()}},{key:"getSelectedComponent",value:function(){var t=1<<this._selectionBit,n=null,r=!1;return this._complex.forEachAtom(function(e){e.mask&t&&(null===n?n=e.residue._component:n!==e.residue._component&&(r=!0))}),r?null:n}},{key:"getSelectionCenter",value:function(t,n,r){t.set(0,0,0);var i=0;return this._complex.forEachAtom(function(e){n(e,r)&&(t.add(e.position),i++)}),0!==i&&(t.divideScalar(i),t.applyMatrix4(this.matrix),!0)}},{key:"needsRebuild",value:function(){if(this._reprListChanged)return!0;for(var e=this._reprList,t=0,n=e.length;t<n;++t)if(e[t].needsRebuild)return!0;return!1}},{key:"rebuild",value:function(){var l=this;return Fn.clearTree(this),new Promise(function(s){var a,c=l._complex;c?(a=!1,setTimeout(function(){for(var e=l._reprList,t=Ra.get(oe.now.palette)||Ra.first,n=!1,r=0,i=e.length;r<i;++r){var o=e[r];if(o.colorer.palette=t,o.needsRebuild){o.reset();try{o.buildGeometry(c)}catch(e){if(!(e instanceof ce.OutOfMemoryError))throw e;o.needsRebuild=!1,o.reset(),B.error("Not enough memory to build geometry for representation ".concat(o.index+1)),a=!0}}n=a||n||Fn.groupHasGeometryToRender(o.geo),o.geo&&l.add(o.geo)}l._reprListChanged=!1,s()},10)):s()})}},{key:"setNeedsRebuild",value:function(){for(var e=this._reprList,t=0,n=e.length;t<n;++t)e[t].needsRebuild=!0}},{key:"rebuildSelectionGeometry",value:function(){var e=1<<this._selectionBit;Fn.clearTree(this._selectionGeometry);for(var t=0,n=this._reprList.length;t<n;++t){var r=this._reprList[t].buildSelectionGeometry(e);if(r){this._selectionGeometry.add(r);for(var i=0;i<r.children.length;i++){var o,s=r.children[i];this._editor&&this._editor._componentTransforms&&((o=this._editor._componentTransforms[s._component._index])&&(s.position.copy(o.position),s.quaternion.copy(o.quaternion)))}Fn.applySelectionMaterial(r)}}}},{key:"_buildSelectorFromSortedLists",value:function(e,t,n){var r=this._complex;function i(e){for(var t=[],n=0,r=NaN,i=NaN,o=0,s=e.length;o<s;++o){var a=e[o];a===i+1?i=a:(Number.isNaN(r)||(t[n++]=new uc.Range(r,i)),r=i=a)}return Number.isNaN(r)||(t[n]=new uc.Range(r,i)),t}var o,s=null;if(n.length===r._chains.length)s=uc.all();else{if(0<n.length&&(o=uc.chain(n),s=s?uc.or(s,o):o),0<Object.keys(t).length)for(var a in t)t.hasOwnProperty(a)&&(o=uc.and(uc.chain(a),uc.residx(i(t[a]))),s=s?uc.or(s,o):o);0<e.length&&(o=uc.serial(i(e)),s=s?uc.or(s,o):o),s=s||uc.none()}return s}},{key:"buildSelectorFromMask",value:function(n){var e=this._complex,t=[],r={},i=[];return e.forEachChain(function(e){e._mask&n&&t.push(e._name)}),e.forEachResidue(function(e){var t;e._mask&n&&!(e._chain._mask&n)&&((t=e._chain._name)in r?r[t].push(e._index):r[t]=[e._index])}),e.forEachAtom(function(e){e.mask&n&&!(e.residue._mask&n)&&i.push(e.serial)}),this._buildSelectorFromSortedLists(i,r,t)}},{key:"forSelectedResidues",value:function(t){var n=1<<this._selectionBit;this._complex.forEachResidue(function(e){e._mask&n&&t(e)})}},{key:"beginComponentEdit",value:function(){if(this._editor)return null;var e=new cc.ComponentEditor(this);return e.begin()?this._editor=e:null}},{key:"beginFragmentEdit",value:function(){if(this._editor)return null;var e=new cc.FragmentEditor(this);return e.begin()?this._editor=e:null}},{key:"finalizeEdit",value:function(){this._editor=null}},{key:"setMaterialValues",value:function(t,e,n){for(var r=1<arguments.length&&void 0!==e&&e,i=2<arguments.length&&void 0!==n?n:void 0,o=0,s=this._reprList.length;o<s;++o){var a=this._reprList[o];a.material.setValues(t),r&&a.geo.traverse(function(e){e instanceof ae.Mesh&&(e.material.setValues(t),void 0!==i&&i(e),e.material.needsUpdate=!0)})}}},{key:"setUberOptions",value:function(e){for(var t=0,n=this._reprList.length;t<n;++t)this._reprList[t].material.setUberOptions(e)}},{key:"within",value:function(e,t){var n=this._complex.getVoxelWorld();if(null===n)return!1;var r=1<<this._selectionBit;return this._complex.markAtoms(e,r),n&&n.forEachAtomWithinDistFromMasked(this._complex,r,Number(t),function(e){e.mask|=r}),this._selectionCount=this._complex.countAtomsByMask(r),this._complex.updateStructuresMask(),this.buildSelectorFromMask(r)}}]),o}();fc.NUM_REPRESENTATION_BITS=30;var dc="varying vec3 pos;\n\nvoid main() {\n  // we're assuming local position is in [-0.5, 0.5]\n  // we need to offset it to be represented in RGB\n  pos = position.xyz + 0.5;\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}",pc="varying vec3 pos;\n\nvoid main() {\n  gl_FragColor = vec4(pos, 0.5);\n}",mc="varying vec4 screenSpacePos;\n\nvoid main() {\n  screenSpacePos = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n  gl_Position = screenSpacePos;\n}",yc="uniform mat4 projectionMatrix;\n\n// 3D volume texture\nuniform vec3 volumeDim;    // volume dimensions, pixels\nuniform sampler2D tileTex; // tiled texture containing all Z-slices of a 3D data\nuniform vec2 tileTexSize;  // size of tiled texture, pixels\nuniform vec2 tileStride;   // UV stride between slices in tile tex, pixels\n\nuniform vec3 boxAngles;//value of angles({x: alpha, y:beta, z:gamma}) types 1 - if angle is obtuse, 0 - if acute\nuniform vec3 delta; //Projection box delta's from non-orthogonal origin axes; {x: XY, y : XZ, z: YZ}\n\nuniform vec3 _isoLevel0;\nuniform float _flipV;\nuniform sampler2D _BFLeft;\nuniform sampler2D _BFRight;\nuniform sampler2D _FFLeft;\nuniform sampler2D _FFRight;\nuniform sampler2D _WFFLeft;\nuniform sampler2D _WFFRight;\n\nvarying vec4 screenSpacePos;\n\n#define NO_COLOR vec4(0., 0., 0., 0.)\n\nvec4 sample3DTexture(vec3 texCoord) {\n  // a pair of Z slices is determined by nearest slice border\n  float zSliceBorder = floor(texCoord.z * volumeDim.z + 0.5);\n  float zSliceNumber1 = max(zSliceBorder - 1.0, 0.0);\n  float zSliceNumber2 = min(zSliceBorder, volumeDim.z - 1.0);\n\n  float rowTiles = floor(tileTexSize.x / tileStride.x);\n\n  // calculate coords in tile texture for both slices\n  vec2 tileOffset = vec2(mod(zSliceNumber1, rowTiles), floor(zSliceNumber1 / rowTiles));\n  vec2 texCoordSlice1 = (texCoord.xy * volumeDim.xy + tileOffset * tileStride) / tileTexSize.xy;\n  tileOffset = vec2(mod(zSliceNumber2, rowTiles), floor(zSliceNumber2 / rowTiles));\n  vec2 texCoordSlice2 = (texCoord.xy * volumeDim.xy + tileOffset * tileStride) / tileTexSize.xy;\n\n  // bilinear filtering\n  vec4 colorSlice1 = texture2D(tileTex, texCoordSlice1);\n  vec4 colorSlice2 = texture2D(tileTex, texCoordSlice2);\n  float weightSlice2 = texCoord.z * volumeDim.z - (zSliceNumber1 + 0.5);\n  return mix(colorSlice1, colorSlice2, weightSlice2);\n}\n\nvec4 sample3DTextureInclined(vec3 boxCoord) { // delta:{ x: XY, y : XZ, z: YZ }\n  vec3 textCoord = boxCoord;\n  vec2 currDelta = mix(boxCoord.zz, vec2(1., 1.) - boxCoord.zz, boxAngles.yx) * delta.yz;\n\n  textCoord.y = (boxCoord.y  - currDelta.y) / (1. - delta.z);\n  if (textCoord.y < 0.0 || textCoord.y > 1.0)\n    return NO_COLOR;\n\n  currDelta.x += mix(textCoord.y, 1.0 - textCoord.y, boxAngles.z) * delta.x;\n\n  textCoord.x = (boxCoord.x - currDelta.x) / (1. - delta.x - delta.y);\n  if (textCoord.x < 0.0 || textCoord.x > 1.0)\n    return NO_COLOR;\n\n  return sample3DTexture(textCoord);\n}\n\nfloat CalcColor(vec3 iter, vec3 dir) {\n  float d = 1. / 128.;\n  vec3 dx = vec3(d, 0.0, 0.0);\n  vec3 dy = vec3(0.0, d, 0.0);\n  vec3 dz = vec3(0.0, 0.0, d);\n\n  // #Opt: coordInc.x:(iter + dx).x > 1. ? 0.: sample3DTextureInclined(iter + dx).x,\n  vec3 coordInc = mix(\n    vec3(\n      sample3DTextureInclined(iter + dx).x,\n      sample3DTextureInclined(iter + dy).x,\n      sample3DTextureInclined(iter + dz).x\n    ),\n    vec3(0. ,0. , 0.),\n    vec3(floor((iter + dx).x), floor((iter + dy).y), floor((iter + dz).z))\n  );\n\n  // #Opt: coordDec.x:(iter - dx).x < 0. ? 0.: sample3DTextureInclined(iter - dx).x,\n  vec3 coordDec = mix(\n    vec3(0. ,0. , 0.),\n    vec3(\n      sample3DTextureInclined(iter - dx).x,\n      sample3DTextureInclined(iter - dy).x,\n      sample3DTextureInclined(iter - dz).x\n    ),\n    vec3(ceil((iter - dx).x), ceil((iter - dy).y), ceil((iter - dz).z))\n  );\n\n  vec3 N = normalize(coordInc - coordDec);\n  float dif = max(0.0, dot(N, dir));\n  return dif;\n}\n\nvec3 AccuracyIso(vec3 left, vec3 right, float volLeft, float threshold) {\n  for (int i = 0; i < 5; i++) {\n    vec3 iterator = 0.5 * (left + right);\n    float vol = sample3DTextureInclined(iterator).r;\n    if ((volLeft - threshold) * (vol - threshold) < 0.)\n      right = iterator;\n    else\n      left = iterator;\n  }\n  return 0.5 * (left + right);\n}\n\nvec3 CorrectIso(vec3 left, vec3 right, float tr) {\n  for (int j = 0; j < 5; j++) {\n    vec3 iterator = 0.5 * (left + right);\n    float vol = sample3DTextureInclined(iterator).r;\n    if (vol < tr)\n      right = iterator;\n    else\n      left = iterator;\n  }\n  return 0.5 * (left + right);\n}\n\nvec4 GetIso1(vec3 start, vec3 back, float molDist, vec3 dir, float tr, int count) {\n  float vol, stepSize = (float(count) + 2.) / float(STEPS_COUNT);\n  vec3 step = stepSize * dir, iterator = start, left, right;\n  vec4 acc = NO_COLOR;\n\n  for (int i = 0; i < STEPS_COUNT; i++) {\n    iterator = iterator + step;\n    vol = sample3DTextureInclined(iterator).r;\n    if (length(iterator - back) <= stepSize || (vol > tr))\n      break;\n  }\n\n  if (vol > tr)\n    acc = vec4(CorrectIso(iterator, iterator - step, tr).xyz, 1.);\n\n  return acc;\n}\n\nfloat easeOut(float x0, float x1, float x) {\n  float t = clamp((x - x0) / (x1 - x0), 0.0, 1.0);\n  return 1.0 - (1.0 - t) * (1.0 - t);\n}\n\nfloat easeIn(float x0, float x1, float x) {\n  float t = clamp((x - x0) / (x1 - x0), 0.0, 1.0);\n  return t * t;\n}\n\nvec3 GetColSimple(float vol) {\n  float t = easeOut(_isoLevel0.x, _isoLevel0.y, vol);\n  float s = easeIn(_isoLevel0.y, _isoLevel0.z, vol);\n  return vec3(0.5, 0.6, 0.7) * (1.0 - t) + 2.0 * vec3(s, 0, 0);\n}\n\nvec4 VolRender(vec3 start, vec3 back, float molDist, vec3 dir) {\n  vec4 acc = NO_COLOR, iso;\n  vec3 iterator = start, sumColor = vec3(0., 0., 0.);\n  float stepSize, alpha, sumAlpha = 0.0, vol, curStepSize, molD;\n  vec3 step, col, colOld, right;\n  float tr0 = _isoLevel0.x;\n  float dif, r, kd, finish;\n  int count = 0, stopMol = 0;\n\n  for (int k = 0; k < 3; k++) {\n    stepSize = (float(k) + 2.) / float(STEPS_COUNT);\n    kd = 140. * tr0 * stepSize;\n    r = 1. - kd;\n    step = stepSize * dir;\n    iso = GetIso1(iterator, back, molDist, dir, tr0, k);\n    if (iso.a < 0.1 || length(iso.xyz - start) > molDist)\n      break;\n    iterator = iso.xyz;\n    dif = 1.;// CalcColor(iterator, dir);\n    colOld = GetColSimple(tr0);\n    curStepSize = stepSize;\n    for (int i = 0; i < STEPS_COUNT; i++) {\n      iterator = iterator + step;\n      molD = length(iterator - start);\n      vol = sample3DTextureInclined(iterator).r;\n      finish = distance(iterator, back) - stepSize;\n      if (finish < 0.0 || vol < tr0 || (sumAlpha > 0.97) || molD > molDist)\n        break;\n      alpha = (1. - r);\n      col = GetColSimple(vol);\n      vol = sample3DTextureInclined(iterator - 0.5 * step).r;\n      vec3 colMid = GetColSimple(vol);\n      sumColor += (1. - sumAlpha) * (colOld + 4.* colMid + col) * alpha / 6.;\n      sumAlpha += (1. - sumAlpha) * alpha;// *(1. - 1.0*dif*dif);\n      colOld = col;\n    } // for i\n\n    if (finish < 0.0 || sumAlpha > 0.97)\n      break;\n\n    if (molD > molDist) {\n      curStepSize = stepSize - (molD - molDist);\n      right = iterator - (molD - molDist) * dir;\n      vol = sample3DTextureInclined(right).r;\n    } else {\n      vec3 left = iterator - step;\n      right = CorrectIso(left, iterator, tr0);\n      curStepSize = distance(left, right);\n      vol = tr0;\n    }\n\n    alpha = (1. - r) * curStepSize / stepSize;\n    dif = 1.;// CalcColor(right, dir);\n    col = GetColSimple(vol);\n    vol = sample3DTextureInclined(iterator - 0.5 * curStepSize / stepSize * step).r;\n    vec3 colMid = GetColSimple(vol);\n    sumColor += (1. - sumAlpha) * (colOld + 4. * colMid + col) * alpha / 6.;\n    sumAlpha += (1. - sumAlpha) * alpha;// *(1. - 1.0*dif*dif);\n\n    if (molD > molDist)\n      break;\n  } // for k\n  acc.rgb = 1. * sumColor / sumAlpha;\n  acc.a = sumAlpha;\n  return acc;\n}\n\nvec4 VolRender1(vec3 start, vec3 back, float molDist, vec3 dir) {\n  float stepSize = 1.0 / float(STEPS_COUNT);\n  float len = length(back - start);\n  vec3 step = stepSize * dir;\n  vec3 iterator = start;\n  float acc = 0.0;\n\n  for (int i = 0; i < STEPS_COUNT; i++) {\n    if (float(i) * stepSize > len)\n      break;\n    iterator = iterator + step;\n    if (sample3DTextureInclined(iterator).r > _isoLevel0.x)\n      acc += 10. * sample3DTextureInclined(iterator).r / float(STEPS_COUNT);\n  }\n\n  return vec4(1.,1.,1., acc);\n}\n\nvec4 IsoRender(vec3 start, vec3 back, float molDist, vec3 dir) {\n  vec4 tst = GetIso1(start, back, 2., dir, _isoLevel0.x, 0);\n  vec4 col = NO_COLOR;\n\n  if (length(tst.xyz - start) < molDist && tst.a > 0.1) {\n    float dif =  CalcColor(tst.xyz, dir);\n    dif = 0.9 * dif * dif;\n    col = vec4(dif, dif, dif, 1);\n  }\n  return col;\n}\n\nvec4 VolRender2(vec3 start, vec3 back, float molDist, vec3 dir) {\n  return sample3DTexture(start);\n}\n\nvoid main() {\n  vec3 tc = screenSpacePos.xyz / screenSpacePos.w * 0.5 + 0.5;\n\n  if (_flipV > 0.0) {\n    tc.y = 1.0 - tc.y;\n  }\n\n  vec3 start;\n  vec3 back;\n  vec3 molBack;\n  if (projectionMatrix[0][2] < 0.0) {\n    start = texture2D(_FFLeft, tc.xy).xyz;\n    back = texture2D(_BFLeft, tc.xy).xyz;\n    molBack = texture2D(_WFFLeft, tc.xy).xyz;\n  } else {\n    start = texture2D(_FFRight, tc.xy).xyz;\n    back = texture2D(_BFRight, tc.xy).xyz;\n    molBack = texture2D(_WFFRight, tc.xy).xyz;\n  }\n\n  vec3 dir = normalize(back - start);\n\n  float molDist = 2.0;\n  if (length(molBack) > 0.001) {\n    molDist = distance(start, molBack);\n  }\n\n  #ifdef ISO_MODE\n    gl_FragColor = IsoRender(start, back, molDist, dir);\n  #else\n    gl_FragColor = VolRender(start, back, molDist, dir);\n  #endif\n}\n",_c="varying vec4 volPos;\nuniform float aspectRatio;\nuniform float farZ;\nuniform float tanHalfFOV;\nuniform mat4  matWorld2Volume;\n\nvoid main() {\n  // rescale plane to fill in the whole far plane area seen from camera\n  vec3 pos = position.xyz;\n  pos.x = pos.x * tanHalfFOV * farZ * aspectRatio;\n  pos.y = pos.y * tanHalfFOV * farZ;\n  // common transformation\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);\n  // calc pos in volume CS\n  volPos = matWorld2Volume * modelMatrix * vec4(pos, 1.0);\n  // we're assuming local position is in [-0.5, 0.5]\n  // we need to offset it to be represented in RGB\n  volPos = volPos + 0.5;\n  volPos.w = 0.5;\n}\n",vc="varying vec4 volPos;\n\nvoid main() {\n  gl_FragColor = volPos;\n}";function gc(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var xc=ae.UniformsUtils.merge([{volumeDim:{type:"v3",value:new ae.Vector3(512,512,512)},tileTex:{type:"t",value:null},tileTexSize:{type:"v2",value:new ae.Vector2(512,512)},tileStride:{type:"v2",value:new ae.Vector2(512,512)},boxAngles:{type:"v3",value:new ae.Vector3(1,1,1)},delta:{type:"v3",value:new ae.Vector3(0,0,0)},_isoLevel0:{type:"v2",value:new ae.Vector3(.5,.75,1)},_flipV:{type:"f",value:0},_BFLeft:{type:"t",value:null},_BFRight:{type:"t",value:null},_FFLeft:{type:"t",value:null},_FFRight:{type:"t",value:null},_WFFLeft:{type:"t",value:null},_WFFRight:{type:"t",value:null}}]);function bc(e,t){var n,r=ae.UniformsUtils.clone(t);for(n in e)r.hasOwnProperty(n)&&(r[n].value=e[n]);return r}function wc(e,t){return{uniforms:bc(e,{}),vertexShader:dc,fragmentShader:pc,transparent:!1,depthTest:!1,depthWrite:!1,side:t}}var Sc=function(e){A(n,e);var t=gc(n);function n(e){j(this,n);e=wc(e,ae.BackSide);return t.call(this,e)}return n}(ae.ShaderMaterial),Rc=function e(t,n,r,i){j(this,e),this.uniforms=bc(t,n),this.vertexShader=r,this.fragmentShader=i,this.transparent=!1,this.depthTest=!1,this.depthWrite=!1,this.side=ae.FrontSide},Cc={BackFacePosMaterial:Sc,BackFacePosMaterialFarPlane:function(e){A(r,e);var n=gc(r);function r(e){j(this,r);var t=ae.UniformsUtils.merge([{aspectRatio:{type:"f",value:0},farZ:{type:"f",value:0},tanHalfFOV:{type:"f",value:0},matWorld2Volume:{type:"4fv",value:new ae.Matrix4}}]),t=new Rc(e,t,_c,vc);return n.call(this,t)}return r}(ae.ShaderMaterial),FrontFacePosMaterial:function(e){A(n,e);var t=gc(n);function n(e){j(this,n);e=wc(e,ae.FrontSide);return t.call(this,e)}return n}(ae.ShaderMaterial),VolumeMaterial:function(e){A(n,e);var t=gc(n);function n(e){j(this,n);var e=new Rc(e,xc,mc,yc);return e.transparent=!0,e.depthTest=!0,(e=t.call(this,e)).updateDefines(),e}return _(n,[{key:"updateDefines",value:function(){this.defines={ISO_MODE:oe.now.modes.VD.isoMode,STEPS_COUNT:100*oe.now.modes.VD.polyComplexity[oe.now.resolution]},this.needsUpdate=!0}}]),n}(ae.ShaderMaterial)};function Ac(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var Ec=function(e){A(b,e);var r=Ac(b);function b(){j(this,b);var e=new ae.BufferGeometry,t=r.call(this,e);ke(k(t),"volumeInfo",{}),t.clipPlane=new ae.Plane;var n=new ae.Vector3(.5,.5,.5);return t.size=n,t.cullFlag=[!0,!0,!0,!0,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1],t.faces=[{indices:[],norm:new ae.Vector3(0,0,-1)},{indices:[],norm:new ae.Vector3(0,0,1)},{indices:[],norm:new ae.Vector3(0,-1,0)},{indices:[],norm:new ae.Vector3(0,1,0)},{indices:[],norm:new ae.Vector3(-1,0,0)},{indices:[],norm:new ae.Vector3(1,0,0)},{indices:[],norm:new ae.Vector3(0,0,0)}],t.vertices=[new ae.Vector3(-n.x,-n.y,-n.z),new ae.Vector3(-n.x,n.y,-n.z),new ae.Vector3(n.x,-n.y,-n.z),new ae.Vector3(n.x,n.y,-n.z),new ae.Vector3(-n.x,-n.y,n.z),new ae.Vector3(-n.x,n.y,n.z),new ae.Vector3(n.x,-n.y,n.z),new ae.Vector3(n.x,n.y,n.z),new ae.Vector3(0,0,0),new ae.Vector3(0,0,0),new ae.Vector3(0,0,0),new ae.Vector3(0,0,0),new ae.Vector3(0,0,0),new ae.Vector3(0,0,0)],e.setAttribute("position",new ae.BufferAttribute(new Float32Array(3*t.vertices.length),3)),t.name="VolumeMesh",t}return _(b,[{key:"_updateVertices",value:function(){var e=b._corners,t=b._edges,n=b._edgeIntersections,r=this.clipPlane.normal,i=this.clipPlane.constant,o=this.vertices,s=this.size,a=[0,0,0,0,0,0,0,0],c=[1,1,1,1,1,1,1,1,1,1,1,1],l=new ae.Vector3,u=null;for(var h=0;h<12;++h){var f=t[h],u=n[h];l.set(f[2],f[3],f[4]),l.multiply(s);var d=0;0===f[2]&&(d=function(){if(0===r.x)return 0;var e=-(r.dot(l)+i)/r.x;return-s.x<=e&&e<=s.x?(u.set(e,l.y,l.z),e===s.x?2:e==-s.x?-2:1):0}()),0===f[3]&&(d=function(){if(0===r.y)return 0;var e=-(r.dot(l)+i)/r.y;return-s.y<=e&&e<=s.y?(u.set(l.x,e,l.z),e===s.y?2:e==-s.y?-2:1):0}()),0===f[4]&&(d=function(){if(0===r.z)return 0;var e=-(r.dot(l)+i)/r.z;return-s.z<=e&&e<=s.z?(u.set(l.x,l.y,e),e===s.z?2:e==-s.z?-2:1):0}()),-2===d?a[f[0]]=1:2===d?a[f[1]]=1:0===d&&(c[h]=0)}for(var p={indices:[],norm:r.clone().negate()},m=8,y=0;y<8;++y)1===a[y]&&(o[m].set(e[y][0],e[y][1],e[y][2]).multiply(s),p.indices.push(m++),c[e[y][3]]=0,c[e[y][4]]=0,c[e[y][5]]=0);for(y=0;y<12;++y)1===c[y]&&(o[m].copy(n[y]),p.indices.push(m++));this.faces[6]=p;var _=new ae.Vector3,v=new ae.Vector3;for(this.clipPlane.coplanarPoint(v),y=0;y<o.length;++y)this.cullFlag[y]=!1,y<8?(_.subVectors(o[y],v),this.cullFlag[y]=0<=r.dot(_)):y<8+p.indices.length&&(this.cullFlag[y]=!0);var g=this.geometry.getAttribute("position"),x=0;for(y=0;y<o.length;++y)g.array[x++]=o[y].x,g.array[x++]=o[y].y,g.array[x++]=o[y].z;g.needsUpdate=!0}},{key:"_collectVertices",value:function(e,t){var n,r=this.vertices;for(e.indices=[],n=0;n<r.length;++n)this.cullFlag[n]&&t(r[n])&&e.indices.push(n)}},{key:"_sortIndices",value:function(e,t){for(var n,r,i=this.vertices,o=[],s=new ae.Vector3,a=1;a<e.indices.length;++a)s.subVectors(i[e.indices[a]],i[e.indices[0]]),s.normalize(),s.cross(t),s.negate(),o[a]=e.norm.dot(s);for(a=1;a<e.indices.length-1;++a)for(n=a+1;n<e.indices.length;++n)o[n]<o[a]&&(r=o[a],o[a]=o[n],o[n]=r,r=e.indices[a],e.indices[a]=e.indices[n],e.indices[n]=r)}},{key:"_updateIndices",value:function(){var e,t=this.vertices,n=this.size;this._collectVertices(this.faces[0],function(e){return e.z===-n.z}),this._collectVertices(this.faces[1],function(e){return e.z===n.z}),this._collectVertices(this.faces[2],function(e){return e.y===-n.y}),this._collectVertices(this.faces[3],function(e){return e.y===n.y}),this._collectVertices(this.faces[4],function(e){return e.x===-n.x}),this._collectVertices(this.faces[5],function(e){return e.x===n.x});for(var r=new ae.Vector3,i=new ae.Vector3,o=new ae.Vector3,s=0;s<this.faces.length;++s)if(0!==(e=this.faces[s]).indices.length){for(r.set(0,0,0),l=0;l<e.indices.length;++l)r.add(t[e.indices[l]]);r.multiplyScalar(1/e.indices.length),i.subVectors(t[e.indices[0]],r),i.normalize();for(var a,c=[],l=0;l<e.indices.length;++l)o.subVectors(t[e.indices[l]],r),c[l]=o.dot(i);for(l=1;l<e.indices.length;++l)c[l]<c[0]&&(a=c[0],c[0]=c[l],c[l]=a,a=m(e.indices,1)[0],e.indices[0]=e.indices[l],e.indices[l]=a);this._sortIndices(e,i)}var u=0;for(s=0;s<this.faces.length;++s)3<=(e=this.faces[s]).indices.length&&(u+=3*(e.indices.length-2));var h=0,f=new Uint16Array(u);for(s=0;s<this.faces.length;++s)for(e=this.faces[s],l=0;l<e.indices.length-2;++l)f[h]=e.indices[0],f[h+1]=e.indices[l+1],f[h+2]=e.indices[l+2],h+=3;this.geometry.setIndex(new ae.BufferAttribute(f,1))}},{key:"setDataSource",value:function(e){var t=new Cc.VolumeMaterial,n=e.getDimensions(),r=e.getTiledTextureStride(),i=e.buildTiledTexture(),o=e.getBox();t.uniforms.volumeDim.value.set(n[0],n[1],n[2]),t.uniforms.tileTex.value=i,t.uniforms.tileTexSize.value.set(i.image.width,i.image.height),t.uniforms.tileStride.value.set(r[0],r[1]),Object.assign(this.volumeInfo,e.getVolumeInfo());e=this.volumeInfo;t.uniforms.delta.value.copy(e.delta),t.uniforms.boxAngles.value.set(e.obtuseAngle[0],e.obtuseAngle[1],e.obtuseAngle[2]),this.material=t,o.getSize(this.scale),o.getCenter(this.position)}},{key:"_updateIsoLevel",value:function(){var e=oe.now.modes.VD,t=e.kSigma,n=e.kSigmaMed,r=e.kSigmaMax,i=this.volumeInfo,o=i.dmean-i.dmin,s=i.dmax-i.dmin,e=function(e){return(o+e*i.sd)/s};this.material.uniforms._isoLevel0.value.set(e(t),e(n),e(r))}},{key:"rebuild",value:function(e){var t=b._nearClipPlaneOffset,n=b._pos,r=b._norm,i=b._norm4D,o=b._matrixWorldToLocal,s=b._clipPlane;this._updateIsoLevel(),e.getWorldDirection(r),e.getWorldPosition(n),n.addScaledVector(r,e.near+t),o.copy(this.matrixWorld).invert(),n.applyMatrix4(o),i.set(r.x,r.y,r.z,0),i.applyMatrix4(o),r.copy(i),r.normalize(),s.setFromNormalAndCoplanarPoint(r,n),this.clipPlane.equals(s)||(this.clipPlane=s.clone(),this._updateVertices(),this._updateIndices())}}]),b}(ae.Mesh);ke(Ec,"_corners",[[-1,-1,-1,0,4,8],[1,-1,-1,0,5,9],[1,1,-1,1,5,10],[-1,1,-1,1,4,11],[-1,-1,1,2,6,8],[1,-1,1,2,7,9],[1,1,1,3,7,10],[-1,1,1,3,6,11]]),ke(Ec,"_edges",[[0,1,0,-1,-1],[2,3,0,1,-1],[4,5,0,-1,1],[6,7,0,1,1],[0,3,-1,0,-1],[1,2,1,0,-1],[4,7,-1,0,1],[5,6,1,0,1],[0,4,-1,-1,0],[1,5,1,-1,0],[2,6,-1,1,0],[3,7,1,1,0]]),ke(Ec,"_edgeIntersections",function(){for(var e=[],t=0;t<12;++t)e.push(new ae.Vector3);return e}()),ke(Ec,"_nearClipPlaneOffset",.2),ke(Ec,"_pos",new ae.Vector3),ke(Ec,"_norm",new ae.Vector3),ke(Ec,"_norm4D",new ae.Vector4),ke(Ec,"_matrixWorldToLocal",new ae.Matrix4),ke(Ec,"_clipPlane",new ae.Plane);var kc=function(){function h(e,t){j(this,h);var n=t.delta,t=t.obtuseAngle,r=new ae.Vector3;e.getSize(r),r.multiplyScalar(.5);for(var i=this._getBaseVertices(n,t),t=new ae.BufferGeometry,o=[],s=0;s<4;s++)o.push(i[s].clone().multiply(r)),o.push(i[(s+1)%4].clone().multiply(r));for(var a=new ae.Vector3(2*r.x*(1-n.x-n.y),0,0),c=0;c<8;c++)o.push(o[c].clone().add(a));for(var l=0;l<4;l++)o.push(o[2*l].clone()),o.push(o[2*l+8].clone());var u=new ae.Vector3;e.getCenter(u),o.forEach(function(e){return e.add(u)});e=function(e){for(var t=e.length,n=new Float32Array(3*t),r=0;r<t;++r){var i=3*r,o=e[r];n[i]=o.x,n[1+i]=o.y,n[2+i]=o.z}return n}(o);t.setAttribute("position",new ae.BufferAttribute(e,3)),this._lines=new ae.LineSegments(t,new ae.LineBasicMaterial({color:16777215})),this._lines.layers.set(Fn.LAYERS.VOLUME)}return _(h,[{key:"_getBaseVertices",value:function(r,i){function e(e,t){var n=r[o[e][0]];return(-.5*(t-1)+t*i[o[e][1]])*n}var o=h._projectionTable;return[new ae.Vector3(2*(e("XZ",1)+e("XY",1))-1,2*e("YZ",1)-1,-1),new ae.Vector3(2*(e("XZ",-1)+e("XY",1))-1,2*e("YZ",-1)-1,1),new ae.Vector3(2*(e("XZ",-1)+e("XY",-1))-1,1-2*e("YZ",1),1),new ae.Vector3(2*(e("XZ",1)+e("XY",-1))-1,1-2*e("YZ",-1),-1)]}},{key:"getMesh",value:function(){return this._lines}}]),h}();ke(kc,"_projectionTable",{XY:["x",2],XZ:["y",1],YZ:["z",0]});var Tc=function(){function n(c,e,t){j(this,n);e=this._initPlaneGeo(e,t),t=new Cc.BackFacePosMaterialFarPlane;this._plane=new xo.Mesh(e,t),this._plane.frustumCulled=!1,this._plane.doubleSided=!0;var l=new ae.Matrix4;this._plane._onBeforeRender=function(e,t,n,r,i,o){var s,a=this.material;c&&a&&((s=new ae.Vector4(0,0,-(n.far-.1),1)).applyMatrix4(n.matrixWorld),this.matrix.identity(),this.matrix.makeTranslation(s.x,s.y,s.z),this.matrixWorld.copy(this.matrix),this.modelViewMatrix.multiplyMatrices(n.matrixWorldInverse,this.matrixWorld),this.normalMatrix.getNormalMatrix(this.modelViewMatrix),s=c.matrixWorld,l.copy(s).invert(),a.uniforms.aspectRatio.value=n.aspect,a.uniforms.farZ.value=n.far,a.uniforms.tanHalfFOV.value=Math.tan(.5*ae.MathUtils.DEG2RAD*n.fov),a.uniforms.matWorld2Volume.value=l)},this._plane.layers.set(Fn.LAYERS.VOLUME_BFPLANE)}return _(n,[{key:"_initPlaneGeo",value:function(e,t){var n=new ae.BufferGeometry;e=e||1,t=t||1;t=new Float32Array([-.5*e,.5*t,0,.5*e,.5*t,0,-.5*e,-.5*t,0,.5*e,-.5*t,0]);return n.setAttribute("position",new ae.BufferAttribute(t,3)),n.setIndex([0,2,1,2,3,1]),n}},{key:"getMesh",value:function(){return this._plane}}]),n}();function Pc(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var Mc=function(){A(r,Gn);var n=Pc(r);function r(e,t){return j(this,r),(e=n.call(this,e,t))._mesh=new Ec,e._mesh.setDataSource(t),e.add(e._mesh),e._frame=new kc(e.getBoundaries().boundingBox,e._mesh.volumeInfo),e.add(e._frame.getMesh()),e.showFrame(oe.now.modes.VD.frame),e._farPlane=new Tc(e._mesh,2,2),e.add(e._farPlane.getMesh()),e}return _(r,[{key:"getBoundaries",value:function(){var e=this._dataSource.getBox(),t=new ae.Sphere;return e.getBoundingSphere(t),{boundingBox:e,boundingSphere:t}}},{key:"getMesh",value:function(){return this._mesh}},{key:"showFrame",value:function(e){this._frame.getMesh().material.visible=e}}]),r}();function Nc(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}ot=function(){A(n,qn);var t=Nc(n);function n(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[];return j(this,n),t.call(this,e,["types"])}return _(n,[{key:"find",value:function(t){var e=[];if(t.type)e=this._dict.types[t.type.toLowerCase()]||[];else if(t.source)return this._list.filter(function(e){return e.canProbablyLoad&&e.canProbablyLoad(t.source)});return Yn(e)}}]),n}();function Ic(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var Lc=function(){A(i,O);var r=Ic(i);function i(e,t){var n;return j(this,i),(n=r.call(this))._source=e,n._options=t||{},n._abort=!1,n._agent=null,n}return _(i,[{key:"load",value:function(){return Promise.reject(new Error("Loading from this source is not implemented"))}},{key:"abort",value:function(){this._abort=!0,this._agent&&this._agent.abort()}}],[{key:"extractName",value:function(){}}]),i}();function Dc(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}$n(Lc.prototype);On=function(){A(r,Lc);var n=Dc(r);function r(e,t){return j(this,r),t=(e=n.call(this,e,t))._options,e._binary=!0===t.binary,e}return _(r,[{key:"load",value:function(){var i=this;return new Promise(function(e,t){if(i._abort)throw new Error("Loading aborted");var n=i._source,r=i._agent=new FileReader;r.addEventListener("load",function(){e(r.result)}),r.addEventListener("error",function(){t(r.error)}),r.addEventListener("abort",function(){t(new Error("Loading aborted"))}),r.addEventListener("progress",function(e){i.dispatchEvent(e)}),i._binary?r.readAsArrayBuffer(n):r.readAsText(n)})}}],[{key:"canProbablyLoad",value:function(e){return File&&e instanceof File||Blob&&e instanceof Blob}},{key:"extractName",value:function(e){return e&&e.name}}]),r}();function Oc(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}On.types=["file","blob"];var Vc=/^(https?|ftp):\/\//i,Mn=function(){A(r,Lc);var n=Oc(r);function r(e,t){return j(this,r),t=(e=n.call(this,e,t))._options,e._binary=!0===t.binary,e}return _(r,[{key:"load",value:function(){var i=this;return new Promise(function(e,t){if(i._abort)throw new Error("Loading aborted");var n=i._source,r=i._agent=new XMLHttpRequest;r.addEventListener("load",function(){200===r.status?e(r.response):t(new Error("HTTP ".concat(r.status," while fetching ").concat(n)))}),r.addEventListener("error",function(){t(new Error("HTTP request failed"))}),r.addEventListener("abort",function(){t(new Error("Loading aborted"))}),r.addEventListener("progress",function(e){i.dispatchEvent(e)}),r.open("GET",n),i._binary?r.responseType="arraybuffer":r.responseType="text",r.send()})}}],[{key:"canProbablyLoad",value:function(e){return b.default.isString(e)&&Vc.test(e)}},{key:"extractName",value:function(e){if(e){var t=(e.indexOf("?")+1||e.lastIndexOf("#")+1||e.length+1)-1;return e.slice(e.lastIndexOf("/",t)+1,t)}}}]),r}();function zc(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}Mn.types=["url"];Qn=function(){A(t,Lc);var e=zc(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"load",value:function(){var t=this;return new Promise(function(e){if(t._abort)throw new Error("Loading aborted");e(t._source)})}}],[{key:"canProbablyLoad",value:function(){return!1}}]),t}();Qn.types=["immediate"];ur=new ot([On,Mn,Qn]);function Fc(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var Vr=function(){A(n,qn);var t=Fc(n);function n(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[];return j(this,n),t.call(this,e,["formats","extensions"])}return _(n,[{key:"find",value:function(t){var e=[];return t.format?e=this._dict.formats[t.format.toLowerCase()]||[]:t.ext&&(e=this._dict.extensions[t.ext.toLowerCase()]||[]),0===e.length&&!t.format&&t.data?this._list.filter(function(e){return e.canProbablyParse&&e.canProbablyParse(t.data)}):Yn(e)}}]),n}(),Bc=function(){function n(e,t){j(this,n),this._data=e,this._options=t||{},this._abort=!1}return _(n,[{key:"parseSync",value:function(){throw new Error("Parsing this type of data is not implemented")}},{key:"parse",value:function(){var n=this;return new Promise(function(e,t){setTimeout(function(){try{return n._abort?t(new Error("Parsing aborted")):e(n.parseSync())}catch(e){return t(e)}})})}},{key:"getModel",value:function(){return this.model._parseHeader(this._data),this.model}},{key:"abort",value:function(){this._abort=!0}}]),n}();$n(Bc.prototype);Jr=function(){function e(){j(this,e),this.matrices=[],this._matrix=null,this._matrixIndex=-1}return _(e,[{key:"parse",value:function(e){var t,n,r=this._matrix;"  SMTRY"===e.readString(12,18)&&(t=e.readCharCode(19)-49,n=e.readString(20,80).trim().split(/\s+/),e=parseInt(n[0],10),null!==this._matrix&&e===this._matrixIndex||(this._matrixIndex=e,this._matrix=r=new ae.Matrix4,this.matrices[this.matrices.length]=r),(r=r.elements)[t]=parseFloat(n[1]),r[4+t]=parseFloat(n[2]),r[8+t]=parseFloat(n[3]),r[12+t]=parseFloat(n[4]))}}]),e}();Jr.prototype.id=290;var Uc=wn.Assembly,ni=function(){function t(e){j(this,t),this._complex=e,this.assemblies=[],this._assembly=null,this._matrix=null,this._matrixIndex=-1}return _(t,[{key:"parse",value:function(e){var t=this._assembly,n=this._matrix;if(t&&"  BIOMT"===e.readString(12,18)){var r=e.readCharCode(19)-49,i=e.readString(20,80).trim().split(/\s+/),o=parseInt(i[0],10);null!==this._matrix&&o===this._matrixIndex||(this._matrixIndex=o,this._matrix=n=new ae.Matrix4,t.addMatrix(n));n=n.elements;n[r]=parseFloat(i[1]),n[4+r]=parseFloat(i[2]),n[8+r]=parseFloat(i[3]),n[12+r]=parseFloat(i[4])}else if(t&&"CHAINS:"===e.readString(35,41))for(var s=e.readString(42,80).split(","),a=0,c=s.length;a<c;++a){var l=s[a].trim();0<l.length&&t.addChain(l)}else"BIOMOLECULE:"===e.readString(12,23)&&(this._matrix=null,this._matrixIndex=-1,this._assembly=t=new Uc(this._complex),this.assemblies.push(t))}}]),t}();ni.prototype.id=350;var Gc=function(){function t(e){j(this,t),this._data=e,this._start=0,this._nextCR=-1,this._nextLF=-1,this._next=-1,this._end=e.length,this.next()}return _(t,[{key:"readLine",value:function(){return this._data.slice(this._start,this._next)}},{key:"readChar",value:function(e){return(e=this._start+e-1)<this._next?this._data[e]:" "}},{key:"readCharCode",value:function(e){return(e=this._start+e-1)<this._next?this._data.charCodeAt(e):32}},{key:"readString",value:function(e,t){e=this._start+e-1,t=this._start+t;return this._data.slice(e,t<this._next?t:this._next)}},{key:"readInt",value:function(e,t){return parseInt(this.readString(e,t),10)}},{key:"readFloat",value:function(e,t){return parseFloat(this.readString(e,t))}},{key:"end",value:function(){return this._start>=this._end}},{key:"next",value:function(){var e=this._next+1;this._start=e<this._end?e:this._end,this._start>this._nextCR&&(this._nextCR=(this._data.indexOf("\r",this._start)+1||this._end+1)-1),this._start>this._nextLF&&(this._nextLF=(this._data.indexOf("\n",this._start)+1||this._end+1)-1),this._next=this._nextCR+1<this._nextLF?this._nextCR:this._nextLF}}]),t}();function jc(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var Hc=wn.Complex,Wc=wn.Element,Yc=wn.Helix,Xc=wn.Sheet,qc=wn.Strand,$c=wn.Bond,Zc=wn.Molecule;var Kc=/^(HEADER\s|COMPND\s|REMARK\s|ATOM {2}|HETATM|MODEL )/i,Qc={290:Jr,350:ni},ci=function(){A(r,Bc);var n=jc(r);function r(e,t){return j(this,r),(t=n.call(this,e,t))._complex=null,t._chain=null,t._residue=null,t._sheet=null,t._serialAtomMap=null,t._modelId=1,t._compaundFound=!1,t._biomoleculeFound=!1,t._allowedChainsIDs=null,t._lastMolId=-1,t._remarks={},t._remark=null,t._molecules=[],t._molecule=null,t._compndCurrToken="",t._options.fileType="pdb",t}return _(r,[{key:"_finalize",value:function(){this._fixBondsArray(),this._fixChains();var e=this._remarks[290];this._complex.symmetry=b.default.isUndefined(e)?[]:e.matrices;e=this._remarks[350];this._complex.units=this._complex.units.concat(b.default.isUndefined(e)?[]:e.assemblies),this._finalizeMolecules(),this._complex.finalize({needAutoBonding:!0,detectAromaticLoops:this.settings.now.aromatic,enableEditing:this.settings.now.editing,serialAtomMap:this._serialAtomMap})}},{key:"_finalizeMolecules",value:function(){for(var e={},t=this._complex._chains,n=0;n<t.length;++n){var r=t[n];e[r._name]=r}for(n=0;n<this._molecules.length;n++){for(var i=this._molecules[n],o=[],s=0;s<i._chains.length;s++)var a=e[i._chains[s]],o=o.concat(a._residues.slice());var c=new Zc(this._complex,i._name,n+1);c.residues=o,this._complex._molecules[n]=c}}},{key:"_fixChains",value:function(){for(var e={},t=this._complex,n=0;n<t._chains.length;n++){var r=t._chains[n];e[r._name.charCodeAt(0)]=r}}},{key:"_fixBondsArray",value:function(){for(var e=this._serialAtomMap={},t=this._complex,n=t._atoms,r=0,i=n.length;r<i;++r){var o=n[r];e[o.serial]=o}for(var s=t._bonds,a=this.logger,c=0,l=s.length;c<l;++c){var u=s[c];u._right<u._left&&a.debug("_fixBondsArray: Logic error."),u._left=e[u._left]||null,u._right=e[u._right]||null}}},{key:"_parseATOM",value:function(e){var t,n,r,i,o,s,a,c,l,u,h,f,d,p,m,y;1===this._modelId&&(n=(t=72===e.readCharCode(1))?e.readInt(7,11):e.readInt(6,11),r=e.readString(13,16),i=e.readChar(17),o=e.readString(18,20).trim(),m=e.readChar(22),s=e.readInt(23,26),a=e.readChar(27),c=e.readFloat(31,38),l=e.readFloat(39,46),y=e.readFloat(47,54),u=e.readFloat(55,60),h=e.readFloat(61,66),p=e.readString(77,78).trim()||(d=4===(f=r).trim().length,f.slice(0,d?1:2).trim()),f=e.readInt(79,80)||0,this.settings.now.nowater&&("HOH"===o||"WAT"===o)||(r=r.trim(),d=Wc.getByName(p),e=Wc.Role[r],(p=this._chain)&&p.getName()===m||(this._chain=p=this._complex.getChain(m)||this._complex.addChain(m),this._residue=null),(m=this._residue)&&m.getSequence()===s&&m.getICode()===a||(this._residue=m=p.addResidue(o,s,a)),y=new ae.Vector3(c,l,y),m.addAtom(r,d,y,e,t,n,i,u,h,f)))}},{key:"_parseENDMDL",value:function(){this._modelId+=1}},{key:"_parseCONECT",value:function(e){var t=e.readInt(7,11),n=e.readInt(12,16),r=e.readInt(17,21),i=e.readInt(22,26),o=e.readInt(27,31),e=this._complex;n&&t<n&&e.addBond(t,n,0,$c.BondType.UNKNOWN,!0),r&&t<r&&e.addBond(t,r,0,$c.BondType.UNKNOWN,!0),i&&t<i&&e.addBond(t,i,0,$c.BondType.UNKNOWN,!0),o&&t<o&&e.addBond(t,o,0,$c.BondType.UNKNOWN,!0)}},{key:"_parseCOMPND",value:function(e){var t=e.readString(11,80),e=t.indexOf(":");this._compndCurrToken=0<e?t.substring(0,e).trim():this._compndCurrToken,"MOL_ID"===this._compndCurrToken?(this._molecule={_index:"",_chains:[]},this._molecule._index=parseInt(t.substring(e+1,t.indexOf(";")),10),this._molecules.push(this._molecule)):"MOLECULE"===this._compndCurrToken&&null!=this._molecule?this._molecule._name=t.substring(e+1,t.indexOf(";")).trim():"CHAIN"===this._compndCurrToken&&null!=this._molecule&&(";"!==(e=(t=t.substring(e+1,80).trim())[t.length-1])&&","!==e||(t=t.slice(0,-1)),t=(t=t.replace(/\s+/g,"")).split(","),this._molecule._chains=this._molecule._chains.concat(t))}},{key:"_parseREMARK",value:function(e){var t,n=e.readInt(8,10),r=this._remarks[n];b.default.isUndefined(r)&&(t=Qc[n],b.default.isFunction(t)&&(this._remarks[n]=r=new t(this._complex))),b.default.isUndefined(r)||r.parse(e)}},{key:"_parseHELIX",value:function(e){var t=this;this._parseSTRUCTURE(e,[20,22,32,34],function(e){t._complex.addHelix(e),t._complex.structures.push(e)})}},{key:"_parseSHEET",value:function(e){var t=this;this._parseSTRUCTURE(e,[22,23,33,34],function(e){t._complex.addSheet(e)})}},{key:"_parseSTRUCTURE",value:function(e,t,n){var r=e.readInt(8,10),i=e.readString(12,14).trim(),o=e.readString(41,70).trim(),s=e.readInt(72,76),a=e.readInt(39,40),c=e.readInt(15,16),l=e.readInt(42,45),u=e.readInt(57,60),h=e.readString(t[0],t[2]+1).charCodeAt(0),f=e.readString(t[2],t[2]+1).charCodeAt(0),d=e.readInt(t[1],t[1]+3),p=e.readString(t[1]+4,t[1]+4),m=0;0<p.length&&(m=p.charCodeAt(0));var y,_=e.readInt(t[3],t[3]+3),v=0;0<(p=e.readString(t[3]+4,t[3]+4)).length&&(v=p.charCodeAt(0));p=this._sheet;83===e.readCharCode(1)?(null!==p&&p.getName()!==i&&(p=null,this._sheet=null),null===p?(this._sheet=y=new Xc(i,c),n(y)):y=p,u=new qc(y,this._complex.getUnifiedSerial(h,d,m),this._complex.getUnifiedSerial(f,_,v),a,l,u),y.addStrand(u),this._complex.structures.push(u)):n(y=new Yc(a,this._complex.getUnifiedSerial(h,d,m),this._complex.getUnifiedSerial(f,_,v),r,i,o,s))}},{key:"_parseHEADER",value:function(e){var t=this._complex.metadata;t.classification=e.readString(11,50).trim(),t.date=e.readString(51,59).trim();e=e.readString(63,66).trim();(t.id=e)&&(this._complex.name=e),t.format="pdb"}},{key:"_parseTITLE",value:function(e){var t=this._complex.metadata;t.title=t.title||[];var n=e.readInt(9,10)||1;t.title[n-1]=e.readString(11,80).trim()}},{key:"parseSync",value:function(){for(var e=new Gc(this._data),t=this._complex=new Hc;!e.end();){var n=e.readString(1,6),n=r.tagParsers[n];b.default.isFunction(n)&&n.call(this,e),e.next()}if(this._finalize(),this._serialAtomMap=null,this._sheet=null,this._residue=null,this._chain=null,this._complex=null,0===t.getAtomCount())throw new Error("The data does not contain valid atoms");return t}}],[{key:"canProbablyParse",value:function(e){return b.default.isString(e)&&Kc.test(e)}}]),r}();function Jc(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}ke(ci,"tagParsers",{HEADER:ci.prototype._parseHEADER,"TITLE ":ci.prototype._parseTITLE,"ATOM  ":ci.prototype._parseATOM,HETATM:ci.prototype._parseATOM,ENDMDL:ci.prototype._parseENDMDL,CONECT:ci.prototype._parseCONECT,COMPND:ci.prototype._parseCOMPND,REMARK:ci.prototype._parseREMARK,"HELIX ":ci.prototype._parseHELIX,"SHEET ":ci.prototype._parseSHEET,"ATOM 1":ci.prototype._parseATOM,"ATOM 2":ci.prototype._parseATOM,"ATOM 3":ci.prototype._parseATOM,"ATOM 4":ci.prototype._parseATOM,"ATOM 5":ci.prototype._parseATOM,"ATOM 6":ci.prototype._parseATOM,"ATOM 7":ci.prototype._parseATOM,"ATOM 8":ci.prototype._parseATOM,"ATOM 9":ci.prototype._parseATOM}),ci.formats=["pdb"],ci.extensions=[".pdb",".ent"];var el=wn.Complex,tl=wn.Element,nl=wn.SGroup,rl=wn.Bond,il={A:0,S:1,D:2,T:3},ol=/\s*<\?xml\b[^?>]*\?>\s*<(?:cml|molecule)\b/i,Ri=function(){A(r,Bc);var n=Jc(r);function r(e,t){return j(this,r),(t=n.call(this,e,t))._complex=null,t._residue=null,t._serialAtomMap=null,t._modelId=1,t._lastMolId=-1,t._readOnlyOneMolecule=!1,t._options.fileType="cml",t}return _(r,[{key:"_rebuidBondIndexes",value:function(e,t){for(var n=e.length,r=0;r<n;r++)for(var i=e[r].id,o=t.length,s=0;s<o;s++){var a=t[s].atomRefs2.split(" ");a[0]===i&&(t[s].start=r),a[1]===i&&(t[s].end=r)}}},{key:"_createSGroup",value:function(e,t){var n=new nl(e.id,e.fieldData,new ae.Vector3(parseFloat(e.x),parseFloat(e.y),0),e.atomRefs,e);"Relative"===e.placement&&(n._center=new ae.Vector3(0,0,0)),"MDLBG_FRAGMENT_CHARGE"===e.fieldName&&(n._charge=parseInt(e.fieldData,10)||0),"MDLBG_FRAGMENT_COEFFICIENT"===e.fieldName&&(n._repeat=parseInt(e.fieldData,10)||1),t.push(n)}},{key:"_extractSGroup",value:function(e,t){if(Array.isArray(t)||(t=[]),e)if(Array.isArray(e))for(var n=e.length,r=0;r<n;r++)e[r].molecule&&(t=t.concat(this._extractSGroup(e[r].molecule))),this._createSGroup(e[r],t);else e.molecule&&e.molecule&&(t=t.concat(this._extractSGroup(e.molecule))),this._createSGroup(e,t);return t}},{key:"_extractSGroups",value:function(e,t){for(var n=this._extractSGroup(e),r=t.length,i=0;i<r;i++)for(var o=t[i].id,s=0;s<n.length;s++)n[s]._atoms.split(" ")[0]===o&&(t[i].sgroupRef||(t[i].sgroupRef=[]),t[i].sgroupRef.push(n[s]));var a,c={},l=null,u=new ae.Vector3(1e8,1e8,1e8),h=new ae.Vector3(-1e8,-1e8,-1e8);function f(e){(l=c[e])&&n[s]._atoms.push(l.a)}function d(e){(l=c[e])&&(u.set(Math.min(u.x,l.x),Math.min(u.y,l.y),Math.min(u.z,l.z)),h.set(Math.max(h.x,l.x),Math.max(h.y,l.y),Math.max(h.z,l.z)),f(e))}for(i=0;i<t.length;i++)c[t[i].id]={},c[t[i].id].x=t[i].x2,t[i].x3&&(c[t[i].id].x=t[i].x3),c[t[i].id].x=parseFloat(c[t[i].id].x),c[t[i].id].y=t[i].y2,t[i].y3&&(c[t[i].id].y=t[i].y3),c[t[i].id].y=parseFloat(c[t[i].id].y),c[t[i].id].z="0.0",t[i].z3&&(c[t[i].id].z=t[i].z3),c[t[i].id].z=parseFloat(c[t[i].id].z),c[t[i].id].a=t[i];for(s=0;s<n.length;s++)null!==n[s]._center?(u.set(1e8,1e8,1e8),h.set(-1e8,-1e8,-1e8),a=n[s]._atoms.split(" "),n[s]._atoms=[],a.forEach(d),n[s]._center.addVectors(u,h),n[s]._center.multiplyScalar(.5)):(a=n[s]._atoms.split(" "),n[s]._atoms=[],a.forEach(f));c=null}},{key:"_traverseData",value:function(e){var t={};return e.childNodes.length&&function e(t,n){if("#text"!==t.nodeName||""!==t.nodeValue.trim()){var r,i,o,s={},a=n[(s.xmlNode=t).nodeName];if(a?(r=a,"[object Array]"!==Object.prototype.toString.apply(r)?n[t.nodeName]=[a,s]:n[t.nodeName].push(s)):n[t.nodeName]=s,t.attributes)for(i=t.attributes.length,o=0;o<i;o++){var c=t.attributes[o];s[c.nodeName]=c.nodeValue}for(i=t.childNodes.length,o=0;o<i;o++)e(t.childNodes[o],s)}}(e.childNodes[0],t),t}},{key:"_findSuitableMolecule",value:function(e,t){for(var n in e)if("xmlNode"!==n)if("molecule"===n){if(e.molecule&&(e.molecule.atomArray&&e.molecule.atomArray.atom&&t.push(e),Array.isArray(e.molecule)))for(var r=0;r<e.molecule.length;r++)e.molecule[r].atomArray&&e.molecule[r].atomArray.atom&&t.push({molecule:e.molecule[r]})}else e[n]&&null!==e[n]&&"object"===E(e[n])&&this._findSuitableMolecule(e[n],t)}},{key:"_selectComponents",value:function(e){var h=(new DOMParser).parseFromString(e,"application/xml"),t=this._traverseData(h),f=this;e=t.cml||t;var n=[],t=[];return this._findSuitableMolecule(e,t),this._readOnlyOneMolecule&&1<t.length&&t.splice(1,t.length-1),t.forEach(function(e){e=function(e){var t,n=[];if(e.molecule&&e.molecule.atomArray&&e.molecule.atomArray.atom)Array.isArray(e.molecule.atomArray.atom)?n=e.molecule.atomArray.atom:n.push(e.molecule.atomArray.atom);else if(!e.molecule){var r={atomLabels:null,labelsCount:1};return r}e.molecule.molecule&&f._extractSGroups(e.molecule.molecule,n);for(var i=n.length,o=0;o<i;o++)(t=n[o]).edges=[];var s=[];e.molecule.bondArray&&e.molecule.bondArray.bond&&(Array.isArray(e.molecule.bondArray.bond)?s=e.molecule.bondArray.bond:s.push(e.molecule.bondArray.bond)),i=s.length,f._rebuidBondIndexes(n,s);for(var a,c,l=0;l<i;l++)c=s[l],(t=n[c.start])&&(t.edges.push(c.end),(t=n[c.end])?(t.edges.push(c.start),1):void 0)&&(a=c.xmlNode.getAttribute("order"),c=parseInt(a,10),s[l].order=0,s[l].type=rl.BondType.UNKNOWN,1<c?s[l].order=c:void 0!==(c=il[a])&&(s[l].order=c,"A"===a&&(s[l].type=rl.BondType.AROMATIC)));i=n.length;for(var u=0;u<i;u++)(t=n[u]).edges.sort();return r=f._breadWidthSearch(n,0),(e={}).atoms=n,e.bonds=s,e.labels=r.atomLabels,e.count=Math.min(1,r.labelsCount),e.curr=-1,e.originalCML=h,e}(e);0<e.atoms.length&&n.push(e)}),n}},{key:"_packLabel",value:function(e,t){return(t<<16)+e}},{key:"_unpackLabel",value:function(e){return{molId:e>>>16,compId:65535&e}}},{key:"_breadWidthSearch",value:function(e,t){var n=new Array(e.length);for(a=0;a<n.length;a++)n[a]=this._packLabel(0,t);for(var r=[],i=0,o=e.length;0<o;){i++;for(var s=-1,a=0;a<n.length;a++)if(0===this._unpackLabel(n[a]).compId){s=a;break}if(s<0)break;for(r.push(e[s]),n[s]=this._packLabel(i,t),o--;0<r.length;){var c=r.shift();if(c)for(var l=0;l<c.edges.length;l++)n[c.edges[l]]!==i&&(r.push(e[c.edges[l]]),n[c.edges[l]]=i,o--)}}var u={};return u.atomLabels=n,u.labelsCount=i,u}},{key:"_parseBond",value:function(e,t,n,r){0<=e&&(t=[Math.min(e,t),Math.max(e,t)],this._complex.addBond(t[0],t[1],n,r,!0))}},{key:"_fixBondsArray",value:function(){for(var e=this._serialAtomMap={},t=this._complex,n=t._atoms,r=0,i=n.length;r<i;++r){var o=n[r];e[o.serial]=o}for(var s=t._bonds,a=this.logger,c=0,l=s.length;c<l;++c){var u=s[c];u._right<u._left&&a.debug("_fixBondsArray: Logic error."),u._left=e[u._left]||null,u._right=e[u._right]||null}}},{key:"_parseSet",value:function(e){var t=this._complex=new el,n=e,r=n.curr,i=n.atoms,o=n.labels,s=null,a=i.length;for(var c,l={},u=[],h=0;h<a;h++)u.push(h);for(u.sort(function(e,t){return o[e]-o[t]}),h=0;h<a;h++){var f=o[u[h]];if(this._unpackLabel(f).molId===this._unpackLabel(r).molId){var d,p,m,y,_=(s=i[u[h]]).elementType;if(s.sgroupRef)for(var v=s.sgroupRef.length,g=0;g<v;++g)t._sgroups.push(s.sgroupRef[g]);(s.x3||s.x2)&&(0,1===(d=(m=this._unpackLabel(f).compId).toString()).length&&(d="0".concat(d)),p="N".concat(d),(f=l[" "])&&" "===f.getName()||(l[" "]=f=this._complex.getChain(" ")||this._complex.addChain(" "),this._residue=null),(d=this._residue)&&d.getSequence()===m&&" "===d.getICode()||(this._residue=d=f.addResidue(p,m," ")),f=null,s.x3?f=new ae.Vector3(parseFloat(s.x3),parseFloat(s.y3),parseFloat(s.z3)):s.x2&&(f=new ae.Vector3(parseFloat(s.x2),parseFloat(s.y2),0)),(p=tl.ByName[s.elementType.toUpperCase()])||((p=JSON.parse(JSON.stringify(tl.ByName[Object.keys(tl.ByName)[Object.keys(tl.ByName).length-1]]))).number+=1,p.name=s.elementType.toUpperCase(),p.fullName="Unknown",tl.ByName[s.elementType.toUpperCase()]=p),m=parseInt(s.id.replace(/[^0-9]/,""),10),y=d.addAtom(_,p,f,tl.Role.SG,!0,m," ",1,0,0),s.hydrogenCount&&(y.hydrogenCount=parseInt(s.hydrogenCount,10)),s.mrvValence&&(y.valence=parseInt(s.mrvValence,10)),((c=y).xmlNodeRef=s).x2&&(s.x3=s.x2,delete s.x2),s.y2&&(s.y3=s.y2,delete s.y2),s.z3||(s.z3="0.0"),s.complexAtom=c)}}for(l=null,h=0;h<n.bonds.length;h++){var x=n.bonds[h];this._unpackLabel(o[x.start]).molId===this._unpackLabel(r).molId&&this._unpackLabel(o[x.end]).molId===this._unpackLabel(r).molId&&(s=i[x.start])&&i[x.end]&&this._parseBond(parseInt(s.id.replace(/[^0-9]/,""),10),parseInt(i[x.end].id.replace(/[^0-9]/,""),10),x.order,x.type)}for(h=0;h<this._complex.getSGroupCount();h++)for(var b=this._complex.getSGroups()[h],w=0;w<b._atoms.length;w++)b._atoms[w]=b._atoms[w].complexAtom;for(h=0;h<a;h++)this._unpackLabel(o[h]).molId===this._unpackLabel(r).molId&&((s=i[h]).complexAtom=null,delete s.complexAtom);return this._complex.originalCML=n.originalCML,this._fixBondsArray(),t.finalize({needAutoBonding:!1,detectAromaticLoops:this.settings.now.aromatic,enableEditing:this.settings.now.editing,serialAtomMap:this._serialAtomMap}),this._serialAtomMap=null,this._complex=null,t}},{key:"parseSync",value:function(){var n=[],r=this;this._selectComponents(this._data).forEach(function(e){e.curr=2,0===e.count&&(e.count=1);for(var t=0;t<e.count;t++)e.curr=t+1,n.push(r._parseSet(e,!1))});var t=0;if(n.forEach(function(e){t+=e.getAtomCount()}),t<=0)throw new Error("The data does not contain valid atoms");if(1<n.length){var e=new el;return e.joinComplexes(n),e.originalCML=n[0].originalCML,e}return 1===n.length?n[0]:new el}}],[{key:"canProbablyParse",value:function(e){return b.default.isString(e)&&ol.test(e)}}]),r}();Ri.formats=["cml"],Ri.extensions=[".cml"];var sl=R(function(e,t){function h(e,t,n){for(var r=(e.byteLength,0),i=n.length;r<i;r++){var o=n.charCodeAt(r);if(o<128)e.setUint8(t++,o>>>0&127|0);else if(o<2048)e.setUint8(t++,o>>>6&31|192),e.setUint8(t++,o>>>0&63|128);else if(o<65536)e.setUint8(t++,o>>>12&15|224),e.setUint8(t++,o>>>6&63|128),e.setUint8(t++,o>>>0&63|128);else{if(!(o<1114112))throw new Error("bad codepoint "+o);e.setUint8(t++,o>>>18&7|240),e.setUint8(t++,o>>>12&63|128),e.setUint8(t++,o>>>6&63|128),e.setUint8(t++,o>>>0&63|128)}}}function f(e){for(var t=0,n=0,r=e.length;n<r;n++){var i=e.charCodeAt(n);if(i<128)t+=1;else if(i<2048)t+=2;else if(i<65536)t+=3;else{if(!(i<1114112))throw new Error("bad codepoint "+i);t+=4}}return t}function n(e){var t=new ArrayBuffer(function e(t){var n=typeof t;if("string"==n){if((r=f(t))<32)return 1+r;if(r<256)return 2+r;if(r<65536)return 3+r;if(r<4294967296)return 5+r}if(t instanceof Uint8Array){if((r=t.byteLength)<256)return 2+r;if(r<65536)return 3+r;if(r<4294967296)return 5+r}if("number"==n){if(Math.floor(t)!==t)return 9;if(0<=t){if(t<128)return 1;if(t<256)return 2;if(t<65536)return 3;if(t<4294967296)return 5;throw new Error("Number too big 0x"+t.toString(16))}if(-32<=t)return 1;if(-128<=t)return 2;if(-32768<=t)return 3;if(-2147483648<=t)return 5;throw new Error("Number too small -0x"+t.toString(16).substr(1))}if("boolean"==n||null===t)return 1;if("object"!=n)throw new Error("Unknown type "+n);var r,i=0;if(Array.isArray(t)){r=t.length;for(var o=0;o<r;o++)i+=e(t[o])}else{var s=Object.keys(t);for(r=s.length,o=0;o<r;o++){var a=s[o];i+=e(a)+e(t[a])}}if(r<16)return 1+i;if(r<65536)return 3+i;if(r<4294967296)return 5+i;throw new Error("Array or object too long 0x"+r.toString(16))}(e));return function e(t,n,r){var i=typeof t;if("string"==i){if((o=f(t))<32)return n.setUint8(r,160|o),h(n,r+1,t),1+o;if(o<256)return n.setUint8(r,217),n.setUint8(r+1,o),h(n,r+2,t),2+o;if(o<65536)return n.setUint8(r,218),n.setUint16(r+1,o),h(n,r+3,t),3+o;if(o<4294967296)return n.setUint8(r,219),n.setUint32(r+1,o),h(n,r+5,t),5+o}if(t instanceof Uint8Array){var o=t.byteLength,s=new Uint8Array(n.buffer);if(o<256)return n.setUint8(r,196),n.setUint8(r+1,o),s.set(t,r+2),2+o;if(o<65536)return n.setUint8(r,197),n.setUint16(r+1,o),s.set(t,r+3),3+o;if(o<4294967296)return n.setUint8(r,198),n.setUint32(r+1,o),s.set(t,r+5),5+o}if("number"==i){if(!isFinite(t))throw new Error("Number not finite: "+t);if(Math.floor(t)!==t)return n.setUint8(r,203),n.setFloat64(r+1,t),9;if(0<=t){if(t<128)return n.setUint8(r,t),1;if(t<256)return n.setUint8(r,204),n.setUint8(r+1,t),2;if(t<65536)return n.setUint8(r,205),n.setUint16(r+1,t),3;if(t<4294967296)return n.setUint8(r,206),n.setUint32(r+1,t),5;throw new Error("Number too big 0x"+t.toString(16))}if(-32<=t)return n.setInt8(r,t),1;if(-128<=t)return n.setUint8(r,208),n.setInt8(r+1,t),2;if(-32768<=t)return n.setUint8(r,209),n.setInt16(r+1,t),3;if(-2147483648<=t)return n.setUint8(r,210),n.setInt32(r+1,t),5;throw new Error("Number too small -0x"+(-t).toString(16).substr(1))}if(null===t)return n.setUint8(r,192),1;if("boolean"==i)return n.setUint8(r,t?195:194),1;if("object"!=i)throw new Error("Unknown type "+i);var a,c=0,i=Array.isArray(t);if((o=(i?t:a=Object.keys(t)).length)<16?(n.setUint8(r,o|(i?144:128)),c=1):o<65536?(n.setUint8(r,i?220:222),n.setUint16(r+1,o),c=3):o<4294967296&&(n.setUint8(r,i?221:223),n.setUint32(r+1,o),c=5),i)for(var l=0;l<o;l++)c+=e(t[l],n,r+c);else for(l=0;l<o;l++){var u=a[l];c+=e(u,n,r+c),c+=e(t[u],n,r+c)}return c}(e,new DataView(t),0),new Uint8Array(t)}function r(e,t,n){return t?new e(t.buffer,t.byteOffset,t.byteLength/(n||1)):void 0}function l(e){return r(DataView,e)}function c(e){return r(Uint8Array,e)}function u(e){return r(Int8Array,e)}function d(e){return r(Int32Array,e,4)}function p(e,t){var n=e.length/2;t=t||new Int16Array(n);for(var r=0,i=0;r<n;++r,i+=2)t[r]=e[i]<<8^e[i+1]<<0;return t}function m(e,t){var n=e.length/4;t=t||new Int32Array(n);for(var r=0,i=0;r<n;++r,i+=4)t[r]=e[i]<<24^e[i+1]<<16^e[i+2]<<8^e[i+3]<<0;return t}function i(e,t){for(var n=e.length,r=l(t=t||new Uint8Array(4*n)),i=0;i<n;++i)r.setInt32(4*i,e[i]);return c(t)}function y(e,t,n){var r=e.length,i=1/t;n=n||new Float32Array(r);for(var o=0;o<r;++o)n[o]=e[o]*i;return n}function o(e,t,n){var r=e.length;n=n||new Int32Array(r);for(var i=0;i<r;++i)n[i]=Math.round(e[i]*t);return n}function _(e,t){if(!t){for(var n=0,r=0,i=e.length;r<i;r+=2)n+=e[r+1];t=new e.constructor(n)}var o=0;for(r=0,i=e.length;r<i;r+=2)for(var s=e[r],a=e[r+1],c=0;c<a;++c)t[o]=s,++o;return t}function s(e){if(0===e.length)return new Int32Array;for(var t=2,n=1,r=e.length;n<r;++n)e[n-1]!==e[n]&&(t+=2);var i=new Int32Array(t),o=0,s=1;for(n=1,r=e.length;n<r;++n)e[n-1]!==e[n]?(i[o]=e[n-1],i[o+1]=s,s=1,o+=2):++s;return i[o]=e[e.length-1],i[o+1]=s,i}function v(e,t){var n=e.length;t=t||new e.constructor(n),n&&(t[0]=e[0]);for(var r=1;r<n;++r)t[r]=e[r]+t[r-1];return t}function a(e,t){var n=e.length;(t=t||new e.constructor(n))[0]=e[0];for(var r=1;r<n;++r)t[r]=e[r]-e[r-1];return t}function g(e,t){var n,r=e instanceof Int8Array?127:32767,i=-r-1,o=e.length;if(!t){for(var s=0,a=0;a<o;++a)e[a]<r&&e[a]>i&&++s;t=new Int32Array(s)}for(n=a=0;a<o;){for(var c=0;e[a]===r||e[a]===i;)c+=e[a],++a;c+=e[a],++a,t[n]=c,++n}return t}function x(e,t,n){return y(g(e,d(n)),t,n)}function b(e,t,n){e=g(e,d(n));return n=e,t=t,e=r(Float32Array,e,4),y(v(n,d(e)),t,e)}function w(e,t,n){return function(e,t){for(var n=t?127:32767,r=-n-1,i=e.length,o=0,s=0;s<i;++s)0===(a=e[s])?++o:o+=a===n||a===r?2:0<a?Math.ceil(a/n):Math.ceil(a/r);var a,c=new(t?Int8Array:Int16Array)(o),l=0;for(s=0;s<i;++s){if(0<=(a=e[s]))for(;n<=a;)c[l]=n,++l,a-=n;else for(;a<=r;)c[l]=r,++l,a-=r;c[l]=a,++l}return c}(a(o(e,t),r),n);var r}function S(e,t,n,r){var i=new ArrayBuffer(12+r.byteLength),o=new Uint8Array(i),i=new DataView(i);return i.setInt32(0,e),i.setInt32(4,t),n&&o.set(n,8),o.set(r,12),o}function R(e){return S(2,e.length,void 0,c(e))}function C(e){return S(4,e.length,void 0,i(e))}function A(e,t){return S(5,e.length/t,i([t]),c(e))}function E(e){return S(6,e.length,void 0,i(s(e)))}function k(e){return S(8,e.length,void 0,i(s(a(e))))}function T(e,t){return S(9,e.length,i([t]),i(s(o(e,t))))}function P(e,t){return S(10,e.length,i([t]),function(e,t){for(var n=e.length,r=l(t=t||new Uint8Array(2*n)),i=0;i<n;++i)r.setInt16(2*i,e[i]);return c(t)}(w(e,t)))}function M(t){var n={};return z.forEach(function(e){void 0!==t[e]&&(n[e]=t[e])}),t.bondAtomList&&(n.bondAtomList=C(t.bondAtomList)),t.bondOrderList&&(n.bondOrderList=R(t.bondOrderList)),n.xCoordList=P(t.xCoordList,1e3),n.yCoordList=P(t.yCoordList,1e3),n.zCoordList=P(t.zCoordList,1e3),t.bFactorList&&(n.bFactorList=P(t.bFactorList,100)),t.atomIdList&&(n.atomIdList=k(t.atomIdList)),t.altLocList&&(n.altLocList=E(t.altLocList)),t.occupancyList&&(n.occupancyList=T(t.occupancyList,100)),n.groupIdList=k(t.groupIdList),n.groupTypeList=C(t.groupTypeList),t.secStructList&&(n.secStructList=R(t.secStructList)),t.insCodeList&&(n.insCodeList=E(t.insCodeList)),t.sequenceIndexList&&(n.sequenceIndexList=k(t.sequenceIndexList)),n.chainIdList=A(t.chainIdList,4),t.chainNameList&&(n.chainNameList=A(t.chainNameList,4)),n}function N(i){function r(e){for(var t={},n=0;n<e;n++)t[c()]=c();return t}function o(e){var t=i.subarray(l,l+e);return l+=e,t}function s(e){var t=i.subarray(l,l+e);l+=e;if(65535<e){for(var n=[],r=0;r<t.length;r+=65535)n.push(String.fromCharCode.apply(null,t.subarray(r,r+65535)));return n.join("")}return String.fromCharCode.apply(null,t)}function a(e){for(var t=new Array(e),n=0;n<e;n++)t[n]=c();return t}function c(){var e,t,n=i[l];if(0==(128&n))return l++,n;if(128==(240&n))return l++,r(t=15&n);if(144==(240&n))return l++,a(t=15&n);if(160==(224&n))return l++,s(t=31&n);if(224==(224&n))return e=u.getInt8(l),l++,e;switch(n){case 192:return l++,null;case 194:return l++,!1;case 195:return l++,!0;case 196:return t=u.getUint8(l+1),l+=2,o(t);case 197:return t=u.getUint16(l+1),l+=3,o(t);case 198:return t=u.getUint32(l+1),l+=5,o(t);case 202:return e=u.getFloat32(l+1),l+=5,e;case 203:return e=u.getFloat64(l+1),l+=9,e;case 204:return e=i[l+1],l+=2,e;case 205:return e=u.getUint16(l+1),l+=3,e;case 206:return e=u.getUint32(l+1),l+=5,e;case 208:return e=u.getInt8(l+1),l+=2,e;case 209:return e=u.getInt16(l+1),l+=3,e;case 210:return e=u.getInt32(l+1),l+=5,e;case 217:return t=u.getUint8(l+1),l+=2,s(t);case 218:return t=u.getUint16(l+1),l+=3,s(t);case 219:return t=u.getUint32(l+1),l+=5,s(t);case 220:return t=u.getUint16(l+1),l+=3,a(t);case 221:return t=u.getUint32(l+1),l+=5,a(t);case 222:return t=u.getUint16(l+1),l+=3,r(t);case 223:return t=u.getUint32(l+1),l+=5,r(t)}throw new Error("Unknown type 0x"+n.toString(16))}var l=0,u=new DataView(i.buffer);return c()}function I(e,t,n,r){switch(e){case 1:return function(e,t){for(var n=e.length,r=l(t=t||new Float32Array(n/4)),i=l(e),o=0,s=0,a=n/4;o<a;++o,s+=4)r.setFloat32(s,i.getFloat32(s),!0);return t}(t);case 2:return u(t);case 3:return p(t);case 4:return m(t);case 5:return c(t);case 6:return _(m(t),new Uint8Array(n));case 7:return _(m(t));case 8:return v(_(m(t)),a);case 9:return i=m(t),o=m(r)[0],y(_(i,d(s)),o,s);case 10:return b(p(t),m(r)[0]);case 11:return y(p(t),m(r)[0]);case 12:return x(p(t),m(r)[0]);case 13:return x(u(t),m(r)[0]);case 14:return g(p(t));case 15:return g(u(t))}var i,o,s,a}function L(s,e){var a=(e=e||{}).ignoreFields,c={};return F.forEach(function(e){var t,n,r,i=!!a&&-1!==a.indexOf(e),o=s[e];i||void 0===o||(o instanceof Uint8Array?c[e]=I.apply(null,(n=(r=l(t=o)).getInt32(0),i=r.getInt32(4),r=t.subarray(8,12),[n,t=t.subarray(12),i,r])):c[e]=o)}),c}function X(e){return String.fromCharCode.apply(null,e).replace(/\0/g,"")}function D(e,t){return e instanceof ArrayBuffer&&(e=new Uint8Array(e)),L(e instanceof Uint8Array?N(e):e,t)}function O(e,t,n,r){var i=new XMLHttpRequest;i.addEventListener("load",function(){try{var e=D(i.response);n(e)}catch(e){r(e)}},!0),i.addEventListener("error",r,!0),i.responseType="arraybuffer",i.open("GET",t+e.toUpperCase()),i.send()}var V,z,F,B,U;V=t,F=(z=["mmtfVersion","mmtfProducer","unitCell","spaceGroup","structureId","title","depositionDate","releaseDate","experimentalMethods","resolution","rFree","rWork","bioAssemblyList","ncsOperatorList","entityList","groupList","numBonds","numAtoms","numGroups","numChains","numModels","groupsPerChain","chainsPerModel"]).concat(["xCoordList","yCoordList","zCoordList","groupIdList","groupTypeList","chainIdList","bFactorList","atomIdList","altLocList","occupancyList","secStructList","insCodeList","sequenceIndexList","chainNameList","bondAtomList","bondOrderList"]),B=(t="//mmtf.rcsb.org/v1.0/")+"full/",U=t+"reduced/",V.encode=function(e){return n(M(e))},V.decode=D,V.traverse=function(e,t,n){var r,i,o,s,a,c,l=(n=n||{}).firstModelOnly,u=t.onModel,h=t.onChain,f=t.onGroup,d=t.onAtom,p=t.onBond,m=0,y=0,_=0,v=0,g=0,x=-1,b=e.chainNameList,w=e.secStructList,S=e.insCodeList,R=e.sequenceIndexList,C=e.atomIdList,A=e.bFactorList,E=e.altLocList,k=e.occupancyList,T=e.bondAtomList,P=e.bondOrderList;for(r=0,i=e.chainsPerModel.length;r<i&&!(l&&0<m);++r){var M=e.chainsPerModel[m];for(u&&u({chainCount:M,modelIndex:m}),o=0;o<M;++o){var N,I,L=e.groupsPerChain[y];for(h&&(N=X(e.chainIdList.subarray(4*y,4*y+4)),I=null,b&&(I=X(b.subarray(4*y,4*y+4))),h({groupCount:L,chainIndex:y,modelIndex:m,chainId:N,chainName:I})),s=0;s<L;++s){var D,O,V,z,F,B,U,G=e.groupList[e.groupTypeList[_]],j=G.atomNameList.length;for(f&&(D=null,w&&(D=w[_]),O=null,e.insCodeList&&(O=String.fromCharCode(S[_])),V=null,R&&(V=R[_]),f({atomCount:j,groupIndex:_,chainIndex:y,modelIndex:m,groupId:e.groupIdList[_],groupType:e.groupTypeList[_],groupName:G.groupName,singleLetterCode:G.singleLetterCode,chemCompType:G.chemCompType,secStruct:D,insCode:O,sequenceIndex:V})),a=0;a<j;++a)d&&(z=null,C&&(z=C[v]),F=null,A&&(F=A[v]),B=null,E&&(B=String.fromCharCode(E[v])),U=null,k&&(U=k[v]),d({atomIndex:v,groupIndex:_,chainIndex:y,modelIndex:m,atomId:z,element:G.elementList[a],atomName:G.atomNameList[a],formalCharge:G.formalChargeList[a],xCoord:e.xCoordList[v],yCoord:e.yCoordList[v],zCoord:e.zCoordList[v],bFactor:F,altLoc:B,occupancy:U})),v+=1;if(p){var H=G.bondAtomList;for(a=0,c=G.bondOrderList.length;a<c;++a)p({atomIndex1:v-j+H[2*a],atomIndex2:v-j+H[2*a+1],bondOrder:G.bondOrderList[a]})}_+=1}y+=1}if(g=x+1,x=v-1,p&&T)for(a=0,c=T.length;a<c;a+=2){var W=T[a],Y=T[a+1];(g<=W&&W<=x||g<=Y&&Y<=x)&&p({atomIndex1:W,atomIndex2:Y,bondOrder:P?P[a/2]:null})}m+=1}},V.fetch=function(e,t,n){O(e,B,t,n)},V.fetchReduced=function(e,t,n){O(e,U,t,n)},V.version="v1.1.0dev",V.fetchUrl=B,V.fetchReducedUrl=U,V.encodeMsgpack=n,V.encodeMmtf=M,V.decodeMsgpack=N,V.decodeMmtf=L});function al(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var cl=wn.Complex,ll=wn.Chain,ul=wn.Atom,hl=wn.Element,fl=wn.Helix,dl=wn.Sheet,pl=wn.Strand,ml=wn.Bond,yl=wn.Assembly,_l=wn.Molecule,vl=function(){function n(e){j(this,n),this._original=Array.from(e),this._original.sort();for(var t=this._sum=0;t<this._original.length;++t)this._sum+=this._original[t]}return _(n,[{key:"compare",value:function(e){var t=e.length;if(t!==this._original.length)return!1;for(var n=0,r=0;r<t;++r)n+=e[r];if(n!==this._sum)return!1;var i=Array.from(e);for(i.sort(),r=0;r<t;++r)if(i[r]!==this._original[r])return!1;return!0}}]),n}();vl.prototype.constructor=vl;var Pi=Xe.Type,gl=[Pi.HELIX_PI,Pi.BEND,Pi.HELIX_ALPHA,Pi.STRAND,Pi.HELIX_310,Pi.BRIDGE,Pi.TURN,Pi.COIL];Bi=function(){A(r,Bc);var n=al(r);function r(e,t){return j(this,r),(t=n.call(this,e,t))._options.fileType="mmtf",t}return _(r,[{key:"_onModel",value:function(){}},{key:"_onChain",value:function(e){var t;0===e.modelIndex&&(t=new ll(this._complex,e.chainName),(this._complex._chains[e.chainIndex]=t)._index=e.chainIndex)}},{key:"_onGroup",value:function(e){var t,n;0===e.modelIndex&&(this.settings.now.nowater&&("HOH"===e.groupName||"WAT"===e.groupName)||(t=this._complex._chains[e.chainIndex],n=e.insCode.charCodeAt(0)?e.insCode:"",(n=t.addResidue(e.groupName,e.groupId,n))._index=e.groupIndex,this._updateSecStructure(this._complex,n,e)))}},{key:"_onAtom",value:function(e){var t;0===e.modelIndex&&(t=e.altLoc.charCodeAt(0)?e.altLoc:"",t=new ul(e.groupIndex,e.atomName,hl.getByName(e.element.toUpperCase()),new ae.Vector3(e.xCoord,e.yCoord,e.zCoord),hl.Role[e.atomName],!1,e.atomId,t,e.occupancy,e.bFactor,e.formalCharge),(this._complex._atoms[e.atomIndex]=t).index=e.atomIndex,this._serialAtomMap[e.atomId]=t)}},{key:"_onBond",value:function(e){var t,n=Math.max(e.atomIndex1,e.atomIndex2);n>=this._complex._atoms.length||(t=Math.min(e.atomIndex1,e.atomIndex2),this._complex.addBond(this._complex._atoms[t],this._complex._atoms[n],e.bondOrder,ml.BondType.UNKNOWN,!0))}},{key:"_updateSecStructure",value:function(e,t,n){if(!b.default.isUndefined(n)&&n.secStruct===this._ssType)return t._secondary=this._ssStruct,void(this._ssStruct&&(this._ssStruct.term=t));if(!b.default.isUndefined(n)){var r=gl[n.secStruct];this._ssType=n.secStruct,this._ssStart=t;var i=null;switch(this._ssType){case-1:case 7:break;case 0:case 2:case 4:i=new fl([3,-1,1,-1,5][this._ssType],t,t,0,"","",0),e._helices.push(i);break;case 3:var o=new dl("",0);e._sheets.push(o),i=new pl(o,t,t,0,null,null);break;default:void 0!==r&&(i=new Xe(r,t,t))}this._ssStruct=i,(t._secondary=i)&&e.structures.push(i)}}},{key:"_updateMolecules",value:function(e){var t=e.entityList;if(t)for(var n=e.chainsPerModel[0],r=0;r<t.length;r++){for(var i=t[r],o=i.chainIndexList,s=[],a=0;a<o.length;a++){var c=o[a];n<=c||(c=this._complex._chains[c],s=s.concat(c._residues.slice()))}i=new _l(this._complex,i.description,r+1);i.residues=s,this._complex._molecules[r]=i}}},{key:"_traverse",value:function(e){var t=this,n=this._complex.metadata;n.id=e.structureId,n.title=[],n.title[0]=e.title,n.date=e.releaseDate,n.format="mmtf";n={onModel:function(e){t._onModel(e)},onChain:function(e){t._onChain(e)},onGroup:function(e){t._onGroup(e)},onAtom:function(e){t._onAtom(e)},onBond:function(e){t._onBond(e)}};this._ssType=-1,this._ssStruct=null,this._ssStart=null,sl.traverse(e,n),this._updateSecStructure(this._complex),this._updateMolecules(e)}},{key:"_linkAtomsToResidues",value:function(){for(var e=0;e<this._complex._atoms.length;++e){var t=this._complex._atoms[e],n=this._complex._residues[t.residue];(t.residue=n)._atoms.push(t)}}},{key:"_findSynonymousChains",value:function(){for(var e={},t=0;t<this._complex._chains.length;++t){var n=this._complex._chains[t],r=n.getName();e.hasOwnProperty(r)||(e[r]=[]),e[r].push(n._index)}return e}},{key:"_parseAssemblyInfo",value:function(e){for(var t=[],n=this.logger,r=0;r<e.bioAssemblyList.length;++r){var i=e.bioAssemblyList[r];if(0!==i.transformList.length){for(var o=i.transformList[0].chainIndexList,s=new vl(o),a={},c=0;c<o.length;++c)a[this._complex._chains[o[c]].getName()]=1;var l=[],u=void 0;for(u in a)a.hasOwnProperty(u)&&Array.prototype.push.apply(l,this._chainsByName[u]);s.compare(l)||n.debug("MMTF: Assembly is missing some of the synonymous chains. Skipping...");var h=new yl(this._complex);for(u in a)a.hasOwnProperty(u)&&h.addChain(u);for(h.addMatrix((new ae.Matrix4).fromArray(i.transformList[0].matrix).transpose()),c=1;c<i.transformList.length;++c){var f=i.transformList[c];if(s.compare(f.chainIndexList)){for(var d=(new ae.Matrix4).fromArray(f.matrix).transpose(),p=0;p<h.matrices.length&&!h.matrices[p].equals(d);++p);p===h.matrices.length&&h.addMatrix(d)}else n.debug("MMTF: Chain lists differ for different transforms in one assembly. Skipping...")}h.finalize(),t.push(h)}}return t}},{key:"_markHeteroAtoms",value:function(e){for(var t=e.chainsPerModel[0],n=0;n<e.entityList.length;++n){var r=e.entityList[n];if("polymer"!==r.type)for(var i=0;i<r.chainIndexList.length;++i){var o=r.chainIndexList[i];if(!(t<=o))for(var s=this._complex._chains[o],a=0;a<s._residues.length;++a)for(var c=s._residues[a],l=0;l<c._atoms.length;++l)c._atoms[l].het=!0}}}},{key:"_joinSynonymousChains",value:function(){for(var e=[],t={},n=0;n<this._complex._chains.length;++n){var r=this._complex._chains[n],i=r.getName();if(t.hasOwnProperty(i))for(var o=t[i],s=0;s<r._residues.length;++s){var a=r._residues[s];o._residues.push(a),a._chain=o}else(t[i]=r)._index=e.length,e.push(r)}this._complex._chains=e}},{key:"parseSync",value:function(){var e=sl.decode(this._data);return this._complex=new cl,this._serialAtomMap={},this._traverse(e),this._linkAtomsToResidues(),this._markHeteroAtoms(e),this._chainsByName=this._findSynonymousChains(),Array.prototype.push.apply(this._complex.units,this._parseAssemblyInfo(e)),this._joinSynonymousChains(),this._complex.finalize({needAutoBonding:!1,detectAromaticLoops:this.settings.now.aromatic,enableEditing:this.settings.now.editing,serialAtomMap:this._serialAtomMap}),this._complex}}],[{key:"canProbablyParse",value:function(e){return b.default.isArrayBuffer(e)&&223==(1|new Uint8Array(e,0,1)[0])}}]),r}();function xl(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}Bi.formats=["mmtf"],Bi.extensions=[".mmtf"],Bi.binary=!0;var bl=function(e){A(i,e);var r=xl(i);function i(e,t,n){return j(this,i),e=r.call(this,"data:".concat(t,":").concat(n,": ").concat(e)),Error.captureStackTrace&&Error.captureStackTrace(k(e),i),e.name="ParsingError",e.parseLine=t,e.parseColumn=n,e}return i}(L(Error));function wl(e){return 32===e||10===e||13===e||9===e}function Sl(e,t,n){for(var r=t.length,i=-1;n<r&&(i=t.charCodeAt(n))!==e&&10!==i;)++n;return i===e?n:-1}function Rl(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var Cl=wn.Complex,Al=wn.Element,El=wn.Helix,kl=wn.Sheet,Tl=wn.Strand,Pl=wn.Assembly,Ml=wn.Molecule,Nl=["auth_seq_id","Cartn_x","Cartn_y","Cartn_z","label_atom_id"],Il={helx:"helix",turn:"turn",strn:"strand"};function Ll(e){return null==e||b.default.isArray(e)?e:[e]}var Dl=function(e){A(r,e);var n=Rl(r);function r(e){var t;return j(this,r),(t=n.call(this)).name="AtomDataError",t.message=e,t}return r}(L(Error));function Ol(e,t){for(var n=(e=b.default.isString(e)?e:"".concat(e)).replace(/\)\s*\(/g,"!").replace(/[()']/g,"").split("!"),s=[],r=0,i=n.length;r<i;++r){for(var o=n[r].split(","),a=[],c=0,l=0,u=o.length;l<u;++l){var h=o[l];if(h.includes("-"))for(var f=h.split("-"),d=parseInt(f[0],10),p=parseInt(f[1],10);d<=p;++d)a[c++]=t[d];else a[c++]=t[h]}s.push(a)}var m=[],y=0;return function e(t,n){for(var r=0,i=s[t].length;r<i;++r){var o=n?n.clone():new ae.Matrix4;o.multiplyMatrices(s[t][r],o),0===t?m[y++]=o:e(t-1,o)}}(s.length-1),m}Wi=function(){A(r,Bc);var n=Rl(r);function r(e,t){return j(this,r),(t=n.call(this,e,t)).asymDict={},t.molecules=[],t._options.fileType="cif",t}return _(r,[{key:"parseSync",value:function(){this.logger.info("Parsing CIF file..");var e=function(r){var e,t,n,i=0,o=0,s=r.length,a=NaN,c=!0,l=1,u=1,h=0,f={},d={},p=[],m=0,y="",_=[],v=0;function g(){var e;if((46===a||63===a)&&(s<=i+1||wl(r.charCodeAt(i+1))))return++u,void++i;if(c&&59===a){o=i;var t=0;do{if(-1===(o=Sl(10,r,o+1)))throw new bl("Unterminated text block found",l,u)}while(++t,o+1<s&&r.charCodeAt(o+1)!==a||s<=o+1);return e=r.substring(i+1,o).replace(/\r/g,""),i=o+2,l+=t,c=!(u=1),e}if(39===a||34===a){o=i;do{if(-1===(o=Sl(a,r,o+1)))throw new bl("Unterminated quoted string found",l,u)}while(o+1<s&&!wl(r.charCodeAt(o+1)));return e=r.substring(i+1,o),u+=o-i+1,i=o+1,e}for(o=i;o<s&&!wl(r.charCodeAt(o));)++o;e=r.substring(i,o),u+=o-i,i=o;var n=Number(e);return Number.isNaN(n)?e:n}for(;i<=s;){if(a=r.charCodeAt(i),13!==a)if(10===a)c=!0,++l,u=1;else{if(32!==a&&9!==a){if(35===a){if(-1===(i=Sl(10,r,i+1)))break;continue}if(0===h){if(68!==a&&100!==a||"ata_"!==r.substr(i+1,4).toLowerCase()){if(Number.isNaN(a))break;throw new bl("Unexpected character in state ".concat(h),l,u)}for(e=o=i+5;o<s&&!wl(r.charCodeAt(o));)++o;if(u+=o-i,e<(i=o)){f[r.substring(e,i)]=d={},h=1;continue}throw new bl("Data block name missing",l,u)}if(1===h){if(68!==a&&100!==a||"ata_"!==r.substr(i+1,4).toLowerCase()){if(95===a){for(e=o=i+1;o<s&&!wl(r.charCodeAt(o));)++o;if(u+=o-i,e<(i=o)){y=r.substring(e,i),h=2;continue}throw new bl("Tag name missing",l,u)}if(76!==a&&108!==a||"oop_"!==r.substr(i+1,4).toLowerCase()){if(Number.isNaN(a))break;throw new bl("Unexpected character in state ".concat(h),l,u)}if(u+=5,(i+=5)<s&&!wl(r.charCodeAt(i)))throw new bl("Unexpected character in state ".concat(h),l,u);p=[],_=[],v=m=0,h=3;continue}h=0;continue}if(2===h){if(Number.isNaN(a))break;t=g(),b.default.set(d,y,t),h=1;continue}if(3===h){if(95===a){for(e=o=i+1;o<s&&!wl(r.charCodeAt(o));)++o;if(u+=o-i,e<(i=o)){n=r.substring(e,i),p[m++]=n;continue}throw new bl("Tag name missing",l,u)}if(0<m){for(var x=0;x<m;++x)t=[],_[x]=t,b.default.set(d,p[x],t);h=4;continue}throw new bl("Data tags are missing inside a loop",l,u)}if(4!==h)throw new bl("Unexpected internal state ".concat(h),l,u);68!==a&&100!==a||"ata_"!==r.substr(i+1,4).toLowerCase()?95!==a&&(76!==a&&108!==a||"oop_"!==r.substr(i+1,4).toLowerCase())?Number.isNaN(a)?h=0:(n=g(),_[v%m].push(n),++v):h=1:h=0;continue}c=!1,++u}++i}if(2===h)throw new bl("Unexpected end of file in state ".concat(h),l,u);return f}(this._data);return this._toComplex(e)}},{key:"_toComplex",value:function(e){var t=new Cl,e=e[Object.keys(e)[0]];return this._extractAtoms(t,e),this._extractSecondary(t,e),this._extractAssemblies(t,e),this._extractMolecules(t,e),this._extractMetadata(t,e),t.finalize({needAutoBonding:!0,detectAromaticLoops:this.settings.now.aromatic,enableEditing:this.settings.now.editing}),t}},{key:"_extractMetadata",value:function(e,t){var n=e.metadata;n.id=t.entry.id,n.classification=t.struct_keywords.pdbx_keywords;e=t.database_PDB_rev;n.date=e&&e.date_original?e.date_original:"",n.format="cif",n.title=[],n.title[0]=t.struct.title}},{key:"_extractMolecules",value:function(e,t){for(var n=Ll(t.entity.pdbx_description),r=n.length,i=0;i<r;i++)this.molecules[i]?this.molecules[i].name=n[i]:this.molecules[i]={name:n[i],residues:[]};var o=e.getMolecules();for(i=0;i<r;i++){var s=this.molecules[i];o[i]=new Ml(e,s.name,i+1),o[i].residues=s.residues}}},{key:"_extractAtoms",value:function(e,t){var n=t.atom_site;if(!n)throw new Dl("CIF parsing error: atom_site is not specified!");for(var r=0,i=Nl.length;r<i;++r)if(!n[Nl[r]])throw new Dl("CIF parsing error: requires field ".concat(Nl[r]," not found!"));for(var o,s,a,c,l,u,h,f,d,p,m=this.asymDict,y=Ll(n.auth_seq_id),_=Ll(n.Cartn_x),v=Ll(n.Cartn_y),g=Ll(n.Cartn_z),x=Ll(n.label_atom_id),b=x.length,w=Ll(n.group_PDB)||[],S=Ll(n.auth_asym_id)||[],R=Ll(n.label_asym_id)||[],C=Ll(n.id)||[],A=Ll(n.pdbx_PDB_ins_code)||[],E=Ll(n.label_comp_id)||[],k=Ll(n.type_symbol)||[],T=Ll(n.B_iso_or_equiv)||[],P=Ll(n.occupancy)||[],M=Ll(n.pdbx_formal_charge)||[],N=Ll(n.label_alt_id)||[],I=Ll(n.pdbx_PDB_model_num)||[],L=Ll(n.label_entity_id)||[],D=null,O=null,V=0;V<b;++V)1===(I[V]||1)&&(s=String(S[V]||" "),D&&D.getName()===s||(D=e.getChain(s)||e.addChain(s)),m[String(R[V]||" ")]=s,c=y[V],l=String(A[V]||" "),a=String(E[V]||""),O&&O.getSequence()===c&&O.getICode()===l||(O=D.addResidue(a,c,l),u=L[V]-1,(h=this.molecules[u])||(this.molecules[u]={name:"",residues:[]},h=this.molecules[u]),h.residues.push(O)),o=x[V],f=k[V]||(p=void 0,p=4===(d=o).trim().length,d.slice(0,p?1:2).trim()),s=Al.getByName(f),a=Al.Role[o.trim()],c=new ae.Vector3(_[V],v[V],g[V]),l="HETATM"===w[V]||!1,u=C[V]||V,h=T[V]||0,d=P[V]||0,p=String(N[V]||""),f=M[V]||0,O.addAtom(o,s,c,a,l,u,p,d,h,f))}},{key:"_extractSecondary",value:function(e,t){t.struct_conf&&this._extractConfs(e,t.struct_conf),t.struct_sheet_range&&this._extractSheets(e,t.struct_sheet_range)}},{key:"_extractSheets",value:function(e,t){var n=this.asymDict;if(t.sheet_id&&t.id&&t.beg_label_seq_id&&t.end_label_seq_id&&t.beg_label_asym_id)for(var r=e._sheets,i=Ll(t.sheet_id),o=Ll(t.id),s=Ll(t.beg_auth_seq_id),a=Ll(t.end_auth_seq_id),c=Ll(t.beg_label_asym_id),l=Ll(t.pdbx_beg_PDB_ins_code)||[],u=Ll(t.pdbx_end_PDB_ins_code)||[],h=0,f=o.length;h<f;++h){var d=e.getChain(n[c[h]]),p=function(e){for(var t=r.length,n=0;n<t;++n)if(r[n]._name===e)return r[n];return r[t]=new kl(e,0),r[t]}(i[h]),m=s[h],y=a[h],_=l[h]||" ",v=u[h]||" ",_=d.findResidue(m,_),g=d.findResidue(y,v);if(_&&g){for(var x=new Tl(p,_[0],g[0],0,null,null),b=d.getResidues(),w=_[1];w<=g[1];++w)b[w]._secondary=x;p.addStrand(x),e.structures.push(x)}}}},{key:"_extractConfs",value:function(e,t){var n=this.asymDict;if(t.conf_type_id&&t.beg_label_seq_id&&t.end_label_seq_id&&t.beg_label_asym_id)for(var r=Ll(t.conf_type_id),i=Ll(t.beg_auth_seq_id),o=Ll(t.pdbx_beg_PDB_ins_code)||[],s=Ll(t.end_auth_seq_id),a=Ll(t.pdbx_end_PDB_ins_code)||[],c=Ll(t.details)||[],l=Ll(t.pdbx_PDB_helix_length)||[],u=Ll(t.pdbx_PDB_helix_class)||[],h=Ll(t.id)||[],f=Ll(t.beg_label_asym_id),d=0,p=r.length;d<p;++d){var m=(w=r[d],(w=/[A-Za-z]+/.exec(w))?Il[w[0].toLowerCase()]:null);if(m){var y=h[d]||r[d],_=e.getChain(n[f[d]]),v=i[d],g=s[d],x=o[d]||" ",b=a[d]||" ",w=_.findResidue(v,x),S=_.findResidue(g,b);if(w&&S){var v=c[d]||"",x=l[d]||0,g=u[d]||" ",R=void 0;if("helix"===m?(b=e._helices.length,R=new El(g,w[0],S[0],b,y,v,x),e.addHelix(R),e.structures.push(R)):"turn"===m?(R=new Xe(Xe.Type.TURN,w[0],S[0]),e.structures.push(R)):R=null,R)for(var C=_.getResidues(),A=w[1];A<=S[1];++A)C[A]._secondary=R}}}}},{key:"_extractAssemblies",value:function(e,t){var n=this.asymDict,r=t.pdbx_struct_assembly_gen;if(r){var i=Ll(r.assembly_id),o=Ll(r.oper_expression),s=Ll(r.asym_id_list);if(i&&o&&s){var a=function(e){if(!e)return null;var t=Ll(e.id),n=e.matrix,r=e.vector;if(!t||!n||!r)return null;for(var i=[],o=0,s=t.length;o<s;++o){for(var a=new ae.Matrix4,c=a.elements,l=0;l<3;++l){var u=n[l+1];c[l]=Ll(u[1])[o],c[l+4]=Ll(u[2])[o],c[l+8]=Ll(u[3])[o],c[l+12]=Ll(r[l+1])[o]}i[t[o]]=a}return i}(t.pdbx_struct_oper_list);if(a)for(var c=0,l=i.length;c<l;++c){for(var u=new Pl(e),h=Ol(o[c],a),f=s[c].split(","),d=0,p=f.length;d<p;++d){var m=f[d].trim();0<m.length&&u.addChain(n[m])}u.matrices=h,e.units.push(u)}}}}}],[{key:"canProbablyParse",value:function(e){return b.default.isString(e)&&/^\s*data_/i.test(e)}}]),r}();Wi.formats=["cif","mmcif"],Wi.extensions=[".cif",".mmcif"];var Vl=0,zl=1,Fl=2,Bl=3,Ul=function(){function e(){j(this,e),ke(this,"_xyz2crs",[]),ke(this,"_origin",new ae.Vector3(0,0,0)),this._header={},this._boxSize=new ae.Vector3,this._boxStart=new ae.Vector3,this._header.delta={},this._header.extent=[],this._header.nstart=[],this._header.grid=[],this._header.crs2xyz=[],this._header.cellDims=new ae.Vector3,this._header.angles=[],this._header.origin=new ae.Vector3(0,0,0),this._header.dmin=0,this._header.dmean=0,this._header.dmax=0}return _(e,[{key:"_typedCheck",value:function(){if(b.default.isTypedArray(this._buff))this._buff=this._buff.buffer;else if(!b.default.isArrayBuffer(this._buff))throw new TypeError("Expected ArrayBuffer or TypedArray")}},{key:"_fillHeader",value:function(e,t){for(var n in e)if(e.hasOwnProperty(n))switch(e[n][0]){case Vl:this._header[n]=t[e[n][1]][e[n][2]];break;case Fl:this._parseArray(this._header[n],t[e[n][1]],e[n][2]);break;case zl:this._parseVector(this._header[n],t[e[n][1]],e[n][2]);break;case Bl:this._header[n]=new Uint8Array(t[e[n][1]],4*[e[n][2]],4*[e[n][3]])}}},{key:"_parseVector",value:function(e,t,n){n=[t[n],t[n+1],t[n+2]];e.x=n[0],e.y=n[1],e.z=n[2]}},{key:"_parseArray",value:function(e,t,n){e[0]=t[n],e[1]=t[n+1],e[2]=t[n+2]}},{key:"_parseHeader",value:function(){}},{key:"_setAxisIndices",value:function(){}},{key:"_setOrigins",value:function(){}},{key:"_getAxis",value:function(){var e=this._header,t=e.cellDims.x/e.grid[0],n=e.cellDims.y/e.grid[1],r=e.cellDims.z/e.grid[2],i=m(e.angles,3),o=i[0],s=i[1],e=i[2],i=Math.cos(s),o=(Math.cos(o)-Math.cos(s)*Math.cos(e))/Math.sin(e),s=Math.sqrt(1-i*i-o*o);return[new ae.Vector3(t,0,0),new ae.Vector3(Math.cos(e)*n,Math.sin(e)*n,0),new ae.Vector3(i*r,o*r,s*r)]}},{key:"_getXYZdim",value:function(){return[this._header.extent[this._xyz2crs[0]],this._header.extent[this._xyz2crs[1]],this._header.extent[this._xyz2crs[2]]]}},{key:"_getVolumeInfo",value:function(){var e=b.default.pick(this._header,["dmean","dmin","dmax","sd","delta"]);return e.obtuseAngle=this._header.angles.map(function(e){return Number(e>=Math.PI/2)}),e}},{key:"_setBoxParams",value:function(e,t,n){var r=this,i=0,o=0,s=m(this._header.angles,3),a=s[0],c=s[1];s[2]>=Math.PI/2&&(i+=Math.abs(t.x)),c>=Math.PI/2&&(i+=Math.abs(n.x)),a>=Math.PI/2&&(o+=Math.abs(n.y)),this._boxStart=new ae.Vector3(this._origin.x-i,this._origin.y-o,this._origin.z),this._boxSize=new ae.Vector3(Math.abs(e.x)+Math.abs(t.x)+Math.abs(n.x),Math.abs(t.y)+Math.abs(n.y),Math.abs(n.z));e=function(e,t){return Math.abs(e[t])/r._boxSize[t]};this._header.delta.x=e(t,"x"),this._header.delta.y=e(n,"x"),this._header.delta.z=e(n,"y")}},{key:"_getXYZbox",value:function(){return new ae.Box3(this._boxStart.clone(),this._boxStart.clone().add(this._boxSize))}},{key:"_toXYZData",value:function(){}},{key:"parse",value:function(e){return this._parseHeader(e),this._setOrigins(),new bn(Float32Array,this._getXYZdim(),this._getXYZbox(),1,this._toXYZData(),this._getVolumeInfo())}}]),e}();function Gl(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var jl={extent:[Fl,"u32",0],type:[Vl,"u32",3],nstart:[Fl,"i32",4],grid:[Fl,"u32",7],cellDims:[zl,"f32",10],angles:[Fl,"f32",13],crs2xyz:[Fl,"i32",16],dmin:[Vl,"f32",19],dmax:[Vl,"f32",20],dmean:[Vl,"f32",21],ispg:[Vl,"u32",22],nsymbt:[Vl,"u32",23],lksflg:[Vl,"u32",24],customData:[Bl,"buffer",25,9],origin:[zl,"f32",34],map:[Bl,"buffer",52,1],machine:[Vl,"u32",53],sd:[Vl,"f32",54],nlabel:[Vl,"f32",55],label:[Bl,"buffer",56,200]},Hl=function(){A(t,Ul);var e=Gl(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"_parseHeader",value:function(e){this._buff=e,this._typedCheck();var t={};t.u32=new Uint32Array(this._buff,0,56),t.i32=new Int32Array(this._buff,0,56),t.f32=new Float32Array(this._buff,0,56),t.buffer=this._buff;e=this._header;this._fillHeader(jl,t),e.angles.forEach(function(e,t,n){n[t]*=Math.PI/180})}},{key:"_setAxisIndices",value:function(){var e=this._header;0===e.cellDims.x&&0===e.cellDims.y&&0===e.cellDims.z&&e.cellDims.set(1,1,1);var t=this._header.crs2xyz;0===t[0]&&0===t[1]&&0===t[2]&&(t[0]=1,t[1]=2,t[2]=3);e=this._xyz2crs;e[t[0]-1]=0,e[t[1]-1]=1,e[t[2]-1]=2}},{key:"_setOrigins",value:function(){var e=this._getAxis(),t=m(e,3),n=t[0],r=t[1],i=t[2];this._setAxisIndices();e=this._header,t=this._xyz2crs;if(0===e.origin.x&&0===e.origin.y&&0===e.origin.z?(this._origin.addScaledVector(n,e.nstart[t[0]]),this._origin.addScaledVector(r,e.nstart[t[1]]),this._origin.addScaledVector(i,e.nstart[t[2]])):this._origin=e.origin,n.multiplyScalar(e.extent[t[0]]-1),r.multiplyScalar(e.extent[t[1]]-1),i.multiplyScalar(e.extent[t[2]]-1),2!==e.type)throw new Error("CCP4: Unsupported format ".concat(e.type));this._data=new Float32Array(this._buff,1024+e.nsymbt,e.extent[0]*e.extent[1]*e.extent[2]),this._setBoxParams(n,r,i)}},{key:"_toXYZData",value:function(){var e=this._header,t=this._data,n=this._xyz2crs,r=new Float32Array(t.length),i=this._getXYZdim(),o=i[0],s=i[1],a=0,c=[];for(c[2]=0;c[2]<e.extent[2];c[2]++)for(c[1]=0;c[1]<e.extent[1];c[1]++)for(c[0]=0;c[0]<e.extent[0];c[0]++,a++)r[c[n[0]]+o*(c[n[1]]+s*c[n[2]])]=t[a];return r}}]),t}(),Ui=function(){A(r,Bc);var n=Gl(r);function r(e,t){return j(this,r),(t=n.call(this,e,t))._options.fileType="ccp4",t.model=new Hl,t}return _(r,[{key:"parseSync",value:function(){return this.model.parse(this._data)}}],[{key:"canProbablyParse",value:function(){return!1}}]),r}();function Wl(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}Ui.formats=["ccp4"],Ui.extensions=[".ccp4",".map",".mrc"],Ui.binary=!0;var Yl=wn.Complex,Xl=wn.Element,ql=wn.Molecule,Gi=function(){A(r,Bc);var n=Wl(r);function r(e,t){return j(this,r),(e=n.call(this,e,t))._complex=null,e._atomsInf=null,e._options.fileType="xyz",e._fileName=t.name,e}return _(r,[{key:"_parseToAtomsInf",value:function(e){var t=e.indexOf("\n"),n=parseInt(e.substring(0,t),10),r=e.indexOf("\n",t+1),t=e.slice(t+1,r).trim();0===t.length&&(t=this._fileName);r+=e.substring(r).search(/\S/);this._atomsInf=e.substring(r).split(/[\s,]*\n[\s,]*/),Number.isNaN(n)||this._atomsInf.length-1===n?(this._complex.metadata.format="xyz",this._complex.name=t):this._complex.error={message:"wrong number of atoms"}}},{key:"_parseAtomsInf",value:function(){for(var e=this._complex.addChain("A").addResidue("UNK",1," "),t=0;t<this._atomsInf.length-1;t++){var n=this._atomsInf[t].split(/[\s,]+/);if(4!==n.length){this._complex.error={message:"missed parameters"};break}var r=t+1,i=n[0],o=new ae.Vector3(parseFloat(n[1]),parseFloat(n[2]),parseFloat(n[3])),n=Xl.getByName(i);e.addAtom(i,n,o,void 0,!0,r," ",1,1,0)}var s=new ql(this._complex,this._complex.name,1);s.residues=e,this._complex._molecules[0]=s}},{key:"parseSync",value:function(){var e=this._complex=new Yl;if(this._parseToAtomsInf(this._data),this._parseAtomsInf(),this._complex.finalize({needAutoBonding:!0,detectAromaticLoops:this.settings.now.aromatic,enableEditing:this.settings.now.editing,serialAtomMap:this._serialAtomMap}),this._complex=null,this._atomsInf=null,e.error)throw new Error(e.error.message);return e}}],[{key:"canProbablyParse",value:function(e){return b.default.isString(e)&&/^\s*\d+ *\n[^\n]*\n\s*\w{1,3}\s+-?\d/.test(e)}}]),r}();function $l(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}ke(Gi,"formats",["xyz"]),ke(Gi,"extensions",[".xyz"]);var Zl=wn.Complex,Kl=wn.Element,Hi=function(){A(r,Bc);var n=$l(r);function r(e,t){return j(this,r),(t=n.call(this,e,t))._options.fileType="pubchem+json",t}return _(r,[{key:"parseSync",value:function(){return this.logger.info("Parsing PubChem JSON file..."),this._toComplex(JSON.parse(this._data))}},{key:"_toComplex",value:function(e){var t=new Zl,e=e.PC_Compounds&&e.PC_Compounds[0];return e&&(this._extractAtoms(t,e),t.finalize({needAutoBonding:!1,detectAromaticLoops:this.settings.now.aromatic,enableEditing:this.settings.now.editing})),t}},{key:"_extractAtoms",value:function(e,t){var n=t.atoms&&t.atoms.aid,r=n&&t.atoms.element;if(!r||n.length!==r.length)throw new Error("Unable to parse atom elements");r=b.default.fromPairs(b.default.zip(n,r));var i={},o=t.coords&&t.coords[0],s=o&&o.conformers&&o.conformers[0],a=s&&s.x,c=s&&s.y,l=s&&s.z||[];if(!(n=o&&o.aid)||!a||!c)throw new Error("Coordinates are not found in the file");for(var u=e.addChain(" ").addResidue("UNK",1," "),h=0,f=n.length;h<f;++h){var d=n[h],p=Kl.ByAtomicNumber[r[d]],m=new ae.Vector3(a[h],c[h],l[h]||0);i[d]=u.addAtom(p.name,p,m,void 0,!0,d," ",1,0,0)}var y=t.bonds&&t.bonds.aid1,_=t.bonds&&t.bonds.aid2,v=t.bonds&&t.bonds.order||[];if(y&&_&&y.length===_.length)for(var g=0,x=y.length;g<x;++g)e.addBond(i[y[g]],i[_[g]],v[g]||1,0,!0)}}],[{key:"canProbablyParse",value:function(e){return b.default.isString(e)&&"{"===e[0]}}]),r}();Hi.formats=["pubchem","pubchem+json","pc"],Hi.extensions=[".json"];var Ql=function(){function t(e){j(this,t),this._strings=e.split(/\r?\n|\r/),this._currentStart=0,this._currentStringIndx=0}return _(t,[{key:"setStart",value:function(e){e>=this._strings.length?(this._currentStart=this._strings.length-1,this._currentStringIndx=this._strings.length-1):(this._currentStart=e,this._currentStringIndx=e)}},{key:"getNextString",value:function(){return this._strings[++this._currentStringIndx]}},{key:"getCurrentString",value:function(){return this._strings[this._currentStringIndx]}},{key:"getStringFromStart",value:function(e){return this._currentStringIndx=this._currentStart+e,this._strings[this._currentStart+e]}},{key:"findNextDataItem",value:function(){for(var e=this.getNextString(),t=!1;!b.default.isUndefined(e)&&"$$$$"!==e.trim();){if(e.match(/>\s+<(.*)>/)){t=!0;break}e=this.getNextString()}return t}},{key:"findNextCompoundStart",value:function(){for(var e=this.getCurrentString();!b.default.isUndefined(e)&&"$$$$"!==e.trim();)e=this.getNextString();return this.setStart(++this._currentStringIndx),this.probablyHaveDataToParse()}},{key:"probablyHaveDataToParse",value:function(){return this._currentStringIndx<this._strings.length-2}}]),t}();function Jl(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var eu=wn.Complex,tu=wn.Element,nu=wn.Bond,ru=wn.Molecule,iu=[0,3,2,1,0,-1,-2,-3],ou=[0,1,2,3,1,1,1,2],su=[nu.BondType.UNKNOWN,nu.BondType.COVALENT,nu.BondType.COVALENT,nu.BondType.COVALENT,nu.BondType.AROMATIC,nu.BondType.UNKNOWN,nu.BondType.AROMATIC,nu.BondType.AROMATIC],au=/.*(M\s\sEND).*|.*(^$$$$).*|.*>\s+<(.+)>.*/,cu=/.*($$$$).*|.*>\s+<(.+)>.*/,lu="sdf",uu="mol",hu=["name","id","title"],fu={name:["PUBCHEM_IUPAC_TRADITIONAL_NAME",/PUBCHEM_(.+)_NAME/,/(.+)name/,/(.+)NAME/],id:["PUBCHEM_COMPOUND_CID","id","ID",/.*CID/,/.*ID/,/.*id/],title:["msg","MSG","message","title","description","desc"]};ji=function(){A(r,Bc);var n=Jl(r);function r(e,t){return j(this,r),(t=n.call(this,e,t))._format="sdf",t._complex=null,t._chain=null,t._residue=null,t._molecules=null,t._metadata={},t._metadata.molecules=[],t._currentMolProps={},t._compoundIndx=-1,t._assemblies=[],t._atomsParsed=0,t._atomsIndexes=[],t}return _(r,[{key:"canProbablyParse",value:function(e){return b.default.isString(e)&&au.test(e)}},{key:"_parseHeader",value:function(e){var t={};t.name=e.getStringFromStart(0);var n=parseInt(e.getStringFromStart(1).substr(10,6).trim(),10);t.date=n.toString()||"",t.title=e.getStringFromStart(2),this._metadata.molecules.push(t)}},{key:"_parseAtoms",value:function(e,t){var n=this._atomsParsed,r=function(e){if(!e)return"A";for(var t=[];e;)t.push(65+e%26),e=Math.trunc(e/26);return 1<t.length&&(t.reverse(),--t[0]),String.fromCharCode.apply(String,t)}(this._compoundIndx);this._chain=this._complex.getChain(r)||this._complex.addChain(r),this._residue=this._chain.addResidue("UNK",1," ");for(var i=0;i<t;i++){l=e.getNextString(),n++;var o=parseFloat(l.substr(0,10)),s=parseFloat(l.substr(10,10)),a=parseFloat(l.substr(20,10)),c=iu[parseInt(l.substr(36,3),10)],s=new ae.Vector3(o,s,a),a=l.substr(31,3).trim().toUpperCase(),l=tu.getByName(a);this._atomsIndexes[a]||(this._atomsIndexes[a]=0),this._atomsIndexes[a]+=1,a+=this._atomsIndexes[a],this._residue.addAtom(a,l,s,void 0,!0,n," ",1,0,c)}}},{key:"_parseBonds",value:function(e,t){for(var n=0;n<t;n++){r=e.getNextString();var r,i=parseInt(r.substr(0,3),10)+this._atomsParsed,o=parseInt(r.substr(3,3),10)+this._atomsParsed,s=parseInt(r.substr(6,3),10);o<i&&(i=(r=[o,i])[0],o=r[1]),this._complex.addBond(i,o,ou[s]||1,su[s]||nu.BondType.UNKNOWN,!0)}}},{key:"_parseMOL",value:function(e){this._compoundIndx++,this._parseHeader(e);var t=e.getStringFromStart(3),n=parseInt(t.substr(0,3),10),t=parseInt(t.substr(3,3),10);this._parseAtoms(e,n),this._parseBonds(e,t),this._atomsParsed+=n,this._metadata.molecules[this._compoundIndx]._residues=[],this._metadata.molecules[this._compoundIndx]._residues.push(this._residue)}},{key:"_parseDataItem",value:function(e){for(var t=e.getCurrentString(),n=[],r=e.getNextString();""!==r.trim();)n.push(r),r=e.getNextString();1===n.length&&(n=m(n,1)[0]),this._currentMolProps[t.replace(/[<>]/g,"").trim()]=n}},{key:"_parseCompound",value:function(e){if(this._parseMOL(e),this._format===lu){for(this._currentMolProps={};e.findNextDataItem();)this._parseDataItem(e);var t;0!==Object.keys(this._currentMolProps).length&&((t=this._metadata.molecules[this._compoundIndx]).props=this._currentMolProps,this._tryToUpdateMoleculeData(t))}}},{key:"_fixBondsArray",value:function(){for(var e=this._serialAtomMap,t=this._complex._bonds,n=0;n<t.length;n++){var r=t[n];r._right,r._left,r._left=e[r._left]||null,r._right=e[r._right]||null}}},{key:"_buildAssemblies",value:function(){var e=this._complex._chains;if(1===e.length)return this._assemblies;for(var t=0;t<e.length;t++){var n=new Lt(this._complex),r=new ae.Matrix4;n.addMatrix(r),n.addChain(e[t]._name),this._assemblies.push(n)}return this._assemblies}},{key:"_buildMolecules",value:function(){this._complex._molecules=[];for(var e=this._metadata.molecules,t=0;t<e.length;t++){var n=new ru(this._complex,e[t].name,t+1);n.residues=e[t]._residues,this._complex._molecules[t]=n}return this._complex._molecules}},{key:"_searchTag",value:function(e,t){for(var n=0;n<t.length;n++)if(e instanceof RegExp&&e.test(t[n].tag)||e===t[n].tag)return t[n].data}},{key:"_tryToFind",value:function(e,t){for(var n=0;n<e.length;n++){var r=this._searchTag(e[n],t);if(r)return r}}},{key:"_tryToUpdateMoleculeData",value:function(e){for(var t=!1,n=0;n<hu.length;n++){var r=fu[hu[n]],r=this._tryToFind(r,e.props);r&&(e[hu[n]]=r,t=!0)}return e.name=e.name||e.id,e.name.match(/^\d+$/)&&(e.name="CID: ".concat(e.name)),t}},{key:"_finalizeMetadata",value:function(){var e=this._metadata.molecules,t=this._complex.metadata,n=this._complex;if(1===e.length)n.name=e[0].name,t.title=e[0].title,t.date=e[0].date,t.properties=e[0].props;else if(1<e.length){t.molecules=[];for(var r=0;r<e.length;r++)t.molecules.push({name:e[r].name,date:e[r].date,title:e[r].title,properties:e[r].props})}}},{key:"_finalize",value:function(){for(var e=this._serialAtomMap={},t=this._complex._atoms,n=0;n<t.length;n++){var r=t[n];e[r.serial]=r}this._complex._finalizeBonds(),this._fixBondsArray(),this._finalizeMetadata(),this._buildAssemblies(),this._complex.units=this._complex.units.concat(this._assemblies),this._buildMolecules(),this._complex.finalize({needAutoBonding:!1,detectAromaticLoops:!1,enableEditing:!1,serialAtomMap:this._serialAtomMap})}},{key:"defineFormat",value:function(e){e=cu.test(e)?lu:uu;return e}},{key:"parseSync",value:function(){var e=this._complex=new eu,t=new Ql(this._data);for(this._format=this.defineFormat(this._data),e.metadata.format=this._format;this._parseCompound(t),t.findNextCompoundStart(););return this._finalize(),e}}]),r}();function du(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}ji.formats=["mol","sdf"],ji.extensions=[".mol",".sdf"];var pu={nstart:[Fl,"i16",0],extent:[Fl,"i16",3],grid:[Fl,"i16",6],cellDims:[zl,"i16",9],angles:[Fl,"i16",12],div:[Vl,"i16",15],adder:[Vl,"i16",16],scaleFactor:[Vl,"i16",17]},mu=function(){A(t,Ul);var e=du(t);function t(){return j(this,t),e.apply(this,arguments)}return _(t,[{key:"_parseHeader",value:function(e){this._buff=e,this._typedCheck();var t={};if(t.i16=new Int16Array(this._buff),100!==t.i16[18])for(var n=0,r=t.i16.length;n<r;++n){var i=t.i16[n];t.i16[n]=(255&i)<<8|i>>8&255}if(100!==t.i16[18])throw new Error("DSN6: Incorrect format ");var o=this._header;this._fillHeader(pu,t),o.cellDims.multiplyScalar(1/o.scaleFactor),o.angles.forEach(function(e,t,n){n[t]*=Math.PI/180/o.scaleFactor}),o.div/=100}},{key:"_setAxisIndices",value:function(){this._xyz2crs[0]=0,this._xyz2crs[1]=1,this._xyz2crs[2]=2}},{key:"_setOrigins",value:function(){var e=this._header,t=this._getAxis(),n=m(t,3),r=n[0],t=n[1],n=n[2];this._setAxisIndices(),this._origin.addScaledVector(r,e.nstart[0]),this._origin.addScaledVector(t,e.nstart[1]),this._origin.addScaledVector(n,e.nstart[2]),r.multiplyScalar(e.extent[0]),t.multiplyScalar(e.extent[1]),n.multiplyScalar(e.extent[2]),this._setBoxParams(r,t,n)}},{key:"_pointCalculate",value:function(e,t,n,r,i,o,s){var a=this._header;return i<a.extent[0]&&r<a.extent[1]&&n<a.extent[2]?(e[i+a.extent[0]*(r+a.extent[1]*n)]=(t[o.counter]-a.adder)/a.div,++o.counter,!0):(o.counter+=8-s,!1)}},{key:"_blockCalculate",value:function(e,t,n,r,i,o){for(var s=0;s<8;++s)for(var a=8*n+s,c=0;c<8;++c)for(var l=8*r+c,u=!0,h=0;u&&h<8;){var f=8*i+h,u=this._pointCalculate(e,t,a,l,f,o,h);h++}}},{key:"_toXYZData",value:function(){for(var e=this._header,t=new Uint8Array(this._buff),n=new Float32Array(e.extent[0]*e.extent[1]*e.extent[2]),r=new ae.Vector3(e.extent[0]/8,e.extent[1]/8,e.extent[2]/8),i={counter:512},o=0;o<r.z;++o)for(var s=0;s<r.y;++s)for(var a=0;a<r.x;++a)this._blockCalculate(n,t,o,s,a,i);return this._calculateInfoParams(n),n}},{key:"_calculateInfoParams",value:function(e){this._header.dmean/=e.length;for(var t=0,n=e[0],r=e[0],i=0;i<e.length;i++)t+=Math.pow(this._header.dmean-e[i],2),e[i]<n&&(n=e[i]),e[i]>r&&(r=e[i]);this._header.sd=Math.sqrt(t/e.length),this._header.dmax=r,this._header.dmin=n}}]),t}(),Yi=function(){A(r,Bc);var n=du(r);function r(e,t){return j(this,r),(t=n.call(this,e,t))._options.fileType="dsn6",t.model=new mu,t}return _(r,[{key:"parseSync",value:function(){return this.model.parse(this._data)}}],[{key:"canParse",value:function(e,t){return!!e&&(e instanceof ArrayBuffer&&Bc.checkDataTypeOptions(t,"dsn6"))}},{key:"canProbablyParse",value:function(){return!1}}]),r}();function yu(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}Yi.formats=["dsn6"],Yi.extensions=[".dsn6",".omap"],Yi.binary=!0;var _u=function(){A(n,Gc);var t=yu(n);function n(e){return j(this,n),(e=t.call(this,e))._next=-1,e.next(),e}return _(n,[{key:"getNext",value:function(){return this._next}}]),n}();function vu(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var gu=wn.Complex,xu=wn.Element,bu=wn.Molecule,$i=function(){A(r,Bc);var n=vu(r);function r(e,t){return j(this,r),(t=n.call(this,e,t))._time=null,t._numAtoms=null,t._residueNumber=null,t._residueName="",t._atomName="",t._atomNumber=null,t._atomPosition=[],t._atomVelocity=[],t._complex=null,t._molecules=[],t._molecule=null,t._options.filetype="gro",t}return _(r,[{key:"canProbablyParse",value:function(e){return b.default.isString(this._data)&&/^\s*[^\n]*\n\s*\d+ *\n\s*\d+[^\n\d]{3}\s*\w+\s*\d+\s*-?\d/.test(e)}},{key:"_parseTitle",value:function(e){var t=this._complex.metadata;t.id=e.readLine().trim(),t.name=t.id.slice(t.id.lastIndexOf("\\")+1,t.id.lastIndexOf(".")),t.format="gro"}},{key:"_parseNumberOfAtoms",value:function(e){if(this._numAtoms=e.readInt(0,e.getNext()),Number.isNaN(this._numAtoms))throw new Error("Line 2 is not representing atom number. Consider checking input file")}},{key:"_parseAtom",value:function(e){this._residueNumber=e.readInt(1,5),this._residueName=e.readString(6,10).trim(),this._atomName=e.readString(11,15).trim(),this._atomNumber=e.readInt(16,20);var t,n,r,i=10*e.readFloat(21,28),o=10*e.readFloat(29,36),s=10*e.readFloat(37,45);Number.isNaN(i)||Number.isNaN(o)||Number.isNaN(s)?this._complex.error={message:'Atom position is invalid in "'.concat(e.readLine(),'"')}:"Unknown"!==(t=xu.getByName(this._atomName[0])).fullName?(n=xu.Role[this._atomName],(r=this._chain)||(this._chain=r=this._complex.addChain("A")),(e=this._residue)&&e.getSequence()===this._residueNumber||(this._residue=e=r.addResidue(this._residueName,this._residueNumber," ")),this._atomPosition=new ae.Vector3(i,o,s),e.addAtom(this._atomName,t,this._atomPosition,n,!0,this._atomNumber," ",1,1,0)):this._complex.error={message:"".concat(this._atomName[0]," hasn't been recognised as an atom name.")}}},{key:"_finalize",value:function(){var e=new bu(this._complex,this._complex.metadata.name,1);e.residues=this._chain._residues,e._chains=this._chain,this._complex._molecules[0]=e,this._molecules.push(e),this._complex.finalize({needAutoBonding:!0,detectAromaticLoops:this.settings.now.aromatic,enableEditing:this.settings.now.editing,serialAtomMap:this._serialAtomMap})}},{key:"parseSync",value:function(){var e=this._complex=new gu,t=new _u(this._data),n=0;for(this._parseTitle(t),t.next(),this._parseNumberOfAtoms(t),t.next(),n=0;n<this._numAtoms&&!t.end();++n)this._parseAtom(t),t.next();if(n<this._numAtoms&&(this._complex.error={message:"File ended unexpectedly."}),e.error)throw new Error(e.error.message);return this._finalize(),this._atomPosition=null,this._complex=null,this._molecules=null,this._molecule=null,e}}]),r}();function wu(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}$i.formats=["gro"],$i.extensions=[".gro"];var Su=wn.Complex,Ru=wn.Element,Cu=wn.Bond,Au=wn.Molecule,Eu={un:0,1:1,2:2,3:3,ar:1,am:1,nc:0,du:1},ku={un:Cu.BondType.UNKNOWN,1:Cu.BondType.COVALENT,2:Cu.BondType.COVALENT,3:Cu.BondType.COVALENT,ar:Cu.BondType.AROMATIC,am:Cu.BondType.COVALENT,nc:Cu.BondType.UNKNOWN,du:Cu.BondType.COVALENT},Tu=/\d+$/,Pu=/\s+/;function Mu(e){return e.trim().split(Pu)}so=function(){A(r,Bc);var n=wu(r);function r(e,t){return j(this,r),(t=n.call(this,e,t))._complex=null,t._chain=null,t._residue=null,t._compoundIndx=-1,t._molecules=[],t._molecule=null,t._currPosIdx=0,t._currStartIdx=0,t._serialAtomMap={},t._options.fileType="mol2",t}return _(r,[{key:"_parseRawStrings",value:function(e){return e.split(/\r?\n|\r/)}},{key:"_toStringFromStart",value:function(e,t){e=this._currStartIdx+e;this._currPosIdx=e<t.length?e:this._currStartIdx}},{key:"_toHeaderString",value:function(e,t){for(this._toStringFromStart(0,t);this._currPosIdx<t.length;){if(t[this._currPosIdx].match("@<TRIPOS>".concat(e)))return;this._currPosIdx++}this._toStringFromStart(0,t)}},{key:"_toStringFromHeader",value:function(e,t,n){this._toHeaderString(e,n);t=this._currPosIdx+t;n[this._currPosIdx].match("@<TRIPOS>".concat(e))&&t<n.length&&(this._currPosIdx=t)}},{key:"_setStart",value:function(e,t){e>=t.length?this._currStartIdx=this._currPosIdx=t.length-1:this._currStartIdx=this._currPosIdx=e}},{key:"_probablyHaveDataToParse",value:function(e){return this._currPosIdx<e.length-2}},{key:"_findNextCompoundStart",value:function(e){for(;this._currPosIdx<e.length&&"@<TRIPOS>MOLECULE>"!==e[this._currPosIdx].trim();)this._currPosIdx++;return this._setStart(++this._currPosIdx,e),this._probablyHaveDataToParse(e)}},{key:"_parseMolecule",value:function(e){this._toHeaderString("MOLECULE",e);var t=this._complex.metadata;t.name=e[++this._currPosIdx],t.format="mol2",this._molecule={_index:"",_chains:[]},this._molecule._index=this._compoundIndx+1,this._molecules.push(this._molecule)}},{key:"_parseAtoms",value:function(e,t){this._toHeaderString("ATOM",t);for(var n=0;n<e;n++){var r=Mu(t[++this._currPosIdx]);if(r.length<6)throw new Error("MOL2 parsing error: Not enough information to create atom!");var i=parseInt(r[0],10),o=r[1],s=parseFloat(r[2]),a=parseFloat(r[3]),c=parseFloat(r[4]),l=r[5].split(".")[0].toUpperCase(),u=0;9<=r.length&&(u=parseFloat(r[8])||0),this._chain||(this._chain=this._complex.getChain("A")||this._complex.addChain("A"),this._residue=null),this._setResidue(r)&&(r=Ru.getByName(l),l=Ru.Role[o],c=new ae.Vector3(s,a,c),this._residue.addAtom(o,r,c,l,!1,i," ",1,0,u))}}},{key:"_setResidue",value:function(e){var t=1,n="UNK";if(7<=e.length&&(t=parseInt(e[6],10)),8<=e.length&&"<0>"!==e[7]&&(n=e[7].replace(Tu,"")),this.settings.now.nowater&&("HOH"===n||"WAT"===n))return!1;var r=this._residue,e=this._chain;return r&&r.getSequence()===t||(this._residue=e.addResidue(n,t,"A")),!0}},{key:"_parseBonds",value:function(e,t){this._toHeaderString("BOND",t);for(var n=0;n<e;n++){var r=Mu(t[++this._currPosIdx]);if(r.length<3)throw new Error("MOL2 parsing error: Missing information about bonds!");var i=parseInt(r[1],10),o=parseInt(r[2],10),s=r[3];o<i&&(i=(r=[o,i])[0],o=r[1]),this._complex.addBond(i,o,Eu[s]||0,ku[s]||Cu.BondType.UNKNOWN,!0)}}},{key:"_fixSerialAtoms",value:function(){for(var e=this._complex._atoms,t=0;t<e.length;t++){var n=e[t];this._serialAtomMap[n.serial]=n}}},{key:"_fixBondsArray",value:function(){var e=this._serialAtomMap,t=this._complex;if(0===Object.keys(e).length)throw new Error("MOL2 parsing error: Missing atom information!");for(var n=t._bonds,r=0;r<n.length;r++){var i=n[r];i._left=e[i._left]||null,i._right=e[i._right]||null}}},{key:"_finalizeMolecules",value:function(){var e=this._complex._chains[0];this._complex._molecules=[];for(var t=0;t<this._molecules.length;t++){var n=this._molecules[t],r=e._residues,n=new Au(this._complex,n._name,t+1);n.residues=r,this._complex._molecules[t]=n}}},{key:"_finalize",value:function(){this._complex._finalizeBonds(),this._fixSerialAtoms(),this._fixBondsArray(),this._finalizeMolecules(),this._complex.finalize({needAutoBonding:!1,detectAromaticLoops:this.settings.now.aromatic,enableEditing:this.settings.now.editing,serialAtomMap:this._serialAtomMap})}},{key:"_parseCompound",value:function(e){this._compoundIndx++,this._parseMolecule(e),this._toStringFromHeader("MOLECULE",2,e);var t=e[this._currPosIdx].trim().split(Pu),n=t[0],t=t[1];this._parseAtoms(n,e),this._parseBonds(t,e)}},{key:"parseSync",value:function(){for(var e=this._complex=new Su,t=this._parseRawStrings(this._data);this._parseCompound(t),this._findNextCompoundStart(t););return this._finalize(),e}}]),r}();so.formats=["mol2"],so.extensions=[".mol2",".ml2",".sy2"];co=new Vr([ci,Wi,Bi,Gi,Ri,Hi,ji,Ui,Yi,$i,so]);function Nu(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var ho=function(){A(n,qn);var t=Nu(n);function n(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[];return j(this,n),t.call(this,e,["formats"])}return _(n,[{key:"find",value:function(e){var t=[];return e.format&&(t=this._dict.formats[e.format.toLowerCase()]||[]),Yn(t)}}]),n}(),Iu=function(){function n(e,t){j(this,n),this._source=e,this._options=t||{},this._abort=!1}return _(n,[{key:"exportSync",value:function(){throw new Error("Exporting to this source is not implemented")}},{key:"export",value:function(){var n=this;return new Promise(function(e,t){setTimeout(function(){try{return n._abort?t(new Error("Export aborted")):e(n.exportSync())}catch(e){return t(e)}})})}},{key:"abort",value:function(){this._abort=!0}}]),n}();$n(Iu.prototype);var Lu=function(){function e(){j(this,e),this._resultArray=[],this._currentStr=-1,this._tag=null,this._fixedNumeration=!1,this._numeration=!1,this._tagStrNum=0}return _(e,[{key:"getResult",value:function(){return this.writeString("\n",81,81),this._resultArray.join("")}},{key:"_currentStrLength",value:function(){var e=this._resultArray[this._currentStr];return e?e.length:0}},{key:"newTag",value:function(e,t){this._tag=e||null,b.default.isUndefined(t)?(this._numeration=!1,this._fixedNumeration=!1,this._tagStrNum=0):b.default.isNumber(t)?(this._tagStrNum=t,this._numeration=!0,this._fixedNumeration=!0):b.default.isBoolean(t)&&(this._tagStrNum=0,this._numeration=t,this._fixedNumeration=!1)}},{key:"newString",value:function(e){this.writeString("\n",81,81),this._currentStr++,this._resultArray.push(""),e?this.writeString(e,1,6):this._tag&&this.writeString(this._tag,1,6),this._numeration&&(this._fixedNumeration||this._tagStrNum++,1!==this._tagStrNum&&this.writeString(this._tagStrNum.toString(),10,8))}},{key:"writeEntireString",value:function(e,t,n){t=t||81;for(var r=0;r<e.length;r++)this._currentStrLength()===t&&r!==e.length-1&&(this.newString(),n&&this.writeString(n.tag,n.begin,n.end)),"\n"===e[r]?this.newString():this.writeString(e[r])}},{key:"writeString",value:function(e,t,n){var r,i,o=this._resultArray[this._currentStr],s=o?o.length:0;b.default.isUndefined(e)||(b.default.isNumber(t)||(t=s+1),b.default.isNumber(n)||(n=s+e.length),r=t<n?n:t,i=t<n?t:n,(e=b.default.isString(e)?e:e.toString()).length>Math.abs(t-n)+1&&(e=e.substr(0,Math.abs(t-n+1))),s+1<i?this._resultArray[this._currentStr]+=" ".repeat(i-s-1):i<=s&&(s=this._resultArray[this._currentStr],this._resultArray[this._currentStr]=s.slice(0,i-1)),n<t&&(e=" ".repeat(t-n+1-e.length)+e),11===i&&this._numeration&&1!==this._tagStrNum&&(e=" ".concat(e)),this._resultArray[this._currentStr]+=e,r>(o=this._resultArray[this._currentStr]).length&&(this._resultArray[this._currentStr]+=" ".repeat(r-o.length)))}},{key:"writeBondsArray",value:function(e,t){for(var n=this._getSubArrays(e,4),r=0;r<n.length;r++){this.newString(),this.writeString(t.serial,11,7);for(var i=0;i<n[r].length;i++){var o=(n[r][i]._left.serial===t.serial?n[r][i]._right:n[r][i]._left).serial;this.writeString(o,16+5*i,12+5*i)}}}},{key:"_getSubArrays",value:function(e,t){for(var n=[],r=0;r<e.length;r+=t)n.push(e.slice(r,r+t));return n}},{key:"writeMatrix",value:function(e,t,n){for(var r=0;r<3;r++){this.newString(),this.writeString(n,14,18),this.writeString((r+1).toString(),19,19),this.writeString(t.toString(),23,20);for(var i=0;i<3;i++){var o=parseFloat(e.elements[4*r+i]).toFixed(6);this.writeString(o.toString(),33+10*i,24+10*i)}var s=parseFloat(e.elements[4*r+3]).toFixed(5);this.writeString(s.toString(),68,55)}}},{key:"writeMatrices",value:function(e,t){if(e)for(var n=new ae.Matrix4,r=0;r<e.length;r++)n.copy(e[r]).transpose(),this.writeMatrix(n,r+1,t)}}]),e}();function Du(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}go=function(){A(r,Iu);var n=Du(r);function r(e,t){return j(this,r),(t=n.call(this,e,t))._tags=["HEADER","TITLE","COMPND","REMARK","HELIX","SHEET","ATOM and HETATM","CONECT"],t._result=null,t._tagExtractors={HEADER:t._extractHEADER,TITLE:t._extractTITLE,"ATOM and HETATM":t._extractATOM,CONECT:t._extractCONECT,COMPND:t._extractCOMPND,REMARK:t._extractREMARK,HELIX:t._extractHELIX,SHEET:t._extractSHEET},t._stringForRemark350="COORDINATES FOR A COMPLETE MULTIMER REPRESENTING THE KNOWN\nBIOLOGICALLY SIGNIFICANT OLIGOMERIZATION STATE OF THE\nMOLECULE CAN BE GENERATED BY APPLYING BIOMT TRANSFORMATIONS\nGIVEN BELOW.  BOTH NON-CRYSTALLOGRAPHIC AND\nCRYSTALLOGRAPHIC OPERATIONS ARE GIVEN.",t._stringForRemark290="CRYSTALLOGRAPHIC SYMMETRY TRANSFORMATIONS\nTHE FOLLOWING TRANSFORMATIONS OPERATE ON THE ATOM/HETATM\nRECORDS IN THIS ENTRY TO PRODUCE CRYSTALLOGRAPHICALLY\nRELATED MOLECULES.",t}return _(r,[{key:"exportSync",value:function(){var e=new Lu;if(!this._source)return this._result;for(var t=0;t<this._tags.length;t++){var n=this._tags[t],n=this._tagExtractors[n];b.default.isFunction(n)&&n.call(this,e)}return this._result=e.getResult(),this._result}},{key:"_extractHEADER",value:function(e){var t;this._source.metadata&&(t=this._source.metadata,e.newTag("HEADER"),e.newString(),t.classification&&e.writeString(t.classification,11,50),t.date&&e.writeString(t.date,51,59),t.id&&e.writeString(t.id,63,66))}},{key:"_extractTITLE",value:function(e){if(this._source.metadata){var t=this._source.metadata;if(t.title){e.newTag("TITLE",!0);for(var n=0;n<t.title.length;n++)e.newString(),e.writeString(t.title[n],11,80)}}}},{key:"_extractCONECT",value:function(e){if(this._source._atoms){var t=this._source._atoms;e.newTag("CONECT");for(var n=0;n<t.length;n++){var r=t[n].bonds.filter(function(e){return e._fixed});0!==r.length&&e.writeBondsArray(r.reverse(),t[n])}}}},{key:"_extractSHEET",value:function(e){if(this._source._sheets){e.newTag("SHEET");for(var t=this._source._sheets,n=0;n<t.length;n++)if(t[n]._strands)for(var r=t[n]._strands,i=0;i<r.length;i++)e.newString(),e.writeString(i+1,10,8),e.writeString(t[n]._name,14,12),e.writeString(r.length,16,15),e.writeString(r[i].init._type._name,18,20),e.writeString(r[i].init._chain._name,22,22),e.writeString(r[i].init._sequence,26,23),e.writeString(r[i].init._icode,27,27),e.writeString(r[i].term._type._name,29,31),e.writeString(r[i].init._chain._name,33,33),e.writeString(r[i].term._sequence,37,34),e.writeString(r[i].term._icode,38,38),e.writeString(r[i].sense,40,39)}}},{key:"_extractHELIX",value:function(e){if(this._source._helices){e.newTag("HELIX");for(var t=this._source._helices,n=0;n<t.length;n++){var r=t[n],i=b.default.invert(Qe);e.newString(),e.writeString(r.serial,10,8),e.writeString(r.name,14,12),e.writeString(r.init._type._name,16,18),e.writeString(r.init._chain._name,20,20),e.writeString(r.init._sequence,25,22),e.writeString(r.init._icode,26,26),e.writeString(r.term._type._name,28,30),e.writeString(r.term._chain._name,32,32),e.writeString(r.term._sequence,37,34),e.writeString(r.term._icode,38,38),e.writeString(i[r.type],40,39),e.writeString(r.comment,41,70),e.writeString(r.length,76,72)}}}},{key:"_extractATOM",value:function(e){if(this._source._atoms)for(var t=this._source._atoms,n=0;n<t.length;n++){var r=t[n].het?"HETATM":"ATOM";e.newString(r);r=1<t[n].element.name.length||3<t[n].name.length?13:14;e.writeString(t[n].serial,11,7),e.writeString(t[n].name,r,16),e.writeString(String.fromCharCode(t[n].location),17,17),e.writeString(t[n].residue._type._name,20,18),e.writeString(t[n].residue._chain._name,22,22),e.writeString(t[n].residue._sequence,26,23),e.writeString(t[n].residue._icode,27,27),e.writeString(t[n].position.x.toFixed(3),38,31),e.writeString(t[n].position.y.toFixed(3),46,39),e.writeString(t[n].position.z.toFixed(3),54,47),e.writeString(t[n].occupancy.toFixed(2),60,55),e.writeString(t[n].temperature.toFixed(2),66,61),e.writeString(t[n].element.name,78,77),t[n].charge&&e.writeString(t[n].charge,79,80)}}},{key:"_extractCOMPND",value:function(e){if(this._source._molecules){var t=this._source._molecules;e.newTag("COMPND",!0);for(var n=0;n<t.length;n++){var r=this._getMoleculeChains(t[n]);e.newString(),e.writeString("MOL_ID: ".concat(t[n].index,";"),11,80),e.newString(),e.writeString("MOLECULE: ".concat(t[n].name,";"),11,80),e.newString(),e.writeString("CHAIN: ",11,18);r="".concat(r.join(", "),";");e.writeEntireString(r,81)}}}},{key:"_extractREMARK",value:function(e){this._Remark290(e),this._Remark350(e)}},{key:"_Remark290",value:function(e){var t;this._source.symmetry&&0!==this._source.symmetry.length&&(t=this._source.symmetry,e.newTag("REMARK",290),e.newString(),e.newString(),e.writeEntireString(this._stringForRemark290),e.writeMatrices(t,"SMTRY"),e.newString(),e.newString(),e.writeString("REMARK: NULL",11,80))}},{key:"_Remark350",value:function(e){if(this._source.units){var t=this._source.units,n=0;e.newTag("REMARK",350),e.newString(),e.newString(),e.writeEntireString(this._stringForRemark350);for(var r=t.filter(function(e){return e instanceof Lt}),i=0;i<r.length;i++){e.newString(),e.newString(),n++,e.writeString("BIOMOLECULE: ".concat(n),11,80);var o=r[i].chains.join(", ");e.newString(),e.writeString("APPLY THE FOLLOWING TO CHAINS: "),e.writeEntireString(o,69,{tag:"AND CHAINS: ",begin:31,end:42});o=r[i].matrices;e.writeMatrices(o,"BIOMT")}}}},{key:"_getMoleculeChains",value:function(e){var n=e.residues.map(function(e){return e._chain._name});return n.filter(function(e,t){return n.indexOf(e)===t})}}]),r}();go.formats=["pdb"],go.SourceClass=gn;function Ou(e,t,n,r){n[r]=e[t],n[r+1]=e[t+1],n[r+2]=e[t+2]}function Vu(e,t,n,r,i){n[r]=e[t],n[r+1]=e[t+1],n[r+2]=e[t+2],n[r+3]=i}var zu=new ae.Vector4;function Fu(e,t,n,r,i){zu.set(e[t],e[t+1],e[t+2],i.w),zu.applyMatrix4(i.matrix),n[r]=zu.x,n[r+1]=zu.y,n[r+2]=zu.z}function Bu(e,t,n,r,i){if(!((t.array.length-t.start)/t.stride<n||(e.array.length-e.start)/e.stride<n))if(e.stride===t.stride)t.array.set(e.array,t.start);else for(var o=t.start,s=e.start,a=0;a<n;++a,o+=t.stride,s+=e.stride)r(e.array,s,t.array,o,i)}var Uu=function(){function e(){j(this,e),this.positions=null,this.normals=null,this.colors=null,this.indices=null,this.lastPos=0,this.lastNorm=0,this.lastCol=0,this.lastIdx=0}return _(e,[{key:"init",value:function(e,t){this.positions=new Float32Array(3*e),this.normals=new Float32Array(3*e),this.colors=new Float32Array(4*e),this.indices=new Int32Array(t)}},{key:"setPositions",value:function(e,t,n,r){Bu({array:e,start:t,stride:r},{array:this.positions,start:this.lastPos,stride:3},n,Ou),this.lastPos+=3*n}},{key:"setTransformedPositions",value:function(e,t,n,r,i){for(var o=this.lastPos,s=t,a={matrix:i,w:1},c=0;c<n;++c,s+=r,o+=3)Fu(e,s,this.positions,o,a);this.lastPos+=3*n}},{key:"setNormals",value:function(e,t,n,r){Bu({array:e,start:t,stride:r},{array:this.normals,start:this.lastNorm,stride:3},n,Ou),this.lastNorm+=3*n}},{key:"setTransformedNormals",value:function(e,t,n,r,i){for(var o=this.lastNorm,s=t,a={matrix:i,w:0},c=0;c<n;++c,s+=r,o+=3)Fu(e,s,this.normals,o,a);this.lastNorm+=3*n}},{key:"setColors",value:function(e,t,n,r){Bu({array:e,start:t,stride:r},{array:this.colors,start:this.lastCol,stride:4},n,Vu,1),this.lastCol+=4*n}},{key:"setIndices",value:function(e,t,n){this.indices.set(e,this.lastIdx),this.lastIdx+=n}},{key:"setShiftedIndices",value:function(e,t,n){e=e.map(function(e){return e+n});this.setIndices(e,0,t)}},{key:"getVerticesNumber",value:function(){return this.lastPos/3}},{key:"addInstance",value:function(e,t){var n=this.getVerticesNumber();this.setShiftedIndices(t.indices,t.indices.length,n);n=t.itemSize;this.setTransformedPositions(t.positions,0,t.vertsCount,n.position,e),this.setTransformedNormals(t.normals,0,t.vertsCount,n.normal,e),this.setColors(t.colors,0,t.vertsCount,n.color)}}]),e}(),Gu=function(){function e(){j(this,e),this.positions=null,this.normals=null,this.colors=null,this.indices=null,this.vertsCount=0,this.itemSize=null}return _(e,[{key:"init",value:function(e){e=e.attributes;this.itemSize={position:e.position.itemSize,normal:e.normal.itemSize,color:e.color.itemSize}}}]),e}();function ju(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var Hu=function(){A(r,Gu);var e=ju(r);function r(){return j(this,r),e.apply(this,arguments)}return _(r,[{key:"init",value:function(e,t){tt(P(r.prototype),"init",this).call(this,e,t);var n=e.attributes,t=n.position,n=n.normal,e=e.index;this.vertsCount=t.count,this.positions=t.array,this.normals=n.array,this.colors=new Float32Array(this.vertsCount*this.itemSize.color),this.indices=e.array}},{key:"setColors",value:function(e){for(var t=0,n=0,r=this.colors.length,i=this.itemSize.color;n<r;n+=i)this.colors[t++]=e.r,this.colors[t++]=e.g,this.colors[t++]=e.b}}]),r}();function Wu(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var Yu=function(){A(i,Gu);var t=Wu(i);function i(){var e;return j(this,i),(e=t.call(this))._cutRawStart=0,e._cutRawEnd=0,e._facesPerSlice=0,e}return _(i,[{key:"init",value:function(e,t){tt(P(i.prototype),"init",this).call(this,e,t);var n=e.attributes.position,r=e.index;this.vertsCount=n.count+t.addPerCylinder,this._facesPerSlice=t.addPerCylinder,this.positions=new Float32Array(this.vertsCount*n.itemSize),this.normals=new Float32Array(this.vertsCount*this.itemSize.normal),this.colors=new Float32Array(this.vertsCount*this.itemSize.color),this._extendVertices(e,t),this.indices=new Uint32Array(r.count),this._extendIndices(e,t)}},{key:"_extendVertices",value:function(e,t){var n=e.attributes.position,r=e.attributes.normal,e=e.getGeoParams();this._cutRawStart=+e.radialSegments,this._cutRawEnd=this._cutRawStart+t.addPerCylinder;t=n.array.slice(0,this._cutRawEnd*n.itemSize);this.positions.set(t,0),t=r.array.slice(0,this._cutRawEnd*r.itemSize),this.normals.set(t,0);t=n.array.slice(this._cutRawStart*n.itemSize,n.array.length);this.positions.set(t,this._cutRawEnd*n.itemSize),t=r.array.slice(this._cutRawStart*r.itemSize,r.array.length),this.normals.set(t,this._cutRawEnd*r.itemSize)}},{key:"_extendIndices",value:function(e,t){var n=e.index,e=6*t.addPerCylinder,r=t.addPerCylinder,t=(t=n.array.slice(e,n.count)).map(function(e){return e+r});this.indices.set(n.array,0),this.indices.set(t,e)}},{key:"_setColorRange",value:function(e,t,n,r){for(var i=r.length,o=e;o<t;o+=i)n.set(r,o)}},{key:"setColors",value:function(e,t){var n=this.itemSize.color,r=this._cutRawEnd*n,i=2*r;this._setColorRange(0,r,this.colors,e.toArray()),this._setColorRange(r,i,this.colors,t.toArray()),i<this.colors.length&&(n=i+(r=(this._facesPerSlice+1)*n),this._setColorRange(i,n,this.colors,t.toArray()),r=n+r,this._setColorRange(n,r,this.colors,e.toArray()))}}]),i}(),Xu=function(){function e(){j(this,e),this._materials=[],this._models=[]}return _(e,[{key:"process",value:function(e){this._extractModelsAndMaterials(e);var t=this._flattenModels();return{name:e.name,models:t,materials:this._materials}}},{key:"_extractModelsAndMaterials",value:function(e){var t=this,n=new ae.Layers;n.set(Fn.LAYERS.DEFAULT),n.enable(Fn.LAYERS.TRANSPARENT),e.traverse(function(e){e instanceof ae.Mesh&&e.layers.test(n)&&t.checkExportAbility(e)&&("InstancedBufferGeometry"===e.geometry.type?t._collectInstancedGeoInfo(e):t._collectGeoInfo(e))})}},{key:"_reworkIndices",value:function(e){for(var t=2;t<e.length;t+=3)e[t]*=-1,e[t]--}},{key:"_flattenModels",value:function(){var t=0;function e(e){return e+t}for(var n=[],r=0,i=this._models.length;r<i;r++){for(var o=this._models[r],s=[],a=[],c=[],l=[],t=0,u=0;u<o.length;u++){var h=o[u];s.push(h.indices.map(e)),t+=h.getVerticesNumber(),a.push(h.positions),c.push(h.normals),l.push(h.colors)}s=ce.mergeTypedArraysUnsafe(s),this._reworkIndices(s),a=ce.mergeTypedArraysUnsafe(a),c=ce.mergeTypedArraysUnsafe(c),l=ce.mergeTypedArraysUnsafe(l),n.push({indices:s,positions:a,normals:c,colors:l,verticesCount:t})}return n}},{key:"checkExportAbility",value:function(e){return 0!==e.geometry.attributes.position.count&&(e instanceof ro?(B.warn("Currently we cannot export 'sprites' modes, like BS, WV, LC. Please turn of settings 'zSprites' and try again"),!1):!(e instanceof yo)||(B.warn("Currently we cannot export Lines mode"),!1))}},{key:"_collectGeoInfo",value:function(e){var t=e.geometry,n=t.attributes,r=n.position,i=n.color,o=n.normal,s=t.index,a=e.matrix,n=new Uu,t=r.count;n.init(t,s.count),a.isIdentity()?(n.setPositions(r.array,0,t,r.itemSize),n.setNormals(o.array,0,t,o.itemSize)):(n.setTransformedPositions(r.array,0,t,r.itemSize,a),n.setTransformedNormals(o.array,0,t,o.itemSize,a)),n.setColors(i.array,0,t,i.itemSize),n.setIndices(s.array,0,s.count);e=this._collectMaterialInfo(e);this._addToPool(n,e)}},{key:"_collectSpheresInfo",value:function(e){var t=e.geometry,n=t.attributes,r=n.position,i=n.color,t=t.index,o=e.matrix,s=new Uu,a=e.geometry.instanceCount,r=r.count,t=t.count;s.init(a*r,a*t);var c=new Hu;c.init(e.geometry);for(var l=new ae.Matrix4,u=new ae.Matrix4,h=new ae.Color,f=0;f<a;++f){var d=f*i.itemSize;h.fromArray(i.array,d),c.setColors(h),this._getSphereInstanceMatrix(e.geometry,f,l),u.multiplyMatrices(o,l),s.addInstance(u,c)}t=this._collectMaterialInfo(e);this._addToPool(s,t)}},{key:"_collectCylindersInfo",value:function(e){var t=e.geometry,n=t.attributes,r=n.position,i=n.color,o=n.color2,n=t.index,s=e.matrix,a=new Uu,c=e.geometry.instanceCount,l=new Hu;l.init(e.geometry);var u=this._gatherCylindersColoringInfo(e.geometry),h=null;0<u.needToSplit&&(h=new Yu).init(e.geometry,u);t=u.addPerCylinder*u.needToSplit,r=r.count,n=n.count;a.init(c*r+t,c*n);for(var f=new ae.Matrix4,d=new ae.Matrix4,p=new ae.Color,m=new ae.Color,y={},_=0;_<c;++_){var v=_*i.itemSize;u.is2Colored[_]?(p.fromArray(o.array,v),m.fromArray(i.array,v),h&&(h.setColors(p,m),y=h)):(p.fromArray(i.array,v),l.setColors(p),y=l),this._getCylinderInstanceMatrix(e.geometry,_,f),d.multiplyMatrices(s,f),a.addInstance(d,y)}n=this._collectMaterialInfo(e);this._addToPool(a,n)}},{key:"_addToPool",value:function(e,t){var n=this._checkExistingMaterial(t);n<0?(this._models.push([e]),this._materials.push(t)):this._models[n].push(e)}},{key:"_checkExistingMaterial",value:function(t){return b.default.findIndex(this._materials,function(e){return b.default.isEqual(e,t)})}},{key:"_gatherCylindersColoringInfo",value:function(e){for(var t=e.instanceCount,n=e.attributes.color.array,r=e.attributes.color2.array,i=e.attributes.color.itemSize,o=new Array(t),s=0,a=0,c=0;c<t;c++,a+=i){var l=1e-7<Math.abs(n[a]-r[a])||1e-7<Math.abs(n[a+1]-r[a+1])||1e-7<Math.abs(n[a+2]-r[a+2]);s+=o[c]=l}return{is2Colored:o,needToSplit:s,addPerCylinder:e.getGeoParams().radialSegments}}},{key:"_collectInstancedGeoInfo",value:function(e){e.geometry instanceof nr?this._collectSpheresInfo(e):e.geometry instanceof Er&&this._collectCylindersInfo(e)}},{key:"_collectMaterialInfo",value:function(e){e=e.material.uberOptions;return{diffuse:e.diffuse.toArray(),opacity:e.opacity,shininess:e.shininess,specular:e.specular.toArray()}}},{key:"_getCylinderInstanceMatrix",value:function(e,t,n){var r=e.attributes.matVector1.array,i=e.attributes.matVector2.array,e=e.attributes.matVector3.array,t=4*t;n.set(r[t],r[1+t],r[2+t],r[3+t],i[t],i[1+t],i[2+t],i[3+t],e[t],e[1+t],e[2+t],e[3+t],0,0,0,1)}},{key:"_getSphereInstanceMatrix",value:function(e,t,n){var r=e.attributes.offset,i=t*r.itemSize,o=r.array[i],e=r.array[1+i],t=r.array[2+i],i=r.array[3+i];n.set(i,0,0,o,0,i,0,e,0,0,i,t,0,0,0,1)}}]),e}(),qu=function(){function e(){j(this,e),this._resultArray=[],this._info=null}return _(e,[{key:"getResult",value:function(e){return this._info=e,this._resultArray.push(this._writeHeader()),this._resultArray.push(this._writeDefinitions()),this._resultArray.push(this._writeObjects(e.models,e.materials)),this._resultArray.push(this._writeRelations()),this._resultArray.push(this._writeConnections()),this._info=null,this._resultArray.join("")}},{key:"_writeHeader",value:function(){var e=new Date,t="Miew FBX Exporter v".concat(this._info.version);return"; FBX 6.1.0 project file\n; Created by ".concat(t," Copyright (c) 2015-2020 EPAM Systems, Inc.\n; For support please contact miew@epam.com\n; ----------------------------------------------------\n\nFBXHeaderExtension:  {\n  FBXHeaderVersion: ").concat(1003,"\n  FBXVersion: ").concat(6100,"\n  CreationTimeStamp:  {\n    Version: ").concat(1e3,"\n    Year: ").concat(e.getFullYear(),"\n    Month: ").concat(e.getMonth()+1," \n    Day: ").concat(e.getDate(),"\n    Hour: ").concat(e.getHours(),"\n    Minute: ").concat(e.getMinutes(),"\n    Second: ").concat(e.getSeconds(),"\n    Millisecond: ").concat(e.getMilliseconds(),'\n  }\n  Creator: "').concat(t,'"\n  OtherFlags:  {\n    FlagPLE: 0\n  }\n}\nCreationTime: "').concat(e,'"\nCreator: "').concat(t,'"  \n')}},{key:"_writeDefinitions",value:function(){return"\n; Object definitions\n;------------------------------------------------------------------\n\n".concat('\nDefinitions:  {\n  Version: 100\n  Count: 3\n  ObjectType: "Model" {\n    Count: 1\n  }\n  ObjectType: "Geometry" {\n    Count: 1\n  }\n  ObjectType: "Material" {\n    Count: 1\n  }\n  ObjectType: "Pose" {\n    Count: 1\n  }\n  ObjectType: "GlobalSettings" {\n    Count: 1\n  }\n} ',"\n")}},{key:"_models",value:function(){for(var e="",t=this._info.models,n=0;n<t.length;++n){var r=t[n],i=r.verticesCount;e+='\n  Model: "Model::'.concat(this._info.name,"_").concat(n,'", "Mesh" {\n    Version: ').concat(232," \n    ").concat('Properties60: {\n      Property: "QuaternionInterpolate", "bool", "",0\n      Property: "Visibility", "Visibility", "A",1\n      Property: "Lcl Translation", "Lcl Translation", "A",0.000000000000000,0.000000000000000,-1789.238037109375000\n      Property: "Lcl Rotation", "Lcl Rotation", "A",0.000009334667643,-0.000000000000000,0.000000000000000\n      Property: "Lcl Scaling", "Lcl Scaling", "A",1.000000000000000,1.000000000000000,1.000000000000000\n      Property: "RotationOffset", "Vector3D", "",0,0,0\n      Property: "RotationPivot", "Vector3D", "",0,0,0\n      Property: "ScalingOffset", "Vector3D", "",0,0,0\n      Property: "ScalingPivot", "Vector3D", "",0,0,0\n      Property: "TranslationActive", "bool", "",0\n      Property: "TranslationMin", "Vector3D", "",0,0,0\n      Property: "TranslationMax", "Vector3D", "",0,0,0\n      Property: "TranslationMinX", "bool", "",0\n      Property: "TranslationMinY", "bool", "",0\n      Property: "TranslationMinZ", "bool", "",0\n      Property: "TranslationMaxX", "bool", "",0\n      Property: "TranslationMaxY", "bool", "",0\n      Property: "TranslationMaxZ", "bool", "",0\n      Property: "RotationOrder", "enum", "",0\n      Property: "RotationSpaceForLimitOnly", "bool", "",0\n      Property: "AxisLen", "double", "",10\n      Property: "PreRotation", "Vector3D", "",0,0,0\n      Property: "PostRotation", "Vector3D", "",0,0,0\n      Property: "RotationActive", "bool", "",0\n      Property: "RotationMin", "Vector3D", "",0,0,0\n      Property: "RotationMax", "Vector3D", "",0,0,0\n      Property: "RotationMinX", "bool", "",0\n      Property: "RotationMinY", "bool", "",0\n      Property: "RotationMinZ", "bool", "",0\n      Property: "RotationMaxX", "bool", "",0\n      Property: "RotationMaxY", "bool", "",0\n      Property: "RotationMaxZ", "bool", "",0\n      Property: "RotationStiffnessX", "double", "",0\n      Property: "RotationStiffnessY", "double", "",0\n      Property: "RotationStiffnessZ", "double", "",0\n      Property: "MinDampRangeX", "double", "",0\n      Property: "MinDampRangeY", "double", "",0\n      Property: "MinDampRangeZ", "double", "",0\n      Property: "MaxDampRangeX", "double", "",0\n      Property: "MaxDampRangeY", "double", "",0\n      Property: "MaxDampRangeZ", "double", "",0\n      Property: "MinDampStrengthX", "double", "",0\n      Property: "MinDampStrengthY", "double", "",0\n      Property: "MinDampStrengthZ", "double", "",0\n      Property: "MaxDampStrengthX", "double", "",0\n      Property: "MaxDampStrengthY", "double", "",0\n      Property: "MaxDampStrengthZ", "double", "",0\n      Property: "PreferedAngleX", "double", "",0\n      Property: "PreferedAngleY", "double", "",0\n      Property: "PreferedAngleZ", "double", "",0\n      Property: "InheritType", "enum", "",0\n      Property: "ScalingActive", "bool", "",0\n      Property: "ScalingMin", "Vector3D", "",1,1,1\n      Property: "ScalingMax", "Vector3D", "",1,1,1\n      Property: "ScalingMinX", "bool", "",0\n      Property: "ScalingMinY", "bool", "",0\n      Property: "ScalingMinZ", "bool", "",0\n      Property: "ScalingMaxX", "bool", "",0\n      Property: "ScalingMaxY", "bool", "",0\n      Property: "ScalingMaxZ", "bool", "",0\n      Property: "GeometricTranslation", "Vector3D", "",0,0,0\n      Property: "GeometricRotation", "Vector3D", "",0,0,0\n      Property: "GeometricScaling", "Vector3D", "",1,1,1\n      Property: "LookAtProperty", "object", ""\n      Property: "UpVectorProperty", "object", ""\n      Property: "Show", "bool", "",1\n      Property: "NegativePercentShapeSupport", "bool", "",1\n      Property: "DefaultAttributeIndex", "int", "",0\n      Property: "Color", "Color", "A+",0,0,0\n      Property: "Size", "double", "",100\n      Property: "Look", "enum", "",1\n    }',"\n    ").concat(this._verticesIndices(r.positions,r.indices),"\n    ").concat(this._normalLayer(r.normals)," \n    ").concat(this._colorLayer(r.colors,i)," \n    ").concat('\n    LayerElementMaterial: 0 {\n      Version: 101\n      Name: ""\n      MappingInformationType: "AllSame"\n      ReferenceInformationType: "Direct"\n      Materials: 0\n    }',"  \n    ").concat('\n    Layer: 0 {\n      Version: 100\n      LayerElement:  {\n        Type: "LayerElementNormal"\n        TypedIndex: 0\n      }\n      LayerElement:  {\n        Type: "LayerElementColor"\n        TypedIndex: 0\n      }\n      LayerElement:  {\n        Type: "LayerElementMaterial"\n        TypedIndex: 0\n      }\n    }',"\n  }")}return e}},{key:"_materials",value:function(){for(var e="",t=this._info.materials,n=0;n<t.length;++n){var r=t[n];e+='\n  Material: "Material::'.concat(this._info.name,"_").concat(n,'_default", "" {\n    Version: ').concat(102,'\n    ShadingModel: "lambert"\n    MultiLayer: 0\n    ').concat(this._materialProperties(r),"\n  }")}return e}},{key:"_writeObjects",value:function(){return"\n; Object properties\n;------------------------------------------------------------------\n\nObjects:  {\n  ".concat(this._models(),"\n  ").concat(this._materials(),"\n  ").concat('GlobalSettings: {\n    Version: 1000\n    Properties60:  {\n      Property: "UpAxis", "int", "",1\n      Property: "UpAxisSign", "int", "",1\n      Property: "FrontAxis", "int", "",2\n      Property: "FrontAxisSign", "int", "",1\n      Property: "CoordAxis", "int", "",0\n      Property: "CoordAxisSign", "int", "",1\n      Property: "UnitScaleFactor", "double", "",1\n    }\n  }',"\n}\n")}},{key:"_writeRelations",value:function(){for(var e="",t=0;t<this._info.models.length;++t)e+='\n  Model: "Model::'.concat(this._info.name,"_").concat(t,'", "Mesh" {\n  }');for(var n="",r=0;r<this._info.materials.length;++r)n+='\n  Material: "Material::'.concat(this._info.name,"_").concat(r,'_default", "" {\n  }');return"\n; Object relations\n;------------------------------------------------------------------\n\nRelations:  {\n  ".concat(e,'\n  Model: "Model::Producer Perspective", "Camera" {\n  }\n  Model: "Model::Producer Top", "Camera" {\n  }\n  Model: "Model::Producer Bottom", "Camera" {\n  }\n  Model: "Model::Producer Front", "Camera" {\n  }\n  Model: "Model::Producer Back", "Camera" {\n  }\n  Model: "Model::Producer Right", "Camera" {\n  }\n  Model: "Model::Producer Left", "Camera" {\n  }\n  Model: "Model::Camera Switcher", "CameraSwitcher" {\n  }\n  ').concat(n,"\n}")}},{key:"_writeConnections",value:function(){for(var e="",t=this._info.name,n=0;n<this._info.models.length;++n)e+='\n  Connect: "OO", "Model::'.concat(t,"_").concat(n,'", "Model::Scene"');for(var r="",i=0;i<this._info.materials.length;++i)r+='\n  Connect: "OO", "Material::'.concat(t,"_").concat(i,'_default", "Model::').concat(t,"_").concat(i,'"');return"\n; Object connections\n;------------------------------------------------------------------\n\nConnections:  {\n  ".concat(e,"\n  ").concat(r,"\n}")}},{key:"_floatArrayToString",value:function(e){for(var t=[],n=0;n<e.length;++n)t[n]=e[n].toFixed(6);return t.join(",")}},{key:"_colorLayer",value:function(e,t){e=this._floatArrayToString(e),t=Yn(Array(t).keys());return"\n    LayerElementColor: ".concat(0," {\n      Version: ").concat(101,'\n      Name: "').concat("",'"\n      MappingInformationType: "ByVertice"\n      ReferenceInformationType: "Direct"\n      Colors: ').concat(e,"\n      ColorIndex: ").concat(t,"\n    }")}},{key:"_normalLayer",value:function(e){e=this._floatArrayToString(e);return"\n    LayerElementNormal: ".concat(0," {\n      Version: ").concat(101,'\n      Name: "').concat("",'"\n      MappingInformationType: "ByVertice"\n      ReferenceInformationType: "Direct" \n      Normals: ').concat(e,"\n    }")}},{key:"_verticesIndices",value:function(e,t){e=this._floatArrayToString(e);return"MultiLayer: ".concat(0,"\n    MultiTake: ").concat(1,"\n    Shading: ").concat("Y",'\n    Culling: "').concat("CullingOff",'"\n    Vertices: ').concat(e,"\n    PolygonVertexIndex: ").concat(t,"\n    GeometryVersion: ").concat(124)}},{key:"_materialProperties",value:function(e){return'Properties60:  {\n      Property: "ShadingModel", "KString", "", "Lambert"\n      Property: "MultiLayer", "bool", "",0\n      Property: "EmissiveColor", "ColorRGB", "",0,0,0\n      Property: "EmissiveFactor", "double", "",0.0000\n      Property: "AmbientColor", "ColorRGB", "",1,1,1\n      Property: "AmbientFactor", "double", "",0.0000\n      Property: "DiffuseColor", "ColorRGB", "",'.concat(e.diffuse,'\n      Property: "DiffuseFactor", "double", "",1.0000\n      Property: "Bump", "Vector3D", "",0,0,0\n      Property: "TransparentColor", "ColorRGB", "",1,1,1\n      Property: "TransparencyFactor", "double", "",0.0000\n      Property: "SpecularColor", "ColorRGB", "",').concat(e.specular,'\n      Property: "SpecularFactor", "double", "",1.0000\n      Property: "ShininessExponent", "double", "",').concat(e.shininess,'\n      Property: "ReflectionColor", "ColorRGB", "",0,0,0\n      Property: "ReflectionFactor", "double", "",1\n      Property: "Ambient", "ColorRGB", "",1,1,1\n      Property: "Diffuse", "ColorRGB", "",').concat(e.diffuse,'\n      Property: "Specular", "ColorRGB", "",').concat(e.specular,'\n      Property: "Shininess", "double", "",').concat(e.shininess,'\n      Property: "Opacity", "double", "",').concat(e.opacity,'\n      Property: "Reflectivity", "double", "",0\n    }')}}]),e}();function $u(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}Do=function(){A(i,Iu);var r=$u(i);function i(e,t){var n;return j(this,i),(n=r.call(this,e,t))._data=e,n._version=t.miewVersion||"0.0-UNSPECIFIED",n._extractor=new Xu,n}return _(i,[{key:"exportSync",value:function(){var e=new qu;if(!this._source)return this._result;var t=this._extractor.process(this._data);return t.version=this._version,this._result=e.getResult(t),this._result}}]),i}();Do.formats=["fbx"],Do.SourceClass=fc;var Zu,Ku,Qu,Ju,eh,th,nh,rh,ih,oh,sh,ah,ch,lh,uh,hh,fh,dh,ph,mh={loaders:ur,parsers:co,exporters:new ho([go,Do])},yh=new ae.Color,_h=function(){function e(){j(this,e),this._width=0,this._height=0,this._widthHalf=0,this._heightHalf=0,this._vector=new ae.Vector3,this._viewMatrix=new ae.Matrix4,this._projectionMatrix=new ae.Matrix4,this._domElement=document.createElement("div"),this._domElement.style.overflow="hidden",this._domElement.style.position="absolute",this._domElement.style.top="0",this._domElement.style.zIndex="0",this._domElement.style.pointerEvents="none"}return _(e,[{key:"getElement",value:function(){return this._domElement}},{key:"reset",value:function(){for(var e=this.getElement();e.firstChild;)e.removeChild(e.firstChild)}},{key:"setSize",value:function(e,t){this._width=e,this._height=t,this._widthHalf=this._width/2,this._heightHalf=this._height/2,this._domElement.style.width="".concat(e,"px"),this._domElement.style.height="".concat(t,"px")}},{key:"_renderObject",value:function(e,t,n){function r(e,t,n){return yh.setHex(e),yh.lerp(t,n),"#".concat(yh.getHexString())}function i(e){return yh.setHex(e),"#".concat(yh.getHexString())}var o,s,a,c;e instanceof Rn&&(this._vector.setFromMatrixPosition(e.matrixWorld),void 0!==e.userData&&void 0!==e.userData.offset&&(a=new ae.Vector3(e.userData.offset.x,e.userData.offset.y,0),this._vector.add(a.multiplyScalar(e.matrixWorld.getMaxScaleOnAxis()))),this._vector.applyMatrix4(this._viewMatrix),o=this._vector.z>-t.near?"hidden":"visible",s=1e4*(t.far- -this._vector.z)/(t.far-t.near),a=e.getElement(),void 0===n.fog?(a.style.color=i(e.userData.color),"transparent"!==e.userData.background&&(a.style.background=i(e.userData.background))):(c=ae.MathUtils.smoothstep(-this._vector.z,n.fog.near,n.fog.far),a.style.color=r(e.userData.color,n.fog.color,c),"transparent"!==e.userData.background&&(a.style.background=r(e.userData.background,n.fog.color,c))),this._vector.applyMatrix4(this._projectionMatrix),c="".concat(e.userData!=={}?e.userData.translation:"translate(-50%, -50%) ","translate(").concat(this._vector.x*this._widthHalf+this._widthHalf,"px,").concat(-this._vector.y*this._heightHalf+this._heightHalf,"px)"),a.style.visibility=o,a.style.WebkitTransform=c,a.style.MozTransform=c,a.style.oTransform=c,a.style.transform=c,a.style.zIndex=Number(s).toFixed(0),a.parentNode!==this._domElement&&this._domElement.appendChild(a));for(var l=0,u=e.children.length;l<u;l++)this._renderObject(e.children[l],t,n)}},{key:"render",value:function(e,t){e.updateMatrixWorld(),null===t.parent&&t.updateMatrixWorld(),t.matrixWorldInverse.copy(t.matrixWorld).invert(),this._viewMatrix.copy(t.matrixWorldInverse),this._projectionMatrix.copy(t.projectionMatrix),this._renderObject(e,t,e)}}]),e}(),vh=-1,gh=0,xh=1,bh=2,wh=3,Sh=new ae.Quaternion,Rh=new ae.Matrix4;function Ch(e,t,n,r){this.objects=e;e=m(e,1);this.object=e[0],this.camera=t,this.pivot=n,this.axis=new ae.Vector3(0,0,1),this.options=r,this.lastRotation={axis:new ae.Vector3,angle:0}}function Ah(e,t,n,r,i){O.call(this);var o=this;this.object=e,this.objectPivot=t,this.camera=n,this.domElement=void 0!==r?r:document,this.getAltObj=i,this.enabled=!0,this.hotkeysEnabled=!0,this.screen={left:0,top:0,width:0,height:0},this.options={rotateFactor:Math.PI,axisRotateFactor:4*Math.PI,intertia:!0,dynamicDampingFactor:.1,intertiaThreshold:.001},this._state=vh,this._mousePrevPos=new ae.Vector2,this._mouseCurPos=new ae.Vector2,this._mainObj=new Ch([this.object],this.camera,new ae.Vector3(0,0,0),this.options),this._altObj=new Ch([this.object],this.camera,new ae.Vector3(0,0,0),this.options),this._affectedObj=this._mainObj,this._isAltObjFreeRotationAllowed=!0,this._isTranslationAllowed=!0,this._isKeysTranslatingObj=!1,this._pressedKeys=[],this._clock=new v,this._clock.start(),this._lastUpdateTime=this._clock.getElapsedTime(),this._listeners=[{obj:o.domElement,type:"mousedown",handler:function(e){o.mousedown(e)}},{obj:o.domElement,type:"mouseup",handler:function(e){o.mouseup(e)}},{obj:o.domElement,type:"mousemove",handler:function(e){o.mousemove(e)}},{obj:o.domElement,type:"mousewheel",handler:function(e){o.mousewheel(e)}},{obj:o.domElement,type:"DOMMouseScroll",handler:function(e){o.mousewheel(e)}},{obj:o.domElement,type:"mouseout",handler:function(e){o.mouseup(e)}},{obj:o.domElement,type:"touchstart",handler:function(e){o.touchstartend(e)}},{obj:o.domElement,type:"touchend",handler:function(e){o.touchstartend(e)}},{obj:o.domElement,type:"touchmove",handler:function(e){o.touchmove(e)}},{obj:o.getKeyBindObject(),type:"keydown",handler:function(e){o.keydownup(e)}},{obj:o.getKeyBindObject(),type:"keyup",handler:function(e){o.keydownup(e)}},{obj:window,type:"resize",handler:function(){o.handleResize()}},{obj:window,type:"blur",handler:function(){o.resetKeys()}},{obj:o.domElement,type:"contextmenu",handler:function(e){o.contextmenu(e)}}];for(var s=0;s<this._listeners.length;s++){var a=this._listeners[s];a.obj.addEventListener(a.type,a.handler)}this.handleResize(),this.resetKeys(),this.update()}function Eh(e,t,n){O.call(this);var r=this;this.gfxObj=e,this.camera=t,this.domElement=void 0!==n?n:document,this.screen={left:0,top:0,width:0,height:0},this._lastMousePos=new ae.Vector2(0,0),this._mouseTotalDist=0,this._lastClickBeginTime=-1e3,this._lastClickPos=new ae.Vector2(0,0),this._clickBeginTime=0,this._clock=new v,this._clock.start(),this._listeners=[{obj:r.domElement,type:"mousedown",handler:function(e){r.mousedown(e)}},{obj:r.domElement,type:"mouseup",handler:function(e){r.mouseup(e)}},{obj:r.domElement,type:"mousemove",handler:function(e){r.mousemove(e)}},{obj:r.domElement,type:"touchstart",handler:function(e){r.touchstart(e)}},{obj:r.domElement,type:"touchend",handler:function(e){r.touchend(e)}},{obj:window,type:"resize",handler:function(){r.handleResize()}}];for(var i=0;i<this._listeners.length;i++){var o=this._listeners[i];o.obj.addEventListener(o.type,o.handler)}this.handleResize()}Ch.prototype._rotate=(Zu=new ae.Vector3,Ku=new ae.Quaternion,Qu=new ae.Vector3,Ju=new ae.Matrix4,function(e){var t=0===this.pivot.x&&0===this.pivot.y&&0===this.pivot.z;if(Ju.copy(this.object.matrix),t?Ju.multiply(Rh.makeRotationFromQuaternion(e)):(Ju.multiply(Rh.makeTranslation(this.pivot.x,this.pivot.y,this.pivot.z)),Ju.multiply(Rh.makeRotationFromQuaternion(e)),Ju.multiply(Rh.makeTranslation(-this.pivot.x,-this.pivot.y,-this.pivot.z))),Ju.decompose(Zu,Ku,Qu),!t)for(var n=0;n<this.objects.length;++n)this.objects[n].position.copy(Zu);for(var r=0;r<this.objects.length;++r)this.objects[r].quaternion.copy(Ku),this.objects[r].updateMatrix()}),Ch.prototype.setObjects=function(e){this.objects=e;e=m(e,1);this.object=e[0]},Ch.prototype.rotate=(eh={axis:new ae.Vector3,angle:0},function(e,t,n,r){this.mouse2rotation(eh,t,n,r),e.setFromAxisAngle(eh.axis,eh.angle),eh.angle&&this._rotate(e),this.lastRotation=eh}),Ch.prototype.translate=(th=new ae.Vector3,nh=new ae.Vector3,function(e){th.set(e.x/this.camera.projectionMatrix.elements[0],e.y/this.camera.projectionMatrix.elements[5],0);var t=th.length();th.normalize(),th.transformDirection(Rh.copy(this.object.matrixWorld).invert()),nh.copy(this.pivot),this.object.localToWorld(nh),t*=Math.abs(nh.z-this.camera.position.z),t/=this.object.matrixWorld.getMaxScaleOnAxis();for(var n=0;n<this.objects.length;++n)this.objects[n].translateOnAxis(th,t)}),Ch.prototype.update=(rh=new ae.Vector3,function(e,t){if(0!==oe.now.autoRotation)return oe.now.autoRotationAxisFixed||0===this.lastRotation.axis.length()?rh.set(0,1,0).transformDirection(Rh.copy(this.object.matrixWorld).invert()):rh.copy(this.lastRotation.axis),this._rotate(Sh.setFromAxisAngle(rh,oe.now.autoRotation*e)),!0;if(this.options.intertia&&this.lastRotation.angle){t=this.lastRotation.angle*Math.pow(1-this.options.dynamicDampingFactor,40*t);if(!(Math.abs(t)<=this.options.intertiaThreshold))return this._rotate(Sh.setFromAxisAngle(this.lastRotation.axis,t)),!0;this.lastRotation.angle=0}return!1}),Ch.prototype.stop=function(){this.lastRotation.angle=0},Ch.prototype.mouse2rotation=(ih=new ae.Vector3,oh=new ae.Vector3,sh=new ae.Vector3,ah=new ae.Vector3,ch=new ae.Vector3,lh=new ae.Vector3,uh=new ae.Vector2,function(e,t,n,r){if(r)e.axis.copy(this.axis),e.angle=this.options.axisRotateFactor*(n.y-t.y);else{uh.subVectors(n,t);t=uh.length();if(0===t)return;ih.copy(this.pivot),this.object.localToWorld(ih),oh.subVectors(this.camera.position,ih),sh.copy(oh).normalize(),ah.copy(this.camera.up).normalize(),ch.crossVectors(ah,sh).normalize(),ah.setLength(uh.y),ch.setLength(uh.x),lh.copy(ah.add(ch)),e.axis.crossVectors(lh,oh),e.angle=-t*this.options.rotateFactor}e.axis.transformDirection(Rh.copy(this.object.matrixWorld).invert()),e.angle<0&&(e.axis.negate(),e.angle=-e.angle)}),((Ah.prototype=Object.create(O.prototype)).constructor=Ah).prototype.resetKeys=function(){this._pressedKeys[37]=!1,this._pressedKeys[38]=!1,this._pressedKeys[39]=!1,this._pressedKeys[40]=!1},Ah.prototype.contextmenu=function(e){e.stopPropagation(),e.preventDefault()},Ah.prototype.handleResize=function(){var e,t;this.domElement===document?(this.screen.left=0,this.screen.top=0,this.screen.width=window.innerWidth,this.screen.height=window.innerHeight):(e=this.domElement.getBoundingClientRect(),t=this.domElement.ownerDocument.documentElement,this.screen.left=e.left+window.pageXOffset-t.clientLeft,this.screen.top=e.top+window.pageYOffset-t.clientTop,this.screen.width=e.width,this.screen.height=e.height)},Ah.prototype.enable=function(e){this.enabled=e},Ah.prototype.enableHotkeys=function(e){this.hotkeysEnabled=e},Ah.prototype.allowTranslation=function(e){this._isTranslationAllowed=e},Ah.prototype.allowAltObjFreeRotation=function(e){this._isAltObjFreeRotationAllowed=e},Ah.prototype.keysTranslateObj=function(e){this._isKeysTranslatingObj=e},Ah.prototype.isEditingAltObj=function(){return(this._state===gh||this._state===xh)&&this._affectedObj===this._altObj},Ah.prototype.convertMouseToOnCircle=function(e,t,n){var r=Math.min(this.screen.width,this.screen.height);0!==r?e.set((t-.5*this.screen.width-this.screen.left)/r,(.5*this.screen.height+this.screen.top-n)/r):e.set(0,0)},Ah.prototype.convertMouseToViewport=function(e,t,n){0!==this.screen.width&&0!==this.screen.height?e.set(2*(t-.5*this.screen.width-this.screen.left)/this.screen.width,2*(.5*this.screen.height+this.screen.top-n)/this.screen.height):e.set(0,0)},Ah.prototype.stop=function(){this._mainObj.stop(),this._altObj.stop()},Ah.prototype.rotateByMouse=(hh=new ae.Quaternion,function(e){this._affectedObj.rotate(hh,this._mousePrevPos,this._mouseCurPos,e),this.dispatchEvent({type:"change",action:"rotate",quaternion:hh})}),Ah.prototype.rotate=function(e){this.object.quaternion.multiply(e),this.dispatchEvent({type:"change",action:"rotate",quaternion:e})},Ah.prototype.getOrientation=function(){return this.object.quaternion},Ah.prototype.setOrientation=function(e){this.object.quaternion.copy(e)},Ah.prototype.translate=(fh=new ae.Vector2,function(){fh.subVectors(this._mouseCurPos,this._mousePrevPos),this._affectedObj.translate(fh),this.dispatchEvent({type:"change",action:"translate"})}),Ah.prototype.getScale=function(){return this.object.scale.x},Ah.prototype.setScale=function(e){this.object.scale.set(e,e,e)},Ah.prototype.scale=function(e){e<=0||(this.setScale(this.object.scale.x*e),this.dispatchEvent({type:"change",action:"zoom",factor:e}))},Ah.prototype.update=(dh=new ae.Vector2,function(){var e,t,n,r=this._clock.getElapsedTime(),i=r-this._lastUpdateTime;this._state===vh&&(n=r-this._lastMouseMoveTime,(this._mainObj.update(i,n)||this._altObj.update(i,n))&&this.dispatchEvent({type:"change",action:"auto"})),this._isKeysTranslatingObj&&(e=Number(this._pressedKeys[39])-Number(this._pressedKeys[37]),t=Number(this._pressedKeys[38])-Number(this._pressedKeys[40]),0==e&&0==t||(n=i,0<(i=this.getAltObj()).objects.length&&(this._altObj.setObjects(i.objects),this._altObj.pivot=i.pivot,"axis"in i?this._altObj.axis=i.axis.clone():this._altObj.axis.set(0,0,1),dh.set(n*e,n*t),this._altObj.translate(dh),this.dispatchEvent({type:"change",action:"translate"})))),this._lastUpdateTime=r}),Ah.prototype.reset=function(){this._state=vh,this.object.quaternion.copy(Sh.set(0,0,0,1))},Ah.prototype.mousedown=function(e){var t,n;!1!==this.enabled&&this._state===vh&&(e.preventDefault(),e.stopPropagation(),this._state===vh&&(0===e.button?(this._affectedObj.stop(),n=!1,!e.altKey||(n=0<(t=this.getAltObj()).objects.length)&&(this._altObj.setObjects(t.objects),this._altObj.pivot=t.pivot,"axis"in t?this._altObj.axis=t.axis.clone():this._altObj.axis.set(0,0,1)),this._affectedObj=n?this._altObj:this._mainObj,this._state=n&&e.ctrlKey&&this._isTranslationAllowed?xh:gh):2===e.button&&(this._state=wh)),this._state===gh&&(this.convertMouseToOnCircle(this._mouseCurPos,e.pageX,e.pageY),this._mousePrevPos.copy(this._mouseCurPos)),this._state!==xh&&this._state!==wh||(this.convertMouseToViewport(this._mouseCurPos,e.pageX,e.pageY),this._mousePrevPos.copy(this._mouseCurPos)))},Ah.prototype.mousemove=function(e){if(!1!==this.enabled&&this._state!==vh)switch(e.preventDefault(),e.stopPropagation(),this._state){case gh:this._mousePrevPos.copy(this._mouseCurPos),this.convertMouseToOnCircle(this._mouseCurPos,e.pageX,e.pageY),this.rotateByMouse(e.altKey&&!this._isAltObjFreeRotationAllowed||e.shiftKey),this._lastMouseMoveTime=this._clock.getElapsedTime();break;case xh:this._mousePrevPos.copy(this._mouseCurPos),this.convertMouseToViewport(this._mouseCurPos,e.pageX,e.pageY),this.translate();break;case wh:this._mousePrevPos.copy(this._mouseCurPos),this.convertMouseToViewport(this._mouseCurPos,e.pageX,e.pageY),this.translatePivotByMouse()}},Ah.prototype.mousewheel=function(e){var t;!1!==this.enabled&&oe.now.zooming&&this._state===vh&&!e.shiftKey&&(e.preventDefault(),t=0,e.wheelDelta?t=e.wheelDelta/40:e.detail&&(t=-e.detail/3),t=1+.05*t,t=Math.max(t,.01),this.scale(t))},Ah.prototype.mouseup=function(e){!1!==this.enabled&&this._state!==vh&&(e.preventDefault(),e.stopPropagation(),this._state=vh,.1<this._clock.getElapsedTime()-this._lastMouseMoveTime&&this._affectedObj.stop())},Ah.prototype.touchstartend=function(e){if(!1!==this.enabled)switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:this._state=gh,this.convertMouseToOnCircle(this._mouseCurPos,e.touches[0].pageX,e.touches[0].pageY),this._mousePrevPos.copy(this._mouseCurPos);break;case 2:this._mainObj.stop(),this._altObj.stop(),this._state=bh;var t=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY;this._touchDistanceCur=this._touchDistanceStart=Math.sqrt(t*t+n*n),this._scaleStart=this.object.scale.x;break;default:this._state=vh}},Ah.prototype.touchmove=function(e){if(!1!==this.enabled&&this._state!==vh)switch(e.preventDefault(),e.stopPropagation(),this._state){case gh:this._mousePrevPos.copy(this._mouseCurPos),this.convertMouseToOnCircle(this._mouseCurPos,e.touches[0].pageX,e.touches[0].pageY),this.rotateByMouse(!1),this._lastMouseMoveTime=this._clock.getElapsedTime();break;case bh:var t,n;oe.now.zooming&&(t=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY,this._touchDistanceCur=Math.sqrt(t*t+n*n),n=this._scaleStart*this._touchDistanceCur/this._touchDistanceStart/this.object.scale.x,this.scale(n))}},Ah.prototype.keydownup=function(e){if(!1!==this.enabled&&!1!==this.hotkeysEnabled)switch(e.keyCode){case 37:case 38:case 39:case 40:this._pressedKeys[e.keyCode]="keydown"===e.type,e.preventDefault(),e.stopPropagation()}},Ah.prototype.getKeyBindObject=function(){return window.top},Ah.prototype.dispose=function(){for(var e=0;e<this._listeners.length;e++){var t=this._listeners[e];t.obj.removeEventListener(t.type,t.handler)}},Ah.prototype.translatePivotByMouse=(ph=new ae.Vector2,function(){ph.subVectors(this._mouseCurPos,this._mousePrevPos),this.translatePivotInWorld(oe.now.translationSpeed*ph.x,oe.now.translationSpeed*ph.y,0)}),Ah.prototype.translatePivotInWorld=function(e,t,n){var r=this.objectPivot.position;r.applyMatrix4(this.object.matrixWorld),r.setX(r.x+e),r.setY(r.y+t),r.setZ(r.z+n),r.applyMatrix4(Rh.copy(this.object.matrixWorld).invert()),this.dispatchEvent({type:"change",action:"translatePivot"})},Ah.prototype.translatePivot=function(e,t,n){var r=this.objectPivot.position;r.setX(r.x+e),r.setY(r.y+t),r.setZ(r.z+n),this.dispatchEvent({type:"change",action:"translatePivot"})},Ah.prototype.setPivot=function(e){this.objectPivot.position.copy(e),this.dispatchEvent({type:"change",action:"translatePivot"})},((Eh.prototype=Object.create(O.prototype)).constructor=Eh).prototype.reset=function(){this.picked={},this.dispatchEvent({type:"newpick",obj:{}})},Eh.prototype.handleResize=function(){var e,t;this.domElement===document?(this.screen.left=0,this.screen.top=0,this.screen.width=window.innerWidth,this.screen.height=window.innerHeight):(e=this.domElement.getBoundingClientRect(),t=this.domElement.ownerDocument.documentElement,this.screen.left=e.left+window.pageXOffset-t.clientLeft,this.screen.top=e.top+window.pageYOffset-t.clientTop,this.screen.width=e.width,this.screen.height=e.height)},Eh.prototype.pickObject=function(e){if(!this.gfxObj)return this.picked={},void this.dispatchEvent({type:"newpick",obj:{}});var t=this.gfxObj,n=new ae.Raycaster;n.ray.origin.setFromMatrixPosition(this.camera.matrixWorld),n.ray.direction.set(e.x,e.y,.5).unproject(this.camera).sub(n.ray.origin).normalize();var r=oe.now.draft.clipPlane&&this.clipPlaneValue?this.clipPlaneValue:1/0,e=oe.now.fog&&this.fogFarValue?this.fogFarValue:1/0,t=n.intersectVisibleObject(t,this.camera,r,e);if(!t)return this.picked={},void this.dispatchEvent({type:"newpick",obj:{}});r={};(t.residue||t.atom)&&(e=t.residue||t.atom.residue,"chain"===oe.now.pick?r={chain:e.getChain()}:"molecule"===oe.now.pick?r={molecule:e.getMolecule()}:t.residue||"residue"===oe.now.pick?r={residue:e}:t.atom&&(r={atom:t.atom})),this.picked=r,this.dispatchEvent({type:"newpick",obj:r})},Eh.prototype.getMouseInViewport=function(e,t){return new ae.Vector2((e-this.screen.left)/this.screen.width*2-1,-(t-this.screen.top)/this.screen.height*2+1)},Eh.prototype.mousedown=function(e){e.preventDefault(),e.stopPropagation(),0===e.button&&(this._lastMousePos=this.getMouseInViewport(e.pageX,e.pageY),this._mouseTotalDist=0,this._clickBeginTime=this._clock.getElapsedTime())},Eh.prototype.mousemove=function(e){e.preventDefault(),e.stopPropagation();e=this.getMouseInViewport(e.pageX,e.pageY);this._mouseTotalDist+=e.sub(this._lastMousePos).length()},Eh.prototype.mouseup=function(e){var t=this;if(e.preventDefault(),e.stopPropagation(),0===e.button&&this._mouseTotalDist<.01){var n=this._clock.getElapsedTime(),r=this.getMouseInViewport(e.pageX,e.pageY),n=n-this._lastClickBeginTime;if(n<.7)if((new ae.Vector2).subVectors(r,this._lastClickPos).length()<.01)return this.dispatchEvent({type:"dblclick",obj:this.picked}),this._lastClickPos=r,void(this._lastClickBeginTime=-1e3);setTimeout(function(){t.pickObject(r)},0),this._lastClickPos=r,this._lastClickBeginTime=this._clickBeginTime}},Eh.prototype.touchstart=function(e){e.preventDefault(),e.stopPropagation(),1===e.touches.length&&(this._lastTouchdownPos=this.getMouseInViewport(e.touches[0].pageX,e.touches[0].pageY))},Eh.prototype.touchend=function(e){var t=this;e.preventDefault(),e.stopPropagation(),0===e.touches.length&&1===e.changedTouches.length&&this.getMouseInViewport(e.changedTouches[0].pageX,e.changedTouches[0].pageY).sub(this._lastTouchdownPos).length()<.01&&setTimeout(function(){t.pickObject(t._lastTouchdownPos)},0)},Eh.prototype.dispose=function(){for(var e=0;e<this._listeners.length;e++){var t=this._listeners[e];t.obj.removeEventListener(t.type,t.handler)}};var kh=function(){function n(e,t){j(this,n),this._target=e,this._targetCamera=t,this._camera=new ae.PerspectiveCamera(t.fov,t.aspect,1,100),this._object=new ae.AxesHelper(1),this._scene=new ae.Scene,this._scene.add(this._object),this._full=new ae.Vector2,this._update()}return _(n,[{key:"_update",value:function(){var e=this._targetCamera.fov,t=this._camera;t.aspect=this._targetCamera.aspect,t.setMinimalFov(e),t.setDistanceToFit(1,e),t.updateProjectionMatrix(),this._object.quaternion.copy(this._target.quaternion)}},{key:"render",value:function(e){this._update(),e.getSize(this._full);var t=.25*this._full.width,n=.25*this._full.height,r=e.autoClear;e.autoClear=!1,e.setViewport(0,0,t,n),e.clear(!1,!0,!1),e.render(this._scene,this._camera),e.setViewport(0,0,this._full.width,this._full.height),e.autoClear=r}}]),n}(),Th=1<<19,Ph=1<<20,Mh=["helix","strand"],Nh=["fs","ps","ns","us"];function Ih(e){return Th<=e?e-Ph:e}var Lh=function(){function r(e,t,n){j(this,r),this._complex=e,this._secondary=null,this.isLoading=!1,this._framesRange={start:0,end:-1},this.frameIsReady=!1,this._buffer=null,this._frameRequest=null,this._callbacks=n,"function"==typeof t?(this._framesRequestLength=1,this._downloadDataFn=t):this.parseBinaryData(t,!0),this.reset(),this.setFrame(0)}return _(r,[{key:"_prepareBuffer",value:function(t,n){var r;null==t&&(t=0),null==n&&(n=t+this._framesRequestLength),void 0!==this._framesCount&&(n=Math.min(this._framesCount-1,n)),this._downloadDataFn&&((r=this)._buffer||(this._buffer={}),this._buffer.state="downloading",this.isLoading=!0,r._callbacks&&"function"==typeof r._callbacks.onLoadStatusChanged&&r._callbacks.onLoadStatusChanged(),this._downloadDataFn({start:t,end:n+1},function(e){r.isLoading=!1,r._callbacks&&"function"==typeof r._callbacks.onLoadStatusChanged&&r._callbacks.onLoadStatusChanged(),r._buffer={data:e,state:"ready",start:t,end:n},null!==r._frameRequest&&(e=r._frameRequest,r._frameRequest=null,r.setFrame(e))},function(){r.isLoading=!1,r._callbacks&&"function"==typeof r._callbacks.onError&&r._callbacks.onError("Streaming failed")}))}},{key:"_parseBuffer",value:function(){var e;this._buffer&&"ready"===this._buffer.state&&(this._framesRange={start:this._buffer.start,end:this._buffer.end},this.parseBinaryData(this._buffer.data,!1),(e=(this._buffer.end+1)%this._framesCount)>=this._framesCount&&(e=0),this._buffer={state:"none"},this._prepareBuffer(e,e+this._framesRequestLength),null!==this._frameRequest&&(e=this._frameRequest,this._frameRequest=null,this.setFrame(e)))}},{key:"parseBinaryData",value:function(e){var t=new DataView(e),n=0,r=t.getUint32(n,!0);n+=4;var i=t.getUint32(n,!0);this._framesCount=i,this._framesRange.end=0<this._framesRange.end?Math.min(this._framesRange.end,i-1):i-1,n+=4,this._atomsCount=r;this._framesRequestLength=Math.ceil(1048576/(8*r));var o=this._framesRange.end-this._framesRange.start+1;if(r!==this._complex._atoms.length||e.byteLength!==12+o*r*8)throw new Error;for(var s=this._complex,a=t.getUint32(n,!0),c=0;1e3<a&&c<Nh.length-1;)a/=1e3,++c;this._timeStep="".concat(a.toString()," ").concat(Nh[c]),n+=4;for(var l=[],u=new Float32Array(o*r*3),h=0,f=new Int8Array(r),d=0;d<o;++d){for(var p=0;p<r;++p){var m=t.getUint32(n,!0);n+=4;var y=t.getUint32(n,!0);n+=4;var _=(4026531840&y)>>>28,v=Ih((268435200&y)>>>8>>0),y=Ih(((255&y)<<12|(4293918720&m)>>>20)>>0),m=Ih((1048575&m)>>0);(f[p]=0)<_&&_<4?f[p]=1:4==_&&(f[p]=2),u[h++]=v/100,u[h++]=y/100,u[h++]=m/100}l.push(function(e,t){for(var n=t._residues,r=n.length,i=new Uint8Array(r),o=t._atoms,s=0,a=e.length;s<a;++s)i[o[s].residue._index]=e[s];for(var c=[],l=0;l<r;){if(0!==i[l]){for(var u=l,h=i[l];l<r-1&&i[l+1]===h&&n[l].isConnected(n[l+1]);)++l;c.push({start:u,end:l,type:Mh[h-1]})}++l}return c}(f,s))}this._secondaryData=l,this._data=u}},{key:"nextFrame",value:function(){this.setFrame((this._currFrame+1)%this._framesCount)}},{key:"needsColorUpdate",value:function(e){return e instanceof Da}},{key:"getAtomColor",value:function(e,t){return e.getResidueColor(this._residues[t.residue._index],this._complex)}},{key:"getResidueColor",value:function(e,t){return e.getResidueColor(this._residues[t._index],this._complex)}},{key:"_updateSecondary",value:function(){for(var e=this._residues,t=e.length,n=0;n<t;++n)e[n]._secondary=null;var r=this._secondaryData[this._currFrame-this._framesRange.start];for(n=0,t=r.length;n<t;++n)for(var i=r[n],o=i.start,s=i.end,a={_start:e[o],_end:e[s],type:i.type,generic:i.generic},c=o;c<=s;++c)e[c]._secondary=a}},{key:"reset",value:function(){var e=this._complex._residues,t=e.length;this._residues=new Array(t);for(var n=this._residues,r=function(){return this._secondary},i=0;i<t;++i)n[i]={_type:e[i]._type,_isValid:e[i]._isValid,_controlPoint:null,_wingVector:null,_secondary:null,getSecondary:r}}},{key:"setFrame",value:function(e){if(this.frameIsReady=!1,e>=this._framesRange.start&&e<=this._framesRange.end)this._currFrame=e,this._cachedResidues=!1,this._updateSecondary(),this.frameIsReady=!0;else if(this._frameRequest=e,this._buffer)switch(this._buffer.state){case"none":this._prepareBuffer(e);break;case"ready":this._parseBuffer()}else this._prepareBuffer(e)}},{key:"disableEvents",value:function(){this._callbacks=null}},{key:"getAtomPos",value:function(e){var t=r._vec,n=this._data,e=3*(this._atomsCount*(this._currFrame-this._framesRange.start)+e);return t.set(n[e],n[1+e],n[2+e]),t}},{key:"getResidues",value:function(){return this._cachedResidues||this._complex.updateToFrame(this),this._residues}}]),r}();ke(Lh,"_vec",new ae.Vector3);var Dh=function(){function n(e,t){if(j(this,n),this.constructor===n)throw new Error("Can not instantiate abstract class!");this.params=e,this.opts=b.default.merge(ce.deriveDeep(oe.now.objects[this.type],!0),t),this.needsRebuild=!1,this._mesh=null,this.id=null}return _(n,[{key:"identify",value:function(){var e={type:this.type,params:this.params},t=ce.objectsDiff(this.opts,oe.now.modes[this.id]);return b.default.isEmpty(t)||(e.opts=t),e}},{key:"toString",value:function(){return"o=".concat(this.type,",").concat(this.params.join(","))+ce.compareOptionsWithDefaults(this.opts,oe.defaults.objects[this.type])}},{key:"getGeometry",value:function(){return this._mesh}},{key:"destroy",value:function(){this._mesh&&Fn.destroyObject(this._mesh)}}]),n}();function Oh(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}Dh.prototype.type="__";var Vh=function(){A(r,Dh);var n=Oh(r);function r(e,t){if(j(this,r),t=n.call(this,e,t),e.length<2)throw new Error("Wrong number of argumets on line object creation!");e=m(e,2);return t._id1=e[0],t._id2=e[1],t}return _(r,[{key:"_getAtomFromName",value:function(e,t){e=e.getAtomByFullname(t);if(!e)throw new Error(t+" - Wrong atom format it must be '#CHAIN_NAME.#RESIDUE_NUMBER.#ATOM_NAME' (e.g. 'A.38.CO1')");return e}},{key:"build",value:function(e){var t=new ae.BufferGeometry;this._atom1=this._getAtomFromName(e,this._id1),this._atom2=this._getAtomFromName(e,this._id2);var n=this._atom1.position,r=this._atom2.position,r=new Float32Array([n.x,n.y,n.z,r.x,r.y,r.z]);t.setAttribute("position",new ae.BufferAttribute(r,3)),t.computeBoundingBox(),this._line=new xo.Line(t,new Qi({lights:!1,overrideColor:!0,dashedLine:!0,fogTransparent:oe.now.bg.transparent})),this._line.computeLineDistances(),this._line.material.setUberOptions({fixedColor:new ae.Color(this.opts.color),dashedLineSize:this.opts.dashSize,dashedLinePeriod:this.opts.dashSize+this.opts.gapSize}),this._line.material.updateUniforms(),this._line.raycast=function(e,t){},this._mesh=this._line;e=e.getTransforms();0<e.length&&(this._mesh=new ae.Group,this._mesh.add(this._line),rc.applyTransformsToMeshes(this._mesh,e))}},{key:"updateToFrame",value:function(e){var t;this._atom1&&this._atom2&&this._line&&((t=this._line.geometry).vertices[0].copy(e.getAtomPos(this._atom1.index)),t.vertices[1].copy(e.getAtomPos(this._atom2.index)),this._line.computeLineDistances(),t.computeBoundingSphere(),t.verticesNeedUpdate=!0)}}]),r}();(Vh.prototype.constructor=Vh).prototype.type="line";var zh="precision highp float;\n\nuniform sampler2D srcTex;\nuniform vec2 srcTexSize;\nuniform vec2 thickness;\nvarying vec2 vUv;\n\n#ifdef DEPTH_OUTLINE\n  uniform sampler2D srcDepthTex; //depthTexture\n  uniform vec3 color;\n  uniform float threshold;\n#endif\n\nvoid main() {\n\n  vec2 pixelSize = thickness / srcTexSize;\n\n  #ifdef DEPTH_OUTLINE\n    float c00 = texture2D(srcDepthTex, vUv + vec2(-pixelSize.x,-pixelSize.y)).x;\n    float c01 = texture2D(srcDepthTex, vUv + vec2(0,-pixelSize.y)).x;\n    float c02 = texture2D(srcDepthTex, vUv + vec2(pixelSize.x,-pixelSize.y)).x;\n    float c10 = texture2D(srcDepthTex, vUv + vec2(-pixelSize.x,0)).x;\n    float c12 = texture2D(srcDepthTex, vUv + vec2(pixelSize.x,0)).x;\n    float c20 = texture2D(srcDepthTex, vUv + vec2(-pixelSize.x,pixelSize.y)).x;\n    float c21 = texture2D(srcDepthTex, vUv + vec2(0,pixelSize.y)).x;\n    float c22 = texture2D(srcDepthTex, vUv + vec2(pixelSize.x,pixelSize.y)).x;\n\n    float horizEdge = - c00 - 2.0 * c01 - c02 + c20 + 2.0 * c21 + c22;\n    float vertEdge  = - c00 - 2.0 * c10 - c20 + c02 + 2.0 * c12 + c22;\n\n    float grad = sqrt(horizEdge * horizEdge + vertEdge * vertEdge);\n\n    gl_FragColor = ( grad > threshold ) ? vec4(color.rgb, 1.0) : gl_FragColor = texture2D(srcTex, vUv);\n\n  #else\n    vec4 c00 = texture2D(srcTex, vUv + vec2(-pixelSize.x,-pixelSize.y));\n    vec4 c01 = texture2D(srcTex, vUv + vec2(0,-pixelSize.y));\n    vec4 c02 = texture2D(srcTex, vUv + vec2(pixelSize.x,-pixelSize.y));\n    vec4 c10 = texture2D(srcTex, vUv + vec2(-pixelSize.x,0));\n    vec4 c12 = texture2D(srcTex, vUv + vec2(pixelSize.x,0));\n    vec4 c20 = texture2D(srcTex, vUv + vec2(-pixelSize.x,pixelSize.y));\n    vec4 c21 = texture2D(srcTex, vUv + vec2(0,pixelSize.y));\n    vec4 c22 = texture2D(srcTex, vUv + vec2(pixelSize.x,pixelSize.y));\n\n    vec4 horizEdge = - c00 - 2.0 * c01 - c02 + c20 + 2.0 * c21 + c22;\n    vec4 vertEdge  = - c00 - 2.0 * c10 - c20 + c02 + 2.0 * c12 + c22;\n\n    vec4 grad = sqrt(horizEdge * horizEdge + vertEdge * vertEdge);\n    gl_FragColor = grad;\n  #endif\n}\n";function Fh(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}Vo=function(e){A(r,e);var n=Fh(r);function r(e){var t;j(this,r),t=n.call(this,e);e={uniforms:{srcTex:{type:"t",value:null},srcDepthTex:{type:"t",value:null},srcTexSize:{type:"v2",value:new ae.Vector2(512,512)},color:{type:"v3",value:null},threshold:{type:"f",value:null},opacity:{type:"f",value:1},thickness:{type:"v2",value:new ae.Vector2(1,1)}},vertexShader:En,fragmentShader:zh,transparent:!0,depthTest:!1,depthWrite:!1};return t.setValues(e),t}return _(r,[{key:"copy",value:function(e){tt(P(r.prototype),"copy",this).call(this,e),this.depth=e.depth}},{key:"setValues",value:function(e){void 0!==e&&(tt(P(r.prototype),"setValues",this).call(this,e),e={},this.depth&&(e.DEPTH_OUTLINE=1),this.defines=e)}}]),r}(ae.RawShaderMaterial);Vo.prototype.depth=!1;var Bh="precision highp float;\n\n// edge end finding algorithm parameters\n#define FXAA_QUALITY_PS 8\n#define FXAA_QUALITY_P0 1.0\n#define FXAA_QUALITY_P1 1.5\n#define FXAA_QUALITY_P2 2.0\n#define FXAA_QUALITY_P3 2.0\n#define FXAA_QUALITY_P4 2.0\n#define FXAA_QUALITY_P5 2.0\n#define FXAA_QUALITY_P6 4.0\n#define FXAA_QUALITY_P7 12.0\n// constants\nfloat fxaaQualityEdgeThreshold = 0.125;\nfloat fxaaQualityEdgeThresholdMin = 0.0625;\nfloat fxaaQualitySubpix = 0.7; //0.65;\n// global params\nuniform sampler2D srcTex;\nuniform vec2 srcTexelSize;\nuniform vec3 bgColor;\n// from vs\nvarying vec2 vUv;\n//=====================================================================//\n// calc luminance from rgb\n//'float FxaaLuma(vec3 rgb) {return rgb.y * (0.587/0.299) + rgb.x; } // Lotte's idea about game luminance\nfloat FxaaLuma(vec3 rgb) {return dot(rgb, vec3(0.299, 0.587, 0.114)); } // real luminance calculation\n                                                                           // for non-real scene rendering\n// texture sampling by pixel position(coords) and offset(in pixels)\n vec3 FxaaTex(sampler2D tex, vec2 pos, vec2 off,  vec2 res ) {\n  #ifdef BG_TRANSPARENT\n    vec4 color = texture2D( tex, pos + off * res );\n    return mix(color.rgb, bgColor, 1.0 - color.a);\n  #else\n    return texture2D( tex, pos + off * res ).xyz;\n  #endif\n}\nvec3 FxaaTexTop(sampler2D tex, vec2 pos) {\n  #ifdef BG_TRANSPARENT\n    vec4 color = texture2D( tex, pos );\n    return mix(color.rgb, bgColor, 1.0 - color.a);\n  #else\n    return texture2D( tex, pos).xyz;\n  #endif\n}\nvec4 FxaaTexTopAlpha(sampler2D tex, vec2 pos) {\n  return texture2D( tex, pos);\n}\n\n//=====================================================================//\nvoid main() {\n  // renaming\n  vec2 posM = vUv;\n  // get luminance for neighbours\n  float lumaS = FxaaLuma(FxaaTex(srcTex, posM, vec2( 0.0, 1.0 ), srcTexelSize));\n  float lumaE = FxaaLuma(FxaaTex(srcTex, posM, vec2( 1.0, 0.0 ), srcTexelSize));\n  float lumaN = FxaaLuma(FxaaTex(srcTex, posM, vec2( 0.0, -1.0 ), srcTexelSize));\n  float lumaW = FxaaLuma(FxaaTex(srcTex, posM, vec2( -1.0, 0.0 ), srcTexelSize));\n  float lumaM = FxaaLuma(FxaaTexTop(srcTex, posM));\n  // find max and min luminance\n  float rangeMax = max(max(lumaN, lumaW), max(lumaE, max(lumaS, lumaM)));\n  float rangeMin = min(min(lumaN, lumaW), min(lumaE, min(lumaS, lumaM)));\n  // calc maximum non-edge range\n  float rangeMaxScaled = rangeMax * fxaaQualityEdgeThreshold;\n  float range = rangeMax - rangeMin;\n  float rangeMaxClamped = max(fxaaQualityEdgeThresholdMin, rangeMaxScaled);\n  // exit when luma contrast is small (is not edge)\n  if(range < rangeMaxClamped){\n    gl_FragColor = FxaaTexTopAlpha(srcTex, posM);\n    return;\n  }\n  float subpixRcpRange = 1.0/range;\n  // note: the sampling coordinates can be calculated in vertex shader but the approach doesn't affect performance\n  // visibly, thus we decided to leave calculation here for better readability.\n  // calc other neighbours luminance\n  float lumaNE = FxaaLuma(FxaaTex(srcTex, posM, vec2(  1.0, -1.0 ), srcTexelSize));\n  float lumaSW = FxaaLuma(FxaaTex(srcTex, posM, vec2( -1.0,  1.0 ), srcTexelSize));\n  float lumaSE = FxaaLuma(FxaaTex(srcTex, posM, vec2(  1.0,  1.0 ), srcTexelSize));\n  float lumaNW = FxaaLuma(FxaaTex(srcTex, posM, vec2( -1.0, -1.0 ), srcTexelSize));\n/*--------------span calculation and subpix amount calulation-----------------*/\n  float lumaNS = lumaN + lumaS;\n  float lumaWE = lumaW + lumaE;\n  float subpixNSWE = lumaNS + lumaWE;\n  float edgeHorz1 = (-2.0 * lumaM) + lumaNS;\n  float edgeVert1 = (-2.0 * lumaM) + lumaWE;\n/*--------------------------------------------------------------------------*/\n  float lumaNESE = lumaNE + lumaSE;\n  float lumaNWNE = lumaNW + lumaNE;\n  float edgeHorz2 = (-2.0 * lumaE) + lumaNESE;\n  float edgeVert2 = (-2.0 * lumaN) + lumaNWNE;\n/*--------------------------------------------------------------------------*/\n  float lumaNWSW = lumaNW + lumaSW;\n  float lumaSWSE = lumaSW + lumaSE;\n  float edgeHorz4 = (abs(edgeHorz1) * 2.0) + abs(edgeHorz2);\n  float edgeVert4 = (abs(edgeVert1) * 2.0) + abs(edgeVert2);\n  float edgeHorz3 = (-2.0 * lumaW) + lumaNWSW;\n  float edgeVert3 = (-2.0 * lumaS) + lumaSWSE;\n  float edgeHorz = abs(edgeHorz3) + edgeHorz4;\n  float edgeVert = abs(edgeVert3) + edgeVert4;\n/*--------------------subpix amount calulation------------------------------*/\n  float subpixNWSWNESE = lumaNWSW + lumaNESE;\n  float lengthSign = srcTexelSize.x;\n  bool horzSpan = edgeHorz >= edgeVert;\n   // debug  code edge span visualization\n/*'  if (horzSpan)\n      gl_FragColor = vec4(0.0, 0.0, 1.0, 1.0);\n  else\n    gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);\n  return;*/\n  float subpixA = subpixNSWE * 2.0 + subpixNWSWNESE;\n/*--------------------------------------------------------------------------*/\n  if(!horzSpan) lumaN = lumaW;\n  if(!horzSpan) lumaS = lumaE;\n  if(horzSpan) lengthSign = srcTexelSize.y;\n  float subpixB = (subpixA * (1.0/12.0)) - lumaM;\n/*--------------------------------------------------------------------------*/\n  float gradientN = lumaN - lumaM;\n  float gradientS = lumaS - lumaM;\n  float lumaNN = lumaN + lumaM;\n  float lumaSS = lumaS + lumaM;\n  bool pairN = abs(gradientN) >= abs(gradientS);\n  float gradient = max(abs(gradientN), abs(gradientS));\n  if(pairN) lengthSign = -lengthSign;\n  float subpixC = clamp(abs(subpixB) * subpixRcpRange, 0.0, 1.0);\n/*--------------------------------------------------------------------------*/\n  vec2 posB;\n  posB = posM;\n  vec2 offNP;\n  offNP.x = (!horzSpan) ? 0.0 : srcTexelSize.x;\n  offNP.y = ( horzSpan) ? 0.0 : srcTexelSize.y;\n  if(!horzSpan) posB.x += lengthSign * 0.5;\n  if( horzSpan) posB.y += lengthSign * 0.5;\n/*--------------------------------------------------------------------------*/\n  vec2 posN;\n  posN = posB - offNP * FXAA_QUALITY_P0;\n  vec2 posP;\n  posP = posB + offNP * FXAA_QUALITY_P0;\n  float subpixD = ((-2.0)*subpixC) + 3.0;\n  float lumaEndN = FxaaLuma(FxaaTexTop(srcTex, posN));\n  float subpixE = subpixC * subpixC;\n  float lumaEndP = FxaaLuma(FxaaTexTop(srcTex, posP));\n/*--------------------------------------------------------------------------*/\n  if(!pairN) lumaNN = lumaSS;\n  float gradientScaled = gradient * 1.0/4.0;\n  float lumaMM = lumaM - lumaNN * 0.5;\n  float subpixF = subpixD * subpixE;\n  bool lumaMLTZero = lumaMM < 0.0;\n/*---------------------looped edge-end search-------------------------------*/\n  lumaEndN -= lumaNN * 0.5;\n  lumaEndP -= lumaNN * 0.5;\n  bool doneN = abs(lumaEndN) >= gradientScaled;\n  bool doneP = abs(lumaEndP) >= gradientScaled;\n  if(!doneN) posN -= offNP * FXAA_QUALITY_P1;\n  bool doneNP = (!doneN) || (!doneP);\n  if(!doneP) posP += offNP * FXAA_QUALITY_P1;\n/*--------------------------------------------------------------------------*/\n  if(doneNP) {\n    if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(srcTex, posN.xy));\n    if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(srcTex, posP.xy));\n    if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;\n    if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;\n    doneN = abs(lumaEndN) >= gradientScaled;\n    doneP = abs(lumaEndP) >= gradientScaled;\n    if(!doneN) posN -= offNP * FXAA_QUALITY_P2;\n    doneNP = (!doneN) || (!doneP);\n    if(!doneP) posP += offNP * FXAA_QUALITY_P2;\n/*--------------------------------------------------------------------------*/\n    #if (FXAA_QUALITY_PS > 3)\n      if(doneNP) {\n        if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(srcTex, posN.xy));\n        if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(srcTex, posP.xy));\n        if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;\n        if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;\n        doneN = abs(lumaEndN) >= gradientScaled;\n        doneP = abs(lumaEndP) >= gradientScaled;\n        if(!doneN) posN -= offNP * FXAA_QUALITY_P3;\n        doneNP = (!doneN) || (!doneP);\n        if(!doneP) posP += offNP * FXAA_QUALITY_P3;\n/*--------------------------------------------------------------------------*/\n        #if (FXAA_QUALITY_PS > 4)\n          if(doneNP) {\n            if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(srcTex, posN.xy));\n            if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(srcTex, posP.xy));\n            if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;\n            if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;\n            doneN = abs(lumaEndN) >= gradientScaled;\n            doneP = abs(lumaEndP) >= gradientScaled;\n            if(!doneN) posN -= offNP * FXAA_QUALITY_P4;\n            doneNP = (!doneN) || (!doneP);\n            if(!doneP) posP += offNP * FXAA_QUALITY_P4;\n/*--------------------------------------------------------------------------*/\n            #if (FXAA_QUALITY_PS > 5)\n               if(doneNP) {\n                 if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(srcTex, posN.xy));\n                 if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(srcTex, posP.xy));\n                 if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;\n                 if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;\n                 doneN = abs(lumaEndN) >= gradientScaled;\n                 doneP = abs(lumaEndP) >= gradientScaled;\n                 if(!doneN) posN -= offNP * FXAA_QUALITY_P5;\n                 doneNP = (!doneN) || (!doneP);\n                 if(!doneP) posP += offNP * FXAA_QUALITY_P5;\n/*--------------------------------------------------------------------------*/\n                 #if (FXAA_QUALITY_PS > 6)\n                   if(doneNP) {\n                     if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(srcTex, posN.xy));\n                     if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(srcTex, posP.xy));\n                     if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;\n                     if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;\n                     doneN = abs(lumaEndN) >= gradientScaled;\n                     doneP = abs(lumaEndP) >= gradientScaled;\n                     if(!doneN) posN -= offNP * FXAA_QUALITY_P6;\n                     doneNP = (!doneN) || (!doneP);\n                     if(!doneP) posP += offNP * FXAA_QUALITY_P6;\n/*--------------------------------------------------------------------------*/\n                     #if (FXAA_QUALITY_PS > 7)\n                       if(doneNP) {\n                         if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(srcTex, posN.xy));\n                         if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(srcTex, posP.xy));\n                         if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;\n                         if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;\n                         doneN = abs(lumaEndN) >= gradientScaled;\n                         doneP = abs(lumaEndP) >= gradientScaled;\n                         if(!doneN) posN -= offNP * FXAA_QUALITY_P7;\n                         doneNP = (!doneN) || (!doneP);\n                         if(!doneP) posP += offNP * FXAA_QUALITY_P7;\n/*--------------------------------------------------------------------------*/\n                       }\n                     #endif\n                   }\n                 #endif\n               }\n             #endif\n           }\n         #endif\n      }\n    #endif\n  }\n/*----------------calculate subpix offset due to edge ends-------------------*/\n  float dstN = posM.x - posN.x;\n  float dstP = posP.x - posM.x;\n  if(!horzSpan) dstN = posM.y - posN.y;\n  if(!horzSpan) dstP = posP.y - posM.y;\n/*--------------------------------------------------------------------------*/\n  bool goodSpanN = (lumaEndN < 0.0) != lumaMLTZero;\n  float spanLength = (dstP + dstN);\n  bool goodSpanP = (lumaEndP < 0.0) != lumaMLTZero;\n  float spanLengthRcp = 1.0 / spanLength;\n/*--------------------------------------------------------------------------*/\n  bool directionN = dstN < dstP;\n  float dst = min(dstN, dstP);\n  bool goodSpan = directionN ? goodSpanN : goodSpanP;\n  float subpixG = subpixF * subpixF;\n  float pixelOffset = (dst * (-spanLengthRcp)) + 0.5;\n  float subpixH = subpixG * fxaaQualitySubpix;\n/*-----------------calc texture offest using subpix-------------------------*/\n  float pixelOffsetGood = goodSpan ? pixelOffset : 0.0;\n  float pixelOffsetSubpix = max(pixelOffsetGood, subpixH);\n\n  float offset = pixelOffsetSubpix * lengthSign;\n  #ifdef BG_TRANSPARENT\n    // get original texel\n    vec4 rgbaA = FxaaTexTopAlpha(srcTex, posM);\n    // calc step to blended texel\n    vec2 step = sign((!horzSpan) ? vec2 (offset, 0.0) : vec2 (0.0, offset));\n    // get neighboring texel\n    vec4 rgbaB = FxaaTexTopAlpha(srcTex, posM + step * srcTexelSize);\n    //  calc blend factor from offset\n    float f = (!horzSpan) ? offset / srcTexelSize.x : offset / srcTexelSize.y;\n    f = abs(f);\n    // calc alpha (special formula to emulate blending with bg)\n    gl_FragColor.a = 1.0 - mix(1.0 - rgbaA.a, 1.0 - rgbaB.a, f);\n    // calc color (special formula to emulate blending with bg)\n    gl_FragColor.rgb = mix(rgbaA.rgb * rgbaA.a, rgbaB.rgb * rgbaB.a, f) / gl_FragColor.a;\n  #else\n    if(!horzSpan) {\n       posM.x += offset;\n    } else {\n       posM.y += offset;\n    }\n    gl_FragColor = FxaaTexTopAlpha(srcTex, posM);\n  #endif\n  return;\n}\n";function Uh(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}Ho=function(e){A(r,e);var n=Uh(r);function r(e){var t;return j(this,r),(t=n.call(this,e)).setValues.call(k(t),{uniforms:{srcTex:{type:"t",value:null},srcTexelSize:{type:"v2",value:new ae.Vector2(1/512,1/512)},bgColor:{type:"c",value:new ae.Color(16777215)}},vertexShader:En,fragmentShader:Bh,transparent:!1,depthTest:!1,depthWrite:!1}),t.setValues(e),t}return _(r,[{key:"copy",value:function(e){tt(P(r.prototype),"copy",this).call(this,e),this.depth=e.depth}},{key:"setValues",value:function(e){void 0!==e&&(tt(P(r.prototype),"setValues",this).call(this,e),e={},this.bgTransparent&&(e.BG_TRANSPARENT=1),this.defines=e)}}]),r}(ae.RawShaderMaterial);Ho.prototype.bgTransparent=!1;var Gh="precision highp float;\n#define EPSILON 0.0000001\n\n#define MAX_SAMPLES_COUNT 32\nuniform vec3 samplesKernel[MAX_SAMPLES_COUNT];\nuniform sampler2D noiseTexture;\nuniform vec2      noiseTexelSize;\nuniform sampler2D diffuseTexture;\nuniform sampler2D depthTexture;\nuniform sampler2D normalTexture;\nuniform vec2      srcTexelSize;\nuniform vec2      camNearFar;\nuniform mat4      projMatrix;\n\nuniform float aspectRatio;\nuniform float tanHalfFOV;\n\nuniform float kernelRadius;\nuniform float depthThreshold;\nuniform float factor;\n\nvarying vec2 vUv;\n\nfloat CalcViewZ(vec2 screenPos)\n{\n  float depth = texture2D(depthTexture, screenPos).x;\n  // [0, 1]->[-1, 1]\n  float clipedZ = 2.0 * depth - 1.0;\n  // see THREE.js camera.makeFrustum for projection details\n  return (-projMatrix[3][2] / (clipedZ + projMatrix[2][2]));\n}\n\nvec3 ViewPosFromDepth(vec2 screenPos)\n{\n  vec3 viewPos;\n  viewPos.z = CalcViewZ(screenPos);\n  //[0, 1]->[-1, 1]\n  vec2 projPos = 2.0 * screenPos - 1.0;\n  // reconstruct viewposition in right-handed sc with z to viewer\n  viewPos.xy = vec2(\n                    projPos.x * aspectRatio * tanHalfFOV * abs(viewPos.z),\n                    projPos.y * tanHalfFOV * abs(viewPos.z)\n                   );\n  return viewPos;\n}\n\nvoid main() {\n  vec3 viewPos = ViewPosFromDepth(vUv);\n  // remap coordinates to prevent noise exture rescale\n  vec2 vUvNoise = vUv / srcTexelSize * noiseTexelSize;\n  vec4 normalData = texture2D(normalTexture, vUv);\n  // return for background fragments (their normals are zero vectors)\n  if (length(normalData.rgb) < EPSILON) {\n    // 0.0 in alpha component means that it is background fragment\n    gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);\n    return;\n  }\n  //[0, 1] -> [-1, 1]\n  vec3 normal = (normalData.rgb * 2.0 - 1.0);\n  // normalData.a store 1.0 if normal was build for frontfaced surface\n  // and 0.0 in other case\n  if (normalData.a < EPSILON) {\n    normal *= -1.0;\n  }\n  // get random vector for sampling sphere rotation\n  vec3 randN = texture2D(noiseTexture, vUvNoise).rgb * 2.0 - 1.0;\n  randN = normalize(randN);\n  // build TBN (randomly rotated around normal)\n  vec3 tangent   = normalize(randN - normal * dot(randN, normal));\n  vec3 bitangent = cross(tangent, normal);\n  mat3 TBN = mat3(tangent, bitangent, normal);\n  // calc AO value\n  float AO = 0.0;\n  for (int i = 0 ; i < MAX_SAMPLES_COUNT ; i++) {\n    // rotate sampling kernel around normal\n    vec3 reflectedSample = TBN * samplesKernel[i];\n    // get sample\n    vec3 samplePos = viewPos + reflectedSample * kernelRadius;\n\n    // project sample to screen to get sample's screen pos\n    vec4 SampleScrPos = vec4(samplePos, 1.0);\n    // eye -> clip\n    SampleScrPos = projMatrix * SampleScrPos;\n    // normalize\n    SampleScrPos.xy /= SampleScrPos.w;\n    //[-1, 1] -> [0, 1]\n    SampleScrPos.xy = (SampleScrPos.xy + vec2(1.0)) * 0.5;\n\n    // get view z for sample projected to the objct surface\n    float sampleDepth = CalcViewZ(SampleScrPos.xy);\n    // calc occlusion made by object surface at the sample\n    AO += step(samplePos.z, sampleDepth);\n  }\n  // calc result AO-map color\n  AO = 1.0 - max(0.0, AO / float(MAX_SAMPLES_COUNT) * factor);\n  // write value to AO-map\n  gl_FragColor = vec4(AO, AO, AO, 1.0);\n}\n";function jh(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var Hh=[new ae.Vector3(.295184,.077723,.068429),new ae.Vector3(-.271976,-.365221,.838363),new ae.Vector3(.547713,.467576,.488515),new ae.Vector3(.662808,-.031733,.584758),new ae.Vector3(-.025717,.218955,.657094),new ae.Vector3(-.310153,-.365223,.370701),new ae.Vector3(-.101407,-.006313,.747665),new ae.Vector3(-.769138,.360399,.086847),new ae.Vector3(-.271988,-.27514,.905353),new ae.Vector3(.09674,-.566901,.700151),new ae.Vector3(.562872,-.735136,.094647),new ae.Vector3(.379877,.359278,.190061),new ae.Vector3(.519064,-.023055,.405068),new ae.Vector3(-.301036,.114696,.088885),new ae.Vector3(-.282922,.598305,.487214),new ae.Vector3(-.181859,.25167,.679702),new ae.Vector3(-.191463,-.635818,.512919),new ae.Vector3(-.293655,.427423,.078921),new ae.Vector3(-.267983,.680534,.13288),new ae.Vector3(.139611,.319637,.477439),new ae.Vector3(-.352086,.31104,.653913),new ae.Vector3(.321032,.805279,.487345),new ae.Vector3(.073516,.820734,.414183),new ae.Vector3(-.155324,.589983,.41146),new ae.Vector3(.335976,.170782,.527627),new ae.Vector3(.46346,-.355658,.167689),new ae.Vector3(.222654,.59655,.769406),new ae.Vector3(.922138,-.04207,.147555),new ae.Vector3(-.72705,-.329192,.369826),new ae.Vector3(-.090731,.53382,.463767),new ae.Vector3(-.323457,-.876559,.238524),new ae.Vector3(-.663277,-.372384,.342856)],Zo=function(e){A(n,e);var t=jh(n);function n(){var e;return j(this,n),(e=t.call(this)).setValues.call(k(e),{uniforms:{noiseTexture:{type:"t",value:Xi.noiseTexture},noiseTexelSize:{type:"v2",value:new ae.Vector2(1/Xi.noiseWidth,1/Xi.noiseHeight)},diffuseTexture:{type:"t",value:null},normalTexture:{type:"t",value:null},depthTexture:{type:"t",value:null},srcTexelSize:{type:"v2",value:new ae.Vector2(1/512,1/512)},camNearFar:{type:"v2",value:new ae.Vector2(1,10)},projMatrix:{type:"mat4",value:new ae.Matrix4},aspectRatio:{type:"f",value:0},tanHalfFOV:{type:"f",value:0},samplesKernel:{type:"v3v",value:Hh},kernelRadius:{type:"f",value:1},depthThreshold:{type:"f",value:1},factor:{type:"f",value:1}},vertexShader:En,fragmentShader:Gh,transparent:!1,depthTest:!1,depthWrite:!1}),e}return n}(ae.RawShaderMaterial),Wh="precision highp float;\n#define EPSILON 0.0000001\n\n#define MAX_SAMPLES_COUNT 5\nuniform float samplesOffsets[MAX_SAMPLES_COUNT];\nuniform sampler2D aoMap;\nuniform sampler2D depthTexture;\nuniform vec2      srcTexelSize;\n\nvarying vec2 vUv;\n\nvoid main() {\n  float x = vUv.x;\n  float y = vUv.y;\n  vec4 res = vec4(0.0);\n  res.a = texture2D(aoMap, vec2(x, y )).a;\n  // return for background fragments (0.0 in alpha component means that it is background fragment)\n  if (res.a < EPSILON) {\n    gl_FragColor = res;\n    return;\n  }\n\n  float pixelDepth = texture2D(depthTexture, vec2(x, y)).x;\n  float weightSum = 0.0;\n  for (int i = 0; i < MAX_SAMPLES_COUNT; ++i) {\n    if (texture2D(aoMap, vec2(x + samplesOffsets[i] * srcTexelSize.x, y )).a < EPSILON) {\n      continue;\n    }\n    vec2 samplePos = vec2(x + samplesOffsets[i] * srcTexelSize.x, y);\n    float depth = texture2D(depthTexture, samplePos).x;\n    float weight = (1.0 / (0.0001 + abs(depth - pixelDepth)));\n    res.rgb += texture2D(aoMap, vec2(x + samplesOffsets[i] * srcTexelSize.x, y )).rgb * weight;\n    weightSum += weight;\n  }\n  res.rgb = res.rgb / weightSum;\n  gl_FragColor = res;\n}\n";function Yh(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var Xh=[-2,-1,0,1,2],Qo=function(e){A(n,e);var t=Yh(n);function n(){var e;return j(this,n),(e=t.call(this)).setValues.call(k(e),{uniforms:{depthTexture:{type:"t",value:null},srcTexelSize:{type:"v2",value:new ae.Vector2(1/512,1/512)},aoMap:{type:"t",value:null},samplesOffsets:{type:"fv1",value:Xh}},vertexShader:En,fragmentShader:Wh,transparent:!1,depthTest:!1,depthWrite:!1}),e}return n}(ae.RawShaderMaterial),qh="precision highp float;\n#define EPSILON 0.0000001\n\n#define MAX_SAMPLES_COUNT 5\nuniform float samplesOffsets[MAX_SAMPLES_COUNT];\nuniform sampler2D diffuseTexture;\nuniform sampler2D aoMap;\nuniform sampler2D depthTexture;\nuniform vec2      srcTexelSize;\n\nuniform mat4  projMatrix;\nuniform float aspectRatio;\nuniform float tanHalfFOV;\n\n#ifdef USE_FOG\n  uniform vec2 fogNearFar;\n  uniform vec4 fogColor;\n#endif\nvarying vec2 vUv;\n\nfloat CalcViewZ(vec2 screenPos)\n{\n  float depth = texture2D(depthTexture, screenPos).x;\n  // [0, 1]->[-1, 1]\n  float clipedZ = 2.0 * depth - 1.0;\n  // see THREE.js camera.makeFrustum for projection details\n  return (-projMatrix[3][2] / (clipedZ + projMatrix[2][2]));\n}\n\nvec3 ViewPosFromDepth(vec2 screenPos)\n{\n  vec3 viewPos;\n  viewPos.z = CalcViewZ(screenPos);\n  //[0, 1]->[-1, 1]\n  vec2 projPos = 2.0 * screenPos - 1.0;\n  // reconstruct viewposition in right-handed sc with z to viewer\n  viewPos.xy = vec2(\n  projPos.x * aspectRatio * tanHalfFOV * abs(viewPos.z),\n  projPos.y * tanHalfFOV * abs(viewPos.z)\n  );\n  return viewPos;\n}\n\nvoid main() {\n  vec3 viewPos = ViewPosFromDepth(vUv);\n  float x = vUv.x;\n  float y = vUv.y;\n  vec4 color = texture2D(diffuseTexture, vec2(x, y));\n  vec4 res = vec4(0.0);\n  res.a = texture2D(aoMap, vec2(x, y )).a;\n  // return for background fragments (0.0 in alpha component means that it is background fragment)\n  if (res.a < EPSILON) {\n    gl_FragColor = color;\n    return;\n  }\n\n  float pixelDepth = texture2D(depthTexture, vec2(x, y)).x;\n  float weightSum = 0.0;\n  for (int i = 0; i < MAX_SAMPLES_COUNT; ++i) {\n    if (texture2D(aoMap, vec2(x, y + samplesOffsets[i] * srcTexelSize.y)).a < EPSILON) {\n      continue;\n    }\n    vec2 samplePos = vec2(x, y + samplesOffsets[i] * srcTexelSize.y);\n    float depth = texture2D(depthTexture, samplePos).x;\n    float weight = (1.0 / (0.0001 + abs(depth - pixelDepth)));\n    res.rgb += texture2D(aoMap, vec2(x, y + samplesOffsets[i] * srcTexelSize.y)).rgb * weight;\n    weightSum += weight;\n  }\n  res.rgb /= weightSum;\n\n  #if defined(USE_FOG) && !defined(FOG_TRANSPARENT)\n    // Add fog to the result value\n    // Proper way to get an image with fog and ao requires formula:\n    //          gl_FragColor = fragColor*AO*(1-fogFactor) + fogColor*fogFactor\n    // But we have already fogged molecule to add AO too. Let's split the straight formula into our real steps!\n    // We have:  AO, fogFactor, fogColor,\n    //          color = fragColor*(1-fogFactor) + fogColor*fogFactor (it comes from diffuseTexture,\n    //                                                                where molecule has been already drawn with fog)\n    // Transform:\n    //          fragColor*AO*(1-fogFactor) + fogColor*fogFactor =\n    //        = [fragColor*(1-fogFactor) = color - fogColor*fogFactor] =\n    //        = (color - fogColor*fogFactor)*AO + fogColor*fogFactor =\n    //        = color*AO + fogColor*fogFactor*(1 - AO)\n    // Result:  gl_FragColor = color*AO + fogColor*fogFactor*(1 - AO)\n    float fogFactor = smoothstep(fogNearFar.x, fogNearFar.y, - viewPos.z) * fogColor.a;\n    gl_FragColor.rgb = color.rgb * res.rgb + fogColor.rgb * fogFactor *(vec3(1.0, 1.0, 1.0) - res.rgb);\n  #else\n    gl_FragColor.rgb = color.rgb * res.rgb;\n  #endif\n  gl_FragColor.a = color.a;\n}\n";function $h(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var Zh=[-2,-1,0,1,2],is=function(e){A(r,e);var n=$h(r);function r(e){var t;return j(this,r),(t=n.call(this,e)).setValues.call(k(t),{uniforms:{diffuseTexture:{type:"t",value:null},depthTexture:{type:"t",value:null},srcTexelSize:{type:"v2",value:new ae.Vector2(1/512,1/512)},aoMap:{type:"t",value:null},samplesOffsets:{type:"fv1",value:Zh},projMatrix:{type:"mat4",value:new ae.Matrix4},aspectRatio:{type:"f",value:0},tanHalfFOV:{type:"f",value:0},fogNearFar:{type:"v2",value:new ae.Vector2(100,100)},fogColor:{type:"v4",value:new ae.Vector4(0,.5,0,1)}},vertexShader:En,fragmentShader:qh,transparent:!1,depthTest:!1,depthWrite:!1}),t.setValues(e),t}return _(r,[{key:"setValues",value:function(e){void 0!==e&&(tt(P(r.prototype),"setValues",this).call(this,e),e={},this.useFog&&(e.USE_FOG=1),this.fogTransparent&&(e.FOG_TRANSPARENT=1),this.defines=e)}}]),r}(ae.RawShaderMaterial);is.prototype.useFog=!0,is.prototype.fogTransparent=!1;var Kh="precision highp float;\n\nuniform sampler2D srcL;\nuniform sampler2D srcR;\nvarying vec2 vUv;\n\nvoid main() {\n  vec4 l = texture2D(srcL, vUv);\n  vec4 r = texture2D(srcR, vUv);\n  gl_FragColor = vec4(l.r, r.g, r.b, 1.0);\n}\n";function Qh(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=P(n);return t=r?(e=P(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),T(this,t)}}var ss=function(e){A(r,e);var n=Qh(r);function r(){var e;j(this,r),e=n.call(this);var t={uniforms:{srcL:{type:"t",value:null},srcR:{type:"t",value:null}},vertexShader:En,fragmentShader:Kh,transparent:!1,depthTest:!1,depthWrite:!1};return e.setValues(t),e}return r}(ae.RawShaderMaterial),Jh=function(){function e(){j(this,e),this.position=new ae.Vector3(0,0,0),this.scale=1,this.orientation=new ae.Quaternion(0,0,0,1)}return _(e,[{key:"set",value:function(e,t,n){this.position=e,this.scale=t,this.orientation=n}}]),e}(),ef=function(){function e(){j(this,e)}return _(e,[{key:"setup",value:function(e,t){this._startTime=void 0,this._endTime=void 0,this._isPaused=!1,this._srcView=e,this._dstView=t,this._isMoving=!1}},{key:"isMoving",value:function(){return this._isMoving}},{key:"wasStarted",value:function(){return void 0!==this._startTime&&void 0!==this._endTime}},{key:"start",value:function(){this._startTime=Date.now();var e=oe.now.interpolateViews?1500:0;this._endTime=this._startTime+e,this._isMoving=!0}},{key:"getCurrentView",value:function(){if(void 0===this._srcView||void 0===this._dstView||!this._isMoving||!this.wasStarted())return{success:!1};var e=this.createView(),t=Date.now();if(t>this._endTime)return e=this._dstView,this.reset(),{success:!0,view:e};t=(t-this._startTime)/(this._endTime-this._startTime);return e.position.copy(this._srcView.position),e.position.lerp(this._dstView.position,t),e.scale=(1-t)*this._srcView.scale+t*this._dstView.scale,e.orientation.copy(this._srcView.orientation),e.orientation.slerp(this._dstView.orientation,t),{success:!0,view:e}}},{key:"reset",value:function(){this._startTime=this._endTime=0,this._isMoving=!1}},{key:"pause",value:function(){this._isPaused||(this.setup(this.getCurrentView().view,this._dstView),this._isPaused=!0)}},{key:"resume",value:function(){this._isPaused=!1}},{key:"createView",value:function(){return new Jh}}]),e}();function tf(e,t){this.context=e,this._opts=b.default.merge({path:"/"},t)}function nf(i){function e(e){e.style.position="absolute",e.style.bottom="20px",e.style.padding="12px 6px",e.style.border="1px solid #fff",e.style.borderRadius="4px",e.style.background="transparent",e.style.color="#fff",e.style.font="normal 13px sans-serif",e.style.textAlign="center",e.style.opacity="0.5",e.style.outline="none",e.style.zIndex="999"}if("xr"in navigator){var t=document.createElement("button");return t.style.display="none",e(t),navigator.xr.isSessionSupported("immersive-vr").then(function(e){return e?function(t){t.style.display="",t.style.cursor="pointer",t.style.left="calc(50% - 50px)",t.style.width="100px",t.textContent="ENTER VR";var n=null;function r(){n.removeEventListener("end",r),t.textContent="ENTER VR",n=null}function e(e){e.addEventListener("end",r),i._gfx.renderer.xr.setReferenceSpaceType("local"),i._gfx.renderer.xr.setSession(e),t.textContent="EXIT VR",n=e}t.onmouseenter=function(){t.style.opacity="1.0"},t.onmouseleave=function(){t.style.opacity="0.5"},t.onclick=function(){null===n?(navigator.xr.requestSession("immersive-vr",{optionalFeatures:["local-floor","bounded-floor"]}).then(e),i.moveSceneBehindHeadset()):n.end()}}(t):((e=t).style.display="",e.style.cursor="auto",e.style.left="calc(50% - 75px)",e.style.width="150px",e.textContent="VR NOT FOUND",e.onmouseenter=null,e.onmouseleave=null,void(e.onclick=null))}),t}var n=document.createElement("a");return n.href="https://webvr.info",n.innerHTML="WEBXR NOT SUPPORTED",n.style.left="calc(50% - 90px)",n.style.width="180px",n.style.textDecoration="none",e(n),n}$n(tf.prototype),tf.prototype.removeCookie=function(e){var t=this._toCount(e),n=this._getSimpleCookie(t);if(n){this._removeSimpleCookie(t),n=parseInt(n,10);for(var r=0;r<n;++r)this._removeSimpleCookie(e+r)}else this._removeSimpleCookie(e)},tf.prototype.setCookie=function(e,t){this.removeCookie(e);var n=function(e,t){for(var n=e.length,r=[],i=0,o=0;o<n;i++,o+=t)r[i]=e.slice(o,o+t);return r}(t=encodeURIComponent(t),4e3-e.length-1),r=n.length;if(1!==r){var i=this._toCount(e);this._setSimpleCookie(i,r.toString());for(var o=0;o<r;++o)this._setSimpleCookie(e+o,n[o])}else this._setSimpleCookie(e,t)},tf.prototype.getCookie=function(e){var t=this._toCount(e),n=this._getSimpleCookie(t);if(!n)return this._getSimpleCookie(e);n=parseInt(n,10);for(var r=[],i=0;i<n;++i)r[i]=this._getSimpleCookie(e+i);return r.join("")},tf.prototype._toCount=function(e){return e+"Cnt"},tf.prototype._removeSimpleCookie=function(e){document.cookie="".concat(e,"=; expires=Thu, 01 Jan 1970 00:00:01 GMT;")},tf.prototype._getExpirationDate=function(){var e=new Date;return e.setFullYear(e.getFullYear()+10),e},tf.prototype._setSimpleCookie=function(e,t){document.cookie="".concat(e,"=").concat(t,";expires=").concat(this._getExpirationDate().toUTCString(),";path=").concat(this._opts.path)},tf.prototype._getSimpleCookie=function(e){e=document.cookie.match(new RegExp("(?:^|; )".concat(e,"=([^;]*)")));return e?decodeURIComponent(e[1]):""},tf.prototype._exists=function(e){return document.cookie.match(new RegExp("(?:^|; )".concat(e,"=([^;]*)")))};var rf,of,sf,af,cf,lf,uf,hf,ff,df,pf,mf,yf,_f,vf,gf,xf,bf,wf,Sf,Rf,Cf,Af,Ef,kf,Tf,Pf=function(){function t(e){j(this,t),this._mainCamera=new ae.PerspectiveCamera,this._button=null,this._onToggle=e,this._molContainer=new Fn.RCGroup,this._user=new Fn.RCGroup,this._scalingPivot=new ae.Object3D,this._user.add(this._scalingPivot),this._controller1=null,this._controller2=null,this._pressedGripsCounter=0,this._distance=0,this._gfx=null}return _(t,[{key:"startScalingByControllers",value:function(){this._distance=this._controller1.position.distanceTo(this._controller2.position),Fn.getMiddlePoint(this._controller1.position,this._controller2.position,this._scalingPivot.position),this._scalingPivot.scale.set(1,1,1),this._scalingPivot.updateMatrix(),this._scalingPivot.updateMatrixWorld(),this._scalingPivot.addSavingWorldTransform(this._molContainer)}},{key:"stopScalingByControllers",value:function(){this._gfx.scene.addSavingWorldTransform(this._molContainer)}},{key:"handleGripsDown",value:function(e){this._pressedGripsCounter++,2===this._pressedGripsCounter?this.startScalingByControllers():1===this._pressedGripsCounter&&e.target.addSavingWorldTransform(this._molContainer)}},{key:"handleGripsUp",value:function(e){this._pressedGripsCounter--,1===this._pressedGripsCounter?(this.stopScalingByControllers(),(e.target===this._controller1?this._controller2:this._controller1).addSavingWorldTransform(this._molContainer)):0===this._pressedGripsCounter&&this._gfx.scene.addSavingWorldTransform(this._molContainer)}},{key:"enable",value:function(e){if(e){var t=(this._gfx=e).renderer,n=e.camera;if(!t)throw new Error("No renderer is available to toggle WebVR");if(!n)throw new Error("No camera is available to toggle WebVR");t.xr.enabled=!0,this._button?this._button.style.display="block":(this._button=nf(this),document.body.appendChild(this._button)),this._mainFog=oe.now.fog,oe.set("fog",!1),this._plugVRNodesIntoScene(e,t),this._setControllersListeners(),this._onToggle&&this._onToggle(!0)}else B.warn("WebVR couldn't be enabled, because gfx is not defined")}},{key:"_plugVRNodesIntoScene",value:function(e,t){this._mainCamera.copy(e.camera),e.scene.add(this._user),e.scene.add(this._molContainer),this._molContainer.add(e.root),this._controller1=t.xr.getController(0),this._controller2=t.xr.getController(1);t=this._createControllerMesh();this._controller1.add(t),this._controller2.add(t.clone()),this._user.add(this._controller1),this._user.add(this._controller2)}},{key:"_setControllersListeners",value:function(){var t=this;this._controller1.addEventListener("selectstart",function(e){t.handleGripsDown(e)}),this._controller1.addEventListener("selectend",function(e){t.handleGripsUp(e)}),this._controller2.addEventListener("selectstart",function(e){t.handleGripsDown(e)}),this._controller2.addEventListener("selectend",function(e){t.handleGripsUp(e)}),this._controller1.addEventListener("squeezestart",function(e){t.handleGripsDown(e)}),this._controller1.addEventListener("squeezeend",function(e){t.handleGripsUp(e)}),this._controller2.addEventListener("squeezestart",function(e){t.handleGripsDown(e)}),this._controller2.addEventListener("squeezeend",function(e){t.handleGripsUp(e)})}},{key:"disable",value:function(){if(this._gfx){var e=this._gfx,t=e.renderer,n=e.camera;if(!t)throw new Error("No renderer is available to toggle WebVR");t.setAnimationLoop(null);e=t.xr.getSession();e&&e.end(),t.xr.enabled=!1,this._button&&(this._button.style.display="none"),oe.set("fog",this._mainFog),this._unplugVRNodesFromScene(n),this._onToggle&&this._onToggle(!1)}}},{key:"_unplugVRNodesFromScene",value:function(e){this._mainCamera&&e&&e.copy(this._mainCamera);e=this._molContainer.children[0];e&&this._gfx.scene.add(e),this._molContainer.parent.remove(this._molContainer),this._user&&this._gfx.scene.remove(this._user),this._molContainer=null,this._user=null,this._scalingPivot=null,this._user=null,this._controller1=null,this._controller2=null}},{key:"_createControllerMesh",value:function(){var e=new ae.CylinderGeometry(.04,.04,.3),t=new Qi({lights:!1,overrideColor:!0});t.setUberOptions({fixedColor:new ae.Color(4474111)}),t.updateUniforms();t=new ae.Mesh(e,t);return t.rotateX(-Math.PI/2),t}},{key:"updateMoleculeScale",value:function(){var e,t;this._controller1&&this._controller2&&(2===this._pressedGripsCounter&&(Fn.getMiddlePoint(this._controller1.position,this._controller2.position,this._scalingPivot.position),t=(e=this._controller1.position.distanceTo(this._controller2.position))/this._distance,this._scalingPivot.scale.multiplyScalar(t),this._distance=e))}},{key:"moveSceneBehindHeadset",value:function(){var e=this._gfx,t=e.camera,n=this._molContainer;n.matrix.identity(),n.position.set(0,0,-4),n.updateMatrix(),n.matrixWorld.multiplyMatrices(t.matrixWorld,n.matrix),e.scene.addSavingWorldTransform(n),this._onToggle&&this._onToggle(!0)}},{key:"getCanvas",value:function(){var e=this._gfx;return e&&e.renderer?e.renderer.domElement:null}}]),t}(),Mf=wn.selectors,Nf=wn.Atom,If=wn.Residue,Lf=wn.Chain,Df=wn.Molecule,Of=0,Vf=1,zf=2,Ff="Could not find suitable loader for this source",Bf=ce.createElement;function Uf(e){var t=e.lastIndexOf(".");return 0<=t&&(e=e.substr(0,t)),e}function Gf(e,t,n){void 0!==n?e.debug("".concat(t,"... ").concat(Math.floor(100*n),"%")):e.debug("".concat(t,"..."))}function jf(){return oe.now.fogColorEnable?oe.now.fogColor:oe.now.bg.color}function Hf(e){O.call(this),this._opts=b.default.merge({settingsCookie:"settings",cookiePath:"/"},e),this._gfx=null,this._interpolator=new ef,this._container=e&&e.container||document.getElementById("miew-container")||b.default.head(document.getElementsByClassName("miew-container"))||document.body,this._containerRoot=this._container,this._running=!1,this._halting=!1,this._building=!1,this._needRender=!0,this._hotKeysEnabled=!0,this.settings=oe;var t=B;t.console=!1,t.level="info",this.logger=t,this._cookies=new tf(this),this.restoreSettings(),e&&e.settings&&this.settings.set(e.settings),this._spinner=null,this._loading=[],this._animInterval=null,this._visuals={},this._curVisualName=null,this._objects=[],this._sourceWindow=null,this.reset(),this._repr&&t.debug("Selected ".concat(this._repr.mode.name," mode with ").concat(this._repr.colorer.name," colorer."));var n=this;Hf.registeredPlugins.forEach(function(e){e.call(n)}),this._initOnSettingsChanged()}function Wf(e,t){for(var n=e;n.firstChild;)n.removeChild(n.firstChild);n.appendChild(t)}function Yf(e){return e.getExtension("EXT_frag_depth")}function Xf(e){return e.getExtension("WEBGL_depth_texture")&&e.getExtension("WEBGL_draw_buffers")}Hf.prototype=Object.create(O.prototype),(Hf.prototype.constructor=Hf).prototype.getMaxRepresentationCount=function(){return fc.NUM_REPRESENTATION_BITS},Hf.prototype._updateShadowCamera=(rf=new ae.Matrix4,of=new ae.Vector3,sf={center:new ae.Vector3,halfSize:new ae.Vector3},function(){this._gfx.scene.updateMatrixWorld();for(var e,t=0;t<this._gfx.scene.children.length;t++)"DirectionalLight"===this._gfx.scene.children[t].type&&(e=this._gfx.scene.children[t],rf.copy(e.shadow.camera.matrixWorldInverse),this.getOBB(rf,sf),of.subVectors(e.target.position,e.position),e.position.subVectors(sf.center,of),e.target.position.copy(sf.center),e.shadow.bias=.09,e.shadow.camera.bottom=-sf.halfSize.y,e.shadow.camera.top=sf.halfSize.y,e.shadow.camera.right=sf.halfSize.x,e.shadow.camera.left=-sf.halfSize.x,e.shadow.camera.near=of.length()-sf.halfSize.z,e.shadow.camera.far=of.length()+sf.halfSize.z,e.shadow.camera.updateProjectionMatrix())}),Hf.prototype.init=function(){var e=this._container,t=ce.createElement("div",{class:"miew-canvas"});Wf(e,t),this._container=t;t=document.createDocumentFragment();if(t.appendChild(this._msgMode=Bf("div",{class:"mode-message overlay"},Bf("p",{},"COMPONENT EDIT MODE"))),t.appendChild(this._msgAtomInfo=Bf("div",{class:"atom-info overlay"},Bf("p",{},""))),e.appendChild(t),null!==this._gfx)return!0;var n=this;this._showMessage("Viewer is being initialized...");try{this._initGfx(),this._initListeners(),this._spinner=new h({lines:13,length:28,width:14,radius:42,color:"#fff",zIndex:700}),window.top.addEventListener("keydown",function(e){n._onKeyDown(e)}),window.top.addEventListener("keyup",function(e){n._onKeyUp(e)}),this._objectControls=new Ah(this._gfx.root,this._gfx.pivot,this._gfx.camera,this._gfx.renderer.domElement,function(){return n._getAltObj()}),this._objectControls.addEventListener("change",function(e){switch(oe.now.shadow.on&&n._updateShadowCamera(),e.action){case"rotate":n.dispatchEvent({type:"rotate",quaternion:e.quaternion});break;case"zoom":n.dispatchEvent({type:"zoom",factor:e.factor});break;default:n.dispatchEvent({type:e.action})}n.dispatchEvent({type:"transform"}),n._needRender=!0});var r=this._gfx;this._picker=new Eh(r.root,r.camera,r.renderer.domElement),this._picker.addEventListener("newpick",function(e){n._onPick(e)}),this._picker.addEventListener("dblclick",function(e){n.center(e)})}catch(e){if("TypeError"===e.name&&"Cannot read property 'getExtension' of null"===e.message)this._showMessage("Could not create WebGL context.");else{if(!(1<e.message.search(/webgl/i)))throw this._showMessage("Viewer initialization failed."),e;this._showMessage(e.message)}return!1}e=this._opts&&this._opts.load;return e&&(t=this._opts&&this._opts.type,this.load(e,{fileType:t,keepRepsInfo:!0})),!0},Hf.prototype.term=function(){this._showMessage("Viewer has been terminated."),this._loading.forEach(function(e){e.cancel()}),this._loading.length=0,this.halt(),this._gfx=null},Hf.prototype._showMessage=function(e){var t=document.createElement("div");t.setAttribute("class","miew-message"),t.appendChild(document.createElement("p")).appendChild(document.createTextNode(e)),Wf(this._container,t)},Hf.prototype._showCanvas=function(){Wf(this._container,this._gfx.renderer.domElement)},Hf.prototype._requestAnimationFrame=function(e){var t=this._gfx.renderer.xr;t&&t.enabled?this._gfx.renderer.setAnimationLoop(e):requestAnimationFrame(e)},Hf.prototype._initGfx=function(){var e={width:this._container.clientWidth,height:this._container.clientHeight},t={preserveDrawingBuffer:!0,alpha:!0,premultipliedAlpha:!1};oe.now.antialias&&(t.antialias=!0),e.renderer2d=new _h,e.renderer=new ae.WebGL1Renderer(t),e.renderer.shadowMap.enabled=oe.now.shadow.on,e.renderer.shadowMap.autoUpdate=!1,e.renderer.shadowMap.type=ae.PCFShadowMap,Fi.init(e.renderer),Yf(e.renderer.getContext())||oe.set("zSprites",!1),Xf(e.renderer.getContext())||oe.set("ao",!1),e.renderer.autoClear=!1,e.renderer.setPixelRatio(window.devicePixelRatio),e.renderer.setSize(e.width,e.height),e.renderer.setClearColor(oe.now.bg.color,Number(!oe.now.bg.transparent)),e.renderer.clearColor(),e.renderer2d.setSize(e.width,e.height),e.camera=new ae.PerspectiveCamera(oe.now.camFov,e.width/e.height,oe.now.camNear,oe.now.camFar),e.camera.setMinimalFov(oe.now.camFov),e.camera.position.z=oe.now.camDistance,e.camera.updateProjectionMatrix(),e.camera.layers.set(Fn.LAYERS.DEFAULT),e.camera.layers.enable(Fn.LAYERS.VOLUME),e.camera.layers.enable(Fn.LAYERS.VOLUME_BFPLANE),e.stereoCam=new ae.StereoCamera,e.scene=new ae.Scene;var n=jf();e.scene.fog=new ae.Fog(n,oe.now.camNear,oe.now.camFar),e.root=new Fn.RCGroup,e.scene.add(e.root),e.pivot=new Fn.RCGroup,e.root.add(e.pivot),e.selectionScene=new ae.Scene,e.selectionRoot=new ae.Group,e.selectionRoot.matrixAutoUpdate=!1,e.selectionScene.add(e.selectionRoot),e.selectionPivot=new ae.Group,e.selectionPivot.matrixAutoUpdate=!1,e.selectionRoot.add(e.selectionPivot);var r=new ae.DirectionalLight(16777215,.45);r.position.set(0,.414,1),r.layers.enable(Fn.LAYERS.TRANSPARENT),r.castShadow=!0,r.shadow.bias=.09,r.shadow.radius=oe.now.shadow.radius,r.shadow.camera.layers.set(Fn.LAYERS.SHADOWMAP);t=e.renderer.getPixelRatio(),n=Math.max(e.width,e.height)*t;r.shadow.mapSize.width=n,r.shadow.mapSize.height=n,r.target.position.set(0,0,0),e.scene.add(r),e.scene.add(r.target);r=new ae.AmbientLight(6710886);r.layers.enable(Fn.LAYERS.TRANSPARENT),e.scene.add(r),e.axes=new kh(e.root,e.camera);r=e.width*t,t=e.height*t;e.offscreenBuf=new ae.WebGLRenderTarget(r,t,{minFilter:ae.LinearFilter,magFilter:ae.NearestFilter,format:ae.RGBAFormat,depthBuffer:!0}),e.renderer.getContext().getExtension("WEBGL_depth_texture")&&(e.offscreenBuf.depthTexture=new ae.DepthTexture,e.offscreenBuf.depthTexture.type=ae.UnsignedShortType),e.offscreenBuf2=new ae.WebGLRenderTarget(r,t,{minFilter:ae.LinearFilter,magFilter:ae.LinearFilter,format:ae.RGBAFormat,depthBuffer:!1}),e.offscreenBuf3=new ae.WebGLRenderTarget(r,t,{minFilter:ae.LinearFilter,magFilter:ae.LinearFilter,format:ae.RGBAFormat,depthBuffer:!1}),e.offscreenBuf4=new ae.WebGLRenderTarget(r,t,{minFilter:ae.LinearFilter,magFilter:ae.LinearFilter,format:ae.RGBAFormat,depthBuffer:!1}),e.volBFTex=e.offscreenBuf3,e.volFFTex=e.offscreenBuf4,e.volWFFTex=e.offscreenBuf,e.renderer.getContext().getExtension("OES_texture_float")?(e.offscreenBuf5=new ae.WebGLRenderTarget(r,t,{minFilter:ae.LinearFilter,magFilter:ae.LinearFilter,format:ae.RGBAFormat,type:ae.FloatType,depthBuffer:!1}),e.offscreenBuf6=new ae.WebGLRenderTarget(r,t,{minFilter:ae.LinearFilter,magFilter:ae.LinearFilter,format:ae.RGBAFormat,type:ae.FloatType,depthBuffer:!1}),e.offscreenBuf7=new ae.WebGLRenderTarget(r,t,{minFilter:ae.LinearFilter,magFilter:ae.LinearFilter,format:ae.RGBAFormat,type:ae.FloatType,depthBuffer:!0}),e.volBFTex=e.offscreenBuf5,e.volFFTex=e.offscreenBuf6,e.volWFFTex=e.offscreenBuf7):this.logger.warn("Device doesn't support OES_texture_float extension"),e.stereoBufL=new ae.WebGLRenderTarget(r,t,{minFilter:ae.LinearFilter,magFilter:ae.LinearFilter,format:ae.RGBAFormat,depthBuffer:!1}),e.stereoBufR=new ae.WebGLRenderTarget(r,t,{minFilter:ae.LinearFilter,magFilter:ae.LinearFilter,format:ae.RGBAFormat,depthBuffer:!1}),this._gfx=e,this._showCanvas(),this._embedWebXR("WEBVR"===oe.now.stereo),this._container.appendChild(e.renderer2d.getElement());e=new w;e.domElement.style.position="absolute",e.domElement.style.right="0",e.domElement.style.bottom="0",this._container.appendChild(e.domElement),this._fps=e,this._fps.show(oe.now.fps)},Hf.prototype._initListeners=function(){var e=this;window.addEventListener("resize",function(){e._onResize()})},Hf.prototype._makeUniqueVisualName=function(e){if(!e)return Math.random().toString();for(var t=e,n=1;this._visuals.hasOwnProperty(t);)t="".concat(e," (").concat(n.toString(),")"),n++;return t},Hf.prototype._addVisual=function(e){if(!e)return null;var t=this._makeUniqueVisualName(e.name);return e.name=t,this._visuals[t]=e,this._gfx.pivot.add(e),e.getSelectionGeo&&this._gfx.selectionPivot.add(e.getSelectionGeo()),t},Hf.prototype._removeVisual=function(e){var t="",n=null;e instanceof Gn?(t=e.name,n=e):"string"==typeof e&&(t=e,n=this._visuals[t]),n&&this._visuals.hasOwnProperty(t)&&this._visuals[t]===n&&(t===this._curVisualName&&(this._curVisualName=void 0),delete this._visuals[t],n.release(),this._needRender=!0)},Hf.prototype._forEachVisual=function(e){for(var t in this._visuals)this._visuals.hasOwnProperty(t)&&e(this._visuals[t])},Hf.prototype._releaseAllVisuals=function(){if(this._gfx&&this._gfx.pivot){for(var e in this._visuals)this._visuals.hasOwnProperty(e)&&this._visuals[e].release();this._visuals={}}},Hf.prototype._forEachComplexVisual=function(e){if(this._gfx&&this._gfx.pivot)for(var t in this._visuals)this._visuals.hasOwnProperty(t)&&this._visuals[t]instanceof fc&&e(this._visuals[t])},Hf.prototype._getComplexVisual=function(t){t=t||this._curVisualName;var n=null,r=null;return this._forEachComplexVisual(function(e){(n=e).name===t&&(r=e)}),r||n},Hf.prototype._getVolumeVisual=function(){var t=null;return this._forEachVisual(function(e){e instanceof Mc&&(t=e)}),t},Hf.prototype._getVisualForComplex=function(t){if(!t)return null;var n=null;return this._forEachComplexVisual(function(e){e.getComplex()===t&&(n=e)}),n},Hf.prototype.getVisuals=function(){return Object.keys(this._visuals)},Hf.prototype.getComplexVisualsCount=function(){var e=0;return this._forEachComplexVisual(function(){return e++}),e},Hf.prototype.getCurrentVisual=function(){return this._curVisualName},Hf.prototype.setCurrentVisual=function(e){this._visuals[e]&&(this._curVisualName=e)},Hf.prototype.run=function(){var e=this;this._running||(this._running=!0,this._halting?this._halting=!1:(this._objectControls.enable(!0),this._interpolator.resume(),this._requestAnimationFrame(function(){return e._onTick()})))},Hf.prototype.halt=function(){this._running&&(this._discardComponentEdit(),this._discardFragmentEdit(),this._objectControls.enable(!1),this._interpolator.pause(),this._halting=!0)},Hf.prototype.enableHotKeys=function(e){this._hotKeysEnabled=e,this._objectControls.enableHotkeys(e)},Hf.prototype._onResize=function(){this._needRender=!0;var e=this._gfx;e.width=this._container.clientWidth,e.height=this._container.clientHeight,e.camera.aspect=e.width/e.height,e.camera.setMinimalFov(oe.now.camFov),e.camera.updateProjectionMatrix(),e.renderer.setSize(e.width,e.height),e.renderer2d.setSize(e.width,e.height),this.dispatchEvent({type:"resize"})},Hf.prototype._resizeOffscreenBuffers=function(e,t,n){var r=this._gfx,i="NONE"===(n=n||"NONE")||"ANAGLYPH"===n,n=i?1:.5;r.offscreenBuf.setSize(n*e,t),r.offscreenBuf2.setSize(n*e,t),r.offscreenBuf3.setSize(n*e,t),r.offscreenBuf4.setSize(n*e,t),r.offscreenBuf5&&r.offscreenBuf5.setSize(n*e,t),r.offscreenBuf6&&r.offscreenBuf6.setSize(n*e,t),r.offscreenBuf7&&r.offscreenBuf7.setSize(n*e,t),i&&(r.stereoBufL.setSize(e,t),r.stereoBufR.setSize(e,t))},Hf.prototype._onTick=function(){var e=this;if(this._halting)return this._running=!1,void(this._halting=!1);this._fps.update(),this._requestAnimationFrame(function(){return e._onTick()}),this._onUpdate(),this._needRender&&(this._onRender(),this._needRender=!oe.now.suspendRender||"WEBVR"===oe.now.stereo)},Hf.prototype._getBSphereRadius=function(){var t=0;return this._forEachVisual(function(e){t=Math.max(t,e.getBoundaries().boundingSphere.radius)}),t*this._objectControls.getScale()},Hf.prototype.getOBB=(af=new ae.Sphere,cf=new ae.Box3,lf=new ae.Box3,uf=new ae.Matrix4,hf=[new ae.Vector3,new ae.Vector3,new ae.Vector3,new ae.Vector3],function(t,e){lf.makeEmpty(),this._forEachVisual(function(e){af.copy(e.getBoundaries().boundingSphere),af.applyMatrix4(e.matrixWorld).applyMatrix4(t),af.getBoundingBox(cf),lf.union(cf)}),lf.getCenter(e.center),uf.copy(t).invert(),e.center.applyMatrix4(uf);var n=lf.min,r=lf.max;hf[0].set(n.x,n.y,n.z),hf[1].set(r.x,n.y,n.z),hf[2].set(n.x,r.y,n.z),hf[3].set(n.x,n.y,r.z);for(var i=0,o=hf.length;i<o;i++)hf[i].applyMatrix4(uf);e.halfSize.set(Math.abs(hf[0].x-hf[1].x),Math.abs(hf[0].y-hf[2].y),Math.abs(hf[0].z-hf[3].z)).multiplyScalar(.5)}),Hf.prototype._updateFog=function(){var e,t,n,r=this._gfx;oe.now.fog?(void 0!==r.scene.fog&&null!==r.scene.fog||(n=jf(),r.scene.fog=new ae.Fog(n),this._setUberMaterialValues({fog:oe.now.fog})),e=r.scene.fog,t=r.camera.position.z,n=this._getBSphereRadius(),e.near=t-n*oe.now.fogNearFactor,e.far=t+n*oe.now.fogFarFactor):r.scene.fog&&(r.scene.fog=void 0,this._setUberMaterialValues({fog:oe.now.fog}))},Hf.prototype._onUpdate=function(){void 0!==this.isScriptingCommandAvailable&&this.isScriptingCommandAvailable()&&!this._building&&this.callNextCmd(),this._objectControls.update(),this._forEachComplexVisual(function(e){e.getComplex().update()}),oe.now.autobuild&&!this._loading.length&&!this._building&&this._needRebuild()&&this.rebuild(),this._loading.length||this._building||this._needRebuild()||this._updateView(),this._updateFog(),this._gfx.renderer.xr.enabled&&this.webVR.updateMoleculeScale()},Hf.prototype._onRender=function(){var e=this._gfx;e.scene.updateMatrixWorld(),e.camera.updateMatrixWorld(),this._clipPlaneUpdateValue(this._getBSphereRadius()),this._fogFarUpdateValue(),e.renderer.setRenderTarget(null),e.renderer.clear(),this._renderFrame(oe.now.stereo)},Hf.prototype._renderFrame=(ff=new ss,df=new ae.Vector2,function(e){var t=this._gfx,n=t.renderer;n.getSize(df),"NONE"!==e&&(t.camera.focus=t.camera.position.z,t.stereoCam.aspect=1,"ANAGLYPH"===e?t.stereoCam.update(t.camera):t.stereoCam.updateHalfSized(t.camera,oe.now.camFov));var r=t.renderer.getPixelRatio();switch(this._resizeOffscreenBuffers(df.width*r,df.height*r,e),this._renderShadowMap(),e){case"WEBVR":case"NONE":this._renderScene(t.camera,!1);break;case"SIMPLE":case"DISTORTED":n.setScissorTest(!0),n.setScissor(0,0,df.width/2,df.height),n.setViewport(0,0,df.width/2,df.height),this._renderScene(this._gfx.stereoCam.cameraL,"DISTORTED"===e),n.setScissor(df.width/2,0,df.width/2,df.height),n.setViewport(df.width/2,0,df.width/2,df.height),this._renderScene(this._gfx.stereoCam.cameraR,"DISTORTED"===e),n.setScissorTest(!1);break;case"ANAGLYPH":this._renderScene(this._gfx.stereoCam.cameraL,!1,t.stereoBufL),this._renderScene(this._gfx.stereoCam.cameraR,!1,t.stereoBufR),n.setRenderTarget(null),ff.uniforms.srcL.value=t.stereoBufL.texture,ff.uniforms.srcR.value=t.stereoBufR.texture,t.renderer.renderScreenQuad(ff)}t.renderer2d.render(t.scene,t.camera),oe.now.axes&&t.axes&&!t.renderer.xr.enabled&&t.axes.render(n)}),Hf.prototype._onBgColorChanged=function(){var e=this._gfx,t=jf();e&&(e.scene.fog&&e.scene.fog.color.set(t),e.renderer.setClearColor(oe.now.bg.color,Number(!oe.now.bg.transparent))),this._needRender=!0},Hf.prototype._onFogColorChanged=function(){var e=this._gfx,t=jf();e&&e.scene.fog&&e.scene.fog.color.set(t),this._needRender=!0},Hf.prototype._setUberMaterialValues=function(t){this._gfx.root.traverse(function(e){(e instanceof ae.Mesh||e instanceof ae.LineSegments||e instanceof ae.Line)&&e.material instanceof Qi&&(e.material.setValues(t),e.material.needsUpdate=!0)})},Hf.prototype._enableMRT=function(e,t,n){var r=this._gfx,i=r.renderer.getContext(),o=i.getExtension("WEBGL_draw_buffers"),s=r.renderer.properties;e?(r.renderer.setRenderTarget(n),n=s.get(n.texture).__webglTexture,i.bindTexture(i.TEXTURE_2D,n),r.renderer.setRenderTarget(t),r=s.get(t).__webglFramebuffer,s=s.get(t.texture).__webglTexture,i.bindFramebuffer(i.FRAMEBUFFER,r),r.width=t.width,r.height=t.height,i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,s,0),i.framebufferTexture2D(i.FRAMEBUFFER,o.COLOR_ATTACHMENT1_WEBGL,i.TEXTURE_2D,n,0),o.drawBuffersWEBGL([i.COLOR_ATTACHMENT0,o.COLOR_ATTACHMENT1_WEBGL])):o.drawBuffersWEBGL([i.COLOR_ATTACHMENT0,null])},Hf.prototype._renderScene=function(e,t,n){t=t||!1,n=n||null;var r,i,o,s,a,c,l,u=this._gfx;u.renderer.setClearColor(oe.now.bg.color,Number(!oe.now.bg.transparent)),u.renderer.setRenderTarget(n),u.renderer.clear(),u.renderer.xr.enabled?u.renderer.render(u.scene,e):(u.renderer.setClearColor(0,0),u.renderer.setRenderTarget(u.offscreenBuf4),u.renderer.clearColor(),u.renderer.setClearColor(oe.now.bg.color,Number(!oe.now.bg.transparent)),u.renderer.setRenderTarget(u.offscreenBuf),u.renderer.clear(),l=null!==this._getComplexVisual(),r=this._getVolumeVisual(),(i=l&&oe.now.ao)&&this._enableMRT(!0,u.offscreenBuf,u.offscreenBuf4),"prepass"===oe.now.transparency?this._renderWithPrepassTransparency(e,u.offscreenBuf):"standard"===oe.now.transparency&&(u.renderer.setRenderTarget(u.offscreenBuf),u.renderer.render(u.scene,e)),i&&this._enableMRT(!1,null,null),o=l&&oe.now.outline.on,s=l&&oe.now.fxaa,a=null!==r&&null!=r.getMesh().material,c=i||o||a||s||t?u.offscreenBuf2:n,l=u.offscreenBuf,i?(this._performAO(l,u.offscreenBuf4,u.offscreenBuf.depthTexture,c,u.offscreenBuf3,u.offscreenBuf2),s||t||a||o||(l=c,c=n,u.renderer.setRenderTarget(c),u.renderer.renderScreenQuadFromTex(l.texture,1))):(u.renderer.setRenderTarget(c),u.renderer.renderScreenQuadFromTex(l.texture,1)),o&&(l=c,c=a||s||t?u.offscreenBuf3:n,null!=l&&this._renderOutline(e,u.offscreenBuf,l,c)),this._renderSelection(e,u.offscreenBuf,c),a&&(u.renderer.setRenderTarget(u.offscreenBuf),u.renderer.renderScreenQuadFromTex(c.texture,1),c=u.offscreenBuf,this._renderVolume(r,e,c,u.volBFTex,u.volFFTex,u.volWFFTex),s||t||(u.renderer.setRenderTarget(n),u.renderer.renderScreenQuadFromTex(c.texture,1))),l=c,s&&(c=t?u.offscreenBuf4:n,this._performFXAA(l,c),l=c),t&&(c=n,this._performDistortion(l,c,!0)))},Hf.prototype._performDistortion=(pf=new ae.Scene,mf=new ae.OrthographicCamera(-1,1,1,-1,-500,1e3),yf=new ae.RawShaderMaterial({uniforms:{srcTex:{type:"t",value:null},aberration:{type:"fv3",value:new ae.Vector3(1)}},vertexShader:En,fragmentShader:"precision highp float;\n\nvarying vec2 vUv;\nuniform sampler2D srcTex;\nuniform vec3 aberration;\n\nvoid main() {\n  vec2 uv = vUv * 2.0 - 1.0;\n  \n  gl_FragColor.r = texture2D(srcTex, 0.5 * (uv * aberration[0] + 1.0)).r;\n  gl_FragColor.g = texture2D(srcTex, 0.5 * (uv * aberration[1] + 1.0)).g;\n  gl_FragColor.b = texture2D(srcTex, 0.5 * (uv * aberration[2] + 1.0)).b;\n  gl_FragColor.a = 1.0;\n}",transparent:!1,depthTest:!1,depthWrite:!1}),ys=Fn.buildDistorionMesh(10,10,oe.now.debug.stereoBarrel),pf.add(new xo.Mesh(ys,yf)),function(e,t,n){this._gfx.renderer.setRenderTarget(t),this._gfx.renderer.clear(),n?(yf.uniforms.srcTex.value=e.texture,yf.uniforms.aberration.value.set(.995,1,1.01),this._gfx.renderer.render(pf,mf)):this._gfx.renderer.renderScreenQuadFromTexWithDistortion(e,oe.now.debug.stereoBarrel)}),Hf.prototype._renderOutline=(_f=new Vo({depth:!0}),function(e,t,n,r){var i=this._gfx;_f.uniforms.srcTex.value=n.texture,_f.uniforms.srcDepthTex.value=t.depthTexture,_f.uniforms.srcTexSize.value.set(t.width,t.height),_f.uniforms.color.value=new ae.Color(oe.now.outline.color),_f.uniforms.threshold.value=oe.now.outline.threshold,_f.uniforms.thickness.value=new ae.Vector2(oe.now.outline.thickness,oe.now.outline.thickness),i.renderer.setRenderTarget(r),i.renderer.renderScreenQuad(_f)}),Hf.prototype._renderShadowMap=(vf={minFilter:ae.NearestFilter,magFilter:ae.NearestFilter,format:ae.RGBAFormat},function(){if(oe.now.shadow.on){var e=this._gfx,t=e.renderer.getRenderTarget(),n=e.renderer.getActiveCubeFace(),r=e.renderer.getActiveMipmapLevel(),i=e.renderer.state;i.setBlending(ae.NoBlending),i.buffers.color.setClear(1,1,1,1),i.buffers.depth.setTest(!0),i.setScissorTest(!1);for(var o,s=0;s<e.scene.children.length;s++)"DirectionalLight"===e.scene.children[s].type&&(null==(o=e.scene.children[s]).shadow.map&&(o.shadow.map=new ae.WebGLRenderTarget(o.shadow.mapSize.width,o.shadow.mapSize.height,vf),o.shadow.camera.updateProjectionMatrix()),o.shadow.updateMatrices(o),e.renderer.setRenderTarget(o.shadow.map),e.renderer.clear(),e.renderer.render(e.scene,o.shadow.camera));e.renderer.setRenderTarget(t,n,r)}}),Hf.prototype._hasSelectionToRender=function(){for(var e=this._gfx.selectionPivot,t=0;t<e.children.length;t++)if(0<e.children[t].children.length)return!0;return!1},Hf.prototype._renderSelection=(gf=new Vo,function(e,t,n){var r=this._gfx;r.renderer.setClearColor("black",0),r.renderer.setRenderTarget(t),r.renderer.clear(!0,!1,!1),this._hasSelectionToRender()?(r.selectionRoot.matrix=r.root.matrix,r.selectionPivot.matrix=r.pivot.matrix,r.renderer.render(r.selectionScene,e)):r.renderer.renderDummyQuad(),r.renderer.setRenderTarget(n),r.renderer.renderScreenQuadFromTex(t.texture,.6),gf.uniforms.srcTex.value=t.texture,gf.uniforms.srcTexSize.value.set(t.width,t.height),r.renderer.renderScreenQuad(gf)}),Hf.prototype._checkVolumeRenderingSupport=function(e){if(!e)return!1;var t=this._gfx,n=t.renderer.getRenderTarget();t.renderer.setRenderTarget(e);var r=t.renderer.getContext(),e=r.checkFramebufferStatus(r.FRAMEBUFFER);return t.renderer.setRenderTarget(n),e===r.FRAMEBUFFER_COMPLETE||(this.logger.warn("Device doesn't support electron density rendering"),!1)},Hf.prototype._renderVolume=(bf=new Cc.BackFacePosMaterial,wf=new Cc.FrontFacePosMaterial,Sf=(new ae.Matrix4).makeTranslation(.5,.5,.5),Rf=new ae.Matrix4,function(e,t,n,r,i,o){var s=this._gfx;void 0===xf&&(xf=this._checkVolumeRenderingSupport(r)),xf&&((e=e.getMesh()).rebuild(s.camera),s.renderer.setClearColor("black",0),s.renderer.setRenderTarget(r),s.renderer.clear(),s.renderer.setRenderTarget(i),s.renderer.clear(),s.renderer.setRenderTarget(o),s.renderer.clear(),s.renderer.setRenderTarget(r),t.layers.set(Fn.LAYERS.VOLUME_BFPLANE),s.renderer.render(s.scene,t),t.layers.set(Fn.LAYERS.VOLUME),s.scene.overrideMaterial=bf,s.renderer.render(s.scene,t),s.renderer.setRenderTarget(i),t.layers.set(Fn.LAYERS.VOLUME),s.scene.overrideMaterial=wf,s.renderer.render(s.scene,t),s.scene.overrideMaterial=null,t.layers.set(Fn.LAYERS.DEFAULT),Rf.copy(e.matrixWorld).invert(),Qi.prototype.uberOptions.world2colorMatrix.multiplyMatrices(Sf,Rf),t.layers.set(Fn.LAYERS.COLOR_FROM_POSITION),s.renderer.setRenderTarget(o),s.renderer.render(s.scene,t),(e=e.material).uniforms._BFRight.value=r.texture,e.uniforms._FFRight.value=i.texture,e.uniforms._WFFRight.value=o.texture,t.layers.set(Fn.LAYERS.VOLUME),s.renderer.setRenderTarget(n),s.renderer.render(s.scene,t),t.layers.set(Fn.LAYERS.DEFAULT))}),Hf.prototype._renderWithPrepassTransparency=function(e,t){var n=this._gfx;n.renderer.setRenderTarget(t),e.layers.set(Fn.LAYERS.DEFAULT),n.renderer.render(n.scene,e),e.layers.set(Fn.LAYERS.PREPASS_TRANSPARENT),n.renderer.getContext().colorMask(!1,!1,!1,!1),n.renderer.render(n.scene,e),n.renderer.getContext().colorMask(!0,!0,!0,!0),e.layers.set(Fn.LAYERS.TRANSPARENT),n.renderer.render(n.scene,e),e.layers.set(Fn.LAYERS.DEFAULT)},Hf.prototype._performFXAA=(Cf=new Ho,function(e,t){var n;void 0!==e&&void 0!==t&&((n=this._gfx).renderer.setClearColor(oe.now.bg.color,Number(!oe.now.bg.transparent)),n.renderer.setRenderTarget(t),n.renderer.clear(),Cf.uniforms.srcTex.value=e.texture,Cf.uniforms.srcTexelSize.value.set(1/e.width,1/e.height),Cf.uniforms.bgColor.value.set(oe.now.bg.color),Cf.bgTransparent!==oe.now.bg.transparent&&(Cf.setValues({bgTransparent:oe.now.bg.transparent}),Cf.needsUpdate=!0),n.renderer.renderScreenQuad(Cf))}),Hf.prototype._performAO=(Af=new Zo,Ef=new Qo,kf=new is,Tf=new ae.Vector3,function(e,t,n,r,i,o){var s,a;e&&t&&n&&r&&i&&o&&(s=this._gfx,a=Math.tan(.5*ae.MathUtils.DEG2RAD*s.camera.fov),Af.uniforms.diffuseTexture.value=e.texture,Af.uniforms.depthTexture.value=n,Af.uniforms.normalTexture.value=t.texture,Af.uniforms.srcTexelSize.value.set(1/e.width,1/e.height),Af.uniforms.camNearFar.value.set(s.camera.near,s.camera.far),Af.uniforms.projMatrix.value=s.camera.projectionMatrix,Af.uniforms.aspectRatio.value=s.camera.aspect,Af.uniforms.tanHalfFOV.value=a,s.root.matrix.extractScale(Tf),Af.uniforms.kernelRadius.value=oe.now.debug.ssaoKernelRadius*Tf.x,Af.uniforms.depthThreshold.value=2*this._getBSphereRadius(),Af.uniforms.factor.value=oe.now.debug.ssaoFactor,s.renderer.setRenderTarget(o),s.renderer.renderScreenQuad(Af),Ef.uniforms.aoMap.value=o.texture,Ef.uniforms.srcTexelSize.value.set(1/o.width,1/o.height),Ef.uniforms.depthTexture.value=n,s.renderer.setRenderTarget(i),s.renderer.renderScreenQuad(Ef),kf.uniforms.aoMap.value=i.texture,kf.uniforms.diffuseTexture.value=e.texture,kf.uniforms.srcTexelSize.value.set(1/i.width,1/i.height),kf.uniforms.depthTexture.value=n,kf.uniforms.projMatrix.value=s.camera.projectionMatrix,kf.uniforms.aspectRatio.value=s.camera.aspect,kf.uniforms.tanHalfFOV.value=a,(a=s.scene.fog)&&(kf.uniforms.fogNearFar.value.set(a.near,a.far),kf.uniforms.fogColor.value.set(a.color.r,a.color.g,a.color.b,oe.now.fogAlpha)),kf.useFog===oe.now.fog&&kf.fogTransparent===oe.now.bg.transparent||(kf.setValues({useFog:oe.now.fog,fogTransparent:oe.now.bg.transparent}),kf.needsUpdate=!0),s.renderer.setRenderTarget(r),s.renderer.renderScreenQuad(kf))}),Hf.prototype.reset=function(){this._picker&&this._picker.reset(),this._lastPick=null,this._releaseAllVisuals(),this._setEditMode(Of),this._resetObjects(),this._gfx&&(Fn.clearTree(this._gfx.pivot),this._gfx.renderer2d.reset()),this.setNeedRender()},Hf.prototype._resetScene=function(){this._objectControls.reset(),this._objectControls.allowTranslation(!0),this._objectControls.allowAltObjFreeRotation(!0),this.resetReps(),this.resetPivot(),this.rebuildAll()},Hf.prototype.resetView=function(){this._picker&&this._picker.reset(),this._setEditMode(Of),this._resetScene(),this._forEachComplexVisual(function(e){e.updateSelectionMask({}),e.rebuildSelectionGeometry()})},Hf.prototype._export=function(e){var t=b.default.head(mh.exporters.find({format:e}));if(!t)return this.logger.error("Could not find suitable exporter for this source"),Promise.reject(new Error("Could not find suitable exporter for this source"));if(this.dispatchEvent({type:"exporting"}),this._visuals[this._curVisualName]instanceof fc){e=null;return t.SourceClass===fc?e=this._visuals[this._curVisualName]:t.SourceClass===gn&&(e=this._visuals[this._curVisualName]._complex),new t(e,{miewVersion:Hf.VERSION}).export().then(function(e){return e})}return this._visuals[this._curVisualName]instanceof Mc?Promise.reject(new Error("Sorry, exporter for volume data not implemented yet")):Promise.reject(new Error("Unexpected format of data"))};var qf,$f,Zf,Kf,Qf,Jf,ed=/^(?:(pdb|cif|mmtf|ccp4|dsn6):\s*)?(\d[a-z\d]{3})$/i,td=/^(?:pc|pubchem):\s*([a-z]+)$/i,nd=/^([a-z][a-z\d\-+.]*):/i;function rd(f,d,p){return new Promise(function(e){if(p.shouldCancel())throw new Error("Operation cancelled");p.notify({type:"fetching"}),f=function(e,t){if(!b.default.isString(e))return e;if(n=ed.exec(e)){var n=m(n,3),r=n[1],r=void 0===r?"pdb":r,i=n[2],r=r.toLowerCase(),i=i.toUpperCase();switch(r){case"pdb":e="https://files.rcsb.org/download/".concat(i,".pdb");break;case"cif":e="https://files.rcsb.org/download/".concat(i,".cif");break;case"mmtf":e="https://mmtf.rcsb.org/v1.0/full/".concat(i);break;case"ccp4":e="https://www.ebi.ac.uk/pdbe/coordinates/files/".concat(i.toLowerCase(),".ccp4");break;case"dsn6":e="https://edmaps.rcsb.org/maps/".concat(i.toLowerCase(),"_2fofc.dsn6");break;default:throw new Error("Unexpected data format shortcut")}return t.fileType=r,t.fileName="".concat(i,".").concat(r),t.sourceType="url",e}if(r=td.exec(e)){r=r[1].toLowerCase();return e="https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/".concat(r,"/JSON?record_type=3d"),t.fileType="pubchem",t.fileName="".concat(r,".json"),t.sourceType="url",e}return"url"!==t.sourceType&&void 0!==t.sourceType||(t.sourceType="url",nd.test(e)||(e=ce.resolveURL(e))),e}(f,d);var t=b.default.head(mh.loaders.find({type:d.sourceType,source:f}));if(!t)throw new Error(Ff);var n,r,i=d.fileName||t.extractName(f);i&&(n=ce.splitFileName(i),n=(r=m(n,2))[0],r=r[1],b.default.defaults(d,{name:n,fileExt:r,fileName:i})),function(e){var t=e.binary;if(void 0!==e.fileType){var n=b.default.head(mh.parsers.find({format:e.fileType}));if(!n)throw new Error("Could not find suitable parser for this format");t=n.binary||!1}void 0!==t||void 0===e.fileExt||(n=b.default.head(mh.parsers.find({ext:e.fileExt})))&&(t=n.binary||!1),void 0!==e.fileExt&&".man"===e.fileExt.toLowerCase()&&(e.binary=!0,e.animation=!0),void 0!==t&&void 0!==e.binary&&e.binary!==t&&e.context.logger.warn("Overriding incorrect binary mode"),e.binary=t||!1}(d);var o=b.default.get(d,"preset.expression");if(!b.default.isUndefined(o)&&(o=JSON.parse(o))&&o.settings)for(var s=["singleUnit"],a=0,c=s.length;a<c;++a){var l=s[a],u=b.default.get(o.settings,l);b.default.isUndefined(u)||oe.set(l,u)}var h=new t(f,d);h.context=d.context,p.addEventListener("cancel",function(){return h.abort()}),h.addEventListener("progress",function(e){e.lengthComputable&&0<e.total?Gf(h.logger,"Fetching",e.loaded/e.total):Gf(h.logger,"Fetching")}),e(h.load().then(function(e){return d.context.logger.info("Fetching finished"),p.notify({type:"fetchingDone",data:e}),e}).catch(function(e){throw d.context.logger.debug(e.message),e.stack&&d.context.logger.debug(e.stack),d.context.logger.error("Fetching failed"),p.notify({type:"fetchingDone",error:e}),e}))})}function id(e,t){return e.mask&1<<t}function od(e,t){return t.selector.includesAtom(e)}Hf.prototype.load=function(e,t){var n=this;t=b.default.merge({},t,{context:this}),this.settings.now.use.multiFile||(this._loading.length&&(this._loading.forEach(function(e){e.cancel()}),this._loading.length=0),t.animation||this.reset(!0)),this._interpolator.reset(),this.dispatchEvent({type:"loading",options:t,source:e});var r=new ne;this._loading.push(r),r.addEventListener("notification",function(e){n.dispatchEvent(e.slaveEvent)}),this._spinner.spin(this._container);function i(e){var t=n._loading.indexOf(r);return-1!==t&&n._loading.splice(t,1),n._spinner.stop(),n._refreshTitle(),r.notify({type:"loadingDone",anything:e}),e}return rd(e,t,r).then(function(e){return function(e,t,n){if(n.shouldCancel())return Promise.reject(new Error("Operation cancelled"));n.notify({type:"parsing"});var r=b.default.head(mh.parsers.find({format:t.fileType,ext:t.fileExt,data:e}));if(!r)return Promise.reject(new Error("Could not find suitable parser"));var i=new r(e,t);return i.context=t.context,n.addEventListener("cancel",function(){return i.abort()}),i.parse().then(function(e){return n.notify({type:"parsingDone",data:e}),e}).catch(function(e){throw t.error=e,t.context.logger.debug(e.message),e.stack&&t.context.logger.debug(e.stack),t.context.logger.error("Parsing failed"),n.notify({type:"parsingDone",error:e}),e})}(e,t,r)}).then(function(e){e=n._onLoad(e,t);return i(e)}).catch(function(e){throw n.logger.error("Could not load data"),n.logger.debug(e),i(e)})},Hf.prototype.unload=function(e){this._removeVisual(e||this.getCurrentVisual()),this.resetPivot(),oe.now.shadow.on&&this._updateShadowCamera()},Hf.prototype._startAnimation=function(e){this._stopAnimation();var t=this,n=this._getComplexVisual();if(null!==n){try{this._frameInfo=new Lh(n.getComplex(),e,{onLoadStatusChanged:function(){t.dispatchEvent({type:"mdPlayerStateChanged",state:{isPlaying:t._isAnimating,isLoading:!t._frameInfo||t._frameInfo.isLoading}})},onError:function(e){t._stopAnimation(),t.logger.error(e)}})}catch(e){return void this.logger.error("Animation file does not fit to current complex!")}this._continueAnimation()}else this.logger.error("Unable to start animation - no molecule is loaded.")},Hf.prototype._pauseAnimation=function(){null!==this._animInterval&&(this._isAnimating=!1,clearInterval(this._animInterval),this._animInterval=null,this._frameInfo&&this.dispatchEvent({type:"mdPlayerStateChanged",state:{isPlaying:this._isAnimating,isLoading:this._frameInfo.isLoading}}))},Hf.prototype._continueAnimation=function(){this._isAnimating=!0;var e=1e3/oe.now.maxfps,e=Number.isNaN(e)?0:e,t=this,n=t._gfx.pivot,r=this._getComplexVisual();r&&(r.resetSelectionMask(),r.rebuildSelectionGeometry(),this._msgAtomInfo.style.opacity=0),this._animInterval=setInterval(function(){if(t.dispatchEvent({type:"mdPlayerStateChanged",state:{isPlaying:t._isAnimating,isLoading:t._frameInfo.isLoading}}),t._frameInfo.frameIsReady){n.updateToFrame(t._frameInfo),t._updateObjsToFrame(t._frameInfo),t._refreshTitle(" Frame ".concat(t._frameInfo._currFrame," of ").concat(t._frameInfo._framesCount," time interval - ").concat(t._frameInfo._timeStep));try{t._frameInfo.nextFrame()}catch(e){return t.logger.error("Error during animation"),void t._stopAnimation()}t._needRender=!0}},e)},Hf.prototype._stopAnimation=function(){null!==this._animInterval&&(clearInterval(this._animInterval),this._frameInfo.disableEvents(),this._frameInfo=null,this._animInterval=null,this.dispatchEvent({type:"mdPlayerStateChanged",state:null}))},Hf.prototype._onLoad=function(e,t){var n,r=this._gfx,i=null;if(t.animation)return this._refreshTitle(),this._startAnimation(e),null;if(this._stopAnimation(),t&&t.keepRepsInfo||(this._opts.reps=null,this._opts._objects=null),"Complex"===e.id){var o=e;t.fileName?o.name=o.name||Uf(t.fileName).toUpperCase():t.amberFileName?o.name=o.name||Uf(t.amberFileName).toUpperCase():o.name="Dynamic ".concat(t.fileType," molecule"),i=this._addVisual(new fc(o.name,o)),this._curVisualName=i;var s=this.info();if(this.logger.info("Parsed ".concat(t.fileName," (").concat(s.atoms," atoms, ").concat(s.bonds," bonds, ").concat(s.residues," residues, ").concat(s.chains," chains).")),b.default.isNumber(this._opts.unit)&&o.setCurrentUnit(this._opts.unit),!t.preset)if(oe.now.autoPreset)switch(t.fileType){case"cml":this.resetReps("small");break;case"pdb":case"mmtf":case"cif":n=!1,o.forEachComponent(function(e){e.forEachResidue(function(e){e._isValid&&(n=!0)})}),n?this.resetReps("macro"):this.resetReps("small");break;default:this.resetReps("default")}else this.resetReps("default")}else"Volume"===e.id&&(this.resetEd(),i=this._onLoadEd(e));return r.camera.updateProjectionMatrix(),this._updateFog(),r.root.resetTransform(),this.resetPivot(),this._objectControls.setScale(oe.now.radiusToFit/this._getBSphereRadius()),this._resetObjects(),oe.now.autoResolution&&this._tweakResolution(),oe.now.shadow.on&&this._updateShadowCamera(),this._opts.view&&(this.view(this._opts.view),delete this._opts.view),this._refreshTitle(),i},Hf.prototype.resetEd=function(){this._edLoader&&(this._edLoader.abort(),this._edLoader=null),this._removeVisual(this._getVolumeVisual()),this._needRender=!0},Hf.prototype.loadEd=function(e){var n=this;this.resetEd();var t=b.default.head(mh.loaders.find({source:e}));if(!t)return this.logger.error(Ff),Promise.reject(new Error(Ff));e=this._edLoader=new t(e,{binary:!0});return e.context=this,e.load().then(function(e){var t=b.default.head(mh.parsers.find({format:"ccp4"}));if(!t)throw new Error("Could not find suitable parser for this source");e=new t(e);return e.context=n,e.parse().then(function(e){n._onLoadEd(e)})}).catch(function(e){n.logger.error("Could not load ED data"),n.logger.debug(e)})},Hf.prototype._onLoadEd=function(e){e.normalize();e=new Mc("volume",e);e.getMesh().layers.set(Fn.LAYERS.VOLUME);e=this._addVisual(e);return this._needRender=!0,e},Hf.prototype._needRebuild=function(){var t=!1;return this._forEachComplexVisual(function(e){t=t||e.needsRebuild()}),t},Hf.prototype._rebuildObjects=function(){for(var n,r=this,i=this._gfx,e=[],o=0;o<i.pivot.children.length;++o){var t=i.pivot.children[o];t instanceof Gn||e.push(t)}for(o=0;o<e.length;++o)e[o].parent.remove(e[o]);setTimeout(function(){var e=r._objects;for(o=0,n=e.length;o<n;++o){var t=e[o];t.needsRebuild&&t.build(),t.getGeometry()&&i.pivot.add(t.getGeometry())}},10)},Hf.prototype.changeUnit=function(e,t){var n=this._getComplexVisual(t);if(!n)throw new Error("There is no complex to change!");function r(){var e=n?n.getComplex().getCurrentUnit():0,t=0<e?"Bio molecule ".concat(e):"Asymmetric unit";return"Current unit: ".concat(e," (").concat(t,")")}return void 0===e||(b.default.isString(e)&&(e=Math.max(parseInt(e,10),0)),n.getComplex().setCurrentUnit(e)&&(this._resetScene(),this._updateInfoPanel())),r()},Hf.prototype.rebuild=function(){var e,t,n=this;this._building?this.logger.warn("Miew.rebuild(): already building!"):(this._building=!0,this.dispatchEvent({type:"rebuilding"}),this._rebuildObjects(),this._gfx.renderer2d.reset(),e=[],this._forEachComplexVisual(function(t){t.needsRebuild()&&e.push(t.rebuild().then(function(){return new Promise(function(e){t.rebuildSelectionGeometry(),e()})}))}),(t=this)._spinner.spin(this._container),Promise.all(e).then(function(){t._spinner.stop(),t._needRender=!0,t._refreshTitle(),n.dispatchEvent({type:"buildingDone"}),t._building=!1}))},Hf.prototype.rebuildAll=function(){this._forEachComplexVisual(function(e){e.setNeedsRebuild()})},Hf.prototype._refreshTitle=function(e){var t;e=void 0===e?"":e;var n=this._getComplexVisual();n?(t=n.getComplex().name,t+=(n=n.repGet(n.repCurrent()))?"  ".concat(n.mode.name," Mode"):""):t=0<Object.keys(this._visuals).length?"Unknown":"No Data",t+=e,this.dispatchEvent({type:"titleChanged",data:t})},Hf.prototype.setNeedRender=function(){this._needRender=!0},Hf.prototype._extractRepresentation=function(){var r=this,i=[];this._forEachComplexVisual(function(e){var t,n;0!==e.getSelectionCount()&&(t=e.buildSelectorFromMask(1<<e.getSelectionBit()),n=oe.now.presets.default,(n=e.repAdd({selector:t,mode:n[0].mode.id,colorer:n[0].colorer.id,material:n[0].material.id}))?(r.dispatchEvent({type:"repAdded",index:n.index,name:e.name}),e.repCurrent(n.index),i.push(e.name)):e.repCount()===fc.NUM_REPRESENTATION_BITS&&r.logger.warn("Number of representations is limited to ".concat(fc.NUM_REPRESENTATION_BITS)))}),0<i.length&&this.logger.report("New representation from selection for complexes: ".concat(i.join(", ")))},Hf.prototype._setReps=function(t){t=t||this._opts&&this._opts.reps||[],this._forEachComplexVisual(function(e){return e.resetReps(t)})},Hf.prototype.applyPreset=function(e){for(var t=oe.now.presets,n=[e||oe.defaults.preset,oe.defaults.preset,Object.keys(t)[0]],r=null,i=0;!r&&i<n.length;++i)oe.set("preset",n[i]),(r=t[oe.now.preset])||this.logger.warn('Unknown preset "'.concat(oe.now.preset,'"'));this._setReps(r)},Hf.prototype.resetReps=function(e){var t=this._opts&&this._opts.reps;t?this._setReps(t):this.applyPreset(e)},Hf.prototype.repCount=function(e){e=this._getComplexVisual(e);return e?e.repCount():0},Hf.prototype.repCurrent=function(e,t){t=this._getComplexVisual(t),t=t?t.repCurrent(e):-1;return e&&t!==e&&this.logger.warn("Representation ".concat(e," was not found. Current rep remains unchanged.")),t},Hf.prototype.rep=function(e,t){var n=this._getComplexVisual("");if(!n)return null;t=n.rep(e,t);return"created"===t.status?this.dispatchEvent({type:"repAdded",index:t.index,name:n.name}):"changed"===t.status&&this.dispatchEvent({type:"repChanged",index:t.index,name:n.name}),t.desc},Hf.prototype.repGet=function(e,t){t=this._getComplexVisual(t);return t?t.repGet(e):null},Hf.prototype.repAdd=function(e,t){var n=this._getComplexVisual(t);if(!n)return-1;e=n.repAdd(e);return e?(this.dispatchEvent({type:"repAdded",index:e.index,name:t}),e.index):-1},Hf.prototype.repRemove=function(e,t){var n=this._getComplexVisual(t);n&&(n.repRemove(e),this.dispatchEvent({type:"repRemoved",index:e,name:t}))},Hf.prototype.repHide=function(e,t,n){this._needRender=!0;n=this._getComplexVisual(n);return n?n.repHide(e,t):null},Hf.prototype._setEditMode=function(e){this._editMode=e;var t=this._msgMode;t&&(t.style.opacity=e===Of?0:1,e!==Of&&(t.getElementsByTagName("p")[0].innerHTML=e===Vf?"COMPONENT EDIT MODE":"FRAGMENT EDIT MODE")),this.dispatchEvent({type:"editModeChanged",data:e===Of})},Hf.prototype._enterComponentEditMode=function(){var t;this._editMode===Of&&(t=[],this._forEachComplexVisual(function(e){e=e.beginComponentEdit();e&&t.push(e)}),t!==[]&&(this._editors=t,this.logger.info("COMPONENT EDIT MODE -- ON"),this._setEditMode(Vf),this._objectControls.keysTranslateObj(!0)))},Hf.prototype._applyComponentEdit=function(){if(this._editMode===Vf){this._objectControls.stop(),this._objectControls.keysTranslateObj(!1);for(var e=0;e<this._editors.length;++e)this._editors[e].apply();this._editors=[],this.logger.info("COMPONENT EDIT MODE -- OFF (applied)"),this._setEditMode(Of),this.rebuildAll()}},Hf.prototype._discardComponentEdit=function(){if(this._editMode===Vf){this._objectControls.stop(),this._objectControls.keysTranslateObj(!1);for(var e=0;e<this._editors.length;++e)this._editors[e].discard();this._editors=[],this.logger.info("COMPONENT EDIT MODE -- OFF (discarded)"),this._setEditMode(Of),this._needRender=!0,this.rebuildAll()}},Hf.prototype._enterFragmentEditMode=function(){var t,e;this._editMode===Of&&(t=[],this._forEachComplexVisual(function(e){e instanceof fc&&0<e.getSelectionCount()&&t.push(e)}),1!==t.length||(e=t[0].beginFragmentEdit())&&(this._editors=[e],this.logger.info("FRAGMENT EDIT MODE -- ON (single bond)"),this._setEditMode(zf),this._objectControls.allowTranslation(!1),this._objectControls.allowAltObjFreeRotation(e.isFreeRotationAllowed()),this._needRender=!0))},Hf.prototype._applyFragmentEdit=function(){if(this._editMode===zf){this._objectControls.stop();for(var e=0;e<this._editors.length;++e)this._editors[e].apply();this._editors=[],this.logger.info("FRAGMENT EDIT MODE -- OFF (applied)"),this._setEditMode(Of),this._objectControls.allowTranslation(!0),this._objectControls.allowAltObjFreeRotation(!0),this.rebuildAll()}},Hf.prototype._discardFragmentEdit=function(){if(this._editMode===zf){this._objectControls.stop();for(var e=0;e<this._editors.length;++e)this._editors[e].discard();this._editors=[],this.logger.info("FRAGMENT EDIT MODE -- OFF (discarded)"),this._setEditMode(Of),this._objectControls.allowTranslation(!0),this._objectControls.allowAltObjFreeRotation(!0),this._needRender=!0}},Hf.prototype._onPick=function(t){var e;function n(e){e.updateSelectionMask(t.obj),e.rebuildSelectionGeometry()}oe.now.picking&&null===this._animInterval&&this._editMode!==zf&&(this._objectControls.isEditingAltObj()||(e=null,t.obj.atom?(e=t.obj.atom.residue.getChain().getComplex(),this._lastPick=t.obj.atom):t.obj.residue?(e=t.obj.residue.getChain().getComplex(),this._lastPick=t.obj.residue):t.obj.chain?(e=t.obj.chain.getComplex(),this._lastPick=t.obj.chain):t.obj.molecule?(e=t.obj.molecule.complex,this._lastPick=t.obj.molecule):this._lastPick=null,e?(e=this._getVisualForComplex(e))&&(n(e),this._needRender=!0):(this._forEachComplexVisual(n),this._needRender=!0),this._updateInfoPanel(),this.dispatchEvent(t)))},Hf.prototype._onKeyDown=function(e){if(this._running&&this._hotKeysEnabled)switch(e.keyCode){case"C".charCodeAt(0):oe.now.editing&&this._enterComponentEditMode();break;case"F".charCodeAt(0):oe.now.editing&&this._enterFragmentEditMode();break;case"A".charCodeAt(0):switch(this._editMode){case Vf:this._applyComponentEdit();break;case zf:this._applyFragmentEdit()}break;case"D".charCodeAt(0):switch(this._editMode){case Vf:this._discardComponentEdit();break;case zf:this._discardFragmentEdit()}break;case"S".charCodeAt(0):e.preventDefault(),e.stopPropagation(),oe.set("ao",!oe.now.ao),this._needRender=!0;break;case 107:e.preventDefault(),e.stopPropagation(),this._forEachComplexVisual(function(e){e.expandSelection(),e.rebuildSelectionGeometry()}),this._updateInfoPanel(),this._needRender=!0;break;case 109:e.preventDefault(),e.stopPropagation(),this._forEachComplexVisual(function(e){e.shrinkSelection(),e.rebuildSelectionGeometry()}),this._updateInfoPanel(),this._needRender=!0}},Hf.prototype._onKeyUp=function(e){this._running&&this._hotKeysEnabled&&e.keyCode==="X".charCodeAt(0)&&this._extractRepresentation()},Hf.prototype._updateInfoPanel=function(){var e,t,n,r,i,o,s,a=this._msgAtomInfo.getElementsByTagName("p")[0],c=0;for(this._forEachComplexVisual(function(e){c+=e.getSelectionCount()});a.firstChild;)a.removeChild(a.firstChild);0!==c?(n="".concat(String(c)," atom").concat(1!==c?"s":""," selected"),null!==this._lastPick&&(n+=", the last pick:"),i=r=s="",this._lastPick instanceof Nf?(t=(e=this._lastPick).residue,r=e.name,o=32!==e.location?String.fromCharCode(e.location):"",s="".concat(e.element.fullName," #").concat(e.serial).concat(o,":       ").concat(t._chain._name,".").concat(t._type._name).concat(t._sequence).concat(t._icode.trim(),"."),s+=r,i="Coord: (".concat(e.position.x.toFixed(2).toString(),",     ").concat(e.position.y.toFixed(2).toString(),",     ").concat(e.position.z.toFixed(2).toString(),")")):this._lastPick instanceof If?(t=this._lastPick,s="".concat(t._type._fullName,":       ").concat(t._chain._name,".").concat(t._type._name).concat(t._sequence).concat(t._icode.trim())):this._lastPick instanceof Lf?s="chain ".concat(this._lastPick._name):this._lastPick instanceof Df&&(s="molecule ".concat(this._lastPick._name)),a.appendChild(document.createTextNode(n)),""!==s&&(a.appendChild(document.createElement("br")),a.appendChild(document.createTextNode(s))),""!==i&&(a.appendChild(document.createElement("br")),a.appendChild(document.createTextNode(i))),this._msgAtomInfo.style.opacity=1):this._msgAtomInfo.style.opacity=0},Hf.prototype._getAltObj=function(){if(this._editors){for(var e=null,t=0;t<this._editors.length;++t){var n=this._editors[t].getAltObj();if(0<n.objects.length){if(e){e=null;break}e=n}}if(e)return e}return{objects:[],pivot:new ae.Vector3(0,0,0)}},Hf.prototype.resetPivot=(qf=new ae.Box3,$f=new ae.Vector3,function(){qf.makeEmpty(),this._forEachVisual(function(e){qf.union(e.getBoundaries().boundingBox)}),qf.getCenter($f),this._objectControls.setPivot($f.negate()),this.dispatchEvent({type:"transform"})}),Hf.prototype.setPivotResidue=(Zf=new ae.Vector3,function(e){var t=this._getVisualForComplex(e.getChain().getComplex());if(t){if(e._controlPoint)Zf.copy(e._controlPoint);else{for(var n=0,r=0,i=0,o=e._atoms.length,s=0;s<o;++s){var a=e._atoms[s].position;n+=a.x/o,r+=a.y/o,i+=a.z/o}Zf.set(n,r,i)}Zf.applyMatrix4(t.matrix).negate(),this._objectControls.setPivot(Zf),this.dispatchEvent({type:"transform"})}}),Hf.prototype.setPivotAtom=(Kf=new ae.Vector3,function(e){var t=this._getVisualForComplex(e.residue.getChain().getComplex());t&&(Kf.copy(e.position),Kf.applyMatrix4(t.matrix).negate(),this._objectControls.setPivot(Kf),this.dispatchEvent({type:"transform"}))}),Hf.prototype.getSelectionCenter=(Qf=new ae.Vector3(0,0,0),function(t,n,r){t.set(0,0,0);var i=0;return this._forEachComplexVisual(function(e){e.getSelectionCenter(Qf,n,r||e.getSelectionBit())&&(t.add(Qf),i++)}),0!==i&&(t.divideScalar(i),t.negate(),!0)}),Hf.prototype.setPivotSubset=(Jf=new ae.Vector3(0,0,0),function(e){var t=e?od:id;this.getSelectionCenter(Jf,t,e)?(this._objectControls.setPivot(Jf),this.dispatchEvent({type:"transform"})):this.logger.warn("selection is empty. Center operation not performed")}),Hf.prototype.screenshot=function(n,r){var e,t,i,o,s,a,c,l=this._gfx,u=l.renderer.domElement.width,h=l.renderer.domElement.height;function f(){var e,t=ce.getBrowser()===ce.browserType.SAFARI?(e=(t=document.createElement("canvas")).getContext("2d"),t.width=void 0===n?u:n,t.height=void 0===r?h:r,e.drawImage(l.renderer.domElement,0,0,t.width,t.height),t.toDataURL("image/png")):l.renderer.domElement.toDataURL("image/png");return t}return r=r||n,void 0===n&&void 0===r||n===u&&r===h?e=f():(t=l.camera.aspect,i=l.camera.fov,o=(c=l.camera.fov,Math.tan(ae.MathUtils.degToRad(.5*c)))*Math.min(l.width,l.height)/l.height,s=n/r,l.renderer.setPixelRatio(1),l.camera.aspect=s,l.camera.fov=(a=o/Math.min(s,1),2*ae.MathUtils.radToDeg(Math.atan(a))),l.camera.updateProjectionMatrix(),l.renderer.setDrawingBufferSize(n,r,1),this._renderFrame(oe.now.stereo),e=f(),l.renderer.setPixelRatio(window.devicePixelRatio),l.camera.aspect=t,l.camera.fov=i,l.camera.updateProjectionMatrix(),l.renderer.setDrawingBufferSize(l.width,l.height,window.devicePixelRatio),this._needRender=!0),e},Hf.prototype.screenshotSave=function(e,t,n){n=this.screenshot(t,n);ce.shotDownload(n,e)},Hf.prototype.save=function(n){var r=this;this._export(n.fileType).then(function(e){var t=r._visuals[r._curVisualName]._complex.name;ce.download(e,t,n.fileType),r._refreshTitle(),r.dispatchEvent({type:"exportingDone"})}).catch(function(e){r.logger.error("Could not export data"),r.logger.debug(e),r._refreshTitle(),r.dispatchEvent({type:"exportingDone",error:e})})},Hf.prototype._tweakResolution=function(){var e=[["poor",100],["low",500],["medium",1e3],["high",5e3],["ultra",Number.MAX_VALUE]],t=0;if(this._forEachComplexVisual(function(e){t+=e.getComplex().getAtomCount()}),0<t)for(var n=1e6*this._gfxScore/t,r=0;r<e.length;++r)if(n<e[r][1]){this._autoChangeResolution(e[r][0]);break}},Hf.prototype._autoChangeResolution=function(e){e!==oe.now.resolution&&this.logger.report('Your rendering resolution was changed to "'.concat(e,'" for best performance.')),oe.now.resolution=e},Hf.prototype.saveSettings=function(){this._cookies.setCookie(this._opts.settingsCookie,JSON.stringify(this.settings.getDiffs(!0)))},Hf.prototype.restoreSettings=function(){try{var e=this._cookies.getCookie(this._opts.settingsCookie),e=e?JSON.parse(e):{};this.settings.applyDiffs(e,!0)}catch(e){this.logger.error("Cookies parse error: ".concat(e.message))}},Hf.prototype.resetSettings=function(){this.settings.reset()},Hf.prototype.setOptions=function(e){"string"==typeof e&&(e=Hf.options.fromAttr(e)),e.reps&&(this._opts.reps=null),b.default.merge(this._opts,e),e.settings&&this.set(e.settings),this._opts._objects=e._objects,this._resetObjects(),e.load&&this.load(e.load,{fileType:e.type}),e.preset&&(oe.now.preset=e.preset),e.reps&&this.resetReps(e.preset),this._opts.view&&(this.view(this._opts.view),delete this._opts.view);var t=this._getComplexVisual();t&&(t.getComplex().resetCurrentUnit(),b.default.isNumber(e.unit)&&t.getComplex().setCurrentUnit(e.unit),this.resetView(),this.rebuildAll())},Hf.prototype.info=function(e){var t=this._getComplexVisual(e);if(!t)return{};e=t.getComplex(),t=e.metadata;return{id:t.id||e.name||"UNKNOWN",title:t.title&&t.title.join(" ")||"UNKNOWN DATA",atoms:e.getAtomCount(),bonds:e.getBondCount(),residues:e.getResidueCount(),chains:e.getChainCount()}},Hf.prototype.addObject=function(e,t){var n=null;if(e.type===Vh.prototype.type&&(n=Vh),null===n)throw new Error("Unknown scene object type - ".concat(e.type));try{var r=new n(e.params,e.opts);this._addSceneObject(r)}catch(e){if(t)throw e;this.logger.debug("Error during scene object creation: ".concat(e.message))}this._needRender=!0},Hf.prototype._addSceneObject=function(e){var t=this._getComplexVisual();e.build&&t&&(e.build(t.getComplex()),this._gfx.pivot.add(e.getGeometry()));t=this._objects;t[t.length]=e},Hf.prototype._updateObjsToFrame=function(e){for(var t=this._objects,n=0,r=t.length;n<r;++n)t[n].updateToFrame&&t[n].updateToFrame(e)},Hf.prototype._resetObjects=function(){var e=this._opts._objects;if(this._objects=[],e)for(var t=0,n=e.length;t<n;++t)this.addObject(e[t],!1)},Hf.prototype.removeObject=function(e){var t=this._objects[e];if(!t)throw new Error("Scene object with index ".concat(e," does not exist"));t.destroy(),this._objects.splice(e,1),this._needRender=!0},Hf.prototype.getURL=function(e){return Ee.toURL(this.getState(b.default.defaults(e,{compact:!0,settings:!1,view:!1})))},Hf.prototype.getScript=function(e){return Ee.toScript(this.getState(b.default.defaults(e,{compact:!0,settings:!0,view:!0})))},Hf.prototype._compareReps=function(e,t){var n={},r=0;e&&(r=e.repCount());var i=oe.defaults.presets[oe.now.preset],o=t;void 0===i||i.length>r?(o=!1,n.preset="empty"):oe.now.preset!==oe.defaults.preset&&(n.preset=oe.now.preset);for(var s=[],a=!0,c=0,l=r;c<l;++c)s[c]=e.repGet(c).compare(o?i[c]:null),b.default.isEmpty(s[c])||(a=!1);return a||(n.reps=s),n},Hf.prototype.getState=function(e){var t={};e=b.default.defaults(e,{compact:!0,settings:!1,view:!1});var n,r,i,o=this._getComplexVisual();null!==o&&((n=(i=o.getComplex()).metadata).id&&(r=n.format?"".concat(n.format,":"):"",t.load=r+n.id),1!==(i=i.getCurrentUnit())&&(t.unit=i));o=this._compareReps(o,e.compact);o.preset&&(t.preset=o.preset),o.reps&&(t.reps=o.reps);for(var s=this._objects,a=[],c=0,l=s.length;c<l;++c)a[c]=s[c].identify();return 0<s.length&&(t._objects=a),e.view&&(t.view=this.view()),e.settings&&(e=this.settings.getDiffs(!1),b.default.isEmpty(e)||(t.settings=e)),t},Hf.prototype.get=function(e,t){return oe.get(e,t)},Hf.prototype._clipPlaneUpdateValue=function(e){var e=Math.max(this._gfx.camera.position.z-e*oe.now.draft.clipPlaneFactor,oe.now.camNear),t={clipPlaneValue:e};this._forEachComplexVisual(function(e){e.setUberOptions(t)});for(var n=0,r=this._objects.length;n<r;++n){var i=this._objects[n];i._line&&i._line.material.setUberOptions(t)}null!==this._picker&&(this._picker.clipPlaneValue=e)},Hf.prototype._fogFarUpdateValue=function(){null!==this._picker&&(this._gfx.scene.fog?this._picker.fogFarValue=this._gfx.scene.fog.far:this._picker.fogFarValue=void 0)},Hf.prototype._updateShadowmapMeshes=function(o){this._forEachComplexVisual(function(e){for(var t=e._reprList,n=0,r=t.length;n<r;++n){var i=t[n];o(i.geo,i.material)}})},Hf.prototype._updateMaterials=function(t){var n=1<arguments.length&&void 0!==arguments[1]&&arguments[1],r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:void 0;this._forEachComplexVisual(function(e){return e.setMaterialValues(t,n,r)});for(var e=0,i=this._objects.length;e<i;++e){var o=this._objects[e];o._line&&(o._line.material.setValues(t),o._line.material.needsUpdate=!0)}},Hf.prototype._fogAlphaChanged=function(){this._forEachComplexVisual(function(e){e.setUberOptions({fogAlpha:oe.now.fogAlpha})})},Hf.prototype._embedWebXR=function(){var e=this;if("WEBVR"!==oe.now.stereo)return this.webVR&&this.webVR.disable(),void(this.webVR=null);this.webVR||(this.webVR=new Pf(function(){e._requestAnimationFrame(function(){return e._onTick()}),e._needRender=!0,e._onResize()})),this.webVR.enable(this._gfx)},Hf.prototype._initOnSettingsChanged=function(){function e(e,t){(e=b.default.isArray(e)?e:[e]).forEach(function(e){n.settings.addEventListener("change:".concat(e),t)})}var n=this;e("modes.VD.frame",function(){var e=n._getVolumeVisual();null!==e&&(e.showFrame(oe.now.modes.VD.frame),n._needRender=!0)}),e("modes.VD.isoMode",function(){var e=n._getVolumeVisual();null!==e&&(e.getMesh().material.updateDefines(),n._needRender=!0)}),e("bg.color",function(){n._onBgColorChanged()}),e("ao",function(){var e;oe.now.ao&&!Xf(n._gfx.renderer.getContext())?(n.logger.warn("Your device or browser does not support ao"),oe.set("ao",!1)):(e={normalsToGBuffer:oe.now.ao},n._setUberMaterialValues(e))}),e("zSprites",function(){oe.now.zSprites&&!Yf(n._gfx.renderer.getContext())&&(n.logger.warn("Your device or browser does not support zSprites"),oe.set("zSprites",!1)),n.rebuildAll()}),e("fogColor",function(){n._onFogColorChanged()}),e("fogColorEnable",function(){n._onFogColorChanged()}),e("bg.transparent",function(e){var t=n._gfx;t&&t.renderer.setClearColor(oe.now.bg.color,Number(!oe.now.bg.transparent)),n._updateMaterials({fogTransparent:e.value}),n.rebuildAll()}),e("draft.clipPlane",function(e){n._updateMaterials({clipPlane:e.value}),n.rebuildAll()}),e("shadow.on",function(e){var t={shadowmap:e.value,shadowmapType:oe.now.shadow.type},e=n._gfx;e&&(e.renderer.shadowMap.enabled=Boolean(t.shadowmap)),n._updateMaterials(t,!0),t.shadowmap?(n._updateShadowCamera(),n._updateShadowmapMeshes(rc.createShadowmapMaterial)):n._updateShadowmapMeshes(rc.removeShadowmapMaterial),n._needRender=!0}),e("shadow.type",function(e){oe.now.shadow.on&&(n._updateMaterials({shadowmapType:e.value},!0),n._needRender=!0)}),e("shadow.radius",function(e){for(var t=0;t<n._gfx.scene.children.length;t++)void 0!==n._gfx.scene.children[t].shadow&&(n._gfx.scene.children[t].shadow.radius=e.value,n._needRender=!0)}),e("fps",function(){n._fps.show(oe.now.fps)}),e(["fog","fogNearFactor","fogFarFactor"],function(){n._updateFog(),n._needRender=!0}),e("fogAlpha",function(){var e=oe.now.fogAlpha;(e<0||1<e)&&n.logger.warn("fogAlpha must belong range [0,1]"),n._fogAlphaChanged(),n._needRender=!0}),e("autoResolution",function(e){e.value&&!n._gfxScore&&n.logger.warn("Benchmarks are missed, autoresolution will not work! Autoresolution should be set during miew startup.")}),e("stereo",function(){n._embedWebXR("WEBVR"===oe.now.stereo),n._needRender=!0}),e(["transparency","palette"],function(){n.rebuildAll()}),e("resolution",function(){n.rebuildAll();var e=n._getVolumeVisual();e&&(e.getMesh().material.updateDefines(),n._needRender=!0)}),e(["axes","fxaa","ao","outline.on","outline.color","outline.threshold","outline.thickness"],function(){n._needRender=!0})},Hf.prototype.set=function(e,t){oe.set(e,t)},Hf.prototype.select=function(e,t){var n,r=this._getComplexVisual();r&&(n=e,b.default.isString(e)&&(n=Mf.parse(e).selector),r.select(n,t),this._lastPick=null,this._updateInfoPanel(),this._needRender=!0)};var sd,ad;function cd(){this.yy={}}Hf.prototype.view=function(r){var e,t,n,i=this,o=this._gfx.pivot,s=[],a="ZXY";return void 0===r?(e=o.position,t=i._objectControls.getScale()/oe.now.radiusToFit,(n=new ae.Euler).setFromQuaternion(i._objectControls.getOrientation(),a),s=[e.x,e.y,e.z,t,n.x,n.y,n.z],"1"+ce.arrayToBase64(s,Float32Array)):(function(){40===r.length&&(r="0".concat(r));var e=r[0];if(s=ce.arrayFromBase64(r.substr(1),Float32Array),"1"!==e){if("0"!==e)return i.logger.warn("Encoded view version mismatch, stored as ".concat(e," vs ").concat("1"," expected"));s[3]/=8}var t=i._interpolator,n=t.createView();n.position.copy(o.position),n.scale=i._objectControls.getScale(),n.orientation.copy(i._objectControls.getOrientation()),(e=t.createView()).position.set(s[0],s[1],s[2]),i._getComplexVisual()&&e.position.sub(i._getComplexVisual().position),e.scale=s[3],e.orientation.setFromEuler(new ae.Euler(s[4],s[5],s[6],a)),t.setup(n,e)}(),r)},Hf.prototype._updateView=function(){var e=this._gfx.pivot,t=this._interpolator;t.wasStarted()||t.start(),!t.isMoving()||(t=t.getCurrentView()).success&&(t=t.view,e.position.copy(t.position),this._objectControls.setScale(t.scale*oe.now.radiusToFit),this._objectControls.setOrientation(t.orientation),this.dispatchEvent({type:"transform"}),this._needRender=!0)},Hf.prototype.translate=function(e,t,n){this._objectControls.translatePivot(e,t,n),this.dispatchEvent({type:"transform"}),this._needRender=!0},Hf.prototype.rotate=function(e,t,n){this._objectControls.rotate((new ae.Quaternion).setFromEuler(new ae.Euler(e,t,n,"XYZ"))),this.dispatchEvent({type:"transform"}),this._needRender=!0},Hf.prototype.scale=function(e){if(e<=0)throw new RangeError("Scale should be greater than zero");this._objectControls.scale(e),this.dispatchEvent({type:"transform"}),this._needRender=!0},Hf.prototype.center=function(e){if(void 0===e)return this.setPivotSubset(),void(this._needRender=!0);if(void 0!==e.obj&&("atom"in e.obj||"residue"in e.obj))return"atom"in e.obj?this.setPivotAtom(e.obj.atom):this.setPivotResidue(e.obj.residue),void(this._needRender=!0);if(void 0===e.obj&&""!==e){e=Mf.parse(e);if(void 0===e.error)return this.setPivotSubset(e),void(this._needRender=!0)}this.resetPivot(),this._needRender=!0},Hf.prototype.within=function(e,t){var n=this._getComplexVisual();if(!n)return Mf.None();e instanceof String&&(e=Mf.parse(e));t=n.within(e,t);return t&&(n.rebuildSelectionGeometry(),this._needRender=!0),t},Hf.prototype.projected=function(e,t){t=this._getComplexVisual(t);if(!t)return!1;e=t.getComplex().getAtomByFullname(e);if(null===e)return!1;e=e.position.clone();return this._gfx.pivot.updateMatrixWorldRecursive(),this._gfx.camera.updateMatrixWorldRecursive(),this._gfx.pivot.localToWorld(e),e.project(this._gfx.camera),{x:.5*(e.x+1)*this._gfx.width,y:.5*(1-e.y)*this._gfx.height}},Hf.prototype.dssp=function(e){e=this._getComplexVisual(e);e&&(e.getComplex().dssp(),e._reprList.forEach(function(e){"CA"!==e.mode.id&&"SS"!==e.colorer.id||(e.needsRebuild=!0)}))},Hf.prototype.exportCML=function(){var e=this;var t,n,r,i,o,s,a,c,l,u,h=e._getComplexVisual(),h=h?h.getComplex():null;return h&&h.originalCML?(t=h,o=e._gfx.root,n=o.matrixWorld,r=new ae.Vector3,i=new ae.Vector3,o=new ae.Vector3,n.extractBasis(r,i,o),r.normalize(),i.normalize(),o.normalize(),(n=new ae.Matrix4).identity(),n.makeBasis(r,i,o),s=n,a=new ae.Vector4(0,0,0,0),c=new ae.Vector4(0,0,0,0),u=l=null,t.forEachAtom(function(e){e.xmlNodeRef&&e.xmlNodeRef.xmlNode&&(l=e.xmlNodeRef.xmlNode,u=e.position,a.set(u.x,u.y,u.z,1),a.applyMatrix4(s),l.setAttribute("x3",a.x.toString()),l.setAttribute("y3",a.y.toString()),l.setAttribute("z3",a.z.toString()),l.removeAttribute("x2"),l.removeAttribute("y2"))}),t.forEachSGroup(function(e){e.xmlNodeRef&&e.xmlNodeRef.xmlNode&&(l=e.xmlNodeRef.xmlNode,u=e.getPosition(),a.set(u.x,u.y,u.z,1),null===(e=e.getCentralPoint())?a.applyMatrix4(s):(c.set(e.x,e.y,e.z,0),a.add(c),a.applyMatrix4(s),c.set(e.x,e.y,e.z,1),c.applyMatrix4(s),a.sub(c)),l.setAttribute("x",a.x.toString()),l.setAttribute("y",a.y.toString()),l.setAttribute("z",a.z.toString()))}),(new XMLSerializer).serializeToString(h.originalCML)):null},Hf.prototype.motm=function(){oe.set({fogColorEnable:!0,fogColor:0,outline:{on:!0,threshold:.01},bg:{color:16777215}}),this._forEachComplexVisual(function(e){for(var t=[],n=e.getComplex(),r=Ra.get(oe.now.palette),i=0;i<n.getChainCount();i++){var o=n._chains[i]._name,s=r.getChainColor(o);t[i]={selector:"chain ".concat(o),mode:"VW",colorer:["CB",{color:s,factor:.9}],material:"FL"}}e.resetReps(t)})},Hf.prototype.VERSION="0.9.0+20230822.103925.6b542ed",b.default.assign(Hf,{VERSION:Hf.prototype.VERSION,registeredPlugins:[],chem:wn,io:mh,modes:ua,colorers:qa,materials:Ja,palettes:Ra,options:Ee,settings:oe,utils:ce,gfx:{Representation:oc},thirdParty:{lodash:b.default,three:r}});var ld={parser:(vs=[5,6,7,9,13,14,15,17,18,19,20,23,25,26,27,30,33,34,35,37,38,41,43,45,46,49,52,54,55,56,58,59,62,64,65,66,70,71,72,74,77,78,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,101],Es=[5,6,7,9,13,15,17,18,19,20,23,25,26,27,30,33,34,37,38,41,43,45,46,49,52,54,55,56,58,59,62,64,65,66,70,72,82,83,84,85,86,87,88,89,90,91,92,93,94,95],Bs=[5,70,72],Gs=[5,74],Hs=[71,101],Ho={trace:function(){},yy:{},symbols_:{error:2,Program:3,Command:4,EOF:5,RESET:6,BUILD:7,ALL:8,HELP:9,Path:10,MOTM:11,OneArgCommand:12,GET:13,STRING:14,SET:15,Value:16,SET_SAVE:17,SET_RESTORE:18,SET_RESET:19,PRESET:20,AddRepresentation:21,EditRepresentation:22,REMOVE:23,RepresentationReference:24,HIDE:25,SHOW:26,LIST:27,EXPAND_KEY:28,SELECTOR_KEY:29,SELECT:30,AS:31,WordAll:32,SELECTOR:33,WITHIN:34,NUMBER:35,OF:36,MATERIAL:37,IDENTIFIER:38,ModeCMD:39,ColorCMD:40,VIEW:41,BASE_64:42,UNIT:43,DSSP:44,SCALE:45,ROTATE:46,AxesList:47,TRANSLATE:48,CENTER:49,GetURLBranch:50,Screenshot:51,LINE:52,ArgList:53,LISTOBJ:54,REMOVEOBJ:55,URL:56,VIEW_KEY:57,SCREENSHOT:58,LOAD:59,Url:60,FILE_KEY:61,ADD:62,Description:63,REP:64,MODE:65,COLOR:66,Descriptor:67,RepresentationOwnProperty:68,RepresentationOwnPropertyOpts:69,DESC_KEY:70,"=":71,DESC_KEY_OPTS:72,AxesArg:73,DESC_KEY_AXES:74,Arg:75,PathWoDescKey:76,HEX:77,BOOL:78,Word:79,CommandSetWoDESC_KEY:80,DescKeys:81,CLEAR:82,FILE_LIST:83,FILE_REGISTER:84,FILE_DELETE:85,PRESET_ADD:86,PRESET_DELETE:87,PRESET_UPDATE:88,PRESET_RENAME:89,PRESET_OPEN:90,CREATE_SCENARIO:91,RESET_SCENARIO:92,DELETE_SCENARIO:93,ADD_SCENARIO_ITEM:94,LIST_SCENARIO:95,PDB_KEY:96,DELAY_KEY:97,PRST_KEY:98,DESCRIPTION_KEY:99,CommandSet:100,".":101,PresetPath:102,"/":103,HexOrNumber:104,$accept:0,$end:1},terminals_:{2:"error",5:"EOF",6:"RESET",7:"BUILD",8:"ALL",9:"HELP",11:"MOTM",13:"GET",14:"STRING",15:"SET",17:"SET_SAVE",18:"SET_RESTORE",19:"SET_RESET",20:"PRESET",23:"REMOVE",25:"HIDE",26:"SHOW",27:"LIST",28:"EXPAND_KEY",29:"SELECTOR_KEY",30:"SELECT",31:"AS",33:"SELECTOR",34:"WITHIN",35:"NUMBER",36:"OF",37:"MATERIAL",38:"IDENTIFIER",41:"VIEW",42:"BASE_64",43:"UNIT",44:"DSSP",45:"SCALE",46:"ROTATE",48:"TRANSLATE",49:"CENTER",52:"LINE",54:"LISTOBJ",55:"REMOVEOBJ",56:"URL",57:"VIEW_KEY",58:"SCREENSHOT",59:"LOAD",61:"FILE_KEY",62:"ADD",64:"REP",65:"MODE",66:"COLOR",70:"DESC_KEY",71:"=",72:"DESC_KEY_OPTS",74:"DESC_KEY_AXES",77:"HEX",78:"BOOL",82:"CLEAR",83:"FILE_LIST",84:"FILE_REGISTER",85:"FILE_DELETE",86:"PRESET_ADD",87:"PRESET_DELETE",88:"PRESET_UPDATE",89:"PRESET_RENAME",90:"PRESET_OPEN",91:"CREATE_SCENARIO",92:"RESET_SCENARIO",93:"DELETE_SCENARIO",94:"ADD_SCENARIO_ITEM",95:"LIST_SCENARIO",96:"PDB_KEY",97:"DELAY_KEY",98:"PRST_KEY",99:"DESCRIPTION_KEY",101:".",103:"/"},productions_:[0,[3,2],[3,1],[4,1],[4,1],[4,2],[4,1],[4,2],[4,1],[4,1],[4,2],[4,2],[4,3],[4,3],[4,1],[4,1],[4,1],[4,1],[4,2],[4,1],[4,1],[4,2],[4,2],[4,2],[4,2],[4,1],[4,2],[4,2],[4,2],[4,4],[4,2],[4,6],[4,2],[4,1],[4,1],[4,1],[4,2],[4,2],[4,1],[4,2],[4,1],[4,2],[4,2],[4,2],[4,1],[4,2],[4,1],[4,1],[4,3],[4,3],[4,4],[4,4],[4,1],[4,2],[50,1],[50,2],[50,2],[50,3],[50,3],[51,1],[51,2],[51,3],[12,2],[12,2],[12,2],[21,1],[21,2],[21,2],[21,3],[22,2],[22,3],[39,2],[39,3],[40,2],[40,3],[24,1],[24,1],[63,1],[63,2],[63,3],[63,4],[67,1],[67,1],[67,2],[68,3],[69,3],[47,1],[47,2],[73,2],[53,1],[53,2],[75,3],[16,1],[16,1],[16,1],[16,1],[16,1],[79,1],[79,1],[32,1],[32,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[81,1],[81,1],[81,1],[81,1],[81,1],[81,1],[81,1],[100,1],[100,1],[76,1],[76,3],[76,3],[10,1],[10,1],[10,3],[10,3],[10,3],[60,1],[102,1],[102,3],[104,1],[104,1]],performAction:function(e,t,n,r,i,o){var s=o.length-1;switch(i){case 1:return o[s-1];case 3:this.$=r.miew.reset(!1),r.ClearContext(),r.miew.resetReps("empty");break;case 4:this.$=r.miew.rebuild();break;case 5:this.$=r.miew.rebuildAll(),r.miew.rebuild();break;case 6:this.$=r.echo(r.utils.help().toString());break;case 7:this.$=r.echo(r.utils.help(o[s]).toString());break;case 8:this.$=r.miew.motm();break;case 10:case 11:this.$=r.utils.propagateProp(o[s]),r.echo(r.miew.get(o[s]).toString());break;case 12:case 13:this.$=r.miew.set(o[s-1],r.utils.propagateProp(o[s-1],o[s]));break;case 14:this.$=r.miew.saveSettings();break;case 15:this.$=r.miew.restoreSettings();break;case 16:this.$=r.miew.resetSettings();break;case 17:this.$=r.miew.resetReps();break;case 18:this.$=r.miew.applyPreset(o[s]);break;case 21:this.$=r.miew.repRemove(o[s]),r.representations.remove(o[s]);break;case 22:this.$=r.miew.repHide(o[s]);break;case 23:this.$=r.miew.repHide(o[s],!1);break;case 24:this.$=r.echo(r.utils.listRep(r.miew,r.representations,o[s],"-e"));break;case 25:this.$=r.echo(r.utils.list(r.miew,r.representations));break;case 26:this.$=r.echo(r.utils.list(r.miew,r.representations,o[s]));break;case 27:this.$=r.echo(r.utils.listSelector(r.miew,r.Context));break;case 28:this.$=r.miew.select(r.utils.checkArg(o[s-1].toLowerCase(),o[s],!0));break;case 29:this.$=r.Context[o[s].toLowerCase()]=r.utils.checkArg(o[s-3].toLowerCase(),o[s-2],!0),r.miew.select(r.Context[o[s].toLowerCase()]);break;case 30:this.$=r.miew.rep(r.miew.repCurrent(),{selector:r.utils.checkArg(o[s-1].toLowerCase(),o[s])});break;case 31:this.$=r.Context[o[s].toLowerCase()]=r.miew.within(r.utils.checkArg("select",o[s-2],!0),Number(o[s-4]));break;case 32:this.$=r.miew.rep(r.miew.repCurrent(),{material:r.utils.checkArg(o[s-1].toLowerCase(),o[s].toUpperCase())});break;case 35:this.$=r.echo(r.miew.view());break;case 36:case 37:this.$=r.miew.view(o[s]);break;case 38:this.$=r.echo(r.miew.changeUnit());break;case 39:this.$=r.echo(r.miew.changeUnit(o[s]));break;case 40:this.$=r.miew.dssp();break;case 41:this.$=r.miew.scale(o[s]);break;case 42:for(var a=0,c=o[s].length;a<c;a++)r.miew.rotate(o[s][a].x*Math.PI/180,o[s][a].y*Math.PI/180,o[s][a].z*Math.PI/180);break;case 43:for(a=0,c=o[s].length;a<c;a++)r.miew.translate(o[s][a].x||0,o[s][a].y||0,o[s][a].z||0);break;case 44:this.$=r.miew.center();break;case 45:this.$=r.miew.center(o[s]);break;case 48:case 49:this.$=r.miew.addObject({type:"line",params:[o[s-1],o[s]]},!0);break;case 50:case 51:this.$=r.miew.addObject({type:"line",params:[o[s-2],o[s-1]],opts:o[s].toJSO(r.utils,"objects","line")},!0);break;case 52:this.$=r.echo(r.utils.listObjs(r.miew));break;case 53:this.$=r.miew.removeObject(o[s]);break;case 54:this.$=r.echo(r.miew.getURL({view:!1,settings:!1}));break;case 55:this.$=r.echo(r.miew.getURL({view:!1,settings:!0}));break;case 56:this.$=r.echo(r.miew.getURL({view:!0,settings:!1}));break;case 57:case 58:this.$=r.echo(r.miew.getURL({view:!0,settings:!0}));break;case 59:this.$=r.miew.screenshotSave();break;case 60:this.$=r.miew.screenshotSave("",Number(o[s]));break;case 61:this.$=r.miew.screenshotSave("",Number(o[s-1]),Number(o[s]));break;case 62:case 63:case 64:this.$=r.utils.load(r.miew,o[s]),r.representations.clear();break;case 65:this.$=r.echo(r.representations.add(r.miew.repAdd()));break;case 66:this.$=r.echo(r.representations.add(o[s],r.miew.repAdd()));break;case 67:this.$=r.echo(r.representations.add(r.miew.repAdd(o[s])));break;case 68:this.$=r.echo(r.representations.add(o[s-1],r.miew.repAdd(o[s])));break;case 69:this.$=r.miew.rep(o[s]),r.miew.repCurrent(o[s]);break;case 70:this.$=r.miew.rep(o[s-1],o[s]),r.miew.repCurrent(o[s-1]);break;case 71:this.$=r.miew.rep(r.miew.repCurrent(),{mode:r.utils.checkArg(o[s-1].toLowerCase(),o[s].toUpperCase())});break;case 72:this.$=r.miew.rep(r.miew.repCurrent(),{mode:new Array(r.utils.checkArg(o[s-2].toLowerCase(),o[s-1].toUpperCase()),o[s].toJSO(r.utils,o[s-2],o[s-1].toUpperCase()))});break;case 73:this.$=r.miew.rep(r.miew.repCurrent(),{colorer:r.utils.checkArg(o[s-1].toLowerCase(),o[s].toUpperCase())});break;case 74:this.$=r.miew.rep(r.miew.repCurrent(),{colorer:new Array(r.utils.checkArg(o[s-2].toLowerCase(),o[s-1].toUpperCase()),o[s].toJSO(r.utils,o[s-2],o[s-1].toUpperCase()))});break;case 75:this.$=Number(r.representations.get(o[s]));break;case 76:case 92:this.$=Number(o[s]);break;case 77:this.$=o[s];break;case 78:this.$=r._.assign(o[s-1],o[s]);break;case 79:this.$=r._.assign(o[s-2],o[s-1],o[s]);break;case 80:this.$=r._.assign(o[s-3],o[s-2],o[s-1],o[s]);break;case 81:case 82:this.$=r.CreateObjectPair(o[s].key,o[s].val);break;case 83:this.$=r.CreateObjectPair(o[s-1].key,new Array(o[s-1].val,o[s].toJSO(r.utils,o[s-1].key,o[s-1].val)));break;case 84:case 85:this.$=Object.create({key:r.keyRemap(o[s-2]),val:r.utils.checkArg(o[s-2],o[s])});break;case 86:this.$=[o[s]];break;case 87:this.$=o[s-1].concat(o[s]);break;case 88:this.$=r.CreateObjectPair(o[s-1].toLowerCase(),Number(o[s]));break;case 89:this.$=new r.ArgList(o[s]);break;case 90:this.$=o[s-1].append(o[s]);break;case 91:this.$=new r.Arg(o[s-2],o[s]);break;case 93:this.$=parseInt(o[s]);break;case 94:this.$=JSON.parse(o[s]);break;case 95:case 96:this.$=String(o[s]);break;case 157:case 158:case 161:case 162:case 163:this.$=o[s-2]+o[s-1]+o[s];break;case 166:this.$=o[s-2]=o[s-2]+o[s-1]+o[s]}},table:[{3:1,4:2,5:[1,3],6:[1,4],7:[1,5],9:[1,6],11:[1,7],12:8,13:[1,9],15:[1,10],17:[1,11],18:[1,12],19:[1,13],20:[1,14],21:15,22:16,23:[1,17],25:[1,18],26:[1,19],27:[1,20],30:[1,21],33:[1,22],34:[1,23],37:[1,24],39:25,40:26,41:[1,27],43:[1,28],44:[1,29],45:[1,30],46:[1,31],48:[1,32],49:[1,33],50:34,51:35,52:[1,36],54:[1,37],55:[1,38],56:[1,44],58:[1,45],59:[1,39],62:[1,40],64:[1,41],65:[1,42],66:[1,43]},{1:[3]},{5:[1,46]},{1:[2,2]},{5:[2,3]},{5:[2,4],8:[1,47]},{5:[2,6],6:Ys=[1,60],7:qs=[1,62],9:e=[1,63],10:48,13:Ks=[1,65],15:Me=[1,66],17:Ge=[1,67],18:qe=[1,68],19:$e=[1,69],20:la=[1,80],23:fa=[1,72],25:ba=[1,73],26:sd=[1,74],27:Ke=[1,75],30:Sa=[1,99],33:ad=[1,76],34:ga=[1,100],37:xa=[1,79],38:wa=[1,51],41:Ea=[1,81],43:Ta=[1,82],45:Ma=[1,84],46:Ia=[1,83],49:Va=[1,85],52:Fa=[1,96],54:Ua=[1,97],55:xt=[1,98],56:gt=[1,86],58:lt=[1,87],59:Ya=[1,64],62:yn=[1,70],64:Sc=[1,71],65:ot=[1,77],66:On=[1,78],70:Mn=[1,53],72:Qn=[1,54],74:Jr=[1,55],79:49,80:52,81:50,82:ni=[1,61],83:Pi=[1,88],84:L=[1,89],85:Vr=[1,90],86:ci=[1,91],87:Wi=[1,92],88:Bi=[1,93],89:Gi=[1,94],90:Ri=[1,95],91:Hi=[1,101],92:ji=[1,102],93:Ui=[1,103],94:Yi=[1,104],95:$i=[1,105],96:so=[1,56],97:ur=[1,57],98:co=[1,58],99:ho=[1,59]},{5:[2,8]},{5:[2,9]},{6:Ys,7:qs,9:e,10:106,13:Ks,14:[1,107],15:Me,17:Ge,18:qe,19:$e,20:la,23:fa,25:ba,26:sd,27:Ke,30:Sa,33:ad,34:ga,37:xa,38:wa,41:Ea,43:Ta,45:Ma,46:Ia,49:Va,52:Fa,54:Ua,55:xt,56:gt,58:lt,59:Ya,62:yn,64:Sc,65:ot,66:On,70:Mn,72:Qn,74:Jr,79:49,80:52,81:50,82:ni,83:Pi,84:L,85:Vr,86:ci,87:Wi,88:Bi,89:Gi,90:Ri,91:Hi,92:ji,93:Ui,94:Yi,95:$i,96:so,97:ur,98:co,99:ho},{6:Ys,7:qs,9:e,10:108,13:Ks,14:[1,109],15:Me,17:Ge,18:qe,19:$e,20:la,23:fa,25:ba,26:sd,27:Ke,30:Sa,33:ad,34:ga,37:xa,38:wa,41:Ea,43:Ta,45:Ma,46:Ia,49:Va,52:Fa,54:Ua,55:xt,56:gt,58:lt,59:Ya,62:yn,64:Sc,65:ot,66:On,70:Mn,72:Qn,74:Jr,79:49,80:52,81:50,82:ni,83:Pi,84:L,85:Vr,86:ci,87:Wi,88:Bi,89:Gi,90:Ri,91:Hi,92:ji,93:Ui,94:Yi,95:$i,96:so,97:ur,98:co,99:ho},{5:[2,14]},{5:[2,15]},{5:[2,16]},{5:[2,17],14:go=[1,115],16:110,35:Do=[1,111],38:ss=[1,114],77:ys=[1,112],78:Vo=[1,113]},{5:[2,19]},{5:[2,20]},{24:116,35:Ho=[1,118],38:Zo=[1,117]},{24:119,35:Ho,38:Zo},{24:120,35:Ho,38:Zo},{5:[2,25],24:121,28:[1,122],29:[1,123],35:Ho,38:Zo},{14:[1,124]},{14:[1,125]},{35:[1,126]},{38:[1,127]},{5:[2,33]},{5:[2,34]},{5:[2,35],14:[1,128],42:[1,129]},{5:[2,38],35:[1,130]},{5:[2,40]},{35:[1,131]},{47:132,73:133,74:Qo=[1,134]},{47:135,73:133,74:Qo},{5:[2,44],14:[1,136]},{5:[2,46]},{5:[2,47]},{6:Ys,7:qs,9:e,10:138,13:Ks,14:[1,137],15:Me,17:Ge,18:qe,19:$e,20:la,23:fa,25:ba,26:sd,27:Ke,30:Sa,33:ad,34:ga,37:xa,38:wa,41:Ea,43:Ta,45:Ma,46:Ia,49:Va,52:Fa,54:Ua,55:xt,56:gt,58:lt,59:Ya,62:yn,64:Sc,65:ot,66:On,70:Mn,72:Qn,74:Jr,79:49,80:52,81:50,82:ni,83:Pi,84:L,85:Vr,86:ci,87:Wi,88:Bi,89:Gi,90:Ri,91:Hi,92:ji,93:Ui,94:Yi,95:$i,96:so,97:ur,98:co,99:ho},{5:[2,52]},{35:[1,139]},{14:[1,143],38:[1,141],60:140,61:[1,142]},{5:[2,65],38:[1,144],63:145,67:146,68:147,69:148,70:is=[1,149],72:wn=[1,150]},{24:151,35:Ho,38:Zo},{38:[1,152]},{38:[1,153]},{5:[2,54],29:[1,154],57:[1,155]},{5:[2,59],35:[1,156]},{1:[2,1]},{5:[2,5]},{5:[2,7],101:r=[1,157]},(Ho=function(e,t,n,r){for(n=n||{},r=e.length;r--;n[e[r]]=t);return n})(Zo=[5,6,7,9,13,14,15,17,18,19,20,23,25,26,27,30,33,34,35,37,38,41,43,45,46,49,52,54,55,56,58,59,62,64,65,66,70,72,74,77,78,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,101],[2,159]),Ho(Zo,[2,160]),Ho(vs,[2,97]),Ho(vs,[2,98]),Ho(Zo,[2,147]),Ho(Zo,[2,148]),Ho(Zo,[2,149]),Ho(Zo,[2,150]),Ho(Zo,[2,151]),Ho(Zo,[2,152]),Ho(Zo,[2,153]),Ho(vs,[2,101]),Ho(vs,[2,102]),Ho(vs,[2,103]),Ho(vs,[2,104]),Ho(vs,[2,105]),Ho(vs,[2,106]),Ho(vs,[2,107]),Ho(vs,[2,108]),Ho(vs,[2,109]),Ho(vs,[2,110]),Ho(vs,[2,111]),Ho(vs,[2,112]),Ho(vs,[2,113]),Ho(vs,[2,114]),Ho(vs,[2,115]),Ho(vs,[2,116]),Ho(vs,[2,117]),Ho(vs,[2,118]),Ho(vs,[2,119]),Ho(vs,[2,120]),Ho(vs,[2,121]),Ho(vs,[2,122]),Ho(vs,[2,123]),Ho(vs,[2,124]),Ho(vs,[2,125]),Ho(vs,[2,126]),Ho(vs,[2,127]),Ho(vs,[2,128]),Ho(vs,[2,129]),Ho(vs,[2,130]),Ho(vs,[2,131]),Ho(vs,[2,132]),Ho(vs,[2,133]),Ho(vs,[2,134]),Ho(vs,[2,135]),Ho(vs,[2,136]),Ho(vs,[2,137]),Ho(vs,[2,138]),Ho(vs,[2,139]),Ho(vs,[2,140]),Ho(vs,[2,141]),Ho(vs,[2,142]),Ho(vs,[2,143]),Ho(vs,[2,144]),Ho(vs,[2,145]),Ho(vs,[2,146]),{5:[2,10],101:r},{5:[2,11]},{14:go,16:158,35:Do,38:ss,77:ys,78:Vo,101:r},{14:go,16:159,35:Do,38:ss,77:ys,78:Vo},{5:[2,18]},Ho(Es,[2,92]),Ho(Es,[2,93]),Ho(Es,[2,94]),Ho(Es,[2,95]),Ho(Es,[2,96]),{5:[2,21]},Ho(Bs,[2,75]),Ho(Bs,[2,76]),{5:[2,22]},{5:[2,23]},{5:[2,24]},{5:[2,26]},{5:[2,27]},{5:[2,28],31:[1,160]},{5:[2,30]},{36:[1,161]},{5:[2,32]},{5:[2,36]},{5:[2,37]},{5:[2,39]},{5:[2,41]},{5:[2,42],73:162,74:Qo},Ho(Gs,[2,86]),{35:[1,163]},{5:[2,43],73:162,74:Qo},{5:[2,45]},{14:[1,164]},{6:Ys,7:qs,9:e,10:165,13:Ks,15:Me,17:Ge,18:qe,19:$e,20:la,23:fa,25:ba,26:sd,27:Ke,30:Sa,33:ad,34:ga,37:xa,38:wa,41:Ea,43:Ta,45:Ma,46:Ia,49:Va,52:Fa,54:Ua,55:xt,56:gt,58:lt,59:Ya,62:yn,64:Sc,65:ot,66:On,70:Mn,72:Qn,74:Jr,79:49,80:52,81:50,82:ni,83:Pi,84:L,85:Vr,86:ci,87:Wi,88:Bi,89:Gi,90:Ri,91:Hi,92:ji,93:Ui,94:Yi,95:$i,96:so,97:ur,98:co,99:ho,101:r},{5:[2,53]},{5:[2,62]},{5:[2,63]},{5:[2,64]},{5:[2,164]},{5:[2,66],63:166,67:146,68:147,69:148,70:is,72:wn},{5:[2,67]},{5:[2,77],67:167,68:147,69:148,70:is,72:wn},Ho(Bs,[2,81]),Ho(Bs,[2,82],{80:52,53:168,75:169,76:170,79:171,6:Ys,7:qs,9:e,13:Ks,15:Me,17:Ge,18:qe,19:$e,20:la,23:fa,25:ba,26:sd,27:Ke,30:Sa,33:ad,34:ga,37:xa,38:wa,41:Ea,43:Ta,45:Ma,46:Ia,49:Va,52:Fa,54:Ua,55:xt,56:gt,58:lt,59:Ya,62:yn,64:Sc,65:ot,66:On,82:ni,83:Pi,84:L,85:Vr,86:ci,87:Wi,88:Bi,89:Gi,90:Ri,91:Hi,92:ji,93:Ui,94:Yi,95:$i}),{71:[1,172]},{71:[1,173]},{5:[2,69],63:174,67:146,68:147,69:148,70:is,72:wn},{5:[2,71],6:Ys,7:qs,9:e,13:Ks,15:Me,17:Ge,18:qe,19:$e,20:la,23:fa,25:ba,26:sd,27:Ke,30:Sa,33:ad,34:ga,37:xa,38:wa,41:Ea,43:Ta,45:Ma,46:Ia,49:Va,52:Fa,53:175,54:Ua,55:xt,56:gt,58:lt,59:Ya,62:yn,64:Sc,65:ot,66:On,75:169,76:170,79:171,80:52,82:ni,83:Pi,84:L,85:Vr,86:ci,87:Wi,88:Bi,89:Gi,90:Ri,91:Hi,92:ji,93:Ui,94:Yi,95:$i},{5:[2,73],6:Ys,7:qs,9:e,13:Ks,15:Me,17:Ge,18:qe,19:$e,20:la,23:fa,25:ba,26:sd,27:Ke,30:Sa,33:ad,34:ga,37:xa,38:wa,41:Ea,43:Ta,45:Ma,46:Ia,49:Va,52:Fa,53:176,54:Ua,55:xt,56:gt,58:lt,59:Ya,62:yn,64:Sc,65:ot,66:On,75:169,76:170,79:171,80:52,82:ni,83:Pi,84:L,85:Vr,86:ci,87:Wi,88:Bi,89:Gi,90:Ri,91:Hi,92:ji,93:Ui,94:Yi,95:$i},{5:[2,55],57:[1,177]},{5:[2,56],29:[1,178]},{5:[2,60],35:[1,179]},{6:Ys,7:qs,9:e,13:Ks,15:Me,17:Ge,18:qe,19:$e,20:la,23:fa,25:ba,26:sd,27:Ke,30:Sa,33:ad,34:ga,35:[1,181],37:xa,38:wa,41:Ea,43:Ta,45:Ma,46:Ia,49:Va,52:Fa,54:Ua,55:xt,56:gt,58:lt,59:Ya,62:yn,64:Sc,65:ot,66:On,70:Mn,72:Qn,74:Jr,79:180,80:52,81:182,82:ni,83:Pi,84:L,85:Vr,86:ci,87:Wi,88:Bi,89:Gi,90:Ri,91:Hi,92:ji,93:Ui,94:Yi,95:$i,96:so,97:ur,98:co,99:ho},{5:[2,12]},{5:[2,13]},{6:Ys,7:qs,9:e,13:Ks,15:Me,17:Ge,18:qe,19:$e,20:la,23:fa,25:ba,26:sd,27:Ke,30:Sa,32:183,33:ad,34:ga,37:xa,38:wa,41:Ea,43:Ta,45:Ma,46:Ia,49:Va,52:Fa,54:Ua,55:xt,56:gt,58:lt,59:Ya,62:yn,64:Sc,65:ot,66:On,70:Mn,72:Qn,74:Jr,79:184,80:52,81:185,82:ni,83:Pi,84:L,85:Vr,86:ci,87:Wi,88:Bi,89:Gi,90:Ri,91:Hi,92:ji,93:Ui,94:Yi,95:$i,96:so,97:ur,98:co,99:ho},{14:[1,186]},Ho(Gs,[2,87]),Ho(Gs,[2,88]),{5:[2,48],6:Ys,7:qs,9:e,13:Ks,15:Me,17:Ge,18:qe,19:$e,20:la,23:fa,25:ba,26:sd,27:Ke,30:Sa,33:ad,34:ga,37:xa,38:wa,41:Ea,43:Ta,45:Ma,46:Ia,49:Va,52:Fa,53:187,54:Ua,55:xt,56:gt,58:lt,59:Ya,62:yn,64:Sc,65:ot,66:On,75:169,76:170,79:171,80:52,82:ni,83:Pi,84:L,85:Vr,86:ci,87:Wi,88:Bi,89:Gi,90:Ri,91:Hi,92:ji,93:Ui,94:Yi,95:$i},{5:[2,49],6:Ys,7:qs,9:e,13:Ks,15:Me,17:Ge,18:qe,19:$e,20:la,23:fa,25:ba,26:sd,27:Ke,30:Sa,33:ad,34:ga,37:xa,38:wa,41:Ea,43:Ta,45:Ma,46:Ia,49:Va,52:Fa,53:188,54:Ua,55:xt,56:gt,58:lt,59:Ya,62:yn,64:Sc,65:ot,66:On,75:169,76:170,79:171,80:52,82:ni,83:Pi,84:L,85:Vr,86:ci,87:Wi,88:Bi,89:Gi,90:Ri,91:Hi,92:ji,93:Ui,94:Yi,95:$i,101:r},{5:[2,68]},{5:[2,78],67:189,68:147,69:148,70:is,72:wn},Ho(Bs,[2,83],{80:52,76:170,79:171,75:190,6:Ys,7:qs,9:e,13:Ks,15:Me,17:Ge,18:qe,19:$e,20:la,23:fa,25:ba,26:sd,27:Ke,30:Sa,33:ad,34:ga,37:xa,38:wa,41:Ea,43:Ta,45:Ma,46:Ia,49:Va,52:Fa,54:Ua,55:xt,56:gt,58:lt,59:Ya,62:yn,64:Sc,65:ot,66:On,82:ni,83:Pi,84:L,85:Vr,86:ci,87:Wi,88:Bi,89:Gi,90:Ri,91:Hi,92:ji,93:Ui,94:Yi,95:$i}),Ho(Es,[2,89]),{71:[1,191],101:[1,192]},Ho(Hs,[2,156]),{14:go,16:193,35:Do,38:ss,77:ys,78:Vo},{14:go,16:194,35:Do,38:ss,77:ys,78:Vo},{5:[2,70]},{5:[2,72],6:Ys,7:qs,9:e,13:Ks,15:Me,17:Ge,18:qe,19:$e,20:la,23:fa,25:ba,26:sd,27:Ke,30:Sa,33:ad,34:ga,37:xa,38:wa,41:Ea,43:Ta,45:Ma,46:Ia,49:Va,52:Fa,54:Ua,55:xt,56:gt,58:lt,59:Ya,62:yn,64:Sc,65:ot,66:On,75:190,76:170,79:171,80:52,82:ni,83:Pi,84:L,85:Vr,86:ci,87:Wi,88:Bi,89:Gi,90:Ri,91:Hi,92:ji,93:Ui,94:Yi,95:$i},{5:[2,74],6:Ys,7:qs,9:e,13:Ks,15:Me,17:Ge,18:qe,19:$e,20:la,23:fa,25:ba,26:sd,27:Ke,30:Sa,33:ad,34:ga,37:xa,38:wa,41:Ea,43:Ta,45:Ma,46:Ia,49:Va,52:Fa,54:Ua,55:xt,56:gt,58:lt,59:Ya,62:yn,64:Sc,65:ot,66:On,75:190,76:170,79:171,80:52,82:ni,83:Pi,84:L,85:Vr,86:ci,87:Wi,88:Bi,89:Gi,90:Ri,91:Hi,92:ji,93:Ui,94:Yi,95:$i},{5:[2,57]},{5:[2,58]},{5:[2,61]},Ho(Zo,[2,161]),Ho(Zo,[2,162]),Ho(Zo,[2,163]),{5:[2,29]},{5:[2,99]},{5:[2,100]},{31:[1,195]},{5:[2,50],6:Ys,7:qs,9:e,13:Ks,15:Me,17:Ge,18:qe,19:$e,20:la,23:fa,25:ba,26:sd,27:Ke,30:Sa,33:ad,34:ga,37:xa,38:wa,41:Ea,43:Ta,45:Ma,46:Ia,49:Va,52:Fa,54:Ua,55:xt,56:gt,58:lt,59:Ya,62:yn,64:Sc,65:ot,66:On,75:190,76:170,79:171,80:52,82:ni,83:Pi,84:L,85:Vr,86:ci,87:Wi,88:Bi,89:Gi,90:Ri,91:Hi,92:ji,93:Ui,94:Yi,95:$i},{5:[2,51],6:Ys,7:qs,9:e,13:Ks,15:Me,17:Ge,18:qe,19:$e,20:la,23:fa,25:ba,26:sd,27:Ke,30:Sa,33:ad,34:ga,37:xa,38:wa,41:Ea,43:Ta,45:Ma,46:Ia,49:Va,52:Fa,54:Ua,55:xt,56:gt,58:lt,59:Ya,62:yn,64:Sc,65:ot,66:On,75:190,76:170,79:171,80:52,82:ni,83:Pi,84:L,85:Vr,86:ci,87:Wi,88:Bi,89:Gi,90:Ri,91:Hi,92:ji,93:Ui,94:Yi,95:$i},{5:[2,79],67:196,68:147,69:148,70:is,72:wn},Ho(Es,[2,90]),{14:go,16:197,35:Do,38:ss,77:ys,78:Vo},{6:Ys,7:qs,9:e,13:Ks,15:Me,17:Ge,18:qe,19:$e,20:la,23:fa,25:ba,26:sd,27:Ke,30:Sa,33:ad,34:ga,35:[1,199],37:xa,38:wa,41:Ea,43:Ta,45:Ma,46:Ia,49:Va,52:Fa,54:Ua,55:xt,56:gt,58:lt,59:Ya,62:yn,64:Sc,65:ot,66:On,79:198,80:52,82:ni,83:Pi,84:L,85:Vr,86:ci,87:Wi,88:Bi,89:Gi,90:Ri,91:Hi,92:ji,93:Ui,94:Yi,95:$i},Ho(Bs,[2,84]),Ho(Es,[2,85]),{6:Ys,7:qs,9:e,13:Ks,15:Me,17:Ge,18:qe,19:$e,20:la,23:fa,25:ba,26:sd,27:Ke,30:Sa,32:200,33:ad,34:ga,37:xa,38:wa,41:Ea,43:Ta,45:Ma,46:Ia,49:Va,52:Fa,54:Ua,55:xt,56:gt,58:lt,59:Ya,62:yn,64:Sc,65:ot,66:On,70:Mn,72:Qn,74:Jr,79:184,80:52,81:185,82:ni,83:Pi,84:L,85:Vr,86:ci,87:Wi,88:Bi,89:Gi,90:Ri,91:Hi,92:ji,93:Ui,94:Yi,95:$i,96:so,97:ur,98:co,99:ho},{5:[2,80]},Ho(Es,[2,91]),Ho(Hs,[2,157]),Ho(Hs,[2,158]),{5:[2,31]}],defaultActions:{3:[2,2],4:[2,3],7:[2,8],8:[2,9],11:[2,14],12:[2,15],13:[2,16],15:[2,19],16:[2,20],25:[2,33],26:[2,34],29:[2,40],34:[2,46],35:[2,47],37:[2,52],46:[2,1],47:[2,5],107:[2,11],110:[2,18],116:[2,21],119:[2,22],120:[2,23],121:[2,24],122:[2,26],123:[2,27],125:[2,30],127:[2,32],128:[2,36],129:[2,37],130:[2,39],131:[2,41],136:[2,45],139:[2,53],140:[2,62],141:[2,63],142:[2,64],143:[2,164],145:[2,67],158:[2,12],159:[2,13],166:[2,68],174:[2,70],177:[2,57],178:[2,58],179:[2,61],183:[2,29],184:[2,99],185:[2,100],196:[2,80],200:[2,31]},parseError:function(e,t){if(!t.recoverable){var n=new Error(e);throw n.hash=t,n}this.trace(e)},parse:function(e){var t,n=this,r=[0],i=[],o=[null],s=[],a=this.table,c="",l=0,u=0,h=1,f=s.slice.call(arguments,1),d=Object.create(this.lexer),p={yy:{}};for(t in this.yy)Object.prototype.hasOwnProperty.call(this.yy,t)&&(p.yy[t]=this.yy[t]);d.setInput(e,p.yy),p.yy.lexer=d,p.yy.parser=this,void 0===d.yylloc&&(d.yylloc={});var m=d.yylloc;s.push(m);var y=d.options&&d.options.ranges;"function"==typeof p.yy.parseError?this.parseError=p.yy.parseError:this.parseError=Object.getPrototypeOf(this).parseError;for(var _,v,g,x,b,w,S,R={};;){if(v=r[r.length-1],void 0===(g=this.defaultActions[v]||(null==_&&(S=void 0,"number"!=typeof(S=i.pop()||d.lex()||h)&&(S instanceof Array&&(S=(i=S).pop()),S=n.symbols_[S]||S),_=S),a[v]&&a[v][_]))||!g.length||!g[0]){var C="",A=[];for(b in a[v])this.terminals_[b]&&2<b&&A.push("'"+this.terminals_[b]+"'");C=d.showPosition?"Parse error on line "+(l+1)+":\n"+d.showPosition()+"\nExpecting "+A.join(", ")+", got '"+(this.terminals_[_]||_)+"'":"Parse error on line "+(l+1)+": Unexpected "+(_==h?"end of input":"'"+(this.terminals_[_]||_)+"'"),this.parseError(C,{text:d.match,token:this.terminals_[_]||_,line:d.yylineno,loc:m,expected:A})}if(g[0]instanceof Array&&1<g.length)throw new Error("Parse Error: multiple actions possible at state: "+v+", token: "+_);switch(g[0]){case 1:r.push(_),o.push(d.yytext),s.push(d.yylloc),r.push(g[1]),_=null,u=d.yyleng,c=d.yytext,l=d.yylineno,m=d.yylloc;break;case 2:if(w=this.productions_[g[1]][1],R.$=o[o.length-w],R._$={first_line:s[s.length-(w||1)].first_line,last_line:s[s.length-1].last_line,first_column:s[s.length-(w||1)].first_column,last_column:s[s.length-1].last_column},y&&(R._$.range=[s[s.length-(w||1)].range[0],s[s.length-1].range[1]]),void 0!==(x=this.performAction.apply(R,[c,u,l,p.yy,g[1],o,s].concat(f))))return x;w&&(r=r.slice(0,-1*w*2),o=o.slice(0,-1*w),s=s.slice(0,-1*w)),r.push(this.productions_[g[1]][0]),o.push(R.$),s.push(R._$),w=a[r[r.length-2]][r[r.length-1]],r.push(w);break;case 3:return!0}}return!0}},Hs={EOF:1,parseError:function(e,t){if(!this.yy.parser)throw new Error(e);this.yy.parser.parseError(e,t)},setInput:function(e,t){return this.yy=t||this.yy||{},this._input=e,this._more=this._backtrack=this.done=!1,this.yylineno=this.yyleng=0,this.yytext=this.matched=this.match="",this.conditionStack=["INITIAL"],this.yylloc={first_line:1,first_column:0,last_line:1,last_column:0},this.options.ranges&&(this.yylloc.range=[0,0]),this.offset=0,this},input:function(){var e=this._input[0];return this.yytext+=e,this.yyleng++,this.offset++,this.match+=e,this.matched+=e,e.match(/(?:\r\n?|\n).*/g)?(this.yylineno++,this.yylloc.last_line++):this.yylloc.last_column++,this.options.ranges&&this.yylloc.range[1]++,this._input=this._input.slice(1),e},unput:function(e){var t=e.length,n=e.split(/(?:\r\n?|\n)/g);this._input=e+this._input,this.yytext=this.yytext.substr(0,this.yytext.length-t),this.offset-=t;var r=this.match.split(/(?:\r\n?|\n)/g);this.match=this.match.substr(0,this.match.length-1),this.matched=this.matched.substr(0,this.matched.length-1),n.length-1&&(this.yylineno-=n.length-1);e=this.yylloc.range;return this.yylloc={first_line:this.yylloc.first_line,last_line:this.yylineno+1,first_column:this.yylloc.first_column,last_column:n?(n.length===r.length?this.yylloc.first_column:0)+r[r.length-n.length].length-n[0].length:this.yylloc.first_column-t},this.options.ranges&&(this.yylloc.range=[e[0],e[0]+this.yyleng-t]),this.yyleng=this.yytext.length,this},more:function(){return this._more=!0,this},reject:function(){return this.options.backtrack_lexer?(this._backtrack=!0,this):this.parseError("Lexical error on line "+(this.yylineno+1)+". You can only invoke reject() in the lexer when the lexer is of the backtracking persuasion (options.backtrack_lexer = true).\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},less:function(e){this.unput(this.match.slice(e))},pastInput:function(){var e=this.matched.substr(0,this.matched.length-this.match.length);return(20<e.length?"...":"")+e.substr(-20).replace(/\n/g,"")},upcomingInput:function(){var e=this.match;return e.length<20&&(e+=this._input.substr(0,20-e.length)),(e.substr(0,20)+(20<e.length?"...":"")).replace(/\n/g,"")},showPosition:function(){var e=this.pastInput(),t=new Array(e.length+1).join("-");return e+this.upcomingInput()+"\n"+t+"^"},test_match:function(e,t){var n,r;if(this.options.backtrack_lexer&&(r={yylineno:this.yylineno,yylloc:{first_line:this.yylloc.first_line,last_line:this.last_line,first_column:this.yylloc.first_column,last_column:this.yylloc.last_column},yytext:this.yytext,match:this.match,matches:this.matches,matched:this.matched,yyleng:this.yyleng,offset:this.offset,_more:this._more,_input:this._input,yy:this.yy,conditionStack:this.conditionStack.slice(0),done:this.done},this.options.ranges&&(r.yylloc.range=this.yylloc.range.slice(0))),(n=e[0].match(/(?:\r\n?|\n).*/g))&&(this.yylineno+=n.length),this.yylloc={first_line:this.yylloc.last_line,last_line:this.yylineno+1,first_column:this.yylloc.last_column,last_column:n?n[n.length-1].length-n[n.length-1].match(/\r?\n?/)[0].length:this.yylloc.last_column+e[0].length},this.yytext+=e[0],this.match+=e[0],this.matches=e,this.yyleng=this.yytext.length,this.options.ranges&&(this.yylloc.range=[this.offset,this.offset+=this.yyleng]),this._more=!1,this._backtrack=!1,this._input=this._input.slice(e[0].length),this.matched+=e[0],t=this.performAction.call(this,this.yy,this,t,this.conditionStack[this.conditionStack.length-1]),this.done&&this._input&&(this.done=!1),t)return t;if(this._backtrack){for(var i in r)this[i]=r[i];return!1}return!1},next:function(){if(this.done)return this.EOF;var e,t,n,r;this._input||(this.done=!0),this._more||(this.yytext="",this.match="");for(var i=this._currentRules(),o=0;o<i.length;o++)if((n=this._input.match(this.rules[i[o]]))&&(!t||n[0].length>t[0].length))if(t=n,r=o,this.options.backtrack_lexer){if(!1!==(e=this.test_match(n,i[o])))return e;if(!this._backtrack)return!1;t=!1}else if(!this.options.flex)break;return t?!1!==(e=this.test_match(t,i[r]))&&e:""===this._input?this.EOF:this.parseError("Lexical error on line "+(this.yylineno+1)+". Unrecognized text.\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},lex:function(){var e=this.next();return e||this.lex()},begin:function(e){this.conditionStack.push(e)},popState:function(){return 0<this.conditionStack.length-1?this.conditionStack.pop():this.conditionStack[0]},_currentRules:function(){return(this.conditionStack.length&&this.conditionStack[this.conditionStack.length-1]?this.conditions[this.conditionStack[this.conditionStack.length-1]]:this.conditions.INITIAL).rules},topState:function(e){return 0<=(e=this.conditionStack.length-1-Math.abs(e||0))?this.conditionStack[e]:"INITIAL"},pushState:function(e){this.begin(e)},stateStackSize:function(){return this.conditionStack.length},options:{"case-insensitive":!0},performAction:function(e,t,n){switch(n){case 0:break;case 1:case 2:return"";case 3:return 42;case 4:return 35;case 5:return 77;case 6:case 7:return 78;case 8:return 8;case 9:return 6;case 10:return 82;case 11:return 7;case 12:return 9;case 13:return 59;case 14:return 13;case 15:return 15;case 16:return 17;case 17:return 18;case 18:return 19;case 19:return 20;case 20:return 11;case 21:return 62;case 22:return 64;case 23:return 23;case 24:return 25;case 25:return 26;case 26:return 27;case 27:return 30;case 28:return 34;case 29:return 33;case 30:return 65;case 31:return 66;case 32:return 37;case 33:return 41;case 34:return 43;case 35:return 52;case 36:return 54;case 37:return 55;case 38:return 46;case 39:return 48;case 40:return 45;case 41:return 49;case 42:return 56;case 43:return 58;case 44:return 44;case 45:return 83;case 46:return 84;case 47:return 85;case 48:return 86;case 49:return 87;case 50:return 88;case 51:return 89;case 52:return 90;case 53:return 91;case 54:return 92;case 55:return 93;case 56:return 94;case 57:return 95;case 58:case 59:return 70;case 60:case 61:return 72;case 62:case 63:case 64:return 74;case 65:return 31;case 66:return 36;case 67:return 96;case 68:return 97;case 69:return 98;case 70:return 99;case 71:return t.yytext=e.utils.unquoteString(t.yytext),14;case 72:return 38;case 73:return 5;case 74:return 101;case 75:return 103;case 76:return"\\";case 77:return 28;case 78:return 61;case 79:return 29;case 80:return 57;case 81:return 71}},rules:[/^(?:\s+)/i,/^(?:[#].*)/i,/^(?:\/\/.*)/i,/^(?:([_A-Z0-9\/\+]+==))/i,/^(?:-?[0-9]+(\.[0-9]+)?\b)/i,/^(?:0[xX][0-9A-F]+\b)/i,/^(?:false\b)/i,/^(?:true\b)/i,/^(?:all\b)/i,/^(?:reset\b)/i,/^(?:clear\b)/i,/^(?:build\b)/i,/^(?:help\b)/i,/^(?:load\b)/i,/^(?:get\b)/i,/^(?:set\b)/i,/^(?:set_save\b)/i,/^(?:set_restore\b)/i,/^(?:set_reset\b)/i,/^(?:preset\b)/i,/^(?:motm\b)/i,/^(?:add\b)/i,/^(?:rep\b)/i,/^(?:remove\b)/i,/^(?:hide\b)/i,/^(?:show\b)/i,/^(?:list\b)/i,/^(?:select\b)/i,/^(?:within\b)/i,/^(?:selector\b)/i,/^(?:mode\b)/i,/^(?:color\b)/i,/^(?:material\b)/i,/^(?:view\b)/i,/^(?:unit\b)/i,/^(?:line\b)/i,/^(?:listobj\b)/i,/^(?:removeobj\b)/i,/^(?:rotate\b)/i,/^(?:translate\b)/i,/^(?:scale\b)/i,/^(?:center\b)/i,/^(?:url\b)/i,/^(?:screenshot\b)/i,/^(?:dssp\b)/i,/^(?:file_list\b)/i,/^(?:file_register\b)/i,/^(?:file_delete\b)/i,/^(?:preset_add\b)/i,/^(?:preset_delete\b)/i,/^(?:preset_update\b)/i,/^(?:preset_rename\b)/i,/^(?:preset_open\b)/i,/^(?:create_scenario\b)/i,/^(?:reset_scenario\b)/i,/^(?:delete_scenario\b)/i,/^(?:add_scenario_item\b)/i,/^(?:list_scenario\b)/i,/^(?:s\b)/i,/^(?:mt\b)/i,/^(?:m\b)/i,/^(?:c\b)/i,/^(?:x\b)/i,/^(?:y\b)/i,/^(?:z\b)/i,/^(?:as\b)/i,/^(?:of\b)/i,/^(?:pdb\b)/i,/^(?:delay\b)/i,/^(?:prst\b)/i,/^(?:desc\b)/i,/^(?:((?:"(?:\\.|[^\\"])*"|'(?:\\.|[^\\'])*')))/i,/^(?:([_A-Z0-9]+))/i,/^(?:$)/i,/^(?:\.)/i,/^(?:\/)/i,/^(?:\\)/i,/^(?:-e\b)/i,/^(?:-f\b)/i,/^(?:-s\b)/i,/^(?:-v\b)/i,/^(?:=)/i],conditions:{INITIAL:{rules:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81],inclusive:!0}}},Ho.lexer=Hs,new((cd.prototype=Ho).Parser=cd))}.parser,co={$help:["Rendering mode shortcut","    BS - balls and sticks mode","    LN - lines mode","    LC - licorice mode","    VW - van der waals mode","    TR - trace mode","    TU - tube mode","    CA - cartoon mode","    SA - isosurface mode","    QS - quick surface mode","    SE - solvent excluded mode","    TX - text mode"],BS:{$help:["   Balls and sticks","      aromrad = <number> #aromatic radius","      atom = <number>    #atom radius","      bond = <number>    #bond radius","      multibond = <bool> #use multibond","      showarom = <bool>  #show aromatic","      space = <number>   #space value\n"]},CA:{$help:["   Cartoon","      arrow = <number>   #arrow size","      depth = <number>   #depth of surface","      heightSegmentsRatio = <number>","      radius = <number>  #tube radius","      tension = <number> #","      width = <number>  #secondary width\n"]},LN:{$help:["   Lines","      atom = <number>    #atom radius","      chunkarom = <number>","      multibond = <bool> #use multibond","      showarom = <bool>  #show aromatic","      offsarom = <number>\n"]},LC:{$help:["   Licorice","      aromrad = <number> #aromatic radius","      bond = <number>    #bond radius","      multibond = <bool> #use multibond","      showarom = <bool>  #show aromatic","      space = <number>   #space value\n"]},VW:{$help:["   Van der Waals","      nothing\n"]},TR:{$help:["   Trace","      radius = <number>  #tube radius\n"]},TU:{$help:["   Tube","      heightSegmentsRatio = <number>","      radius = <number>  #tube radius","      tension = <number> \n"]},SA:{$help:["   Surface","      zClip = <bool> #clip z plane\n"]},QS:{$help:["   Quick surface","      isoValue = <number>","      scale = <number>","      wireframe = <bool>","      zClip = <bool> #clip z plane\n"]},SE:{$help:["   Solvent excluded surface","      zClip = <bool> #clip z plane\n"]},TX:{$help:["   Text mode",'      template = <format string> string that can include "{{ id }}"',"          it will be replaced by value, id can be one of next:","          serial, name, type, sequence, residue, chain, hetatm, water\n",'      horizontalAlign = <string> {"left", "right", "center"}','      verticalAlign = <string> {"top", "bottom", "middle"}',"      dx = <number> #offset along x","      dy = <number> #offset along y","      dz = <number> #offset along z","      fg = <string> #text color modificator","           could be keyword, named color or hex","      fg = <string> #back color modificator","           could be keyword, named color or hex","      showBg = <bool> #if set show background","           plate under text"]}},ho={$help:["Coloring mode shortcut","    EL - color by element","    CH - color by chain","    SQ - color by sequence","    RT - color by residue type","    SS - color by secondary structure","    UN - uniform"],UN:{$help:["Parameters of coloring modes customization","   Uniform","      color = <number|color> #RGB->HEX->dec\n"],color:{$help:Object.keys(Ra.get(oe.now.palette).namedColors).sort().join("\n")}}},Es={$help:["Material shortcut","    DF - diffuse","    TR - transparent","    SF - soft plastic","    PL - glossy plastic","    ME - metal","    GL - glass"]},Hs={$help:["Short (packed) representation description as a set of variables","    s=<EXPRESSION>","        selector property","    m=<MODE_ID>[!<PARAMETER>:<VALUE>[,...]]","        render mode property","    c=<COLORER_ID>[!<PARAMETER>:<VALUE>[,...]]","        color mode property","    mt=<MATERIAL_ID>","        material property"],s:{$help:"Selection expression string as it is in menu->representations->selection"},m:co,c:ho,mt:Es},Ho={$help:["Parameters of rendering modes customization: modes","Parameters of colorer customization: colorers","Autobuild: autobuild = (<number>|<bool>)"],modes:co,colorers:ho},ud={$help:["help (<cmd name>| <path to property>)","You can get detailed information about command options",'   using "help cmd.opt.opt.[...]"\n',"   you can use one line comments","   everything started from (#|//) will be skipped","   Example: >build //some comment\n","List of available commands:"],reset:{$help:["Reload current object, delete all representations","    Nothing will work until load new object"]},load:{$help:["load (<PDBID>|<URL>|-f [<*.NC FILE URL STRING>])","    Load new pdb object from selected source"],PDBID:{$help:"pdb id in remote molecule database"},URL:{$help:"url to source file"},f:{$help:["open file system dialog to fetch local file","optionally you can determine trajectory file","via URL for *.top model"]}},clear:{$help:"No args. Clear terminal"},add:{$help:["add [<REP_NAME>] [<DESCRIPTION>]","    Add new item to representation set with","    default or <DESCRIPTION> params"],REP_NAME:{$help:"Identifier string [_,a-z,A-Z,0-9] can not start from digit"},DESCRIPTION:Hs},rep:{$help:["rep [<REP_NAME>|<REP_INDEX>] [<DESCRIPTION>]","    set current representation by name or index","    edit current representation by <DESCRIPTION>"],REP_NAME:{$help:["Identifier string [_,a-z,A-Z,0-9] can not start from digit","Must be declared before"]},REP_INDEX:{$help:"Index of available representation"},DESCRIPTION:Hs},remove:{$help:["remove (<REP_NAME>|<REP_INDEX>)","Remove representation by name or index"],REP_NAME:{$help:["Identifier string [_,a-z,A-Z,0-9] can not start from digit","Must be declared before"]},REP_INDEX:{$help:"Index of available representation"}},selector:{$help:["selector <EXPRESSION>","   set selector from EXPRESSION to current representation"],EXPRESSION:{$help:"Selection expression string as it is in menu->representations->selection"}},mode:{$help:["mode <MODE_ID> [<PARAMETER>=<VALUE>...]","   set rendering mode and apply parameters to current representation"],MODE_ID:co},color:{$help:["color <COLORER_ID> [<PARAMETER>=<VALUE>...]","   set colorer and apply parameters to current representation"],COLORER_ID:ho},material:{$help:["material <MATERIAL_ID>","   set material to current representation"],MATERIAL_ID:Es},build:{$help:"build help str",add:{$help:"build.add",new:{$help:["add.new","add.new new line 1","add.new new line 2","add.new new line 3"]}},del:{$help:"build.del"}},list:{$help:["list [-e|-s|<REP_NAME>|<REP_INDEX>]","Print representations if no args print list of representations","    -e expand list and show all representations","    -s show all user-registered selectors","    <REP_NAME>|<REP_INDEX> show only current representation"]},hide:{$help:["hide (<REP_NAME>|<REP_INDEX>)","Hide representation referenced in args"]},show:{$help:["show (<REP_NAME>|<REP_INDEX>)","Show representation referenced in args"]},get:{$help:["get <PARAMETER>","Print <PARAMETER> value","    <PARAMETER> - path to option use get.PARAMETER to get more info"],PARAMETER:Ho},set:{$help:["set <PARAMETER> <VALUE>","Set <PARAMETER> with <VALUE>","    <PARAMETER> - path to option use set.PARAMETER to get more info"],PARAMETER:Ho},set_save:{$help:["set_save","Save current settings to cookie"]},set_restore:{$help:["set_restore","Load and apply settings from cookie"]},set_reset:{$help:["set_reset","Reset current settings to the defaults"]},preset:{$help:["preset [<PRESET>]","Reset current representation or set preset to <PRESET>"],PRESET:{$help:["default","wire","small","macro"]}},unit:{$help:["unit [<unit_id>]","Change current biological structure view. Zero <unit_id> value means asymmetric unit,","positive values set an assembly with corresponding number.","Being called with no parameters command prints current unit information."]},view:{$help:["view [<ENCODED_VIEW>]","Get current encoded view or set if ENCODED_VIEW placed as argument"],ENCODED_VIEW:{$help:["encoded view matrix string (binary code)"]}},rotate:{$help:["rotate (x|y|z) [<DEGREES>] [(x|y|z) [<DEGREES>]]...","Rotate scene"]},scale:{$help:["scale <SCALE>","Scale scene"]},select:{$help:["select <SELECTOR_STRING> [as <SELECTOR_NAME>]","Select atoms using selector defined in SELECTOR_STRING","    and if SELECTOR_NAME is defined register it in viewer","    you can use it later as a complex selector"]},within:{$help:["within <DISTANCE> of <SELECTOR_STRING> as <SELECTOR_NAME>","Build within named selector","    DISTANCE        <number>","    SELECTOR_STRING <string(selection language)>","    SELECTOR_NAME   <identifier>"]},url:{$help:["url [-s] [-v]","Report URL encoded scene","    if -s set that include settings in the URL","    if -v set that include view in the URL"]},screenshot:{$help:["screenshot [<WIDTH> [<HEIGHT>]]","Make a screenshot of the scene","    WIDTH  <number> in pixels","    HEIGHT <number> in pixels, equal to WIDTH by default"]},line:{$help:["line <first_atom_path> <second_atom_path> [<PARAMETER>=<VALUE>]","Draw dashed line between two specified atoms"]},removeobj:{$help:["removeobj <id>","Remove scene object by its index. Indices could be obtained by <listobj> command"]},listobj:{$help:["listobj","Display the list of all existing scene objects"]}},hd=Hf.chem.selectors,fd=Hf.modes,dd=Hf.colorers,pd=Hf.materials,md=Hf.palettes,yd=Hf.options,_d=Hf.settings;function vd(){}var gd,xd=(gd=new vd,function(){return gd}),ho=new(function(){function e(){j(this,e),this.representationMap={},this.representationID={}}return _(e,[{key:"get",value:function(e){return this.representationMap[e]||this.representationID[e]||"<no name>"}},{key:"add",value:function(e,t){if(-1===e)return"Can not create representation: there is no data";if(void 0!==t){if(this.representationMap.hasOwnProperty(e))return"This name has already existed, registered without name";this.representationMap[e.toString()]=t,this.representationID[t]=e.toString()}return"Representation ".concat(e," successfully added")}},{key:"remove",value:function(e){e&&this.representationID.hasOwnProperty(e)&&(delete this.representationMap[this.representationID[e]],delete this.representationID[e]);var t,n,r=Object.keys(this.representationID).sort();for(t in r)!r.hasOwnProperty(t)||e<(n=r[t])&&(this.representationID[n-1]=this.representationID[n],--this.representationMap[this.representationID[n]],delete this.representationID[n])}},{key:"clear",value:function(){this.representationMap={},this.representationID={}}}]),e}());function bd(e){var t={s:"selector",m:"mode",c:"colorer",mt:"material",mode:"modes",color:"colorers",colorer:"colorers",select:"selector",material:"materials",selector:"selector"}[e];return void 0===t?e:t}Es=new(function(){function e(){j(this,e)}return _(e,[{key:"list",value:function(e,t,n){var r="";if(e&&void 0!==t&&(void 0===n||"-e"===n))for(var i=e.repCount(),o=0;o<i;o++)r+=this.listRep(e,t,o,n);return r}},{key:"listRep",value:function(e,t,n,r){var i="",o=e.repGet(n);if(!o)return B.warn("Rep ".concat(n," does not exist!")),i;var s=n,a=t.get(s),e=o.mode,n=o.colorer,t=o.selectorString,o=o.materialPreset;return i+="#".concat(s," : ").concat(e.name).concat("<no name>"===a?"":", ".concat(a),"\n"),void 0!==r&&(i+='    selection : "'.concat(t,'"\n'),i+="    mode      : (".concat(e.id,"), ").concat(e.name,"\n"),i+="    colorer   : (".concat(n.id,"), ").concat(n.name,"\n"),i+="    material  : (".concat(o.id,"), ").concat(o.name,"\n")),i}},{key:"listSelector",value:function(e,t){var n,r="";for(n in t)t.hasOwnProperty(n)&&(r+="".concat(n,' : "').concat(t[n],'"\n'));return r}},{key:"listObjs",value:function(e){var t=e._objects;if(!t||!Array.isArray(t)||0===t.length)return"There are no objects on the scene";for(var n=[],r=0,i=t.length;r<i;++r)n[r]="".concat(r,": ").concat(t[r].toString());return n.join("\n")}},{key:"joinHelpStr",value:function(e){return e instanceof Array?e.join("\n"):e}},{key:"help",value:function(e){if(b.default.isUndefined(e))return"".concat(this.joinHelpStr(ud.$help),"\n").concat(b.default.slice(b.default.sortBy(b.default.keys(ud)),1).join(", "),"\n");e=b.default.get(ud,e);return b.default.isUndefined(e)?this.help():"".concat(this.joinHelpStr(e.$help),"\n")}},{key:"load",value:function(e,t){var n;void 0!==e&&void 0!==t&&"-f"!==t&&(e.awaitWhileCMDisInProcess(),n=function(){return e.finishAwaitingCMDInProcess()},e.load(t).then(n,n))}},{key:"checkArg",value:function(e,t,n){if(void 0===e||void 0===t)return xd;if("selector"===bd(e)){var r=hd.parse(t);if(void 0===r.error)return void 0!==n&&n?r.selector:t;throw{message:r.error}}for(var i,r={colorers:dd,modes:fd,materials:pd},o=e;o!==i;)o=bd(i=o);if(void 0!==r[o].get(t))return t;throw{message:"".concat(t," is not existed in ").concat(o)}}},{key:"propagateProp",value:function(e,t){if(void 0!==e){var n,r=yd.adapters[E(b.default.get(_d.defaults,e))];if(void 0===r)throw{message:"".concat(e," is not existed")};if((e.endsWith(".color")||e.endsWith(".baseColor")||e.endsWith(".EL.carbon"))&&"number"!=typeof t&&(t=md.get(_d.now.palette).getNamedColor(t)),(e.endsWith(".fg")||e.endsWith(".bg"))&&("number"!=typeof t?void 0!==(n=md.get(_d.now.palette).getNamedColor(t,!0))&&(t="0x".concat(n.toString(16))):t="0x".concat(t.toString(16))),e.endsWith(".template")&&(t=t.replace(/\\n/g,"\n")),void 0!==t&&r(t)!==t&&r(t)!==0<t)throw{message:"".concat(e,' must be a "').concat(E(b.default.get(_d.defaults,e)),'"')}}return t}},{key:"unquoteString",value:function(e){return ce.unquoteString(e)}}]),e}());function wd(e){if(e instanceof this.constructor)return e;e instanceof Array?this._values=e.slice(0):this._values=e?[e]:[]}wd.prototype.append=function(e){var t=this._values;return t[t.length]=e,this},wd.prototype.remove=function(e){var t=this._values,e=t.indexOf(e);return 0<=e&&t.splice(e,1),this},wd.prototype.toJSO=function(e,t,n){for(var r={},i=this._values,o=0,s=i.length;o<s;++o)b.default.set(r,i[o].id,e.propagateProp("".concat(bd(t),".").concat(n,".").concat(i[o].id),i[o].val));return r};Ho=Object.create({});return Ho.Arg=function(e,t){this.id=e,this.val=t},Ho.ArgList=wd,Ho.miew=null,Ho.echo=null,Ho.representations=ho,Ho.utils=Es,Ho._=b.default,Ho.CreateObjectPair=function(e,t){var n={};return n[e]=t,n},Ho.keyRemap=bd,Ho.Context=hd.Context,Ho.ClearContext=hd.ClearContext,Ho.NULL=xd,Ho.notimplemented=function(){return this.NULL},Hf.prototype.script=function(e,t,n){ld.yy.miew=this,ld.yy.echo=t,ld.yy.error=n,void 0===this.cmdQueue&&(this.cmdQueue=[]),void 0===this.commandInAction&&(this.commandInAction=!1),this.cmdQueue=this.cmdQueue.concat(e.split("\n"))},Hf.prototype.awaitWhileCMDisInProcess=function(){this.commandInAction=!0},Hf.prototype.finishAwaitingCMDInProcess=function(){this.commandInAction=!1},Hf.prototype.isScriptingCommandAvailable=function(){return void 0!==this.commandInAction&&!this.commandInAction&&void 0!==this.cmdQueue&&0<this.cmdQueue.length},Hf.prototype.callNextCmd=function(){if(this.isScriptingCommandAvailable()){var e=this.cmdQueue.shift(),t={success:!1};try{ld.parse(e),t.success=!0}catch(e){t.error=e.message,ld.yy.error(t.error),this.finishAwaitingCMDInProcess()}return t}return""},ld.yy=Ho,ld.yy.parseError=ld.parseError,Hf});
//# sourceMappingURL=Miew.min.js.map