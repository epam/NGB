(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{"2zIC":function(e,t){var n=function(){var e=function(e,t,n,r){for(n=n||{},r=e.length;r--;n[e[r]]=t);return n},t=[1,60],n=[1,62],r=[1,63],i=[1,65],o=[1,66],a=[1,67],s=[1,68],l=[1,69],c=[1,80],u=[1,72],h=[1,73],d=[1,74],f=[1,75],p=[1,99],m=[1,76],v=[1,100],y=[1,79],_=[1,51],g=[1,81],x=[1,82],b=[1,84],w=[1,83],S=[1,85],C=[1,96],R=[1,97],A=[1,98],E=[1,86],k=[1,87],T=[1,64],P=[1,70],M=[1,71],I=[1,77],N=[1,78],L=[1,53],D=[1,54],O=[1,55],V=[1,61],z=[1,88],F=[1,89],B=[1,90],U=[1,91],G=[1,92],j=[1,93],H=[1,94],W=[1,95],Y=[1,101],q=[1,102],X=[1,103],$=[1,104],K=[1,105],Z=[1,56],Q=[1,57],J=[1,58],ee=[1,59],te=[1,115],ne=[1,111],re=[1,114],ie=[1,112],oe=[1,113],ae=[1,118],se=[1,117],le=[1,134],ce=[1,149],ue=[1,150],he=[1,157],de=[5,6,7,9,13,14,15,17,18,19,20,23,25,26,27,30,33,34,35,37,38,41,43,45,46,49,52,54,55,56,58,59,62,64,65,66,70,72,74,77,78,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,101],fe=[5,6,7,9,13,14,15,17,18,19,20,23,25,26,27,30,33,34,35,37,38,41,43,45,46,49,52,54,55,56,58,59,62,64,65,66,70,71,72,74,77,78,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,101],pe=[5,6,7,9,13,15,17,18,19,20,23,25,26,27,30,33,34,37,38,41,43,45,46,49,52,54,55,56,58,59,62,64,65,66,70,72,82,83,84,85,86,87,88,89,90,91,92,93,94,95],me=[5,70,72],ve=[5,74],ye=[71,101],_e={trace:function(){},yy:{},symbols_:{error:2,Program:3,Command:4,EOF:5,RESET:6,BUILD:7,ALL:8,HELP:9,Path:10,MOTM:11,OneArgCommand:12,GET:13,STRING:14,SET:15,Value:16,SET_SAVE:17,SET_RESTORE:18,SET_RESET:19,PRESET:20,AddRepresentation:21,EditRepresentation:22,REMOVE:23,RepresentationReference:24,HIDE:25,SHOW:26,LIST:27,EXPAND_KEY:28,SELECTOR_KEY:29,SELECT:30,AS:31,WordAll:32,SELECTOR:33,WITHIN:34,NUMBER:35,OF:36,MATERIAL:37,IDENTIFIER:38,ModeCMD:39,ColorCMD:40,VIEW:41,BASE_64:42,UNIT:43,DSSP:44,SCALE:45,ROTATE:46,AxesList:47,TRANSLATE:48,CENTER:49,GetURLBranch:50,Screenshot:51,LINE:52,ArgList:53,LISTOBJ:54,REMOVEOBJ:55,URL:56,VIEW_KEY:57,SCREENSHOT:58,LOAD:59,Url:60,FILE_KEY:61,ADD:62,Description:63,REP:64,MODE:65,COLOR:66,Descriptor:67,RepresentationOwnProperty:68,RepresentationOwnPropertyOpts:69,DESC_KEY:70,"=":71,DESC_KEY_OPTS:72,AxesArg:73,DESC_KEY_AXES:74,Arg:75,PathWoDescKey:76,HEX:77,BOOL:78,Word:79,CommandSetWoDESC_KEY:80,DescKeys:81,CLEAR:82,FILE_LIST:83,FILE_REGISTER:84,FILE_DELETE:85,PRESET_ADD:86,PRESET_DELETE:87,PRESET_UPDATE:88,PRESET_RENAME:89,PRESET_OPEN:90,CREATE_SCENARIO:91,RESET_SCENARIO:92,DELETE_SCENARIO:93,ADD_SCENARIO_ITEM:94,LIST_SCENARIO:95,PDB_KEY:96,DELAY_KEY:97,PRST_KEY:98,DESCRIPTION_KEY:99,CommandSet:100,".":101,PresetPath:102,"/":103,HexOrNumber:104,$accept:0,$end:1},terminals_:{2:"error",5:"EOF",6:"RESET",7:"BUILD",8:"ALL",9:"HELP",11:"MOTM",13:"GET",14:"STRING",15:"SET",17:"SET_SAVE",18:"SET_RESTORE",19:"SET_RESET",20:"PRESET",23:"REMOVE",25:"HIDE",26:"SHOW",27:"LIST",28:"EXPAND_KEY",29:"SELECTOR_KEY",30:"SELECT",31:"AS",33:"SELECTOR",34:"WITHIN",35:"NUMBER",36:"OF",37:"MATERIAL",38:"IDENTIFIER",41:"VIEW",42:"BASE_64",43:"UNIT",44:"DSSP",45:"SCALE",46:"ROTATE",48:"TRANSLATE",49:"CENTER",52:"LINE",54:"LISTOBJ",55:"REMOVEOBJ",56:"URL",57:"VIEW_KEY",58:"SCREENSHOT",59:"LOAD",61:"FILE_KEY",62:"ADD",64:"REP",65:"MODE",66:"COLOR",70:"DESC_KEY",71:"=",72:"DESC_KEY_OPTS",74:"DESC_KEY_AXES",77:"HEX",78:"BOOL",82:"CLEAR",83:"FILE_LIST",84:"FILE_REGISTER",85:"FILE_DELETE",86:"PRESET_ADD",87:"PRESET_DELETE",88:"PRESET_UPDATE",89:"PRESET_RENAME",90:"PRESET_OPEN",91:"CREATE_SCENARIO",92:"RESET_SCENARIO",93:"DELETE_SCENARIO",94:"ADD_SCENARIO_ITEM",95:"LIST_SCENARIO",96:"PDB_KEY",97:"DELAY_KEY",98:"PRST_KEY",99:"DESCRIPTION_KEY",101:".",103:"/"},productions_:[0,[3,2],[3,1],[4,1],[4,1],[4,2],[4,1],[4,2],[4,1],[4,1],[4,2],[4,2],[4,3],[4,3],[4,1],[4,1],[4,1],[4,1],[4,2],[4,1],[4,1],[4,2],[4,2],[4,2],[4,2],[4,1],[4,2],[4,2],[4,2],[4,4],[4,2],[4,6],[4,2],[4,1],[4,1],[4,1],[4,2],[4,2],[4,1],[4,2],[4,1],[4,2],[4,2],[4,2],[4,1],[4,2],[4,1],[4,1],[4,3],[4,3],[4,4],[4,4],[4,1],[4,2],[50,1],[50,2],[50,2],[50,3],[50,3],[51,1],[51,2],[51,3],[12,2],[12,2],[12,2],[21,1],[21,2],[21,2],[21,3],[22,2],[22,3],[39,2],[39,3],[40,2],[40,3],[24,1],[24,1],[63,1],[63,2],[63,3],[63,4],[67,1],[67,1],[67,2],[68,3],[69,3],[47,1],[47,2],[73,2],[53,1],[53,2],[75,3],[16,1],[16,1],[16,1],[16,1],[16,1],[79,1],[79,1],[32,1],[32,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[81,1],[81,1],[81,1],[81,1],[81,1],[81,1],[81,1],[100,1],[100,1],[76,1],[76,3],[76,3],[10,1],[10,1],[10,3],[10,3],[10,3],[60,1],[102,1],[102,3],[104,1],[104,1]],performAction:function(e,t,n,r,i,o,a){var s=o.length-1;switch(i){case 1:return o[s-1];case 3:this.$=r.miew.reset(!1),r.ClearContext(),r.miew.resetReps("empty");break;case 4:this.$=r.miew.rebuild();break;case 5:this.$=r.miew.rebuildAll(),r.miew.rebuild();break;case 6:this.$=r.echo(r.utils.help().toString());break;case 7:this.$=r.echo(r.utils.help(o[s]).toString());break;case 8:this.$=r.miew.motm();break;case 10:case 11:this.$=r.utils.propagateProp(o[s]),r.echo(r.miew.get(o[s]).toString());break;case 12:case 13:this.$=r.miew.set(o[s-1],r.utils.propagateProp(o[s-1],o[s]));break;case 14:this.$=r.miew.saveSettings();break;case 15:this.$=r.miew.restoreSettings();break;case 16:this.$=r.miew.resetSettings();break;case 17:this.$=r.miew.resetReps();break;case 18:this.$=r.miew.applyPreset(o[s]);break;case 21:this.$=r.miew.repRemove(o[s]),r.representations.remove(o[s]);break;case 22:this.$=r.miew.repHide(o[s]);break;case 23:this.$=r.miew.repHide(o[s],!1);break;case 24:this.$=r.echo(r.utils.listRep(r.miew,r.representations,o[s],"-e"));break;case 25:this.$=r.echo(r.utils.list(r.miew,r.representations));break;case 26:this.$=r.echo(r.utils.list(r.miew,r.representations,o[s]));break;case 27:this.$=r.echo(r.utils.listSelector(r.miew,r.Context));break;case 28:this.$=r.miew.select(r.utils.checkArg(o[s-1].toLowerCase(),o[s],!0));break;case 29:this.$=r.Context[o[s].toLowerCase()]=r.utils.checkArg(o[s-3].toLowerCase(),o[s-2],!0),r.miew.select(r.Context[o[s].toLowerCase()]);break;case 30:this.$=r.miew.rep(r.miew.repCurrent(),{selector:r.utils.checkArg(o[s-1].toLowerCase(),o[s])});break;case 31:this.$=r.Context[o[s].toLowerCase()]=r.miew.within(r.utils.checkArg("select",o[s-2],!0),Number(o[s-4]));break;case 32:this.$=r.miew.rep(r.miew.repCurrent(),{material:r.utils.checkArg(o[s-1].toLowerCase(),o[s].toUpperCase())});break;case 35:this.$=r.echo(r.miew.view());break;case 36:case 37:this.$=r.miew.view(o[s]);break;case 38:this.$=r.echo(r.miew.changeUnit());break;case 39:this.$=r.echo(r.miew.changeUnit(o[s]));break;case 40:this.$=r.miew.dssp();break;case 41:this.$=r.miew.scale(o[s]);break;case 42:for(var l=0,c=o[s].length;l<c;l++)r.miew.rotate(o[s][l].x*Math.PI/180,o[s][l].y*Math.PI/180,o[s][l].z*Math.PI/180);break;case 43:for(l=0,c=o[s].length;l<c;l++)r.miew.translate(o[s][l].x||0,o[s][l].y||0,o[s][l].z||0);break;case 44:this.$=r.miew.center();break;case 45:this.$=r.miew.center(o[s]);break;case 48:case 49:this.$=r.miew.addObject({type:"line",params:[o[s-1],o[s]]},!0);break;case 50:case 51:this.$=r.miew.addObject({type:"line",params:[o[s-2],o[s-1]],opts:o[s].toJSO(r.utils,"objects","line")},!0);break;case 52:this.$=r.echo(r.utils.listObjs(r.miew));break;case 53:this.$=r.miew.removeObject(o[s]);break;case 54:this.$=r.echo(r.miew.getURL({view:!1,settings:!1}));break;case 55:this.$=r.echo(r.miew.getURL({view:!1,settings:!0}));break;case 56:this.$=r.echo(r.miew.getURL({view:!0,settings:!1}));break;case 57:case 58:this.$=r.echo(r.miew.getURL({view:!0,settings:!0}));break;case 59:this.$=r.miew.screenshotSave();break;case 60:this.$=r.miew.screenshotSave("",Number(o[s]));break;case 61:this.$=r.miew.screenshotSave("",Number(o[s-1]),Number(o[s]));break;case 62:case 63:case 64:this.$=r.utils.load(r.miew,o[s]),r.representations.clear();break;case 65:this.$=r.echo(r.representations.add(r.miew.repAdd()));break;case 66:this.$=r.echo(r.representations.add(o[s],r.miew.repAdd()));break;case 67:this.$=r.echo(r.representations.add(r.miew.repAdd(o[s])));break;case 68:this.$=r.echo(r.representations.add(o[s-1],r.miew.repAdd(o[s])));break;case 69:this.$=r.miew.rep(o[s]),r.miew.repCurrent(o[s]);break;case 70:this.$=r.miew.rep(o[s-1],o[s]),r.miew.repCurrent(o[s-1]);break;case 71:this.$=r.miew.rep(r.miew.repCurrent(),{mode:r.utils.checkArg(o[s-1].toLowerCase(),o[s].toUpperCase())});break;case 72:this.$=r.miew.rep(r.miew.repCurrent(),{mode:new Array(r.utils.checkArg(o[s-2].toLowerCase(),o[s-1].toUpperCase()),o[s].toJSO(r.utils,o[s-2],o[s-1].toUpperCase()))});break;case 73:this.$=r.miew.rep(r.miew.repCurrent(),{colorer:r.utils.checkArg(o[s-1].toLowerCase(),o[s].toUpperCase())});break;case 74:this.$=r.miew.rep(r.miew.repCurrent(),{colorer:new Array(r.utils.checkArg(o[s-2].toLowerCase(),o[s-1].toUpperCase()),o[s].toJSO(r.utils,o[s-2],o[s-1].toUpperCase()))});break;case 75:this.$=Number(r.representations.get(o[s]));break;case 76:case 92:this.$=Number(o[s]);break;case 77:this.$=o[s];break;case 78:this.$=r._.assign(o[s-1],o[s]);break;case 79:this.$=r._.assign(o[s-2],o[s-1],o[s]);break;case 80:this.$=r._.assign(o[s-3],o[s-2],o[s-1],o[s]);break;case 81:case 82:this.$=r.CreateObjectPair(o[s].key,o[s].val);break;case 83:this.$=r.CreateObjectPair(o[s-1].key,new Array(o[s-1].val,o[s].toJSO(r.utils,o[s-1].key,o[s-1].val)));break;case 84:case 85:this.$=Object.create({key:r.keyRemap(o[s-2]),val:r.utils.checkArg(o[s-2],o[s])});break;case 86:this.$=[o[s]];break;case 87:this.$=o[s-1].concat(o[s]);break;case 88:this.$=r.CreateObjectPair(o[s-1].toLowerCase(),Number(o[s]));break;case 89:this.$=new r.ArgList(o[s]);break;case 90:this.$=o[s-1].append(o[s]);break;case 91:this.$=new r.Arg(o[s-2],o[s]);break;case 93:this.$=parseInt(o[s]);break;case 94:this.$=JSON.parse(o[s]);break;case 95:case 96:this.$=String(o[s]);break;case 157:case 158:case 161:case 162:case 163:this.$=o[s-2]+o[s-1]+o[s];break;case 166:this.$=o[s-2]=o[s-2]+o[s-1]+o[s]}},table:[{3:1,4:2,5:[1,3],6:[1,4],7:[1,5],9:[1,6],11:[1,7],12:8,13:[1,9],15:[1,10],17:[1,11],18:[1,12],19:[1,13],20:[1,14],21:15,22:16,23:[1,17],25:[1,18],26:[1,19],27:[1,20],30:[1,21],33:[1,22],34:[1,23],37:[1,24],39:25,40:26,41:[1,27],43:[1,28],44:[1,29],45:[1,30],46:[1,31],48:[1,32],49:[1,33],50:34,51:35,52:[1,36],54:[1,37],55:[1,38],56:[1,44],58:[1,45],59:[1,39],62:[1,40],64:[1,41],65:[1,42],66:[1,43]},{1:[3]},{5:[1,46]},{1:[2,2]},{5:[2,3]},{5:[2,4],8:[1,47]},{5:[2,6],6:t,7:n,9:r,10:48,13:i,15:o,17:a,18:s,19:l,20:c,23:u,25:h,26:d,27:f,30:p,33:m,34:v,37:y,38:_,41:g,43:x,45:b,46:w,49:S,52:C,54:R,55:A,56:E,58:k,59:T,62:P,64:M,65:I,66:N,70:L,72:D,74:O,79:49,80:52,81:50,82:V,83:z,84:F,85:B,86:U,87:G,88:j,89:H,90:W,91:Y,92:q,93:X,94:$,95:K,96:Z,97:Q,98:J,99:ee},{5:[2,8]},{5:[2,9]},{6:t,7:n,9:r,10:106,13:i,14:[1,107],15:o,17:a,18:s,19:l,20:c,23:u,25:h,26:d,27:f,30:p,33:m,34:v,37:y,38:_,41:g,43:x,45:b,46:w,49:S,52:C,54:R,55:A,56:E,58:k,59:T,62:P,64:M,65:I,66:N,70:L,72:D,74:O,79:49,80:52,81:50,82:V,83:z,84:F,85:B,86:U,87:G,88:j,89:H,90:W,91:Y,92:q,93:X,94:$,95:K,96:Z,97:Q,98:J,99:ee},{6:t,7:n,9:r,10:108,13:i,14:[1,109],15:o,17:a,18:s,19:l,20:c,23:u,25:h,26:d,27:f,30:p,33:m,34:v,37:y,38:_,41:g,43:x,45:b,46:w,49:S,52:C,54:R,55:A,56:E,58:k,59:T,62:P,64:M,65:I,66:N,70:L,72:D,74:O,79:49,80:52,81:50,82:V,83:z,84:F,85:B,86:U,87:G,88:j,89:H,90:W,91:Y,92:q,93:X,94:$,95:K,96:Z,97:Q,98:J,99:ee},{5:[2,14]},{5:[2,15]},{5:[2,16]},{5:[2,17],14:te,16:110,35:ne,38:re,77:ie,78:oe},{5:[2,19]},{5:[2,20]},{24:116,35:ae,38:se},{24:119,35:ae,38:se},{24:120,35:ae,38:se},{5:[2,25],24:121,28:[1,122],29:[1,123],35:ae,38:se},{14:[1,124]},{14:[1,125]},{35:[1,126]},{38:[1,127]},{5:[2,33]},{5:[2,34]},{5:[2,35],14:[1,128],42:[1,129]},{5:[2,38],35:[1,130]},{5:[2,40]},{35:[1,131]},{47:132,73:133,74:le},{47:135,73:133,74:le},{5:[2,44],14:[1,136]},{5:[2,46]},{5:[2,47]},{6:t,7:n,9:r,10:138,13:i,14:[1,137],15:o,17:a,18:s,19:l,20:c,23:u,25:h,26:d,27:f,30:p,33:m,34:v,37:y,38:_,41:g,43:x,45:b,46:w,49:S,52:C,54:R,55:A,56:E,58:k,59:T,62:P,64:M,65:I,66:N,70:L,72:D,74:O,79:49,80:52,81:50,82:V,83:z,84:F,85:B,86:U,87:G,88:j,89:H,90:W,91:Y,92:q,93:X,94:$,95:K,96:Z,97:Q,98:J,99:ee},{5:[2,52]},{35:[1,139]},{14:[1,143],38:[1,141],60:140,61:[1,142]},{5:[2,65],38:[1,144],63:145,67:146,68:147,69:148,70:ce,72:ue},{24:151,35:ae,38:se},{38:[1,152]},{38:[1,153]},{5:[2,54],29:[1,154],57:[1,155]},{5:[2,59],35:[1,156]},{1:[2,1]},{5:[2,5]},{5:[2,7],101:he},e(de,[2,159]),e(de,[2,160]),e(fe,[2,97]),e(fe,[2,98]),e(de,[2,147]),e(de,[2,148]),e(de,[2,149]),e(de,[2,150]),e(de,[2,151]),e(de,[2,152]),e(de,[2,153]),e(fe,[2,101]),e(fe,[2,102]),e(fe,[2,103]),e(fe,[2,104]),e(fe,[2,105]),e(fe,[2,106]),e(fe,[2,107]),e(fe,[2,108]),e(fe,[2,109]),e(fe,[2,110]),e(fe,[2,111]),e(fe,[2,112]),e(fe,[2,113]),e(fe,[2,114]),e(fe,[2,115]),e(fe,[2,116]),e(fe,[2,117]),e(fe,[2,118]),e(fe,[2,119]),e(fe,[2,120]),e(fe,[2,121]),e(fe,[2,122]),e(fe,[2,123]),e(fe,[2,124]),e(fe,[2,125]),e(fe,[2,126]),e(fe,[2,127]),e(fe,[2,128]),e(fe,[2,129]),e(fe,[2,130]),e(fe,[2,131]),e(fe,[2,132]),e(fe,[2,133]),e(fe,[2,134]),e(fe,[2,135]),e(fe,[2,136]),e(fe,[2,137]),e(fe,[2,138]),e(fe,[2,139]),e(fe,[2,140]),e(fe,[2,141]),e(fe,[2,142]),e(fe,[2,143]),e(fe,[2,144]),e(fe,[2,145]),e(fe,[2,146]),{5:[2,10],101:he},{5:[2,11]},{14:te,16:158,35:ne,38:re,77:ie,78:oe,101:he},{14:te,16:159,35:ne,38:re,77:ie,78:oe},{5:[2,18]},e(pe,[2,92]),e(pe,[2,93]),e(pe,[2,94]),e(pe,[2,95]),e(pe,[2,96]),{5:[2,21]},e(me,[2,75]),e(me,[2,76]),{5:[2,22]},{5:[2,23]},{5:[2,24]},{5:[2,26]},{5:[2,27]},{5:[2,28],31:[1,160]},{5:[2,30]},{36:[1,161]},{5:[2,32]},{5:[2,36]},{5:[2,37]},{5:[2,39]},{5:[2,41]},{5:[2,42],73:162,74:le},e(ve,[2,86]),{35:[1,163]},{5:[2,43],73:162,74:le},{5:[2,45]},{14:[1,164]},{6:t,7:n,9:r,10:165,13:i,15:o,17:a,18:s,19:l,20:c,23:u,25:h,26:d,27:f,30:p,33:m,34:v,37:y,38:_,41:g,43:x,45:b,46:w,49:S,52:C,54:R,55:A,56:E,58:k,59:T,62:P,64:M,65:I,66:N,70:L,72:D,74:O,79:49,80:52,81:50,82:V,83:z,84:F,85:B,86:U,87:G,88:j,89:H,90:W,91:Y,92:q,93:X,94:$,95:K,96:Z,97:Q,98:J,99:ee,101:he},{5:[2,53]},{5:[2,62]},{5:[2,63]},{5:[2,64]},{5:[2,164]},{5:[2,66],63:166,67:146,68:147,69:148,70:ce,72:ue},{5:[2,67]},{5:[2,77],67:167,68:147,69:148,70:ce,72:ue},e(me,[2,81]),e(me,[2,82],{80:52,53:168,75:169,76:170,79:171,6:t,7:n,9:r,13:i,15:o,17:a,18:s,19:l,20:c,23:u,25:h,26:d,27:f,30:p,33:m,34:v,37:y,38:_,41:g,43:x,45:b,46:w,49:S,52:C,54:R,55:A,56:E,58:k,59:T,62:P,64:M,65:I,66:N,82:V,83:z,84:F,85:B,86:U,87:G,88:j,89:H,90:W,91:Y,92:q,93:X,94:$,95:K}),{71:[1,172]},{71:[1,173]},{5:[2,69],63:174,67:146,68:147,69:148,70:ce,72:ue},{5:[2,71],6:t,7:n,9:r,13:i,15:o,17:a,18:s,19:l,20:c,23:u,25:h,26:d,27:f,30:p,33:m,34:v,37:y,38:_,41:g,43:x,45:b,46:w,49:S,52:C,53:175,54:R,55:A,56:E,58:k,59:T,62:P,64:M,65:I,66:N,75:169,76:170,79:171,80:52,82:V,83:z,84:F,85:B,86:U,87:G,88:j,89:H,90:W,91:Y,92:q,93:X,94:$,95:K},{5:[2,73],6:t,7:n,9:r,13:i,15:o,17:a,18:s,19:l,20:c,23:u,25:h,26:d,27:f,30:p,33:m,34:v,37:y,38:_,41:g,43:x,45:b,46:w,49:S,52:C,53:176,54:R,55:A,56:E,58:k,59:T,62:P,64:M,65:I,66:N,75:169,76:170,79:171,80:52,82:V,83:z,84:F,85:B,86:U,87:G,88:j,89:H,90:W,91:Y,92:q,93:X,94:$,95:K},{5:[2,55],57:[1,177]},{5:[2,56],29:[1,178]},{5:[2,60],35:[1,179]},{6:t,7:n,9:r,13:i,15:o,17:a,18:s,19:l,20:c,23:u,25:h,26:d,27:f,30:p,33:m,34:v,35:[1,181],37:y,38:_,41:g,43:x,45:b,46:w,49:S,52:C,54:R,55:A,56:E,58:k,59:T,62:P,64:M,65:I,66:N,70:L,72:D,74:O,79:180,80:52,81:182,82:V,83:z,84:F,85:B,86:U,87:G,88:j,89:H,90:W,91:Y,92:q,93:X,94:$,95:K,96:Z,97:Q,98:J,99:ee},{5:[2,12]},{5:[2,13]},{6:t,7:n,9:r,13:i,15:o,17:a,18:s,19:l,20:c,23:u,25:h,26:d,27:f,30:p,32:183,33:m,34:v,37:y,38:_,41:g,43:x,45:b,46:w,49:S,52:C,54:R,55:A,56:E,58:k,59:T,62:P,64:M,65:I,66:N,70:L,72:D,74:O,79:184,80:52,81:185,82:V,83:z,84:F,85:B,86:U,87:G,88:j,89:H,90:W,91:Y,92:q,93:X,94:$,95:K,96:Z,97:Q,98:J,99:ee},{14:[1,186]},e(ve,[2,87]),e(ve,[2,88]),{5:[2,48],6:t,7:n,9:r,13:i,15:o,17:a,18:s,19:l,20:c,23:u,25:h,26:d,27:f,30:p,33:m,34:v,37:y,38:_,41:g,43:x,45:b,46:w,49:S,52:C,53:187,54:R,55:A,56:E,58:k,59:T,62:P,64:M,65:I,66:N,75:169,76:170,79:171,80:52,82:V,83:z,84:F,85:B,86:U,87:G,88:j,89:H,90:W,91:Y,92:q,93:X,94:$,95:K},{5:[2,49],6:t,7:n,9:r,13:i,15:o,17:a,18:s,19:l,20:c,23:u,25:h,26:d,27:f,30:p,33:m,34:v,37:y,38:_,41:g,43:x,45:b,46:w,49:S,52:C,53:188,54:R,55:A,56:E,58:k,59:T,62:P,64:M,65:I,66:N,75:169,76:170,79:171,80:52,82:V,83:z,84:F,85:B,86:U,87:G,88:j,89:H,90:W,91:Y,92:q,93:X,94:$,95:K,101:he},{5:[2,68]},{5:[2,78],67:189,68:147,69:148,70:ce,72:ue},e(me,[2,83],{80:52,76:170,79:171,75:190,6:t,7:n,9:r,13:i,15:o,17:a,18:s,19:l,20:c,23:u,25:h,26:d,27:f,30:p,33:m,34:v,37:y,38:_,41:g,43:x,45:b,46:w,49:S,52:C,54:R,55:A,56:E,58:k,59:T,62:P,64:M,65:I,66:N,82:V,83:z,84:F,85:B,86:U,87:G,88:j,89:H,90:W,91:Y,92:q,93:X,94:$,95:K}),e(pe,[2,89]),{71:[1,191],101:[1,192]},e(ye,[2,156]),{14:te,16:193,35:ne,38:re,77:ie,78:oe},{14:te,16:194,35:ne,38:re,77:ie,78:oe},{5:[2,70]},{5:[2,72],6:t,7:n,9:r,13:i,15:o,17:a,18:s,19:l,20:c,23:u,25:h,26:d,27:f,30:p,33:m,34:v,37:y,38:_,41:g,43:x,45:b,46:w,49:S,52:C,54:R,55:A,56:E,58:k,59:T,62:P,64:M,65:I,66:N,75:190,76:170,79:171,80:52,82:V,83:z,84:F,85:B,86:U,87:G,88:j,89:H,90:W,91:Y,92:q,93:X,94:$,95:K},{5:[2,74],6:t,7:n,9:r,13:i,15:o,17:a,18:s,19:l,20:c,23:u,25:h,26:d,27:f,30:p,33:m,34:v,37:y,38:_,41:g,43:x,45:b,46:w,49:S,52:C,54:R,55:A,56:E,58:k,59:T,62:P,64:M,65:I,66:N,75:190,76:170,79:171,80:52,82:V,83:z,84:F,85:B,86:U,87:G,88:j,89:H,90:W,91:Y,92:q,93:X,94:$,95:K},{5:[2,57]},{5:[2,58]},{5:[2,61]},e(de,[2,161]),e(de,[2,162]),e(de,[2,163]),{5:[2,29]},{5:[2,99]},{5:[2,100]},{31:[1,195]},{5:[2,50],6:t,7:n,9:r,13:i,15:o,17:a,18:s,19:l,20:c,23:u,25:h,26:d,27:f,30:p,33:m,34:v,37:y,38:_,41:g,43:x,45:b,46:w,49:S,52:C,54:R,55:A,56:E,58:k,59:T,62:P,64:M,65:I,66:N,75:190,76:170,79:171,80:52,82:V,83:z,84:F,85:B,86:U,87:G,88:j,89:H,90:W,91:Y,92:q,93:X,94:$,95:K},{5:[2,51],6:t,7:n,9:r,13:i,15:o,17:a,18:s,19:l,20:c,23:u,25:h,26:d,27:f,30:p,33:m,34:v,37:y,38:_,41:g,43:x,45:b,46:w,49:S,52:C,54:R,55:A,56:E,58:k,59:T,62:P,64:M,65:I,66:N,75:190,76:170,79:171,80:52,82:V,83:z,84:F,85:B,86:U,87:G,88:j,89:H,90:W,91:Y,92:q,93:X,94:$,95:K},{5:[2,79],67:196,68:147,69:148,70:ce,72:ue},e(pe,[2,90]),{14:te,16:197,35:ne,38:re,77:ie,78:oe},{6:t,7:n,9:r,13:i,15:o,17:a,18:s,19:l,20:c,23:u,25:h,26:d,27:f,30:p,33:m,34:v,35:[1,199],37:y,38:_,41:g,43:x,45:b,46:w,49:S,52:C,54:R,55:A,56:E,58:k,59:T,62:P,64:M,65:I,66:N,79:198,80:52,82:V,83:z,84:F,85:B,86:U,87:G,88:j,89:H,90:W,91:Y,92:q,93:X,94:$,95:K},e(me,[2,84]),e(pe,[2,85]),{6:t,7:n,9:r,13:i,15:o,17:a,18:s,19:l,20:c,23:u,25:h,26:d,27:f,30:p,32:200,33:m,34:v,37:y,38:_,41:g,43:x,45:b,46:w,49:S,52:C,54:R,55:A,56:E,58:k,59:T,62:P,64:M,65:I,66:N,70:L,72:D,74:O,79:184,80:52,81:185,82:V,83:z,84:F,85:B,86:U,87:G,88:j,89:H,90:W,91:Y,92:q,93:X,94:$,95:K,96:Z,97:Q,98:J,99:ee},{5:[2,80]},e(pe,[2,91]),e(ye,[2,157]),e(ye,[2,158]),{5:[2,31]}],defaultActions:{3:[2,2],4:[2,3],7:[2,8],8:[2,9],11:[2,14],12:[2,15],13:[2,16],15:[2,19],16:[2,20],25:[2,33],26:[2,34],29:[2,40],34:[2,46],35:[2,47],37:[2,52],46:[2,1],47:[2,5],107:[2,11],110:[2,18],116:[2,21],119:[2,22],120:[2,23],121:[2,24],122:[2,26],123:[2,27],125:[2,30],127:[2,32],128:[2,36],129:[2,37],130:[2,39],131:[2,41],136:[2,45],139:[2,53],140:[2,62],141:[2,63],142:[2,64],143:[2,164],145:[2,67],158:[2,12],159:[2,13],166:[2,68],174:[2,70],177:[2,57],178:[2,58],179:[2,61],183:[2,29],184:[2,99],185:[2,100],196:[2,80],200:[2,31]},parseError:function(e,t){if(!t.recoverable){var n=new Error(e);throw n.hash=t,n}this.trace(e)},parse:function(e){var t=this,n=[0],r=[],i=[null],o=[],a=this.table,s="",l=0,c=0,u=0,h=2,d=1,f=o.slice.call(arguments,1),p=Object.create(this.lexer),m={yy:{}};for(var v in this.yy)Object.prototype.hasOwnProperty.call(this.yy,v)&&(m.yy[v]=this.yy[v]);p.setInput(e,m.yy),m.yy.lexer=p,m.yy.parser=this,void 0===p.yylloc&&(p.yylloc={});var y=p.yylloc;o.push(y);var _=p.options&&p.options.ranges;function g(){var e;return"number"!=typeof(e=r.pop()||p.lex()||d)&&(e instanceof Array&&(e=(r=e).pop()),e=t.symbols_[e]||e),e}"function"==typeof m.yy.parseError?this.parseError=m.yy.parseError:this.parseError=Object.getPrototypeOf(this).parseError;for(var x,b,w,S,C,R,A,E,k,T={};;){if(w=n[n.length-1],this.defaultActions[w]?S=this.defaultActions[w]:(null==x&&(x=g()),S=a[w]&&a[w][x]),void 0===S||!S.length||!S[0]){var P="";for(R in k=[],a[w])this.terminals_[R]&&R>h&&k.push("'"+this.terminals_[R]+"'");P=p.showPosition?"Parse error on line "+(l+1)+":\n"+p.showPosition()+"\nExpecting "+k.join(", ")+", got '"+(this.terminals_[x]||x)+"'":"Parse error on line "+(l+1)+": Unexpected "+(x==d?"end of input":"'"+(this.terminals_[x]||x)+"'"),this.parseError(P,{text:p.match,token:this.terminals_[x]||x,line:p.yylineno,loc:y,expected:k})}if(S[0]instanceof Array&&S.length>1)throw new Error("Parse Error: multiple actions possible at state: "+w+", token: "+x);switch(S[0]){case 1:n.push(x),i.push(p.yytext),o.push(p.yylloc),n.push(S[1]),x=null,b?(x=b,b=null):(c=p.yyleng,s=p.yytext,l=p.yylineno,y=p.yylloc,u>0&&u--);break;case 2:if(A=this.productions_[S[1]][1],T.$=i[i.length-A],T._$={first_line:o[o.length-(A||1)].first_line,last_line:o[o.length-1].last_line,first_column:o[o.length-(A||1)].first_column,last_column:o[o.length-1].last_column},_&&(T._$.range=[o[o.length-(A||1)].range[0],o[o.length-1].range[1]]),void 0!==(C=this.performAction.apply(T,[s,c,l,m.yy,S[1],i,o].concat(f))))return C;A&&(n=n.slice(0,-1*A*2),i=i.slice(0,-1*A),o=o.slice(0,-1*A)),n.push(this.productions_[S[1]][0]),i.push(T.$),o.push(T._$),E=a[n[n.length-2]][n[n.length-1]],n.push(E);break;case 3:return!0}}return!0}},ge={EOF:1,parseError:function(e,t){if(!this.yy.parser)throw new Error(e);this.yy.parser.parseError(e,t)},setInput:function(e,t){return this.yy=t||this.yy||{},this._input=e,this._more=this._backtrack=this.done=!1,this.yylineno=this.yyleng=0,this.yytext=this.matched=this.match="",this.conditionStack=["INITIAL"],this.yylloc={first_line:1,first_column:0,last_line:1,last_column:0},this.options.ranges&&(this.yylloc.range=[0,0]),this.offset=0,this},input:function(){var e=this._input[0];return this.yytext+=e,this.yyleng++,this.offset++,this.match+=e,this.matched+=e,e.match(/(?:\r\n?|\n).*/g)?(this.yylineno++,this.yylloc.last_line++):this.yylloc.last_column++,this.options.ranges&&this.yylloc.range[1]++,this._input=this._input.slice(1),e},unput:function(e){var t=e.length,n=e.split(/(?:\r\n?|\n)/g);this._input=e+this._input,this.yytext=this.yytext.substr(0,this.yytext.length-t),this.offset-=t;var r=this.match.split(/(?:\r\n?|\n)/g);this.match=this.match.substr(0,this.match.length-1),this.matched=this.matched.substr(0,this.matched.length-1),n.length-1&&(this.yylineno-=n.length-1);var i=this.yylloc.range;return this.yylloc={first_line:this.yylloc.first_line,last_line:this.yylineno+1,first_column:this.yylloc.first_column,last_column:n?(n.length===r.length?this.yylloc.first_column:0)+r[r.length-n.length].length-n[0].length:this.yylloc.first_column-t},this.options.ranges&&(this.yylloc.range=[i[0],i[0]+this.yyleng-t]),this.yyleng=this.yytext.length,this},more:function(){return this._more=!0,this},reject:function(){return this.options.backtrack_lexer?(this._backtrack=!0,this):this.parseError("Lexical error on line "+(this.yylineno+1)+". You can only invoke reject() in the lexer when the lexer is of the backtracking persuasion (options.backtrack_lexer = true).\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},less:function(e){this.unput(this.match.slice(e))},pastInput:function(){var e=this.matched.substr(0,this.matched.length-this.match.length);return(e.length>20?"...":"")+e.substr(-20).replace(/\n/g,"")},upcomingInput:function(){var e=this.match;return e.length<20&&(e+=this._input.substr(0,20-e.length)),(e.substr(0,20)+(e.length>20?"...":"")).replace(/\n/g,"")},showPosition:function(){var e=this.pastInput(),t=new Array(e.length+1).join("-");return e+this.upcomingInput()+"\n"+t+"^"},test_match:function(e,t){var n,r,i;if(this.options.backtrack_lexer&&(i={yylineno:this.yylineno,yylloc:{first_line:this.yylloc.first_line,last_line:this.last_line,first_column:this.yylloc.first_column,last_column:this.yylloc.last_column},yytext:this.yytext,match:this.match,matches:this.matches,matched:this.matched,yyleng:this.yyleng,offset:this.offset,_more:this._more,_input:this._input,yy:this.yy,conditionStack:this.conditionStack.slice(0),done:this.done},this.options.ranges&&(i.yylloc.range=this.yylloc.range.slice(0))),(r=e[0].match(/(?:\r\n?|\n).*/g))&&(this.yylineno+=r.length),this.yylloc={first_line:this.yylloc.last_line,last_line:this.yylineno+1,first_column:this.yylloc.last_column,last_column:r?r[r.length-1].length-r[r.length-1].match(/\r?\n?/)[0].length:this.yylloc.last_column+e[0].length},this.yytext+=e[0],this.match+=e[0],this.matches=e,this.yyleng=this.yytext.length,this.options.ranges&&(this.yylloc.range=[this.offset,this.offset+=this.yyleng]),this._more=!1,this._backtrack=!1,this._input=this._input.slice(e[0].length),this.matched+=e[0],n=this.performAction.call(this,this.yy,this,t,this.conditionStack[this.conditionStack.length-1]),this.done&&this._input&&(this.done=!1),n)return n;if(this._backtrack){for(var o in i)this[o]=i[o];return!1}return!1},next:function(){if(this.done)return this.EOF;var e,t,n,r;this._input||(this.done=!0),this._more||(this.yytext="",this.match="");for(var i=this._currentRules(),o=0;o<i.length;o++)if((n=this._input.match(this.rules[i[o]]))&&(!t||n[0].length>t[0].length)){if(t=n,r=o,this.options.backtrack_lexer){if(!1!==(e=this.test_match(n,i[o])))return e;if(this._backtrack){t=!1;continue}return!1}if(!this.options.flex)break}return t?!1!==(e=this.test_match(t,i[r]))&&e:""===this._input?this.EOF:this.parseError("Lexical error on line "+(this.yylineno+1)+". Unrecognized text.\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},lex:function(){var e=this.next();return e||this.lex()},begin:function(e){this.conditionStack.push(e)},popState:function(){return this.conditionStack.length-1>0?this.conditionStack.pop():this.conditionStack[0]},_currentRules:function(){return this.conditionStack.length&&this.conditionStack[this.conditionStack.length-1]?this.conditions[this.conditionStack[this.conditionStack.length-1]].rules:this.conditions.INITIAL.rules},topState:function(e){return(e=this.conditionStack.length-1-Math.abs(e||0))>=0?this.conditionStack[e]:"INITIAL"},pushState:function(e){this.begin(e)},stateStackSize:function(){return this.conditionStack.length},options:{"case-insensitive":!0},performAction:function(e,t,n,r){switch(n){case 0:break;case 1:case 2:return"";case 3:return 42;case 4:return 35;case 5:return 77;case 6:case 7:return 78;case 8:return 8;case 9:return 6;case 10:return 82;case 11:return 7;case 12:return 9;case 13:return 59;case 14:return 13;case 15:return 15;case 16:return 17;case 17:return 18;case 18:return 19;case 19:return 20;case 20:return 11;case 21:return 62;case 22:return 64;case 23:return 23;case 24:return 25;case 25:return 26;case 26:return 27;case 27:return 30;case 28:return 34;case 29:return 33;case 30:return 65;case 31:return 66;case 32:return 37;case 33:return 41;case 34:return 43;case 35:return 52;case 36:return 54;case 37:return 55;case 38:return 46;case 39:return 48;case 40:return 45;case 41:return 49;case 42:return 56;case 43:return 58;case 44:return 44;case 45:return 83;case 46:return 84;case 47:return 85;case 48:return 86;case 49:return 87;case 50:return 88;case 51:return 89;case 52:return 90;case 53:return 91;case 54:return 92;case 55:return 93;case 56:return 94;case 57:return 95;case 58:case 59:return 70;case 60:case 61:return 72;case 62:case 63:case 64:return 74;case 65:return 31;case 66:return 36;case 67:return 96;case 68:return 97;case 69:return 98;case 70:return 99;case 71:return t.yytext=e.utils.unquoteString(t.yytext),14;case 72:return 38;case 73:return 5;case 74:return 101;case 75:return 103;case 76:return"\\";case 77:return 28;case 78:return 61;case 79:return 29;case 80:return 57;case 81:return 71}},rules:[/^(?:\s+)/i,/^(?:[#].*)/i,/^(?:\/\/.*)/i,/^(?:([_A-Z0-9\/\+]+==))/i,/^(?:-?[0-9]+(\.[0-9]+)?\b)/i,/^(?:0[xX][0-9A-F]+\b)/i,/^(?:false\b)/i,/^(?:true\b)/i,/^(?:all\b)/i,/^(?:reset\b)/i,/^(?:clear\b)/i,/^(?:build\b)/i,/^(?:help\b)/i,/^(?:load\b)/i,/^(?:get\b)/i,/^(?:set\b)/i,/^(?:set_save\b)/i,/^(?:set_restore\b)/i,/^(?:set_reset\b)/i,/^(?:preset\b)/i,/^(?:motm\b)/i,/^(?:add\b)/i,/^(?:rep\b)/i,/^(?:remove\b)/i,/^(?:hide\b)/i,/^(?:show\b)/i,/^(?:list\b)/i,/^(?:select\b)/i,/^(?:within\b)/i,/^(?:selector\b)/i,/^(?:mode\b)/i,/^(?:color\b)/i,/^(?:material\b)/i,/^(?:view\b)/i,/^(?:unit\b)/i,/^(?:line\b)/i,/^(?:listobj\b)/i,/^(?:removeobj\b)/i,/^(?:rotate\b)/i,/^(?:translate\b)/i,/^(?:scale\b)/i,/^(?:center\b)/i,/^(?:url\b)/i,/^(?:screenshot\b)/i,/^(?:dssp\b)/i,/^(?:file_list\b)/i,/^(?:file_register\b)/i,/^(?:file_delete\b)/i,/^(?:preset_add\b)/i,/^(?:preset_delete\b)/i,/^(?:preset_update\b)/i,/^(?:preset_rename\b)/i,/^(?:preset_open\b)/i,/^(?:create_scenario\b)/i,/^(?:reset_scenario\b)/i,/^(?:delete_scenario\b)/i,/^(?:add_scenario_item\b)/i,/^(?:list_scenario\b)/i,/^(?:s\b)/i,/^(?:mt\b)/i,/^(?:m\b)/i,/^(?:c\b)/i,/^(?:x\b)/i,/^(?:y\b)/i,/^(?:z\b)/i,/^(?:as\b)/i,/^(?:of\b)/i,/^(?:pdb\b)/i,/^(?:delay\b)/i,/^(?:prst\b)/i,/^(?:desc\b)/i,/^(?:((?:"(?:\\.|[^\\"])*"|'(?:\\.|[^\\'])*')))/i,/^(?:([_A-Z0-9]+))/i,/^(?:$)/i,/^(?:\.)/i,/^(?:\/)/i,/^(?:\\)/i,/^(?:-e\b)/i,/^(?:-f\b)/i,/^(?:-s\b)/i,/^(?:-v\b)/i,/^(?:=)/i],conditions:{INITIAL:{rules:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81],inclusive:!0}}};function xe(){this.yy={}}return _e.lexer=ge,xe.prototype=_e,_e.Parser=xe,new xe}();e.exports={parser:n}},"4oJk":function(e,t){var n=function(){var e=function(e,t,n,r){for(n=n||{},r=e.length;r--;n[e[r]]=t);return n},t=[1,4],n=[1,5],r=[1,6],i=[1,7],o=[1,8],a=[1,9],s=[1,11],l=[1,12],c=[5,7,8,11],u=[1,17],h=[1,22],d=[1,20],f=[1,21],p=[5,7,8,11,19],m={trace:function(){},yy:{},symbols_:{error:2,Program:3,Expression:4,EOF:5,Selector:6,OR:7,AND:8,NOT:9,"(":10,")":11,SELECTOR:12,NAMED_SELECTOR:13,SELECTOR_RANGED:14,RangeList:15,SELECTOR_NAMED:16,NameList:17,Range:18,",":19,NUMBER:20,":":21,Name:22,IDENTIFIER:23,STRING:24,$accept:0,$end:1},terminals_:{2:"error",5:"EOF",7:"OR",8:"AND",9:"NOT",10:"(",11:")",12:"SELECTOR",13:"NAMED_SELECTOR",14:"SELECTOR_RANGED",16:"SELECTOR_NAMED",19:",",20:"NUMBER",21:":",23:"IDENTIFIER",24:"STRING"},productions_:[0,[3,2],[4,1],[4,3],[4,3],[4,2],[4,3],[6,1],[6,1],[6,2],[6,2],[15,1],[15,3],[18,1],[18,3],[17,1],[17,3],[22,1],[22,1],[22,1]],performAction:function(e,t,n,r,i,o,a){var s=o.length-1;switch(i){case 1:return o[s-1];case 3:this.$=r.keyword("or")(o[s-2],o[s]);break;case 4:this.$=r.keyword("and")(o[s-2],o[s]);break;case 5:this.$=r.keyword("not")(o[s]);break;case 6:this.$=o[s-1];break;case 7:this.$=r.keyword(o[s])();break;case 8:this.$=r.GetSelector(o[s].toLowerCase().slice(1,o[s].length));break;case 9:case 10:this.$=r.keyword(o[s-1])(o[s]);break;case 11:this.$=new r.RangeList(o[s]);break;case 12:case 16:this.$=o[s-2].append(o[s]);break;case 13:this.$=new r.Range(Number(o[s]));break;case 14:this.$=new r.Range(Number(o[s-2]),Number(o[s]));break;case 15:this.$=new r.ValueList(o[s])}},table:[{3:1,4:2,6:3,9:t,10:n,12:r,13:i,14:o,16:a},{1:[3]},{5:[1,10],7:s,8:l},e(c,[2,2]),{4:13,6:3,9:t,10:n,12:r,13:i,14:o,16:a},{4:14,6:3,9:t,10:n,12:r,13:i,14:o,16:a},e(c,[2,7]),e(c,[2,8]),{15:15,18:16,20:u},{17:18,20:h,22:19,23:d,24:f},{1:[2,1]},{4:23,6:3,9:t,10:n,12:r,13:i,14:o,16:a},{4:24,6:3,9:t,10:n,12:r,13:i,14:o,16:a},e(c,[2,5]),{7:s,8:l,11:[1,25]},e(c,[2,9],{19:[1,26]}),e(p,[2,11]),e(p,[2,13],{21:[1,27]}),e(c,[2,10],{19:[1,28]}),e(p,[2,15]),e(p,[2,17]),e(p,[2,18]),e(p,[2,19]),e([5,7,11],[2,3],{8:l}),e(c,[2,4]),e(c,[2,6]),{18:29,20:u},{20:[1,30]},{20:h,22:31,23:d,24:f},e(p,[2,12]),e(p,[2,14]),e(p,[2,16])],defaultActions:{10:[2,1]},parseError:function(e,t){if(!t.recoverable){var n=new Error(e);throw n.hash=t,n}this.trace(e)},parse:function(e){var t=this,n=[0],r=[],i=[null],o=[],a=this.table,s="",l=0,c=0,u=0,h=2,d=1,f=o.slice.call(arguments,1),p=Object.create(this.lexer),m={yy:{}};for(var v in this.yy)Object.prototype.hasOwnProperty.call(this.yy,v)&&(m.yy[v]=this.yy[v]);p.setInput(e,m.yy),m.yy.lexer=p,m.yy.parser=this,void 0===p.yylloc&&(p.yylloc={});var y=p.yylloc;o.push(y);var _=p.options&&p.options.ranges;function g(){var e;return"number"!=typeof(e=r.pop()||p.lex()||d)&&(e instanceof Array&&(e=(r=e).pop()),e=t.symbols_[e]||e),e}"function"==typeof m.yy.parseError?this.parseError=m.yy.parseError:this.parseError=Object.getPrototypeOf(this).parseError;for(var x,b,w,S,C,R,A,E,k,T={};;){if(w=n[n.length-1],this.defaultActions[w]?S=this.defaultActions[w]:(null==x&&(x=g()),S=a[w]&&a[w][x]),void 0===S||!S.length||!S[0]){var P="";for(R in k=[],a[w])this.terminals_[R]&&R>h&&k.push("'"+this.terminals_[R]+"'");P=p.showPosition?"Parse error on line "+(l+1)+":\n"+p.showPosition()+"\nExpecting "+k.join(", ")+", got '"+(this.terminals_[x]||x)+"'":"Parse error on line "+(l+1)+": Unexpected "+(x==d?"end of input":"'"+(this.terminals_[x]||x)+"'"),this.parseError(P,{text:p.match,token:this.terminals_[x]||x,line:p.yylineno,loc:y,expected:k})}if(S[0]instanceof Array&&S.length>1)throw new Error("Parse Error: multiple actions possible at state: "+w+", token: "+x);switch(S[0]){case 1:n.push(x),i.push(p.yytext),o.push(p.yylloc),n.push(S[1]),x=null,b?(x=b,b=null):(c=p.yyleng,s=p.yytext,l=p.yylineno,y=p.yylloc,u>0&&u--);break;case 2:if(A=this.productions_[S[1]][1],T.$=i[i.length-A],T._$={first_line:o[o.length-(A||1)].first_line,last_line:o[o.length-1].last_line,first_column:o[o.length-(A||1)].first_column,last_column:o[o.length-1].last_column},_&&(T._$.range=[o[o.length-(A||1)].range[0],o[o.length-1].range[1]]),void 0!==(C=this.performAction.apply(T,[s,c,l,m.yy,S[1],i,o].concat(f))))return C;A&&(n=n.slice(0,-1*A*2),i=i.slice(0,-1*A),o=o.slice(0,-1*A)),n.push(this.productions_[S[1]][0]),i.push(T.$),o.push(T._$),E=a[n[n.length-2]][n[n.length-1]],n.push(E);break;case 3:return!0}}return!0}},v={EOF:1,parseError:function(e,t){if(!this.yy.parser)throw new Error(e);this.yy.parser.parseError(e,t)},setInput:function(e,t){return this.yy=t||this.yy||{},this._input=e,this._more=this._backtrack=this.done=!1,this.yylineno=this.yyleng=0,this.yytext=this.matched=this.match="",this.conditionStack=["INITIAL"],this.yylloc={first_line:1,first_column:0,last_line:1,last_column:0},this.options.ranges&&(this.yylloc.range=[0,0]),this.offset=0,this},input:function(){var e=this._input[0];return this.yytext+=e,this.yyleng++,this.offset++,this.match+=e,this.matched+=e,e.match(/(?:\r\n?|\n).*/g)?(this.yylineno++,this.yylloc.last_line++):this.yylloc.last_column++,this.options.ranges&&this.yylloc.range[1]++,this._input=this._input.slice(1),e},unput:function(e){var t=e.length,n=e.split(/(?:\r\n?|\n)/g);this._input=e+this._input,this.yytext=this.yytext.substr(0,this.yytext.length-t),this.offset-=t;var r=this.match.split(/(?:\r\n?|\n)/g);this.match=this.match.substr(0,this.match.length-1),this.matched=this.matched.substr(0,this.matched.length-1),n.length-1&&(this.yylineno-=n.length-1);var i=this.yylloc.range;return this.yylloc={first_line:this.yylloc.first_line,last_line:this.yylineno+1,first_column:this.yylloc.first_column,last_column:n?(n.length===r.length?this.yylloc.first_column:0)+r[r.length-n.length].length-n[0].length:this.yylloc.first_column-t},this.options.ranges&&(this.yylloc.range=[i[0],i[0]+this.yyleng-t]),this.yyleng=this.yytext.length,this},more:function(){return this._more=!0,this},reject:function(){return this.options.backtrack_lexer?(this._backtrack=!0,this):this.parseError("Lexical error on line "+(this.yylineno+1)+". You can only invoke reject() in the lexer when the lexer is of the backtracking persuasion (options.backtrack_lexer = true).\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},less:function(e){this.unput(this.match.slice(e))},pastInput:function(){var e=this.matched.substr(0,this.matched.length-this.match.length);return(e.length>20?"...":"")+e.substr(-20).replace(/\n/g,"")},upcomingInput:function(){var e=this.match;return e.length<20&&(e+=this._input.substr(0,20-e.length)),(e.substr(0,20)+(e.length>20?"...":"")).replace(/\n/g,"")},showPosition:function(){var e=this.pastInput(),t=new Array(e.length+1).join("-");return e+this.upcomingInput()+"\n"+t+"^"},test_match:function(e,t){var n,r,i;if(this.options.backtrack_lexer&&(i={yylineno:this.yylineno,yylloc:{first_line:this.yylloc.first_line,last_line:this.last_line,first_column:this.yylloc.first_column,last_column:this.yylloc.last_column},yytext:this.yytext,match:this.match,matches:this.matches,matched:this.matched,yyleng:this.yyleng,offset:this.offset,_more:this._more,_input:this._input,yy:this.yy,conditionStack:this.conditionStack.slice(0),done:this.done},this.options.ranges&&(i.yylloc.range=this.yylloc.range.slice(0))),(r=e[0].match(/(?:\r\n?|\n).*/g))&&(this.yylineno+=r.length),this.yylloc={first_line:this.yylloc.last_line,last_line:this.yylineno+1,first_column:this.yylloc.last_column,last_column:r?r[r.length-1].length-r[r.length-1].match(/\r?\n?/)[0].length:this.yylloc.last_column+e[0].length},this.yytext+=e[0],this.match+=e[0],this.matches=e,this.yyleng=this.yytext.length,this.options.ranges&&(this.yylloc.range=[this.offset,this.offset+=this.yyleng]),this._more=!1,this._backtrack=!1,this._input=this._input.slice(e[0].length),this.matched+=e[0],n=this.performAction.call(this,this.yy,this,t,this.conditionStack[this.conditionStack.length-1]),this.done&&this._input&&(this.done=!1),n)return n;if(this._backtrack){for(var o in i)this[o]=i[o];return!1}return!1},next:function(){if(this.done)return this.EOF;var e,t,n,r;this._input||(this.done=!0),this._more||(this.yytext="",this.match="");for(var i=this._currentRules(),o=0;o<i.length;o++)if((n=this._input.match(this.rules[i[o]]))&&(!t||n[0].length>t[0].length)){if(t=n,r=o,this.options.backtrack_lexer){if(!1!==(e=this.test_match(n,i[o])))return e;if(this._backtrack){t=!1;continue}return!1}if(!this.options.flex)break}return t?!1!==(e=this.test_match(t,i[r]))&&e:""===this._input?this.EOF:this.parseError("Lexical error on line "+(this.yylineno+1)+". Unrecognized text.\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},lex:function(){var e=this.next();return e||this.lex()},begin:function(e){this.conditionStack.push(e)},popState:function(){return this.conditionStack.length-1>0?this.conditionStack.pop():this.conditionStack[0]},_currentRules:function(){return this.conditionStack.length&&this.conditionStack[this.conditionStack.length-1]?this.conditions[this.conditionStack[this.conditionStack.length-1]].rules:this.conditions.INITIAL.rules},topState:function(e){return(e=this.conditionStack.length-1-Math.abs(e||0))>=0?this.conditionStack[e]:"INITIAL"},pushState:function(e){this.begin(e)},stateStackSize:function(){return this.conditionStack.length},options:{"case-insensitive":!0},performAction:function(e,t,n,r){switch(n){case 0:break;case 1:return 20;case 2:return 7;case 3:return 8;case 4:return 9;case 5:return 12;case 6:return 16;case 7:return 14;case 8:return 10;case 9:return 11;case 10:return 19;case 11:return 21;case 12:return"<=";case 13:return">=";case 14:return"<";case 15:return">";case 16:return t.yytext=t.yytext.substr(1,t.yyleng-2),24;case 17:return 13;case 18:return 23;case 19:return 5;case 20:return"INVALID"}},rules:[/^(?:\s+)/i,/^(?:(-?(?:[1-9][0-9]+|[0-9]))\b)/i,/^(?:OR\b)/i,/^(?:AND\b)/i,/^(?:NOT\b)/i,/^(?:((ALL|NONE|HETATM|PROTEIN|BASIC|ACIDIC|CHARGED|POLAR|NONPOLAR|AROMATIC|NUCLEIC|PURINE|PYRIMIDINE|WATER|POLARH|NONPOLARH))\b)/i,/^(?:((NAME|ELEM|TYPE|RESIDUE|ICODE|CHAIN|ALTLOC))\b)/i,/^(?:((SERIAL|SEQUENCE|RESIDX))\b)/i,/^(?:\()/i,/^(?:\))/i,/^(?:,)/i,/^(?::)/i,/^(?:<=)/i,/^(?:>=)/i,/^(?:<)/i,/^(?:>)/i,/^(?:((?:"(?:\\.|[^\\"])*"|'(?:\\.|[^\\'])*')))/i,/^(?:(@[_A-Z0-9]+))/i,/^(?:([_A-Z0-9]+))/i,/^(?:$)/i,/^(?:.)/i],conditions:{INITIAL:{rules:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20],inclusive:!0}}};function y(){this.yy={}}return m.lexer=v,y.prototype=m,m.Parser=y,new y}();e.exports={parser:n}},mDBS:function(e,t,n){},xGHL:function(e,t,n){"use strict";n.r(t);n("MvBf"),n("Gwlr"),n("FZrZ"),n("dqOz"),n("mDBS"),n("Z2U/");var r,i=n("GtyH"),o=n.n(i),a=n("VHX9"),s=n.n(a),l=n("ddV6"),c=n.n(l),u=n("nsO7"),h=n.n(u),d=n("i8eK"),f=n("Ufoz"),p=n("VrFO"),m=n.n(p),v=n("Y9Ll"),y=n.n(v),_=function(){function e(){m()(this,e),this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}return y()(e,[{key:"start",value:function(){this.startTime=e.now(),this.oldTime=this.startTime,this.running=!0}},{key:"stop",value:function(){this.getElapsedTime(),this.running=!1}},{key:"getElapsedTime",value:function(){return this.update(),this.elapsedTime}},{key:"update",value:function(){var t=0;if(this.running){var n=e.now();t=.001*(n-this.oldTime),this.oldTime=n,this.elapsedTime+=t}return t}}]),e}();_.now=(r="undefined"!=typeof window&&window.performance)&&r.now?r.now.bind(r):Date.now;var g=_.now;function x(e,t,n){var r=document.createElement(e);return r.id=t,r.style.cssText=n,r}var b=function(){function e(){m()(this,e),this.domElement=x("div","stats","padding:8px"),this._text=x("p","fps","margin:0;color:silver;font-size:large"),this.domElement.appendChild(this._text),this._startTime=g(),this._prevTime=this._startTime,this._deltas=new Array(20),this._index=0,this._total=0,this._count=0}return y()(e,[{key:"end",value:function(){var e=g(),t=e-this._startTime;return this._count<this._deltas.length?this._count++:this._total-=this._deltas[this._index],this._total+=t,this._deltas[this._index]=t,this._index=(this._index+1)%this._deltas.length,this.ms=this._total/this._count,this.fps=1e3/this.ms,e>this._prevTime+1e3&&(this._text.textContent=this.fps.toPrecision(2),this._prevTime=e),e}},{key:"update",value:function(){this._startTime=this.end()}},{key:"show",value:function(e){void 0===e&&(e=!0),this.domElement.style.display=e?"block":"none"}}]),e}(),w=n("5Yy7"),S=n.n(w),C=n("N+ot"),R=n.n(C),A=n("AuHH"),E=n.n(A),k=n("mAxt"),T=n.n(k);function P(e,t){return!e||e===t}function M(){this._handlers={}}M.prototype.addEventListener=function(e,t,n){var r=this._handlers[e];r||(this._handlers[e]=[],r=this._handlers[e]);var i=[t,n];void 0===h.a.find(r,(function(e){return e[0]===i[0]&&e[1]===i[1]}))&&r.push(i)},M.prototype.removeEventListener=function(e,t,n){var r=this;h.a.forEach(r._handlers,(function(i,o){h.a.remove(i,(function(i){return P(e,o)&&P(t,i[0])&&P(n,i[1]||r)}))})),this._handlers=h.a.omitBy(r._handlers,(function(e){return 0===e.length}))},M.prototype.dispatchEvent=function(e){var t=this;h.a.forEach(this._handlers[e.type],(function(n){var r=n[1]||t;n[0].apply(r,[e])}))};var I=M,N={debug:0,info:1,report:2,warn:3,error:4};function L(){I.call(this),this.console=!1,this._priority=N.warn}function D(e){if(!h.a.isNumber(e))throw new Error("Wrong log level specified!");return e}L.prototype=Object.create(I.prototype),L.prototype.constructor=L,L.prototype.instantiate=function(){return new L},Object.defineProperty(L.prototype,"level",{get:function(){var e=this;return h.a.findKey(N,(function(t){return t===e._priority}))},set:function(e){this._priority=D(N[e])}}),L.prototype.levels=function(){return Object.keys(N)},L.prototype.message=function(e,t){var n=D(N[e]);this._message(n,t)},L.prototype.debug=function(e){this._message(N.debug,e)},L.prototype.info=function(e){this._message(N.info,e)},L.prototype.report=function(e){this._message(N.report,e)},L.prototype.warn=function(e){this._message(N.warn,e)},L.prototype.error=function(e){this._message(N.error,e)},L.prototype._message=function(e,t){if(!(e<this._priority)){var n=h.a.findKey(N,(function(t){return t===e}));if(t=String(t),this.console){var r="miew:".concat(n,": ").concat(t);"error"===n?console.error(r):"warn"===n?console.warn(r):console.log(r)}this.dispatchEvent({type:"message",level:n,message:t})}};var O=new L;function V(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var z={DEFAULT:0,SAFARI:1};function F(e){return decodeURIComponent(e.replace(/\+/g," "))}function B(e){for(var t,n=(e=e||window.location.search).substring(e.indexOf("?")+1),r=/([^&=]+)=?([^&]*)/g,i=[];null!==(t=r.exec(n));)i.push([F(t[1]),F(t[2])]);return i}function U(e){var t=!1;this.enable=function(e){t=e};var n=0,r=Object.keys(e);function i(e,r){return function(){var i=U.spaces.substr(0,2*n);t&&O.debug("".concat(i+r," {")),n++;for(var o=arguments.length,a=new Array(o),s=0;s<o;s++)a[s]=arguments[s];var l=e.apply(this,a);return n--,t&&O.debug("".concat(i,"} // ").concat(r)),l}}for(var o=0,a=r.length;o<a;++o){var s=r[o],l=e[s];l instanceof Function&&"constructor"!==s&&(e[s]=i(l,s))}}U.spaces="                                                                                          ";var G=function(e){S()(n,e);var t=V(n);function n(e){var r;return m()(this,n),(r=t.call(this)).name="OutOfMemoryError",r.message=e,r}return n}(T()(Error));function j(e){for(var t=new Uint8Array(e),n="",r=0;r<t.byteLength;r++)n+=String.fromCharCode(t[r]);return window.btoa(n)}function H(e){for(var t=window.atob(e),n=new Uint8Array(t.length),r=0;r<n.length;++r)n[r]=t[r].charCodeAt(0);return n.buffer}function W(e){if(h.a.isPlainObject(e))return!0;var t=e&&Object.getPrototypeOf(e);return!!t&&!t.hasOwnProperty("constructor")&&W(t)}function Y(e){return e.slice(Math.max(0,e.lastIndexOf("."))||1/0)}function q(e){var t=e.split(/[:;,]/),n=t.length;return n>=3&&"base64"===t[n-2]?new Blob([H(t[n-1])]):null}var X=/^[a-zA-Z0-9_]*$/,$=['"',"",'"'];var K={browserType:z,encodeQueryComponent:function(e,t){return encodeURIComponent(e).replace(t,(function(e){return String.fromCharCode(parseInt(e.substr(1),16))})).replace(/%20/g,"+")},decodeQueryComponent:F,getUrlParameters:B,getUrlParametersAsDict:function(e){for(var t={},n=B(e),r=0;r<n.length;++r){var i=c()(n[r],2),o=i[0],a=i[1];t[o]=a}return t},resolveURL:function(e){if("undefined"!=typeof URL)try{return"undefined"!=typeof window?new URL(e,window.location).href:new URL(e).href}catch(e){}if("undefined"!=typeof document){var t=document.createElement("a");return t.href=e,t.href}return e},generateRegExp:function(e){for(var t=[],n=0,r=e.length;n<r;++n)t[t.length]=e[n].charCodeAt(0).toString(16);var i=t.join("|");return new RegExp("%(?:".concat(i,")"),"gi")},createElement:function(e,t,n){var r,i,o=document.createElement(e);if(t){var a=Object.keys(t);for(r=0,i=a.length;r<i;++r){var s=a[r];o.setAttribute(s,t[s])}}if(n)for(n instanceof Array||(n=[n]),r=0,i=n.length;r<i;++r){var l=n[r];"string"==typeof l?o.appendChild(document.createTextNode(l)):l instanceof HTMLElement&&o.appendChild(l)}return o},deriveClass:function(e,t,n,r){return e.prototype=h.a.assign(Object.create(t.prototype),{constructor:e},n),r&&h.a.assign(e,r),e},deriveDeep:function e(t,n){var r,i,o=t;if(t instanceof Array)for(o=new Array(t.length),r=0,i=t.length;r<i;++r)o[r]=e(t[r]);else if(t instanceof Object){o=Object.create(t);var a=Object.keys(t);for(r=0,i=a.length;r<i;++r){var s=a[r],l=t[s],c=e(l);c!==l&&(o[s]=c)}n&&Object.keys(o).length>0&&(o=Object.create(o))}return o},hexColor:function(e){var t="0000000".concat(e.toString(16)).substr(-6);return"#".concat(t)},DebugTracer:U,OutOfMemoryError:G,allocateTyped:function(e,t){var n=null;try{n=new e(t)}catch(e){throw e instanceof RangeError?new G(e.message):e}return n},bytesFromBase64:H,bytesToBase64:j,arrayFromBase64:function(e,t){return Array.prototype.slice.call(new t(H(e)))},arrayToBase64:function(e,t){return j(new t(e).buffer)},compareOptionsWithDefaults:function(e,t){var n=[];if(t&&e){for(var r=Object.keys(e),i=0;i<r.length;++i){var o=r[i],a=e[o];a instanceof Object||void 0===t[o]||t[o]===a||n.push("".concat(o,":").concat(a))}if(n.length>0)return"!".concat(n.join())}return""},objectsDiff:function e(t,n){var r={};return h.a.forIn(t,(function(t,i){var o=n[i];if(W(t)&&W(o)){var a=e(t,o);h.a.isEmpty(a)||(r[i]=a)}else h.a.isEqual(t,o)||(r[i]=t)})),r},forInRecursive:function(e,t){!function e(n,r){h.a.forIn(n,(function(n,i){var o=r+(r.length>0?".":"");n instanceof Object?e(n,o+i):void 0!==n&&t(n,o+i)}))}(e,"")},enquoteString:function(e){return h.a.isString(e)?'"'.concat(e.replace(/"/g,'\\"'),'"'):e},unquoteString:function(e){if(!h.a.isString(e))return e;if('"'===e[0]&&'"'===e[e.length-1])return(e=e.slice(1,e.length-1)).replace(/\\"/g,'"');if("'"===e[0]&&"'"===e[e.length-1])return(e=e.slice(1,e.length-1)).replace(/\\'/g,"'");throw new SyntaxError("Incorrect string format, can't unqute it")},getBrowser:function(){return navigator.vendor&&navigator.vendor.indexOf("Apple")>-1&&navigator.userAgent&&-1===navigator.userAgent.indexOf("CriOS")&&-1===navigator.userAgent.indexOf("FxiOS")?z.SAFARI:z.DEFAULT},shotOpen:function(e){"undefined"!=typeof window&&window.open().document.write('<body style="margin:0"><img src="'.concat(e,'" /></body>'))},shotDownload:function(e,t){if(e&&"data:"===e.substr(0,5))if(t||(t=["screenshot-",+new Date,".png"].join("")),"undefined"!=typeof window&&window.navigator&&window.navigator.msSaveBlob)window.navigator.msSaveBlob(q(e),t);else if("undefined"!=typeof document){var n=document.createElement("a");n.download=t,n.innerHTML="download",n.href=window.URL.createObjectURL(q(e)),document.body.appendChild(n),n.click(),document.body.removeChild(n)}},copySubArrays:function(e,t,n,r){for(var i=0,o=n.length;i<o;++i)for(var a=0;a<r;++a)t[i*r+a]=e[n[i]*r+a]},shallowCloneNode:function(e){var t=e.cloneNode(!0);return t.worldPos=e.worldPos,t},correctSelectorIdentifier:function(e){return X.test(e)?e:($[1]=e,$.join(""))},getFileExtension:Y,splitFileName:function(e){var t=Y(e);return[e.slice(0,e.length-t.length),t]},download:function(e,t,n){var r=new Blob([e]);if(t||(t=["data",+new Date].join("")),t+=n?".".concat(n):r.type||".bin","undefined"!=typeof window&&window.navigator&&window.navigator.msSaveBlob)window.navigator.msSaveBlob(r,t);else if("undefined"!=typeof document){var i=document.createElement("a");i.download=t,i.innerHTML="download",i.href=window.URL.createObjectURL(r),document.body.appendChild(i),i.click(),document.body.removeChild(i)}},concatTypedArraysUnsafe:function(e,t){var n=new e.constructor(e.length+t.length);return n.set(e),n.set(t,e.length),n},mergeTypedArraysUnsafe:function(e){if(e.length<=0)return null;for(var t=e.reduce((function(e,t){return e+t.length}),0),n=new e[0].constructor(t),r=0,i=0;r<e.length;r++){var o=e[r].length;n.set(e[r],i),i+=o}return n}};function Z(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var Q=function(e){S()(n,e);var t=Z(n);function n(){var e;return m()(this,n),(e=t.call(this))._shouldCancel=!1,e}return y()(n,[{key:"cancel",value:function(){this._shouldCancel=!0,this.dispatchEvent({type:"cancel"})}},{key:"shouldCancel",value:function(){return this._shouldCancel}},{key:"notify",value:function(e){this.dispatchEvent({type:"notification",slaveEvent:e})}}]),n}(I),J=n("T0aG"),ee=n.n(J),te={modes:{BS:{atom:.23,bond:.15,space:.5,multibond:!0,aromrad:.1,showarom:!0,polyComplexity:{poor:3,low:4,medium:6,high:12,ultra:32}},VW:{polyComplexity:{poor:4,low:6,medium:8,high:16,ultra:32}},LN:{multibond:!0,showarom:!0,offsarom:.2,chunkarom:10,atom:.23,lineWidth:2},LC:{bond:.2,space:0,multibond:!0,aromrad:.1,showarom:!0,polyComplexity:{poor:3,low:4,medium:6,high:12,ultra:32}},SA:{zClip:!1,probeRadius:1.5,subset:"",wireframe:!1,polyComplexity:{poor:6,low:8,medium:16,high:30,ultra:60}},SE:{zClip:!1,probeRadius:1.5,subset:"",wireframe:!1,polyComplexity:{poor:6,low:8,medium:16,high:30,ultra:60}},QS:{isoValue:.5,gaussLim:{poor:1.5,low:2,medium:2.5,high:3,ultra:4},scale:1,wireframe:!1,gridSpacing:{poor:2,low:1.5,medium:1,high:.5,ultra:.25},subset:"",zClip:!1},CS:{probeRadius:1.4,isoValue:1.5,wireframe:!1,probePositions:30,polyComplexity:{poor:.5,low:1,medium:1.5,high:1.75,ultra:2},subset:"",zClip:!1},TR:{radius:.3,polyComplexity:{poor:12,low:16,medium:32,high:64,ultra:64}},TU:{radius:.3,heightSegmentsRatio:1.5,tension:-.7,polyComplexity:{poor:4,low:6,medium:10,high:18,ultra:34}},CA:{radius:.3,depth:.25,ss:{helix:{width:1,arrow:2},strand:{width:1,arrow:2}},heightSegmentsRatio:1.5,tension:-.7,polyComplexity:{poor:4,low:6,medium:10,high:18,ultra:34}},TX:{template:"{{Chain}}.{{Residue}}{{Sequence}}.{{Name}}",horizontalAlign:"center",verticalAlign:"middle",dx:0,dy:0,dz:1,fg:"none",bg:"0x202020",showBg:!0},VD:{kSigma:1,kSigmaMed:2,kSigmaMax:4,frame:!0,isoMode:!1,polyComplexity:{poor:2,low:3,medium:4,high:8,ultra:10}}},colorers:{EL:{carbon:-1},UN:{color:16777215},CO:{subset:"charged",color:16711680,baseColor:16777215},CB:{color:9474192,factor:.6},SQ:{gradient:"rainbow"},TM:{gradient:"temp",min:5,max:40},OC:{gradient:"reds"},HY:{gradient:"blue-red"},MO:{gradient:"rainbow"}},antialias:!0,camFov:45,camNear:.5,camFar:100,camDistance:2.5,radiusToFit:1,fogNearFactor:.5,fogFarFactor:1,fogAlpha:1,fogColor:0,fogColorEnable:!1,palette:"JM",resolution:"medium",autoResolution:!1,autoPreset:!0,preset:"default",presets:{default:[{mode:"BS",colorer:"EL",selector:"all",material:"SF"}],empty:[],wire:[{mode:"LN",colorer:"EL",selector:"all",material:"SF"}],small:[{mode:"BS",colorer:"EL",selector:"all",material:"SF"}],macro:[{mode:"CA",colorer:"SS",selector:"not hetatm",material:"SF"},{mode:"BS",colorer:"EL",selector:"hetatm and not water",material:"SF"}]},objects:{line:{color:4294967295,dashSize:.3,gapSize:.05}},bg:{color:2105376,transparent:!1},draft:{clipPlane:!1,clipPlaneFactor:.5,clipPlaneSpeed:3e-5},plugins:{},axes:!0,fog:!0,fps:!0,zSprites:!0,isoSurfaceFakeOpacity:!0,suspendRender:!0,nowater:!1,autobuild:!0,fxaa:!0,outline:{on:!1,color:0,threshold:.1,thickness:1},ao:!1,shadow:{on:!1,type:"random",radius:1},autoRotation:0,maxfps:30,fbxprec:4,autoRotationAxisFixed:!0,zooming:!0,picking:!0,pick:"atom",editing:!1,aromatic:!1,singleUnit:!0,stereo:"NONE",interpolateViews:!0,transparency:"prepass",translationSpeed:2,debug:{example:3.5,text:"hello!",good:!0,ssaoKernelRadius:.7,ssaoFactor:.7,stereoBarrel:.25},use:{multiFile:!1}};function ne(){I.call(this),this.old=null,this.now={},this._changed={},this.reset()}K.deriveClass(ne,I,{defaults:te,set:function(e,t){if(h.a.isString(e)){h.a.get(this.now,e)!==t&&(h.a.set(this.now,e,t),this._notifyChange(e,t))}else{var n=K.objectsDiff(e,this.now);h.a.isEmpty(n)||(h.a.merge(this.now,n),this._notifyChanges(n))}},get:function(e,t){return h.a.get(this.now,e,t)},reset:function(){var e=K.objectsDiff(te,this.now);this.now=h.a.cloneDeep(te),this.old=null,this._notifyChanges(e),this._changed={}},checkpoint:function(){this.old=h.a.cloneDeep(this.now),this._changed={}},_notifyChange:function(e,t){this._changed[e]=!0,this.dispatchEvent({type:"change:".concat(e),value:t})},_notifyChanges:function(e){var t=this;K.forInRecursive(e,(function(e,n){t._notifyChange(n,e)}))},changed:function(){if(!this.old)return[];var e=this.old,t=this.now;return h.a.filter(Object.keys(this._changed),(function(n){return h.a.get(e,n)!==h.a.get(t,n)}))},applyDiffs:function(e){if(e.hasOwnProperty("VERSION")&&0!==e.VERSION)throw new Error("Settings version does not match!");delete e.VERSION,this.reset(),this.set(e)},getDiffs:function(e){var t=K.objectsDiff(this.now,te);return e&&(t.VERSION=0),t},setPluginOpts:function(e,t){te.plugins[e]=h.a.cloneDeep(t),this.now.plugins[e]=h.a.cloneDeep(t)}});var re=new ne,ie=0;function oe(e){return!(!e||"0"===e||h.a.isString(e)&&"false"===e.toLowerCase())}var ae={string:String,number:Number,boolean:oe};var se=K.generateRegExp("$;@/?:,");function le(e){return K.encodeQueryComponent(e,se)}var ce=K.generateRegExp("$;@/? ");function ue(e){return K.encodeQueryComponent(e,ce)}function he(e){var t=e.reps;if(!t){var n=re.now.presets,r=e.preset||re.now.preset;if(!(t=n[r])){O.warn('Unknown preset "'.concat(r,'"'));var i=Object.keys(n);t=n[r=c()(i,1)[0]]}e.preset=r,e.reps=K.deriveDeep(t,!0)}}function de(e,t,n){he(e);var r=e.reps[ie];r.hasOwnProperty(t)&&(ie=e.reps.length,e.reps[ie]=K.deriveDeep(r,!0)),void 0!==n&&(e.reps[ie][t]=n)}function fe(e,t,n){if(e){var r=e.indexOf("!"),i=function(e,t){var n=e.indexOf(",");return n>=0?(t.push(e.substr(n+1).split(",")),e.substr(0,n)):e}(e.substr(0,r>=0?r:void 0),n);if(r>=0){var o=e.substr(r+1).split(",");if(e=i,t){var a=t[e],s=K.deriveDeep(a,!0);o.forEach((function(t){var n=t.split(":",2),r=decodeURIComponent(n[0]),i=decodeURIComponent(n[1]),o=ae[ee()(h.a.get(a,r))];o?h.a.set(s,r,o(i)):O.warn('Unknown argument "'.concat(r,'" for option "').concat(e,'"'))})),Object.keys(s).length>0&&(e=[e,s])}}else e=i}return e}var pe={l:"load",load:String,t:"type",type:String,v:"view",view:String,u:"unit",unit:Number,menu:oe,o:"object",object:function(e,t){var n=[],r=fe(e,re.defaults.objects,n);Array.isArray(r)||(r=[r]),function(e,t,n){void 0===e._objects&&(e._objects=[]);var r=c()(n,2),i=r[0],o=r[1],a={type:i,params:t};void 0!==o&&(a.opts=o),e._objects[e._objects.length]=a}(t,n[0],r)},p:"preset",preset:function(e,t){t.preset=e,t.reps=null,he(t)},r:"rep",rep:function(e,t){he(t),(ie=(ie=Number(e))<=t.reps.length?ie<0?0:ie:t.reps.length)===t.reps.length&&(t.reps[ie]=ie>0?K.deriveDeep(t.reps[ie-1],!0):K.deriveDeep(re.defaults.presets.default[0],!0))},s:"select",select:function(e,t){de(t,"selector",e)},m:"mode",mode:function(e,t){de(t,"mode",fe(e,re.defaults.modes))},c:"color",color:function(e,t){de(t,"colorer",fe(e,re.defaults.colorers))},mt:"material",material:function(e,t){de(t,"material",fe(e,re.defaults.materials))},dup:function(e,t){he(t);var n=t.reps,r=n[ie];n[ie=n.length]=K.deriveDeep(r,!0)},ar:"autoResolution"};function me(e){ie=0;for(var t={},n=0,r=e.length;n<r;++n){for(var i=e[n],o=i[0],a=i[1],s=pe[o];h.a.isString(s);)s=pe[o=s];if(s){if(h.a.isFunction(s)){var l=s(a,t);void 0!==l&&(t[o]=l)}}else{var c=ae[ee()(h.a.get(re.defaults,o))];c?h.a.set(t,"settings.".concat(o),c(a)):O.warn('Unknown option "'.concat(o,'"'))}}return t}function ve(e){var t=[],n=0;return K.forInRecursive(e,(function(e,r){t[n++]=ue(r)+":"+ue(e)})),t.join(",")}function ye(e){return h.a.isArray(e)?e.length<2?e[0]:"".concat(e[0]).concat("!").concat(ve(e[1])):e}function _e(e){if(e&&e.type){var t=e.type;return h.a.isArray(e.params)&&e.params.length>0&&(t+=",".concat(e.params.join(","))),e.opts&&(t+="!"+ve(e.opts)),t}}function ge(e){var t=[],n=0;return K.forInRecursive(e,(function(e,r){t[n++]="".concat(r,"=").concat(K.enquoteString(e))})),t.join(" ")}function xe(e){return h.a.isArray(e)?e.length<2?e[0]:"".concat(e[0]," ").concat(ge(e[1])):e}function be(e){if(e&&e.type){var t=e.type;return h.a.isArray(e.params)&&e.params.length>0&&(t+=" ".concat(e.params.map(K.enquoteString).join(" "))),e.opts&&(t+=" ".concat(ge(e.opts))),t}}function we(e,t){var n=[],r=0;function i(e,t){null!=t&&(n[r++]=e+t)}return h.a.isEmpty(e)?null:(i("",t),i("s=",K.enquoteString(e.selector)),i("m=",xe(e.mode)),i("c=",xe(e.colorer)),i("mt=",xe(e.material)),n.join(" "))}var Se={fromURL:function(e){return me(K.getUrlParameters(e))},fromAttr:function(e){return me(K.getUrlParameters("?".concat(e||"")))},adapters:ae,toURL:function(e){var t=[],n=0;function r(e,r){null!=r&&(t[n++]=le(e)+"="+le(r))}r("l",e.load),r("u",e.unit),r("p",e.preset),function(e){if(e)for(var t=0,n=e.length;t<n;++t)h.a.isEmpty(e[t])||(r("r",t),r("s",e[t].selector),r("m",ye(e[t].mode)),r("c",ye(e[t].colorer)),r("mt",ye(e[t].material)))}(e.reps),function(e){if(e)for(var t=0,n=e.length;t<n;++t)r("o",_e(e[t]))}(e._objects),r("v",e.view),K.forInRecursive(e.settings,(function(e,t){"preset"!==t&&r(t,e)}));var i="";if("undefined"!=typeof window){var o=window.location;i="".concat(o.protocol,"//").concat(o.host).concat(o.pathname)}return t.length>0&&(i+="?".concat(t.join("&"))),i},toScript:function(e){var t=[],n=0;function r(e,r,i){if(null!=r){var o="string"==typeof r&&i?'"':"";t[n++]="".concat(e," ").concat(o).concat(r).concat(o).trim()}}return r("set","autobuild false"),r("load",e.load,!0),r("unit",e.unit),r("preset",e.preset),function(e){if(e)for(var t=0,n=e.length;t<n;++t)r("rep",we(e[t],t))}(e.reps),function(e){if(e)for(var t=0,n=e.length;t<n;++t)r("",be(e[t]))}(e._objects),K.forInRecursive(e.settings,(function(e,t){"preset"!==t&&r("set ".concat(t),e,!0)})),r("view",e.view),r("set","autobuild true"),t.join("\n")}},Ce=n("KEM+"),Re=n.n(Ce),Ae=function(){function e(t,n,r,i,o,a,s,l,c,u,h){m()(this,e),this.index=-1,this.residue=t,this.name=n,this.element=r,this.position=i,this.role=o,this.mask=1,this.het=a,this.serial=s,this.location=(l||" ").charCodeAt(0),this.occupancy=c||1,this.temperature=u,this.charge=h,this.hydrogenCount=-1,this.radicalCount=0,this.valence=-1,this.bonds=[],this.flags=0,"H"===r.name?this.flags|=e.Flags.HYDROGEN:"C"===r.name&&(this.flags|=e.Flags.CARBON)}return y()(e,[{key:"isHet",value:function(){return this.het}},{key:"isHydrogen",value:function(){return 1===this.element.number}},{key:"getVisualName",value:function(){var e=this.name;return e.length>0?e:this.element.name.trim()}},{key:"forEachBond",value:function(e){for(var t=this.bonds,n=0,r=t.length;n<r;++n)e(t[n])}},{key:"getFullName",value:function(){var e="";return null!==this.residue&&(null!==this.residue._chain&&(e+="".concat(this.residue._chain.getName(),".")),e+="".concat(this.residue._sequence,".")),e+=this.name}}]),e}();Re()(Ae,"Flags",{CARBON:1,HYDROGEN:8,NONPOLARH:4104});var Ee=Ae,ke=function e(t,n,r,i,o,a,s){m()(this,e),this.number=t,this.name=n,this.fullName=r,this.weight=i,this.radius=o,this.radiusBonding=a,this.hydrogenValency=s};Re()(ke,"Constants",{U1:1,Lead:2,U2:3,Wing:4,U18:18}),Re()(ke,"Role",{N:ke.Constants.U1,CA:ke.Constants.Lead,C:ke.Constants.U2,O:ke.Constants.Wing,SG:ke.Constants.U18}),Re()(ke,"ByAtomicNumber",[null,new ke(1,"H","Hydrogen",1.008,1.2,.23,[1]),new ke(2,"HE","Helium",4.003,1.4,.93,[0]),new ke(3,"LI","Lithium",6.941,1.82,.68,[1]),new ke(4,"BE","Beryllium",9.012,1.7,.35,[2]),new ke(5,"B","Boron",10.81,2.08,.83,[3]),new ke(6,"C","Carbon",12.011,1.95,.68,[4]),new ke(7,"N","Nitrogen",14.007,1.85,.68,[3,5]),new ke(8,"O","Oxygen",15.999,1.7,.68,[2,4]),new ke(9,"F","Fluorine",18.998,1.73,.64,[1]),new ke(10,"NE","Neon",20.18,1.54,1.12,[0]),new ke(11,"NA","Sodium",22.99,2.27,.97,[1]),new ke(12,"MG","Magnesium",24.305,1.73,1.1,[2]),new ke(13,"AL","Aluminum",26.981,2.05,1.35,[3]),new ke(14,"SI","Silicon",28.086,2.1,1.2,[4]),new ke(15,"P","Phosphorus",30.974,2.08,.75,[3,5]),new ke(16,"S","Sulfur",32.07,2,1.02,[2,4,6]),new ke(17,"CL","Chlorine",35.453,1.97,.99,[1,3,5,7]),new ke(18,"AR","Argon",39.948,1.88,1.57,[0]),new ke(19,"K","Potassium",39.1,2.75,1.33,[1]),new ke(20,"CA","Calcium",40.08,1.973,.99,[2]),new ke(21,"SC","Scandium",44.956,1.7,1.44,[0]),new ke(22,"TI","Titanium",47.88,1.7,1.47,[0]),new ke(23,"V","Vanadium",50.941,1.7,1.33,[0]),new ke(24,"CR","Chromium",52,1.7,1.35,[0]),new ke(25,"MN","Manganese",54.938,1.7,1.35,[0]),new ke(26,"FE","Iron",55.847,1.7,1.34,[0]),new ke(27,"CO","Cobalt",58.93,1.7,1.33,[0]),new ke(28,"NI","Nickel",58.69,1.63,1.5,[0]),new ke(29,"CU","Copper",63.55,1.4,1.52,[0]),new ke(30,"ZN","Zinc",65.39,1.39,1.45,[0]),new ke(31,"GA","Gallium",69.72,1.87,1.22,[3]),new ke(32,"GE","Germanium",72.61,1.7,1.17,[4]),new ke(33,"AS","Arsenic",74.92,1.85,1.21,[3,5]),new ke(34,"SE","Selenium",78.96,1.9,1.22,[2,4,6]),new ke(35,"BR","Bromine",79.9,2.1,1.21,[1,3,5,7]),new ke(36,"KR","Krypton",83.8,2.02,1.91,[0]),new ke(37,"RB","Rubidium",85.47,1.7,1.47,[1]),new ke(38,"SR","Strontium",87.62,1.7,1.12,[2]),new ke(39,"Y","Yttrium",88.91,1.7,1.78,[0]),new ke(40,"ZR","Zirconium",91.22,1.7,1.56,[0]),new ke(41,"NB","Niobium",92.91,1.7,1.48,[0]),new ke(42,"MO","Molybdenum",95.94,1.7,1.47,[0]),new ke(43,"TC","Technetium",98.91,1.7,1.35,[0]),new ke(44,"RU","Ruthenium",101.07,1.7,1.4,[0]),new ke(45,"RH","Rhodium",102.91,1.7,1.45,[0]),new ke(46,"PD","Palladium",106.42,1.63,1.5,[0]),new ke(47,"AG","Silver",107.87,1.72,1.59,[0]),new ke(48,"CD","Cadmium",112.41,1.58,1.69,[0]),new ke(49,"IN","Indium",114.82,1.93,1.63,[3]),new ke(50,"SN","Tin",118.71,2.17,1.46,[2,4]),new ke(51,"SB","Antimony",121.75,2.2,1.46,[3,5]),new ke(52,"TE","Tellurium",127.6,2.06,1.47,[2,4,6]),new ke(53,"I","Iodine",126.91,2.15,1.4,[1,3,5,7]),new ke(54,"XE","Xenon",131.29,2.16,1.98,[0]),new ke(55,"CS","Cesium",132.91,1.7,1.67,[1]),new ke(56,"BA","Barium",137.33,1.7,1.34,[2]),new ke(57,"LA","Lanthanum",138.91,1.7,1.87,[0]),new ke(58,"CE","Cerium",140.12,1.7,1.83,[0]),new ke(59,"PR","Praseodymium",140.91,1.7,1.82,[0]),new ke(60,"ND","Neodymium",144.24,1.7,1.81,[0]),new ke(61,"PM","Promethium",144.9,1.7,1.8,[0]),new ke(62,"SM","Samarium",150.36,1.7,1.8,[0]),new ke(63,"EU","Europium",151.96,1.7,1.99,[0]),new ke(64,"GD","Gadolinium",157.25,1.7,1.79,[0]),new ke(65,"TB","Terbium",158.93,1.7,1.76,[0]),new ke(66,"DY","Dysprosium",162.5,1.7,1.75,[0]),new ke(67,"HO","Holmium",164.93,1.7,1.74,[0]),new ke(68,"ER","Erbium",167.26,1.7,1.73,[0]),new ke(69,"TM","Thulium",168.93,1.7,1.72,[0]),new ke(70,"YB","Ytterbium",173.04,1.7,1.94,[0]),new ke(71,"LU","Lutetium",174.97,1.7,1.72,[0]),new ke(72,"HF","Hafnium",178.49,1.7,1.57,[0]),new ke(73,"TA","Tantalum",180.95,1.7,1.43,[0]),new ke(74,"W","Tungsten",183.85,1.7,1.37,[0]),new ke(75,"RE","Rhenium",186.21,1.7,1.35,[0]),new ke(76,"OS","Osmium",190.2,1.7,1.37,[0]),new ke(77,"IR","Iridium",192.22,1.7,1.32,[0]),new ke(78,"PT","Platinum",195.08,1.72,1.5,[0]),new ke(79,"AU","Gold",196.97,1.66,1.5,[0]),new ke(80,"HG","Mercury",200.59,1.55,1.7,[0]),new ke(81,"TL","Thallium",204.38,1.96,1.55,[1,3]),new ke(82,"PB","Lead",207.2,2.02,1.54,[2,4]),new ke(83,"BI","Bismuth",208.98,1.7,1.54,[3,5]),new ke(84,"PO","Polonium",210,1.7,1.68,[2,4,6]),new ke(85,"AT","Astatine",210,1.7,1.7,[1,3,5,7]),new ke(86,"RN","Radon",222,1.7,2.4,[0]),new ke(87,"FR","Francium",223,1.7,2,[1]),new ke(88,"RA","Radium",226.03,1.7,1.9,[2]),new ke(89,"AC","Actinium",227.03,1.7,1.88,[0]),new ke(90,"TH","Thorium",232.04,1.7,1.79,[0]),new ke(91,"PA","Protactinium",231.04,1.7,1.61,[0]),new ke(92,"U","Uranium",238.03,1.86,1.58,[0]),new ke(93,"NP","Neptunium",237.05,1.7,1.55,[0]),new ke(94,"PU","Plutonium",239.1,1.7,1.53,[0]),new ke(95,"AM","Americium",243.1,1.7,1.51,[0]),new ke(96,"CM","Curium",247.1,1.7,1.5,[0]),new ke(97,"BK","Berkelium",247.1,1.7,1.5,[0]),new ke(98,"CF","Californium",252.1,1.7,1.5,[0]),new ke(99,"ES","Einsteinium",252.1,1.7,1.5,[0]),new ke(100,"FM","Fermium",257.1,1.7,1.5,[0]),new ke(101,"MD","Mendelevium",256.1,1.7,1.5,[0]),new ke(102,"NO","Nobelium",259.1,1.7,1.5,[0]),new ke(103,"LR","Lawrencium",260.1,1.7,1.5,[0]),new ke(104,"RF","Rutherfordium",261,1.7,1.6,[0]),new ke(105,"DB","Dubnium",262,1.7,1.6,[0]),new ke(106,"SG","Seaborgium",263,1.7,1.6,[0]),new ke(107,"BH","Bohrium",262,1.7,1.6,[0]),new ke(108,"HS","Hassium",265,1.7,1.6,[0]),new ke(109,"MT","Meitnerium",268,1.7,1.6,[0])]),Re()(ke,"ByName",{D:new ke(1,"D","Deuterium",2.014,1.2,.23,[1]),T:new ke(1,"T","Tritium",3.016,1.2,.23,[1])}),function(){for(var e=ke.ByAtomicNumber,t=ke.ByName,n=0,r=e.length;n<r;++n){var i=e[n];i&&(t[i.name]=i)}}(),ke.getByName=function(e){var t=ke.ByName[e];return t||(t=ke.ByName[e]=new ke(0,e,"Unknown",0,1,.01,[0])),t};var Te=ke,Pe={UNKNOWN:0,COVALENT:1,AROMATIC:2};function Me(e){return e.position}var Ie=function(){function e(t,n,r,i,o){if(m()(this,e),this._left=t,this._right=n,this._fixed=o,this._index=-1,t>n)throw new Error("In a bond atom indices must be in increasing order");this._order=r,this._type=i}return y()(e,[{key:"getLeft",value:function(){return this._left}},{key:"getRight",value:function(){return this._right}},{key:"getOrder",value:function(){return this._order}},{key:"calcLength",value:function(){return this._left.position.distanceTo(this._right.position)}},{key:"_forEachNeighbour",value:function(e,t){for(var n=e.bonds,r=0,i=n.length;r<i;++r)t(n[r]._left!==e?n[r]._left:n[r]._right)}},{key:"forEachLevelOne",value:function(e){var t=this._left,n=this._right;this._forEachNeighbour(t,(function(t){t!==n&&e(t)})),this._forEachNeighbour(n,(function(n){n!==t&&e(n)}))}},{key:"forEachLevelTwo",value:function(e){var t=this._left,n=this._right,r=this;r._forEachNeighbour(t,(function(i){i!==n&&r._forEachNeighbour(i,(function(n){n!==t&&e(n)}))})),r._forEachNeighbour(n,(function(i){i!==t&&r._forEachNeighbour(i,(function(t){t!==n&&e(t)}))}))}},{key:"_fixDir",value:function(e,t,n){var r=0,i=0,o=e.clone();function a(a){o.copy(n(a)),o.sub(e),t.dot(o)>0?++r:++i}function s(e){"C"===e.element.name&&a(e)}for(var l=[[this.forEachLevelOne,s],[this.forEachLevelOne,a],[this.forEachLevelTwo,s],[this.forEachLevelTwo,a]],c=0;c<l.length;++c){if(l[c][0].call(this,l[c][1]),i>r)return t.multiplyScalar(-1);if(i<r)return t}return t}},{key:"calcNormalDir",value:function(e){var t=this._left,n=this._right,r=t,i=n;e=void 0===e?Me:e,t.bonds.length>n.bonds.length&&(r=n,i=t);for(var o=r,a=0,s=i.bonds,l=0,c=s.length;l<c;++l){var u=s[l]._left;s[l]._left===i&&(u=s[l]._right),u.bonds.length>a&&u!==r&&(o=u,a=u.bonds.length)}var h=e(i),d=e(r).clone().sub(h),f=e(o).clone().sub(h);return f.crossVectors(d,f),f.lengthSq()<1e-4&&f.set(0,1,0),d.normalize(),f.normalize(),d.crossVectors(f,d),d.lengthSq()<1e-4&&d.set(0,1,0),d.normalize(),this._fixDir(h,d,e)}}]),e}();Re()(Ie,"BondType",Pe),Ie.prototype.BondType=Pe;var Ne=Ie,Le=["C3'","C3*","P","H5T","H3T"],De=["OP1","O1P"],Oe=["OP2","O2P"],Ve=["C3'","C3*","C1","C1'","C1*","P"],ze=[{types:["A","DA","G","DG"],atoms:["N1"]},{types:["C","DC"],atoms:["N3"]},{types:["T","DT","U","DU"],atoms:["O4"]}],Fe=function(){function e(t,n,r,i){m()(this,e),this._chain=t,this._component=null,this._type=n,this._sequence=r,this._icode=i,this._mask=1,this._index=-1,this._atoms=[],this._secondary=null,this._firstAtom=null,this._leadAtom=null,this._wingAtom=null,this._lastAtom=null,this._controlPoint=null,this._midPoint=null,this._wingVector=null,this._cylinders=null,this._isValid=!0,this._het=!1,this._molecule=null,this.temperature=null,this.occupancy=null}return y()(e,[{key:"getChain",value:function(){return this._chain}},{key:"getMolecule",value:function(){return this._molecule}},{key:"getType",value:function(){return this._type}},{key:"getSequence",value:function(){return this._sequence}},{key:"getSecondary",value:function(){return this._secondary}},{key:"getICode",value:function(){return this._icode}},{key:"addAtom",value:function(e,t,n,r,i,o,a,s,l,c){var u=new Ee(this,e,t,n,r,i,o,a,s,l,c);return this._chain.getComplex().addAtom(u),this._atoms.push(u),this._het=this._het||i,u}},{key:"getAtomCount",value:function(){return this._atoms.length}},{key:"forEachAtom",value:function(e){for(var t=this._atoms,n=0,r=t.length;n<r&&!e(t[n]);++n);}},{key:"_findAtomByName",value:function(e){var t=null;return this.forEachAtom((function(n){return n.name===e&&(t=n,!0)})),t}},{key:"_findFirstAtomInList",value:function(e){for(var t=null,n=0;n<e.length;++n)if(null!==(t=this._findAtomByName(e[n])))return t;return t}},{key:"collectMask",value:function(){for(var e=4294967295,t=this._atoms,n=0,r=t.length;n<r;++n)e&=t[n].mask;this._mask=e}},{key:"getCylinderTargetList",value:function(){for(var e=this._type._name,t=0,n=ze.length;t<n;++t)for(var r=0,i=ze[t].types.length;r<i;++r)if(e===ze[t].types[r])return ze[t].atoms;return null}},{key:"_detectLeadWing",value:function(e,t,n){var r=this._findFirstAtomInList(Le),i=this._findFirstAtomInList(De),o=this._findFirstAtomInList(Oe);if(null===i&&null!==t&&(i=t._findFirstAtomInList(De)),null===o&&null!==t&&(o=t._findFirstAtomInList(Oe)),null!==r&&null!==i&&null!==o){e._leadAtom=r,e._controlPoint=n(r),e._wingVector=n(o).clone().sub(n(i)),e._isValid=!0;var a=this._findFirstAtomInList(Ve),s=this.getCylinderTargetList(),l=null!==s?this._findFirstAtomInList(s):null;null!==a&&null!==l&&(e._cylinders=[n(a),n(l)])}}},{key:"calcWing",value:function(e,t,n,r){var i=t.clone().sub(e),o=e.clone().sub(n);(o.crossVectors(i,o),o.crossVectors(i,o).normalize(),null!==r&&r.length()>1e-4)&&(o.length()>1e-4&&Math.abs(r.angleTo(o))>Math.PI/2&&o.negate());return o}},{key:"_innerFinalize",value:function(e,t,n,r,i,o){var a=null===t,s=o(this._leadAtom),l=new d.Vector3(s.x,s.y,s.z);if(i)this._detectLeadWing(r,n,o);else{if(a)r._midPoint=o(this._firstAtom).clone();else{var c=t._controlPoint;r._midPoint=c.clone().lerp(l,.5),r._wingVector=this.calcWing(c,l,o(e._wingAtom),t._wingVector)}r._controlPoint=l}}},{key:"_finalize2",value:function(e,t,n){this._innerFinalize(e,e,t,this,n,(function(e){return e.position}))}},{key:"isConnected",value:function(e){if(this._chain!==e._chain)return!1;if(this===e)return!0;var t=!1;return this.forEachAtom((function(n){for(var r=n.bonds,i=0,o=r.length;i<o;++i){var a=r[i];if(a._left.residue===e||a._right.residue===e)return t=!0,!0}return!1})),t}},{key:"_finalize",value:function(){var e=this,t=c()(this._atoms,1);this._firstAtom=t[0],this._lastAtom=this._atoms[this._atoms.length-1],this._leadAtom=null,this._wingAtom=null;var n=0,r=0,i=0,o=0;this.forEachAtom((function(t){return null===e._leadAtom&&t.role===Te.Constants.Lead&&(e._leadAtom=t),null===e._wingAtom&&t.role===Te.Constants.Wing&&(e._wingAtom=t),t.temperature&&(r+=t.temperature,n++),t.occupancy&&(o+=t.occupancy,i++),null!==e._leadAtom&&null!==e._wingAtom})),n>0&&(this.temperature=r/n),i>0&&(this.occupancy=o/i),null!==this._leadAtom&&null!==this._wingAtom||(this._isValid=!1),null===this._leadAtom&&(this._leadAtom=this._firstAtom),null===this._wingAtom&&(this._wingAtom=this._lastAtom)}}]),e}(),Be=function(){function e(t,n,r){m()(this,e),this._name=t,this._fullName=n,this.letterCode=r,this.flags=0}return y()(e,[{key:"getName",value:function(){return this._name}}]),e}();function Ue(e,t){for(var n=0,r=t.length;n<r;++n){var i=Be.StandardTypes[t[n]];i&&(i.flags|=e)}}Re()(Be,"StandardTypes",{ALA:new Be("ALA","Alanine","A"),ARG:new Be("ARG","Arginine","R"),ASN:new Be("ASN","Asparagine","N"),ASP:new Be("ASP","Aspartic Acid","D"),CYS:new Be("CYS","Cysteine","C"),GLN:new Be("GLN","Glutamine","Q"),GLU:new Be("GLU","Glutamic Acid","E"),GLY:new Be("GLY","Glycine","G"),HIS:new Be("HIS","Histidine","H"),ILE:new Be("ILE","Isoleucine","I"),LEU:new Be("LEU","Leucine","L"),LYS:new Be("LYS","Lysine","K"),MET:new Be("MET","Methionine","M"),PHE:new Be("PHE","Phenylalanine","F"),PRO:new Be("PRO","Proline","P"),PYL:new Be("PYL","Pyrrolysine","O"),SEC:new Be("SEC","Selenocysteine","U"),SER:new Be("SER","Serine","S"),THR:new Be("THR","Threonine","T"),TRP:new Be("TRP","Tryptophan","W"),TYR:new Be("TYR","Tyrosine","Y"),VAL:new Be("VAL","Valine","V"),A:new Be("A","Adenine","A"),C:new Be("C","Cytosine","C"),G:new Be("G","Guanine","G"),I:new Be("I","Inosine","I"),T:new Be("T","Thymine","T"),U:new Be("U","Uracil","U"),DA:new Be("DA","Adenine","A"),DC:new Be("DC","Cytosine","C"),DG:new Be("DG","Guanine","G"),DI:new Be("DI","Inosine","I"),DT:new Be("DT","Thymine","T"),DU:new Be("DU","Uracil","U"),"+A":new Be("+A","Adenine","A"),"+C":new Be("+C","Cytosine","C"),"+G":new Be("+G","Guanine","G"),"+I":new Be("+I","Inosine","I"),"+T":new Be("+T","Thymine","T"),"+U":new Be("+U","Uracil","U"),WAT:new Be("WAT","Water",""),H2O:new Be("H2O","Water",""),HOH:new Be("HOH","Water",""),DOD:new Be("DOD","Water",""),UNK:new Be("UNK","Unknown",""),UNL:new Be("UNL","Unknown Ligand","")}),Re()(Be,"Flags",{PROTEIN:1,BASIC:2,ACIDIC:4,POLAR:8,NONPOLAR:16,AROMATIC:32,NUCLEIC:256,PURINE:512,PYRIMIDINE:1024,DNA:2048,RNA:4096,WATER:65536});var Ge=Be.Flags;Ue(Ge.WATER,["WAT","H2O","HOH","DOD"]),Ue(Ge.PROTEIN,["ALA","ARG","ASN","ASP","CYS","GLY","GLU","GLN","HIS","ILE","LEU","LYS","MET","PHE","PRO","PYL","SEC","SER","THR","TRP","TYR","VAL"]),Ue(Ge.BASIC,["ARG","HIS","LYS"]),Ue(Ge.ACIDIC,["ASP","GLU"]),Ue(Ge.POLAR,["ASN","CYS","GLN","SER","THR","TYR"]),Ue(Ge.NONPOLAR,["ALA","ILE","LEU","MET","PHE","PRO","TRP","VAL","GLY"]),Ue(Ge.AROMATIC,["PHE","TRP","TYR"]),Ue(Ge.NUCLEIC,["A","G","I","DA","DG","DI","+A","+G","+I","C","T","U","DC","DT","DU","+C","+T","+U"]),Ue(Ge.PURINE,["A","G","I","DA","DG","DI","+A","+G","+I"]),Ue(Ge.PYRIMIDINE,["C","T","U","DC","DT","DU","+C","+T","+U"]),Ue(Ge.DNA,["DA","DG","DI","DC","DT","DU"]),Ue(Ge.RNA,["A","G","I","C","T","U"]);!function(e,t){for(var n=Object.keys(t),r=0,i=n.length;r<i;++r){var o=n[r],a=t[o];Be.StandardTypes[o][e]=a}}("hydrophobicity",{ILE:4.5,VAL:4.2,LEU:3.8,PHE:2.8,CYS:2.5,MET:1.9,ALA:1.8,GLY:-.4,THR:-.7,SER:-.8,TRP:-.9,TYR:-1.3,PRO:-1.6,HIS:-3.2,GLU:-3.5,GLN:-3.5,ASP:-3.5,ASN:-3.5,LYS:-3.9,ARG:-4.5});var je,He=Be,We=0,Ye=1,qe=2,Xe=function(){function e(t,n){m()(this,e),this._complex=t,this._name=n,this._mask=1,this._index=-1,this._residues=[],this.minSequence=Number.POSITIVE_INFINITY,this.maxSequence=Number.NEGATIVE_INFINITY}return y()(e,[{key:"getComplex",value:function(){return this._complex}},{key:"getName",value:function(){return this._name}},{key:"getResidues",value:function(){return this._residues}},{key:"_determineType",value:function(){var e=this._residues,t=He.Flags,n=t.PROTEIN,r=t.NUCLEIC;this.type=We;for(var i=0,o=e.length;i<o;++i){var a=e[i]._type.flags;if(0!=(a&r)){this.type=qe;break}if(0!=(a&n)){this.type=Ye;break}}}},{key:"findResidue",value:function(e,t){for(var n=this._residues,r=0,i=n.length;r<i;++r){var o=n[r];if(o._sequence===e&&o._icode===t)return[o,r]}return null}},{key:"_finalize",value:function(){this._determineType();for(var e=this._residues,t=null,n=0,r=e.length;n<r;++n){var i=n+1<r?e[n+1]:null,o=e[n];o._finalize2(t,i,this.type===qe),t=o}if(e.length>1&&e[1]._wingVector){var a=e[1]._wingVector;e[0]._wingVector=new d.Vector3(a.x,a.y,a.z)}else e.length>0&&(e[0]._wingVector=new d.Vector3(1,0,0))}},{key:"updateToFrame",value:function(e){var t=this._residues,n=null,r=null,i=e._residues,o=t.length;function a(t){return e.getAtomPos(t.index)}for(var s=0;s<o;++s){var l=t[s],c=i[l._index],u=s+1<o?t[s+1]:null;l._innerFinalize(n,r,u,c,this.type===qe,a),n=l,r=c}i[t[0]._index]._wingVector=o>1?i[t[1]._index]._wingVector:new d.Vector3(1,0,0)}},{key:"addResidue",value:function(e,t,n){var r=this._complex.getResidueType(e);null===r&&(r=this._complex.addResidueType(e));var i=new Fe(this,r,t,n);return this._complex.addResidue(i),this._residues.push(i),r.flags&(He.Flags.NUCLEIC|He.Flags.PROTEIN)&&(this.maxSequence<t&&(this.maxSequence=t),this.minSequence>t&&(this.minSequence=t)),i}},{key:"getResidueCount",value:function(){return this._residues.length}},{key:"forEachResidue",value:function(e){for(var t=this._residues,n=0,r=t.length;n<r;++n)e(t[n])}},{key:"collectMask",value:function(){for(var e=4294967295,t=this._residues,n=0,r=t.length;n<r;++n)e&=t[n]._mask;this._mask=e}}]),e}(),$e=function(){function e(t,n,r){m()(this,e),this.type=t,this.generic=e.genericByType[this.type]||"loop",this.init=n,this.term=r}return y()(e,[{key:"_finalize",value:function(e,t,n){if(!(this.init instanceof Fe&&this.term instanceof Fe)){for(var r=n.splitUnifiedSerial(this.init),i=n.splitUnifiedSerial(this.term),o=r.chain;o<=i.chain;o++)for(var a=r.serial;a<=i.serial;a++)for(var s=r.iCode;s<=i.iCode;s++){var l=n.getUnifiedSerial(o,a,s);t[l]&&(t[l]._secondary=this)}this.init=t[this.init],this.term=t[this.term]}}}]),e}();$e.Type={STRAND:"E",BRIDGE:"B",HELIX_310:"G",HELIX_ALPHA:"H",HELIX_PI:"I",HELIX:"X",TURN_310:"3",TURN_ALPHA:"4",TURN_PI:"5",TURN:"T",BEND:"S",COIL:"C"},$e.Generic={STRAND:"strand",HELIX:"helix",LOOP:"loop"};var Ke=$e.Type,Ze=$e.Generic;$e.genericByType=(je={},Re()(je,Ke.STRAND,Ze.STRAND),Re()(je,Ke.HELIX_310,Ze.HELIX),Re()(je,Ke.HELIX_ALPHA,Ze.HELIX),Re()(je,Ke.HELIX_PI,Ze.HELIX),Re()(je,Ke.HELIX,Ze.HELIX),je);var Qe=$e;function Je(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var et=Qe.Type,tt={1:et.HELIX_ALPHA,3:et.HELIX_PI,5:et.HELIX_310},nt=function(e){S()(n,e);var t=Je(n);function n(e,r,i,o,a,s,l){var c;return m()(this,n),(c=t.call(this,tt[e]||Qe.Type.HELIX,r,i)).serial=o,c.name=a,c.comment=s,c.length=l,c}return n}(Qe),rt=n("n70c"),it=n.n(rt);function ot(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var at=function(e){S()(n,e);var t=ot(n);function n(e,r,i,o,a,s){var l;return m()(this,n),(l=t.call(this,Qe.Type.STRAND,r,i)).sheet=e,l.sense=o,l.atomCur=a,l.atomPrev=s,l}return y()(n,[{key:"_finalize",value:function(e,t,r){it()(E()(n.prototype),"_finalize",this).call(this,e,t,r);var i=this.atomCur;null===i||Number.isNaN(i)||(this.atomCur=e[i]),null===(i=this.atomPrev)||Number.isNaN(i)||(this.atomPrev=e[i])}}]),n}(Qe),st=function(){function e(t,n){m()(this,e),this._name=t,this._width=n,this._strands=[]}return y()(e,[{key:"getName",value:function(){return this._name}},{key:"getWidth",value:function(){return this._width}},{key:"addStrand",value:function(e){this._strands.push(e),this._width=this._strands.length}},{key:"addEmptyStrand",value:function(){this._strands.push(new at(null,null,null,null,null,null))}},{key:"_finalize",value:function(e,t,n){for(var r=this._strands,i=0,o=r.length;i<o;++i)r[i]._finalize(e,t,n);if(this._width||(this._width=r.length),r.length!==this._width)throw new Error("Sheet ".concat(this._name," is inconsistent."))}}]),e}(),lt=function(){function e(t,n,r,i,o){m()(this,e),this._id=t,this._name=n,this._position=r||new d.Vector3,this._atoms=i||[],this._charge=0,this._repeat=1,this._center=null,this.xmlNodeRef=o||null}return y()(e,[{key:"getName",value:function(){return this._name}},{key:"getPosition",value:function(){return this._position}},{key:"getCentralPoint",value:function(){return this._center}},{key:"_rebuildSGroupOnAtomChange",value:function(){var e=1e8;if(null!==this._center){for(var t=new d.Vector3(e,e,e),n=new d.Vector3(-e,-e,-e),r=0,i=this._atoms.length;r<i;r++){var o=this._atoms[r].position;t.set(Math.min(t.x,o.x),Math.min(t.y,o.y),Math.min(t.z,o.z)),n.set(Math.max(n.x,o.x),Math.max(n.y,o.y),Math.max(n.z,o.z))}this._center.addVectors(t,n),this._center.multiplyScalar(.5)}}}]),e}(),ct=n("rDK1"),ut=n.n(ct),ht=n("4oJk");function dt(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var ft=function(){function e(t,n){m()(this,e),this.min=t,this.max=void 0===n?t:n}return y()(e,[{key:"includes",value:function(e){return this.min<=e&&e<=this.max}},{key:"toString",value:function(){var e=this.min,t=this.max;return e===t?String(e):[e,t].join(":")}},{key:"toJSON",value:function(){return[this.min,this.max]}}]),e}(),pt=function(){function e(t){if(m()(this,e),t instanceof this.constructor)return t;this._values=t instanceof Array?t.slice(0):t?[t]:[]}return y()(e,[{key:"append",value:function(e){var t=this._values;return t[t.length]=e,this}},{key:"remove",value:function(e){var t=this._values,n=t.indexOf(e);return n>=0&&t.splice(n,1),this}},{key:"toString",value:function(){return this._values.join(",")}},{key:"toJSON",value:function(){for(var e=this._values,t=[],n=0,r=e.length;n<r;++n){var i=e[n];t[n]=i.toJSON?i.toJSON():i}return t}}]),e}(),mt=function(e){S()(n,e);var t=dt(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"includes",value:function(e){for(var t=this._values,n=0,r=t.length;n<r;++n)if(t[n].includes(e))return!0;return!1}}]),n}(pt),vt=[],yt=function(e){S()(n,e);var t=dt(n);function n(e,r){var i;m()(this,n);var o=i=t.call(this,e);if(r){i.upperOnly=!0;for(var a=o._values,s=0,l=a.length;s<l;++s){var c=a[s];"string"==typeof c&&(a[s]=c.toUpperCase())}}else i.upperOnly=!1;return R()(i,o)}return y()(n,[{key:"includes",value:function(e){return-1!==this._values.indexOf(e)}},{key:"toString",value:function(){var e=this._values;vt.length=0;for(var t=0,n=e.length;t<n;++t)vt[t]=K.correctSelectorIdentifier(String(e[t]));return vt.join(",")}},{key:"_validate",value:function(e){return this.upperOnly&&"string"==typeof e?e.toUpperCase():e}},{key:"append",value:function(e){return it()(E()(n.prototype),"append",this).call(this,this._validate(e)),this}},{key:"remove",value:function(e){return it()(E()(n.prototype),"remove",this).call(this,this._validate(e)),this}}]),n}(pt);function _t(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var gt=function(){function e(){m()(this,e)}return y()(e,[{key:"toString",value:function(){return this.keyword}},{key:"toJSON",value:function(){return[this.name]}}]),e}();gt.prototype.name="Error",gt.prototype.keyword="error";var xt=function(e){S()(n,e);var t=_t(n);function n(e){var r;return m()(this,n),(r=t.call(this)).list=e,r}return y()(n,[{key:"toString",value:function(){return"".concat(this.keyword," ").concat(this.list)}},{key:"toJSON",value:function(){return[this.name,this.list.toJSON()]}}]),n}(gt),bt=function(e){S()(n,e);var t=_t(n);function n(e){return m()(this,n),t.call(this,new mt(e))}return n}(xt),wt=function(e){S()(n,e);var t=_t(n);function n(e,r){return m()(this,n),t.call(this,new yt(e,!r))}return n}(xt),St=function(e){S()(n,e);var t=_t(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"includesAtom",value:function(e){return!1}}]),n}(gt);St.prototype.name="None",St.prototype.keyword="none";var Ct=function(e){S()(n,e);var t=_t(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"includesAtom",value:function(e){return!0}}]),n}(gt);function Rt(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}Ct.prototype.name="All",Ct.prototype.keyword="all";var At=new St,Et=function(e){S()(n,e);var t=Rt(n);function n(e){var r;return m()(this,n),(r=t.call(this)).rhs=e||At,r}return y()(n,[{key:"toString",value:function(){var e=this.rhs.priority&&this.rhs.priority>this.priority?"(".concat(this.rhs,")"):this.rhs;return"".concat(this.keyword," ").concat(e)}},{key:"toJSON",value:function(){return[this.name,this.rhs.toJSON()]}}]),n}(gt);Et.prototype.priority=1;var kt=function(e){S()(n,e);var t=Rt(n);function n(e,r){var i;return m()(this,n),(i=t.call(this)).lhs=e||At,i.rhs=r||At,i}return y()(n,[{key:"toString",value:function(){var e=this.lhs.priority&&this.lhs.priority>this.priority?"(".concat(this.lhs,")"):this.lhs,t=this.rhs.priority&&this.rhs.priority>this.priority?"(".concat(this.rhs,")"):this.rhs;return"".concat(e," ").concat(this.keyword," ").concat(t)}},{key:"toJSON",value:function(){return[this.name,this.lhs.toJSON(),this.rhs.toJSON()]}}]),n}(gt);function Tt(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}kt.prototype.priority=1e3;var Pt={};function Mt(e,t){var n=e.toLowerCase();t.prototype.keyword=n,t.prototype.name=e;var r=function(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return ut()(t,n)};return r.SelectorClass=t,Pt[n]=r,t}Mt("Serial",function(e){S()(n,e);var t=Tt(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"includesAtom",value:function(e){return this.list.includes(e.serial)}}]),n}(bt)),Mt("Name",function(e){S()(n,e);var t=Tt(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"includesAtom",value:function(e){return this.list.includes(e.name)}}]),n}(wt)),Mt("AltLoc",function(e){S()(n,e);var t=Tt(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"includesAtom",value:function(e){return this.list.includes(String.fromCharCode(e.location))}}]),n}(wt)),Mt("Elem",function(e){S()(n,e);var t=Tt(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"includesAtom",value:function(e){return this.list.includes(e.element.name)}}]),n}(wt)),Mt("Residue",function(e){S()(n,e);var t=Tt(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"includesAtom",value:function(e){return this.list.includes(e.residue._type._name)}}]),n}(wt)),Mt("Sequence",function(e){S()(n,e);var t=Tt(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"includesAtom",value:function(e){return this.list.includes(e.residue._sequence)}}]),n}(bt)),Mt("ICode",function(e){S()(n,e);var t=Tt(n);function n(e){return m()(this,n),t.call(this,e,!0)}return y()(n,[{key:"includesAtom",value:function(e){return this.list.includes(e.residue._icode)}}]),n}(wt)),Mt("ResIdx",function(e){S()(n,e);var t=Tt(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"includesAtom",value:function(e){return this.list.includes(e.residue._index)}}]),n}(bt)),Mt("Chain",function(e){S()(n,e);var t=Tt(n);function n(e){return m()(this,n),t.call(this,e,!0)}return y()(n,[{key:"includesAtom",value:function(e){return this.list.includes(e.residue._chain._name)}}]),n}(wt)),Mt("Hetatm",function(e){S()(n,e);var t=Tt(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"includesAtom",value:function(e){return e.het}}]),n}(gt)),Mt("PolarH",function(e){S()(n,e);var t=Tt(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"includesAtom",value:function(e){return(e.flags&Ee.Flags.NONPOLARH)===Ee.Flags.HYDROGEN}}]),n}(gt)),Mt("NonPolarH",function(e){S()(n,e);var t=Tt(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"includesAtom",value:function(e){return(e.flags&Ee.Flags.NONPOLARH)===Ee.Flags.NONPOLARH}}]),n}(gt)),Mt("All",Ct),Mt("None",St);var It=Pt.none();function Nt(e,t,n){return n.prototype.priority=t,Mt(e,n)}function Lt(e,t){return Mt(t,function(t){S()(r,t);var n=Tt(r);function r(){return m()(this,r),n.apply(this,arguments)}return y()(r,[{key:"includesAtom",value:function(t){return 0!=(t.residue._type.flags&e)}}]),r}(gt))}Nt("Not",1,function(e){S()(n,e);var t=Tt(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"includesAtom",value:function(e){return!this.rhs.includesAtom(e)}}]),n}(Et)),Nt("And",2,function(e){S()(n,e);var t=Tt(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"includesAtom",value:function(e){return this.lhs.includesAtom(e)&&this.rhs.includesAtom(e)}}]),n}(kt)),Nt("Or",3,function(e){S()(n,e);var t=Tt(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"includesAtom",value:function(e){return this.lhs.includesAtom(e)||this.rhs.includesAtom(e)}}]),n}(kt)),Lt(He.Flags.PROTEIN,"Protein"),Lt(He.Flags.BASIC,"Basic"),Lt(He.Flags.ACIDIC,"Acidic"),Lt(He.Flags.BASIC|He.Flags.ACIDIC,"Charged"),Lt(He.Flags.POLAR,"Polar"),Lt(He.Flags.NONPOLAR,"NonPolar"),Lt(He.Flags.AROMATIC,"Aromatic"),Lt(He.Flags.NUCLEIC,"Nucleic"),Lt(He.Flags.PURINE,"Purine"),Lt(He.Flags.PYRIMIDINE,"Pyrimidine"),Lt(He.Flags.WATER,"Water");var Dt=Object.create(Pt);Dt.Selector=gt,Dt.RangeListSelector=bt,Dt.ValueListSelector=wt,Dt.Range=ft,Dt.RangeList=mt,Dt.ValueList=yt,Dt.PrefixOperator=Et,Dt.InfixOperator=kt,Dt.Context=Object.create({}),Dt.GetSelector=function(e){if(!Dt.Context.hasOwnProperty(e))throw{message:"selector ".concat(e," is not registered")};return Dt.Context[e]||It},Dt.ClearContext=function(){Object.keys(Dt.Context).forEach((function(e){delete Dt.Context[e]}))},Dt.keyword=function(e){return Pt[e.toLowerCase()]||Pt.none},Dt.parse=function(e){var t={};try{t.selector=ht.parser.parse(e)}catch(e){t.selector=It,t.error=e.message}return t},ht.parser.yy=Dt,ht.parser.yy.parseError=ht.parser.parseError;var Ot=Dt,Vt=function(){function e(t){m()(this,e),this._complex=t,this._selector=Ot.keyword("All")(),this._boundaries={boundingBox:new d.Box3,boundingSphere:new d.Sphere}}return y()(e,[{key:"computeBoundaries",value:function(){var e=this._complex._atoms,t=e.length,n=this._selector,r=this._boundaries.boundingBox;if(r.makeEmpty(),1===t){r.expandByPoint(e[0].position);var i=new d.Vector3;r.getCenter(i);var o=2*e[0].element.radius;r.setFromCenterAndSize(i,new d.Vector3(o,o,o))}else for(var a=0;a<t;++a)n.includesAtom(e[a])&&r.expandByPoint(e[a].position);var s=0,l=new d.Vector3;if(r.getCenter(l),1===t)this._boundaries.boundingSphere.set(l,e[0].element.radius);else{for(var c=0;c<t;++c)if(n.includesAtom(e[c])){var u=e[c].position,h=l.distanceToSquared(u);s<h&&(s=h)}this._boundaries.boundingSphere.set(l,Math.sqrt(s))}}},{key:"getTransforms",value:function(){return[]}},{key:"getSelector",value:function(){return this._selector}},{key:"getBoundaries",value:function(){return this._boundaries}},{key:"finalize",value:function(){}}]),e}();function zt(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var Ft=function(e){S()(n,e);var t=zt(n);function n(e){var r;return m()(this,n),(r=t.call(this,e)).chains=[],r.matrices=[],r}return y()(n,[{key:"computeBoundaries",value:function(){it()(E()(n.prototype),"computeBoundaries",this).call(this);var e=this.matrices,t=this._boundaries.boundingSphere.center,r=this._boundaries.boundingSphere.radius,i=this._boundaries.boundingBox=new d.Box3;i.makeEmpty();for(var o=0,a=e.length;o<a;++o)i.expandByPoint(t.clone().applyMatrix4(e[o]));var s=i.max.distanceTo(i.min)/2+r,l=new d.Vector3;i.getCenter(l),this._boundaries.boundingSphere=(new d.Sphere).set(l,s),i.max.addScalar(r),i.min.subScalar(r)}},{key:"addChain",value:function(e){this.chains[this.chains.length]=e}},{key:"addMatrix",value:function(e){this.matrices[this.matrices.length]=e}},{key:"getTransforms",value:function(){return this.matrices}},{key:"finalize",value:function(){this.chains.length>0?this._selector=Ot.keyword("Chain")(this.chains):this._selector=Ot.keyword("None")()}}]),n}(Vt),Bt=function(){function e(t){m()(this,e),this._complex=t,this._index=-1,this._residueIndices=[],this._cycles=[],this._subDivs=[],this._residueCount=0}return y()(e,[{key:"getResidues",value:function(){return this._complex._residues}},{key:"getResidueCount",value:function(){return this._residueCount}},{key:"forEachResidue",value:function(e){for(var t=this._complex._residues,n=this._residueIndices,r=0,i=n.length;r<i;++r)for(var o=n[r].start,a=n[r].end;o<=a;++o)e(t[o])}},{key:"setSubDivs",value:function(e){this._subDivs=e;for(var t=0,n=[],r=0,i=0,o=e.length;i<o;++i)if(i===o-1||e[i].end+1!==e[i+1].start){var a=e[t].start,s=e[i].end;n[n.length]={start:a,end:s},r+=s-a+1,t=i+1}this._residueIndices=n,this._residueCount=r}},{key:"getComplex",value:function(){return this._complex}},{key:"forEachBond",value:function(e){for(var t=this._complex._bonds,n=0,r=t.length;n<r;++n){var i=t[n];i._left.residue._component===this&&e(i)}}},{key:"update",value:function(){this.forEachCycle((function(e){e.update()}))}},{key:"forEachAtom",value:function(e){this.forEachResidue((function(t){t.forEachAtom(e)}))}},{key:"addCycle",value:function(e){this._cycles.push(e)}},{key:"forEachCycle",value:function(e){for(var t=this._cycles,n=0,r=t.length;n<r;++n)e(t[n])}},{key:"markResidues",value:function(){var e=this;e.forEachResidue((function(t){t._component=e}))}},{key:"_forEachSubChain",value:function(e,t){for(var n=this._complex._residues,r=this._subDivs,i=0,o=r.length;i<o;++i)for(var a=r[i].start,s=r[i].end;a<=s;++a){var l=n[a];if(e&l._mask&&l._isValid){for(var c=a+1;c<=s;++c){var u=n[c];if(!(e&u._mask&&u._isValid))break}t(i,a,c-1),a=c}}}},{key:"getMaskedSequences",value:function(e){var t=[],n=0;return this._forEachSubChain(e,(function(e,r,i){t[n++]={start:r,end:i}})),t}},{key:"getMaskedSubdivSequences",value:function(e){var t=[],n=-1,r=-1,i=this._subDivs;return this._forEachSubChain(e,(function(e,o,a){r!==e&&(++n,t[n]={arr:[],boundaries:i[e]},r=e),t[n].arr[t[n].arr.length]={start:o,end:a}})),t}}]),e}(),Ut=function(){function e(t){m()(this,e),this.numPairs=0,this.numMaxPairs=t,this.intBuffer=K.allocateTyped(Int32Array,4*t);for(var n=0;n<4*t;n++)this.intBuffer[n]=-1;this.hashBuffer=K.allocateTyped(Int32Array,33554432);for(var r=0;r<33554432;r++)this.hashBuffer[r]=-1}return y()(e,[{key:"destroy",value:function(){this.intBuffer=null,this.hashBuffer=null}},{key:"addPair",value:function(e,t){for(var n=e<t?e:t,r=e>t?e:t,i=n+(r<<14),o=32*(n+89237*r&1048575),a=0;a<32;a++){var s=this.hashBuffer[o+a];if(-1===s)break;if(s===i)return!1}if(a>=32)throw new Error("addPair: increase cMaxPairsForHashCode");if(this.hashBuffer[o+a]=i,this.numPairs>=this.numMaxPairs)throw new Error("addPair: increase num pairs");return o=4*this.numPairs,this.intBuffer[o]=n,this.intBuffer[o+1]=r,this.intBuffer[o+2]=i,this.numPairs++,!0}}]),e}();function Gt(e){var t=e.element;if(t)return t.radiusBonding;throw new Error("_getBondingRadius: Logic error.")}var jt,Ht,Wt,Yt=function(){function e(t){m()(this,e),this._complex=t,this._maxRad=1.8;var n=this._complex.getDefaultBoundaries().boundingBox;this._vBoxMin=n.min.clone(),this._vBoxMax=n.max.clone(),this._pairCollection=null}return y()(e,[{key:"_addExistingPairs",value:function(){for(var e=this._complex.getAtoms(),t=e.length,n=0,r=this._pairCollection;n<t;n++)for(var i=e[n].bonds,o=i.length,a=0;a<o;a++){var s=i[a];s._left.index===n&&r.addPair(n,s._right.index)}return 0}},{key:"_findPairs",value:function(){var e=this._complex.getVoxelWorld();if(null!==e)for(var t,n,r,i,o,a,s=this._complex._atoms,l=s.length,c=this,u=function(e){if(!n||!e.isHydrogen()){var a=e.location;if(32===i||32===a||i===a){var s=r.distanceToSquared(e.position),l=e.element.radiusBonding,u=t+l+.45;s>u*u||s<.001||c._pairCollection.addPair(o.index,e.index)}}},h=0;h<l;++h)o=s[h],(!(a=o).isHet()||a.bonds&&0===a.bonds.length)&&(t=o.element.radiusBonding,n=o.isHydrogen(),r=o.position,i=o.location,e.forEachAtomWithinRadius(r,2*this._maxRad+.45,u))}},{key:"_addPairs",value:function(){for(var e=this._complex._atoms,t=0,n=0;t<this._pairCollection.numPairs;t++,n+=4){var r=this._pairCollection.intBuffer[n],i=this._pairCollection.intBuffer[n+1];this._addPair(e[r],e[i])}}},{key:"_addPair",value:function(e,t){for(var n=e.bonds,r=e.index,i=t.index,o=0,a=n.length;o<a;++o){var s=n[o];if(s._left.index===i||s._right.index===i)return}var l=r<i?e:t,c=r<i?t:e,u=this._complex.addBond(l,c,0,Ne.BondType.UNKNOWN,!1);n.push(u),t.bonds.push(u)}},{key:"build",value:function(){this._buildInner()}},{key:"_buildInner",value:function(){var e=this._complex._atoms;if(!(e.length<2)){if(e[0].index<0)throw new Error("AutoBond: Atoms in complex were not indexed.");this._calcBoundingBox(),this._pairCollection=new Ut(4*e.length),this._addExistingPairs(),this._findPairs(),this._addPairs()}}},{key:"_calcBoundingBox",value:function(){for(var e=this._complex._atoms,t=e.length,n=Gt(e[0]),r=1;r<t;++r)n=Math.max(n,Gt(e[r]));this._vBoxMax.addScalar(n),this._vBoxMin.addScalar(-n),this._maxRad=1.2*n}},{key:"destroy",value:function(){this._pairCollection&&this._pairCollection.destroy()}}]),e}(),qt=Ne.BondType.AROMATIC,Xt=[Te.ByName.C.number,Te.ByName.N.number],$t=(jt=new d.Vector3,Ht=new d.Vector3,Wt=new d.Vector3,function(e,t){return jt.copy(e).normalize(),Ht.copy(t).normalize(),Wt.crossVectors(jt,Ht),!(Wt.length()>.1)&&jt.dot(Ht)>=0});function Kt(e,t){for(var n=0;n<e.length&&e[n]<t;)++n;e.splice(n,0,t)}function Zt(e,t){return e._left===t?e._right:e._left}function Qt(e){e._type=qt}var Jt=function(){function e(t){m()(this,e),this.atoms=t,this.update()}return y()(e,[{key:"update",value:function(){for(var e=this.atoms,t=new d.Vector3,n=e.length,r=0;r<n;++r)t.add(e[r].position);t.multiplyScalar(1/n),this.center=t,this.radius=t.distanceTo(e[0].position.clone().lerp(e[1].position,.5))}},{key:"forEachBond",value:function(e){var t,n=this.atoms,r=n.length,i=n[0];function o(n){n._left!==t&&n._right!==t||e(n)}for(var a=0;a<r;++a)t=n[(a+1)%r],i.forEachBond(o),i=t}}]),e}();function en(e){return e._type===qt}function tn(e){if(e.type===qt)return!0;var t=Xt.indexOf(e._right.element.number),n=Xt.indexOf(e._left.element.number);return-1!==t&&-1!==n}function nn(e){return e.length>3}function rn(e){return console.assert(e.length>2),!0}var on=function(){function e(t){m()(this,e),this._complex=t;for(var n=new Array(t._bonds.length),r=new Array(t._bonds.length),i=0,o=n.length;i<o;++i)n[i]=[],r[i]=!1;this._bondsData=n,this._bondMarks=r,this._resetCycles()}return y()(e,[{key:"_resetCycles",value:function(){this._cycles=[],this._currIdx=-1}},{key:"_haveSameCycle",value:function(e,t,n){for(var r=e[t._index],i=e[n._index],o=r.length,a=i.length,s=0,l=0;s<o&&l<a;){if(r[s]===i[l])return!0;r[s]>i[l]?++l:++s}return!1}},{key:"_tryBond",value:function(e,t,n){var r=[],i=this._bondsData,o=Zt(e,t),a=t.position.clone().sub(o.position),s=this._currStart,l=this,c=this._bondMarks,u=this._checkBond;c[e._index]=!0,u=void 0===u?en:u,t.forEachBond((function(o){if(u(o)&&o!==e&&!c[o._index]&&!l._haveSameCycle(i,e,o)){var h,f,p,m=Zt(o,t),v=m.position.clone().sub(t.position),y=m===s?-2:1-(f=v,p=(h=a).dot(f)/Math.sqrt(h.lengthSq()*f.lengthSq()),d.MathUtils.clamp(p,-1,1)),_=v.cross(a);if($t(_,n)){for(var g=0;g<r.length&&r[g].val<y;)++g;r.splice(g,0,{bond:o,val:y,dir:_})}}}));for(var h=0,f=r.length;h<f;++h){var p=r[h].bond,m=p._left===t?p._right:p._left;if(m===s)return++this._currIdx,this._cycles.push([t]),c[e._index]=!1,!0;if(this._tryBond(p,m,r[h].dir))return Kt(i[p._index],this._currIdx),this._cycles[this._currIdx].push(t),c[e._index]=!1,!0}return c[e._index]=!1,!1}},{key:"_startCycle",value:function(e){this._currStart=e._left,this._tryBond(e,e._right,new d.Vector3)&&(Kt(this._bondsData[e._index],this._currIdx),this._cycles[this._currIdx].push(e._left))}},{key:"_findLoops",value:function(e,t){this._checkBond=e;var n=this._complex,r=this;n.forEachComponent((function(n){r._resetCycles(),n.forEachBond((function(t){e(t)&&r._startCycle(t)}));for(var i=r._cycles,o=0,a=i.length;o<a;++o){var s=i[o];if(t(s)){var l=new Jt(s);l.forEachBond(Qt),n.addCycle(l)}}}))}},{key:"markCycles",value:function(){this._findLoops(en,nn)}},{key:"detectCycles",value:function(){this._findLoops(tn,rn)}}]),e}();function an(e,t,n,r){var i=n-e.z,o=r-e.z,a=Math.sqrt(Math.max(t*t-i*i,0)),s=Math.sqrt(Math.max(t*t-o*o,0));return[Math.min(a,s),n<=e.z&&r>=e.z?t:Math.max(a,s)]}function sn(e,t,n,r){var i=n-e.y,o=r-e.y,a=Math.sqrt(Math.max(t*t-i*i,0)),s=Math.sqrt(Math.max(t*t-o*o,0));return[Math.min(a,s),n<=e.y&&r>=e.y?t:Math.max(a,s)]}var ln=function(){function e(t,n){m()(this,e),this._box=t.clone();var r=new d.Vector3;t.getSize(r),this._count=r.clone().divide(n).floor().max(new d.Vector3(1,1,1)),this._last=this._count.clone().subScalar(1),this._cellSize=r.clone().divide(this._count),this._cellInnerR=.5*Math.min(Math.min(this._cellSize.x,this._cellSize.y),this._cellSize.z),this._cellOuterR=.5*Math.sqrt(this._cellSize.dot(this._cellSize));var i=this._count.x*this._count.y*this._count.z;this._voxels=K.allocateTyped(Int32Array,i);for(var o=0;o<i;++o)this._voxels[o]=-1;this._atoms=[]}return y()(e,[{key:"addAtoms",value:function(e){var t=this,n=this._atoms.length;this._atoms.length+=2*e.getAtomCount(),e.forEachAtom((function(e){var r=t._findVoxel(e.position);t._atoms[n]=e,t._atoms[n+1]=t._voxels[r],t._voxels[r]=n,n+=2}))}},{key:"_findVoxel",value:function(t){var n=e._zero,r=e._voxel;return r.copy(t).sub(this._box.min).divide(this._cellSize).floor().clamp(n,this._last),r.x+this._count.x*(r.y+this._count.y*r.z)}},{key:"_forEachAtomInVoxel",value:function(e,t){for(var n=this._voxels[e];n>=0;n=this._atoms[n+1])t(this._atoms[n])}},{key:"_forEachVoxelWithinRadius",value:function(t,n,r){var i=e._xRange,o=e._yRange,a=e._zRange;if(n/this._cellInnerR<10)this._forEachVoxelWithinRadiusSimple(t,n,r);else{var s,l,c,u,h,d,f,p;a.set(t.z-n,t.z+n),a.subScalar(this._box.min.z).divideScalar(this._cellSize.z).floor().clampScalar(0,this._count.z-1);for(var m=a.x;m<=a.y;++m){h=[this._box.min.z+m*this._cellSize.z,this._box.min.z+(m+1)*this._cellSize.z],p=t.z-n<=h[0]&&h[1]<=t.z+n,s=an(t,n,h[0],h[1]),o.set(t.y-s[1],t.y+s[1]),o.subScalar(this._box.min.y).divideScalar(this._cellSize.y).floor().clampScalar(0,this._count.y-1);for(var v=o.x;v<=o.y;++v){u=[this._box.min.y+v*this._cellSize.y,this._box.min.y+(v+1)*this._cellSize.y],f=t.y-s[0]<=u[0]&&u[1]<=t.y+s[0],l=sn(t,s[1],u[0],u[1]),i.set(t.x-l[1],t.x+l[1]),i.subScalar(this._box.min.x).divideScalar(this._cellSize.x).floor().clampScalar(0,this._count.x-1);for(var y=i.x;y<=i.y;++y)c=[this._box.min.x+y*this._cellSize.x,this._box.min.x+(y+1)*this._cellSize.x],d=t.x-l[0]<=c[0]&&c[1]<=t.x+l[0],r(y+this._count.x*(v+this._count.y*m),d&&f&&p)}}}}},{key:"_forEachVoxelWithinRadiusSimple",value:function(t,n,r){var i=e._xRange,o=e._yRange,a=e._zRange,s=e._vCenter,l=(n+this._cellOuterR)*(n+this._cellOuterR),c=-1;n>this._cellOuterR&&(c=(n-this._cellOuterR)*(n-this._cellOuterR)),i.set(t.x-n,t.x+n),i.subScalar(this._box.min.x).divideScalar(this._cellSize.x).floor(),i.x=Math.min(Math.max(i.x,0),this._count.x-1),i.y=Math.min(Math.max(i.y,0),this._count.x-1),o.set(t.y-n,t.y+n),o.subScalar(this._box.min.y).divideScalar(this._cellSize.y).floor(),o.x=Math.min(Math.max(o.x,0),this._count.y-1),o.y=Math.min(Math.max(o.y,0),this._count.y-1),a.set(t.z-n,t.z+n),a.subScalar(this._box.min.z).divideScalar(this._cellSize.z).floor(),a.x=Math.min(Math.max(a.x,0),this._count.z-1),a.y=Math.min(Math.max(a.y,0),this._count.z-1);for(var u=a.x;u<=a.y;++u){var h=[this._box.min.z+u*this._cellSize.z,this._box.min.z+(u+1)*this._cellSize.z];s.z=.5*(h[0]+h[1]);for(var d=o.x;d<=o.y;++d){var f=[this._box.min.y+d*this._cellSize.y,this._box.min.y+(d+1)*this._cellSize.y];s.y=.5*(f[0]+f[1]);for(var p=i.x;p<=i.y;++p){var m=[this._box.min.x+p*this._cellSize.x,this._box.min.x+(p+1)*this._cellSize.x];s.x=.5*(m[0]+m[1]);var v=t.distanceToSquared(s);v<=l&&r(p+this._count.x*(d+this._count.y*u),v<=c)}}}}},{key:"forEachAtomWithinRadius",value:function(e,t,n){var r=this,i=t*t;r._forEachVoxelWithinRadius(e,t,(function(t,o){o?r._forEachAtomInVoxel(t,n):r._forEachAtomInVoxel(t,(function(t){e.distanceToSquared(t.position)<=i&&n(t)}))}))}},{key:"forEachAtomWithinDistFromMasked",value:function(e,t,n,r){this._forEachAtomWithinDistFromGroup((function(n){e.forEachAtom((function(e){0!=(e.mask&t)&&n(e)}))}),n,r)}},{key:"forEachAtomWithinDistFromSelected",value:function(e,t,n,r){this._forEachAtomWithinDistFromGroup((function(n){e.forEachAtom((function(e){t.includesAtom(e)&&n(e)}))}),n,r)}},{key:"_forEachAtomWithinDistFromGroup",value:function(e,t,n){var r,i=this,o=t*t,a=[],s=[],l=0;e((function(e){i._forEachVoxelWithinRadius(e.position,t,(function(t,n){n?a[t]=-1:void 0===a[t]?(s.push(e),s.push(-1),a[t]=l,l+=2):-1!==a[t]&&(s.push(e),s.push(a[t]),a[t]=l,l+=2)}))}));var c=function(e){if(void 0!==a[r])if(-1!==(l=a[r])){for(;l>=0;l=s[l+1])if(e.position.distanceToSquared(s[l].position)<o){n(e);break}}else n(e)};for(r in a)a.hasOwnProperty(r)&&i._forEachAtomInVoxel(r,c)}}]),e}();Re()(ln,"_zero",new d.Vector3(0,0,0)),Re()(ln,"_voxel",new d.Vector3),Re()(ln,"_xRange",new d.Vector2),Re()(ln,"_yRange",new d.Vector2),Re()(ln,"_zRange",new d.Vector2),Re()(ln,"_vCenter",new d.Vector3);var cn=ln,un=function(){function e(t){m()(this,e),this._complex=t,this._hbonds=[],this._complex._residues.length>1e3?this._buildVW():this._build()}return y()(e,[{key:"isBond",value:function(e,t){if(this._hbonds[e]){var n=c()(this._hbonds[e].acceptor,2),r=n[0],i=n[1];if(r&&r.residue===t&&r.energy<-.5)return!0;if(i&&i.residue===t&&i.energy<-.5)return!0}return!1}},{key:"_build",value:function(){for(var e=0;e<this._complex._residues.length-1;++e){var t=this._complex._residues[e];if(0!=(t.getType().flags&He.Flags.PROTEIN)){var n=null;e>0&&this._complex._residues[e-1].getType().flags&He.Flags.PROTEIN&&t._sequence===this._complex._residues[e-1]._sequence+1&&(n=this._complex._residues[e-1]);for(var r=e+1;r<this._complex._residues.length;++r){var i=this._complex._residues[r];if(0!=(i.getType().flags&He.Flags.PROTEIN)){var o=null;this._complex._residues[r-1].getType().flags&He.Flags.PROTEIN&&i._sequence===this._complex._residues[r-1]._sequence+1&&(o=this._complex._residues[r-1]),this._calcHBondEnergy(n,t,i),r!==e+1&&this._calcHBondEnergy(o,i,t)}}}}}},{key:"_buildVW",value:function(){var e,t,n=this,r=this._complex._residues,i=this._complex.getVoxelWorld();if(null!==i)for(var o=new Ut(this._complex._residues.length*this._complex._residues.length/2),a=0;a<r.length-1;++a)0!=((e=r[a]).getType().flags&He.Flags.PROTEIN)&&(!(t=a>0?r[a-1]:null)||0!=(t.getType().flags&He.Flags.PROTEIN)&&e._sequence===t._sequence+1||(t=null),i.forEachAtomWithinRadius(this._residueGetCAlpha(e),5,s));function s(i){var a=i.residue;if(a._index!==e._index&&0!=(a.getType().flags&He.Flags.PROTEIN)&&o.addPair(e._index,a._index)){var s=a._index>0?r[a._index-1]:null;!s||0!=(s.getType().flags&He.Flags.PROTEIN)&&a._sequence===s._sequence+1||(s=null),n._calcHBondEnergy(t,e,a),a._index!==e._index+1&&n._calcHBondEnergy(s,a,e)}}}},{key:"_residueGetCAlpha",value:function(e){for(var t=0;t<e._atoms.length;++t){var n=e._atoms[t].name;if("CA"===n||"C1"===n)return e._atoms[t].position}return null}},{key:"_residueGetCO",value:function(e){var t=null,n=null;return e.forEachAtom((function(e){"C"===e.name?t=e.position:"O"===e.name&&(n=e.position)})),[t,n]}},{key:"_residueGetNH",value:function(e,t){var n,r=this._residueGetCO(e),i=c()(r,2),o=i[0],a=i[1];if(t.forEachAtom((function(e){"N"===e.name&&(n=e.position)})),o&&a&&n){var s=o.clone();return s.sub(a),s.multiplyScalar(1/s.length()),s.add(n),[n,s]}return[null,null]}},{key:"_calcHBondEnergy",value:function(e,t,n){var r=0;if(null===e)return r;if("PRO"!==t.getType().getName()){var i=this._residueGetNH(e,t),o=c()(i,2),a=o[0],s=o[1],l=this._residueGetCO(n),u=c()(l,2),h=u[0],d=u[1];if(null===a||null===s||null===h||null===d)return r;var f=s.distanceTo(d),p=s.distanceTo(h),m=a.distanceTo(h),v=a.distanceTo(d);r=f<.5||p<.5||m<.5||v<.5?-9.9:-27.888/f- -27.888/p+-27.888/m- -27.888/v,(r=Math.round(1e3*r)/1e3)<-9.9&&(r=-9.9)}void 0===this._hbonds[t._index]&&(this._hbonds[t._index]={donor:[],acceptor:[]});var y=this._hbonds[t._index];y.acceptor.length<2&&y.acceptor.push({residue:n._index,energy:r}),y.acceptor.length>1&&(r<y.acceptor[0].energy?(y.acceptor[1].residue=y.acceptor[0].residue,y.acceptor[1].energy=y.acceptor[0].energy,y.acceptor[0].residue=n._index,y.acceptor[0].energy=r):r<y.acceptor[1].energy&&(y.acceptor[1].residue=n._index,y.acceptor[1].energy=r)),void 0===this._hbonds[n._index]&&(this._hbonds[n._index]={donor:[],acceptor:[]});var _=this._hbonds[n._index];return _.donor.length<2&&_.donor.push({residue:t._index,energy:r}),_.donor.length>1&&(r<_.donor[0].energy?(_.donor[1].residue=_.donor[0].residue,_.donor[1].energy=_.donor[0].energy,_.donor[0].residue=t._index,_.donor[0].energy=r):r<_.donor[1].energy&&(_.donor[1].residue=t._index,_.donor[1].energy=r)),r}}]),e}();function hn(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return dn(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return dn(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw o}}}}function dn(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var fn,pn,mn=Object.freeze({NO_BRIDGE:0,PARALLEL:1,ANTI_PARALLEL:2}),vn=Object.freeze({START:1,MIDDLE:2,END:3,START_AND_END:4}),yn=Object.freeze({STRAND:"E",BRIDGE:"B",HELIX_310:"G",HELIX_ALPHA:"H",HELIX_PI:"I",TURN:"T",BEND:"S",LOOP:" "}),_n=function(){function e(t){m()(this,e),this._complex=t,this._build()}return y()(e,[{key:"_build",value:function(){this._hbonds=new un(this._complex),this._ss=[],this._sheet=[],this._betaPartners=[],this._bend=[];for(var e=0;e<this._complex.getResidues().length;++e)this._betaPartners[e]=[];this._helixFlags=[],this._helixFlags[3]=[],this._helixFlags[4]=[],this._helixFlags[5]=[],this._chainLengths=[];for(var t=0;t<this._complex._chains.length;++t){for(var n=this._complex._chains[t].getResidues(),r=0;r<n.length&&0!=(n[r].getType().flags&He.Flags.PROTEIN);++r);this._chainLengths[t]=r}this._buildBetaSheets();for(var i=0;i<this._complex._chains.length;++i)this._buildAlphaHelices(this._complex._chains[i].getResidues(),this._chainLengths[i],!1)}},{key:"_buildAlphaHelices",value:function(e,t,n){for(var r=3;r<=5&&!(e.length<r);++r)for(var i=0;i+r<t;++i)if(this._hbonds.isBond(e[i+r]._index,e[i]._index)){this._helixFlags[r][e[i+r]._index]=vn.END;for(var o=i+1;o<i+r;++o)void 0===this._helixFlags[r][e[o]._index]&&(this._helixFlags[r][e[o]._index]=vn.MIDDLE);this._helixFlags[r][e[i]._index]===vn.END?this._helixFlags[r][e[i]._index]=vn.START_AND_END:this._helixFlags[r][e[i]._index]=vn.START}for(var a=2;a<t-2;++a){var s=this._kappa(e[a-2],e[a],e[a+2]);this._bend[e[a]._index]=360!==s&&s>70}for(var l=1;l+4<t;++l)if(this._isHelixStart(e[l]._index,4)&&this._isHelixStart(e[l-1]._index,4))for(var c=l;c<=l+3;++c)this._ss[e[c]._index]=yn.HELIX_ALPHA;for(var u=1;u+3<t;++u)if(this._isHelixStart(e[u]._index,3)&&this._isHelixStart(e[u-1]._index,3)){for(var h=!0,d=u;h&&d<=u+2;++d)h=void 0===this._ss[e[d]._index]||this._ss[e[d]._index]===yn.HELIX_310;if(h)for(var f=u;f<=u+2;++f)this._ss[e[f]._index]=yn.HELIX_310}for(var p=1;p+5<t;++p)if(this._isHelixStart(e[p]._index,5)&&this._isHelixStart(e[p-1]._index,5)){for(var m=!0,v=p;m&&v<=p+4;++v)m=void 0===this._ss[e[v]._index]||this._ss[e[v]._index]===yn.HELIX_PI||n&&this._ss[e[v]._index]===yn.HELIX_ALPHA;if(m)for(var y=p;y<=p+4;++y)this._ss[e[y]._index]=yn.HELIX_PI}for(var _=1;_+1<t;++_)if(void 0===this._ss[e[_]._index]){for(var g=!1,x=3;x<=5&&!g;++x)for(var b=1;b<x&&!g;++b)g=_>=b&&this._isHelixStart(e[_-b]._index,x);g?this._ss[e[_]._index]=yn.TURN:this._bend[e[_]._index]&&(this._ss[e[_]._index]=yn.BEND)}}},{key:"_residueGetCAlpha",value:function(e){for(var t=0;t<e._atoms.length;++t){var n=e._atoms[t].name;if("CA"===n||"C1"===n)return e._atoms[t].position}return null}},{key:"_cosinusAngle",value:function(e,t,n,r){var i=e.clone().sub(t),o=n.clone().sub(r),a=0,s=i.dot(i)*o.dot(o);return s>0&&(a=i.dot(o)/Math.sqrt(s)),a}},{key:"_kappa",value:function(e,t,n){var r=this._residueGetCAlpha(t),i=this._residueGetCAlpha(e),o=this._residueGetCAlpha(n);if(null===r||null===i||null===o)return 180;var a=this._cosinusAngle(r,i,o,r),s=Math.sqrt(1-a*a);return 180*Math.atan2(s,a)/Math.PI}},{key:"_isHelixStart",value:function(e,t){return this._helixFlags[t][e]===vn.START||this._helixFlags[t][e]===vn.START_AND_END}},{key:"_buildBetaSheets",value:function(){for(var e=[],t=0;t<this._complex._chains.length;++t){var n=this._chainLengths[t];if(!(n<=4))for(var r=this._complex._chains[t].getResidues(),i=t;i<this._complex._chains.length;++i){var o=this._chainLengths[i];if(!(o<=4))for(var a=this._complex._chains[i].getResidues(),s=1;s+1<n;++s){var l=r[s],c=1;for(i===t&&(c=s+3);c+1<o;++c){var u=a[c],h=this._testBridge(r,s,a,c);if(h!==mn.NO_BRIDGE){var d,f=!1,p=hn(e);try{for(p.s();!(d=p.n()).done;){var m=d.value;if(h===m.type&&l._index===m.i[m.i.length-1]+1){if(h===mn.PARALLEL&&m.j[m.j.length-1]+1===u._index){m.i.push(l._index),m.j.push(u._index),f=!0;break}if(h===mn.ANTI_PARALLEL&&m.j[0]-1===u._index){m.i.push(l._index),m.j.unshift(u._index),f=!0;break}}}}catch(e){p.e(e)}finally{p.f()}f||e.push({type:h,i:[l._index],chainI:l.getChain()._index,j:[u._index],chainJ:u.getChain()._index})}}}}}e.sort((function(e,t){return e.chainI<t.chainI||e.chainI===t.chainI&&e.i[0]<t.i[0]?-1:1}));for(var v=0;v<e.length;++v)for(var y=v+1;y<e.length;++y){var _=e[v].i[0],g=e[v].i[e[v].i.length-1],x=e[v].j[0],b=e[v].j[e[v].j.length-1],w=e[y].i[0],S=e[y].i[e[y].i.length-1],C=e[y].j[0],R=e[y].j[e[y].j.length-1];if(!(e[v].type!==e[y].type||this._hasChainBreak(Math.min(_,w),Math.max(g,S))||this._hasChainBreak(Math.min(x,C),Math.max(b,R))||w-g>=6||g>=w&&_<=S)){(e[v].type===mn.PARALLEL?C-b<6&&w-g<3||C-b<3:x-R<6&&w-g<3||x-R<3)&&(e[v].i=e[v].i.concat(e[y].i),e[v].type===mn.PARALLEL?e[v].j=e[v].j.concat(e[y].j):e[v].j=e[y].j.concat(e[v].j),e.splice(y--,1))}}for(var A=new Set,E=0;E<e.length;++E)A.add(e[E]);for(var k=1,T=0;A.size>0;){var P=A.values().next().value;A.delete(P);var M=new Set;M.add(P);var I=void 0;do{I=new Set;var N,L=hn(M.values());try{for(L.s();!(N=L.n()).done;){var D,O=N.value,V=hn(A.values());try{for(V.s();!(D=V.n()).done;){var z=D.value;this._areBridgesLinked(O,z)&&I.add(z)}}catch(e){V.e(e)}finally{V.f()}}}catch(e){L.e(e)}finally{L.f()}var F,B=hn(I.values());try{for(B.s();!(F=B.n()).done;)P=F.value,M.add(P),A.delete(P)}catch(e){B.e(e)}finally{B.f()}}while(I.size>0);var U,G=hn(M.values());try{for(G.s();!(U=G.n()).done;)(P=U.value).ladder=T,P.sheet=k,P.link=M,++T}catch(e){G.e(e)}finally{G.f()}++k}for(var j=0;j<e.length;++j){for(var H=e[j],W=0,Y=0,q=0;q<H.i.length;++q)if(this._betaPartners[H.i[q]][0]){W=1;break}for(var X=0;X<H.j.length;++X)if(this._betaPartners[H.j[X]][0]){Y=1;break}var $=yn.BRIDGE;if(H.i.length>1&&($=yn.STRAND),H.type===mn.PARALLEL){for(var K=0,Z=0;Z<H.i.length;++Z)this._betaPartners[H.i[Z]][W]={residue:H.j[K++],ladder:H.ladder,parallel:!0};K=0;for(var Q=0;Q<H.j.length;++Q)this._betaPartners[H.j[Q]][Y]={residue:H.i[K++],ladder:H.ladder,parallel:!0}}else{for(var J=H.j.length-1,ee=0;ee<H.i.length;++ee)this._betaPartners[H.i[ee]][W]={residue:H.j[J--],ladder:H.ladder,parallel:!1};J=H.i.length-1;for(var te=0;te<H.j.length;++te)this._betaPartners[H.j[te]][Y]={residue:H.i[J--],ladder:H.ladder,parallel:!1}}for(var ne=H.i[0];ne<=H.i[H.i.length-1];++ne)this._ss[ne]!==yn.STRAND&&(this._ss[ne]=$,this._sheet[ne]=H.sheet);for(var re=H.j[0];re<=H.j[H.j.length-1];++re)this._ss[re]!==yn.STRAND&&(this._ss[re]=$,this._sheet[re]=H.sheet)}}},{key:"_testBridge",value:function(e,t,n,r){var i=mn.NO_BRIDGE,o=e[t-1]._index,a=e[t]._index,s=e[t+1]._index,l=n[r-1]._index,c=n[r]._index,u=n[r+1]._index,h=this._hbonds.isBond.bind(this._hbonds);return h(s,c)&&h(c,o)||h(u,a)&&h(a,l)?i=mn.PARALLEL:(h(s,l)&&h(u,o)||h(c,a)&&h(a,c))&&(i=mn.ANTI_PARALLEL),i}},{key:"_areBridgesLinked",value:function(e,t){var n,r=new Set(e.i),i=new Set(e.j),o=hn(t.i);try{for(o.s();!(n=o.n()).done;){var a=n.value;if(r.has(a)||i.has(a))return!0}}catch(e){o.e(e)}finally{o.f()}var s,l=hn(t.j);try{for(l.s();!(s=l.n()).done;){var c=s.value;if(r.has(c)||i.has(c))return!0}}catch(e){l.e(e)}finally{l.f()}return!1}},{key:"_hasChainBreak",value:function(e,t){for(var n=e+1;n<=t;++n)if(this._complex._residues[n]._sequence!==this._complex._residues[n-1]._sequence+1)return!0;return!1}}]),e}();_n.StructureType=yn;var gn=_n.StructureType,xn=Qe.Type,bn=(fn={},Re()(fn,gn.HELIX_ALPHA,1),Re()(fn,gn.HELIX_PI,3),Re()(fn,gn.HELIX_310,5),fn),wn=(pn={},Re()(pn,gn.BRIDGE,xn.BRIDGE),Re()(pn,gn.TURN,xn.TURN),Re()(pn,gn.BEND,xn.BEND),Re()(pn,gn.LOOP,xn.COIL),pn),Sn=function(){function e(){m()(this,e),this._chains=[],this._components=[],this._helices=[],this._sheets=[],this.structures=[],this._residueTypes=Object.create(He.StandardTypes),this._atoms=[],this._residues=[],this._bonds=[],this._sgroups=[],this._molecules=[],this._maskNeedsUpdate=!1,this.metadata={},this.symmetry=[],this.units=[new Vt(this)],this._currentUnit=0}return y()(e,[{key:"addAtom",value:function(e){var t=this._atoms.length;return this._atoms.push(e),t}},{key:"addSheet",value:function(e){var t=this._sheets.length;return this._sheets.push(e),t}},{key:"addHelix",value:function(e){var t=this._helices.length;return this._helices.push(e),t}},{key:"getAtoms",value:function(){return this._atoms}},{key:"getBonds",value:function(){return this._bonds}},{key:"getAtomCount",value:function(){return this._atoms.length}},{key:"addResidue",value:function(e){var t=this._residues.length;return this._residues.push(e),t}},{key:"updateToFrame",value:function(e){this.forEachChain((function(t){t.updateToFrame(e)}))}},{key:"addResidueType",value:function(e){return this._residueTypes[e]=new He(e,"Unknown","")}},{key:"getResidueCount",value:function(){return this._residues.length}},{key:"getResidues",value:function(){return this._residues}},{key:"getSGroupCount",value:function(){return this._sgroups.length}},{key:"getSGroups",value:function(){return this._sgroups}},{key:"getAtomByFullname",value:function(e){var t=e.split(".");if(3!==t.length)return null;var n=t[0],r=parseInt(t[1],10);if(Number.isNaN(r))return null;var i=t[2].toUpperCase(),o=null;return this.forEachChain((function(e){o||0===e._name.localeCompare(n)&&e.forEachResidue((function(e){o||e._sequence===r&&e.forEachAtom((function(e){o||0===i.localeCompare(e.name)&&(o=e)}))}))})),o}},{key:"addChain",value:function(e){var t=new Xe(this,e);return this._chains.push(t),t}},{key:"getChain",value:function(e){for(var t=0,n=this._chains.length;t<n;++t){var r=this._chains[t];if(r.getName()===e)return r}return null}},{key:"getChainCount",value:function(){return this._chains.length}},{key:"getMolecules",value:function(){return this._molecules}},{key:"getMoleculeCount",value:function(){return this._molecules.length}},{key:"forEachAtom",value:function(e){for(var t=this._atoms,n=0,r=t.length;n<r;++n)e(t[n])}},{key:"forEachBond",value:function(e){for(var t=this._bonds,n=0,r=t.length;n<r;++n)e(t[n])}},{key:"forEachResidue",value:function(e){for(var t=this._residues,n=0,r=t.length;n<r;++n)e(t[n])}},{key:"forEachChain",value:function(e){for(var t=this._chains,n=0,r=t.length;n<r;++n)e(t[n])}},{key:"forEachMolecule",value:function(e){for(var t=this._molecules,n=t.length,r=0;r<n;++r)e(t[r])}},{key:"forEachSGroup",value:function(e){for(var t=this._sgroups,n=0,r=t.length;n<r;++n)e(t[n])}},{key:"forEachComponent",value:function(e){for(var t=this._components,n=0,r=t.length;n<r;++n)e(t[n])}},{key:"forEachVisibleComponent",value:function(e){for(var t=this._components,n=0,r=t.length;n<r;++n)e(t[n])}},{key:"addBond",value:function(e,t,n,r,i){var o=new Ne(e,t,n,r,i);return this._bonds.push(o),o}},{key:"getBondCount",value:function(){return this._bonds.length}},{key:"getResidueType",value:function(e){return this._residueTypes[e]||null}},{key:"getUnifiedSerial",value:function(e,t,n){return t+65536*n+16777216*e}},{key:"splitUnifiedSerial",value:function(e){var t=Math.floor(e/16777216),n=e-16777216*t,r=Math.floor(n/65536);return{chain:t,serial:n-65536*r,iCode:r}}},{key:"_fillCmpEdit",value:function(){var e=this,t=this._components;function n(){var n=new Bt(e);return n._index=t.length,t[n._index]=n,n}this.forEachChain((function(e){var t=e._residues,r=t.length;if(!(r<1))for(var i=n(),o=t[0]._index,a=0;a<r;++a){var s=t[a];s._component=i;var l=a===r-1?null:t[a+1];l&&s.isConnected(l)&&s._index===l._index-1||(i.setSubDivs([{start:o,end:s._index}]),l&&(o=l._index,i=n()))}}))}},{key:"_fillCmpNoedit",value:function(){var e=new Bt(this);e._index=0;var t=this._residues,n=t.length;if(0!==n){for(var r=[],i=0,o=0;o<n;++o){var a=t[o];a._component=e;var s=o===n-1?null:t[o+1];s&&a.isConnected(s)||(r[r.length]={start:i,end:o},s&&(i=o+1))}e.setSubDivs(r),this._components[e._index]=e}}},{key:"_fillComponents",value:function(e){e?this._fillCmpEdit():this._fillCmpNoedit()}},{key:"getCurrentUnit",value:function(){return this._currentUnit}},{key:"getDefaultBoundaries",value:function(){return this.units[0].getBoundaries()}},{key:"getBoundaries",value:function(){return this.units[this._currentUnit].getBoundaries()}},{key:"getTransforms",value:function(){return this.units[this._currentUnit].getTransforms()}},{key:"getSelector",value:function(){return this.units[this._currentUnit].getSelector()}},{key:"resetCurrentUnit",value:function(){this._currentUnit=0,this.setCurrentUnit(1)}},{key:"setCurrentUnit",value:function(e){return null!=e&&e!==this._currentUnit&&e>=0&&e<this.units.length&&(this._currentUnit=e,!0)}},{key:"_computeBounds",value:function(){for(var e=this.units,t=0,n=e.length;t<n;++t)e[t].computeBoundaries()}},{key:"onAtomPositionChanged",value:function(){this.forEachChain((function(e){e._finalize()})),this.forEachComponent((function(e){e.update()})),this._computeBounds(),this._finalizeBonds(),this.forEachSGroup((function(e){e._rebuildSGroupOnAtomChange()}))}},{key:"update",value:function(){this._maskNeedsUpdate&&(this.updateStructuresMask(),this._maskNeedsUpdate=!1)}},{key:"_finalizeBonds",value:function(){for(var e=this.getBonds(),t=e.length,n=0;n<t;++n)e[n]._index=n}},{key:"finalize",value:function(e){e=e||{};var t,n,r=this._bonds;for(t=r.length-1;t>=0;t--){var i=r[t];null===i._left||null===i._right?r.splice(t,1):(i._left.bonds.push(i),i._right.bonds.push(i))}var o=this._residues;for(t=0,n=o.length;t<n;++t)o[t]._finalize();this.forEachChain((function(e){e._finalize()}));var a=this.units;for(t=0,n=a.length;t<n;++t)a[t].finalize();this.setCurrentUnit(1);var s={};for(t=0,n=o.length;t<n;++t){var l=o[t];s[this.getUnifiedSerial(l.getChain().getName().charCodeAt(0),l.getSequence(),l.getICode().charCodeAt(0))]=l}var c=this.structures;for(t=0,n=c.length;t<n;++t)c[t]._finalize(e.serialAtomMap,s,this);var u=this._helices;for(t=0,n=u.length;t<n;++t)u[t]._finalize(e.serialAtomMap,s,this);var h=this._sheets;for(t=0,n=h.length;t<n;++t)h[t]._finalize(e.serialAtomMap,s,this);this._computeBounds();var d=this._atoms;for(t=0,n=d.length;t<n;++t){d[t].index=t}if(e.needAutoBonding){var f=new Yt(this);f.build(),f.destroy()}var p=this._chains;for(t=0,n=p.length;t<n;++t)p[t]._index=t;for(t=0,n=o.length;t<n;++t)o[t]._index=t;for(t=0,n=d.length;t<n;++t){var m=d[t];if(m.flags&Ee.Flags.HYDROGEN&&1===m.bonds.length){var v=m.bonds[0];(v._left!==m&&v._left||v._right).flags&Ee.Flags.CARBON&&(m.flags|=Ee.Flags.NONPOLARH)}}this._finalizeBonds(),this._fillComponents(e.enableEditing);var y=new on(this);y.markCycles(),e.detectAromaticLoops&&y.detectCycles(),this._finalizeMolecules()}},{key:"_finalizeMolecules",value:function(){for(var e=0;e<this._molecules.length;e++)for(var t=this._molecules[e],n=t.residues.length,r=0;r<n;r++){t.residues[r]._molecule=t}}},{key:"updateStructuresMask",value:function(){var e=function(e){return e.collectMask()};this.forEachResidue(e),this.forEachChain(e),this.forEachMolecule(e)}},{key:"countAtomsByMask",value:function(e){var t=0;return this.forEachAtom((function(n){0!=(n.mask&e)&&t++})),t}},{key:"getNumAtomsBySelector",value:function(e){var t=0;return this.forEachAtom((function(n){e.includesAtom(n)&&t++})),t}},{key:"resetAtomMask",value:function(e){this.forEachAtom((function(t){t.mask=e}))}},{key:"markAtoms",value:function(e,t){var n=t,r=~n,i=0,o=Ot.keyword("And")(e,this.getSelector());return this.forEachAtom((function(e){o.includesAtom(e)?(e.mask|=n,i++):e.mask&=r})),this._maskNeedsUpdate=!0,i}},{key:"markAtomsAdditionally",value:function(e,t){var n=t,r=0;return this.forEachAtom((function(i){e.includesAtom(i)&&(i.mask&t)!==t&&(i.mask|=n,r++)})),r}},{key:"clearAtomBits",value:function(e){var t=~e;this.forEachAtom((function(e){e.mask&=t}));var n=function(e){e._mask&=t};this.forEachAtom(n),this.forEachResidue(n),this.forEachChain(n),this.forEachMolecule(n)}},{key:"getAtomNames",value:function(){if(this.hasOwnProperty("_atomNames"))return this._atomNames;var e={};return this.forEachAtom((function(t){e[t.name]=1})),this._atomNames=Object.keys(e),this._atomNames}},{key:"getElements",value:function(){if(this.hasOwnProperty("_elements"))return this._elements;var e={};return this.forEachAtom((function(t){e[t.element.name]=1})),this._elements=Object.keys(e),this._elements}},{key:"getResidueNames",value:function(){if(this.hasOwnProperty("_residueNames"))return this._residueNames;var e={};return this.forEachResidue((function(t){e[t._type._name]=1})),this._residueNames=Object.keys(e),this._residueNames}},{key:"getChainNames",value:function(){if(this.hasOwnProperty("_chainNames"))return this._chainNames;var e={};return this.forEachChain((function(t){e[t._name]=1})),this._chainNames=Object.keys(e),this._chainNames}},{key:"getAltLocNames",value:function(){if(this.hasOwnProperty("_altlocNames"))return this._altlocNames;var e={};return this.forEachAtom((function(t){e[String.fromCharCode(t.location)]=1})),this._altlocNames=Object.keys(e),this._altlocNames}},{key:"getVoxelWorld",value:function(){if(!this.hasOwnProperty("_voxelWorld"))try{this._voxelWorld=new cn(this.getDefaultBoundaries().boundingBox,new d.Vector3(5,5,5)),this._voxelWorld.addAtoms(this)}catch(e){O.warn("Unable to create voxel world"),this._voxelWorld=null}return this._voxelWorld}},{key:"addElement",value:function(e,t,n,r){for(var i=e.length,o=0;o<i;++o){var a=e[o];r(a,n),t.push(a)}}},{key:"joinComplexes",value:function(e){this._chains=[],this._components=[],this._helices=[],this._sheets=[],this.structures=[],this._atoms=[],this._residues=[],this._bonds=[],this._sgroups=[];var t=this,n=0,r=0,i=0,o=0,a=0;function s(e,t){e.serial+=t,e.index+=t}function l(e,t){e._index+=t}function c(e,t){e._index+=t}function u(e,n){e._complex=t,e._index+=n}function h(e,n){e._complex=t,e._index+=n}function d(){}for(var f=0;f<e.length;++f){var p=e[f];for(var m in this.addElement(p._atoms,this._atoms,n,s),this.addElement(p._bonds,this._bonds,r,l),this.addElement(p._residues,this._residues,i,c),this.addElement(p._chains,this._chains,o,u),this.addElement(p._sheets,this._sheets,0,d),this.addElement(p._helices,this._helices,0,d),this.addElement(p._sgroups,this._sgroups,0,d),this.addElement(p._components,this._components,a,h),this.addElement(p.structures,this.structures,0,d),p._residueTypes)p._residueTypes.hasOwnProperty(m)&&(this._residueTypes[m]=p._residueTypes[m]);n+=p._atoms.length,r+=p._bonds.length,i+=p._residues.length,o+=p._chains.length,a+=p._components.length}this._computeBounds()}},{key:"dssp",value:function(){for(var e,t,n,r,i=new _n(this),o=this.structures=[],a=this._helices=[],s=this._sheets=[],l=0,c=null,u=0,h=this._residues.length;u<h;++u){var d=i._ss[u],f=this._residues[u],p=i._sheet[u];if(d!==e||p!==t){var m=bn[d],v=wn[d];if(d===gn.STRAND){var y=(r=void 0,(r=s[n=p])||(r=s[n]=new st(String(n),0)),r);c=new at(y,f,f,0,null,null),y.addStrand(c)}else void 0!==m?(l++,c=new nt(m,f,f,l,String(l),"",1),a.push(c)):c=void 0!==v?new Qe(v,f,f):null;c&&o.push(c),f._secondary=c,e=d,t=p}else f._secondary=c,c&&(c.term=f),c instanceof nt&&c.length++}this._sheets=s.filter((function(e){return!0}))}}]),e}();Sn.prototype.id="Complex",Sn.prototype.name="";var Cn=Sn;function Rn(e){var t=2;for(e=e-1>>1;e;)t<<=1,e>>=1;return t}var An=function(){function e(t,n,r,i,o,a){if(m()(this,e),this._box=r.clone(),this._dimVec=Math.max(Math.floor(i||1),1),this._volumeInfo=a,n instanceof Array){var s=c()(n,3);this._dimX=s[0],this._dimY=s[1],this._dimZ=s[2]}else this._dimX=n.x,this._dimY=n.y,this._dimZ=n.z;switch(this._dimX=Math.max(Math.floor(this._dimX),1),this._dimY=Math.max(Math.floor(this._dimY),1),this._dimZ=Math.max(Math.floor(this._dimZ),1),this._rowElements=this._dimVec*this._dimX,this._planeElements=this._rowElements*this._dimY,this._totalElements=this._planeElements*this._dimZ,this._data=o||K.allocateTyped(t,this._totalElements),this._dimVec){case 1:break;case 2:this.getValue=function(e,t,n){var r=e*this._dimVec+t*this._rowElements+n*this._planeElements;return[this._data[r],this._data[r+1]]},this.setValue=function(e,t,n,r,i){var o=e*this._dimVec+t*this._rowElements+n*this._planeElements;this._data[o]=r,this._data[o+1]=i},this.addValue=function(e,t,n,r,i){var o=e*this._dimVec+t*this._rowElements+n*this._planeElements;this._data[o]+=r,this._data[o+1]+=i};break;case 3:this.getValue=function(e,t,n){var r=e*this._dimVec+t*this._rowElements+n*this._planeElements;return[this._data[r],this._data[r+1],this._data[r+2]]},this.setValue=function(e,t,n,r,i,o){var a=e*this._dimVec+t*this._rowElements+n*this._planeElements;this._data[a]=r,this._data[a+1]=i,this._data[a+2]=o},this.addValue=function(e,t,n,r,i,o){var a=e*this._dimVec+t*this._rowElements+n*this._planeElements;this._data[a]+=r,this._data[a+1]+=i,this._data[a+2]+=o};break;default:throw new Error("Volume: invalid vector dimension")}}return y()(e,[{key:"getValue",value:function(e,t,n){return this._data[e+t*this._rowElements+n*this._planeElements]}},{key:"setValue",value:function(e,t,n,r){this._data[e+t*this._rowElements+n*this._planeElements]=r}},{key:"addValue",value:function(e,t,n,r){this._data[e+t*this._rowElements+n*this._planeElements]+=r}},{key:"getDimensions",value:function(){return[this._dimX,this._dimY,this._dimZ]}},{key:"getBox",value:function(){return this._box}},{key:"getVolumeInfo",value:function(){return this._volumeInfo}},{key:"getCellSize",value:function(){var e=new d.Vector3;this._box.getSize(e);var t=new d.Vector3;return t.x=this._dimX>1?e.x/(this._dimX-1):0,t.y=this._dimY>1?e.y/(this._dimY-1):0,t.z=this._dimZ>1?e.z/(this._dimZ-1):0,t}},{key:"computeGradient",value:function(){if(1!==this._dimVec)return null;var t=new e(Float32Array,[this._dimX,this._dimY,this._dimZ],this._box,3),n=this.getCellSize(),r=new d.Vector3(-.5/n.x,-.5/n.y,-.5/n.z);function i(e,t,n){return Math.min(n,Math.max(t,e))}var o=this._dimX,a=this._dimY,s=this._dimZ,l=this._data;function c(e,t,n){return l[n*o*a+t*o+e]}for(var u=0;u<s;++u)for(var h=i(u-1,0,s-1),f=i(u+1,0,s-1),p=0;p<a;++p)for(var m=i(p-1,0,a-1),v=i(p+1,0,a-1),y=0;y<o;++y){var _=i(y-1,0,o-1),g=i(y+1,0,o-1);t.setValue(y,p,u,(c(g,p,u)-c(_,p,u))*r.x,(c(y,v,u)-c(y,m,u))*r.y,(c(y,p,f)-c(y,p,h))*r.z)}return t}},{key:"normalize",value:function(){for(var e=this._data,t=e[0],n=e[0],r=1;r<e.length;++r)t=Math.min(t,e[r]),n=Math.max(n,e[r]);var i=1/(n-t);if(0!==i)for(var o=0;o<e.length;++o)e[o]=i*(e[o]-t)}},{key:"getTiledTextureStride",value:function(){return[this._dimX+2,this._dimY+2]}},{key:"buildTiledTexture",value:function(){var e=Math.ceil(Math.sqrt(this._dimZ*this._dimY/this._dimX)),t=e*(this._dimX+2)-1;t=Rn(t),e=Math.floor(t/(this._dimX+2));var n=Math.ceil(this._dimZ/e),r=n*(this._dimY+2)-1;r=Rn(r);for(var i,o,a=new Uint8Array(t*r),s=0;s<n;++s)for(var l=0;l<this._dimY;++l){i=s*e*this._planeElements+l*this._rowElements,o=t*(s*(this._dimY+2)+l);for(var c=0;c<e;++c){for(var u=0;u<this._dimX;++u)a[o++]=255*this._data[i++];a[o++]=255*this._data[i-1],c<e-1&&(i+=this._planeElements-this._rowElements,a[o++]=255*this._data[i])}}for(var h=0;h<n;++h){o=(i=t*(h*(this._dimY+2)+this._dimY-1))+t;for(var f=0;f<t;++f)a[o++]=a[i++];if(h<n-1){o=(i=t*(h+1)*(this._dimY+2))-t;for(var p=0;p<t;++p)a[o++]=a[i++]}}var m=new d.DataTexture(a,t,r,d.LuminanceFormat,d.UnsignedByteType,d.UVMapping,d.ClampToEdgeWrapping,d.ClampToEdgeWrapping,d.LinearFilter,d.LinearFilter);return m.needsUpdate=!0,m}},{key:"getData",value:function(){return this._data}},{key:"getDirectIdx",value:function(e,t,n){return e*this._dimVec+t*this._rowElements+n*this._planeElements}},{key:"getStrideX",value:function(){return this._dimVec}},{key:"getStrideY",value:function(){return this._rowElements}},{key:"getStrideZ",value:function(){return this._planeElements}}]),e}();An.prototype.id="Volume";var En=An,kn={Atom:Ee,Element:Te,Bond:Ne,Residue:Fe,ResidueType:He,Chain:Xe,Helix:nt,Strand:at,Sheet:st,SGroup:lt,Assembly:Ft,Complex:Cn,Volume:En,VoxelWorld:cn,selectors:Ot,Molecule:function(){function e(t,n,r){m()(this,e),this.complex=t,this.name=n||"",this.residues=[],this.mask=1,this.index=r||-1}return y()(e,[{key:"forEachResidue",value:function(e){for(var t=this.residues,n=0,r=t.length;n<r;++n)e(t[n])}},{key:"collectMask",value:function(){for(var e=4294967295,t=this.residues,n=0,r=t.length;n<r;++n)e&=t[n]._mask;this.mask=e}}]),e}()},Tn=n("1Pcy"),Pn=n.n(Tn);function Mn(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var In=function(e){S()(n,e);var t=Mn(n);function n(e){var r;m()(this,n),r=t.call(this);var i=Pn()(r);return r._element=e,r._element.style.position="absolute",r.addEventListener("removed",(function(){null!==i._element.parentNode&&i._element.parentNode.removeChild(i._element)})),r}return y()(n,[{key:"getElement",value:function(){return this._element}},{key:"setTransparency",value:function(e){var t=this.getElement();if(null!==t)if(1!==e){t.style.display="inline";var n=1-e,r=n.toString(),i=100*n;t.style.opacity=r,t.style.filter="alpha(opacity=".concat(i,")")}else t.style.display="none"}},{key:"clone",value:function(){var e=new n(this._element);return e.copy(this),e}}]),n}(d.Object3D);function Nn(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var Ln=function(e){S()(n,e);var t=Nn(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"raycast",value:function(e,t){if(this.visible)for(var n=this.children,r=0,i=n.length;r<i;++r)n[r].raycast(e,t)}},{key:"enableSubset",value:function(e,t){for(var n=this.children,r=0,i=n.length;r<i;++r)n[r].enableSubset&&n[r].enableSubset(e,t)}},{key:"disableSubset",value:function(e,t){for(var n=this.children,r=0,i=n.length;r<i;++r)n[r].disableSubset&&n[r].disableSubset(e,t)}},{key:"isEmpty",value:function(){return 0===this.children.length}},{key:"updateToFrame",value:function(e){for(var t=this.children,n=0,r=t.length;n<r;++n)t[n].updateToFrame&&t[n].updateToFrame(e)}},{key:"getSubset",value:function(e,t){for(var n=[],r=this.children,i=0,o=r.length;i<o;++i)r[i].getSubset&&Array.prototype.push.apply(n,r[i].getSubset(e,t));return n}}]),n}(d.Group),Dn="uniform mat4 projectionMatrix;\nuniform mat4 modelViewMatrix;\n\nattribute vec2 uv;\nattribute vec3 position;\n\nvarying vec2 vUv;\n\nvoid main() {\n  vUv = uv;\n  gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}\n";function On(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var Vn,zn,Fn={DEFAULT:0,VOLUME:1,TRANSPARENT:2,PREPASS_TRANSPARENT:3,VOLUME_BFPLANE:4,COLOR_FROM_POSITION:5,SHADOWMAP:6},Bn=[Fn.DEFAULT,Fn.TRANSPARENT];d.Object3D.prototype.resetTransform=function(){this.position.set(0,0,0),this.quaternion.set(0,0,0,1),this.scale.set(1,1,1)},d.Object3D.prototype.updateMatrixWorldRecursive=function(){null!=this.parent&&this.parent.updateMatrixWorldRecursive(),this.updateMatrixWorld()},d.Object3D.prototype.addSavingWorldTransform=(Vn=new d.Matrix4,function(e){e instanceof d.Object3D&&(Vn.copy(this.matrixWorld).invert(),Vn.multiply(e.matrixWorld),e.matrix.copy(Vn),e.matrix.decompose(e.position,e.quaternion,e.scale),this.add(e))}),d.WebGLRenderer.prototype.renderDummyQuad=function(){var e=new d.MeshBasicMaterial({transparent:!0,opacity:0,depthWrite:!1}),t=new d.Scene,n=new d.Mesh(new d.PlaneBufferGeometry(.01,.01),e);t.add(n);var r=new d.OrthographicCamera(-.5,.5,.5,-.5,-1e4,1e4);return r.position.z=100,function(){this.render(t,r)}}(),d.WebGLRenderer.prototype.renderScreenQuad=function(){var e=new d.Scene,t=new d.Mesh(new d.PlaneBufferGeometry(1,1));e.add(t);var n=new d.OrthographicCamera(-.5,.5,.5,-.5,-1e4,1e4);return n.position.z=100,function(r){t.material=r,this.render(e,n)}}(),d.Matrix4.prototype.isIdentity=(zn=new d.Matrix4,function(){return zn.equals(this)}),d.Matrix4.prototype.applyToPointsArray=function(e,t,n){if(!e||!t||t<3)return e;n=n||0;for(var r=this.elements,i=0;i<e.length;i+=t){var o=e[i],a=e[i+1],s=e[i+2],l=1/(r[3]*o+r[7]*a+r[11]*s+r[15]);e[i]=(r[0]*o+r[4]*a+r[8]*s+r[12]*n)*l,e[i+1]=(r[1]*o+r[5]*a+r[9]*s+r[13]*n)*l,e[i+2]=(r[2]*o+r[6]*a+r[10]*s+r[14]*n)*l}return e};var Un,Gn,jn=function(e){S()(n,e);var t=On(n);function n(e){return m()(this,n),void 0===e.uniforms&&(e.uniforms={}),e.uniforms.srcTex={type:"t",value:null},e.vertexShader=Dn,e.transparent=!1,e.depthTest=!1,e.depthWrite=!1,t.call(this,e)}return n}(d.RawShaderMaterial);function Hn(e){e.traverse((function(e){(e instanceof d.Mesh||e instanceof d.LineSegments||e instanceof d.Line)&&e.geometry.dispose()})),function(e){for(var t=e.children,n=0,r=t.length;n<r;++n){var i=t[n];i.parent=null,i.dispatchEvent({type:"removed"})}e.children=[]}(e)}d.WebGLRenderer.prototype.renderScreenQuadFromTex=(Un=new jn({uniforms:{opacity:{type:"f",value:1}},fragmentShader:"precision highp float;\n\nvarying vec2 vUv;\nuniform sampler2D srcTex;\nuniform float opacity;\n\nvoid main() {\n  vec4 color = texture2D(srcTex, vUv);\n  gl_FragColor = vec4(color.xyz, color.a * opacity);\n}\n",transparent:!0}),function(e,t){Un.uniforms.srcTex.value=e,Un.transparent=t<1,Un.uniforms.opacity.value=t,this.renderScreenQuad(Un)}),d.WebGLRenderer.prototype.renderScreenQuadFromTexWithDistortion=function(){var e=new jn({uniforms:{coef:{type:"f",value:1}},fragmentShader:"precision highp float;\n\nvarying vec2 vUv;\nuniform sampler2D srcTex;\nuniform float coef;\n\nvoid main() {\n  vec2 uv = vUv * 2.0 - 1.0;\n  float r2 = dot(uv, uv);\n  vec2 tc = uv * (1.0 + coef * r2);\n  if (!all(lessThan(abs(tc), vec2(1.0))))\n    discard;\n  tc = 0.5 * (tc + 1.0);\n  gl_FragColor = texture2D(srcTex, tc);\n}\n"});return function(t,n){e.uniforms.srcTex.value=t,e.uniforms.coef.value=n,this.renderScreenQuad(e)}}(),d.PerspectiveCamera.prototype.setMinimalFov=function(e){this.aspect>=1?this.fov=e:this.fov=d.MathUtils.radToDeg(2*Math.atan(Math.tan(.5*d.MathUtils.degToRad(e))/this.aspect))},d.StereoCamera.prototype.updateHalfSized=function(e,t){var n=e.aspect,r=e.fov;e.aspect=n/2,e.setMinimalFov(t),e.updateProjectionMatrix(),this.update(e),e.aspect=n,e.fov=r,e.updateProjectionMatrix()},d.PerspectiveCamera.prototype.setDistanceToFit=function(e,t){this.position.z=e/Math.sin(.5*d.MathUtils.degToRad(t))},d.Raycaster.prototype.intersectVisibleObject=function(e,t,n,r){var i=this.intersectObject(e,!1);if(0===i.length)return null;var o,a=Math.min(t.near,n),s=i[0],l=new d.Vector3;for(o=0;o<i.length&&(s=i[o],l.copy(s.point),l.applyMatrix4(t.matrixWorldInverse),!(l.z<=-a));++o);if(o===i.length)return null;var c=Math.min(t.far,r);return l.copy(s.point),l.applyMatrix4(t.matrixWorldInverse),l.z<=-c?null:s},d.Matrix4.prototype.extractScale=(Gn=new d.Vector3,function(e){void 0===e&&(O.debug("extractScale(): new is too expensive operation to do it on-the-fly"),e=Gn.clone());var t=this.elements;return e.x=Gn.set(t[0],t[1],t[2]).length(),e.y=Gn.set(t[4],t[5],t[6]).length(),e.z=Gn.set(t[8],t[9],t[10]).length(),this.determinant()<0&&(e.x=-e.x),e}),d.BufferAttribute.prototype.copyAtList=function(e,t){console.assert(this.itemSize===e.itemSize,"DEBUG: BufferAttribute.copyAtList buffers have different item size.");for(var n=this.itemSize,r=0,i=t.length;r<i;++r)for(var o=0;o<n;++o)this.array[r*n+o]=e.array[t[r]*n+o];return this};var Wn=d.InstancedBufferGeometry.prototype.copy;d.InstancedBufferGeometry.prototype.copy=function(e){Wn.call(this,e),void 0===this.instanceCount&&(this.instanceCount=1/0)};var Yn={calcCylinderMatrix:function(e,t,n){var r=e.clone().lerp(t,.5),i=new d.Matrix4;i.makeScale(n,e.distanceTo(t),n);var o=new d.Matrix4;o.makeRotationX(Math.PI/2);var a=new d.Matrix4,s=new d.Vector3(0,1,0);return a.lookAt(r,t,s),a.multiply(o),a.multiply(i),a.setPosition(r),a},calcChunkMatrix:function(e,t,n,r){var i=new d.Matrix4;i.makeScale(r.x,r.y,0);var o=new d.Matrix4;return o.lookAt(e,t,n),o.multiply(i),o.setPosition(e),o},groupHasGeometryToRender:function(e){var t=!1;return e.traverse((function(e){(e.hasOwnProperty("geometry")||e instanceof In)&&(t=!0)})),t},buildDistorionMesh:function(e,t,n){function r(e){for(var t=0,r=e,i=1;Math.abs(r-t)>1e-5;)t=r,r=e/((i=1+n*r)*i);return 1/i}for(var i=new d.PlaneBufferGeometry(2,2,e,t),o=i.getAttribute("position"),a=0;a<o.count;++a){var s=o.array[3*a],l=o.array[3*a+1],c=r(s*s+l*l);o.setXY(a,c*s,c*l)}return i},RCGroup:Ln,fillArray:function(e,t,n,r){n=void 0!==n?n:0,r=void 0!==r?r:e.length;for(var i=n;i<r;++i)e[i]=t},clearTree:Hn,destroyObject:function(e){Hn(e),e.parent?e.parent.remove(e):e.dispatchEvent({type:"removed"})},belongToSelectLayers:function(e){for(var t=0;t<Bn.length;t++)if(1==(e.layers.mask>>Bn[t]&1))return!0;return!1},processObjRenderOrder:function(e,t){var n=+("BA"!==t);e.traverse((function(e){e.isGroup&&(e.renderOrder=n)}))},applySelectionMaterial:function(e){e.traverse((function(e){"material"in e&&(e.material=e.material.clone(!0),e.material.setValues({depthFunc:d.LessEqualDepth,overrideColor:!0,fog:!1,lights:!1,shadowmap:!1}),e.material.setUberOptions({fixedColor:new d.Color(16776960),zOffset:-1e-6}))}))},getMiddlePoint:function(e,t,n){var r=n||new d.Vector3;return r.set(0,0,0),r.addScaledVector(e,.5),r.addScaledVector(t,.5),r},LAYERS:Fn};function qn(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var Xn={boundingBox:new d.Box3(new d.Vector3(-1,-1,-1),new d.Vector3(1,1,1)),boundingSphere:new d.Sphere(new d.Vector3(0,0,0),1)},$n=function(e){S()(n,e);var t=qn(n);function n(e,r){var i;return m()(this,n),(i=t.call(this,e,r)).name=e,i._dataSource=r,i}return y()(n,[{key:"release",value:function(){this.parent&&this.parent.remove(this)}},{key:"getDataSource",value:function(){return this._dataSource}},{key:"getBoundaries",value:function(){return Xn}}]),n}(Yn.RCGroup),Kn=n("RhWx"),Zn=n.n(Kn);function Qn(e){return null==e||Array.isArray(e)?e:[e]}var Jn=function(){function e(){var t=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:["id"];m()(this,e),this._list=[],this._dict={},this._indices=Zn()(r),this._indices.forEach((function(e){t._dict[e]={}})),n.forEach((function(e){return t.register(e)}))}return y()(e,[{key:"register",value:function(t){var n=this;e.registerInList(this._list,t),this._indices.forEach((function(r){e.registerInDict(n._dict[r],Qn(t[r]),t)}))}},{key:"unregister",value:function(t){var n=this;e.unregisterFromList(this._list,t),this._indices.forEach((function(r){e.unregisterFromDict(n._dict[r],Qn(t[r]),t)}))}},{key:"keys",value:function(e){return Object.keys(this._dict[e||this._indices[0]])}},{key:"get",value:function(e,t){var n=this._dict[t||this._indices[0]];if(n){var r=n[e&&e.toLowerCase()];return r&&r.length>0?r[0]:void 0}}},{key:"all",get:function(){return Zn()(this._list)}},{key:"first",get:function(){return this._list[0]}}],[{key:"registerInList",value:function(e,t){e.includes(t)||e.push(t)}},{key:"unregisterFromList",value:function(e,t){var n=e.indexOf(t);-1!==n&&e.splice(n,1)}},{key:"registerInDict",value:function(e,t,n){t.forEach((function(t){t=t.toLowerCase();var r=e[t]=e[t]||[];r.includes(n)||r.push(n)}))}},{key:"unregisterFromDict",value:function(e,t,n){t.forEach((function(t){t=t.toLowerCase();var r=e[t];if(r){var i=r.indexOf(n);-1!==i&&r.splice(i,1),0===r.length&&delete e[t]}}))}}]),e}();var er=function(e){Object.defineProperties(e,{logger:{get:function(){return this.context&&this.context.logger?this.context.logger:O}},settings:{get:function(){return this.context&&this.context.settings?this.context.settings:re}}})};function tr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var nr=function(){function e(t,n){m()(this,e),this._position=t,this._radius=n}return y()(e,[{key:"raycast",value:function(t){var n=e._sphere;n.set(this._position,this._radius);var r=new d.Vector3;return t.ray.intersectSphere(n,r)?{distance:t.ray.origin.distanceTo(r),point:r}:null}}]),e}();Re()(nr,"_sphere",new d.Sphere);var rr=function(e){return function(e){S()(n,e);var t=tr(n);function n(e){var r;m()(this,n);for(var i=arguments.length,o=new Array(i>1?i-1:0),a=1;a<i;a++)o[a-1]=arguments[a];return(r=t.call.apply(t,[this].concat(o)))._objects=new Array(e),r.boundingSphere=null,r.boundingBox=null,r}return y()(n,[{key:"setSphere",value:function(e,t,n){this._objects[e]=new nr(t,n)}},{key:"raycast",value:function(e,t){for(var n=0,r=this._objects.length;n<r;++n){var i=this._objects[n].raycast(e);i&&(i.chunkIdx=n,t.push(i))}}},{key:"computeBoundingBox",value:function(){var e=this._objects,t=this.boundingBox;null===t&&(this.boundingBox=t=new d.Box3),t.makeEmpty();for(var n=0,r=e.length;n<r;++n)t.expandByPoint(e[n]._position)}},{key:"computeBoundingSphere",value:function(){this.computeBoundingBox();var e=this._objects,t=this.boundingBox,n=0,r=new d.Vector3;t.getCenter(r);for(var i=0,o=e.length;i<o;++i){var a=e[i]._position,s=r.distanceToSquared(a);n<s&&(n=s)}null===this.boundingSphere&&(this.boundingSphere=new d.Sphere),this.boundingSphere.set(r,Math.sqrt(n))}}]),n}(e)};function ir(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var or=new d.Color,ar=K.copySubArrays;var sr=function(e){S()(n,e);var t=ir(n);function n(e,r,i){var o;return m()(this,n),(o=t.call(this,e))._sphGeometry=i?new d.PlaneBufferGeometry(2,2,1,1):new d.SphereBufferGeometry(1,2*r,r,0,2*Math.PI,0,Math.PI),o._init(e,o._sphGeometry),o}return y()(n,[{key:"setItem",value:function(e,t,n){var r,i,o,a,s,l;r=this._offsets,i=4*e,o=t.x,a=t.y,s=t.z,l=n,r[i]=o,r[i+1]=a,r[i+2]=s,r[i+3]=l,this.setSphere(e,t,n)}},{key:"setColor",value:function(e,t){var n,r,i,o,a;or.set(t),n=this._colors,r=3*e,i=or.r,o=or.g,a=or.b,n[r]=i,n[r+1]=o,n[r+2]=a}},{key:"startUpdate",value:function(){return!0}},{key:"finishUpdate",value:function(){this.getAttribute("offset").needsUpdate=!0,this.getAttribute("color").needsUpdate=!0}},{key:"finalize",value:function(){this.finishUpdate(),this.computeBoundingSphere()}},{key:"setOpacity",value:function(e,t){for(var n=this._alpha,r=0,i=e.length;r<i;++r)n[e[r]]=t;this.getAttribute("alphaColor").needsUpdate=!0}},{key:"getSubset",value:function(e){var t=e.length,n=new d.InstancedBufferGeometry;return this._init.call(n,t,this._sphGeometry),ar(this._offsets,n._offsets,e,4),ar(this._colors,n._colors,e,3),n.boundingSphere=this.boundingSphere,n.boundingBox=this.boundingBox,[n]}},{key:"_init",value:function(e,t){this.copy(t),this._offsets=K.allocateTyped(Float32Array,4*e),this._colors=K.allocateTyped(Float32Array,3*e);var n=this._alpha=K.allocateTyped(Float32Array,e);h.a.fill(n,1),this.setAttribute("offset",new d.InstancedBufferAttribute(this._offsets,4,!1,1)),this.setAttribute("color",new d.InstancedBufferAttribute(this._colors,3,!1,1)),this.setAttribute("alphaColor",new d.InstancedBufferAttribute(n,1,!1,1))}}]),n}(rr(d.InstancedBufferGeometry));function lr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var cr=function(e){S()(n,e);var t=lr(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"uvIntersection",value:function(e,t,r,i,o,a,s){var l=n._barycoord;return d.Triangle.barycoordFromPoint(e,t,r,i,l),o.multiplyScalar(l.x),a.multiplyScalar(l.y),s.multiplyScalar(l.z),o.add(a).add(s),o.clone()}},{key:"checkIntersection",value:function(e,t,n,r,i,o,a){return null===n.intersectTriangle(r,i,o,!1,a)?null:{point:a.clone()}}},{key:"checkBufferGeometryIntersection",value:function(e,t,r,i,o,a,s,l){var c=n._vA,u=n._vB,h=n._vC,f=n._intersectionPoint;c.fromBufferAttribute(i,a),u.fromBufferAttribute(i,s),h.fromBufferAttribute(i,l);var p=this.checkIntersection(e,t,r,c,u,h,f);if(p){if(o){var m=n._uvA,v=n._uvB,y=n._uvC;m.fromBufferAttribute(o,a),v.fromBufferAttribute(o,s),y.fromBufferAttribute(o,l),p.uv=this.uvIntersection(f,c,u,h,m,v,y)}var _=new d.Vector3;d.Triangle.getNormal(c,u,h,_),p.face=new d.Face3(a,s,l,_),p.faceIndex=a}return p}},{key:"raycast",value:function(e,t){var n=e.ray;if(null===this.boundingSphere&&this.computeBoundingSphere(),!1!==e.ray.intersectsSphere(this.boundingSphere)&&(null===this.boundingBox||!1!==n.intersectsBox(this.boundingBox))){var r,i,o,a=this.index,s=this.attributes,l=s.position,c=s.uv;if(null!==a)for(var u=0,h=a.count;u<h;u+=3){r=a.getX(u),i=a.getX(u+1),o=a.getX(u+2);var d=this.checkBufferGeometryIntersection(this,e,n,l,c,r,i,o);d&&(d.faceIndex=Math.floor(u/3),t.push(d))}}}}]),n}(d.BufferGeometry);Re()(cr,"_vA",new d.Vector3),Re()(cr,"_vB",new d.Vector3),Re()(cr,"_vC",new d.Vector3),Re()(cr,"_uvA",new d.Vector2),Re()(cr,"_uvB",new d.Vector2),Re()(cr,"_uvC",new d.Vector2),Re()(cr,"_barycoord",new d.Vector3),Re()(cr,"_intersectionPoint",new d.Vector3);var ur=cr;function hr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var dr=new d.Color,fr=function(e){S()(n,e);var t=hr(n);function n(e,r){var i;if(m()(this,n),(i=t.call(this)).constructor===n)throw new Error("Can not instantiate abstract class!");return i._chunkGeo=e,i._init(e,r),i}return y()(n,[{key:"startUpdate",value:function(){return!0}},{key:"finishUpdate",value:function(){this.getAttribute("position").needsUpdate=!0,this.getAttribute("normal").needsUpdate=!0,this.getAttribute("color").needsUpdate=!0}},{key:"setColor",value:function(e,t){dr.set(t);for(var n=this._colors,r=this._chunkSize,i=e*r,o=i+r;i<o;++i){var a=3*i;n[a]=dr.r,n[a+1]=dr.g,n[a+2]=dr.b}}},{key:"finalize",value:function(){this.finishUpdate(),this.computeBoundingSphere()}},{key:"setOpacity",value:function(e,t){for(var n=this._alpha,r=this._chunkSize,i=0,o=e.length;i<o;++i){var a=e[i]*r;h.a.fill(n,t,a,a+r)}this.getAttribute("alphaColor").needsUpdate=!0}},{key:"raycast",value:function(e,t){var r=[];it()(E()(n.prototype),"raycast",this).call(this,e,r);for(var i=this._chunkGeo.index.count/3,o=0,a=r.length;o<a;++o)r[o].hasOwnProperty("faceIndex")&&(r[o].chunkIdx=Math.floor(r[o].faceIndex/i),t.push(r[o]))}},{key:"getSubset",value:function(e){var t=e.length,n=new d.BufferGeometry;this._init.call(n,this._chunkGeo,t);for(var r=this._positions,i=this._normals,o=this._colors,a=n._positions,s=n._normals,l=n._colors,c=3*this._chunkSize,u=0,h=e.length;u<h;++u){var f=u*c,p=e[u]*c,m=p+c;a.set(r.subarray(p,m),f),s.set(i.subarray(p,m),f),l.set(o.subarray(p,m),f)}return n.boundingSphere=this.boundingSphere,n.boundingBox=this.boundingBox,[n]}},{key:"_init",value:function(e,t){var n=this._chunkSize=e.attributes.position.count,r=e.index.array,i=r.length,o=this._chunkSize*t,a=o>65535,s=i*t,l=this._index=K.allocateTyped(a?Uint32Array:Uint16Array,s);this._positions=K.allocateTyped(Float32Array,3*o),this._normals=K.allocateTyped(Float32Array,3*o),this._colors=K.allocateTyped(Float32Array,3*o);var c=this._alpha=K.allocateTyped(Float32Array,o);h.a.fill(c,1);for(var u=0;u<t;++u){var f=u*i,p=u*n;l.set(r,f);for(var m=0;m<i;++m)l[f+m]+=p}this.setIndex(new d.BufferAttribute(this._index,1)),this.setAttribute("position",new d.BufferAttribute(this._positions,3)),this.setAttribute("normal",new d.BufferAttribute(this._normals,3)),this.setAttribute("color",new d.BufferAttribute(this._colors,3)),this.setAttribute("alphaColor",new d.BufferAttribute(c,1))}}]),n}(ur);function pr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var mr=function(e){S()(n,e);var t=pr(n);function n(e,r){var i;m()(this,n);var o=new d.SphereBufferGeometry(1,2*r,r,0,2*Math.PI,0,Math.PI),a=(i=t.call(this,e,o,e))._normals,s=o.attributes.normal.array,l=i._chunkSize;i._chunkPos=i._chunkGeo.attributes.position.array,i._tmpPositions=K.allocateTyped(Float32Array,3*l);for(var c=0;c<e;++c)a.set(s,3*l*c);return i}return y()(n,[{key:"setItem",value:function(e,t,n){for(var r=this._tmpPositions,i=this._chunkSize,o=this._chunkPos,a=0;a<i;++a){var s=3*a;r[s]=t.x+o[s]*n,r[s+1]=t.y+o[s+1]*n,r[s+2]=t.z+o[s+2]*n}this._positions.set(r,i*e*3),this.setSphere(e,t,n)}}]),n}(rr(fr));function vr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var yr=new d.Vector3,_r=new d.Vector3,gr=new d.Matrix3,xr=function(e){S()(n,e);var t=vr(n);function n(e,r){var i;m()(this,n);var o=new d.CylinderBufferGeometry(1,1,1,Math.max(3,r),2,!0),a=(i=t.call(this,o,2*e))._chunkSize;return i._chunkPos=i._chunkGeo.attributes.position.array,i._chunkNorms=i._chunkGeo.attributes.normal.array,i._tmpVector=K.allocateTyped(Float32Array,3*a),i}return y()(n,[{key:"setItem",value:function(e,t,n,r){var i=this._chunkSize,o=2*i*e*3,a=o+3*i,s=this._tmpVector,l=this._chunkPos,c=this._chunkNorms;yr.lerpVectors(t,n,.5);var u,h=Yn.calcCylinderMatrix(t,yr,r);gr.getNormalMatrix(h);for(var d=0;d<i;++d)u=3*d,_r.fromArray(l,u),_r.applyMatrix4(h),_r.toArray(s,u);this._positions.set(s,o),yr.sub(t);for(var f=0;f<i;++f)s[u=3*f]+=yr.x,s[u+1]+=yr.y,s[u+2]+=yr.z;this._positions.set(s,a);for(var p=0;p<i;++p)u=3*p,_r.fromArray(c,u),_r.applyMatrix3(gr),_r.toArray(s,u);this._normals.set(s,o),this._normals.set(s,a)}},{key:"setColor",value:function(e,t,r){var i=2*e;it()(E()(n.prototype),"setColor",this).call(this,i,t);var o=i+1;it()(E()(n.prototype),"setColor",this).call(this,o,r)}}]),n}(fr);function br(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var wr=function(e){S()(n,e);var t=br(n);function n(e,r,i,o,a,s){var l;m()(this,n),l=t.call(this);var c=2*Math.PI;l.type="CylinderBufferGeometry",l.parameters={radiusTop:e,radiusBottom:r,height:i,radialSegments:o,heightSegments:a,openEnded:s};var u=!1===s&&e>0,h=!1===s&&r>0,f=(a+1)*o+u*(o+1)+h*(o+1),p=(2*a+u+h)*o,v=i/2,y=new d.BufferAttribute(K.allocateTyped(Float32Array,3*f),3),_=new d.BufferAttribute(K.allocateTyped(Float32Array,3*f),3),g=new d.Uint16BufferAttribute(K.allocateTyped(Uint16Array,3*p),1),x=new d.BufferAttribute(K.allocateTyped(Float32Array,2*f),2);console.assert(f<65536,"DEBUG: Cylinder Geometry has too many vertices (65536 max).");for(var b=0,w=0,S=-(r-e)/i,C=0;C<=a;C++){if(C!==a)for(var R=0;R<o;R++){var A=b+R,E=b+o+R,k=b+o+(R+1)%o,T=b+(R+1)%o;g.setXYZ(3*w,A,T,E),w++,g.setXYZ(3*w,E,T,k),w++}for(var P=C/a,M=P*(r-e)+e,I=0;I<o;I++){var N=I/o,L=M*Math.sin(N*c+0),D=P*i-v,O=M*Math.cos(N*c+0),V=new d.Vector3(L,Math.sqrt(L*L+O*O)*S,O).normalize();y.setXYZ(b,L,D,O),_.setXYZ(b,V.x,V.y,V.z),x.setXY(b,N,P),++b}}if(u){for(var z=b,F=b+o,B=0;B<o;++B){var U=b-o;y.setXYZ(b,y.getX(U),y.getY(U),y.getZ(U)),_.setXYZ(b,0,1,0),x.setXY(b,1,1);var G=z+(B+1)%o;g.setXYZ(3*w,b,G,F),w++,b++}y.setXYZ(b,0,v,0),_.setXYZ(b,0,1,0),x.setXY(b,1,1),++b}if(h){for(var j=b,H=b+o,W=0;W<o;++W){var Y=W;y.setXYZ(b,y.getX(Y),y.getY(Y),y.getZ(Y)),_.setXYZ(b,0,-1,0),x.setXY(b,0,0);var q=j+(W+1)%o;g.setXYZ(3*w,q,b,H),w++,b++}y.setXYZ(b,0,-v,0),_.setXYZ(b,0,-1,0),x.setXY(b,0,0)}return l.setIndex(g),l.setAttribute("position",y),l.setAttribute("normal",_),l.setAttribute("uv",x),l}return y()(n,[{key:"clone",value:function(){var e=this.parameters;return new n(e.radiusTop,e.radiusBottom,e.height,e.radialSegments,e.heightSegments,e.openEnded)}}]),n}(d.BufferGeometry);function Sr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var Cr=new d.Color,Rr=new d.Matrix4,Ar=K.copySubArrays;function Er(e,t,n,r,i){e[t]=n,e[t+1]=r,e[t+2]=i}function kr(e,t,n,r,i,o){e[t]=n,e[t+1]=r,e[t+2]=i,e[t+3]=o}function Tr(e,t){return e-t}var Pr=function(e){S()(n,e);var t=Sr(n);function n(e,r,i,o){var a;return m()(this,n),(a=t.call(this))._useZSprites=i,a._cylGeometry=i?new d.PlaneBufferGeometry(2,2,1,1):new wr(1,1,1,Math.max(3,r),2,o),a._init(e,a._cylGeometry,a._useZSprites),a._collisionGeo=new xr(e,3),a}return y()(n,[{key:"setItem",value:function(e,t,n,r){var i=Yn.calcCylinderMatrix(t,n,r),o=i.elements,a=4*e;this._collisionGeo.setItem(e,t,n,r),kr(this._matVector1,a,o[0],o[4],o[8],o[12]),kr(this._matVector2,a,o[1],o[5],o[9],o[13]),kr(this._matVector3,a,o[2],o[6],o[10],o[14]),this._useZSprites&&(Rr.copy(i).invert(),o=Rr.elements,kr(this._invmatVector1,a,o[0],o[4],o[8],o[12]),kr(this._invmatVector2,a,o[1],o[5],o[9],o[13]),kr(this._invmatVector3,a,o[2],o[6],o[10],o[14]))}},{key:"setColor",value:function(e,t,n){var r=3*e;Cr.set(t),Er(this._color1,r,Cr.r,Cr.g,Cr.b),Cr.set(n),Er(this._color2,r,Cr.r,Cr.g,Cr.b)}},{key:"computeBoundingSphere",value:function(){this._collisionGeo.computeBoundingSphere(),this.boundingSphere=this._collisionGeo.boundingSphere}},{key:"computeBoundingBox",value:function(){this._collisionGeo.computeBoundingBox(),this.boundingBox=this._collisionGeo.boundingBox}},{key:"raycast",value:function(e,t){this._collisionGeo.raycast(e,t)}},{key:"startUpdate",value:function(){return!0}},{key:"finishUpdate",value:function(){this.getAttribute("matVector1").needsUpdate=!0,this.getAttribute("matVector2").needsUpdate=!0,this.getAttribute("matVector3").needsUpdate=!0,this.getAttribute("color").needsUpdate=!0,this.getAttribute("color2").needsUpdate=!0,this.getAttribute("alphaColor").needsUpdate=!0,this._useZSprites&&(this.getAttribute("invmatVector1").needsUpdate=!0,this.getAttribute("invmatVector2").needsUpdate=!0,this.getAttribute("invmatVector3").needsUpdate=!0),this._collisionGeo.finishUpdate()}},{key:"finalize",value:function(){this.finishUpdate(),this.computeBoundingSphere()}},{key:"setOpacity",value:function(e,t){for(var n=this._alpha,r=0,i=e.length;r<i;++r)n[Math.floor(e[r]/2)]=t;this.getAttribute("alphaColor").needsUpdate=!0}},{key:"getSubset",value:function(e){var t=function(e){e.sort(Tr);for(var t=[],n=[],r=0,i=e.length;r<i;++r){var o=e[r],a={first:!1,second:!1};(0|o)%2==0?(a.first=!0,a.second=r+1<i&&e[r+1]===e[r]+1,a.second&&++r):a.second=!0,t.push(Math.floor(o/2)),n.push(a)}return{indices:t,cylinderInfo:n}}(e),n=t.indices,r=n.length,i=new d.InstancedBufferGeometry;return this._init.call(i,r,this._cylGeometry,this._useZSprites),Ar(this._matVector1,i._matVector1,n,4),Ar(this._matVector2,i._matVector2,n,4),Ar(this._matVector3,i._matVector3,n,4),this._useZSprites&&(Ar(this._invmatVector1,i._invmatVector1,n,4),Ar(this._invmatVector2,i._invmatVector2,n,4),Ar(this._invmatVector3,i._invmatVector3,n,4)),Ar(this._color1,i._color1,n,3),Ar(this._color2,i._color2,n,3),function(e,t,n){for(var r=0,i=e.length;r<i;++r){var o=e[r];o.first||(t[3*r]=-.5),o.second||(n[3*r]=-.5)}}(t.cylinderInfo,i._color1,i._color2),i.boundingSphere=this.boundingSphere,i.boundingBox=this.boundingBox,[i]}},{key:"getGeoParams",value:function(){return this._cylGeometry.parameters}},{key:"_init",value:function(e,t,n){this.copy(t),this._matVector1=K.allocateTyped(Float32Array,4*e),this._matVector2=K.allocateTyped(Float32Array,4*e),this._matVector3=K.allocateTyped(Float32Array,4*e),this._color1=K.allocateTyped(Float32Array,3*e),this._color2=K.allocateTyped(Float32Array,3*e);var r=this._alpha=K.allocateTyped(Float32Array,e);h.a.fill(r,1),this.setAttribute("matVector1",new d.InstancedBufferAttribute(this._matVector1,4,!1,1)),this.setAttribute("matVector2",new d.InstancedBufferAttribute(this._matVector2,4,!1,1)),this.setAttribute("matVector3",new d.InstancedBufferAttribute(this._matVector3,4,!1,1)),this.setAttribute("color",new d.InstancedBufferAttribute(this._color1,3,!1,1)),this.setAttribute("color2",new d.InstancedBufferAttribute(this._color2,3,!1,1)),this.setAttribute("alphaColor",new d.InstancedBufferAttribute(this._alpha,1,!1,1)),n&&(this._invmatVector1=K.allocateTyped(Float32Array,4*e),this._invmatVector2=K.allocateTyped(Float32Array,4*e),this._invmatVector3=K.allocateTyped(Float32Array,4*e),this.setAttribute("invmatVector1",new d.InstancedBufferAttribute(this._invmatVector1,4,!1,1)),this.setAttribute("invmatVector2",new d.InstancedBufferAttribute(this._invmatVector2,4,!1,1)),this.setAttribute("invmatVector3",new d.InstancedBufferAttribute(this._invmatVector3,4,!1,1)))}}]),n}(d.InstancedBufferGeometry);function Mr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var Ir=new d.Vector3,Nr=new d.Vector3,Lr=new d.Vector3,Dr=new d.Vector3(1,0,0),Or=new d.Vector3,Vr=new d.Vector3;var zr=function(e){S()(n,e);var t=Mr(n);function n(e,r,i){var o;m()(this,n);var a=function(e,t){for(var n=new d.BufferGeometry,r=e.length,i=r*t,o=i<=65536?Uint16Array:Uint32Array,a=(t-1)*r*2,s=new d.BufferAttribute(K.allocateTyped(o,3*a),1),l=0,c=0,u=0;u<t;u++){if(u!==t-1)for(var h=0;h<r;h++){var f=l+h,p=l+r+h,m=l+r+(h+1)%r,v=l+(h+1)%r;s.setXYZ(3*c,f,v,p),c++,s.setXYZ(3*c,p,v,m),c++}l+=r}n.setIndex(s);var y=K.allocateTyped(Float32Array,3*i);return n.setAttribute("position",new d.BufferAttribute(y,3)),n._positions=e,n}(e,r);(o=t.call(this,a,i))._ringsCount=r;for(var s=o._tmpShape=[],l=0;l<e.length;++l)s[l]=new d.Vector3;return o}return y()(n,[{key:"setItem",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],i=this._chunkGeo._positions.length,o=this._ringsCount,a=i*this._ringsCount*e*3;this._setPoints(t,i,o,a),n?this._setSlopeNormals(i,o,a):this._setBaseNormals(i,o,a),r&&this._addCut(i,o,a)}},{key:"_setPoints",value:function(e,t,n,r){for(var i=this._tmpShape,o=this._positions,a=this._chunkGeo._positions,s=0,l=r;s<n;++s)for(var c=e[s],u=0;u<t;++u,l+=3)i[u].copy(a[u]).applyMatrix4(c).toArray(o,l)}},{key:"_setBaseNormals",value:function(e,t,n){for(var r=3*e,i=0,o=n;i<t;++i,o+=r)this._countNormalsInRing(e,o,!1)}},{key:"_setSlopeNormals",value:function(e,t,n){for(var r=this._normals,i=3*e,o=n,a=0;a<e;++a,o+=3)Dr.toArray(r,o);if(o-2*i>0)for(var s=0;s<e;++s,o+=3)Lr.fromArray(r,o-2*i).toArray(r,o);else this._countNormalsInRing(e,o,!0,+i),o+=i;for(var l=2;l<t;++l,o+=i)this._countNormalsInRing(e,o,!0,-i)}},{key:"_countNormalsInRing",value:function(e,t,n,r){var i=this._tmpShape,o=this._normals;i[0].fromArray(this._positions,t),i[e-1].fromArray(this._positions,t+3*(e-1));for(var a=0;a<e;++a,t+=3)a<e-1&&i[a+1].fromArray(this._positions,t+3),n?(Vr.fromArray(this._positions,t+r),Ir.subVectors(i[(a+e-1)%e],i[(a+1)%e]).normalize(),Nr.subVectors(i[a],Vr).normalize(),Lr.crossVectors(Nr,Ir).normalize().toArray(o,t)):(Ir.subVectors(i[a],i[(a+e-1)%e]).normalize(),Nr.subVectors(i[a],i[(a+1)%e]).normalize(),Lr.addVectors(Ir,Nr).normalize().toArray(o,t))}},{key:"_addCut",value:function(e,t,n){if(!(e<3||t<2)){var r=this._positions,i=this._normals,o=this._tmpShape,a=3*e;o[0].fromArray(r,n),o[1].fromArray(r,n+3),o[2].fromArray(r,n+6),Ir.subVectors(o[1],o[0]).normalize(),Nr.subVectors(o[1],o[2]).normalize(),Or.crossVectors(Ir,Nr).normalize();for(var s=n,l=0;l<2*e;++l,s+=3)Or.toArray(i,s);if(t>2)for(var c=0;c<e;++c,s+=3)Lr.fromArray(r,s-a).toArray(r,s)}}}]),n}(fr);function Fr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var Br=new d.Color,Ur=new d.Vector3;function Gr(e,t,n,r,i){e[t]=n,e[t+1]=r,e[t+2]=i}function jr(e,t,n,r,i,o){e[t]=n,e[t+1]=r,e[t+2]=i,e[t+3]=o}function Hr(e,t,n,r){var i=4*t,o=i+4*n;return e.subarray(i*r,o*r)}var Wr=function(e){S()(n,e);var t=Fr(n);function n(e){var r;return m()(this,n),(r=t.call(this))._initVertices(e),r}return y()(n,[{key:"startUpdate",value:function(){return!0}},{key:"finishUpdate",value:function(){this.getAttribute("position").needsUpdate=!0,this.getAttribute("color").needsUpdate=!0,this.getAttribute("alphaColor").needsUpdate=!0,this.getAttribute("direction").needsUpdate=!0}},{key:"setColor",value:function(e,t){Br.set(t);var n=4*e*3;Gr(this._colors,n,Br.r,Br.g,Br.b),n+=3,Gr(this._colors,n,Br.r,Br.g,Br.b),n+=3,Gr(this._colors,n,Br.r,Br.g,Br.b),n+=3,Gr(this._colors,n,Br.r,Br.g,Br.b)}},{key:"setSegment",value:function(e,t,n){Ur.subVectors(t,n),Ur.normalize();var r=this._positions,i=this._directions,o=4*e*4,a=4*e*3;jr(r,o,t.x,t.y,t.z,.5),Gr(i,a,Ur.x,Ur.y,Ur.z),a+=3,jr(r,o+=4,t.x,t.y,t.z,-.5),Gr(i,a,Ur.x,Ur.y,Ur.z),a+=3,jr(r,o+=4,n.x,n.y,n.z,.5),Gr(i,a,Ur.x,Ur.y,Ur.z),a+=3,jr(r,o+=4,n.x,n.y,n.z,-.5),Gr(i,a,Ur.x,Ur.y,Ur.z)}},{key:"setOpacity",value:function(e,t,n){var r=4*e,i=4*t;h.a.fill(this.alpha,n,i,r),this.getAttribute("alphaColor").needsUpdate=!0}},{key:"getSubsetSegments",value:function(e,t){return[Hr(this._positions,e,t,4),Hr(this._directions,e,t,3)]}},{key:"getSubsetColors",value:function(e,t){return Hr(this._colors,e,t,3)}},{key:"getSubsetOpacities",value:function(e,t){return Hr(this._alpha,e,t,1)}},{key:"getNumVertexPerSegment",value:function(){return 4}},{key:"getPositionSize",value:function(){return 4}},{key:"setSegments",value:function(e,t){var n=4*e*4;if(t instanceof Array&&2===t.length){this._positions.set(t[0],n);var r=4*e*3;this._directions.set(t[1],r)}else this._positions.set(t,n)}},{key:"setColors",value:function(e,t){var n=4*e*3;this._colors.set(t,n)}},{key:"_initVertices",value:function(e){this._buffersSize=4*e;var t=this._buffersSize,n=t>65535;this._index=K.allocateTyped(n?Uint32Array:Uint16Array,6*e),this._positions=K.allocateTyped(Float32Array,4*t),this._colors=K.allocateTyped(Float32Array,3*t),this._directions=K.allocateTyped(Float32Array,3*t);var r=this._alpha=K.allocateTyped(Float32Array,t);h.a.fill(r,1);for(var i=this._index,o=0,a=0,s=0;s<e;s++,o+=6,a+=4)i[o]=a,i[o+1]=a+1,i[o+2]=a+3,i[o+3]=a,i[o+4]=a+2,i[o+5]=a+3;this.setIndex(new d.BufferAttribute(this._index,1)),this.setAttribute("position",new d.BufferAttribute(this._positions,4)),this.setAttribute("color",new d.BufferAttribute(this._colors,3)),this.setAttribute("alphaColor",new d.BufferAttribute(r,1)),this.setAttribute("direction",new d.BufferAttribute(this._directions,3))}}]),n}(d.BufferGeometry);function Yr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var qr=function(e){S()(n,e);var t=Yr(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"startUpdate",value:function(){return!0}},{key:"computeBoundingSphere",value:function(){var e=this.boundingBox,t=0,n=new d.Vector3;e&&e.getCenter(n);for(var r=this._positions,i=this.boundingSphere||new d.Sphere,o=this._positions.length,a=new d.Vector3,s=this.getPositionSize(),l=0;l<o;l+=s){a.set(r[l],r[l+1],r[l+2]);var c=n.distanceToSquared(a);t<c&&(t=c)}i.set(n,Math.sqrt(t)),this.boundingSphere=i}},{key:"computeBoundingBox",value:function(){for(var e=this._positions,t=new d.Box3,n=this._positions.length,r=new d.Vector3,i=this.getPositionSize(),o=0;o<n;o+=i)r.set(e[o],e[o+1],e[o+2]),t.expandByPoint(r);this.boundingBox=t}},{key:"finalize",value:function(){this.finishUpdate(),this.computeBoundingSphere()}}]),n}(Wr);function Xr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var $r=new d.Vector3,Kr=new d.Matrix3,Zr=function(e){S()(n,e);var t=Xr(n);function n(e,r){var i;m()(this,n);var o=new d.CylinderBufferGeometry(1,1,1,Math.max(3,r),2,!0),a=(i=t.call(this,o,e))._chunkSize;return i._chunkPos=i._chunkGeo.attributes.position.array,i._chunkNorms=i._chunkGeo.attributes.normal.array,i._tmpVector=K.allocateTyped(Float32Array,3*a),i}return y()(n,[{key:"setItem",value:function(e,t,n,r){var i,o=this._chunkSize,a=o*e*3,s=this._tmpVector,l=this._chunkPos,c=this._chunkNorms,u=Yn.calcCylinderMatrix(t,n,r);Kr.getNormalMatrix(u);for(var h=0;h<o;++h)i=3*h,$r.fromArray(l,i),$r.applyMatrix4(u),$r.toArray(s,i);this._positions.set(s,a);for(var d=0;d<o;++d)i=3*d,$r.fromArray(c,i),$r.applyMatrix3(Kr),$r.toArray(s,i);this._normals.set(s,a)}}]),n}(fr);function Qr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var Jr=function(e){S()(n,e);var t=Qr(n);function n(e,r,i){var o;return m()(this,n),(o=t.call(this,e*r))._init(r),o._collisionGeo=i?new Zr(e*r,3):null,o}return y()(n,[{key:"startUpdate",value:function(){return!0}},{key:"computeBoundingSphere",value:function(){var e=this._collisionGeo;if(e)return e.computeBoundingSphere(),void(this.boundingSphere=e.boundingSphere);it()(E()(n.prototype),"computeBoundingSphere",this).call(this)}},{key:"computeBoundingBox",value:function(){var e=this._collisionGeo;if(e)return e.computeBoundingBox(),void(this.boundingBox=e.boundingBox);it()(E()(n.prototype),"computeBoundingBox",this).call(this)}},{key:"raycast",value:function(e,t){if(this._collisionGeo){var n=this._chunkSize;this._collisionGeo.raycast(e,t);for(var r=0,i=t.length;r<i;++r){var o=t[r].chunkIdx;void 0!==o&&(o=o/n|0,t[r].chunkIdx=o)}}}},{key:"setColor",value:function(e,t){for(var r=this._chunkSize,i=e*r,o=i+r;i<o;++i)it()(E()(n.prototype),"setColor",this).call(this,i,t)}},{key:"setSegment",value:function(e,t,r,i){var o=this._chunkSize,a=e*o+t;it()(E()(n.prototype),"setSegment",this).call(this,a,r,i),this._collisionGeo&&this._collisionGeo.setItem(e*o+t,r,i,.1)}},{key:"finalize",value:function(){this.finishUpdate(),this.computeBoundingSphere()}},{key:"setOpacity",value:function(e,t){for(var r=this._chunkSize,i=0,o=e.length;i<o;++i){var a=e[i]*r;it()(E()(n.prototype),"setOpacity",this).call(this,a,a+r-1,t)}}},{key:"getSubset",value:function(e){for(var t=e.length,r=this._chunkSize,i=new n(t,r,!1),o=0,a=e.length;o<a;++o){var s=o*r,l=e[o]*r;i.setSegments(s,this.getSubsetSegments(l,r)),i.setColors(s,this.getSubsetColors(l,r))}return i.boundingSphere=this.boundingSphere,i.boundingBox=this.boundingBox,[i]}},{key:"_init",value:function(e){this._chunkSize=e}}]),n}(qr);function ei(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var ti=new d.Vector3,ni=function(e){S()(n,e);var t=ei(n);function n(e){var r;return m()(this,n),(r=t.call(this,2*e))._init(e),r._collisionGeo=new xr(e,3),r}return y()(n,[{key:"setItem",value:function(e,t,r){this._collisionGeo.setItem(e,t,r,.3);var i=2*e;ti.lerpVectors(t,r,.5),it()(E()(n.prototype),"setSegment",this).call(this,i,t,ti),it()(E()(n.prototype),"setSegment",this).call(this,i+1,ti,r)}},{key:"setColor",value:function(e,t,r){var i=2*e;it()(E()(n.prototype),"setColor",this).call(this,i,t),it()(E()(n.prototype),"setColor",this).call(this,i+1,r)}},{key:"raycast",value:function(e,t){this._collisionGeo&&this._collisionGeo.raycast(e,t)}},{key:"getSubset",value:function(e){for(var t=e.length,r=new n(t,!1),i=0,o=t;i<o;++i){var a=e[i];r.setSegments(i,this.getSubsetSegments(a,1)),r.setColors(i,this.getSubsetColors(a,1))}return r.boundingSphere=this.boundingSphere,r.boundingBox=this.boundingBox,[r]}},{key:"_init",value:function(e){this._segCounts=2*e}}]),n}(qr);function ri(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var ii=[new d.Vector3(1,0,0),new d.Vector3(-1,0,0),new d.Vector3(0,1,0),new d.Vector3(0,-1,0),new d.Vector3(0,0,1),new d.Vector3(0,0,-1)],oi=ii.length,ai=new d.Vector3,si=new d.Vector3,li=function(e){S()(n,e);var t=ri(n);function n(e){return m()(this,n),t.call(this,e,e,oi/2|0,!1)}return y()(n,[{key:"setItem",value:function(e,t,n){this.setSphere(e,t,n);for(var r=0;r<oi/2;++r){var i=2*r;ai.x=t.x+ii[i].x*n,ai.y=t.y+ii[i].y*n,ai.z=t.z+ii[i].z*n;var o=i+1;si.x=t.x+ii[o].x*n,si.y=t.y+ii[o].y*n,si.z=t.z+ii[o].z*n,this.setSegment(e,r,ai,si)}}}]),n}(rr(Jr));function ci(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var ui=new d.Color,hi=function(e){S()(n,e);var t=ci(n);function n(e,r){var i;return m()(this,n),(i=t.call(this))._opts=r,i.zClip=i._opts.zClip,i._posRad=K.allocateTyped(Float32Array,4*e),i._colors=K.allocateTyped(Float32Array,3*e),i}return y()(n,[{key:"setItem",value:function(e,t,n){var r=this._posRad,i=4*e;r[i++]=t.x,r[i++]=t.y,r[i++]=t.z,r[i]=n}},{key:"setColor",value:function(e,t){ui.set(t);var n=this._colors,r=3*e;n[r++]=ui.r,n[r++]=ui.g,n[r]=ui.b}},{key:"finalize",value:function(){this.finishUpdate(),this.computeBoundingSphere()}},{key:"finishUpdate",value:function(){this._build()}},{key:"setOpacity",value:function(){}},{key:"raycast",value:function(){}},{key:"getSubset",value:function(){return[]}}]),n}(ur),di=function(){function e(){m()(this,e),this.pointsValuesLinear=null,this.hasIntersection=null,this.bitsInside=null}return y()(e,[{key:"create",value:function(e){var t=e*e*e;if(t>117440512)throw new Error("Too large cube dimension: lead to memory huge uasge");return this.pointsValuesLinear=K.allocateTyped(Float32Array,32*t),this.hasIntersection=K.allocateTyped(Int32Array,t),this.bitsInside=K.allocateTyped(Int32Array,t),0}},{key:"destroy",value:function(){this.bitsInside=null,this.hasIntersection=null,this.pointsValuesLinear=null}}]),e}();di.prototype.striIndicesMarchCube=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,8,3,9,8,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,2,10,0,2,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,8,3,2,10,8,10,9,8,-1,-1,-1,-1,-1,-1,-1,3,11,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,11,2,8,11,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,9,0,2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,11,2,1,9,11,9,8,11,-1,-1,-1,-1,-1,-1,-1,3,10,1,11,10,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,10,1,0,8,10,8,11,10,-1,-1,-1,-1,-1,-1,-1,3,9,0,3,11,9,11,10,9,-1,-1,-1,-1,-1,-1,-1,9,8,10,10,8,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,7,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,3,0,7,3,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,8,4,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,1,9,4,7,1,7,3,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,8,4,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,4,7,3,0,4,1,2,10,-1,-1,-1,-1,-1,-1,-1,9,2,10,9,0,2,8,4,7,-1,-1,-1,-1,-1,-1,-1,2,10,9,2,9,7,2,7,3,7,9,4,-1,-1,-1,-1,8,4,7,3,11,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,4,7,11,2,4,2,0,4,-1,-1,-1,-1,-1,-1,-1,9,0,1,8,4,7,2,3,11,-1,-1,-1,-1,-1,-1,-1,4,7,11,9,4,11,9,11,2,9,2,1,-1,-1,-1,-1,3,10,1,3,11,10,7,8,4,-1,-1,-1,-1,-1,-1,-1,1,11,10,1,4,11,1,0,4,7,11,4,-1,-1,-1,-1,4,7,8,9,0,11,9,11,10,11,0,3,-1,-1,-1,-1,4,7,11,4,11,9,9,11,10,-1,-1,-1,-1,-1,-1,-1,9,5,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,5,4,0,8,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,5,4,1,5,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,5,4,8,3,5,3,1,5,-1,-1,-1,-1,-1,-1,-1,1,2,10,9,5,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,8,1,2,10,4,9,5,-1,-1,-1,-1,-1,-1,-1,5,2,10,5,4,2,4,0,2,-1,-1,-1,-1,-1,-1,-1,2,10,5,3,2,5,3,5,4,3,4,8,-1,-1,-1,-1,9,5,4,2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,11,2,0,8,11,4,9,5,-1,-1,-1,-1,-1,-1,-1,0,5,4,0,1,5,2,3,11,-1,-1,-1,-1,-1,-1,-1,2,1,5,2,5,8,2,8,11,4,8,5,-1,-1,-1,-1,10,3,11,10,1,3,9,5,4,-1,-1,-1,-1,-1,-1,-1,4,9,5,0,8,1,8,10,1,8,11,10,-1,-1,-1,-1,5,4,0,5,0,11,5,11,10,11,0,3,-1,-1,-1,-1,5,4,8,5,8,10,10,8,11,-1,-1,-1,-1,-1,-1,-1,9,7,8,5,7,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,3,0,9,5,3,5,7,3,-1,-1,-1,-1,-1,-1,-1,0,7,8,0,1,7,1,5,7,-1,-1,-1,-1,-1,-1,-1,1,5,3,3,5,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,7,8,9,5,7,10,1,2,-1,-1,-1,-1,-1,-1,-1,10,1,2,9,5,0,5,3,0,5,7,3,-1,-1,-1,-1,8,0,2,8,2,5,8,5,7,10,5,2,-1,-1,-1,-1,2,10,5,2,5,3,3,5,7,-1,-1,-1,-1,-1,-1,-1,7,9,5,7,8,9,3,11,2,-1,-1,-1,-1,-1,-1,-1,9,5,7,9,7,2,9,2,0,2,7,11,-1,-1,-1,-1,2,3,11,0,1,8,1,7,8,1,5,7,-1,-1,-1,-1,11,2,1,11,1,7,7,1,5,-1,-1,-1,-1,-1,-1,-1,9,5,8,8,5,7,10,1,3,10,3,11,-1,-1,-1,-1,5,7,0,5,0,9,7,11,0,1,0,10,11,10,0,-1,11,10,0,11,0,3,10,5,0,8,0,7,5,7,0,-1,11,10,5,7,11,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,6,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,5,10,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,0,1,5,10,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,8,3,1,9,8,5,10,6,-1,-1,-1,-1,-1,-1,-1,1,6,5,2,6,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,6,5,1,2,6,3,0,8,-1,-1,-1,-1,-1,-1,-1,9,6,5,9,0,6,0,2,6,-1,-1,-1,-1,-1,-1,-1,5,9,8,5,8,2,5,2,6,3,2,8,-1,-1,-1,-1,2,3,11,10,6,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,0,8,11,2,0,10,6,5,-1,-1,-1,-1,-1,-1,-1,0,1,9,2,3,11,5,10,6,-1,-1,-1,-1,-1,-1,-1,5,10,6,1,9,2,9,11,2,9,8,11,-1,-1,-1,-1,6,3,11,6,5,3,5,1,3,-1,-1,-1,-1,-1,-1,-1,0,8,11,0,11,5,0,5,1,5,11,6,-1,-1,-1,-1,3,11,6,0,3,6,0,6,5,0,5,9,-1,-1,-1,-1,6,5,9,6,9,11,11,9,8,-1,-1,-1,-1,-1,-1,-1,5,10,6,4,7,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,3,0,4,7,3,6,5,10,-1,-1,-1,-1,-1,-1,-1,1,9,0,5,10,6,8,4,7,-1,-1,-1,-1,-1,-1,-1,10,6,5,1,9,7,1,7,3,7,9,4,-1,-1,-1,-1,6,1,2,6,5,1,4,7,8,-1,-1,-1,-1,-1,-1,-1,1,2,5,5,2,6,3,0,4,3,4,7,-1,-1,-1,-1,8,4,7,9,0,5,0,6,5,0,2,6,-1,-1,-1,-1,7,3,9,7,9,4,3,2,9,5,9,6,2,6,9,-1,3,11,2,7,8,4,10,6,5,-1,-1,-1,-1,-1,-1,-1,5,10,6,4,7,2,4,2,0,2,7,11,-1,-1,-1,-1,0,1,9,4,7,8,2,3,11,5,10,6,-1,-1,-1,-1,9,2,1,9,11,2,9,4,11,7,11,4,5,10,6,-1,8,4,7,3,11,5,3,5,1,5,11,6,-1,-1,-1,-1,5,1,11,5,11,6,1,0,11,7,11,4,0,4,11,-1,0,5,9,0,6,5,0,3,6,11,6,3,8,4,7,-1,6,5,9,6,9,11,4,7,9,7,11,9,-1,-1,-1,-1,10,4,9,6,4,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,10,6,4,9,10,0,8,3,-1,-1,-1,-1,-1,-1,-1,10,0,1,10,6,0,6,4,0,-1,-1,-1,-1,-1,-1,-1,8,3,1,8,1,6,8,6,4,6,1,10,-1,-1,-1,-1,1,4,9,1,2,4,2,6,4,-1,-1,-1,-1,-1,-1,-1,3,0,8,1,2,9,2,4,9,2,6,4,-1,-1,-1,-1,0,2,4,4,2,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,3,2,8,2,4,4,2,6,-1,-1,-1,-1,-1,-1,-1,10,4,9,10,6,4,11,2,3,-1,-1,-1,-1,-1,-1,-1,0,8,2,2,8,11,4,9,10,4,10,6,-1,-1,-1,-1,3,11,2,0,1,6,0,6,4,6,1,10,-1,-1,-1,-1,6,4,1,6,1,10,4,8,1,2,1,11,8,11,1,-1,9,6,4,9,3,6,9,1,3,11,6,3,-1,-1,-1,-1,8,11,1,8,1,0,11,6,1,9,1,4,6,4,1,-1,3,11,6,3,6,0,0,6,4,-1,-1,-1,-1,-1,-1,-1,6,4,8,11,6,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,10,6,7,8,10,8,9,10,-1,-1,-1,-1,-1,-1,-1,0,7,3,0,10,7,0,9,10,6,7,10,-1,-1,-1,-1,10,6,7,1,10,7,1,7,8,1,8,0,-1,-1,-1,-1,10,6,7,10,7,1,1,7,3,-1,-1,-1,-1,-1,-1,-1,1,2,6,1,6,8,1,8,9,8,6,7,-1,-1,-1,-1,2,6,9,2,9,1,6,7,9,0,9,3,7,3,9,-1,7,8,0,7,0,6,6,0,2,-1,-1,-1,-1,-1,-1,-1,7,3,2,6,7,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,11,10,6,8,10,8,9,8,6,7,-1,-1,-1,-1,2,0,7,2,7,11,0,9,7,6,7,10,9,10,7,-1,1,8,0,1,7,8,1,10,7,6,7,10,2,3,11,-1,11,2,1,11,1,7,10,6,1,6,7,1,-1,-1,-1,-1,8,9,6,8,6,7,9,1,6,11,6,3,1,3,6,-1,0,9,1,11,6,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,8,0,7,0,6,3,11,0,11,6,0,-1,-1,-1,-1,7,11,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,6,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,8,11,7,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,11,7,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,1,9,8,3,1,11,7,6,-1,-1,-1,-1,-1,-1,-1,10,1,2,6,11,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,10,3,0,8,6,11,7,-1,-1,-1,-1,-1,-1,-1,2,9,0,2,10,9,6,11,7,-1,-1,-1,-1,-1,-1,-1,6,11,7,2,10,3,10,8,3,10,9,8,-1,-1,-1,-1,7,2,3,6,2,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,0,8,7,6,0,6,2,0,-1,-1,-1,-1,-1,-1,-1,2,7,6,2,3,7,0,1,9,-1,-1,-1,-1,-1,-1,-1,1,6,2,1,8,6,1,9,8,8,7,6,-1,-1,-1,-1,10,7,6,10,1,7,1,3,7,-1,-1,-1,-1,-1,-1,-1,10,7,6,1,7,10,1,8,7,1,0,8,-1,-1,-1,-1,0,3,7,0,7,10,0,10,9,6,10,7,-1,-1,-1,-1,7,6,10,7,10,8,8,10,9,-1,-1,-1,-1,-1,-1,-1,6,8,4,11,8,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,6,11,3,0,6,0,4,6,-1,-1,-1,-1,-1,-1,-1,8,6,11,8,4,6,9,0,1,-1,-1,-1,-1,-1,-1,-1,9,4,6,9,6,3,9,3,1,11,3,6,-1,-1,-1,-1,6,8,4,6,11,8,2,10,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,3,0,11,0,6,11,0,4,6,-1,-1,-1,-1,4,11,8,4,6,11,0,2,9,2,10,9,-1,-1,-1,-1,10,9,3,10,3,2,9,4,3,11,3,6,4,6,3,-1,8,2,3,8,4,2,4,6,2,-1,-1,-1,-1,-1,-1,-1,0,4,2,4,6,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,9,0,2,3,4,2,4,6,4,3,8,-1,-1,-1,-1,1,9,4,1,4,2,2,4,6,-1,-1,-1,-1,-1,-1,-1,8,1,3,8,6,1,8,4,6,6,10,1,-1,-1,-1,-1,10,1,0,10,0,6,6,0,4,-1,-1,-1,-1,-1,-1,-1,4,6,3,4,3,8,6,10,3,0,3,9,10,9,3,-1,10,9,4,6,10,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,9,5,7,6,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,4,9,5,11,7,6,-1,-1,-1,-1,-1,-1,-1,5,0,1,5,4,0,7,6,11,-1,-1,-1,-1,-1,-1,-1,11,7,6,8,3,4,3,5,4,3,1,5,-1,-1,-1,-1,9,5,4,10,1,2,7,6,11,-1,-1,-1,-1,-1,-1,-1,6,11,7,1,2,10,0,8,3,4,9,5,-1,-1,-1,-1,7,6,11,5,4,10,4,2,10,4,0,2,-1,-1,-1,-1,3,4,8,3,5,4,3,2,5,10,5,2,11,7,6,-1,7,2,3,7,6,2,5,4,9,-1,-1,-1,-1,-1,-1,-1,9,5,4,0,8,6,0,6,2,6,8,7,-1,-1,-1,-1,3,6,2,3,7,6,1,5,0,5,4,0,-1,-1,-1,-1,6,2,8,6,8,7,2,1,8,4,8,5,1,5,8,-1,9,5,4,10,1,6,1,7,6,1,3,7,-1,-1,-1,-1,1,6,10,1,7,6,1,0,7,8,7,0,9,5,4,-1,4,0,10,4,10,5,0,3,10,6,10,7,3,7,10,-1,7,6,10,7,10,8,5,4,10,4,8,10,-1,-1,-1,-1,6,9,5,6,11,9,11,8,9,-1,-1,-1,-1,-1,-1,-1,3,6,11,0,6,3,0,5,6,0,9,5,-1,-1,-1,-1,0,11,8,0,5,11,0,1,5,5,6,11,-1,-1,-1,-1,6,11,3,6,3,5,5,3,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,9,5,11,9,11,8,11,5,6,-1,-1,-1,-1,0,11,3,0,6,11,0,9,6,5,6,9,1,2,10,-1,11,8,5,11,5,6,8,0,5,10,5,2,0,2,5,-1,6,11,3,6,3,5,2,10,3,10,5,3,-1,-1,-1,-1,5,8,9,5,2,8,5,6,2,3,8,2,-1,-1,-1,-1,9,5,6,9,6,0,0,6,2,-1,-1,-1,-1,-1,-1,-1,1,5,8,1,8,0,5,6,8,3,8,2,6,2,8,-1,1,5,6,2,1,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,3,6,1,6,10,3,8,6,5,6,9,8,9,6,-1,10,1,0,10,0,6,9,5,0,5,6,0,-1,-1,-1,-1,0,3,8,5,6,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,5,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,5,10,7,5,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,5,10,11,7,5,8,3,0,-1,-1,-1,-1,-1,-1,-1,5,11,7,5,10,11,1,9,0,-1,-1,-1,-1,-1,-1,-1,10,7,5,10,11,7,9,8,1,8,3,1,-1,-1,-1,-1,11,1,2,11,7,1,7,5,1,-1,-1,-1,-1,-1,-1,-1,0,8,3,1,2,7,1,7,5,7,2,11,-1,-1,-1,-1,9,7,5,9,2,7,9,0,2,2,11,7,-1,-1,-1,-1,7,5,2,7,2,11,5,9,2,3,2,8,9,8,2,-1,2,5,10,2,3,5,3,7,5,-1,-1,-1,-1,-1,-1,-1,8,2,0,8,5,2,8,7,5,10,2,5,-1,-1,-1,-1,9,0,1,5,10,3,5,3,7,3,10,2,-1,-1,-1,-1,9,8,2,9,2,1,8,7,2,10,2,5,7,5,2,-1,1,3,5,3,7,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,7,0,7,1,1,7,5,-1,-1,-1,-1,-1,-1,-1,9,0,3,9,3,5,5,3,7,-1,-1,-1,-1,-1,-1,-1,9,8,7,5,9,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,5,8,4,5,10,8,10,11,8,-1,-1,-1,-1,-1,-1,-1,5,0,4,5,11,0,5,10,11,11,3,0,-1,-1,-1,-1,0,1,9,8,4,10,8,10,11,10,4,5,-1,-1,-1,-1,10,11,4,10,4,5,11,3,4,9,4,1,3,1,4,-1,2,5,1,2,8,5,2,11,8,4,5,8,-1,-1,-1,-1,0,4,11,0,11,3,4,5,11,2,11,1,5,1,11,-1,0,2,5,0,5,9,2,11,5,4,5,8,11,8,5,-1,9,4,5,2,11,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,5,10,3,5,2,3,4,5,3,8,4,-1,-1,-1,-1,5,10,2,5,2,4,4,2,0,-1,-1,-1,-1,-1,-1,-1,3,10,2,3,5,10,3,8,5,4,5,8,0,1,9,-1,5,10,2,5,2,4,1,9,2,9,4,2,-1,-1,-1,-1,8,4,5,8,5,3,3,5,1,-1,-1,-1,-1,-1,-1,-1,0,4,5,1,0,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,4,5,8,5,3,9,0,5,0,3,5,-1,-1,-1,-1,9,4,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,11,7,4,9,11,9,10,11,-1,-1,-1,-1,-1,-1,-1,0,8,3,4,9,7,9,11,7,9,10,11,-1,-1,-1,-1,1,10,11,1,11,4,1,4,0,7,4,11,-1,-1,-1,-1,3,1,4,3,4,8,1,10,4,7,4,11,10,11,4,-1,4,11,7,9,11,4,9,2,11,9,1,2,-1,-1,-1,-1,9,7,4,9,11,7,9,1,11,2,11,1,0,8,3,-1,11,7,4,11,4,2,2,4,0,-1,-1,-1,-1,-1,-1,-1,11,7,4,11,4,2,8,3,4,3,2,4,-1,-1,-1,-1,2,9,10,2,7,9,2,3,7,7,4,9,-1,-1,-1,-1,9,10,7,9,7,4,10,2,7,8,7,0,2,0,7,-1,3,7,10,3,10,2,7,4,10,1,10,0,4,0,10,-1,1,10,2,8,7,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,9,1,4,1,7,7,1,3,-1,-1,-1,-1,-1,-1,-1,4,9,1,4,1,7,0,8,1,8,7,1,-1,-1,-1,-1,4,0,3,7,4,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,8,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,10,8,10,11,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,9,3,9,11,11,9,10,-1,-1,-1,-1,-1,-1,-1,0,1,10,0,10,8,8,10,11,-1,-1,-1,-1,-1,-1,-1,3,1,10,11,3,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,11,1,11,9,9,11,8,-1,-1,-1,-1,-1,-1,-1,3,0,9,3,9,11,1,2,9,2,11,9,-1,-1,-1,-1,0,2,11,8,0,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,2,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,8,2,8,10,10,8,9,-1,-1,-1,-1,-1,-1,-1,9,10,2,0,9,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,8,2,8,10,0,1,8,1,10,8,-1,-1,-1,-1,1,10,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,3,8,9,1,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,9,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,3,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];var fi=di,pi=[0,265,515,778,1030,1295,1541,1804,2060,2309,2575,2822,3082,3331,3593,3840,400,153,915,666,1430,1183,1941,1692,2460,2197,2975,2710,3482,3219,3993,3728,560,825,51,314,1590,1855,1077,1340,2620,2869,2111,2358,3642,3891,3129,3376,928,681,419,170,1958,1711,1445,1196,2988,2725,2479,2214,4010,3747,3497,3232,1120,1385,1635,1898,102,367,613,876,3180,3429,3695,3942,2154,2403,2665,2912,1520,1273,2035,1786,502,255,1013,764,3580,3317,4095,3830,2554,2291,3065,2800,1616,1881,1107,1370,598,863,85,348,3676,3925,3167,3414,2650,2899,2137,2384,1984,1737,1475,1226,966,719,453,204,4044,3781,3535,3270,3018,2755,2505,2240,2240,2505,2755,3018,3270,3535,3781,4044,204,453,719,966,1226,1475,1737,1984,2384,2137,2899,2650,3414,3167,3925,3676,348,85,863,598,1370,1107,1881,1616,2800,3065,2291,2554,3830,4095,3317,3580,764,1013,255,502,1786,2035,1273,1520,2912,2665,2403,2154,3942,3695,3429,3180,876,613,367,102,1898,1635,1385,1120,3232,3497,3747,4010,2214,2479,2725,2988,1196,1445,1711,1958,170,419,681,928,3376,3129,3891,3642,2358,2111,2869,2620,1340,1077,1855,1590,314,51,825,560,3728,3993,3219,3482,2710,2975,2197,2460,1692,1941,1183,1430,666,915,153,400,3840,3593,3331,3082,2822,2575,2309,2060,1804,1541,1295,1030,778,515,265,0];var mi=function e(){m()(this,e),this._arrSize=8,this.p=new Array(this._arrSize),this.g=new Array(this._arrSize),this.val=new Array(this._arrSize);for(var t=0;t<this._arrSize;++t)this.p[t]=new d.Vector3,this.g[t]=new d.Vector3;this.cubeIndex=0},vi=function e(){m()(this,e),this.a={p:new d.Vector3,n:new d.Vector3},this.b={p:new d.Vector3,n:new d.Vector3},this.c={p:new d.Vector3,n:new d.Vector3}};function yi(e){for(var t=new Array(e),n=0;n<e;++n)t[n]=new d.Vector3;return t}var _i=function(){function e(){m()(this,e),this._numTriangles=0,this._numVertices=0,this._position=[],this._normals=[],this._colors=null,this._indices=[],this._volumetricData=null,this._xAxis=new d.Vector3,this._yAxis=new d.Vector3,this._zAxis=new d.Vector3,this._xDir=new d.Vector3,this._yDir=new d.Vector3,this._zDir=new d.Vector3}return y()(e,[{key:"_prepareAxesAndDirs",value:function(){var e=this._volumetricData.getCellSize(),t=this._xAxis,n=this._yAxis,r=this._zAxis,i=this._xDir,o=this._yDir,a=this._zDir;t.set(e.x,0,0),n.set(0,e.y,0),r.set(0,0,e.z),i.set(1,0,0),o.set(0,1,0),a.set(0,0,1);var s=new d.Vector3;if(s.crossVectors(i,o),s.dot(a)<0&&(i.negate(),o.negate(),a.negate()),i.x<0||i.y<0||i.z<0||o.x<0||o.y<0||o.z<0||a.x<0||a.y<0||a.z<0)return!1;var l=function(e){return Math.abs(e)>Number.EPSILON};return!(l(t.y)||l(t.z)||l(n.x)||l(n.z)||l(r.x)||l(r.y))}},{key:"_vertexInterp",value:function(e,t,n,r,i,o){var a=t.p[n],s=t.p[r],l=t.g[n],c=t.g[r],u=t.val[n],h=e-u,d=t.val[r]-u,f=0;Math.abs(d)>0&&(f=h/d),f=f>1?1:f,i.lerpVectors(a,s,f),o.lerpVectors(l,c,f)}},{key:"_polygonize",value:function(t,n,r){for(var i=t.cubeIndex,o=0,a=e._arrSize,s=e._firstIndices,l=e._secondIndices,c=e._vertexList,u=e._normalList;o<a;++o)pi[i]&1<<o&&this._vertexInterp(n,t,s[o],l[o],c[o],u[o]);var h=0,d=16*i,f=e._triTable;for(o=0;-1!==f[d+o];o+=3)r[h].a.p.copy(c[f[d+o]]),r[h].a.n.copy(u[f[d+o]]),r[h].b.p.copy(c[f[d+o+1]]),r[h].b.n.copy(u[f[d+o+1]]),r[h].c.p.copy(c[f[d+o+2]]),r[h].c.n.copy(u[f[d+o+2]]),++h;return h}},{key:"_doGridPosNorms",value:function(e,t,n){for(var r,i=this._volumetricData,o=this._volumetricData.getData(),a=i.getDimensions(),s=a[0],l=a[1],c=a[2],u=t*i.getStrideX(),h=t*i.getStrideY(),f=t*i.getStrideZ(),p=new mi,m=p.val,v=p.val.length,y=[new d.Vector3(0,0,0),new d.Vector3(t,0,0),new d.Vector3(t,t,0),new d.Vector3(0,t,0),new d.Vector3(0,0,t),new d.Vector3(t,0,t),new d.Vector3(t,t,t),new d.Vector3(0,t,t)],_=new Array(5),g=0;g<5;++g)_[g]=new vi;var x,b=this,w=this._position,S=this._normals;n?(x=new d.Vector3(b._xAxis.x,b._yAxis.y,b._zAxis.z),r=function(e){var t=e.p.clone();t.multiply(x),w.push(t.add(b._origin)),S.push(e.n.clone())}):r=function(){var e=new d.Matrix3;e.set(b._xAxis.x,b._yAxis.x,b._zAxis.x,b._xAxis.y,b._yAxis.y,b._zAxis.y,b._xAxis.z,b._yAxis.z,b._zAxis.z);var t=new d.Matrix3;return t.set(b._xDir.x,b._yDir.x,b._zDir.x,b._xDir.y,b._yDir.y,b._zDir.y,b._xDir.z,b._yDir.z,b._zDir.z),function(n){w.push(n.p.clone().applyMatrix3(e).add(b._origin)),S.push(n.n.clone().applyMatrix3(t))}}();for(var C,R,A,E,k=this._indices,T=0,P=0;P<c-t;P+=t)for(var M=0;M<l-t;M+=t)for(var I=i.getDirectIdx(0,M,P),N=0;N<s-t;N+=t,I+=u){m[0]=o[I],m[1]=o[I+u],m[3]=o[I+h],m[2]=o[I+u+h],m[4]=o[I+f],m[5]=o[I+u+f],m[7]=o[I+h+f],m[6]=o[I+u+h+f];for(var L=0,D=0;D<v;++D)m[D]<e&&(L|=1<<D);if(0!==pi[L]){for(p.cubeIndex=L,D=0;D<v;++D)p.p[D].set(N+y[D].x,M+y[D].y,P+y[D].z),C=this._gradient,R=p.p[D],A=p.g[D],E=void 0,E=C.getValue(R.x,R.y,R.z),A.set(E[0],E[1],E[2]);var O=this._polygonize(p,e,_);for(T+=O,D=0;D<O;++D)k.push(3*this._numTriangles),k.push(3*this._numTriangles+1),k.push(3*this._numTriangles+2),++this._numTriangles,r(_[D].a),r(_[D].b),r(_[D].c)}}return T}},{key:"compute",value:function(e,t,n,r){this._volumetricData=e,this._origin=t,this._gradient=e.computeGradient(),this._doGridPosNorms(n,r,this._prepareAxesAndDirs())}},{key:"_remapIndices",value:function(e,t){for(var n=this._indices,r=K.allocateTyped(Uint32Array,t),i=0;i<t;++i)n[i]=e[n[i]],r[i]=n[i];this._indices=r}},{key:"_remapVertices",value:function(e,t,n){for(var r=K.allocateTyped(Float32Array,3*n),i=K.allocateTyped(Float32Array,3*n),o=0;o<n;++o){var a=e[o];r[3*o]=a.x,r[3*o+1]=a.y,r[3*o+2]=a.z;var s=t[o].normalize();i[3*o]=s.x,i[3*o+1]=s.y,i[3*o+2]=s.z}this._position=r,this._normals=i}},{key:"vertexFusion",value:function(e,t){var n=this._indices.length,r=this._position,i=this._normals,o=0|r.length;if(0!==n&&0!==o){var a=K.allocateTyped(Uint32Array,o);a[0]=0;for(var s=1,l=1;l<o;++l){for(var c=s-e<0?0:s-e,u=c+t>s?s:c+t,h=-1,d=c;d<u;++d)if(Math.abs(r[l]-r[d])<Number.EPSILON){h=d;break}-1!==h?a[l]=h:(r[s].copy(r[l]),i[s].copy(i[l]),a[l]=s,++s)}this._remapIndices(a,n),this._remapVertices(r,i,s)}}},{key:"setColorVolTex",value:function(e,t,n,r){var i,o,a,s,l,c,u=this._position.length/3,h=this._position,d=this._origin,f=this._volumetricData.getDimensions(),p=f[0]-1,m=f[1]-1,v=f[2]-1,y=e.getData(),_=e.getStrideX(),g=e.getStrideY(),x=e.getStrideZ();null!==r&&(a=n.getData(),s=n.getStrideX(),l=n.getStrideY(),c=n.getStrideZ());var b=1/this._xAxis.x,w=1/this._yAxis.y,S=1/this._zAxis.z,C=[],R=[],A=K.allocateTyped(Float32Array,3*u);function E(e,t,n,r){r[0]=(1-e)*y[t]+e*y[n],r[1]=(1-e)*y[t+1]+e*y[n+1],r[2]=(1-e)*y[t+2]+e*y[n+2]}function k(e,n,r,i){var o=t[e];if(null!=o){C[o.index]=o;var s=n*r*i*a[e];void 0===R[o.index]?R[o.index]=s:R[o.index]+=s}}var T=K.allocateTyped(Int32Array,u),P=0;for(i=0;i<u;i++){var M=3*i,I=(h[M]-d.x)*b,N=(h[M+1]-d.y)*w,L=(h[M+2]-d.z)*S,D=0|Math.min(Math.max(I,0),p),O=0|Math.min(Math.max(N,0),m),V=0|Math.min(Math.max(L,0),v),z=I-D,F=N-O,B=L-V;if(null!=r){C=[],R=[],k(o=n.getDirectIdx(D,O,V),1-z,1-F,1-B),k(o+s,z,1-F,1-B),k(o+l,1-z,F,1-B),k(o+s+l,z,F,1-B),k(o+c,1-z,1-F,B),k(o+s+c,z,1-F,B),k(o+l+c,1-z,F,B),k(o+s+l+c,z,F,B);var U=0,G=-1;for(var j in R)R[j]>U&&(G=j,U=R[j]);if(G<0||!r.includesAtom(C[G])){T[i]=-1;continue}}T[i]=P++;var H=D<p?_:0,W=O<m?g:0,Y=V<v?x:0,q=[0,0,0],X=[0,0,0],$=[0,0,0],Z=[0,0,0];E(z,o=e.getDirectIdx(D,O,V),o+H,q),E(z,o+W,o+H+W,X),E(z,o+Y,o+H+Y,$),E(z,o+W+Y,o+H+W+Y,Z);var Q=[0,0,0];Q[0]=(1-F)*q[0]+F*X[0],Q[1]=(1-F)*q[1]+F*X[1],Q[2]=(1-F)*q[2]+F*X[2];var J=[0,0,0];J[0]=(1-F)*$[0]+F*Z[0],J[1]=(1-F)*$[1]+F*Z[1],J[2]=(1-F)*$[2]+F*Z[2],A[M]=(1-B)*Q[0]+B*J[0],A[M+1]=(1-B)*Q[1]+B*J[1],A[M+2]=(1-B)*Q[2]+B*J[2]}if(this._colors=A,null!=r){for(i=0;i<u;++i){var ee=T[i];ee<0||(this._position[3*ee]=this._position[3*i],this._position[3*ee+1]=this._position[3*i+1],this._position[3*ee+2]=this._position[3*i+2],this._normals[3*ee]=this._normals[3*i],this._normals[3*ee+1]=this._normals[3*i+1],this._normals[3*ee+2]=this._normals[3*i+2],this._colors[3*ee]=this._colors[3*i],this._colors[3*ee+1]=this._colors[3*i+1],this._colors[3*ee+2]=this._colors[3*i+2])}var te=this._indices.length/3,ne=0;for(i=0;i<te;++i){var re=T[this._indices[3*i]],ie=T[this._indices[3*i+1]],oe=T[this._indices[3*i+2]];re>=0&&ie>=0&&oe>=0&&(this._indices[3*ne]=re,this._indices[3*ne+1]=ie,this._indices[3*ne+2]=oe,++ne)}this._position=new Float32Array(this._position.buffer.slice(0,3*P*4)),this._normals=new Float32Array(this._normals.buffer.slice(0,3*P*4)),this._colors=new Float32Array(this._colors.buffer.slice(0,3*P*4)),this._indices=new Uint32Array(this._indices.buffer.slice(0,3*ne*4))}}},{key:"toMesh",value:function(){var e=new d.BufferGeometry;return e.setIndex(new d.BufferAttribute(this._indices,1)),e.setAttribute("position",new d.BufferAttribute(this._position,3)),e.setAttribute("normal",new d.BufferAttribute(this._normals,3)),e.setAttribute("color",new d.BufferAttribute(this._colors,3)),e.computeBoundingSphere(),e}}]),e}();Re()(_i,"_triTable",fi.prototype.striIndicesMarchCube),Re()(_i,"_arrSize",12),Re()(_i,"_firstIndices",[0,1,2,3,4,5,6,7,0,1,2,3]),Re()(_i,"_secondIndices",[1,2,3,0,5,6,7,4,4,5,6,7]),Re()(_i,"_vertexList",yi(_i._arrSize)),Re()(_i,"_normalList",yi(_i._arrSize));var gi=_i;function xi(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var bi=function(e){S()(n,e);var t=xi(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"_build",value:function(){var e=this._opts;this.numVoxels=[128,128,128],this.xAxis=new d.Vector3(1,0,0),this.yAxis=new d.Vector3(0,1,0),this.zAxis=new d.Vector3(0,0,1),this.origin=new d.Vector3(0,0,0),this._visibilitySelector=e.visibilitySelector,this._calcSurface(e)}},{key:"_findMinMax",value:function(e){for(var t=e.length/4,n=[e[0],e[1],e[2],e[3]],r=[e[0],e[1],e[2],e[3]],i=1;i<t;++i)for(var o=4*i,a=0;a<4;++a){var s=e[o+a];n[a]=Math.max(s,n[a]),r[a]=Math.min(s,r[a])}return{maxPosRad:n,minPosRad:r}}},{key:"_findNumVoxels",value:function(e,t){var n=this.numVoxels,r=this._findMinMax(e),i=r.minPosRad,o=r.maxPosRad;i[3]>4&&(t.gridSpacing*=i[3]);var a=t.radScale*o[3]*1.7,s=a;s=.65*Math.sqrt(4/3*Math.PI*s*s*s),a=Math.max(a,s);for(var l=0;l<3;++l)i[l]-=a,o[l]+=a;for(l=0;l<3;++l)n[l]=Math.ceil((o[l]-i[l])/t.gridSpacing);this.xAxis.x=(n[0]-1)*t.gridSpacing,this.yAxis.y=(n[1]-1)*t.gridSpacing,this.zAxis.z=(n[2]-1)*t.gridSpacing;var u=c()(i,3);return this.origin.x=u[0],this.origin.y=u[1],this.origin.z=u[2],{bbox:r,dim:n}}},{key:"_makeSurface",value:function(e,t){var n=new gi;n.compute(e.volMap,this.origin,t.isoValue,1),n.vertexFusion(9,9),n._numTriangles>0?(n.setColorVolTex(e.volTexMap,e.atomMap,e.atomWeightMap,this._visibilitySelector),this.setIndex(new d.BufferAttribute(n._indices,1)),this.setAttribute("position",new d.BufferAttribute(n._position,3)),this.setAttribute("normal",new d.BufferAttribute(n._normals,3)),this.setAttribute("color",new d.BufferAttribute(n._colors,3))):this.setAttribute("position",new d.BufferAttribute(K.allocateTyped(Float32Array,0),3))}},{key:"_calcSurface",value:function(e){var t={posRad:this._posRad,colors:this._colors,atoms:this._opts.atoms};if(0!==t.posRad.length){var n=this._findNumVoxels(t.posRad,e),r=new d.Box3(this.origin,new d.Vector3(this.xAxis.x,this.yAxis.y,this.zAxis.z).add(this.origin)),i=this._computeSurface(t,r,n,e);this._makeSurface(i,e)}}}]),n}(hi);function wi(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var Si=kn.Volume,Ci=function(e){S()(n,e);var t=wi(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"_computeSurface",value:function(e,t,n,r){this._shiftByOrigin(e.posRad);var i={volMap:new Si(Float32Array,this.numVoxels,t),volTexMap:new Si(Float32Array,this.numVoxels,t,3)};return null!=this._visibilitySelector&&(i.atomMap=[],i.atomWeightMap=new Si(Float32Array,this.numVoxels,t)),this.gaussdensity(i,e,null,r),i}},{key:"gaussdensity",value:function(e,t,n,r){var i,o=t.posRad.length/4,a=t.posRad,s=t.colors,l=this.numVoxels,c=r.radScale,u=r.gaussLim,h=r.gridSpacing,d=1/r.isoValue,f=1/h,p=l[0]-1,m=l[1]-1,v=l[2]-1,y=e.volMap,_=e.volTexMap,g=y.getData(),x=y.getStrideX(),b=_.getData(),w=_.getStrideX();null!=this._visibilitySelector&&(i=e.atomWeightMap.getData());for(var S=e.atomMap,C=0;C<o;++C){var R=4*C,A=a[R+3]*c,E=null===n?1:n[C],k=1/(2*A*A),T=u*A,P=T*T;T*=f;var M=a[R]*f,I=Math.max(M-T|0,0),N=Math.min(M+T|0,p);M=a[R+1]*f;var L=Math.max(M-T|0,0),D=Math.min(M+T|0,m);M=a[R+2]*f;for(var O=Math.max(M-T|0,0),V=Math.min(M+T|0,v),z=O*h-a[R+2],F=O;F<=V;++F,z+=h)for(var B=L*h-a[R+1],U=L;U<=D;++U,B+=h){var G=B*B+z*z;if(!(G>=P))for(var j=y.getDirectIdx(I,U,F),H=_.getDirectIdx(I,U,F),W=I*h-a[R],Y=I;Y<=N;++Y,W+=h,j+=x,H+=w){var q=-(W*W+G)*k,X=Math.exp(q)*E;null!=this._visibilitySelector&&X>i[j]&&(i[j]=X,S[j]=t.atoms[C]),g[j]+=X,X*=d;var $=3*C;b[H]+=X*s[$],b[H+1]+=X*s[$+1],b[H+2]+=X*s[$+2]}}}}},{key:"_shiftByOrigin",value:function(e){for(var t=this.origin.x,n=this.origin.y,r=this.origin.z,i=e.length/4,o=0;o<i;++o){var a=4*o;e[a]-=t,e[a+1]-=n,e[a+2]-=r}}}]),n}(bi);function Ri(e,t,n,r){var i=e.length/4,o=t[0],a=t[1],s=t[2],l=n[0],c=n[1],u=n[2];function h(e,t){return Math.floor((e-t)/r)}var d,f,p,m,v,y=h(l,o)+1,_=h(c,a)+1,g=h(u,s)+1,x=y*_*g,b=_*g,w=[];for(d=0;d<i;d++){var S=4*d;p=e[S],m=e[S+1],v=e[S+2],void 0===w[f=(h(p,o)*_+h(m,a))*g+h(v,s)]?w[f]=[d]:w[f].push(d)}var C,R=K.allocateTyped(Uint32Array,x),A=K.allocateTyped(Uint16Array,x),E=K.allocateTyped(Uint32Array,i),k=0,T=0;for(d=0;d<x;d++){var P=R[d]=k,M=w[d];if(void 0!==M)for(C=0;C<M.length;C++)E[k]=M[C],k++;var I=k-P;A[d]=I,I>T&&(T=I)}this.neighbourListLength=27*T+1,this.withinRadii=function(t,n,r,i,l){var c=0,u=h(t,o),p=h(n,a),m=h(r,s),v=Math.max(0,u-1),x=Math.max(0,p-1),w=Math.max(0,m-1),S=Math.min(y-1,u+1),k=Math.min(_-1,p+1),T=Math.min(g-1,m+1);for(d=v;d<=S;++d){var P=d*b;for(C=x;C<=k;++C)for(var M=C*g,I=w;I<=T;++I)for(var N=R[f=P+M+I],L=N+A[f],D=N;D<L;D++){var O=4*E[D],V=e[O]-t,z=e[O+1]-n,F=e[O+2]-r,B=e[O+3]+i;V*V+z*z+F*F<=B*B&&(l[c++]=E[D])}}l[c]=-1}}var Ai=function(e,t,n,r){var i,o,a,s,l,c,u,h,f,p,m,v,y,_,g,x,b,w=e.posRad,S=e.colors,C=e.atoms,R=w.length/4,A=t.bbox,E=A.minPosRad,k=A.maxPosRad,T=-1,P=null,M=null,I=null,N=new d.Vector3(0,0,0),L=new d.Vector3(0,0,0),D=new d.Vector3(0,0,0);function O(e,t,n){for(var r=0;r<e.length;r++)e[r]=t+n*r}function V(){s=n.scaleFactor,c=t.dim,b=Math.min(5,2+Math.floor(a*s));var e=c[0]*c[1]*c[2];u=function(e,t,n){for(var r=K.allocateTyped(e,t),i=0;i<t;++i)r[i]=n;return r}(Float32Array,e,-1001),h=K.allocateTyped(Float32Array,3*e),f=K.allocateTyped(Float32Array,e),I&&(P=K.allocateTyped(Float32Array,e),M=[]),p=K.allocateTyped(Float32Array,c[0]),m=K.allocateTyped(Float32Array,c[1]),v=K.allocateTyped(Float32Array,c[2]),O(p,E[0],1/s),O(m,E[1],1/s),O(v,E[2],1/s)}function z(){a=n.probeRadius,s=n.scaleFactor,l=n.probePositions,I=n.visibilitySelector,i=K.allocateTyped(Float32Array,R),o=0;for(var e=0;e<R;++e){var t=w[4*e+3]+=a;t>o&&(o=t),i[e]=t*t}V(),function(){var e=0,t=2*Math.PI/l;_=K.allocateTyped(Float32Array,l),y=K.allocateTyped(Float32Array,l);for(var n=0;n<l;n++)_[n]=Math.cos(e),y[n]=Math.sin(e),e+=t}(),g=new Ri(w,E,k,2.01*o),x=new Int32Array(g.neighbourListLength),T=-1}function F(e,t,n,r){var o=4*e,a=i[e],s=w[o]-t,l=w[o+1]-n,c=w[o+2]-r;return s*s+l*l+c*c<a}function B(e,t,n,r,i){var o;if(-1!==T){if((o=T)!==r&&o!==i&&F(o,e,t,n))return o;T=-1}var a=0;for(o=x[a];o>=0;){if(o!==r&&o!==i&&F(o,e,t,n))return T=o,o;o=x[++a]}return T=-1,-1}function U(e,t){var n=4*e,r=4*t,i=w[n],o=w[n+1],a=w[n+2],h=w[n+3],d=N.x=w[r]-i,f=N.y=w[r+1]-o,g=N.z=w[r+2]-a,x=w[r+3],S=d*d+f*f+g*g,C=Math.sqrt(S),R=h*((h*h+C*C-x*x)/(2*h*C));N.normalize(),function(e,t){e.x=e.y=e.z=1,0!==t.x?e.x=(t.y+t.z)/-t.x:0!==t.y?e.y=(t.x+t.z)/-t.y:0!==t.z&&(e.z=(t.x+t.y)/-t.z)}(L,N),L.normalize(),D.crossVectors(N,L),D.normalize();var A=Math.sqrt(h*h-R*R);L.multiplyScalar(A),D.multiplyScalar(A),N.multiplyScalar(R),N.x+=i,N.y+=o,N.z+=a,T=-1;for(var k=b,P=0;P<l;P++){var M=_[P],I=y[P],O=N.x+M*L.x+I*D.x,V=N.y+M*L.y+I*D.y,z=N.z+M*L.z+I*D.z;if(-1===B(O,V,z,e,t))for(var F=Math.floor(s*(O-E[0])),U=Math.floor(s*(V-E[1])),G=Math.floor(s*(z-E[2])),j=Math.max(0,F-k),H=Math.max(0,U-k),W=Math.max(0,G-k),Y=Math.min(c[0],F+k+2),q=Math.min(c[1],U+k+2),X=Math.min(c[2],G+k+2),$=W;$<X;$++){g=z-v[$];for(var K=c[1]*c[0]*$,Z=H;Z<q;Z++)for(var Q=g*g+(f=V-m[Z])*f,J=K+c[0]*Z,ee=j;ee<Y;ee++){S=Q+(d=O-p[ee])*d;var te=ee+J,ne=u[te];ne>0&&S<ne*ne&&(u[te]=Math.sqrt(S))}}}}function G(){console.time("ContactSurface.getVolume"),console.time("ContactSurface.init"),z(),console.timeEnd("ContactSurface.init"),console.time("ContactSurface.projectPoints"),function(){for(var e=0;e<R;e++){var t=4*e,n=w[t],r=w[t+1],o=w[t+2],a=w[t+3],l=i[e];g.withinRadii(n,r,o,a,x);for(var d=Math.ceil(a*s),y=Math.floor(s*(n-E[0])),_=Math.floor(s*(r-E[1])),b=Math.floor(s*(o-E[2])),A=Math.max(0,y-d),k=Math.max(0,_-d),T=Math.max(0,b-d),N=Math.min(c[0],y+d+2),L=Math.min(c[1],_+d+2),D=Math.min(c[2],b+d+2),O=3*e,V=S[O],z=S[O+1],F=S[O+2],U=T;U<D;U++)for(var G=v[U]-o,j=c[1]*c[0]*U,H=k;H<L;H++)for(var W=m[H]-r,Y=G*G+W*W,q=j+c[0]*H,X=A;X<N;X++){var $=X+q,K=p[X]-n,Z=Y+K*K;if(Z<l){var Q=Math.exp(.28125*-Z),J=3*$;h[J]+=V*Q,h[J+1]+=z*Q,h[J+2]+=F*Q,f[$]+=Q,null!==I&&Q>P[$]&&(P[$]=Q,M[$]=C[e]),u[$]<0&&(u[$]=-u[$]);var ee=Math.sqrt(Z),te=a/ee,ne=K*te,re=W*te,ie=G*te;if(-1===B(ne+=n,re+=r,ie+=o,e,-1)){var oe=a-ee;oe<u[$]&&(u[$]=oe)}}}}}(),console.timeEnd("ContactSurface.projectPoints"),console.time("ContactSurface.projectTorii"),function(){for(var e=0;e<R;e++){var t=4*e;g.withinRadii(w[t],w[t+1],w[t+2],w[t+3],x);for(var n=0,r=x[n];r>=0;)e<r&&U(e,r),r=x[++n]}}(),console.timeEnd("ContactSurface.projectTorii"),function(){for(var e=0,t=u.length;e<t;e++){u[e]<0&&(u[e]=0);var n=f[e];if(n>0){n=1/n;var r=3*e;h[r]*=n,h[r+1]*=n,h[r+2]*=n}}}(),console.timeEnd("ContactSurface.getVolume")}this.build=function(){G(),this.volTexMap=h,this.weightsMap=P,this.atomMap=M,this.volMap=u}};function Ei(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var ki=kn.Volume,Ti=function(e){S()(n,e);var t=Ei(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"_computeSurface",value:function(e,t,n,r){var i=new Ai(e,n,r);return i.build(),{volMap:new ki(Float32Array,this.numVoxels,t,1,i.volMap),volTexMap:new ki(Float32Array,this.numVoxels,t,3,i.volTexMap),atomMap:i.atomMap,atomWeightMap:new ki(Float32Array,this.numVoxels,t,1,i.weightsMap)}}}]),n}(bi),Pi=function e(t,n){m()(this,e),this.coord=new d.Vector3,this.coord.copy(t),this.radius=n,this.colorX=.99999,this.colorY=0,this.colorZ=0,this.atomType=0,this.srcAtom=null},Mi=function(){function e(t,n,r,i,o){m()(this,e),this._numAtoms=t,this._atoms=n,this._vBoxMin=new d.Vector3,this._vBoxMax=new d.Vector3,this._vBoxMin.copy(r),this._vBoxMax.copy(i),this._probeRadius=o,this._atomsList=null,this._voxelList=null}return y()(e,[{key:"createVoxels",value:function(){var e,t,n=0|this._numAtoms,r=this._atoms,i=this._vBoxMax.x-this._vBoxMin.x,o=this._vBoxMax.y-this._vBoxMin.y,a=this._vBoxMax.z-this._vBoxMin.z,s=i<o?i:o;s=a<s?a:s;var l,c=0,u=0;for(l=0;l<n;l++)c=(t=2*(r[l].radius+this._probeRadius))>c?t:c,u+=t;var h=Math.floor(s/c);h<2&&(h=2),u/=n,this._numCells=h,this._aveRad=u,this._maxRad=c;var d=h,f=h*h,p=h*h*h,m=this._xScale=1/(this._vBoxMax.x-this._vBoxMin.x),v=this._yScale=1/(this._vBoxMax.y-this._vBoxMin.y),y=this._zScale=1/(this._vBoxMax.z-this._vBoxMin.z),_=0,g=m*h,x=v*h,b=y*h;for(l=0;l<n;l++){var w=2*(4.5*(r[l].radius+this._probeRadius)),S=Math.floor(g*w+.8),C=Math.floor(x*w+.8),R=Math.floor(b*w+.8);_+=++S*++C*++R}this._voxelList=K.allocateTyped(Int32Array,p);var A=[];if(A.length=_,null===this._voxelList||null===A)return-1;for(l=0;l<p;l++)this._voxelList[l]=-1;for(e=0,l=0;l<n;l++){t=4.5*(r[l].radius+this._probeRadius);var E=Math.floor((r[l].coord.x-this._vBoxMin.x-t)*h*m),k=Math.floor((r[l].coord.y-this._vBoxMin.y-t)*h*v),T=Math.floor((r[l].coord.z-this._vBoxMin.z-t)*h*y),P=Math.floor((r[l].coord.x-this._vBoxMin.x+t)*h*m),M=Math.floor((r[l].coord.y-this._vBoxMin.y+t)*h*v),I=Math.floor((r[l].coord.z-this._vBoxMin.z+t)*h*y);E=E>=0?E:0,k=k>=0?k:0,P=P<h?P:h-1,M=M<h?M:h-1,I=I<h?I:h-1;for(var N=T=T>=0?T:0;N<=I;N++)for(var L=k;L<=M;L++)for(var D=E;D<=P;D++){var O=D+L*d+N*f;if(this._voxelList[O]<0)A[2*e+0]=l,A[2*e+1]=-1,this._voxelList[O]=e,e++;else{var V=this._voxelList[O];this._voxelList[O]=e,A[2*e+0]=l,A[2*e+1]=V,e++}}}return this._atomsList=Int32Array.from(A),0}},{key:"destroyVoxels",value:function(){this._atomsList=null,this._voxelList=null,this._atoms=null,this._vertices=null,this._vBoxMin=null,this._vBoxMax=null}},{key:"forEachRelatedAtom",value:function(e,t){for(var n=Math.floor((e.x-this._vBoxMin.x)*this._numCells*this._xScale),r=Math.floor((e.y-this._vBoxMin.y)*this._numCells*this._yScale),i=Math.floor((e.z-this._vBoxMin.z)*this._numCells*this._zScale),o=n+r*this._numCells+i*this._numCells*this._numCells,a=this._atoms,s=this._voxelList[o];s>=0;s=this._atomsList[2*s+1]){t(a[this._atomsList[2*s]])}}},{key:"getClosestAtom",value:function(e){var t=null,n=Number.MAX_VALUE;return this.forEachRelatedAtom(e,(function(r){var i=e.distanceToSquared(r.coord);i<n&&(n=i,t=r)})),t}},{key:"buildNormals",value:function(e,t,n){for(var r,i=this,o=0,a=0,s=0,l=0,c=0,u=0,h=0,d=0,f=0,p=2.5*this._aveRad,m=p*p,v=.1*-this._aveRad,y=function(e){var t=a-e.coord.x,n=s-e.coord.y,p=l-e.coord.z;if(!((r=t*t+n*n+p*p)>m)){var y=e.radius+i._probeRadius;(d=r-y*y)<0&&(d=-d),f=Math.exp(v*d),c+=t*f,u+=n*f,h+=p*f,o++}},_=0,g=0;g<e;g++)a=t[g].x,s=t[g].y,l=t[g].z,o=0,c=u=h=0,this.forEachRelatedAtom(t[g],y),_=o>_?o:_,r=c*c+u*u+h*h,o>0&&(d=1/Math.sqrt(r),c*=d,u*=d,h*=d),n[g].x=c,n[g].y=u,n[g].z=h;return 0}},{key:"buildColors",value:function(e,t,n,r){for(var i=this,o=0,a=0,s=0,l=0,c=0,u=r*r,h=[],d=[],f=0,p=function(e){var t=o-e.coord.x,n=a-e.coord.y,r=s-e.coord.z,p=t*t+n*n+r*r;if(!(p>u)){var m=e.radius+i._probeRadius;(l=p-m*m)<0&&(l=-l),c=1/(.8+l),h.push([e.colorX,e.colorY,e.colorZ]),d.push(c),f+=c}},m=0;m<e;m++){o=t[m].x,a=t[m].y,s=t[m].z,h=[],d=[],f=0,this.forEachRelatedAtom(t[m],p);for(var v=0;v<h.length;++v){var y=d[v]/f;n[m].x+=h[v][0]*y,n[m].y+=h[v][1]*y,n[m].z+=h[v][2]*y}}return 0}}]),e}(),Ii=function(){function e(t,n,r){var i;for(m()(this,e),this._maxNumVertices=t,this._maxNumTriangles=n,this._vertices=new Array(t),this._normals=new Array(t),this._colors=null,r&&(this._colors=new Array(t)),this._indices=new Array(3*n),this._numVertices=0,this._numTriangles=0,i=0;i<t;i++)this._vertices[i]=new d.Vector3,this._normals[i]=new d.Vector3;for(i=0;i<3*n;i++)this._indices[i]=-1;if(r)for(i=0;i<t;i++)this._colors[i]=new d.Vector3}return y()(e,[{key:"destroy",value:function(){this._vertices=null,this._normals=null,this._indices=null}}]),e}();function Ni(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var Li=kn.Element;function Di(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var Oi={InstancedSpheresGeometry:sr,SimpleSpheresGeometry:mr,Simple2CCylindersGeometry:xr,Instanced2CCylindersGeometry:Pr,ExtrudedObjectsGeometry:zr,ChunkedLinesGeometry:Jr,TwoColorLinesGeometry:ni,CrossGeometry:li,QuickSurfGeometry:Ci,ContactSurfaceGeometry:Ti,SSIsosurfaceGeometry:function(e){S()(n,e);var t=Ni(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"_build",value:function(){this._innerBuild();var e=this.getGeo();this.destroy(),this._fromGeo(e)}},{key:"_fromGeo",value:function(e){var t=null,n=K.allocateTyped(Float32Array,3*e._numVertices),r=K.allocateTyped(Float32Array,3*e._numVertices);null!==e._colors&&(t=K.allocateTyped(Float32Array,3*e._numVertices));for(var i=K.allocateTyped(Uint32Array,3*e._numTriangles),o=0,a=0;o<e._numVertices;o++)n[a+0]=e._vertices[o].x,n[a+1]=e._vertices[o].y,n[a+2]=e._vertices[o].z,r[a+0]=e._normals[o].x,r[a+1]=e._normals[o].y,r[a+2]=e._normals[o].z,a+=3;if(null!==t)for(var s=0,l=0;s<e._numVertices;s++,l+=3)t[l+0]=e._colors[s].x,t[l+1]=e._colors[s].y,t[l+2]=e._colors[s].z;for(var c=3*e._numTriangles,u=0;u<c;u++)i[u]=e._indices[u];this.setIndex(new d.BufferAttribute(i,1)),this.setAttribute("position",new d.BufferAttribute(n,3)),this.setAttribute("normal",new d.BufferAttribute(r,3)),this.setAttribute("color",new d.BufferAttribute(t,3)),this.computeBoundingBox(),this.computeBoundingSphere(),e.destroy()}},{key:"convertToAtomsColored",value:function(e,t){for(var n=e.atoms,r=e.colors,i=0,o=n.length;i<o;i++){var a=n[i].position,s=n[i].element.radius;t[i]=new Pi(a,s);var l=n[i].element.number;t[i].atomType=this.getType(l);var c=3*i;t[i].colorX=r[c++],t[i].colorY=r[c++],t[i].colorZ=r[c],t[i].srcAtom=n[i]}}},{key:"getGeo",value:function(){return this.geoOut}},{key:"destroy",value:function(){this.atoms=null,this.hashLines=null,this.hashEntries=null}},{key:"getBoundingBox",value:function(e,t,n){t.x=t.y=t.z=1e7,n.x=n.y=n.z=-1e7;for(var r=this.probeRadius*this.atomRadiusScale,i=0,o=0,a=e.length;o<a;o++){var s=e[o].coord,l=e[o].radius+r;i=l>i?l:i,s.x-l<t.x&&(t.x=s.x-l),s.y-l<t.y&&(t.y=s.y-l),s.z-l<t.z&&(t.z=s.z-l),s.x+l>n.x&&(n.x=s.x+l),s.y+l>n.y&&(n.y=s.y+l),s.z+l>n.z&&(n.z=s.z+l)}t.x-=i,t.y-=i,t.z-=i,n.x+=i,n.y+=i,n.z+=i}},{key:"getCornerCoord",value:function(e,t,n,r,i,o,a){var s=1/(o-1),l=n*s,c=r*s,u=i*s;a.x=e.x*(1-l)+t.x*l,a.y=e.y*(1-c)+t.y*c,a.z=e.z*(1-u)+t.z*u}},{key:"buildEdgePoint",value:function(e,t,n,r,i,o){if(n[e]^n[t]){var a=(0-r.pointsValuesLinear[i+24+e])/(r.pointsValuesLinear[i+24+t]-r.pointsValuesLinear[i+24+e]),s=r.pointsValuesLinear[i+3*e+0],l=r.pointsValuesLinear[i+3*e+1],c=r.pointsValuesLinear[i+3*e+2],u=r.pointsValuesLinear[i+3*t+0],h=r.pointsValuesLinear[i+3*t+1],d=r.pointsValuesLinear[i+3*t+2];o.x=s*(1-a)+u*a,o.y=l*(1-a)+h*a,o.z=c*(1-a)+d*a}}},{key:"isTriangleVisible",value:function(e,t,n){var r=this.voxelWorld.getClosestAtom(e),i=this.voxelWorld.getClosestAtom(t),o=this.voxelWorld.getClosestAtom(n);return null!==r&&null!==i&&null!==o&&null!==r.srcAtom&&null!==i.srcAtom&&null!==o.srcAtom&&(this.visibilitySelector.includesAtom(r.srcAtom)&&this.visibilitySelector.includesAtom(i.srcAtom)&&this.visibilitySelector.includesAtom(o.srcAtom))}},{key:"addTriangle",value:function(e,t,n){if(this.visibilitySelector&&!this.isTriangleVisible(e,t,n))return!0;var r=this.geoOut;if(r._numTriangles>=this.maxNumTriangles)return!1;var i=this.addVertexToGeo(r,e),o=this.addVertexToGeo(r,t),a=this.addVertexToGeo(r,n);if((i|o|a)<0)return!1;var s=3*r._numTriangles;return r._indices[s+0]=i,r._indices[s+1]=o,r._indices[s+2]=a,r._numTriangles++,!0}},{key:"buildGeoFromCorners",value:function(e,t,n,r,i,o){for(var a=e-1,s=e,l=e*e,c=new Array(12),u=0;u<12;u++)c[u]=new d.Vector3;for(var h=[],f=0;f<8;f++)h[f]=1;for(var p=new d.Vector3,m=0,v=0,y=0;y<a;y++,v+=l)for(var _=0,g=0;g<a;g++,_+=s)for(var x=0;x<a;x++)if(o.hasIntersection[m]){var b=o.bitsInside[m];this.getCornerCoord(t,n,x,y,g,e,p);for(var w=32*m,S=0,C=0;S<8;S++)o.pointsValuesLinear[w+C++]=p.x,o.pointsValuesLinear[w+C++]=p.y,o.pointsValuesLinear[w+C++]=p.z;o.pointsValuesLinear[w+3]+=i.x,o.pointsValuesLinear[w+6]+=i.x,o.pointsValuesLinear[w+15]+=i.x,o.pointsValuesLinear[w+18]+=i.x,o.pointsValuesLinear[w+6+2]+=i.z,o.pointsValuesLinear[w+9+2]+=i.z,o.pointsValuesLinear[w+18+2]+=i.z,o.pointsValuesLinear[w+21+2]+=i.z,o.pointsValuesLinear[w+12+1]+=i.y,o.pointsValuesLinear[w+15+1]+=i.y,o.pointsValuesLinear[w+18+1]+=i.y,o.pointsValuesLinear[w+21+1]+=i.y;for(var R=w+24,A=0;A<8;++A)h[A]=o.pointsValuesLinear[R+A]<0?1:0;this.buildEdgePoint(0,1,h,o,w,c[0]),this.buildEdgePoint(1,2,h,o,w,c[1]),this.buildEdgePoint(2,3,h,o,w,c[2]),this.buildEdgePoint(3,0,h,o,w,c[3]),this.buildEdgePoint(4,5,h,o,w,c[4]),this.buildEdgePoint(5,6,h,o,w,c[5]),this.buildEdgePoint(6,7,h,o,w,c[6]),this.buildEdgePoint(7,4,h,o,w,c[7]),this.buildEdgePoint(0,4,h,o,w,c[8]),this.buildEdgePoint(1,5,h,o,w,c[9]),this.buildEdgePoint(2,6,h,o,w,c[10]),this.buildEdgePoint(3,7,h,o,w,c[11]);for(var E=16*b,k=0,T=0;k<6;k++,T+=3){var P=o.striIndicesMarchCube[E+T];if(P<0)break;var M=o.striIndicesMarchCube[E+T+1],I=o.striIndicesMarchCube[E+T+2];if(!this.addTriangle(c[P],c[M],c[I]))return-2}m++}else m++;return 0}},{key:"getNumIntersectedCells",value:function(e,t,n,r){for(var i=e*e,o=0,a=0,s=0,l=0;l<t;l++,s+=i)for(var c=0,u=0;u<t;u++,c+=e)for(var h=0;h<t;h++){var d=32*a+24,f=h+c+s;r.pointsValuesLinear[d]=n[f],r.pointsValuesLinear[d+1]=n[f+1],r.pointsValuesLinear[d+2]=n[f+e+1],r.pointsValuesLinear[d+3]=n[f+e],r.pointsValuesLinear[d+4]=n[i+f],r.pointsValuesLinear[d+5]=n[i+f+1],r.pointsValuesLinear[d+6]=n[i+f+e+1],r.pointsValuesLinear[d+7]=n[i+f+e];for(var p=0,m=0;m<8;++m)r.pointsValuesLinear[d+m]<0&&(p|=1<<m);0===p||255===p?r.hasIntersection[a]=!1:(r.hasIntersection[a]=!0,o++),r.bitsInside[a]=p,a++}return o}},{key:"getType",value:function(e){var t=[0,0,1,1,2,6,3,6,4,6,5,6,6,0,7,3,8,2,9,6,10,6,11,6,12,6,13,6,14,6,15,4,16,5,17,6,18,6,19,6,20,6,21,6,22,6,23,6,24,6,25,6,26,6,27,6,28,6,29,6,30,6,31,6,32,6,33,6,34,6,35,6,36,6,37,6,38,6,39,6,40,6,41,6,42,6,43,6,44,6,45,6,46,6,47,6,48,6,49,6,50,6,51,6,52,6,53,6,54,6,55,6,56,6,57,6,58,6,59,6,60,6,61,6,62,6,63,6,64,6,65,6,66,6,67,6,68,6,69,6,70,6,71,6,72,6,73,6,74,6,75,6,76,6,77,6,78,6,79,6,80,6,81,6,82,6,83,6,84,6,85,6,86,6,87,6,88,6,89,6,90,6,91,6,92,6,93,6,94,6,95,6,96,6,97,6,98,6,99,6,100,6,101,6,102,6,103,6,104,6,105,6,106,6,107,6,108,6,109,6];if(e<1||e>t.length/2||2*Object.keys(Li.ByAtomicNumber).length!==t.length)throw new Error("atomT.length  should be equal Element.ByAtomicNumber.length * 2");return t[2*e]}},{key:"calculateGridCorners",value:function(e,t,n,r,i,o){for(var a=t*t,s=a*t,l=new d.Vector3,c=new d.Vector3,u=0;u<s;u++)e[u]=1e12;for(var h=(t-1)/(r.x-n.x),f=(t-1)/(r.y-n.y),p=(t-1)/(r.z-n.z),m=0,v=i.length;m<v;m++){var y=i[m],_=y.radius+o,g=(y.coord.x-_-n.x)*h,x=(y.coord.y-_-n.y)*f,b=(y.coord.z-_-n.z)*p,w=Math.floor(g),S=Math.floor(x),C=Math.floor(b),R=Math.floor((y.coord.x+_-n.x)*h),A=Math.floor((y.coord.y+_-n.y)*f),E=Math.floor((y.coord.z+_-n.z)*p);R=++R<=t-1?R:t-1,A=++A<=t-1?A:t-1,E=++E<=t-1?E:t-1;for(var k=S;k<=A;k++)for(var T=k*a,P=C;P<=E;P++)for(var M=P*t,I=w;I<=R;I++){var N=T+M+I;this.getCornerCoord(n,r,I,k,P,t,l),c.x=l.x-y.coord.x,c.y=l.y-y.coord.y,c.z=l.z-y.coord.z;var L=Math.sqrt(c.x*c.x+c.y*c.y+c.z*c.z)-_;L<e[N]&&(e[N]=L)}}}},{key:"createVertexHash",value:function(e,t){if(this.hashLines=K.allocateTyped(Int32Array,65536),null===this.hashLines)return-1;for(var n=0,r=0;n<32768;n++)this.hashLines[r++]=0,this.hashLines[r++]=-1;if(this.maxNumVertices=e,this.maxNumTriangles=t,this.numHashEtriesAllocated=e,this.hashEntries=K.allocateTyped(Int32Array,2*this.numHashEtriesAllocated),null===this.hashEntries)return-1;for(var i=0,o=0;i<this.numHashEtriesAllocated;i++)this.hashEntries[o++]=-1,this.hashEntries[o++]=-1;return this.numHashEntryIndex=0,0}},{key:"getNewHashEntry",value:function(){if(this.numHashEntryIndex<this.numHashEtriesAllocated){var e=this.numHashEntryIndex;return this.numHashEntryIndex++,e}return-1}},{key:"addVertexToGeo",value:function(e,t){var n,r=this.marCubeResoultion<<2,i=new d.Vector3,o=Math.floor(r*(t.x-this.vBoxMin.x)/(this.vBoxMax.x+.01-this.vBoxMin.x)),a=Math.floor(r*(t.y-this.vBoxMin.y)/(this.vBoxMax.y+.01-this.vBoxMin.y)),s=815851*o+37633*Math.floor(r*(t.z-this.vBoxMin.z)/(this.vBoxMax.z+.01-this.vBoxMin.z))+2453543*a,l=(s&=32767)+s;if(null!==this.vBoxMin&&null!==this.vBoxMax)for(n=this.hashLines[l+1];n>=0;n=this.hashEntries[2*n+1]){var c=this.hashEntries[2*n+0];if(i.copy(e._vertices[c]),i.x-=t.x,i.y-=t.y,i.z-=t.z,i.x*i.x+i.y*i.y+i.z*i.z<1e-6)return c}if(e._numVertices>=this.maxNumVertices)return-1;var u=e._numVertices;if(e._vertices[u].copy(t),null!==this.vBoxMin&&null!==this.vBoxMax){if((n=this.getNewHashEntry())<0)return-1;var h=this.hashLines[l+1];this.hashLines[l+1]=n,this.hashEntries[2*n+0]=u,this.hashEntries[2*n+1]=h,this.hashLines[l+0]++}return e._numVertices++,u}},{key:"modifyExcludedFromGeo",value:function(e,t,n,r,i,o){var a,s,l;for(var c=e*e,u=(e-1)/(r.x-n.x),h=(e-1)/(r.y-n.y),d=(e-1)/(r.z-n.z),f=2*t*(2*t),p=1/(e-1),m=0;m<i._numVertices;m++){var v=i._vertices[m],y=1.1*t,_=Math.floor((v.x-y-n.x)*u),g=Math.floor((v.y-y-n.y)*h),x=Math.floor((v.z-y-n.z)*d),b=Math.floor((v.x+y-n.x)*u),w=Math.floor((v.y+y-n.y)*h),S=Math.floor((v.z+y-n.z)*d);_=_>=0?_:0,x=x>=0?x:0,b=b<=e-1?b:e-1,w=w<=e-1?w:e-1,S=S<=e-1?S:e-1;for(var C=g=g>=0?g:0;C<=w;C++)for(var R=C*c,A=x;A<=S;A++)for(var E=A*e,k=_;k<=b;k++){a=R+E+k;var T=k*p,P=n.x*(1-T)+r.x*T;T=C*p;var M=n.y*(1-T)+r.y*T;T=A*p;var I=n.z*(1-T)+r.z*T,N=P-v.x,L=M-v.y,D=I-v.z,O=N*N+L*L+D*D;O<f&&(s=Math.sqrt(O),(l=-(s-t))>0?(o[a]<0&&(o[a]=l),l>o[a]&&(o[a]=l)):l>o[a]&&(o[a]=l))}}return 0}},{key:"_innerBuild",value:function(){var e,t={posRad:this._posRad,colors:this._colors,atoms:this._opts.atoms};this.complex=this._opts.parent,this.atoms=t.atoms,this.meshResolution=this._opts.gridSpacing,this.atomRadiusScale=this._opts.radScale,this.colorMode=this._opts.colorMode,this.probeRadius=this._opts.probeRadius,this.useVertexColors=!0,this.excludeProbe=this._opts.excludeProbe,this.visibilitySelector=this._opts.visibilitySelector,this.geoOut=null,this.hashLines=null,this.hashEntries=null,this.numHashEtriesAllocated=0,this.numHashEntryIndex=0,this.maxNumVertices=0,this.maxNumTriangles=0;var n=new Array(this.atoms.length);this.convertToAtomsColored(t,n);var r=this.vBoxMin=new d.Vector3,i=this.vBoxMax=new d.Vector3;this.getBoundingBox(n,r,i);var o=this.marCubeResoultion=4*this.meshResolution,a=o,s=a*a*a,l=K.allocateTyped(Float32Array,s),c=this.probeRadius*this.atomRadiusScale;this.calculateGridCorners(l,a,r,i,n,c);var u=o-1,h=new fi;if((e=h.create(u))<0)return e;var f=new d.Vector3;f.x=(i.x-r.x)/u,f.y=(i.y-r.y)/u,f.z=(i.z-r.z)/u;var p=this.getNumIntersectedCells(a,u,l,h),m=Math.floor(1.2*p),v=Math.floor(1.2*p*2);if(this.geoOut=new Ii(m,v,this.useVertexColors),(e=this.createVertexHash(m,v))<0)return e;var y=c;if(this.excludeProbe&&(y=.01),this.voxelWorld=new Mi(n.length,n,r,i,y),this.voxelWorld.createVoxels(),e=this.buildGeoFromCorners(o,r,i,l,f,h),this.excludeProbe){if(this.modifyExcludedFromGeo(a,c,r,i,this.geoOut,l),this.geoOut._vertices=null,this.geoOut._colors=null,this.geoOut._indices=null,this.geoOut._normals=null,this.geoOut._numVertices=0,this.geoOut._numTriangles=0,this.geoOut=null,p=this.getNumIntersectedCells(a,u,l,h),m=Math.floor(1.2*p),v=Math.floor(1.2*p*2),this.geoOut=new Ii(m,v,this.useVertexColors),(e=this.createVertexHash(m,v))<0)return e;e=this.buildGeoFromCorners(a,r,i,l,f,h)}this.voxelWorld.buildNormals(this.geoOut._vertices.length,this.geoOut._vertices,this.geoOut._normals);var _=6.5;return this.excludeProbe&&(_-=1.5),this.useVertexColors&&this.voxelWorld.buildColors(this.geoOut._vertices.length,this.geoOut._vertices,this.geoOut._colors,_),this.voxelWorld.destroyVoxels(),this.voxelWorld=null,h.destroy(),e}}]),n}(hi),LabelsGeometry:function(e){S()(n,e);var t=Di(n);function n(e,r){var i;m()(this,n),(i=t.call(this))._opts=r,i.items=[],i.needsUpdate=!1;var o=-50,a=-50;switch(r.horizontalAlign){case"left":o=0;break;case"right":o=-100}switch(r.verticalAlign){case"top":a=-100;break;case"bottom":a=0}var s=new d.Vector3(r.dx||0,r.dy||0,r.dz||0);return i.userData={translation:"translate(".concat(o,"%, ").concat(a,"%)"),offset:s},i}return y()(n,[{key:"setItem",value:function(e,t,n){var r=this._opts,i=this.items[e]||function(e,t){var n=document.createElement("div");if(n.className=t,"string"==typeof e){var r=document.createElement("span");r.style.fontSize="150%";for(var i=e.split("\n"),o=0,a=i.length;o<a;++o){var s=document.createElement("span"),l=document.createTextNode(i[o]);s.appendChild(l),r.appendChild(s),o<a-1&&r.appendChild(document.createElement("br"))}n.appendChild(r)}else n.appendChild(e);return n.worldPos=new d.Vector3,n}(n,"label");i.worldPos.copy(t),i.style.textAlign=r.horizontalAlign,i.style.verticalAlign=r.verticalAlign,this.items[e]=i}},{key:"setColor",value:function(e,t,n){this.items[e].opts={color:t,background:n}}},{key:"startUpdate",value:function(){return!0}},{key:"finishUpdate",value:function(){this.needsUpdate=!0,this.dispatchEvent({type:"update"})}},{key:"finalize",value:function(){this.finishUpdate()}},{key:"raycast",value:function(){}},{key:"setOpacity",value:function(){}},{key:"getSubset",value:function(){return[]}}]),n}(I)},Vi={precision:"mediump",init:function(e){this.precision=e.capabilities.getMaxPrecision("highp")}},zi=new Uint8Array([24,52,0,254,145,0,122,0,0,7,170,0,34,214,0,173,8,0,86,249,0,160,4,0,226,46,0,224,211,0,3,157,0,174,247,0,12,182,0,220,216,0,1,109,0,253,154,0]),Fi=d.RepeatWrapping,Bi=d.RepeatWrapping,Ui=d.NearestFilter,Gi=d.NearestFilter,ji=d.UVMapping,Hi=new d.DataTexture(zi,4,4,d.RGBFormat,d.UnsignedByteType,ji,Fi,Bi,Gi,Ui,1);Hi.needsUpdate=!0;var Wi={noiseWidth:4,noiseHeight:4,noiseTexture:Hi};function Yi(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}var qi=[new d.Vector2(-.541978,.840393),new d.Vector2(.125533,-.992089),new d.Vector2(.374329,.927296),new d.Vector2(-.105475,.994422)],Xi=d.UniformsUtils.merge([d.UniformsLib.fog,d.UniformsLib.lights,{diffuse:{value:new d.Color(15658734)},opacity:{value:1},specular:{type:"c",value:new d.Color(1118481)},shininess:{type:"f",value:30},fixedColor:{type:"c",value:new d.Color(16777215)},zOffset:{type:"f",value:0},zClipValue:{type:"f",value:0},clipPlaneValue:{type:"f",value:0},nearPlaneValue:{type:"f",value:-.5},invModelViewMatrix:{type:"4fv",value:new d.Matrix4},world2colorMatrix:{type:"4fv",value:new d.Matrix4},dashedLineSize:{type:"f",value:.1},dashedLinePeriod:{type:"f",value:.2},projMatrixInv:{type:"4fv",value:new d.Matrix4},viewport:{type:"v2",value:new d.Vector2},lineWidth:{type:"f",value:2},fogAlpha:{type:"f",value:1},samplesKernel:{type:"v2v",value:null},noiseTex:{type:"t",value:null},noiseTexelSize:{type:"v2",value:null},srcTexelSize:{type:"v2",value:null}}]),$i=["shininess","opacity","zOffset","diffuse","specular","fixedColor","zClipCoef","zClipValue","clipPlaneValue","world2colorMatrix","dashedLineSize","dashedLinePeriod","projMatrixInv","viewport","lineWidth","fogAlpha","samplesKernel","noiseTex","noiseTexelSize","srcTexelSize"];function Ki(e){d.RawShaderMaterial.call(this),this.fog=!0,this.instancedPos=!1,this.instancedMatrix=!1,this.attrColor=!1,this.attrColor2=!1,this.attrAlphaColor=!1,this.overrideColor=!1,this.sphereSprite=!1,this.cylinderSprite=!1,this.zClip=!1,this.clipPlane=!1,this.fakeOpacity=!1,this.prepassTransparancy=!1,this.colorFromPos=!1,this.shadowmap=!1,this.shadowmapType="random",this.colorFromDepth=!1,this.orthoCam=!1,this.dashedLine=!1,this.transparent=!0,this.thickLine=!1,this.fogTransparent=!1,this.normalsToGBuffer=!1,this.toonShading=!1,this.uberOptions=Object.create(Ki.prototype.uberOptions),d.RawShaderMaterial.prototype.setValues.call(this,{uniforms:d.UniformsUtils.clone(Xi),vertexShader:this.precisionString()+"float INSTANCED_SPRITE_OVERSCALE = 1.3;\n\nattribute vec3 normal;\n\n#ifdef NORMALS_TO_G_BUFFER\n  varying vec3 viewNormal;\n#endif\n#if !defined (SPHERE_SPRITE) && !defined (CYLINDER_SPRITE)\n  varying vec3 vNormal;\n#endif\n\n#ifdef THICK_LINE\n  attribute vec4 position; // W contains vert pos or neg offset\n#else\n  attribute vec3 position;\n#endif\n\nvarying vec3 vWorldPosition;\nvarying vec3 vViewPosition;\n\n#ifdef ATTR_ALPHA_COLOR\n  attribute float alphaColor;\n  varying float alphaCol;\n#endif\n\n#if defined(USE_LIGHTS) && defined(SHADOWMAP)\n\t#if NUM_DIR_LIGHTS > 0\n\t\tuniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHTS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHTS ];\n\t\tvarying vec3 vDirectionalShadowNormal[ NUM_DIR_LIGHTS ];\n\t#endif\n#endif\n\n#ifdef ATTR_COLOR\n  attribute vec3 color;\n  varying vec3 vColor;\n#endif\n\n#ifdef ATTR_COLOR2\n  attribute vec3 color2;\n  varying vec3 vColor2;\n  attribute vec2 uv;\n  #ifndef CYLINDER_SPRITE\n    varying vec2 vUv;\n  #endif\n#endif\n\n#ifdef INSTANCED_POS\n  attribute vec4 offset;\n  #ifdef SPHERE_SPRITE\n    varying vec4 instOffset;\n  varying vec4 spritePosEye;\n  #endif\n#endif\n\n#ifdef INSTANCED_MATRIX\n  attribute vec4 matVector1;\n  attribute vec4 matVector2;\n  attribute vec4 matVector3;\n  attribute vec4 invmatVector1;\n  attribute vec4 invmatVector2;\n  attribute vec4 invmatVector3;\n\n  #ifdef CYLINDER_SPRITE\n    varying vec4 matVec1;\n    varying vec4 matVec2;\n    varying vec4 matVec3;\n    varying vec4 invmatVec1;\n    varying vec4 invmatVec2;\n    varying vec4 invmatVec3;\n    varying vec4 spritePosEye;\n  #endif\n#endif\n\nuniform mat4 modelViewMatrix; // optional\nuniform mat4 projectionMatrix; // optional\nuniform mat3 normalMatrix; // optional\nuniform mat4 modelMatrix; // optional\n\n#ifdef DASHED_LINE\n  attribute float lineDistance;\n  varying float vLineDistance;\n#endif\n\n#ifdef THICK_LINE\n  attribute vec3 direction;\n  uniform mat4 projMatrixInv;\n  uniform vec2 viewport;\n  uniform float lineWidth;\n\n  vec4 transform(vec4 coord){\n    return projectionMatrix * modelViewMatrix * coord;\n  }\n\n  vec2 project(vec4 device){\n    vec3 device_normal = device.xyz/device.w;\n    vec2 clip_pos = (device_normal*0.5+0.5).xy;\n    return clip_pos * viewport;\n  }\n\n  vec4 unproject(vec2 screen, float z, float w){\n    vec2 clip_pos = screen/viewport;\n    vec2 device_normal = clip_pos*2.0-1.0;\n    return vec4(device_normal*w, z, w);\n  }\n#endif\n\n\n/////////////////////////////////////////// Main ///////////////////////////////////////////////\nvoid main() {\n\n#ifdef ATTR_ALPHA_COLOR\n  alphaCol = alphaColor;\n#endif\n\n#ifdef INSTANCED_MATRIX\n  vec3 objectNormal = vec3(\n    dot(normal, matVector1.xyz),\n    dot(normal, matVector2.xyz),\n    dot(normal, matVector3.xyz));\n#else\n  vec3 objectNormal = vec3( normal );\n#endif\n\nvec3 transformedNormal = normalMatrix * objectNormal;\n\n#if !defined (SPHERE_SPRITE) && !defined (CYLINDER_SPRITE)\n  vNormal = normalize(transformedNormal);\n#endif\n\n#ifdef NORMALS_TO_G_BUFFER\n  viewNormal = normalize(mat3(modelViewMatrix)*objectNormal);\n#endif\n\n  vec4 localPos = vec4(position.xyz, 1.0);\n  vec4 worldPos = modelMatrix * localPos;\n  vec4 mvPosition = modelViewMatrix * localPos;\n\n// make thick line offset\n#ifdef THICK_LINE\n   // get screen pos\n   vec4 dPos = transform(vec4(position.xyz, 1.0));\n   vec2 sPos = project(dPos);\n   // move pos forward\n   vec3 position2 = position.xyz + direction.xyz * 0.5;\n   // get screen offset pos\n   vec4 dPos2 = transform(vec4(position2.xyz, 1.0));\n   vec2 sPos2 = project(dPos2);\n   // screen line direction\n   vec2 sDir = normalize(sPos2 - sPos);\n   // vertex offset (orthogonal to line direction)\n   vec2 offset1 = vec2(-sDir.y, sDir.x);\n   // move screen vertex\n   vec2 newPos = sPos + offset1 * position.w * lineWidth;\n   // get moved pos in view space\n   vec4 dNewPos =  unproject(newPos, dPos.z, dPos.w);\n   mvPosition.xyz = (projMatrixInv * dNewPos).xyz;\n#endif // THICK_LINE\n\n#ifdef INSTANCED_POS\n  #ifdef SPHERE_SPRITE\n    instOffset = offset;\n\n    vec4 posEye = modelViewMatrix * vec4( offset.xyz, 1.0 );\n    float scale = length(modelViewMatrix[0]);\n    mvPosition = posEye + vec4( position.xyz * offset.w * scale * INSTANCED_SPRITE_OVERSCALE, 0.0 );\n    posEye.w = offset.w * scale;\n\n    spritePosEye = posEye;\n #else\n    localPos = vec4( offset.xyz + position.xyz * offset.w, 1.0 );\n    worldPos = modelMatrix * localPos;\n    mvPosition = modelViewMatrix * localPos;\n  #endif\n#endif\n\n#ifdef INSTANCED_MATRIX\n  #ifdef CYLINDER_SPRITE\n    matVec1 = matVector1;\n    matVec2 = matVector2;\n    matVec3 = matVector3;\n    invmatVec1 = invmatVector1;\n    invmatVec2 = invmatVector2;\n    invmatVec3 = invmatVector3;\n\n    // calculate eye coords of cylinder endpoints\n    vec4 v = vec4(0, -0.5, 0, 1);\n    vec4 p1 = modelViewMatrix * vec4(dot(v, matVector1), dot(v, matVector2), dot(v, matVector3), 1.0);\n    v.y = 0.5;\n    vec4 p2 = modelViewMatrix * vec4(dot(v, matVector1), dot(v, matVector2), dot(v, matVector3), 1.0);\n\n    // sprite is placed at the center of cylinder\n    vec4 posEye;\n    posEye.xyz = mix(p1.xyz, p2.xyz, 0.5);\n    posEye.w = 1.0;\n    spritePosEye = posEye;\n\n    // cylinder radius in eye space\n    float rad = length(modelViewMatrix[0]) * length(vec3(matVector1.x, matVector2.x, matVector3.x));\n    vec2 spriteSize;\n    #ifdef ORTHOGRAPHIC_CAMERA\n      // In ortho projection we skip z coordinate\n      // basic sprite size at screen plane (covers only cylinder axis)\n      vec2 spriteSizeScreen = abs(p2.xy - p1.xy);\n\n      spriteSize = vec2(1.0, 1.0) * INSTANCED_SPRITE_OVERSCALE * (spriteSizeScreen + 2.0 * rad);\n    #else\n      // basic sprite size at screen plane (covers only cylinder axis)\n      vec2 spriteSizeScreen = abs(p2.xy / p2.z - p1.xy / p1.z);\n\n      // full sprite size in eye coords\n      float minZ = min(abs(p1.z), abs(p2.z));\n      spriteSize = vec2(1.0, 1.0) * INSTANCED_SPRITE_OVERSCALE * abs(posEye.z) * (spriteSizeScreen + 2.0 * rad / minZ);\n    #endif\n\n    mvPosition = posEye + vec4( position.xy * 0.5 * spriteSize, 0, 0 );\n  #else\n    localPos = vec4(dot(localPos, matVector1), dot(localPos, matVector2), dot(localPos, matVector3), 1.0);\n    worldPos = modelMatrix * localPos;\n    mvPosition = modelViewMatrix * localPos;\n  #endif\n#endif\n\n  gl_Position = projectionMatrix * mvPosition;\n\n  vWorldPosition = worldPos.xyz;\n  vViewPosition = - mvPosition.xyz;\n\n#if defined(USE_LIGHTS) && defined(SHADOWMAP)\n\t#if NUM_DIR_LIGHTS > 0\n\t  vec4 worldPosition;\n\t  // see THREE.WebGLProgram.unrollLoops\n\t  #pragma unroll_loop_start\n\t  for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n      vDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * vec4(vWorldPosition, 1.0);\n      vDirectionalShadowNormal[ i ] = (directionalShadowMatrix[ i ] * (modelMatrix * vec4(objectNormal, 0.0))).xyz;\n\t  }\n\t  #pragma unroll_loop_end\n\t#endif\n#endif\n\n#ifdef ATTR_COLOR\n  vColor = color.xyz;\n#endif\n\n#ifdef ATTR_COLOR2\n  vColor2 = color2;\n  #ifndef CYLINDER_SPRITE\n    vUv = uv;\n  #endif\n#endif\n\n#ifdef DASHED_LINE\n  vLineDistance = lineDistance;\n#endif\n}\n",fragmentShader:this.precisionString()+"#if defined (NORMALS_TO_G_BUFFER)\n  #define fragColor gl_FragData[0]\n#else\n  #define fragColor gl_FragColor\n#endif\n\n#ifdef ATTR_ALPHA_COLOR\n  varying float alphaCol;\n#endif\n\n#ifdef COLOR_FROM_POS\n  uniform mat4 world2colorMatrix;\n#endif\n\n#if defined(USE_LIGHTS) && defined(SHADOWMAP)\n\t#if NUM_DIR_LIGHTS > 0\n\t\tuniform sampler2D directionalShadowMap[ NUM_DIR_LIGHTS ];\n    uniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHTS ]; //only for sprites\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHTS ];\n\t\tvarying vec3 vDirectionalShadowNormal[ NUM_DIR_LIGHTS ];\n    vec4 vDirLightWorldCoord[ NUM_DIR_LIGHTS ];\n    vec3 vDirLightWorldNormal[ NUM_DIR_LIGHTS ];\n\n    #ifdef SHADOWMAP_PCF_RAND\n      // We use 4 instead uniform variable or define because this value is used in for(... i < value; ...) with\n      // unroll_loop and unroll_loop has pattern:\n      // /#pragma unroll_loop[\\s]+?for \\( int i \\= (\\d+)\\; i < (\\d+)\\; i \\+\\+ \\) \\{([\\s\\S]+?)(?=\\})\\}/g\n      uniform vec2 samplesKernel[4]; // 4 is length of _samplesKernel which is defined in UberMaterial.js\n      uniform sampler2D noiseTex;\n      uniform vec2 noiseTexelSize;\n      uniform vec2 srcTexelSize;\n      uniform mat4 projectionMatrix;\n    #endif\n\t#endif\n#endif\n\n#ifdef ATTR_COLOR\n  varying vec3 vColor;\n#endif\n\n#ifdef ATTR_COLOR2\n  varying vec3 vColor2;\n  #ifndef CYLINDER_SPRITE\n    varying vec2 vUv;\n  #endif\n#endif\n\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;\nuniform vec3 fixedColor;\nuniform float opacity;\nuniform float zClipValue;\nuniform float clipPlaneValue;\n\n#ifdef NORMALS_TO_G_BUFFER\n  varying vec3 viewNormal;\n#endif\n\n#define PI 3.14159265359\n#define RECIPROCAL_PI 0.31830988618\n#define saturate(a) clamp( a, 0.0, 1.0 )\n\n#ifdef USE_FOG\n  uniform vec3 fogColor;\n  uniform float fogAlpha;\n  uniform float fogNear;\n  uniform float fogFar;\n#endif\n\nvarying vec3 vWorldPosition; // world position of the pixel (invalid when INSTANCED_SPRITE is defined)\nvarying vec3 vViewPosition;\n\n#if !defined (SPHERE_SPRITE) && !defined (CYLINDER_SPRITE)\n  varying vec3 vNormal;\n#endif\n\n/////////////////////////////////////////// ZSprites ////////////////////////////////////////////////\n#if defined (SPHERE_SPRITE) || defined (CYLINDER_SPRITE)\n  uniform float nearPlaneValue;\n#endif\n\n#ifdef SPHERE_SPRITE\n  varying vec4 spritePosEye;\n#endif\n\n#if defined(SPHERE_SPRITE) || defined(CYLINDER_SPRITE)\n  uniform float zOffset;\n\n  #if !defined(USE_LIGHTS) || !defined(SHADOWMAP) || !defined(SHADOWMAP_PCF_RAND) || !(NUM_DIR_LIGHTS > 0)\n    uniform mat4 projectionMatrix;\n  #endif\n\n  float calcDepthForSprites(vec4 pixelPosEye, float zOffset, mat4 projMatrix) {\n    vec4 pixelPosScreen = projMatrix * pixelPosEye;\n    return 0.5 * (pixelPosScreen.z / pixelPosScreen.w + 1.0) + zOffset;\n  }\n#endif\n\n#ifdef SPHERE_SPRITE\n  varying vec4 instOffset;\n  uniform mat4 modelMatrix;\n  uniform mat4 modelViewMatrix;\n  uniform mat4 invModelViewMatrix;\n  uniform mat3 normalMatrix;\n\n\n  bool intersect_ray_sphere(in vec3 origin, in vec3 ray, out vec3 point, out float frontFaced) {\n\n    // intersect XZ-projected ray with circle\n    float a = dot(ray, ray);\n    float b = dot(ray, origin);\n    float c = dot(origin, origin) - 1.0;\n    float det = b * b - a * c;\n    if (det < 0.0) return false;\n    float t1 = (-b - sqrt(det)) / a;\n    float t2 = (-b + sqrt(det)) / a;\n\n    // calculate both intersection points\n    vec3 p1 = origin + ray * t1;\n    vec3 p2 = origin + ray * t2;\n\n    // choose nearest point inside frustum\n    #ifdef ORTHOGRAPHIC_CAMERA\n      // orthografic camera is used for dirLight sources. So in it for all spheres the point with smaller 't' is visible\n      // t1 is always smaller than t2 (from calculations)\n      point = p1;\n      frontFaced = 1.0;\n      return true;\n    #else\n      // for perspective camera first intersection can be in front of near plane. If not intersection is p1 else - p2\n      // t* = 0.0 corresponds to point of intersection near plane by the ray from camera to curPixel\n      if (t1 >= 0.0) {\n        point = p1;\n        frontFaced = 1.0;\n        return true;\n      }\n      if (t2 >= 0.0) {\n        point = p2;\n        frontFaced = -1.0;\n        return true;\n      }\n    #endif\n\n    return false;\n  }\n\n  bool get_sphere_point(in vec3 pixelPosEye, out vec3 point, out float frontFaced) {\n    vec3 origin, ray;\n\n    #ifdef ORTHOGRAPHIC_CAMERA\n      // transform vector from sprite center to curPixel into sphere local coords\n      origin = pixelPosEye.xyz - spritePosEye.xyz;\n      origin = (invModelViewMatrix * vec4(origin, 0.0)).xyz / instOffset.w;\n\n      // transform camera orientation vector into sphere local coords\n      ray = (invModelViewMatrix * vec4(0.0, 0.0, -1.0, 0.0)).xyz;\n    #else\n      // find point of intersection near plane by the ray from camera to curPixel\n      vec4 v = vec4(-(nearPlaneValue / pixelPosEye.z) * pixelPosEye, 1.0);\n\n      // transform intersection point into sphere local coords\n      v = invModelViewMatrix * v;\n      origin = (v.xyz - instOffset.xyz) / instOffset.w;\n\n      // transform vector from camera pos to curPixel into sphere local coords\n      ray = (invModelViewMatrix * vec4(pixelPosEye, 0.0)).xyz;\n    #endif\n    ray = normalize(ray);\n\n    return intersect_ray_sphere(origin, ray, point, frontFaced);\n  }\n#endif\n\n#ifdef CYLINDER_SPRITE\n  varying vec4 matVec1;\n  varying vec4 matVec2;\n  varying vec4 matVec3;\n  varying vec4 invmatVec1;\n  varying vec4 invmatVec2;\n  varying vec4 invmatVec3;\n\n  uniform mat4 modelMatrix;\n  uniform mat4 modelViewMatrix;\n  uniform mat4 invModelViewMatrix;\n  uniform mat3 normalMatrix;\n\n  varying vec4 spritePosEye;\n\n  bool intersect_ray_cylinder(in vec3 origin, in vec3 ray, out vec3 point, out float frontFaced) {\n\n    // intersect XZ-projected ray with circle\n    float a = dot(ray.xz, ray.xz);\n    float b = dot(ray.xz, origin.xz);\n    float c = dot(origin.xz, origin.xz) - 1.0;\n    float det = b * b - a * c;\n    if (det < 0.0) return false;\n    float t1 = (-b - sqrt(det)) / a;\n    float t2 = (-b + sqrt(det)) / a;\n\n    // calculate both intersection points\n    vec3 p1 = origin + ray * t1;\n    vec3 p2 = origin + ray * t2;\n\n    float halfHeight = 0.5;\n\n    // choose nearest point\n    #ifdef ORTHOGRAPHIC_CAMERA\n      // orthografic camera is used for dirLight sources. So in it for all cylinders the point with smaller 't' is visible\n      // if it is not outside of cylinnder (t1 is always smaller than t2).\n      if (p1.y >= -halfHeight && p1.y <= halfHeight) {\n        point = p1;\n        frontFaced = 1.0;\n        return true;\n      }\n      if (p2.y >= -halfHeight && p2.y <= halfHeight) {\n        point = p2;\n        frontFaced = -1.0;\n        return true;\n      }\n    #else\n      // for perspective camera first intersection can be in front of near plane. If not intersection is p1 else - p2\n      // t* = 0.0 corresponds to point of intersection near plane by the ray from camera to curPixel\n      if (t1 >= 0.0 && p1.y >= -halfHeight && p1.y <= halfHeight) {\n        point = p1;\n        frontFaced = 1.0;\n        return true;\n      }\n      if (t2 >= 0.0 && p2.y >= -halfHeight && p2.y <= halfHeight) {\n        point = p2;\n        frontFaced = -1.0;\n        return true;\n      }\n    #endif\n\n    return false;\n  }\n\n  bool get_cylinder_point(in vec3 pixelPosEye, out vec3 point, out float frontFaced) {\n    vec3 origin, ray;\n    vec4 v;\n\n    #ifdef ORTHOGRAPHIC_CAMERA\n      // transform vector from sprite center to curPixel into cylinder local coords\n      v = invModelViewMatrix * vec4(pixelPosEye.xyz - spritePosEye.xyz, 0.0);\n      origin = vec3(dot(v, invmatVec1), dot(v, invmatVec2), dot(v, invmatVec3));\n\n      // transform camera orientation vector into cylinder local coords\n      v = invModelViewMatrix * vec4(0.0, 0.0, -1.0, 0.0);\n      ray = vec3(dot(v, invmatVec1), dot(v, invmatVec2), dot(v, invmatVec3));\n    #else\n      // find point of intersection near plane by the ray from camera to curPixel\n      v = vec4(-(nearPlaneValue / pixelPosEye.z) * pixelPosEye, 1.0);\n\n      // transform intersection point into cylinder local coords\n      v = invModelViewMatrix * v;\n      origin = vec3(dot(v, invmatVec1), dot(v, invmatVec2), dot(v, invmatVec3));\n\n      // transform vector from camera pos to curPixel into cylinder local coords\n      v = invModelViewMatrix * vec4(pixelPosEye, 0.0);\n      ray = vec3(dot(v, invmatVec1), dot(v, invmatVec2), dot(v, invmatVec3));\n    #endif\n    ray = normalize(ray);\n\n    return intersect_ray_cylinder(origin, ray, point, frontFaced);\n  }\n#endif\n\n///////////////////////////////////// Pack and unpack ///////////////////////////////////////////////\nconst float PackUpscale = 256. / 255.; // fraction -> 0..1 (including 1)\nconst float UnpackDownscale = 255. / 256.; // 0..1 -> fraction (excluding 1)\n\nconst vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );\nconst vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\n\n\nconst float ShiftRight8 = 1. / 256.;\n\nvec4 packDepthToRGBA( const in float v ) {\n  vec4 r = vec4( fract( v * PackFactors ), v );\n  r.yzw -= r.xyz * ShiftRight8; // tidy overflow\n  return r * PackUpscale;\n}\n\nfloat unpackRGBAToDepth( const in vec4 v ) {\n  return dot( v, UnpackFactors );\n}\n\n////////////////////////////////////////// All Lighting /////////////////////////////////////////////////\n#ifdef TOON_SHADING\n  #define LOW_TOON_BORDER 0.0\n  #define MEDIUM_TOON_BORDER 0.7\n  #define HIGH_TOON_BORDER 1.0\n\n  #define MEDIUM_TOON_RANGE 0.5\n  #define HIGH_TOON_RANGE 0.95\n#endif\n#if defined(USE_LIGHTS) && NUM_DIR_LIGHTS > 0\n  struct ReflectedLight {\n    vec3 directDiffuse;\n    vec3 directSpecular;\n    vec3 indirectDiffuse;\n  };\n\n  struct BlinnPhongMaterial {\n    vec3  diffuseColor;\n    vec3  specularColor;\n    float specularShininess;\n  };\n\n  struct GeometricContext {\n    vec3 normal;\n    vec3 viewDir;\n  };\n\n  struct DirectionalLight {\n    vec3 direction;\n    vec3 color;\n  };\n  uniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];\n\n  struct DirectionalLightShadow {\n     vec2 shadowMapSize;\n     float shadowBias;\n     float shadowRadius;\n   };\n  uniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHTS ];\n\n  uniform vec3 ambientLightColor;\n\n  /////////////////////////////////////////// Shadowmap ////////////////////////////////////////////////\n\n  #if defined(SHADOWMAP)\n  \tfloat texture2DCompare( sampler2D depths, vec2 uv, float compare ) {\n  \t\treturn step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );\n  \t}\n\n    float getShadow( sampler2D shadowMap, DirectionalLightShadow dirLight, vec4 shadowCoord, vec3 vViewPosition, vec3 vNormal ) {\n   \t  float shadow = 0.0;\n\n      // When shadows for sprites will appear use here for them normals as it done for G-buffer\n      shadowCoord.xyz += dirLight.shadowBias * vNormal;\n      shadowCoord.xyz /= shadowCoord.w;\n\n      bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );\n      bool inFrustum = all( inFrustumVec );\n      bvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );\n      bool frustumTest = all( frustumTestVec );\n\n      if ( frustumTest ) {\n        #ifdef SHADOWMAP_BASIC\n      \t  shadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );\n      \t#endif\n\n      \t#ifdef SHADOWMAP_PCF_SHARP\n      \t  vec2 texelSize = vec2( 1.0 ) / dirLight.shadowMapSize;\n\n            float dx0 = - texelSize.x * dirLight.shadowRadius;\n            float dy0 = - texelSize.y * dirLight.shadowRadius;\n            float dx1 = + texelSize.x * dirLight.shadowRadius;\n            float dy1 = + texelSize.y * dirLight.shadowRadius;\n\n            shadow = (\n            \ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n            \ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n            \ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n            \ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n            \ttexture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +\n            \ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n            \ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n            \ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n            \ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n            ) * ( 1.0 / 9.0 );\n        #endif\n\n        #ifdef SHADOWMAP_PCF_RAND\n          vec2 texelSize = vec2( 1.0 ) / dirLight.shadowMapSize;\n\n          vec4 vUv = ((projectionMatrix * vec4(vViewPosition, 1.0)) + 1.0) / 2.0;\n          vec2 vUvNoise = vUv.xy / srcTexelSize * noiseTexelSize;\n\n          vec2 noiseVec = normalize(texture2D(noiseTex, vUvNoise).rg);\n          mat2 mNoise = mat2(noiseVec.x, noiseVec.y, -noiseVec.y, noiseVec.x);\n\n          vec2 offset;\n          #pragma unroll_loop_start\n          for ( int i = 0; i < 4; i ++ ) { // 4 is length of _samplesKernel which is defined in UberMaterial.js\n            offset = mNoise * ( normalize( samplesKernel[ i ]) * texelSize * dirLight.shadowRadius );\n            shadow +=  texture2DCompare( shadowMap, shadowCoord.xy + offset, shadowCoord.z );\n          }\n          #pragma unroll_loop_end\n          shadow /= float( 4 ); // 4 is length of _samplesKernel which is defined in UberMaterial.js\n        #endif\n      }\n      return shadow;//(shadow != 1.0) ? 0.5 : 1.0;//vec4(shadow, shadow, shadow, 1.0);\n   }\n  #endif\n\n  /////////////////////////////////////////// Lighting /////////////////////////////////////////////////\n\n  vec3 BRDF_Diffuse_Lambert( const in vec3 diffuseColor ) {\n    return RECIPROCAL_PI * diffuseColor;\n  } // validated\n\n  vec3 F_Schlick( const in vec3 specularColor, const in float dotLH ) {\n    // Original approximation by Christophe Schlick '94\n    //;float fresnel = pow( 1.0 - dotLH, 5.0 );\n    // Optimized variant (presented by Epic at SIGGRAPH '13)\n    float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );\n    return ( 1.0 - specularColor ) * fresnel + specularColor;\n  } // validated\n\n  float G_BlinnPhong_Implicit( /* const in float dotNL, const in float dotNV */ ) {\n    // geometry term is (n dot l)(n dot v) / 4(n dot l)(n dot v)\n    return 0.25;\n  }\n\n  float D_BlinnPhong( const in float shininess, const in float dotNH ) {\n    return RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );\n  }\n\n  vec3 BRDF_Specular_BlinnPhong( const in DirectionalLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float shininess ) {\n    vec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );\n    float dotNH = saturate(dot( geometry.normal, halfDir ));\n    float dotLH = saturate(dot( incidentLight.direction, halfDir ));\n\n    vec3 F = F_Schlick( specularColor, dotLH );\n    float G = G_BlinnPhong_Implicit( /* dotNL, dotNV */ );\n    float D = D_BlinnPhong( shininess, dotNH );\n\n    return F * ( G * D );\n  } // validated\n\n  void RE_Direct_BlinnPhong( const in DirectionalLight directLight, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight, float penumbra ) {\n\n    float dotNL = saturate( dot( geometry.normal, directLight.direction ));\n    #ifdef TOON_SHADING\n      if(dotNL < MEDIUM_TOON_RANGE){\n        dotNL = LOW_TOON_BORDER;\n      }\n      else if(dotNL < HIGH_TOON_RANGE){\n        dotNL = MEDIUM_TOON_BORDER;\n      }\n      else{\n        dotNL = HIGH_TOON_BORDER;\n      }\n    #endif\n\n    vec3 irradiance = dotNL * directLight.color * PI;\n    reflectedLight.directDiffuse += penumbra * irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n    reflectedLight.directSpecular += penumbra * irradiance * BRDF_Specular_BlinnPhong( directLight, geometry, material.specularColor, material.specularShininess );\n  }\n\n  void RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n    reflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n  }\n\n  vec3 calcLighting(const in GeometricContext geometry, const in BlinnPhongMaterial material, vec3 vViewPosition) {\n    ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ));\n    vec3 irradiance = ambientLightColor * PI;\n\n    float shadowMask = 1.0;\n    // see THREE.WebGLProgram.unrollLoops\n  \t#pragma unroll_loop_start\n  \t  for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n  \t    #ifdef SHADOWMAP\n  \t      shadowMask = getShadow( directionalShadowMap[ i ], directionalLightShadows[ i ], vDirLightWorldCoord[ i ], vViewPosition, vDirLightWorldNormal[ i ] );\n        #endif\n\n  \t\t  if ( shadowMask > 0.0 ) RE_Direct_BlinnPhong( directionalLights[ i ], geometry, material, reflectedLight, shadowMask );\n  \t\t}\n  \t\t#pragma unroll_loop_end\n\n    RE_IndirectDiffuse_BlinnPhong(irradiance, material, reflectedLight);\n\n    return saturate(reflectedLight.indirectDiffuse + reflectedLight.directDiffuse + reflectedLight.directSpecular);\n  }\n#endif\n\n/////////////////////////////////////////// Dashed Line ///////////////////////////////////////////////\n#ifdef DASHED_LINE\n  uniform float dashedLineSize;\n  uniform float dashedLinePeriod;\n  varying float vLineDistance;\n#endif\n\n/////////////////////////////////////////// Main ///////////////////////////////////////////////\nvoid main() {\n\n#ifdef CLIP_PLANE\n  if (vViewPosition.z < clipPlaneValue) discard;\n#endif\n\n#ifdef ZCLIP\n  if (vViewPosition.z < zClipValue) discard;\n#endif\n\n#if defined(USE_LIGHTS) && defined(SHADOWMAP)\n  #if NUM_DIR_LIGHTS > 0\n    // see THREE.WebGLProgram.unrollLoops\n    #pragma unroll_loop_start\n    for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n      vDirLightWorldCoord[ i ] = vDirectionalShadowCoord[ i ];\n      vDirLightWorldNormal[ i ] = vDirectionalShadowNormal[ i ];\n    }\n    #pragma unroll_loop_end\n  #endif\n#endif\n\n  vec4 pixelPosWorld = vec4(vWorldPosition, 1.0);\n  vec4 pixelPosEye;\n\n#ifdef SPHERE_SPRITE\n\n  vec3 viewNormalSprites;\n  float frontFaced = 1.0;\n  vec3 normal;\n\n/* quick-and-dirty method\n  normal.xy = ' + INSTANCED_SPRITE_OVERSCALE + ' * (2.0 * vUv - 1.0);\n  float r2 = dot(normal.xy, normal.xy);\n  if (r2 > 1.0) discard;\n  float normalZ = sqrt(1.0 - r2);\n  normal.z = normalZ;\n  normal = normal * ( -1.0 + 2.0 * float( gl_FrontFacing ) );\n  pixelPosEye = vec4(spritePosEye.xyz, 1.0);\n  pixelPosEye.z += spritePosEye.w * normalZ;\n*/\n\n  // ray-trace sphere surface\n  {\n    vec3 p;\n    if (!get_sphere_point(-vViewPosition, p, frontFaced)) discard;\n    vec4 v = vec4(instOffset.xyz + p * instOffset.w, 1.0);\n    pixelPosWorld = modelMatrix * v;\n    pixelPosEye = modelViewMatrix * v;\n    normal = normalize(normalMatrix * p);\n    #ifdef NORMALS_TO_G_BUFFER\n      viewNormalSprites = normalize(mat3(modelViewMatrix)*p);\n    #endif\n\n    #if defined(USE_LIGHTS) && defined(SHADOWMAP)\n      #if NUM_DIR_LIGHTS > 0\n        // see THREE.WebGLProgram.unrollLoops\n        #pragma unroll_loop_start\n          for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n            vDirLightWorldCoord[ i ] = directionalShadowMatrix[ i ] * pixelPosWorld;\n            vDirLightWorldNormal[ i ] = (directionalShadowMatrix[ i ] * (modelMatrix * vec4(p, 0.0))).xyz;\n          }\n        #pragma unroll_loop_end\n      #endif\n    #endif\n  }\n#endif\n\n#ifdef CYLINDER_SPRITE\n  vec3 normal;\n  vec3 viewNormalSprites;\n  float frontFaced = 1.0;\n  float cylinderY = 0.0;\n\n  // ray-trace cylinder surface\n  {\n    vec3 p;\n    if (!get_cylinder_point(-vViewPosition, p, frontFaced)) discard;\n\n    cylinderY = 0.5 * (p.y + 1.0);\n\n    vec4 v = vec4(p, 1.0);\n    v = vec4(dot(v, matVec1), dot(v, matVec2), dot(v, matVec3), 1.0);\n    pixelPosWorld = modelMatrix * v;\n    pixelPosEye = modelViewMatrix * v;\n\n    vec3 localNormal = normalize(vec3(p.x, 0.0, p.z));\n    normal = vec3(\n      dot(localNormal, matVec1.xyz),\n      dot(localNormal, matVec2.xyz),\n      dot(localNormal, matVec3.xyz));\n    #ifdef NORMALS_TO_G_BUFFER\n      viewNormalSprites = normalize(mat3(modelViewMatrix)*normal);\n    #endif\n\n    #if defined(USE_LIGHTS) && defined(SHADOWMAP)\n      #if NUM_DIR_LIGHTS > 0\n        // see THREE.WebGLProgram.unrollLoops\n        #pragma unroll_loop_start\n          for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n            vDirLightWorldCoord[ i ] = directionalShadowMatrix[ i ] * pixelPosWorld;\n            vDirLightWorldNormal[ i ] = (directionalShadowMatrix[ i ] * (modelMatrix * vec4(normal, 0.0))).xyz;\n          }\n        #pragma unroll_loop_end\n      #endif\n    #endif\n\n    normal = normalize(normalMatrix * normal);\n  }\n#endif\n\n  #ifdef ATTR_COLOR\n    vec3 vertexColor = vColor;\n  #else\n    vec3 vertexColor = vec3(1.0, 1.0, 1.0);\n  #endif\n\n  #ifdef ATTR_COLOR2\n    #ifdef CYLINDER_SPRITE\n      float colorCoef = cylinderY; // cylinder parameter is calculated from ray-tracing\n    #else\n      float colorCoef = vUv.y; // cylinder parameter is interpolated as tex coord\n    #endif\n      // choose either color or color2\n    vertexColor = mix(vColor2, vColor, step(0.5, colorCoef));\n  #endif\n\n  // negative red component is a special condition\n  if (vertexColor.x < 0.0) discard;\n\n  #ifdef DASHED_LINE\n    if ( mod( vLineDistance, dashedLinePeriod ) > dashedLineSize ) discard;\n  #endif\n\n  // transparency prepass writes only z, so we don't need to calc the color\n  #ifdef PREPASS_TRANSP\n    fragColor = vec4(1.0, 1.0, 1.0, 1.0);\n    #if defined(SPHERE_SPRITE) || defined(CYLINDER_SPRITE)\n      gl_FragDepthEXT = calcDepthForSprites(pixelPosEye, zOffset, projectionMatrix);\n    #endif\n    return;\n  #endif\n\n    float totalOpacity = opacity;\n\n  #ifdef ATTR_ALPHA_COLOR\n    totalOpacity *= alphaCol;\n  #endif\n\n  // discard fully transparent pixels\n  if (totalOpacity == 0.0) discard;\n\n  #ifdef FAKE_OPACITY\n    // discard pixels in checker pattern\n    vec2 dm_coord = floor(gl_FragCoord.xy);\n    dm_coord = fract(dm_coord * 0.5);\n    if (totalOpacity < 1.0 && (dm_coord.x < 0.5 ^^ dm_coord.y < 0.5)) discard;\n    vec4 diffuseColor = vec4(diffuse, 1.0);\n  #else\n    vec4 diffuseColor = vec4(diffuse, totalOpacity);\n  #endif\n\n  float flipNormal;\n  #if !defined (SPHERE_SPRITE) && !defined (CYLINDER_SPRITE)\n    flipNormal = 1.0;\n    #ifdef DOUBLE_SIDED\n      flipNormal = float( gl_FrontFacing );\n    #endif\n    vec3 normal = normalize( vNormal ) * flipNormal;\n  #endif\n\n    diffuseColor.rgb *= vertexColor;\n\n  #if defined(SPHERE_SPRITE) || defined(CYLINDER_SPRITE)\n    gl_FragDepthEXT = calcDepthForSprites(pixelPosEye, zOffset, projectionMatrix);\n  #endif\n\n  #ifdef NORMALS_TO_G_BUFFER\n    #if defined (SPHERE_SPRITE) || defined (CYLINDER_SPRITE)\n      vec3 viewNormaInColor = viewNormalSprites;\n    #else\n      vec3 viewNormaInColor = viewNormal;\n      float frontFaced = float( gl_FrontFacing );\n    #endif\n    // [-1, 1] -> [0, 1]\n    viewNormaInColor = 0.5 * viewNormaInColor + 0.5;\n    gl_FragData[1] = vec4(viewNormaInColor, frontFaced);\n  #endif\n\n  #if defined(USE_LIGHTS) && NUM_DIR_LIGHTS > 0\n    vec3 viewDir;\n    #if defined(SPHERE_SPRITE) || defined(CYLINDER_SPRITE)\n      viewDir = -pixelPosEye.xyz;\n    #else\n      viewDir = vViewPosition;\n    #endif\n    GeometricContext geometry = GeometricContext(normal, normalize( viewDir ));\n    BlinnPhongMaterial material = BlinnPhongMaterial(diffuseColor.rgb, specular, shininess);\n    vec3 outgoingLight = calcLighting(geometry, material, viewDir);\n  #else\n    vec3 outgoingLight = diffuseColor.rgb;\n  #endif\n\n  #ifdef COLOR_FROM_DEPTH\n    float depth = 0.0;\n    #if defined(SPHERE_SPRITE) || defined(CYLINDER_SPRITE)\n      gl_FragDepthEXT = calcDepthForSprites(pixelPosEye, zOffset, projectionMatrix);\n      depth = gl_FragDepthEXT;\n    #else\n      depth = gl_FragCoord.z;\n    #endif\n    fragColor = packDepthToRGBA(depth);\n    return;\n  #endif\n\n  #ifdef COLOR_FROM_POS\n    fragColor = world2colorMatrix * pixelPosWorld;\n  #else\n    #ifdef OVERRIDE_COLOR\n      fragColor = vec4(fixedColor, diffuseColor.a);\n    #else\n      fragColor = vec4(outgoingLight, diffuseColor.a);//vec4(vNormal, 1.0);\n    #endif\n\n    #ifdef USE_FOG\n      float viewDistance;\n      #if defined(SPHERE_SPRITE) || defined(CYLINDER_SPRITE)\n        viewDistance = abs(pixelPosEye.z);\n      #else\n        viewDistance = vViewPosition.z;\n      #endif\n      float fogFactor = smoothstep( fogNear, fogFar, viewDistance) * fogAlpha;\n      #ifdef FOG_TRANSPARENT\n        fragColor.a = fragColor.a * (1.0 - fogFactor);\n      #else\n        fragColor.rgb = mix( fragColor.rgb, fogColor, fogFactor );\n      #endif\n    #endif\n\n  #endif\n}\n",lights:!0,fog:!0,side:d.DoubleSide}),this.setValues(e)}Ki.prototype=Object.create(d.RawShaderMaterial.prototype),Ki.prototype.constructor=Ki,Ki.prototype.precisionString=function(){var e=Vi.precision;return"precision ".concat(e," float;\n")+"precision ".concat(e," int;\n\n")},Ki.prototype.uberOptions={diffuse:new d.Color(16777215),specular:new d.Color(1118481),shininess:30,opacity:1,fixedColor:new d.Color(16777215),zOffset:0,zClipCoef:2,zClipValue:0,clipPlaneValue:0,world2colorMatrix:new d.Matrix4,dashedLineSize:.1,dashedLinePeriod:.3,projMatrixInv:new d.Matrix4,viewport:new d.Vector2(800,600),lineWidth:2,fogAlpha:1,samplesKernel:qi,noiseTex:Wi.noiseTexture,noiseTexelSize:new d.Vector2(1/Wi.noiseWidth,1/Wi.noiseHeight),srcTexelSize:new d.Vector2(1/800,1/600),copy:function(e){this.diffuse.copy(e.diffuse),this.specular.copy(e.specular),this.shininess=e.shininess,this.opacity=e.opacity,this.fixedColor.copy(e.fixedColor),this.zOffset=e.zOffset,this.zClipCoef=e.zClipCoef,this.zClipValue=e.zClipValue,this.clipPlaneValue=e.clipPlaneValue,this.world2colorMatrix.copy(e.world2colorMatrix),this.dashedLineSize=e.dashedLineSize,this.dashedLinePeriod=e.dashedLinePeriod,this.projMatrixInv=e.projMatrixInv,this.viewport=e.viewport,this.lineWidth=e.lineWidth,this.toonShading=e.toonShading,this.fogAlpha=e.fogAlpha,this.samplesKernel=e.samplesKernel,this.noiseTex=e.noiseTex,this.noiseTexelSize=e.noiseTexelSize,this.srcTexelSize=e.srcTexelSize}},Ki.prototype.copy=function(e){return d.RawShaderMaterial.prototype.copy.call(this,e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=d.UniformsUtils.clone(e.uniforms),this.defines=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Yi(Object(n),!0).forEach((function(t){Re()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Yi(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},e.defines),this.extensions=e.extensions,this.fog=e.fog,this.instancedPos=e.instancedPos,this.instancedMatrix=e.instancedMatrix,this.attrColor=e.attrColor,this.attrColor2=e.attrColor2,this.attrAlphaColor=e.attrAlphaColor,this.overrideColor=e.overrideColor,this.sphereSprite=e.sphereSprite,this.cylinderSprite=e.cylinderSprite,this.zClip=e.zClip,this.clipPlane=e.clipPlane,this.fakeOpacity=e.fakeOpacity,this.colorFromPos=e.colorFromPos,this.shadowmap=e.shadowmap,this.shadowmapType=e.shadowmapType,this.colorFromDepth=e.colorFromDepth,this.orthoCam=e.orthoCam,this.prepassTransparancy=e.prepassTransparancy,this.dashedLine=e.dashedLine,this.thickLine=e.thickLine,this.fogTransparent=e.fogTransparent,this.normalsToGBuffer=e.normalsToGBuffer,this.toonShading=e.toonShading,this.uberOptions.copy(e.uberOptions),this},Ki.prototype.createInstance=function(){var e=new Ki;return e.copy(this),e.uberOptions=Object.create(this.uberOptions),e},Ki.prototype.setValues=function(e){if(void 0!==e){d.RawShaderMaterial.prototype.setValues.call(this,e);var t={},n={};this.fog&&(t.USE_FOG=1),this.instancedPos&&(t.INSTANCED_POS=1),this.instancedMatrix&&(t.INSTANCED_MATRIX=1),this.attrColor&&(t.ATTR_COLOR=1),this.attrColor2&&(t.ATTR_COLOR2=1),this.attrAlphaColor&&(t.ATTR_ALPHA_COLOR=1),this.overrideColor&&(t.OVERRIDE_COLOR=1),this.sphereSprite&&(t.SPHERE_SPRITE=1,n.fragDepth=1),this.cylinderSprite&&(t.CYLINDER_SPRITE=1,n.fragDepth=1),this.zClip&&(t.ZCLIP=1),this.clipPlane&&(t.CLIP_PLANE=1),this.fakeOpacity&&(t.FAKE_OPACITY=1),this.lights&&(t.USE_LIGHTS=1),this.colorFromPos&&(t.COLOR_FROM_POS=1),this.shadowmap&&(t.SHADOWMAP=1,"pcf"===this.shadowmapType?t.SHADOWMAP_PCF_SHARP=1:"random"===this.shadowmapType?t.SHADOWMAP_PCF_RAND=1:t.SHADOWMAP_BASIC=1),this.colorFromDepth&&(t.COLOR_FROM_DEPTH=1),this.orthoCam&&(t.ORTHOGRAPHIC_CAMERA=1),this.prepassTransparancy&&(t.PREPASS_TRANSP=1),this.dashedLine&&(t.DASHED_LINE=1),this.thickLine&&(t.THICK_LINE=1),this.fogTransparent&&(t.FOG_TRANSPARENT=1),this.normalsToGBuffer&&(n.drawBuffers=1,t.NORMALS_TO_G_BUFFER=1),this.toonShading&&(t.TOON_SHADING=1),this.defines=t,this.extensions=n}},Ki.prototype.setUberOptions=function(e){if(void 0!==e)for(var t in e)e.hasOwnProperty(t)&&(this.uberOptions[t]instanceof d.Color?this.uberOptions[t]=e[t].clone():this.uberOptions[t]=e[t])},Ki.prototype.clone=function(e){return e?this.createInstance():d.Material.prototype.clone.call(this)},Ki.prototype.updateUniforms=function(){var e=this;$i.forEach((function(t){e.uniforms.hasOwnProperty(t)&&(e.uberOptions[t]instanceof d.Color||e.uberOptions[t]instanceof d.Matrix4?e.uniforms[t].value=e.uberOptions[t].clone():e.uniforms[t].value=e.uberOptions[t])}))};var Zi=Ki;function Qi(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var Ji=function(e){return function(e){S()(n,e);var t=Qi(n);function n(){var e;m()(this,n);for(var r=arguments.length,i=new Array(r),o=0;o<r;o++)i[o]=arguments[o];return(e=t.call.apply(t,[this].concat(i))).onBeforeRender=n.prototype.onBeforeRender,e}return y()(n,[{key:"onBeforeRender",value:function(e,t,n,r,i,o){this._onBeforeRender(e,t,n,r,i,o),this._update()}},{key:"_onBeforeRender",value:function(){}},{key:"_update",value:function(){var e=this.material;e&&e instanceof Zi&&e.updateUniforms()}}]),n}(e)};function eo(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var to=Ji(d.Mesh),no=function(e){S()(n,e);var t=eo(n);function n(){var e;m()(this,n);for(var r=arguments.length,i=new Array(r),o=0;o<r;o++)i[o]=arguments[o];return(e=t.call.apply(t,[this].concat(i))).castShadow=!0,e.receiveShadow=!0,e}return y()(n,[{key:"_onBeforeRender",value:function(e,t,n,r,i,o){to.prototype._onBeforeRender.call(this,e,t,n);var a=this.material;a&&a.uniforms.invModelViewMatrix&&(this.modelViewMatrix.multiplyMatrices(n.matrixWorldInverse,this.matrixWorld),a.uniforms.invModelViewMatrix.value.copy(this.modelViewMatrix).invert(),a.uniforms.nearPlaneValue.value=n.near,a.uniformsNeedUpdate=!0)}}]),n}(to);function ro(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var io=Ji(d.Mesh),oo=function(e){S()(n,e);var t=ro(n);function n(e,r){var i;return m()(this,n),(i=t.call(this,e,r)).castShadow=!0,i.receiveShadow=!0,i}return y()(n,[{key:"_onBeforeRender",value:function(e,t,r){io.prototype._onBeforeRender.call(this,e,t,r);var i=this.geometry,o=this.material;if(i.zClip&&o.uberOptions){var a=n._modelView,s=n._mvLength,l=n._center;a.multiplyMatrices(this.matrixWorld,r.matrixWorldInverse);var c=s.setFromMatrixColumn(a,0).length();l.copy(i.boundingSphere.center),this.localToWorld(l),o.uberOptions.zClipValue=r.position.z-l.z-c*(.5*i.boundingSphere.radius)}}}]),n}(io);Re()(oo,"_mvLength",new d.Vector3),Re()(oo,"_center",new d.Vector3),Re()(oo,"_modelView",new d.Matrix4);var ao=oo;function so(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var lo=function(e){S()(n,e);var t=so(n);function n(e,r){var i;m()(this,n),(i=t.call(this)).geometry=e;var o=Pn()(i);return o.initialized=!1,i.geometry.addEventListener("update",(function(){o.update()})),i}return y()(n,[{key:"init",value:function(){for(var e=this.children,t=e.length-1;t>=0;--t)this.remove(e[t]);for(var n=this.geometry,r=n.items,i=n.userData,o=0,a=r.length;o<a;++o){var s=r[o];if(s){var l=K.shallowCloneNode(s),c=new In(l);c.userData=h.a.clone(i),c.getElement().style.visibility="visible",c.source=s,this.add(c)}}this.initialized=!0}},{key:"update",value:function(){if(this.geometry.needsUpdate){var e=this.children;this.initialized||this.init();for(var t=0,n=e.length;t<n;++t){var r=e[t],i=r.source;r.position.copy(i.worldPos),r.userData.color=i.opts.color,r.userData.background=i.opts.background}}}}]),n}(d.Group);function co(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var uo=function(e){S()(n,e);var t=co(n);function n(e,r){var i;return m()(this,n),(i=t.call(this,e,r)).castShadow=!0,i.receiveShadow=!0,i}return n}(Ji(d.Mesh));function ho(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var fo=Ji(d.Mesh),po=new d.Vector2,mo=function(e){S()(n,e);var t=ho(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"_onBeforeRender",value:function(e,t,n,r,i,o){var a=this.material;a.uberOptions&&(a.uberOptions.projMatrixInv.copy(n.projectionMatrix).invert(),e.getSize(po),a.uberOptions.viewport.set(po.width,po.height))}}]),n}(fo);function vo(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var yo=function(e){S()(n,e);var t=vo(n);function n(){var e;m()(this,n);for(var r=arguments.length,i=new Array(r),o=0;o<r;o++)i[o]=arguments[o];return(e=t.call.apply(t,[this].concat(i))).castShadow=!0,e.receiveShadow=!0,e}return n}(Ji(d.Mesh)),_o={ZClipped:ao,ZSprite:no,Text:lo,Line:Ji(d.Line),LineSegments:Ji(d.LineSegments),Mesh:uo,ThickLineMesh:mo,Instanced:yo};function go(e,t){return function(n){n.setValues(e),n.setUberOptions(t)}}function xo(e,t){return{Geometry:function(n,r){return new Oi.Instanced2CCylindersGeometry(n,r,e,t)},Object:e?_o.ZSprite:_o.Instanced,initMaterial:go({instancedMatrix:!0,attrColor:!0,attrColor2:!0,attrAlphaColor:!0,cylinderSprite:e})}}function bo(e,t){var n=e.prototype instanceof Wr,r=t.lineWidth||0;return{Geometry:e,Object:n?_o.ThickLineMesh:_o.LineSegments,initMaterial:go({lights:!1,attrColor:!0,attrAlphaColor:!0,thickLine:n},{lineWidth:r})}}function wo(e,t,n,r){var i={wireframe:!!r.wireframe,fakeOpacity:n.now.isoSurfaceFakeOpacity,zClip:r.zClip};return{Geometry:e,Object:_o.ZClipped,initMaterial:go({attrColor:!0,attrAlphaColor:!1,wireframe:i.wireframe,fakeOpacity:i.fakeOpacity,zClip:i.zClip})}}var So=function(){function e(){m()(this,e)}return y()(e,null,[{key:"createSpheres",value:function(e,t){var n=t.now.zSprites;return{Geometry:function(e,t){return new Oi.InstancedSpheresGeometry(e,t,n)},Object:n?_o.ZSprite:_o.Instanced,initMaterial:go({instancedPos:!0,attrColor:!0,attrAlphaColor:!0,sphereSprite:n})}}},{key:"create2CClosedCylinders",value:function(e,t){return xo(!1,!1)}},{key:"create2CCylinders",value:function(e,t){return xo(t.now.zSprites,!0)}},{key:"create2CLines",value:function(e,t,n){return bo(Oi.TwoColorLinesGeometry,n)}},{key:"createCrosses",value:function(e,t,n){return bo(Oi.CrossGeometry,n)}},{key:"createExtrudedChains",value:function(e,t){return{Geometry:Oi.ExtrudedObjectsGeometry,Object:_o.Mesh,initMaterial:go({attrColor:!0,attrAlphaColor:!0})}}},{key:"createChunkedLines",value:function(e,t,n){return bo(Oi.ChunkedLinesGeometry,n)}},{key:"createQuickSurface",value:function(e,t,n){return wo(Oi.QuickSurfGeometry,0,t,n)}},{key:"createContactSurface",value:function(e,t,n){return wo(Oi.ContactSurfaceGeometry,0,t,n)}},{key:"createSASSES",value:function(e,t,n){return wo(Oi.SSIsosurfaceGeometry,0,t,n)}},{key:"createLabels",value:function(e,t){return{Geometry:Oi.LabelsGeometry,Object:_o.Text,initMaterial:function(){}}}}]),e}();function Co(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var Ro=function(e){S()(n,e);var t=Co(n);function n(e,r,i,o){var a;m()(this,n),(a=t.call(this))._geometry=e,a._geoParams=r;var s=i.createInstance();r.initMaterial(s),a._material=s,a._transforms=o.length>0?o:[new d.Matrix4];for(var l=a._createMeshes(e),c=0,u=l.length;c<u;++c)a.add(l[c]);return a}return y()(n,[{key:"raycast",value:function(e,t){var r=n._ray,i=n._inverseMatrix,o=this.children;r.copy(e.ray);for(var a=0,s=o.length;a<s;++a){var l=o[a];if(Yn.belongToSelectLayers(l)){l.updateMatrixWorld();var c=l.matrixWorld;i.copy(c).invert(),e.ray.copy(r).applyMatrix4(i);var u=[];this._geometry.raycast(e,u);for(var h=0,d=u.length;h<d;++h){var f=u[h];f.point&&(f.point.applyMatrix4(c),f.distance=r.origin.distanceTo(f.point)),f.object=l,t[t.length]=f}}}e.ray.copy(r)}},{key:"getSubset",value:function(e){for(var t=this._geometry.getSubset(e),n=[],r=0,i=0,o=t.length;i<o;++i)for(var a=this._createMeshes(t[i]),s=0,l=a.length;s<l;++s)n[r++]=a[s];return n}},{key:"_createMeshes",value:function(e){for(var t=this._transforms,n=this._geoParams.Object,r=this._material,i=[],o=0,a=t.length;o<a;++o){var s=new n(e,r);s.applyMatrix4(t[o]),i[o]=s}return i}}]),n}(d.Object3D);Re()(Ro,"_inverseMatrix",new d.Matrix4),Re()(Ro,"_ray",new d.Ray);var Ao=Ro;function Eo(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var ko=function(e){S()(n,e);var t=Eo(n);function n(e,r,i,o,a,s,l){var c,u,h,d;if(m()(this,n),(c=t.call(this)).constructor===n)throw new Error("Can not instantiate abstract class!");return c._selection=r,c._mode=o,c._colorer=i,c._chunksIdc=r.chunks,c._polyComplexity=s,c._geo=new(u=e.Geometry,h=c._makeGeoArgs(),d=[u].concat(h),u.bind.apply(u,Zn()(d))),c._mesh=new Ao(c._geo,e,l,a),c.add(c._mesh),c._build(),c}return y()(n,[{key:"_makeGeoArgs",value:function(){throw new Error("ChemGroup subclass must override _makeGeoArgs() method")}},{key:"getSubset",value:function(e,t){t=void 0!==t&&t;var n=this._calcChunksList(e,t);return 0===n.length?[]:this._mesh.getSubset(n)}},{key:"_changeSubsetOpacity",value:function(e,t,n){var r=this._calcChunksList(e,n);0!==r.length&&this._geo.setOpacity(r,t)}},{key:"enableSubset",value:function(e,t){t=void 0===t||t,this._changeSubsetOpacity(e,1,t)}},{key:"disableSubset",value:function(e,t){t=void 0===t||t,this._changeSubsetOpacity(e,0,t)}}]),n}(Ln);function To(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var Po=function(e){S()(n,e);var t=To(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"raycast",value:function(e,t){var n=this._selection.atoms,r=[];this._mesh.raycast(e,r);for(var i=this._chunksIdc,o=0,a=r.length;o<a;++o)if(r[o].hasOwnProperty("chunkIdx")){var s=i[r[o].chunkIdx];s<n.length&&(r[o].atom=n[s],t.push(r[o]))}}},{key:"_calcChunksList",value:function(e){for(var t=[],n=this._selection.atoms,r=this._chunksIdc,i=0,o=r.length;i<o;++i){0!=(n[r[i]].mask&e)&&t.push(i)}return t}}]),n}(ko);function Mo(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var Io=function(e){S()(n,e);var t=Mo(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"_makeGeoArgs",value:function(){return[this._selection.chunks.length,this._polyComplexity]}},{key:"_build",value:function(){for(var e=this._selection.chunks,t=this._selection,n=t.atoms,r=t.parent,i=this._mode,o=this._colorer,a=this._geo,s=0,l=e.length;s<l;++s){var c=n[e[s]];a.setItem(s,c.position,i.calcAtomRadius(c)),a.setColor(s,o.getAtomColor(c,r))}a.finalize()}},{key:"updateToFrame",value:function(e){for(var t=this._selection.chunks,n=this._selection.atoms,r=this._mode,i=this._colorer,o=e.needsColorUpdate(i),a=this._geo,s=0,l=t.length;s<l;++s){var c=n[t[s]];a.setItem(s,e.getAtomPos(t[s]),r.calcAtomRadius(c)),o&&a.setColor(s,e.getAtomColor(i,c))}a.finalize()}}]),n}(Po);function No(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var Lo=function(e){S()(n,e);var t=No(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"_makeGeoArgs",value:function(){for(var e=[],t=this._selection,n=t.atoms,r=t.chunks,i=r.length,o=0;o<i;++o)e[o]=n[r[o]];var a=this._mode.getSurfaceOpts();return a.atoms=e,[i,a]}}]),n}(Io);function Do(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var Oo=function(e){S()(n,e);var t=Do(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"_makeGeoArgs",value:function(){for(var e=[],t=this._selection,n=t.atoms,r=t.chunks,i=r.length,o=0;o<i;++o)e[o]=n[r[o]];var a=this._mode.getSurfaceOpts();return a.atoms=e,a.selection=this._selection,a.colorMode=this._colorer,[i,a]}}]),n}(Io);function Vo(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}function zo(e){return null!==e.name.getNode()?e.name.getNode():e.getVisualName()}var Fo={none:function(e){return e},adjust:function(e){var t=e>>16&255,n=e>>8&255,r=255&e;return.2126*t+.7152*n+.0722*r>127?(t=3*t/10,n=3*n/10,r=3*r/10):(t=255-3*(255-t)/10,n=255-3*(255-n)/10,r=255-3*(255-r)/10),t<<16|n<<8|r},inverse:function(e){return 255-(e>>16&255)<<16|255-(e>>8&255)<<8|255-(255&e)}};function Bo(e,t){var n;if(Fo.hasOwnProperty(t))n=K.hexColor(Fo[t](e));else{var r=parseInt(t,16);n=!Number.isNaN(r)&&t.toLowerCase().startsWith("0x")?K.hexColor(r):"#000000"}return n}var Uo={serial:function(e){return e.serial},name:function(e){return e.getVisualName()},elem:function(e){return e.element.name},residue:function(e){return e.residue.getType().getName()},sequence:function(e){return e.residue.getSequence()},chain:function(e){return e.residue.getChain().getName()},hetatm:function(e){return e.isHet()},water:function(e){return"HOH"===e.residue.getType().getName()||"WAT"===e.residue.getType().getName()}},Go=function(e,t){return t.replace(/\{\{(\s*\w+\s*)\}\}/g,(function(t){var n=t.replace(/\s+/g,"");return n=n.substring(2,n.length-2).toLowerCase(),Uo.hasOwnProperty(n)?Uo[n](e):"null"}))},jo=function(e){S()(n,e);var t=Vo(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"_makeGeoArgs",value:function(){var e=this._mode.getLabelOpts();return[this._selection.chunks.length,e]}},{key:"_build",value:function(){for(var e=this._mode.getLabelOpts(),t=this._selection.chunks,n=this._selection,r=n.atoms,i=n.parent,o=this._colorer,a=this._geo,s=0,l=t.length;s<l;++s){var c=r[t[s]],u=e.template?Go(c,e.template):zo(c);if(u){var h=o.getAtomColor(c,i),d=parseInt(Bo(h,e.fg).substring(1),16),f=e.showBg?parseInt(Bo(h,e.bg).substring(1),16):"transparent";a.setItem(s,c.position,u),a.setColor(s,d,f)}}a.finalize()}},{key:"updateToFrame",value:function(e){for(var t=this._mode.getLabelOpts(),n=this._selection.chunks,r=this._selection.atoms,i=this._colorer,o=this._geo,a=e.needsColorUpdate(i),s=0,l=n.length;s<l;++s){var c=r[n[s]],u=t.template?Go(c,t.template):zo(c);if(u){var h=e.getAtomColor(i,c),d=parseInt(Bo(h,t.fg).substring(1),16),f=t.showBg?parseInt(Bo(h,t.bg).substring(1),16):"transparent";o.setItem(s,e.getAtomPos(n[s]),u),a&&o.setColor(s,d,f)}}o.finalize()}}]),n}(Po);function Ho(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}function Wo(e,t,n,r){var i=Math.sin(e);return t.clone().multiplyScalar(Math.sin((1-r)*e)/i).addScaledVector(n,Math.sin(r*e)/i)}var Yo=function(e){S()(n,e);var t=Ho(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"_buildInner",value:function(e,t){for(var n=this._selection.chunks,r=new d.Vector3,i=new d.Vector3,o=this._segmentsHeight,a=1/o,s=this._colorer,l=this._selection,c=l.cycles,u=l.parent,h=0,f=n[h],p=0,m=c.length;p<m;++p){var v=c[p],y=v.atoms,_=[],g=[],x=v.center,b=v.radius-e,w=y.length,S=0,C=y[w-1].position,R=y[S].position;r.subVectors(C,x),i.subVectors(R,x);for(var A=i.clone().cross(r).normalize();S<w;++S){var E=r.angleTo(i);g[S]=Wo(E,r,i,.5).normalize(),R=y[(S+1)%w].position,r.copy(i),i.subVectors(R,x)}for(S=0;S<w;++S)if(y[S].index===f){for(var k=g[S],T=g[(S+1)%w],P=s.getAtomColor(y[S],u),M=k.angleTo(T),I=0;I<=o;++I)_[I]=Wo(M,k,T,I*a).multiplyScalar(b).add(x);t(h++,P,_,x,A),f=n[h]}}}}]),n}(Po);function qo(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}function Xo(e,t){for(var n=[],r=0;r<t;++r){var i=-2*r/t*Math.PI;n.push(new d.Vector3(Math.cos(i)*e,Math.sin(i)*e,0))}return n}var $o=Yn.calcChunkMatrix,Ko=function(e){S()(n,e);var t=qo(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"_build",value:function(){var e=this._segmentsHeight,t=this._mode.getAromRadius(),n=new d.Vector2(t,t),r=this._mode.calcStickRadius()+2*t,i=new d.Vector3,o=[],a=this._geo;this._buildInner(r,(function(t,r,s,l,c){for(var u=0;u<=e;++u){var h=s[u],d=h.clone().sub(l).cross(c);i.addVectors(h,d),o[u]=$o(h,i,c,n)}a.setItem(t,o),a.setColor(t,r)})),a.finalize()}},{key:"_makeGeoArgs",value:function(){return this._segmentsHeight=this._polyComplexity,[Xo(1,this._polyComplexity),this._segmentsHeight+1,this._selection.chunks.length]}}]),n}(Yo);function Zo(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var Qo=function(e){S()(n,e);var t=Zo(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"_build",value:function(){var e=this,t=this._geo,n=this._mode.getAromaticOffset();this._buildInner(n,(function(n,r,i){for(var o=i[0],a=1;a<=e._segmentsHeight;++a){var s=i[a];t.setSegment(n,a-1,o,s),o=s}t.setColor(n,r)})),t.finalize()}},{key:"_makeGeoArgs",value:function(){return this._segmentsHeight=this._mode.getAromaticArcChunks(),[this._selection.chunks.length,this._segmentsHeight,!0]}}]),n}(Yo);function Jo(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var ea=function(e){S()(n,e);var t=Jo(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"raycast",value:function(e,t){var n=this._selection.residues,r=[];this._mesh.raycast(e,r);for(var i=this._chunksIdc,o=0,a=r.length;o<a;++o)if(r[o].hasOwnProperty("chunkIdx")){var s=i[r[o].chunkIdx];s<n.length&&(r[o].residue=n[s],t.push(r[o]))}}},{key:"_calcChunksList",value:function(e){for(var t=[],n=this._selection.residues,r=this._chunksIdc,i=0,o=r.length;i<o;++i){0!=(n[r[i]]._mask&e)&&t.push(i)}return t}}]),n}(ko);function ta(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var na=function(e){S()(n,e);var t=ta(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"raycast",value:function(e,t){var n=this._selection.residues,r=[];this._mesh.raycast(e,r);for(var i=this._chunksIdc,o=0,a=r.length;o<a;++o)if(r[o].hasOwnProperty("chunkIdx")){var s=i[Math.floor(r[o].chunkIdx/2)];s<n.length&&(r[o].residue=n[s],t.push(r[o]))}}},{key:"_build",value:function(){for(var e=this._selection,t=e.residues,n=e.parent,r=this._colorer,i=this._geo,o=this._mode.calcStickRadius(),a=0,s=this._selection.chunks,l=0,c=s.length;l<c;++l){var u=t[s[l]],h=r.getResidueColor(u,n);this._processItem(a++,u._cylinders[0],u._cylinders[1],o,h)}i.finalize()}},{key:"_calcChunksList",value:function(e){for(var t=[],n=0,r=this._selection.residues,i=this._chunksIdc,o=0,a=i.length;o<a;++o){0!=(r[i[o]]._mask&e)&&(t[n++]=2*o,t[n++]=2*o+1)}return t}},{key:"updateToFrame",value:function(e){for(var t=e.getResidues(),n=this._selection.parent,r=this._colorer,i=this._geo,o=this._mode.calcStickRadius(),a=0,s=this._selection.chunks,l=0,c=s.length;l<c;++l){var u=t[s[l]],h=r.getResidueColor(u,n);this._processItem(a++,u._cylinders[0],u._cylinders[1],o,h)}i.finishUpdate()}}]),n}(ea);function ra(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var ia=function(e){S()(n,e);var t=ra(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"_makeGeoArgs",value:function(){return[this._selection.chunks.length,this._polyComplexity]}},{key:"_processItem",value:function(e,t,n,r,i){var o=this._geo;o.setItem(e,t,n,r),o.setColor(e,i,i)}}]),n}(na);function oa(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var aa=function(e){S()(n,e);var t=oa(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"_makeGeoArgs",value:function(){return[2*this._selection.chunks.length,this._polyComplexity]}},{key:"_processItem",value:function(e,t,n,r,i){var o=this._geo,a=2*e;o.setItem(a,t,r),o.setColor(a,i),a++,o.setItem(a,n,r),o.setColor(a,i)}}]),n}(na),sa=n("Nq/s"),la=kn.ResidueType,ca=Yn.calcChunkMatrix;function ua(e,t){var n=Object(sa.Smooth)(e,{method:sa.Smooth.METHOD_CUBIC,clip:sa.Smooth.CLIP_CLAMP,cubicTension:t,scaleTo:1});return function(t,r){var i=r;null===i&&(i=function(t){return(t*(e.length-1-2)+1)/(e.length-1)});var o=i(t),a=n(o);return new d.Vector3(a[0],a[1],a[2])}}function ha(e,t,n,r){if(!r._isValid)return e[n]=e[n-1],void(t[n]=t[n-1]);var i=r._controlPoint;e[n]=[i.x,i.y,i.z];var o=i.clone().add(r._wingVector);t[n]=[o.x,o.y,o.z]}function da(e,t,n,r){var i=r.start,o=r.end;function a(t){return t>i&&e[t-1]._isValid?t-1:t}function s(t){return t<o&&e[t+1]._isValid?t+1:t}var l=[],c=[],u=0;function h(t,n){var r=e[t]._controlPoint.clone().lerp(e[n]._controlPoint,-.25),i=r.clone().add(e[t]._wingVector);c[u]=[r.x,r.y,r.z],l[u++]=[i.x,i.y,i.z],c[u]=[r.x,r.y,r.z],l[u++]=[i.x,i.y,i.z]}var d=a(t),f=s(n);if(d===f)return function(e,t,n,r){var i,o,a=0!=(r._type.flags&la.Flags.NUCLEIC),s=a?"C5'":"N",l=a?"C3'":"C";if(r.forEachAtom((function(e){var t=e.getVisualName();i||t!==s?o||t!==l||(o=e.position):i=e.position})),i&&o||(i=r._firstAtom.position,o=r._lastAtom.position),i&&o){var c=o.clone().sub(i),u=r._wingVector,h=r._controlPoint,d=h.clone().add(u),f=h.clone().sub(c),p=f.clone().add(u);e[n]=[f.x,f.y,f.z],t[n]=[p.x,p.y,p.z],e[++n]=[f.x,f.y,f.z],t[n]=[p.x,p.y,p.z],e[++n]=[h.x,h.y,h.z],t[n]=[d.x,d.y,d.z],++n;var m=h.clone().add(c),v=m.clone().add(u);e[n]=[m.x,m.y,m.z],t[n]=[v.x,v.y,v.z],e[++n]=[m.x,m.y,m.z],t[n]=[v.x,v.y,v.z]}}(c,l,u,e[t]),{centerPoints:c,topPoints:l};t===d?h(t,s(t)):(ha(c,l,u++,e[a(d)]),ha(c,l,u++,e[d]));for(var p=t;p<=n;++p)ha(c,l,u++,e[p]);return f===s(f)?h(n,a(n)):(ha(c,l,u++,e[f]),ha(c,l,u,e[s(f)])),{centerPoints:c,topPoints:l}}var fa=function(){function e(t,n,r,i,o,a){m()(this,e);var s=da(t,n,r,a);this._topInterp=ua(s.topPoints,o),this._centerInterp=ua(s.centerPoints,o),this._shift=.5/(r-n+2),this._valueStep=(1-2*this._shift)/(2*(r-n+1)*(i-1)),this._segmentsCount=i}return y()(e,[{key:"prepareMatrices",value:function(e,t,n){for(var r=this._segmentsCount,i=new Array(r),o=new d.Vector2(0,0),a=this._topInterp,s=this._centerInterp,l=this._shift+this._valueStep*(r-1)*e,c=0;c<r;++c){var u=Math.min(1,c/(r-1));o.lerpVectors(t,n,u);var h=a(l,null),f=s(l,null),p=s(l+=this._valueStep,null);i[c]=ca(f.clone(),p.clone(),h.clone().sub(f),o)}return i}}]),e}();function pa(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}function ma(e,t){for(var n=[],r=0;r<t;++r){var i=Math.PI/2-2*Math.PI*r/t;n.push(new d.Vector3(Math.cos(i)*e,Math.sin(i)*e,0))}return n}function va(e,t,n,r,i,o){for(var a=0,s=e.length;a<s;++a)for(var l=e[a].arr,c=e[a].boundaries,u=0,h=l.length;u<h;++u)for(var d=[l[u].start,l[u].end],f=new fa(t,d[0],d[1],n,r,c),p=null,m=2*l[u].start,v=2*l[u].end+1,y=i.getResidueRadius(t[0],0),_=m;_<=v;++_){var g=t[_/2|0],x=i.getResidueRadius(g,_%2),b=i.getResidueRadius(g,1+_%2),w=f.prepareMatrices(_-2*d[0],x,b);w.unshift(null===p?w[0]:p),o(g,w,x.x!==b.x||x.y!==b.y,x.x!==y.x||x.y!==y.y),p=w[n],y=b}}var ya=function(e){S()(n,e);var t=pa(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"_makeGeoArgs",value:function(){var e=this._mode.getHeightSegmentsRatio();return this._segmentsHeight=this._polyComplexity*e|0,[ma(1,this._polyComplexity),this._segmentsHeight+1,2*this._selection.chunks.length]}},{key:"_build",value:function(){var e=this._selection,t=e.residues,n=e.parent,r=this._mode,i=this._colorer,o=r.getTension(),a=this._geo,s=0,l=[];va(this._selection.subdivs,t,this._segmentsHeight,o,r,(function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],o=arguments.length>3&&void 0!==arguments[3]&&arguments[3],c=i.getResidueColor(e,n);l[s]=e._index,a.setItem(s,t,r,o),a.setColor(s++,c)})),this._chunksIdc=l,a.finalize()}},{key:"updateToFrame",value:function(e){var t=this._selection.parent,n=this._mode,r=this._colorer,i=n.getTension(),o=this._geo,a=e.getResidues(),s=0,l=e.needsColorUpdate(r);va(this._selection.subdivs,a,this._segmentsHeight,i,n,(function(e,n){o.setItem(s,n),l&&o.setColor(s,r.getResidueColor(e,t)),s++})),o.finalize()}}]),n}(ea);function _a(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var ga=function(e){S()(n,e);var t=_a(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"_makeGeoArgs",value:function(){for(var e=this._selection.subdivs,t=0,n=0,r=e.length;n<r;++n)for(var i=e[n].arr,o=0,a=i.length;o<a;++o)t+=i[o].end-i[o].start;return[t,this._polyComplexity]}},{key:"_build",value:function(){for(var e=this._selection,t=e.residues,n=e.parent,r=this._mode,i=this._colorer,o=this._geo,a=0,s=[],l=this._selection.subdivs,c=r.calcStickRadius(),u=0,h=l.length;u<h;++u)for(var d=l[u].arr,f=0,p=d.length;f<p;++f)for(var m=d[f].start,v=d[f].end,y=t[m],_=m+1;_<=v;++_){var g=t[_];s[a]={first:y._index,second:g._index},o.setItem(a,y._controlPoint,g._controlPoint,c),o.setColor(a,i.getResidueColor(y,n),i.getResidueColor(g,n)),a++,y=g}this._chunksIdc=s,o.finalize()}},{key:"updateToFrame",value:function(e){for(var t=e.getResidues(),n=this._selection.parent,r=this._mode,i=this._colorer,o=this._geo,a=0,s=this._selection.subdivs,l=r.calcStickRadius(),c=e.needsColorUpdate(i),u=0,h=s.length;u<h;++u)for(var d=s[u].arr,f=0,p=d.length;f<p;++f)for(var m=d[f].start,v=d[f].end,y=t[m],_=m+1;_<=v;++_){var g=t[_];o.setItem(a,y._controlPoint,g._controlPoint,l),c&&o.setColor(a,i.getResidueColor(y,n),i.getResidueColor(g,n)),a++,y=g}o.finalize()}},{key:"raycast",value:function(e,t){var n=[],r=this._selection.residues;this._mesh.raycast(e,n);for(var i=this._chunksIdc,o=0,a=n.length;o<a;++o)if(n[o].hasOwnProperty("chunkIdx")){var s=n[o].chunkIdx,l=i[Math.floor(s/2)],c=s%2==0?l.first:l.second;c<r.length&&(n[o].residue=r[c],t.push(n[o]))}}},{key:"_calcChunksList",value:function(e){for(var t=[],n=this._chunksIdc,r=this._selection.residues,i=0,o=n.length;i<o;++i){var a=n[i];r[a.first]._mask&e&&t.push(2*i),r[a.second]._mask&e&&t.push(2*i+1)}return t}}]),n}(ko);function xa(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var ba=function(e){S()(n,e);var t=xa(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"_makeGeoArgs",value:function(){for(var e=this._mode.drawMultiorderBonds(),t=this._mode.showAromaticLoops(),n=this._selection.chunks,r=this._selection.bonds,i=0,o=0,a=n.length;o<a;++o)i+=this.getBondOrder(r[n[o]],e,t);return[i,this._polyComplexity]}},{key:"getBondOrder",value:function(e,t,n){var r=1;return!t||n&&e._type===Ne.BondType.AROMATIC||(r=function(e){return e<2?1:e}(e._order)),r}},{key:"raycast",value:function(e,t){var n=this._selection.bonds,r=[];this._mesh.raycast(e,r);for(var i=this._chunksIdc,o=0,a=r.length;o<a;++o)if(r[o].hasOwnProperty("chunkIdx")){var s=r[o].chunkIdx,l=i[Math.floor(s/2)];if(l<n.length){var c=n[l];r[o].atom=s%2==0?c._left:c._right,t.push(r[o])}}}},{key:"_calcChunksList",value:function(e,t){for(var n=[],r=this._selection.bonds,i=this._chunksIdc,o=0,a=i.length;o<a;++o){var s=r[i[o]];s._left.mask&e&&(!t||s._right.mask&e)&&n.push(2*o),s._right.mask&e&&(!t||s._left.mask&e)&&n.push(2*o+1)}return n}}]),n}(ko);function wa(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}function Sa(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var Ca={AtomsSphereGroup:Io,AtomsSurfaceGroup:Lo,AtomsSASSESGroupStub:Oo,AtomsTextGroup:jo,AromaticTorusGroup:Ko,AromaticLinesGroup:Qo,NucleicCylindersGroup:ia,NucleicSpheresGroup:aa,ResiduesSubseqGroup:ya,ResiduesTraceGroup:ga,BondsCylinderGroup:function(e){S()(n,e);var t=wa(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"_build",value:function(){for(var e,t=this._selection.chunks,n=this._selection,r=n.bonds,i=n.parent,o=this._mode,a=this._colorer,s=this._geo,l=o.drawMultiorderBonds(),c=o.showAromaticLoops(),u=o.calcStickRadius(),h=o.calcSpaceFraction(),f=new d.Vector3,p=new d.Vector3,m=0,v=[],y=0,_=t.length;y<_;++y){var g=r[t[y]],x=g._left,b=g._right,w=x.position,S=b.position;e=g.calcNormalDir();for(var C=this.getBondOrder(g,l,c),R=2*Math.min(o.calcAtomRadius(x),o.calcAtomRadius(b))/C,A=l?Math.min(u,.5*R*(1-h)):u,E=0;E<C;++E){var k=R*(C%2==0?(.5+(E/2|0))*(1-E%2*2):((E+1)/2|0)*(E%2*2-1));v[m]=g._index,f.copy(w),f.addScaledVector(e,k),p.copy(S),p.addScaledVector(e,k),s.setItem(m,f,p,A),s.setColor(m++,a.getAtomColor(x,i),a.getAtomColor(b,i))}}s.finalize(),this._chunksIdc=v}},{key:"updateToFrame",value:function(e){for(var t,n=this._selection.chunks,r=this._selection.bonds,i=this._mode,o=this._colorer,a=this._geo,s=i.drawMultiorderBonds(),l=i.showAromaticLoops(),c=i.calcStickRadius(),u=i.calcSpaceFraction(),h=new d.Vector3,f=new d.Vector3,p=0,m=e.needsColorUpdate(o),v=0,y=n.length;v<y;++v){var _=r[n[v]],g=_._left,x=_._right,b=e.getAtomPos(g.index).clone(),w=e.getAtomPos(x.index);t=_.calcNormalDir();for(var S=this.getBondOrder(_,s,l),C=2*Math.min(i.calcAtomRadius(g),i.calcAtomRadius(x))/S,R=s?Math.min(c,.5*C*(1-u)):c,A=0;A<S;++A){var E=C*(S%2==0?(.5+(A/2|0))*(1-A%2*2):((A+1)/2|0)*(A%2*2-1));h.copy(b),h.addScaledVector(t,E),f.copy(w),f.addScaledVector(t,E),a.setItem(p,h,f,R),m&&a.setColor(p,e.getAtomColor(o,g),e.getAtomColor(o,x)),p++}}a.finalize()}}]),n}(ba),BondsLinesGroup:function(e){S()(n,e);var t=Sa(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"_build",value:function(){for(var e=this._selection.chunks,t=this._selection,n=t.bonds,r=t.parent,i=this._mode,o=this._colorer,a=this._geo,s=i.drawMultiorderBonds(),l=i.showAromaticLoops(),c=new d.Vector3,u=new d.Vector3,h=new d.Vector3,f=0,p=[],m=0,v=e.length;m<v;++m){var y=n[e[m]],_=y._left,g=y._right,x=_.position,b=g.position,w=1===_.bonds.length,S=1===g.bonds.length;c.subVectors(b,x);for(var C=c.length(),R=y.calcNormalDir(),A=this.getBondOrder(y,s,l),E=0;E<A;++E){u.copy(x),h.copy(b);var k=A%2==0?(.5+(E/2|0))*(1-E%2*2):((E+1)/2|0)*(E%2*2-1);p[f]=y._index,2!==A||w||S||(k-=.5,k*=-1),!w&&!S&&A>1&&0!==k&&(u.lerpVectors(x,b,.15/C),h.lerpVectors(x,b,1-.15/C)),k*=.15,u.addScaledVector(R,k),h.addScaledVector(R,k),a.setItem(f,u,h),a.setColor(f++,o.getAtomColor(_,r),o.getAtomColor(g,r))}}a.finalize(),this._chunksIdc=p}},{key:"updateToFrame",value:function(e){for(var t=this._selection.chunks,n=this._selection.bonds,r=this._mode,i=this._colorer,o=this._geo,a=r.drawMultiorderBonds(),s=r.showAromaticLoops(),l=new d.Vector3,c=new d.Vector3,u=new d.Vector3,h=0,f=e.needsColorUpdate(i),p=0,m=t.length;p<m;++p){var v=n[t[p]],y=v._left,_=v._right,g=e.getAtomPos(y.index).clone(),x=e.getAtomPos(_.index),b=1===y.bonds.length,w=1===_.bonds.length;l.subVectors(x,g);for(var S=l.length(),C=v.calcNormalDir(),R=this.getBondOrder(v,a,s),A=0;A<R;++A){c.copy(g),u.copy(x);var E=R%2==0?(.5+(A/2|0))*(1-A%2*2):((A+1)/2|0)*(A%2*2-1);2!==R||b||w||(E-=.5,E*=-1),!b&&!w&&R>1&&0!==E&&(c.lerpVectors(g,x,.15/S),u.lerpVectors(g,x,1-.15/S)),E*=.15,c.addScaledVector(C,E),u.addScaledVector(C,E),o.setItem(h,c,u),f&&o.setColor(h,e.getAtomColor(i,y),e.getAtomColor(i,_)),h++}}o.finalize()}}]),n}(ba)};function Ra(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var Aa=function(e){S()(n,e);var t=Ra(n);function n(e,r,i,o,a,s,l,c){var u;m()(this,n),u=t.call(this);var h=Pn()(u);u._complex=i,u._mode=a;var d=i.getAtoms(),f=i.getTransforms();return i.forEachComponent((function(t){var n=[],u=0;if(t.forEachAtom((function(e){h._checkAtom(e,l)&&(n[u++]=e.index)})),0!==u){var p=new e(r,{atoms:d,chunks:n,parent:i},o,a,f,s,c);p._component=t,h.add(p)}})),u}return y()(n,[{key:"_checkAtom",value:function(e,t){return e.mask&t}},{key:"getSubset",value:function(e,t){for(var n=[],r=this.children,i=0,o=0,a=r.length;o<a;++o)if(r[o].getSubset)for(var s=r[o].getSubset(e,t),l=0,c=s.length;l<c;++l){var u=s[l];u._component=r[o]._component,n[i++]=u}return n}}]),n}(Ln);function Ea(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var ka=function(e){S()(n,e);var t=Ea(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"_checkAtom",value:function(e,t){if(!(e.mask&t))return!1;for(var n=e.bonds,r=0,i=n.length;r<i;++r)if(n[r]._left.mask&t&&n[r]._right.mask&t)return!1;return!0}}]),n}(Aa);function Ta(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var Pa=function(e){S()(n,e);var t=Ta(n);function n(e,r,i,o,a,s,l,c){var u;m()(this,n),u=t.call(this);var h=Pn()(u);u._complex=i;var d=i.getResidues(),f=i.getTransforms();return i.forEachComponent((function(t){var n=0,u=[];if(t.forEachResidue((function(e){h._checkResidue(e,l)&&(u[n++]=e._index)})),0!==n){var p=new e(r,{residues:d,chunks:u,parent:i},o,a,f,s,c);p._component=t,h.add(p)}})),u}return y()(n,[{key:"checkResidue",value:function(e,t){return e._mask&t}},{key:"getSubset",value:function(e,t){for(var n=[],r=this.children,i=0,o=0,a=r.length;o<a;++o)if(r[o].getSubset)for(var s=r[o].getSubset(e,t),l=0,c=s.length;l<c;++l){var u=s[l];u._component=r[o]._component,n[i++]=u}return n}}]),n}(Ln);function Ma(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}function Ia(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}function Na(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}function La(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var Da={Atoms:Aa,OrphanAtoms:ka,Residues:Pa,Nucleic:function(e){S()(n,e);var t=Ma(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"_checkResidue",value:function(e,t){return t&e._mask&&null!==e._cylinders}}]),n}(Pa),Subseqs:function(e){S()(n,e);var t=Ia(n);function n(e,r,i,o,a,s,l,c){var u;m()(this,n),u=t.call(this);var h=Pn()(u);u._complex=i;var d=i.getResidues(),f=i.getTransforms();return i.forEachComponent((function(t){for(var n=t.getMaskedSubdivSequences(l),u=0,p=[],m=0,v=n.length;m<v;++m)for(var y=n[m].arr,_=0,g=y.length;_<g;++_)for(var x=y[_].start,b=y[_].end;x<=b;++x)p[u++]=d[x]._index;if(0!==u){var w=new e(r,{residues:d,chunks:p,subdivs:n,parent:i},o,a,f,s,c);w._component=t,h.add(w)}})),u}return y()(n,[{key:"getSubset",value:function(e,t){for(var n=[],r=this.children,i=0,o=0,a=r.length;o<a;++o)if(r[o].getSubset)for(var s=r[o].getSubset(e,t),l=0,c=s.length;l<c;++l){var u=s[l];u._component=r[o]._component,n[i++]=u}return n}}]),n}(Ln),Bonds:function(e){S()(n,e);var t=Na(n);function n(e,r,i,o,a,s,l,c){var u;m()(this,n),u=t.call(this);var h=Pn()(u);u._complex=i;var d=i.getBonds(),f=i.getTransforms();return i.forEachComponent((function(t){var n=[],u=0;if(t.forEachBond((function(e){var t=e._left,r=e._right;t.mask&l&&r.mask&l&&(n[u++]=e._index)})),0!==u){var p=new e(r,{bonds:d,chunks:n,parent:i},o,a,f,s,c);p._component=t,h.add(p)}})),u}return y()(n,[{key:"getSubset",value:function(e,t){for(var n=[],r=this.children,i=0,o=0,a=r.length;o<a;++o)if(r[o].getSubset)for(var s=r[o].getSubset(e,t),l=0,c=s.length;l<c;++l){var u=s[l];u._component=r[o]._component,n[i++]=u}return n}}]),n}(Ln),Aromatic:function(e){S()(n,e);var t=La(n);function n(e,r,i,o,a,s,l,c){var u;m()(this,n),u=t.call(this);var h=Pn()(u);u._complex=i;var d=i.getAtoms(),f=i.getTransforms();return a.showAromaticLoops()?(i.forEachComponent((function(t){var n=[],u=0,p=[],m=0;t.forEachCycle((function(e){for(var t=e.atoms,r=0,i=0,o=t.length;i<o;++i)0!=(t[i].mask&l)&&(++r,n[u++]=t[i].index);r>0&&(p[m++]=e)}));var v=new e(r,{cycles:p,atoms:d,chunks:n,parent:i},o,a,f,s,c);v._component=t,h.add(v)})),u):R()(u)}return y()(n,[{key:"getSubset",value:function(e,t){for(var n=[],r=this.children,i=0,o=0,a=r.length;o<a;++o)if(r[o].getSubset)for(var s=r[o].getSubset(e,t),l=0,c=s.length;l<c;++l){var u=s[l];u._component=r[o]._component,n[i++]=u}return n}}]),n}(Ln)};function Oa(e,t,n){return function(r,i,o,a,s,l){return new t(n,e,r,i,o,a,s,l)}}var Va=function(){function e(){m()(this,e)}return y()(e,null,[{key:"AtomsSpheres",value:function(e,t){return Oa(So.createSpheres(e,t),Da.Atoms,Ca.AtomsSphereGroup)}},{key:"OrphanedAtomsCrosses",value:function(e,t,n){return Oa(So.createCrosses(e,t,n),Da.OrphanAtoms,Ca.AtomsSphereGroup)}},{key:"BondsCylinders",value:function(e,t){return Oa(So.create2CCylinders(e,t),Da.Bonds,Ca.BondsCylinderGroup)}},{key:"BondsLines",value:function(e,t,n){return Oa(So.create2CLines(e,t,n),Da.Bonds,Ca.BondsLinesGroup)}},{key:"CartoonChains",value:function(e,t){return Oa(So.createExtrudedChains(e,t),Da.Subseqs,Ca.ResiduesSubseqGroup)}},{key:"TraceChains",value:function(e,t){return Oa(So.create2CClosedCylinders(e,t),Da.Subseqs,Ca.ResiduesTraceGroup)}},{key:"NucleicSpheres",value:function(e,t){return Oa(So.createSpheres(e,t),Da.Nucleic,Ca.NucleicSpheresGroup)}},{key:"NucleicCylinders",value:function(e,t){return Oa(So.create2CCylinders(e,t),Da.Nucleic,Ca.NucleicCylindersGroup)}},{key:"ALoopsTorus",value:function(e,t){return Oa(So.createExtrudedChains(e,t),Da.Aromatic,Ca.AromaticTorusGroup)}},{key:"ALoopsLines",value:function(e,t,n){return Oa(So.createChunkedLines(e,t,n),Da.Aromatic,Ca.AromaticLinesGroup)}},{key:"QuickSurfGeo",value:function(e,t,n){return Oa(So.createQuickSurface(e,t,n),Da.Atoms,Ca.AtomsSurfaceGroup)}},{key:"ContactSurfaceGeo",value:function(e,t,n){return Oa(So.createContactSurface(e,t,n),Da.Atoms,Ca.AtomsSurfaceGroup)}},{key:"SASSESSurfaceGeo",value:function(e,t,n){return Oa(So.createSASSES(e,t,n),Da.Atoms,Ca.AtomsSASSESGroupStub)}},{key:"TextLabelsGeo",value:function(e,t){return Oa(So.createLabels(e,t),Da.Atoms,Ca.AtomsTextGroup)}}]),e}(),za=function(){function e(t){if(m()(this,e),this.constructor===e)throw new Error("Can not instantiate abstract class!");this.opts=h.a.merge(K.deriveDeep(this.settings.now.modes[this.id],!0),t)}return y()(e,[{key:"identify",value:function(){var e=K.objectsDiff(this.opts,this.settings.now.modes[this.id]);return h.a.isEmpty(e)?this.id:[this.id,e]}},{key:"buildGeometry",value:function(e,t,n,r){for(var i=this.opts.polyComplexity?this.opts.polyComplexity[this.settings.now.resolution]:0,o=this.depGroups,a=o.length,s=new Yn.RCGroup,l=0;l<a;++l){var u=o[l],d={};if(h.a.isArray(u)){d=u[1].call(this);var f=u;u=c()(f,1)[0]}var p=new(Va[u](null,this.settings,d))(e,t,this,i,n,r);p.children.length>0&&s.add(p)}return s}}]),e}();er(za.prototype),za.prototype.id="__",za.prototype.depGroups=[];var Fa=za;function Ba(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}function Ua(){return{lineWidth:this.opts.lineWidth}}var Ga=function(e){S()(n,e);var t=Ba(n);function n(e){var r;m()(this,n),(r=t.call(this,e)).depGroups=r.depGroups.slice(0);for(var i=r.depGroups,o=0,a=i.length;o<a;++o)i[o]=[i[o],Ua];return r}return y()(n,[{key:"drawMultiorderBonds",value:function(){return this.opts.multibond}},{key:"calcAtomRadius",value:function(){return this.opts.atom}},{key:"getAromaticOffset",value:function(){return this.opts.offsarom}},{key:"getAromaticArcChunks",value:function(){return this.opts.chunkarom}},{key:"showAromaticLoops",value:function(){return this.opts.showarom}}]),n}(Fa);Re()(Ga,"id","LN"),Ga.prototype.id="LN",Ga.prototype.name="Lines",Ga.prototype.shortName="Lines",Ga.prototype.depGroups=["ALoopsLines","BondsLines","OrphanedAtomsCrosses"];var ja=Ga;function Ha(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var Wa=function(e){S()(n,e);var t=Ha(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"calcAtomRadius",value:function(e){return this.opts.bond}},{key:"calcStickRadius",value:function(){return this.opts.bond}},{key:"calcSpaceFraction",value:function(){return this.opts.space}},{key:"getAromRadius",value:function(){return this.opts.aromrad}},{key:"showAromaticLoops",value:function(){return this.opts.showarom}},{key:"drawMultiorderBonds",value:function(){return this.opts.multibond}}]),n}(Fa);Re()(Wa,"id","LC"),Wa.prototype.id="LC",Wa.prototype.name="Licorice",Wa.prototype.shortName="Licorice",Wa.prototype.depGroups=["AtomsSpheres","BondsCylinders","ALoopsTorus"];var Ya=Wa;function qa(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var Xa=function(e){S()(n,e);var t=qa(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"calcAtomRadius",value:function(e){return e.element.radius*this.opts.atom}},{key:"calcStickRadius",value:function(){return this.opts.bond}},{key:"getAromRadius",value:function(){return this.opts.aromrad}},{key:"showAromaticLoops",value:function(){return this.opts.showarom}},{key:"calcSpaceFraction",value:function(){return this.opts.space}},{key:"drawMultiorderBonds",value:function(){return this.opts.multibond}}]),n}(Fa);Re()(Xa,"id","BS"),Xa.prototype.id="BS",Xa.prototype.name="Balls and Sticks",Xa.prototype.shortName="Balls",Xa.prototype.depGroups=["AtomsSpheres","BondsCylinders","ALoopsTorus"];var $a=Xa;function Ka(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var Za=function(e){S()(n,e);var t=Ka(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"calcAtomRadius",value:function(e){return e.element.radius}}]),n}(Fa);Re()(Za,"id","VW"),Za.prototype.id="VW",Za.prototype.name="Van der Waals",Za.prototype.shortName="VDW",Za.prototype.depGroups=["AtomsSpheres"];var Qa=Za;function Ja(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var es=function(e){S()(n,e);var t=Ja(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"calcStickRadius",value:function(){return this.opts.radius}}]),n}(Fa);Re()(es,"id","TR"),es.prototype.id="TR",es.prototype.name="Trace",es.prototype.shortName="Trace",es.prototype.depGroups=["TraceChains"];var ts=es;function ns(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var rs=function(e){S()(n,e);var t=ns(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"getResidueRadius",value:function(e){return this.TUBE_RADIUS}},{key:"getHeightSegmentsRatio",value:function(){return this.opts.heightSegmentsRatio}},{key:"getTension",value:function(){return this.opts.tension}},{key:"buildGeometry",value:function(e,t,n,r){var i=this.opts.radius;return this.TUBE_RADIUS=new d.Vector2(i,i),Fa.prototype.buildGeometry.call(this,e,t,n,r)}}]),n}(Fa);Re()(rs,"id","TU"),rs.prototype.id="TU",rs.prototype.name="Tube",rs.prototype.shortName="Tube",rs.prototype.depGroups=["CartoonChains"];var is=rs;function os(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var as=function(e){S()(n,e);var t=os(n);function n(e){var r;return m()(this,n),(r=t.call(this,e)).secCache={},r}return y()(n,[{key:"getResidueStartRadius",value:function(e){var t=e.getSecondary();if(!t||!t.generic)return this.TUBE_RADIUS;var n=this.secCache[t.generic];return n?t.term===e?n.start:n.center:this.TUBE_RADIUS}},{key:"getResidueEndRadius",value:function(e){var t=e.getSecondary();if(null===t||!t.generic)return this.TUBE_RADIUS;var n=this.secCache[t.generic];return n?t.term===e?this.ARROW_END:n.center:this.TUBE_RADIUS}},{key:"getResidueRadius",value:function(e,t){var n=this.getResidueStartRadius(e);if(0===t)return n;var r=this.getResidueEndRadius(e);return 2===t?r:n.clone().lerp(r,t/2)}},{key:"calcStickRadius",value:function(e){return this.opts.radius}},{key:"getHeightSegmentsRatio",value:function(){return this.opts.heightSegmentsRatio}},{key:"getTension",value:function(){return this.opts.tension}},{key:"buildGeometry",value:function(e,t,n,r){var i=this.opts.radius,o=this.opts.depth;this.TUBE_RADIUS=new d.Vector2(i,i),this.ARROW_END=new d.Vector2(o,i);var a={},s=this.opts.ss;for(var l in s)a[l]={center:new d.Vector2(o,s[l].width),start:new d.Vector2(o,s[l].arrow)};return this.secCache=a,Fa.prototype.buildGeometry.call(this,e,t,n,r)}}]),n}(Fa);Re()(as,"id","CA"),as.prototype.id="CA",as.prototype.name="Cartoon",as.prototype.shortName="Cartoon",as.prototype.depGroups=["CartoonChains","NucleicSpheres","NucleicCylinders"];var ss=as;function ls(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var cs=kn.selectors;function us(){return{wireframe:this.opts.wireframe,zClip:this.opts.zClip}}var hs=function(e){S()(n,e);var t=ls(n);function n(e){var r;m()(this,n),(r=t.call(this,e)).depGroups=r.depGroups.slice(0);for(var i=r.surfaceNames,o=r.depGroups,a=0,s=i.length;a<s;++a)o[o.length]=[i[a],us];return r}return y()(n,[{key:"calcAtomRadius",value:function(e){return e.element.radius}},{key:"getVisibilitySelector",value:function(){var e=null;if(""!==this.opts.subset){var t=cs.parse(this.opts.subset);t.error||(e=t.selector)}return e}}]),n}(Fa);hs.prototype.isSurface=!0,hs.prototype.surfaceNames=[];var ds=hs;function fs(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var ps=function(e){S()(n,e);var t=fs(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"getSurfaceOpts",value:function(){return{useBeads:!1,isoValue:this.opts.isoValue,gaussLim:this.opts.gaussLim[this.settings.now.resolution],radScale:this.opts.scale,gridSpacing:this.opts.gridSpacing[this.settings.now.resolution],zClip:this.opts.zClip,visibilitySelector:this.getVisibilitySelector()}}}]),n}(ds);Re()(ps,"id","QS"),ps.prototype.id="QS",ps.prototype.name="Quick Surface",ps.prototype.shortName="Quick Surf",ps.prototype.surfaceNames=["QuickSurfGeo"];var ms=ps;function vs(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var ys=function(e){S()(n,e);var t=vs(n);function n(e,r){var i;return m()(this,n),(i=t.call(this,r))._excludeProbe=e,i}return y()(n,[{key:"calcAtomRadius",value:function(e){return e.element.radius}},{key:"getSurfaceOpts",value:function(){return{gridSpacing:this.opts.polyComplexity[this.settings.now.resolution],radScale:this._radScale,zClip:this.opts.zClip,visibilitySelector:this.getVisibilitySelector(),probeRadius:this.opts.probeRadius,excludeProbe:this._excludeProbe}}}]),n}(ds);ys.prototype.id="SU",ys.prototype.name="Surface",ys.prototype.shortName="Surface",ys.prototype.surfaceNames=["SASSESSurfaceGeo"],ys.prototype._radScale=1,ys.prototype._excludeProbe=!1;var _s=ys;function gs(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var xs=function(e){S()(n,e);var t=gs(n);function n(e){return m()(this,n),t.call(this,!1,e)}return n}(_s);Re()(xs,"id","SA"),xs.prototype.id="SA",xs.prototype.name="Solvent Accessible Surface",xs.prototype.shortName="SAS";var bs=xs;function ws(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var Ss=function(e){S()(n,e);var t=ws(n);function n(e){return m()(this,n),t.call(this,!0,e)}return n}(_s);Re()(Ss,"id","SE"),Ss.prototype.id="SE",Ss.prototype.name="Solvent Excluded Surface",Ss.prototype.shortName="SES";var Cs=Ss;function Rs(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var As=function(e){S()(n,e);var t=Rs(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"getSurfaceOpts",value:function(){return{probeRadius:this.opts.probeRadius,radScale:this.opts.polyComplexity[this.settings.now.resolution],scaleFactor:this.opts.polyComplexity[this.settings.now.resolution],gridSpacing:1/this.opts.polyComplexity[this.settings.now.resolution],isoValue:this.opts.isoValue,probePositions:this.opts.probePositions,zClip:this.opts.zClip,visibilitySelector:this.getVisibilitySelector()}}}]),n}(ds);Re()(As,"id","CS"),As.prototype.id="CS",As.prototype.name="Contact Surface",As.prototype.shortName="Contact Surf",As.prototype.isSurface=!0,As.prototype.surfaceNames=["ContactSurfaceGeo"];var Es=As;function ks(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var Ts=function(e){S()(n,e);var t=ks(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"getTemplateOptions",value:function(){return this.opts.template}},{key:"getLabelOpts",value:function(){return h.a.merge(this.opts,{colors:!0,adjustColor:!0,transparent:!0})}}]),n}(Fa);Re()(Ts,"id","TX"),Ts.prototype.id="TX",Ts.prototype.name="Text mode",Ts.prototype.shortName="Text",Ts.prototype.depGroups=["TextLabelsGeo"];var Ps=new Jn([ja,Ya,$a,Qa,ts,is,ss,ms,bs,Cs,Es,Ts]);function Ms(e,t,n){return e<=n?e<0?0:e:n}var Is=function(){function e(t,n){m()(this,e),this.name=t||"Custom",this.id=n||"CP"}return y()(e,[{key:"getElementColor",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=this.elementColors[e];return void 0!==n||t?n:this.defaultElementColor}},{key:"getResidueColor",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=this.residueColors[e];return void 0!==n||t?n:this.defaultResidueColor}},{key:"getChainColor",value:function(e){var t=e.charCodeAt(0);return t=(31&(t<0?0:t>=256?t-256:t))%this.chainColors.length,this.chainColors[t]}},{key:"getSecondaryColor",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=this.secondaryColors[e];return void 0!==n||t?n:this.defaultSecondaryColor}},{key:"getSequentialColor",value:function(e){var t=this.colors,n=t.length;return e<0?t[e%n+n]:t[e%n]}},{key:"getGradientColor",value:function(e,t){var n=this.gradients[t];if(!n)return this.defaultNamedColor;var r,i,o,a,s=n.length,l=e*(s-1),c=Math.floor(l),u=Ms(c+1,0,s-1);return c=Ms(c,0,s-1),r=n[c],i=n[u],(a=1-(o=l-c))*(r>>16&255)+o*(i>>16&255)<<16|a*(r>>8&255)+o*(i>>8&255)<<8|a*(255&r)+o*(255&i)}},{key:"getNamedColor",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=this.namedColors[e];return void 0!==n||t?n:this.defaultNamedColor}}]),e}();h.a.assign(Is.prototype,{colors:[16777215,16711680,65280,255,8421504],minRangeColor:0,midRangeColor:8355711,maxRangeColor:16777215,defaultElementColor:16777215,elementColors:{},defaultResidueColor:16777215,residueColors:{},chainColors:[16777215],defaultSecondaryColor:16777215,secondaryColors:{},defaultGradientColor:0,defaultNamedColor:16777215,namedColorsArray:[["indianred",13458524],["lightcoral",15761536],["salmon",16416882],["darksalmon",15308410],["lightsalmon",16752762],["crimson",14423100],["red",16711680],["firebrick",11674146],["darkred",9109504],["pink",16761035],["lightpink",16758465],["hotpink",16738740],["deeppink",16716947],["mediumvioletred",13047173],["palevioletred",14381203],["coral",16744272],["tomato",16737095],["orangered",16729344],["darkorange",16747520],["orange",16753920],["gold",16766720],["yellow",16776960],["lightyellow",16777184],["lemonchiffon",16775885],["lightgoldenrodyellow",16448210],["papayawhip",16773077],["moccasin",16770229],["peachpuff",16767673],["palegoldenrod",15657130],["khaki",15787660],["darkkhaki",12433259],["lavender",15132410],["thistle",14204888],["plum",14524637],["violet",15631086],["orchid",14315734],["fuchsia",16711935],["magenta",16711935],["mediumorchid",12211667],["mediumpurple",9662683],["rebeccapurple",6697881],["blueviolet",9055202],["darkviolet",9699539],["darkorchid",10040012],["darkmagenta",9109643],["purple",8388736],["indigo",4915330],["slateblue",6970061],["mediumslateblue",8087790],["darkslateblue",4734347],["greenyellow",11403055],["chartreuse",8388352],["lawngreen",8190976],["lime",65280],["limegreen",3329330],["palegreen",10025880],["lightgreen",9498256],["mediumspringgreen",64154],["springgreen",65407],["mediumseagreen",3978097],["seagreen",3050327],["forestgreen",2263842],["green",32768],["darkgreen",25600],["yellowgreen",10145074],["olivedrab",7048739],["olive",8421376],["darkolivegreen",5597999],["mediumaquamarine",6737322],["darkseagreen",9419919],["lightseagreen",2142890],["darkcyan",35723],["teal",32896],["aqua",65535],["cyan",65535],["lightcyan",14745599],["paleturquoise",11529966],["aquamarine",8388564],["turquoise",4251856],["mediumturquoise",4772300],["darkturquoise",52945],["cadetblue",6266528],["steelblue",4620980],["lightsteelblue",11584734],["powderblue",11591910],["lightblue",11393254],["skyblue",8900331],["lightskyblue",8900346],["deepskyblue",49151],["dodgerblue",2003199],["cornflowerblue",6591981],["royalblue",4286945],["blue",255],["mediumblue",205],["darkblue",139],["navy",128],["midnightblue",1644912],["cornsilk",16775388],["blanchedalmond",16772045],["bisque",16770244],["navajowhite",16768685],["wheat",16113331],["burlywood",14596231],["tan",13808780],["rosybrown",12357519],["sandybrown",16032864],["goldenrod",14329120],["darkgoldenrod",12092939],["peru",13468991],["chocolate",13789470],["saddlebrown",9127187],["sienna",10506797],["brown",10824234],["maroon",8388608],["white",16777215],["snow",16775930],["honeydew",15794160],["mintcream",16121850],["azure",15794175],["aliceblue",15792383],["ghostwhite",16316671],["whitesmoke",16119285],["seashell",16774638],["beige",16119260],["oldlace",16643558],["floralwhite",16775920],["ivory",16777200],["antiquewhite",16444375],["linen",16445670],["lavenderblush",16773365],["mistyrose",16770273],["gainsboro",14474460],["lightgray",13882323],["silver",12632256],["darkgray",11119017],["gray",8421504],["dimgray",6908265],["lightslategray",7833753],["slategray",7372944],["darkslategray",3100495],["black",0]],namedColors:{},gradients:{rainbow:[255,65535,65280,16776960,16711680],temp:[255,32767,16777215,16744192,16711680],hot:[16777215,16744192,16711680],cold:[16777215,32767,255],"blue-red":[255,16777215,16711680],reds:[16777215,16711680],blues:[16777215,255]}});for(var Ns=Is.prototype,Ls=Ns.namedColorsArray,Ds=Ns.namedColors,Os=0,Vs=Ls.length;Os<Vs;++Os){var zs=c()(Ls[Os],2),Fs=zs[0],Bs=zs[1];Ds[Fs]=Bs}var Us=Is,Gs=new Us("CPK","CP");Gs.elementColors={H:16777215,C:2105376,N:2121983,O:15605776,F:65280,P:8397055,S:16776960,CL:47872,FE:13684944,CO:13684944,NI:13684944,CU:13684944,BR:34816,I:21760};var js,Hs=Gs,Ws=new Us("Jmol","JM");Ws.colors=[255,22015,44031,65535,65451,65365,65280,5635840,11271936,16776960,16755456,16733440,16711680,16711765,16711851,16711935,11206911,5570815],Ws.elementColors={H:16777215,D:16777152,T:16777120,HE:14286847,LI:13402367,BE:12779264,B:16758197,C:9474192,N:3166456,O:16715021,F:9494608,NE:11789301,NA:11230450,MG:9109248,AL:12560038,SI:1578e4,P:16744448,S:16777008,CL:2093087,AR:8442339,K:9388244,CA:4062976,SC:15132390,TI:12567239,V:10921643,CR:9083335,MN:10255047,FE:14706227,CO:15765664,NI:5296208,CU:13140019,ZN:8224944,GA:12750735,GE:6721423,AS:12419299,SE:16752896,BR:10889513,KR:6076625,RB:7351984,SR:65280,Y:9764863,ZR:9756896,NB:7586505,MO:5551541,TC:3907230,RU:2396047,RH:687500,PD:27013,AG:12632256,CD:16767375,IN:10909043,SN:6717568,SB:10380213,TE:13924864,I:9699476,XE:4366e3,CS:5707663,BA:51456,LA:7394559,CE:16777159,PR:14286791,ND:13107143,PM:10747847,SM:9437127,EU:6422471,GD:4587463,TB:3211207,DY:2097095,HO:65436,ER:58997,TM:54354,YB:48952,LU:43812,HF:5096191,TA:5089023,W:2200790,RE:2522539,OS:2516630,IR:1528967,PT:13684960,AU:16765219,HG:12105936,TL:10900557,PB:5724513,BI:10375093,PO:11230208,AT:7688005,RN:4358806,FR:4325478,RA:32e3,AC:7384058,TH:47871,PA:41471,U:36863,NP:33023,PU:27647,AM:5528818,CM:7888099,BK:9064419,CF:10565332,ES:11739092,FM:11739066,MD:11734438,NO:12389767,LR:13041766,RF:13369433,DB:13697103,SG:14221381,BH:14680120,HS:15073326,MT:15400998},Ws.defaultResidueColor=12492910,Ws.residueColors={ALA:13158600,ARG:1334015,ASN:56540,ASP:15075850,CYS:15132160,GLN:56540,GLU:15075850,GLY:15461355,HIS:8553170,ILE:1016335,LEU:1016335,LYS:1334015,MET:15132160,PHE:3289770,PRO:14456450,SER:16422400,THR:16422400,TRP:11819700,TYR:3289770,VAL:1016335,A:10526975,C:16747595,G:16740464,I:8454143,T:10551200,U:16744576,DA:10526975,DC:16747595,DG:16740464,DI:8454143,DT:10551200,DU:16744576,"+A":10526975,"+C":16747595,"+G":16740464,"+I":8454143,"+T":10551200,"+U":16744576},Ws.chainColors=[4294967295,4290826495,4289789872,4294951112,4294967168,4294951167,4289786096,4294955120,4293951616,4294303411,4278239231,4291648604,4284927402,4288335154,4293821166,4278243025,4278255487,4282168177,4278190219,4290623339,4278215680,4286578688,4286611456,4286578816,4278222976,4290283019,4289864226];var Ys=Qe.Type;Ws.secondaryColors=(js={},Re()(js,Ys.HELIX_ALPHA,16711808),Re()(js,Ys.HELIX_PI,6291584),Re()(js,Ys.HELIX_310,10485888),Re()(js,Ys.STRAND,16762880),Re()(js,Ys.TURN,6324479),Re()(js,"dna",11403518),Re()(js,"rna",16580962),js);var qs,Xs=Ws,$s=new Us("VMD","VM");$s.colors=[255,16711680,6316128,16744448,16776960,8421427,10066329,65280,16777215,16751001,4243648,10879142,8447590,15099571,8408320,8421568],$s.defaultElementColor=8408320,$s.elementColors={H:16777215,C:4243391,N:255,O:16711680,P:8421427,S:16776960},$s.defaultResidueColor=4243648,$s.residueColors={ALA:255,ARG:16777215,ASN:8421427,ASP:16711680,CYS:16776960,GLN:16744448,GLU:16751001,GLY:16777215,HIS:4243648,ILE:65280,LEU:16751001,LYS:4243648,MET:16776960,PHE:10879142,PRO:8408064,SER:16776960,THR:15099571,TRP:10066329,TYR:65280,VAL:8421427,A:255,C:16744448,G:16776960,T:10879142,U:65280,DA:255,DC:16744448,DG:16776960,DT:10879142,DU:65280,"+A":255,"+C":16744448,"+G":16776960,"+T":10879142,"+U":65280,WAT:4243648,H2O:4243648,HOH:4243648},$s.chainColors=[16777215].concat($s.colors);var Ks=Qe.Type;$s.secondaryColors=(qs={},Re()(qs,Ks.HELIX_ALPHA,10879142),Re()(qs,Ks.HELIX_310,255),Re()(qs,Ks.HELIX_PI,16711680),Re()(qs,Ks.STRAND,16776960),Re()(qs,Ks.BRIDGE,8421427),Re()(qs,Ks.TURN,4243648),qs);var Zs=new Jn([Hs,Xs,$s]),Qs=function(){function e(t){if(m()(this,e),this.constructor===e)throw new Error("Can not instantiate abstract class!");this.opts=h.a.merge(K.deriveDeep(re.now.colorers[this.id],!0),t),this.palette=Zs.first}return y()(e,[{key:"identify",value:function(){var e=K.objectsDiff(this.opts,re.now.colorers[this.id]);return h.a.isEmpty(e)?this.id:[this.id,e]}}]),e}();Qs.prototype.id="__";var Js=Qs;function el(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var tl=function(e){S()(n,e);var t=el(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"getAtomColor",value:function(e,t){var n=e.element.name;return"C"===n&&this.opts.carbon>=0?this.opts.carbon:this.palette.getElementColor(n)}},{key:"getResidueColor",value:function(e,t){return this.palette.defaultResidueColor}}]),n}(Js);Re()(tl,"id","EL"),tl.prototype.id="EL",tl.prototype.name="Element",tl.prototype.shortName="Element";var nl=tl;function rl(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var il=function(e){S()(n,e);var t=rl(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"getAtomColor",value:function(e,t){return this.getResidueColor(e.residue,t)}},{key:"getResidueColor",value:function(e,t){return this.palette.getResidueColor(e._type._name)}}]),n}(Js);Re()(il,"id","RT"),il.prototype.id="RT",il.prototype.name="Residue Type",il.prototype.shortName="Residue";var ol=il;function al(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var sl=function(e){S()(n,e);var t=al(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"getAtomColor",value:function(e,t){return this.getResidueColor(e.residue,t)}},{key:"getResidueColor",value:function(e,t){var n=e._chain;if(n.minSequence===Number.POSITIVE_INFINITY&&n.maxSequence===Number.NEGATIVE_INFINITY)return this.palette.defaultNamedColor;var r=n.minSequence,i=n.maxSequence>r?n.maxSequence:r+1;return this.palette.getGradientColor((e._sequence-r)/(i-r),this.opts.gradient)}}]),n}(Js);Re()(sl,"id","SQ"),sl.prototype.id="SQ",sl.prototype.name="Sequence",sl.prototype.shortName="Sequence";var ll=sl;function cl(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var ul=function(e){S()(n,e);var t=cl(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"getAtomColor",value:function(e,t){return this.getResidueColor(e.residue,t)}},{key:"getResidueColor",value:function(e,t){return this.palette.getChainColor(e.getChain()._name)}}]),n}(Js);Re()(ul,"id","CH"),ul.prototype.id="CH",ul.prototype.name="Chain",ul.prototype.shortName="Chain";var hl=ul;function dl(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var fl=function(e){S()(n,e);var t=dl(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"getAtomColor",value:function(e,t){return this.getResidueColor(e.residue,t)}},{key:"getResidueColor",value:function(e,t){if(e._type.flags&He.Flags.DNA)return this.palette.getSecondaryColor("dna");if(e._type.flags&He.Flags.RNA)return this.palette.getSecondaryColor("rna");var n=e.getSecondary();if(n){var r=this.palette.getSecondaryColor(n.type,!0);return void 0===r&&(r=this.palette.getSecondaryColor(n.generic)),r}return this.palette.defaultSecondaryColor}}]),n}(Js);Re()(fl,"id","SS"),fl.prototype.id="SS",fl.prototype.name="Secondary Structure",fl.prototype.shortName="Structure";var pl=fl;function ml(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var vl=function(e){S()(n,e);var t=ml(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"getAtomColor",value:function(e,t){return this.opts.color}},{key:"getResidueColor",value:function(e,t){return this.opts.color}}]),n}(Js);Re()(vl,"id","UN"),vl.prototype.id="UN",vl.prototype.name="Uniform",vl.prototype.shortName="Uniform";var yl=vl;function _l(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var gl=function(e){S()(n,e);var t=_l(n);function n(e){var r;m()(this,n),r=t.call(this,e);var i=Ot.parse(r.opts.subset);return r._subsetCached=i.error?Ot.none():i.selector,r}return y()(n,[{key:"getAtomColor",value:function(e,t){return this._subsetCached.includesAtom(e)?this.opts.color:this.opts.baseColor}},{key:"getResidueColor",value:function(e,t){for(var n=this._subsetCached,r=e._atoms,i=0,o=r.length;i<o;++i)if(!n.includesAtom(r[i]))return this.opts.baseColor;return this.opts.color}}]),n}(Js);Re()(gl,"id","CO"),gl.prototype.id="CO",gl.prototype.name="Conditional",gl.prototype.shortName="Conditional";var xl=gl;function bl(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var wl=function(e){S()(n,e);var t=bl(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"getAtomColor",value:function(e,t){return this.palette.getChainColor(String.fromCharCode(e.location))}},{key:"getResidueColor",value:function(e,t){return this.palette.defaultResidueColor}}]),n}(Js);Re()(wl,"id","CF"),wl.prototype.id="CF",wl.prototype.name="Conformation",wl.prototype.shortName="Conformation";var Sl=wl;function Cl(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var Rl=function(e){S()(n,e);var t=Cl(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"getAtomColor",value:function(e,t){var n=this.opts,r=1;return e.temperature&&n?(r=n.min===n.max?e.temperature>n.max?1:0:(e.temperature-n.min)/(n.max-n.min),this.palette.getGradientColor(r,n.gradient)):this.palette.defaultGradientColor}},{key:"getResidueColor",value:function(e,t){var n=this.opts;if(!n)return this.palette.defaultGradientColor;if(e.temperature){var r=0;return r=n.min===n.max?e.temperature>n.max?1:0:(e.temperature-n.min)/(n.max-n.min),this.palette.getGradientColor(r,n.gradient)}return this.palette.defaultGradientColor}}]),n}(Js);Re()(Rl,"id","TM"),Rl.prototype.id="TM",Rl.prototype.name="Temperature",Rl.prototype.shortName="Temperature";var Al=Rl;function El(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var kl=function(e){S()(n,e);var t=El(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"_getColorByOccupancy",value:function(e,t){if(void 0!==e){var n=1-e;return this.palette.getGradientColor(n,t.gradient)}return this.palette.defaultGradientColor}},{key:"getAtomColor",value:function(e,t){var n=this.opts;return this._getColorByOccupancy(e.occupancy,n)}},{key:"getResidueColor",value:function(e,t){var n=this.opts;return this._getColorByOccupancy(e.occupancy,n)}}]),n}(Js);Re()(kl,"id","OC"),kl.prototype.id="OC",kl.prototype.name="Occupancy",kl.prototype.shortName="Occupancy";var Tl=kl;function Pl(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var Ml=function(e){S()(n,e);var t=Pl(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"getAtomColor",value:function(e,t){return this.getResidueColor(e.residue,t)}},{key:"getResidueColor",value:function(e,t){var n=this.palette.defaultResidueColor;if(void 0!==e._type.hydrophobicity){n=this.palette.getGradientColor((e._type.hydrophobicity- -4.5)/9,this.opts.gradient)}return n}}]),n}(Js);Re()(Ml,"id","HY"),Ml.prototype.id="HY",Ml.prototype.name="Hydrophobicity",Ml.prototype.shortName="Hydrophobicity";var Il=Ml;function Nl(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var Ll=function(e){S()(n,e);var t=Nl(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"getAtomColor",value:function(e,t){return this.getResidueColor(e.residue,t)}},{key:"getResidueColor",value:function(e,t){var n=e._molecule,r=t.getMoleculeCount();return r>1?this.palette.getGradientColor((n.index-1)/(r-1),this.opts.gradient):this.palette.getGradientColor(0,this.opts.gradient)}}]),n}(Js);Re()(Ll,"id","MO"),Ll.prototype.id="MO",Ll.prototype.name="Molecule",Ll.prototype.shortName="Molecule";var Dl=Ll;function Ol(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var Vl=function(e){S()(n,e);var t=Ol(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"getAtomColor",value:function(e,t){var n,r,i=this.opts.color,o=(n=i,(r=this.opts.factor)*(n>>16&255)<<16|r*(n>>8&255)<<8|r*(255&n));return e.flags&Ee.Flags.CARBON?i:o}},{key:"getResidueColor",value:function(e,t){return this.opts.color}}]),n}(Js);Re()(Vl,"id","CB"),Vl.prototype.id="CB",Vl.prototype.name="Carbon",Vl.prototype.shortName="Carbon";var zl=new Jn([nl,ol,ll,hl,pl,yl,xl,Sl,Al,Tl,Il,Dl,Vl]);function Fl(e){return new d.Color(e,e,e)}var Bl,Ul=new Jn([{id:"DF",name:"Diffuse",shortName:"Diffuse",uberOptions:{diffuse:Fl(1),specular:Fl(0),shininess:1,opacity:1},values:{lights:!0,fog:!0,depthWrite:!0,transparent:!1,toonShading:!1}},{id:"SF",name:"Soft Plastic",shortName:"Soft",uberOptions:{diffuse:Fl(1),specular:Fl(.1),shininess:30,opacity:1},values:{lights:!0,fog:!0,depthWrite:!0,transparent:!1,toonShading:!1}},{id:"PL",name:"Glossy Plastic",shortName:"Glossy",uberOptions:{diffuse:Fl(.56),specular:Fl(.28),shininess:100,opacity:1},values:{lights:!0,fog:!0,depthWrite:!0,transparent:!1,toonShading:!1}},{id:"ME",name:"Metal",shortName:"Metal",uberOptions:{diffuse:Fl(.56),specular:Fl(.55),shininess:30,opacity:1},values:{lights:!0,fog:!0,depthWrite:!0,transparent:!1,toonShading:!1}},{id:"TR",name:"Transparent",shortName:"Transparent",uberOptions:{diffuse:Fl(1),specular:Fl(0),shininess:1,opacity:.5},values:{lights:!0,fog:!0,depthWrite:!0,transparent:!0,toonShading:!1}},{id:"GL",name:"Glass",shortName:"Glass",uberOptions:{diffuse:Fl(.5),specular:Fl(.65),shininess:100,opacity:.5},values:{lights:!0,fog:!0,depthWrite:!0,transparent:!0,toonShading:!1}},{id:"BA",name:"Backdrop",shortName:"Backdrop",uberOptions:{diffuse:Fl(1),specular:Fl(0),shininess:1,opacity:1},values:{lights:!1,fog:!1,depthWrite:!1,transparent:!1,toonShading:!1}},{id:"TN",name:"Toon",shortName:"Toon",uberOptions:{diffuse:Fl(1),specular:Fl(0),shininess:1,opacity:1},values:{lights:!0,fog:!0,depthWrite:!0,transparent:!1,toonShading:!0}},{id:"FL",name:"Flat",shortName:"Flat",uberOptions:{diffuse:Fl(1),specular:Fl(0),shininess:0,opacity:1},values:{lights:!1,fog:!0,depthWrite:!0,transparent:!1}}]);function Gl(e,t,n){var r=e.material.createInstance();r.setValues(t);var i=new e.constructor(e.geometry,r);return i.material.needsUpdate=!0,i.applyMatrix4(e.matrix),i.layers.set(n),i}function jl(e,t,n){for(var r=function(e,t){var n=[];return e.traverse((function(e){for(var r=0;r<t.length;r++)if(e instanceof t[r]){n[n.length]=e;break}})),n}(e,t),i=0,o=r.length;i<o;++i){var a=r[i];a.parent&&n(a)}}function Hl(e,t){!function e(n){n instanceof d.Mesh&&t(n);for(var r=0,i=n.children.length;r<i;r++)e(n.children[r])}(e)}var Wl={applyTransformsToMeshes:function(e,t){var n=t.length;n<1||jl(e,[d.Mesh,d.LineSegments,d.Line],(function(e){e.applyMatrix4(t[0]);for(var r=1;r<n;++r){var i=new e.constructor(e.geometry,e.material);e.parent.add(i),i.applyMatrix4(t[r])}}))},processTransparentMaterial:(Bl={prepassTransparancy:!0,fakeOpacity:!1,transparent:!1,colorFromDepth:!1,lights:!1,shadowmap:!1,fog:!1},function(e,t){t instanceof Zi&&jl(e,[d.Mesh,d.LineSegments],(function(e){e.material.setValues({prepassTransparancy:!1,fakeOpacity:!1}),e.material.needsUpdate=!0,e.layers.set(Yn.LAYERS.TRANSPARENT);var t=Gl(e,Bl,Yn.LAYERS.PREPASS_TRANSPARENT);e.parent.add(t)}))}),processColFromPosMaterial:function(){var e={colorFromPos:!0,transparent:!1,colorFromDepth:!1,lights:!1,shadowmap:!1,fog:!1,overrideColor:!1,fogTransparent:!1,attrColor:!1,attrColor2:!1,attrAlphaColor:!1,fakeOpacity:!1};return function(t,n){n instanceof Zi&&jl(t,[d.Mesh,d.LineSegments],(function(t){var n=Gl(t,e,Yn.LAYERS.COLOR_FROM_POSITION);t.parent.add(n)}))}}(),createShadowmapMaterial:function(){var e={colorFromDepth:!0,orthoCam:!0,lights:!1,shadowmap:!1,fog:!1};return function(t,n){n instanceof Zi&&jl(t,[d.Mesh,d.LineSegments],(function(t){if(!t.receiveShadow&&t.material.shadowmap&&t.material.setValues({shadowmap:!1}),t.material.lights&&t.castShadow&&Yn.belongToSelectLayers(t)){var n=Gl(t,e,Yn.LAYERS.SHADOWMAP);n.isShadowmapMesh=!0,t.parent.add(n)}}))}}(),removeShadowmapMaterial:function(e,t){t instanceof Zi&&jl(e,[d.Mesh,d.LineSegments],(function(e){e.isShadowmapMesh&&e.parent.remove(e)}))},forEachMeshInGroup:Hl,countTriangles:function(e){var t=0;return Hl(e,(function(e){t+=function(e){var t=e.geometry;if(t instanceof d.InstancedBufferGeometry){var n=t.attributes;for(var r in n)if(n.hasOwnProperty(r)&&n[r]instanceof d.InstancedBufferAttribute){var i=n[r];return(t.index?t.index.array.length/3:0)*i.array.length/i.itemSize}return 0}return t instanceof d.BufferGeometry?t.index?t.index.array.length/3:0:t.faces?t.faces.length:0}(e)})),t}},Yl=kn.selectors,ql=function(){function e(t,n,r,i){m()(this,e);var o={clipPlane:re.now.draft.clipPlane,fogTransparent:re.now.bg.transparent,shadowmap:re.now.shadow.on,shadowmapType:re.now.shadow.type};this.index=t,this.mode=n,this.colorer=r,this.selector=i,this.selectorString="",this.count=0,this.material=new Zi,this.material.setValues(o),this.material.setUberOptions({fogAlpha:re.now.fogAlpha}),this.materialPreset=Ul.first,this.needsRebuild=!0,this.visible=!0,this.setMode(n)}return y()(e,[{key:"markAtoms",value:function(e){return this.count=e.markAtoms(this.selector,1<<this.index),this.needsRebuild=!0,this.count}},{key:"unmarkAtoms",value:function(e){e.clearAtomBits(1<<this.index),this.count=0}},{key:"setMode",value:function(e){this.mode=e}},{key:"setMaterialPreset",value:function(e){this.materialPreset=e,this.material.setUberOptions(e.uberOptions),this.material.setValues(e.values)}},{key:"reset",value:function(){this.geo=null,this.selectionGeo=null}},{key:"buildGeometry",value:function(e){return this.reset(),this.needsRebuild=!1,re.now.ao&&this.material.setValues({normalsToGBuffer:re.now.ao}),this.geo=this.mode.buildGeometry(e,this.colorer,1<<this.index,this.material),this.material.uberOptions.opacity<.99&&"prepass"===re.now.transparency&&Wl.processTransparentMaterial(this.geo,this.material),this.geo.visible=this.visible,Yn.processObjRenderOrder(this.geo,this.materialPreset.id),Wl.processColFromPosMaterial(this.geo,this.material),re.now.shadow.on&&Wl.createShadowmapMaterial(this.geo,this.material),this.geo}},{key:"buildSelectionGeometry",value:function(e){var t=null;if(this.geo&&"getSubset"in this.geo){var n=this.geo.getSubset(e);if(n&&n.length>0){(t=new d.Group).matrixAutoUpdate=!1,t.matrix=this.geo.matrix;for(var r=0;r<n.length;r++){var i=n[r];t.add(i)}}}return t&&(t.visible=this.visible),this.selectionGeo=t,this.selectionGeo}},{key:"compare",value:function(e){var t={},n=String(this.selector);e&&n.valueOf()===String(e.selector).valueOf()||(t.selector=n);var r=this.mode.identify();e&&!Array.isArray(r)&&r===e.mode||(t.mode=r);var i=this.colorer.identify();return e&&!Array.isArray(i)&&i===e.colorer||(t.colorer=i),e&&this.materialPreset.id===e.material||(t.material=this.materialPreset.id),t}},{key:"change",value:function(e,t,n,r){var i={};if(e.selector){var o=Yl.parse(e.selector).selector,a=String(o);this.selectorString!==a&&(i.selector=a,this.selectorString=a,this.selector=o,this.markAtoms(t))}if(e.mode){var s=e.mode;h.a.isEqual(this.mode.identify(),s)||(i.mode=s,this.setMode(n))}if(e.colorer){var l=e.colorer;h.a.isEqual(this.colorer.identify(),l)||(i.colorer=l,this.colorer=r)}if(e.material){var c=e.material;h.a.isEqual(this.materialPreset.id,c)||(i.material=c,this.setMaterialPreset(Ul.get(e.material)))}return i}},{key:"show",value:function(e){this.visible=e,this.geo&&(this.geo.visible=e),this.selectionGeo&&(this.selectionGeo.visible=e)}}]),e}();function Xl(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}function $l(){}var Kl={ComponentEditor:function(e){S()(n,e);var t=Xl(n);function n(e){var r;return m()(this,n),(r=t.call(this))._complexVisual=e,r._inProgress=!1,r}return y()(n,[{key:"begin",value:function(){var e=this._complexVisual.getComplex();this._componentTransforms=[];for(var t=0;t<e._components.length;++t){var n=e._components[t];this._componentTransforms[n._index]=new d.Object3D}return this._inProgress=!0,!0}},{key:"apply",value:function(){if(this._inProgress){for(var e=this._complexVisual.getComplex(),t=0;t<e._components.length;++t)this._bakeComponentTransform(e._components[t]);e.onAtomPositionChanged(),this._resetComponentTransform(),this._complexVisual.finalizeEdit()}}},{key:"discard",value:function(){this._inProgress&&(this._resetComponentTransform(),this._complexVisual.finalizeEdit())}},{key:"getAltObj",value:function(){var e={objects:[],pivot:new d.Vector3(0,0,0)},t=this._complexVisual,n=t.getSelectedComponent();if(null===n)return e;var r,i,o,a,s=this._complexVisual.getSelectionGeo(),l=1<<t.getSelectionBit();for(function e(t,n,r){var i=t.children;if(i)for(var o=0,a=i.length;o<a;++o){var s=i[o];s._component===n&&r(s),s instanceof Yn.RCGroup&&e(s,n,r)}}(t,n,(function(t){e.objects.push(t)})),r=0;r<s.children.length;++r)for(o=s.children[r],i=0;i<o.children.length;++i)(a=o.children[i]).hasOwnProperty("_component")&&a._component===n&&e.objects.push(a);e.objects.push(this._componentTransforms[n._index]);var c=new d.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),u=new d.Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return n.forEachResidue((function(e){var t=e._atoms;for(i=0;i<t.length;++i)t[i].mask&l&&(c.min(t[i].position),u.max(t[i].position))})),e.pivot.lerpVectors(c,u,.5),e}},{key:"_bakeComponentTransform",value:function(e){var t=this._componentTransforms[e._index];!t||0===t.position.x&&0===t.position.y&&0===t.position.z&&0===t.quaternion.x&&0===t.quaternion.y&&0===t.quaternion.z&&1===t.quaternion.w||(t.updateMatrix(),e.forEachResidue((function(e){for(var n=e._atoms,r=0;r<n.length;++r)n[r].position.applyMatrix4(t.matrix)})))}},{key:"_resetComponentTransform",value:function(){var e,t,n,r,i=this._complexVisual,o=this._complexVisual.getSelectionGeo();for(e=0;e<this._componentTransforms.length;++e)(r=this._componentTransforms[e]).position.set(0,0,0),r.quaternion.set(0,0,0,1);for(e=0;e<i.children.length;++e)for(n=i.children[e],t=0;t<n.children.length;++t)(r=n.children[t]).hasOwnProperty("_component")&&(r.position.set(0,0,0),r.quaternion.set(0,0,0,1));for(e=0;e<o.children.length;++e)for(n=o.children[e],t=0;t<n.children.length;++t)(r=n.children[t]).hasOwnProperty("_component")&&(r.position.set(0,0,0),r.quaternion.set(0,0,0,1))}}]),n}($l),FragmentEditor:function(e){S()(n,e);var t=Xl(n);function n(e){var r;return m()(this,n),(r=t.call(this))._complexVisual=e,r._inProgress=!1,r}return y()(n,[{key:"begin",value:function(){var e=this._complexVisual,t=this._complexVisual.getSelectionGeo(),n=this._getSelectionBorderAtoms();if(n.length<1||n.length>2)return O.error("Can only edit fragments with one or two bound atoms."),!1;this._fragmentBoundAtoms=n;var r=1<<e.getSelectionBit();e.disableSubset(r,!0);for(var i=0;i<t.children.length;++i)t.children[i].visible=!1;var o=n[0].position.clone();2===n.length&&o.lerp(n[1].position,.5),this._fragmentGeo=new d.Group,e.add(this._fragmentGeo),this._fragmentGeo.position.copy(o),this._fragmentSelectionGeo=new d.Group,t.add(this._fragmentSelectionGeo),this._fragmentSelectionGeo.position.copy(o);var a=o.clone();a.negate();for(var s=0;s<e.children.length;++s){var l=e.children[s];if("getSubset"in l){var c=new d.Group;this._fragmentGeo.add(c);var u=new d.Group;this._fragmentSelectionGeo.add(u);for(var h=l.getSubset(r,!0),f=0;f<h.length;f++){var p=h[f];c.add(p),p.position.copy(a)}for(var m=l.getSubset(r,!0),v=0;v<m.length;v++){var y=m[v];u.add(y),y.position.copy(a)}}}return Yn.applySelectionMaterial(this._fragmentSelectionGeo),this._inProgress=!0,!0}},{key:"apply",value:function(){if(this._inProgress){var e=this._complexVisual,t=e.getSelectionBit(),n=this._fragmentGeo.position,r=this._fragmentGeo.matrix.clone();r.multiply((new d.Matrix4).makeTranslation(-n.x,-n.y,-n.z)),this._bakeAtomTransform(r,1<<t),e.enableSubset(1<<t,!0),e.getComplex().onAtomPositionChanged(),e.finalizeEdit()}}},{key:"discard",value:function(){if(this._inProgress){var e=this._complexVisual,t=this._complexVisual.getSelectionGeo();this._fragmentGeo.parent.remove(this._fragmentGeo),e.enableSubset(1<<e.getSelectionBit(),!0);for(var n=0;n<t.children.length;++n){var r=t.children[n];r.visible?t.remove(r):r.visible=!0}e.finalizeEdit()}}},{key:"isFreeRotationAllowed",value:function(){return this._fragmentBoundAtoms.length<2}},{key:"getAltObj",value:function(){var e={objects:[],pivot:new d.Vector3(0,0,0)};e.objects.push(this._fragmentGeo,this._fragmentSelectionGeo);var t=this._fragmentBoundAtoms;if(1===t.length){if(1===t[0].bonds.length){var n=t[0].bonds[0];e.axis=(new d.Vector3).subVectors(n._right.position,n._left.position),e.axis.normalize(),e.axis.transformDirection(this._complexVisual.matrixWorld)}}else 2===t.length&&(e.axis=(new d.Vector3).subVectors(t[1].position,t[0].position),e.axis.normalize(),e.axis.transformDirection(this._complexVisual.matrixWorld));return e}},{key:"_getSelectionBorderAtoms",value:function(){var e=this._complexVisual.getComplex(),t=1<<this._complexVisual.getSelectionBit(),n={};e.forEachBond((function(e){e._left.mask&t?0==(e._right.mask&t)&&(n[e._left.index]=1):e._right.mask&t&&(n[e._right.index]=1)}));for(var r=[],i=Object.keys(n),o=0,a=i.length;o<a;++o){var s=i[o];r.push(e._atoms[s])}return r}},{key:"_bakeAtomTransform",value:function(e,t){this._complexVisual.getComplex().forEachAtom((function(n){n.mask&t&&n.position.applyMatrix4(e)}))}}]),n}($l)};function Zl(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var Ql=kn.selectors;function Jl(e,t){Array.isArray(t)||(t=[t]);var n=t,r=c()(n,2),i=r[0],o=r[1];return new(e.get(i)||e.first)(o)}var ec=function(e){S()(n,e);var t=Zl(n);function n(e,r){var i;return m()(this,n),(i=t.call(this,e,r))._complex=r,i._reprList=[],i._repr=null,i._reprListChanged=!0,i._selectionBit=0,i._reprUsedBits=0,i._selectionCount=0,i._selectionGeometry=new d.Group,i}return y()(n,[{key:"getBoundaries",value:function(){return this._complex.getBoundaries()}},{key:"release",value:function(){this._selectionGeometry.parent&&this._selectionGeometry.remove(this._selectionGeometry),$n.prototype.release.call(this)}},{key:"getComplex",value:function(){return this._complex}},{key:"getSelectionCount",value:function(){return this._selectionCount}},{key:"getSelectionGeo",value:function(){return this._selectionGeometry}},{key:"getSelectionBit",value:function(){return this._selectionBit}},{key:"getEditor",value:function(){return this._editor}},{key:"resetReps",value:function(e){this._complex&&this._complex.clearAtomBits(-1),this._reprListChanged=!0,this._reprUsedBits=0,this._reprList.length=e.length;for(var t=0,n=e.length;t<n;++t){var r=e[t],i=void 0,o=void 0;if("string"==typeof r.selector)o=r.selector,i=Ql.parse(o).selector;else if(void 0===r.selector){o=re.now.presets.default[0].selector,i=Ql.parse(o).selector}else o=(i=r.selector).toString();var a=Jl(Ps,r.mode),s=Jl(zl,r.colorer),l=Ul.get(r.material)||Ul.first;this._reprList[t]=new ql(t,a,s,i),this._reprList[t].setMaterialPreset(l),this._reprList[t].selectorString=o,this._complex&&this._complex.markAtoms(i,1<<t),this._reprUsedBits|=1<<t}this._repr=e.length>0?this._reprList[0]:null,this._selectionBit=e.length,this._reprUsedBits|=1<<this._selectionBit,this._selectionCount=0,this._complex&&this._complex.update()}},{key:"repCount",value:function(){return this._reprList.length}},{key:"repCurrent",value:function(e){return e>=0&&e<this._reprList.length?this._repr=this._reprList[e]:e=this._reprList.indexOf(this._repr),e}},{key:"rep",value:function(e,t){if(!t&&(void 0===e||e instanceof Object)&&(t=e,e=this.repCurrent()),e<0||e>this._reprList.length)return O.error("Rep ".concat(e," does not exist!")),null;if(e===this._reprList.length){var n=this.repAdd(t);return O.warn("Rep ".concat(e," does not exist! New representation was created.")),{desc:n.desc,index:e,status:"created"}}var r=this._reprList[e],i={selector:r.selectorString,mode:r.mode.identify(),colorer:r.colorer.identify(),material:r.materialPreset.id};if(t){var o=r.change(t,this._complex,Jl(Ps,t.mode),Jl(zl,t.colorer));if(!h.a.isEmpty(o)){for(var a in r.needsRebuild=!0,o)o.hasOwnProperty(a)&&(i[a]=o[a],O.debug("rep[".concat(e,"].").concat(a," changed to ").concat(o[a])));return o.mode&&r.mode.isSurface&&("ultra"===re.now.resolution||"high"===re.now.resolution)&&(O.report('Surface resolution was changed to "medium" to avoid hang-ups.'),re.set("resolution","medium")),{desc:i,index:e,status:"changed"}}}return{desc:i,index:e,status:""}}},{key:"repGet",value:function(e){return(void 0===e||e instanceof Object)&&(e=this.repCurrent()),e<0||e>=this._reprList.length?null:this._reprList[e]}},{key:"_getFreeReprIdx",value:function(){for(var e=this._reprUsedBits,t=0;t<=n.NUM_REPRESENTATION_BITS;++t,e>>=1)if(0==(1&e))return t;return-1}},{key:"repAdd",value:function(e){if(this._reprList.length>=n.NUM_REPRESENTATION_BITS)return null;var t=this._getFreeReprIdx();if(t<0)return null;var r=this.buildSelectorFromMask(1<<this._selectionBit),i=re.now.presets.default[0],o=h.a.merge({selector:i.selector,mode:i.mode,colorer:i.colorer,material:i.material},e),a="string"==typeof o.selector?Ql.parse(o.selector).selector:o.selector,s=new ql(this._selectionBit,Jl(Ps,o.mode),Jl(zl,o.colorer),a);return s.selectorString=a.toString(),s.setMaterialPreset(Ul.get(o.material)),s.markAtoms(this._complex),this._reprList.push(s),this._selectionBit=t,this._reprUsedBits|=1<<this._selectionBit,this._complex.markAtoms(r,1<<this._selectionBit),{desc:o,index:this._reprList.length-1}}},{key:"repRemove",value:function(e){void 0===e&&(e=this.repCurrent());var t=this._reprList.length;if(!(e<0||e>=t||t<=1)){var n=this._reprList[e];n.unmarkAtoms(this._complex),this._reprUsedBits&=~(1<<n.index),this._reprList.splice(e,1),n===this._repr&&(e=e<--t?e:t-1,this._repr=this._reprList[e]),this._reprListChanged=!0}}},{key:"repHide",value:function(e,t){(void 0===t&&(t=!0),e<0||e>=this._reprList.length)||this._reprList[e].show(!t)}},{key:"select",value:function(e,t){t?this._selectionCount+=this._complex.markAtomsAdditionally(e,1<<this._selectionBit):this._selectionCount=this._complex.markAtoms(e,1<<this._selectionBit),this._complex.updateStructuresMask(),this.rebuildSelectionGeometry()}},{key:"resetSelectionMask",value:function(){0!==this._selectionCount&&(this._selectionCount=0,this._complex&&this._complex.clearAtomBits(1<<this._selectionBit))}},{key:"updateSelectionMask",value:function(e){var t=this,n=e.atom,r=e.residue,i=e.chain,o=e.molecule,a=1<<this._selectionBit,s=~a;if(n)r=n.residue,i=r._chain,o=r._molecule,n.mask&a?(n.mask&=s,r._mask&=s,i._mask&=s,o&&(o.mask&=s),this._selectionCount--):(n.mask|=a,this._selectionCount++,r.collectMask(),i.collectMask(),o&&o.collectMask());else if(r)i=r._chain,o=r._molecule,r._mask&a?(r._mask&=s,i._mask&=s,r.forEachAtom((function(e){e.mask&a&&(e.mask&=s,t._selectionCount--)}))):(r._mask|=a,r.forEachAtom((function(e){e.mask&a||(e.mask|=a,t._selectionCount++)})),i.collectMask(),o&&o.collectMask());else if(i||o){var l=i||o;l._mask&a?(l._mask&=s,l.forEachResidue((function(e){e._mask&a&&(e._mask&=s,e.forEachAtom((function(e){e.mask&a&&(e.mask&=s,t._selectionCount--)})),e._mask&=s)}))):(l._mask|=a,l.forEachResidue((function(e){if(!(e._mask&a)){e._mask|=a,e.forEachAtom((function(e){e.mask&a||(e.mask|=a,t._selectionCount++)}));var n=i?e.getMolecule():e.getChain();n&&n.collectMask()}})))}else this.resetSelectionMask()}},{key:"expandSelection",value:function(){var e=this,t=1<<this._selectionBit;this._complex.forEachBond((function(e){e._left.mask&t?0==(e._right.mask&t)&&(e._right.mask|=1<<31):e._right.mask&t&&(e._left.mask|=1<<31)}));this._complex.forEachAtom((function(n){n.mask&1<<31&&(n.mask=n.mask&~(1<<31)|t,++e._selectionCount)})),this._complex.updateStructuresMask()}},{key:"shrinkSelection",value:function(){var e=this,t=1<<this._selectionBit;this._complex.forEachBond((function(e){e._left.mask&t?0==(e._right.mask&t)&&(e._left.mask|=1<<31):e._right.mask&t&&(e._right.mask|=1<<31)})),this._complex.forEachAtom((function(e){e.mask&t&&1===e.bonds.length&&(e.mask|=1<<31)}));var n=~(t|1<<31);this._complex.forEachAtom((function(t){t.mask&1<<31&&(t.mask&=n,--e._selectionCount)})),this._complex.updateStructuresMask()}},{key:"getSelectedComponent",value:function(){var e=1<<this._selectionBit,t=null,n=!1;return this._complex.forEachAtom((function(r){r.mask&e&&(null===t?t=r.residue._component:t!==r.residue._component&&(n=!0))})),n?null:t}},{key:"getSelectionCenter",value:function(e,t,n){e.set(0,0,0);var r=0;return this._complex.forEachAtom((function(i){t(i,n)&&(e.add(i.position),r++)})),0!==r&&(e.divideScalar(r),e.applyMatrix4(this.matrix),!0)}},{key:"needsRebuild",value:function(){if(this._reprListChanged)return!0;for(var e=this._reprList,t=0,n=e.length;t<n;++t){if(e[t].needsRebuild)return!0}return!1}},{key:"rebuild",value:function(){var e=this;return Yn.clearTree(this),new Promise((function(t){var n=e._complex;if(n){var r=!1;setTimeout((function(){console.time("build");for(var i=e._reprList,o=Zs.get(re.now.palette)||Zs.first,a=!1,s=0,l=i.length;s<l;++s){var c=i[s];if(c.colorer.palette=o,c.needsRebuild){c.reset();try{c.buildGeometry(n)}catch(e){if(!(e instanceof K.OutOfMemoryError))throw e;c.needsRebuild=!1,c.reset(),O.error("Not enough memory to build geometry for representation ".concat(c.index+1)),r=!0}0}a=r||a||Yn.groupHasGeometryToRender(c.geo),c.geo&&e.add(c.geo)}e._reprListChanged=!1,console.timeEnd("build"),t()}),10)}else t()}))}},{key:"setNeedsRebuild",value:function(){for(var e=this._reprList,t=0,n=e.length;t<n;++t)e[t].needsRebuild=!0}},{key:"rebuildSelectionGeometry",value:function(){var e=1<<this._selectionBit;Yn.clearTree(this._selectionGeometry);for(var t=0,n=this._reprList.length;t<n;++t){var r=this._reprList[t].buildSelectionGeometry(e);if(r){this._selectionGeometry.add(r);for(var i=0;i<r.children.length;i++){var o=r.children[i];if(this._editor&&this._editor._componentTransforms){var a=this._editor._componentTransforms[o._component._index];a&&(o.position.copy(a.position),o.quaternion.copy(a.quaternion))}}Yn.applySelectionMaterial(r)}}}},{key:"_buildSelectorFromSortedLists",value:function(e,t,n){var r=this._complex;function i(e){for(var t=[],n=0,r=NaN,i=NaN,o=0,a=e.length;o<a;++o){var s=e[o];s===i+1?i=s:(Number.isNaN(r)||(t[n++]=new Ql.Range(r,i)),r=i=s)}return Number.isNaN(r)||(t[n]=new Ql.Range(r,i)),t}var o=null;if(n.length===r._chains.length)o=Ql.all();else{var a;if(n.length>0&&(a=Ql.chain(n),o=o?Ql.or(o,a):a),Object.keys(t).length>0)for(var s in t)t.hasOwnProperty(s)&&(a=Ql.and(Ql.chain(s),Ql.residx(i(t[s]))),o=o?Ql.or(o,a):a);e.length>0&&(a=Ql.serial(i(e)),o=o?Ql.or(o,a):a),o||(o=Ql.none())}return o}},{key:"buildSelectorFromMask",value:function(e){var t=this._complex,n=[],r={},i=[];return t.forEachChain((function(t){t._mask&e&&n.push(t._name)})),t.forEachResidue((function(t){if(t._mask&e&&!(t._chain._mask&e)){var n=t._chain._name;n in r?r[n].push(t._index):r[n]=[t._index]}})),t.forEachAtom((function(t){t.mask&e&&!(t.residue._mask&e)&&i.push(t.serial)})),this._buildSelectorFromSortedLists(i,r,n)}},{key:"forSelectedResidues",value:function(e){var t=1<<this._selectionBit;this._complex.forEachResidue((function(n){n._mask&t&&e(n)}))}},{key:"beginComponentEdit",value:function(){if(this._editor)return null;var e=new Kl.ComponentEditor(this);return e.begin()?(this._editor=e,e):null}},{key:"beginFragmentEdit",value:function(){if(this._editor)return null;var e=new Kl.FragmentEditor(this);return e.begin()?(this._editor=e,e):null}},{key:"finalizeEdit",value:function(){this._editor=null}},{key:"setMaterialValues",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0,r=0,i=this._reprList.length;r<i;++r){var o=this._reprList[r];o.material.setValues(e),t&&o.geo.traverse((function(t){t instanceof d.Mesh&&(t.material.setValues(e),void 0!==n&&n(t),t.material.needsUpdate=!0)}))}}},{key:"setUberOptions",value:function(e){for(var t=0,n=this._reprList.length;t<n;++t){this._reprList[t].material.setUberOptions(e)}}},{key:"within",value:function(e,t){var n=this._complex.getVoxelWorld();if(null===n)return!1;var r=1<<this._selectionBit;return this._complex.markAtoms(e,r),n&&n.forEachAtomWithinDistFromMasked(this._complex,r,Number(t),(function(e){e.mask|=r})),this._selectionCount=this._complex.countAtomsByMask(r),this._complex.updateStructuresMask(),this.buildSelectorFromMask(r)}}]),n}($n);ec.NUM_REPRESENTATION_BITS=30;var tc=ec;function nc(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var rc=d.UniformsUtils.merge([{volumeDim:{type:"v3",value:new d.Vector3(512,512,512)},tileTex:{type:"t",value:null},tileTexSize:{type:"v2",value:new d.Vector2(512,512)},tileStride:{type:"v2",value:new d.Vector2(512,512)},boxAngles:{type:"v3",value:new d.Vector3(1,1,1)},delta:{type:"v3",value:new d.Vector3(0,0,0)},_isoLevel0:{type:"v2",value:new d.Vector3(.5,.75,1)},_flipV:{type:"f",value:0},_BFLeft:{type:"t",value:null},_BFRight:{type:"t",value:null},_FFLeft:{type:"t",value:null},_FFRight:{type:"t",value:null},_WFFLeft:{type:"t",value:null},_WFFRight:{type:"t",value:null}}]);function ic(e,t){var n=d.UniformsUtils.clone(t);for(var r in e)n.hasOwnProperty(r)&&(n[r].value=e[r]);return n}function oc(e,t){return{uniforms:ic(e,{}),vertexShader:"varying vec3 pos;\n\nvoid main() {\n  // we're assuming local position is in [-0.5, 0.5]\n  // we need to offset it to be represented in RGB\n  pos = position.xyz + 0.5;\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}",fragmentShader:"varying vec3 pos;\n\nvoid main() {\n  gl_FragColor = vec4(pos, 0.5);\n}",transparent:!1,depthTest:!1,depthWrite:!1,side:t}}var ac=function(e){S()(n,e);var t=nc(n);function n(e){m()(this,n);var r=oc(e,d.BackSide);return t.call(this,r)}return n}(d.ShaderMaterial),sc=function e(t,n,r,i){m()(this,e),this.uniforms=ic(t,n),this.vertexShader=r,this.fragmentShader=i,this.transparent=!1,this.depthTest=!1,this.depthWrite=!1,this.side=d.FrontSide},lc={BackFacePosMaterial:ac,BackFacePosMaterialFarPlane:function(e){S()(n,e);var t=nc(n);function n(e){m()(this,n);var r=d.UniformsUtils.merge([{aspectRatio:{type:"f",value:0},farZ:{type:"f",value:0},tanHalfFOV:{type:"f",value:0},matWorld2Volume:{type:"4fv",value:new d.Matrix4}}]),i=new sc(e,r,"varying vec4 volPos;\nuniform float aspectRatio;\nuniform float farZ;\nuniform float tanHalfFOV;\nuniform mat4  matWorld2Volume;\n\nvoid main() {\n  // rescale plane to fill in the whole far plane area seen from camera\n  vec3 pos = position.xyz;\n  pos.x = pos.x * tanHalfFOV * farZ * aspectRatio;\n  pos.y = pos.y * tanHalfFOV * farZ;\n  // common transformation\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);\n  // calc pos in volume CS\n  volPos = matWorld2Volume * modelMatrix * vec4(pos, 1.0);\n  // we're assuming local position is in [-0.5, 0.5]\n  // we need to offset it to be represented in RGB\n  volPos = volPos + 0.5;\n  volPos.w = 0.5;\n}\n","varying vec4 volPos;\n\nvoid main() {\n  gl_FragColor = volPos;\n}");return t.call(this,i)}return n}(d.ShaderMaterial),FrontFacePosMaterial:function(e){S()(n,e);var t=nc(n);function n(e){m()(this,n);var r=oc(e,d.FrontSide);return t.call(this,r)}return n}(d.ShaderMaterial),VolumeMaterial:function(e){S()(n,e);var t=nc(n);function n(e){var r;m()(this,n);var i=new sc(e,rc,"varying vec4 screenSpacePos;\n\nvoid main() {\n  screenSpacePos = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n  gl_Position = screenSpacePos;\n}","uniform mat4 projectionMatrix;\n\n// 3D volume texture\nuniform vec3 volumeDim;    // volume dimensions, pixels\nuniform sampler2D tileTex; // tiled texture containing all Z-slices of a 3D data\nuniform vec2 tileTexSize;  // size of tiled texture, pixels\nuniform vec2 tileStride;   // UV stride between slices in tile tex, pixels\n\nuniform vec3 boxAngles;//value of angles({x: alpha, y:beta, z:gamma}) types 1 - if angle is obtuse, 0 - if acute\nuniform vec3 delta; //Projection box delta's from non-orthogonal origin axes; {x: XY, y : XZ, z: YZ}\n\nuniform vec3 _isoLevel0;\nuniform float _flipV;\nuniform sampler2D _BFLeft;\nuniform sampler2D _BFRight;\nuniform sampler2D _FFLeft;\nuniform sampler2D _FFRight;\nuniform sampler2D _WFFLeft;\nuniform sampler2D _WFFRight;\n\nvarying vec4 screenSpacePos;\n\n#define NO_COLOR vec4(0., 0., 0., 0.)\n\nvec4 sample3DTexture(vec3 texCoord) {\n  // a pair of Z slices is determined by nearest slice border\n  float zSliceBorder = floor(texCoord.z * volumeDim.z + 0.5);\n  float zSliceNumber1 = max(zSliceBorder - 1.0, 0.0);\n  float zSliceNumber2 = min(zSliceBorder, volumeDim.z - 1.0);\n\n  float rowTiles = floor(tileTexSize.x / tileStride.x);\n\n  // calculate coords in tile texture for both slices\n  vec2 tileOffset = vec2(mod(zSliceNumber1, rowTiles), floor(zSliceNumber1 / rowTiles));\n  vec2 texCoordSlice1 = (texCoord.xy * volumeDim.xy + tileOffset * tileStride) / tileTexSize.xy;\n  tileOffset = vec2(mod(zSliceNumber2, rowTiles), floor(zSliceNumber2 / rowTiles));\n  vec2 texCoordSlice2 = (texCoord.xy * volumeDim.xy + tileOffset * tileStride) / tileTexSize.xy;\n\n  // bilinear filtering\n  vec4 colorSlice1 = texture2D(tileTex, texCoordSlice1);\n  vec4 colorSlice2 = texture2D(tileTex, texCoordSlice2);\n  float weightSlice2 = texCoord.z * volumeDim.z - (zSliceNumber1 + 0.5);\n  return mix(colorSlice1, colorSlice2, weightSlice2);\n}\n\nvec4 sample3DTextureInclined(vec3 boxCoord) { // delta:{ x: XY, y : XZ, z: YZ }\n  vec3 textCoord = boxCoord;\n  vec2 currDelta = mix(boxCoord.zz, vec2(1., 1.) - boxCoord.zz, boxAngles.yx) * delta.yz;\n\n  textCoord.y = (boxCoord.y  - currDelta.y) / (1. - delta.z);\n  if (textCoord.y < 0.0 || textCoord.y > 1.0)\n    return NO_COLOR;\n\n  currDelta.x += mix(textCoord.y, 1.0 - textCoord.y, boxAngles.z) * delta.x;\n\n  textCoord.x = (boxCoord.x - currDelta.x) / (1. - delta.x - delta.y);\n  if (textCoord.x < 0.0 || textCoord.x > 1.0)\n    return NO_COLOR;\n\n  return sample3DTexture(textCoord);\n}\n\nfloat CalcColor(vec3 iter, vec3 dir) {\n  float d = 1. / 128.;\n  vec3 dx = vec3(d, 0.0, 0.0);\n  vec3 dy = vec3(0.0, d, 0.0);\n  vec3 dz = vec3(0.0, 0.0, d);\n\n  // #Opt: coordInc.x:(iter + dx).x > 1. ? 0.: sample3DTextureInclined(iter + dx).x,\n  vec3 coordInc = mix(\n    vec3(\n      sample3DTextureInclined(iter + dx).x,\n      sample3DTextureInclined(iter + dy).x,\n      sample3DTextureInclined(iter + dz).x\n    ),\n    vec3(0. ,0. , 0.),\n    vec3(floor((iter + dx).x), floor((iter + dy).y), floor((iter + dz).z))\n  );\n\n  // #Opt: coordDec.x:(iter - dx).x < 0. ? 0.: sample3DTextureInclined(iter - dx).x,\n  vec3 coordDec = mix(\n    vec3(0. ,0. , 0.),\n    vec3(\n      sample3DTextureInclined(iter - dx).x,\n      sample3DTextureInclined(iter - dy).x,\n      sample3DTextureInclined(iter - dz).x\n    ),\n    vec3(ceil((iter - dx).x), ceil((iter - dy).y), ceil((iter - dz).z))\n  );\n\n  vec3 N = normalize(coordInc - coordDec);\n  float dif = max(0.0, dot(N, dir));\n  return dif;\n}\n\nvec3 AccuracyIso(vec3 left, vec3 right, float volLeft, float threshold) {\n  for (int i = 0; i < 5; i++) {\n    vec3 iterator = 0.5 * (left + right);\n    float vol = sample3DTextureInclined(iterator).r;\n    if ((volLeft - threshold) * (vol - threshold) < 0.)\n      right = iterator;\n    else\n      left = iterator;\n  }\n  return 0.5 * (left + right);\n}\n\nvec3 CorrectIso(vec3 left, vec3 right, float tr) {\n  for (int j = 0; j < 5; j++) {\n    vec3 iterator = 0.5 * (left + right);\n    float vol = sample3DTextureInclined(iterator).r;\n    if (vol < tr)\n      right = iterator;\n    else\n      left = iterator;\n  }\n  return 0.5 * (left + right);\n}\n\nvec4 GetIso1(vec3 start, vec3 back, float molDist, vec3 dir, float tr, int count) {\n  float vol, stepSize = (float(count) + 2.) / float(STEPS_COUNT);\n  vec3 step = stepSize * dir, iterator = start, left, right;\n  vec4 acc = NO_COLOR;\n\n  for (int i = 0; i < STEPS_COUNT; i++) {\n    iterator = iterator + step;\n    vol = sample3DTextureInclined(iterator).r;\n    if (length(iterator - back) <= stepSize || (vol > tr))\n      break;\n  }\n\n  if (vol > tr)\n    acc = vec4(CorrectIso(iterator, iterator - step, tr).xyz, 1.);\n\n  return acc;\n}\n\nfloat easeOut(float x0, float x1, float x) {\n  float t = clamp((x - x0) / (x1 - x0), 0.0, 1.0);\n  return 1.0 - (1.0 - t) * (1.0 - t);\n}\n\nfloat easeIn(float x0, float x1, float x) {\n  float t = clamp((x - x0) / (x1 - x0), 0.0, 1.0);\n  return t * t;\n}\n\nvec3 GetColSimple(float vol) {\n  float t = easeOut(_isoLevel0.x, _isoLevel0.y, vol);\n  float s = easeIn(_isoLevel0.y, _isoLevel0.z, vol);\n  return vec3(0.5, 0.6, 0.7) * (1.0 - t) + 2.0 * vec3(s, 0, 0);\n}\n\nvec4 VolRender(vec3 start, vec3 back, float molDist, vec3 dir) {\n  vec4 acc = NO_COLOR, iso;\n  vec3 iterator = start, sumColor = vec3(0., 0., 0.);\n  float stepSize, alpha, sumAlpha = 0.0, vol, curStepSize, molD;\n  vec3 step, col, colOld, right;\n  float tr0 = _isoLevel0.x;\n  float dif, r, kd, finish;\n  int count = 0, stopMol = 0;\n\n  for (int k = 0; k < 3; k++) {\n    stepSize = (float(k) + 2.) / float(STEPS_COUNT);\n    kd = 140. * tr0 * stepSize;\n    r = 1. - kd;\n    step = stepSize * dir;\n    iso = GetIso1(iterator, back, molDist, dir, tr0, k);\n    if (iso.a < 0.1 || length(iso.xyz - start) > molDist)\n      break;\n    iterator = iso.xyz;\n    dif = 1.;// CalcColor(iterator, dir);\n    colOld = GetColSimple(tr0);\n    curStepSize = stepSize;\n    for (int i = 0; i < STEPS_COUNT; i++) {\n      iterator = iterator + step;\n      molD = length(iterator - start);\n      vol = sample3DTextureInclined(iterator).r;\n      finish = distance(iterator, back) - stepSize;\n      if (finish < 0.0 || vol < tr0 || (sumAlpha > 0.97) || molD > molDist)\n        break;\n      alpha = (1. - r);\n      col = GetColSimple(vol);\n      vol = sample3DTextureInclined(iterator - 0.5 * step).r;\n      vec3 colMid = GetColSimple(vol);\n      sumColor += (1. - sumAlpha) * (colOld + 4.* colMid + col) * alpha / 6.;\n      sumAlpha += (1. - sumAlpha) * alpha;// *(1. - 1.0*dif*dif);\n      colOld = col;\n    } // for i\n\n    if (finish < 0.0 || sumAlpha > 0.97)\n      break;\n\n    if (molD > molDist) {\n      curStepSize = stepSize - (molD - molDist);\n      right = iterator - (molD - molDist) * dir;\n      vol = sample3DTextureInclined(right).r;\n    } else {\n      vec3 left = iterator - step;\n      right = CorrectIso(left, iterator, tr0);\n      curStepSize = distance(left, right);\n      vol = tr0;\n    }\n\n    alpha = (1. - r) * curStepSize / stepSize;\n    dif = 1.;// CalcColor(right, dir);\n    col = GetColSimple(vol);\n    vol = sample3DTextureInclined(iterator - 0.5 * curStepSize / stepSize * step).r;\n    vec3 colMid = GetColSimple(vol);\n    sumColor += (1. - sumAlpha) * (colOld + 4. * colMid + col) * alpha / 6.;\n    sumAlpha += (1. - sumAlpha) * alpha;// *(1. - 1.0*dif*dif);\n\n    if (molD > molDist)\n      break;\n  } // for k\n  acc.rgb = 1. * sumColor / sumAlpha;\n  acc.a = sumAlpha;\n  return acc;\n}\n\nvec4 VolRender1(vec3 start, vec3 back, float molDist, vec3 dir) {\n  float stepSize = 1.0 / float(STEPS_COUNT);\n  float len = length(back - start);\n  vec3 step = stepSize * dir;\n  vec3 iterator = start;\n  float acc = 0.0;\n\n  for (int i = 0; i < STEPS_COUNT; i++) {\n    if (float(i) * stepSize > len)\n      break;\n    iterator = iterator + step;\n    if (sample3DTextureInclined(iterator).r > _isoLevel0.x)\n      acc += 10. * sample3DTextureInclined(iterator).r / float(STEPS_COUNT);\n  }\n\n  return vec4(1.,1.,1., acc);\n}\n\nvec4 IsoRender(vec3 start, vec3 back, float molDist, vec3 dir) {\n  vec4 tst = GetIso1(start, back, 2., dir, _isoLevel0.x, 0);\n  vec4 col = NO_COLOR;\n\n  if (length(tst.xyz - start) < molDist && tst.a > 0.1) {\n    float dif =  CalcColor(tst.xyz, dir);\n    dif = 0.9 * dif * dif;\n    col = vec4(dif, dif, dif, 1);\n  }\n  return col;\n}\n\nvec4 VolRender2(vec3 start, vec3 back, float molDist, vec3 dir) {\n  return sample3DTexture(start);\n}\n\nvoid main() {\n  vec3 tc = screenSpacePos.xyz / screenSpacePos.w * 0.5 + 0.5;\n\n  if (_flipV > 0.0) {\n    tc.y = 1.0 - tc.y;\n  }\n\n  vec3 start;\n  vec3 back;\n  vec3 molBack;\n  if (projectionMatrix[0][2] < 0.0) {\n    start = texture2D(_FFLeft, tc.xy).xyz;\n    back = texture2D(_BFLeft, tc.xy).xyz;\n    molBack = texture2D(_WFFLeft, tc.xy).xyz;\n  } else {\n    start = texture2D(_FFRight, tc.xy).xyz;\n    back = texture2D(_BFRight, tc.xy).xyz;\n    molBack = texture2D(_WFFRight, tc.xy).xyz;\n  }\n\n  vec3 dir = normalize(back - start);\n\n  float molDist = 2.0;\n  if (length(molBack) > 0.001) {\n    molDist = distance(start, molBack);\n  }\n\n  #ifdef ISO_MODE\n    gl_FragColor = IsoRender(start, back, molDist, dir);\n  #else\n    gl_FragColor = VolRender(start, back, molDist, dir);\n  #endif\n}\n");return i.transparent=!0,i.depthTest=!0,(r=t.call(this,i)).updateDefines(),r}return y()(n,[{key:"updateDefines",value:function(){this.defines={ISO_MODE:re.now.modes.VD.isoMode,STEPS_COUNT:100*re.now.modes.VD.polyComplexity[re.now.resolution]},this.needsUpdate=!0}}]),n}(d.ShaderMaterial)};function cc(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var uc=function(e){S()(n,e);var t=cc(n);function n(){var e;m()(this,n);var r=new d.BufferGeometry;e=t.call(this,r),Re()(Pn()(e),"volumeInfo",{}),e.clipPlane=new d.Plane;var i=new d.Vector3(.5,.5,.5);return e.size=i,e.cullFlag=[!0,!0,!0,!0,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1],e.faces=[{indices:[],norm:new d.Vector3(0,0,-1)},{indices:[],norm:new d.Vector3(0,0,1)},{indices:[],norm:new d.Vector3(0,-1,0)},{indices:[],norm:new d.Vector3(0,1,0)},{indices:[],norm:new d.Vector3(-1,0,0)},{indices:[],norm:new d.Vector3(1,0,0)},{indices:[],norm:new d.Vector3(0,0,0)}],e.vertices=[new d.Vector3(-i.x,-i.y,-i.z),new d.Vector3(-i.x,i.y,-i.z),new d.Vector3(i.x,-i.y,-i.z),new d.Vector3(i.x,i.y,-i.z),new d.Vector3(-i.x,-i.y,i.z),new d.Vector3(-i.x,i.y,i.z),new d.Vector3(i.x,-i.y,i.z),new d.Vector3(i.x,i.y,i.z),new d.Vector3(0,0,0),new d.Vector3(0,0,0),new d.Vector3(0,0,0),new d.Vector3(0,0,0),new d.Vector3(0,0,0),new d.Vector3(0,0,0)],r.setAttribute("position",new d.BufferAttribute(new Float32Array(3*e.vertices.length),3)),e.name="VolumeMesh",e}return y()(n,[{key:"_updateVertices",value:function(){var e,t=n._corners,r=n._edges,i=n._edgeIntersections,o=this.clipPlane.normal,a=this.clipPlane.constant,s=this.vertices,l=this.size,c=[0,0,0,0,0,0,0,0],u=[1,1,1,1,1,1,1,1,1,1,1,1],h=new d.Vector3,f=null;function p(){if(0===o.x)return 0;var e=-(o.dot(h)+a)/o.x;return-l.x<=e&&e<=l.x?(f.set(e,h.y,h.z),e===l.x?2:e===-l.x?-2:1):0}function m(){if(0===o.y)return 0;var e=-(o.dot(h)+a)/o.y;return-l.y<=e&&e<=l.y?(f.set(h.x,e,h.z),e===l.y?2:e===-l.y?-2:1):0}function v(){if(0===o.z)return 0;var e=-(o.dot(h)+a)/o.z;return-l.z<=e&&e<=l.z?(f.set(h.x,h.y,e),e===l.z?2:e===-l.z?-2:1):0}for(var y=0;y<12;++y){var _=r[y];f=i[y],h.set(_[2],_[3],_[4]),h.multiply(l);var g=0;0===_[2]&&(g=p()),0===_[3]&&(g=m()),0===_[4]&&(g=v()),-2===g?c[_[0]]=1:2===g?c[_[1]]=1:0===g&&(u[y]=0)}var x={indices:[],norm:o.clone().negate()},b=8;for(e=0;e<8;++e)1===c[e]&&(s[b].set(t[e][0],t[e][1],t[e][2]).multiply(l),x.indices.push(b++),u[t[e][3]]=0,u[t[e][4]]=0,u[t[e][5]]=0);for(e=0;e<12;++e)1===u[e]&&(s[b].copy(i[e]),x.indices.push(b++));this.faces[6]=x;var w=new d.Vector3,S=new d.Vector3;for(this.clipPlane.coplanarPoint(S),e=0;e<s.length;++e)this.cullFlag[e]=!1,e<8?(w.subVectors(s[e],S),this.cullFlag[e]=o.dot(w)>=0):e<8+x.indices.length&&(this.cullFlag[e]=!0);var C=this.geometry.getAttribute("position"),R=0;for(e=0;e<s.length;++e)C.array[R++]=s[e].x,C.array[R++]=s[e].y,C.array[R++]=s[e].z;C.needsUpdate=!0}},{key:"_collectVertices",value:function(e,t){var n,r=this.vertices;for(e.indices=[],n=0;n<r.length;++n)this.cullFlag[n]&&t(r[n])&&e.indices.push(n)}},{key:"_sortIndices",value:function(e,t){var n,r,i=this.vertices,o=[],a=new d.Vector3;for(n=1;n<e.indices.length;++n)a.subVectors(i[e.indices[n]],i[e.indices[0]]),a.normalize(),a.cross(t),a.negate(),o[n]=e.norm.dot(a);for(n=1;n<e.indices.length-1;++n)for(r=n+1;r<e.indices.length;++r)if(o[r]<o[n]){var s=o[n];o[n]=o[r],o[r]=s,s=e.indices[n],e.indices[n]=e.indices[r],e.indices[r]=s}}},{key:"_updateIndices",value:function(){var e,t,n,r=this.vertices,i=this.size;this._collectVertices(this.faces[0],(function(e){return e.z===-i.z})),this._collectVertices(this.faces[1],(function(e){return e.z===i.z})),this._collectVertices(this.faces[2],(function(e){return e.y===-i.y})),this._collectVertices(this.faces[3],(function(e){return e.y===i.y})),this._collectVertices(this.faces[4],(function(e){return e.x===-i.x})),this._collectVertices(this.faces[5],(function(e){return e.x===i.x}));var o=new d.Vector3,a=new d.Vector3,s=new d.Vector3;for(t=0;t<this.faces.length;++t)if(0!==(n=this.faces[t]).indices.length){for(o.set(0,0,0),e=0;e<n.indices.length;++e)o.add(r[n.indices[e]]);o.multiplyScalar(1/n.indices.length),a.subVectors(r[n.indices[0]],o),a.normalize();var l=[];for(e=0;e<n.indices.length;++e)s.subVectors(r[n.indices[e]],o),l[e]=s.dot(a);for(e=1;e<n.indices.length;++e)if(l[e]<l[0]){var u=l[0];l[0]=l[e],l[e]=u,u=c()(n.indices,1)[0],n.indices[0]=n.indices[e],n.indices[e]=u}this._sortIndices(n,a)}var h=0;for(t=0;t<this.faces.length;++t)(n=this.faces[t]).indices.length>=3&&(h+=3*(n.indices.length-2));var f=0,p=new Uint16Array(h);for(t=0;t<this.faces.length;++t)for(n=this.faces[t],e=0;e<n.indices.length-2;++e)p[f]=n.indices[0],p[f+1]=n.indices[e+1],p[f+2]=n.indices[e+2],f+=3;this.geometry.setIndex(new d.BufferAttribute(p,1))}},{key:"setDataSource",value:function(e){var t=new lc.VolumeMaterial,n=e.getDimensions(),r=e.getTiledTextureStride(),i=e.buildTiledTexture(),o=e.getBox();t.uniforms.volumeDim.value.set(n[0],n[1],n[2]),t.uniforms.tileTex.value=i,t.uniforms.tileTexSize.value.set(i.image.width,i.image.height),t.uniforms.tileStride.value.set(r[0],r[1]),Object.assign(this.volumeInfo,e.getVolumeInfo());var a=this.volumeInfo;t.uniforms.delta.value.copy(a.delta),t.uniforms.boxAngles.value.set(a.obtuseAngle[0],a.obtuseAngle[1],a.obtuseAngle[2]),this.material=t,o.getSize(this.scale),o.getCenter(this.position)}},{key:"_updateIsoLevel",value:function(){var e=re.now.modes.VD,t=e.kSigma,n=e.kSigmaMed,r=e.kSigmaMax,i=this.volumeInfo,o=i.dmean-i.dmin,a=i.dmax-i.dmin,s=function(e){return(o+e*i.sd)/a};this.material.uniforms._isoLevel0.value.set(s(t),s(n),s(r))}},{key:"rebuild",value:function(e){var t=n._nearClipPlaneOffset,r=n._pos,i=n._norm,o=n._norm4D,a=n._matrixWorldToLocal,s=n._clipPlane;this._updateIsoLevel(),e.getWorldDirection(i),e.getWorldPosition(r),r.addScaledVector(i,e.near+t),a.copy(this.matrixWorld).invert(),r.applyMatrix4(a),o.set(i.x,i.y,i.z,0),o.applyMatrix4(a),i.copy(o),i.normalize(),s.setFromNormalAndCoplanarPoint(i,r),this.clipPlane.equals(s)||(this.clipPlane=s.clone(),this._updateVertices(),this._updateIndices())}}]),n}(d.Mesh);Re()(uc,"_corners",[[-1,-1,-1,0,4,8],[1,-1,-1,0,5,9],[1,1,-1,1,5,10],[-1,1,-1,1,4,11],[-1,-1,1,2,6,8],[1,-1,1,2,7,9],[1,1,1,3,7,10],[-1,1,1,3,6,11]]),Re()(uc,"_edges",[[0,1,0,-1,-1],[2,3,0,1,-1],[4,5,0,-1,1],[6,7,0,1,1],[0,3,-1,0,-1],[1,2,1,0,-1],[4,7,-1,0,1],[5,6,1,0,1],[0,4,-1,-1,0],[1,5,1,-1,0],[2,6,-1,1,0],[3,7,1,1,0]]),Re()(uc,"_edgeIntersections",function(){for(var e=[],t=0;t<12;++t)e.push(new d.Vector3);return e}()),Re()(uc,"_nearClipPlaneOffset",.2),Re()(uc,"_pos",new d.Vector3),Re()(uc,"_norm",new d.Vector3),Re()(uc,"_norm4D",new d.Vector4),Re()(uc,"_matrixWorldToLocal",new d.Matrix4),Re()(uc,"_clipPlane",new d.Plane);var hc=uc;var dc=function(){function e(t,n){m()(this,e);var r=n.delta,i=n.obtuseAngle,o=new d.Vector3;t.getSize(o),o.multiplyScalar(.5);for(var a=this._getBaseVertices(r,i),s=new d.BufferGeometry,l=[],c=0;c<4;c++)l.push(a[c].clone().multiply(o)),l.push(a[(c+1)%4].clone().multiply(o));for(var u=new d.Vector3(2*o.x*(1-r.x-r.y),0,0),h=0;h<8;h++)l.push(l[h].clone().add(u));for(var f=0;f<4;f++)l.push(l[2*f].clone()),l.push(l[2*f+8].clone());var p=new d.Vector3;t.getCenter(p),l.forEach((function(e){return e.add(p)}));var v=function(e){for(var t=e.length,n=new Float32Array(3*t),r=0;r<t;++r){var i=3*r,o=e[r];n[i]=o.x,n[i+1]=o.y,n[i+2]=o.z}return n}(l);s.setAttribute("position",new d.BufferAttribute(v,3)),this._lines=new d.LineSegments(s,new d.LineBasicMaterial({color:16777215})),this._lines.layers.set(Yn.LAYERS.VOLUME)}return y()(e,[{key:"_getBaseVertices",value:function(t,n){var r=e._projectionTable,i=function(e,i){var o=t[r[e][0]];return(-.5*(i-1)+i*n[r[e][1]])*o};return[new d.Vector3(2*(i("XZ",1)+i("XY",1))-1,2*i("YZ",1)-1,-1),new d.Vector3(2*(i("XZ",-1)+i("XY",1))-1,2*i("YZ",-1)-1,1),new d.Vector3(2*(i("XZ",-1)+i("XY",-1))-1,1-2*i("YZ",1),1),new d.Vector3(2*(i("XZ",1)+i("XY",-1))-1,1-2*i("YZ",-1),-1)]}},{key:"getMesh",value:function(){return this._lines}}]),e}();Re()(dc,"_projectionTable",{XY:["x",2],XZ:["y",1],YZ:["z",0]});var fc=dc,pc=function(){function e(t,n,r){m()(this,e);var i=this._initPlaneGeo(n,r),o=new lc.BackFacePosMaterialFarPlane;this._plane=new _o.Mesh(i,o),this._plane.frustumCulled=!1,this._plane.doubleSided=!0;var a=new d.Matrix4;this._plane._onBeforeRender=function(e,n,r,i,o,s){var l=this.material;if(t&&l){var c=new d.Vector4(0,0,-(r.far-.1),1);c.applyMatrix4(r.matrixWorld),this.matrix.identity(),this.matrix.makeTranslation(c.x,c.y,c.z),this.matrixWorld.copy(this.matrix),this.modelViewMatrix.multiplyMatrices(r.matrixWorldInverse,this.matrixWorld),this.normalMatrix.getNormalMatrix(this.modelViewMatrix);var u=t.matrixWorld;a.copy(u).invert(),l.uniforms.aspectRatio.value=r.aspect,l.uniforms.farZ.value=r.far,l.uniforms.tanHalfFOV.value=Math.tan(.5*d.MathUtils.DEG2RAD*r.fov),l.uniforms.matWorld2Volume.value=a}},this._plane.layers.set(Yn.LAYERS.VOLUME_BFPLANE)}return y()(e,[{key:"_initPlaneGeo",value:function(e,t){var n=new d.BufferGeometry;e=e||1,t=t||1;var r=new Float32Array([-.5*e,.5*t,0,.5*e,.5*t,0,-.5*e,-.5*t,0,.5*e,-.5*t,0]);return n.setAttribute("position",new d.BufferAttribute(r,3)),n.setIndex([0,2,1,2,3,1]),n}},{key:"getMesh",value:function(){return this._plane}}]),e}();function mc(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var vc=function(e){S()(n,e);var t=mc(n);function n(e,r){var i;return m()(this,n),(i=t.call(this,e,r))._mesh=new hc,i._mesh.setDataSource(r),i.add(i._mesh),i._frame=new fc(i.getBoundaries().boundingBox,i._mesh.volumeInfo),i.add(i._frame.getMesh()),i.showFrame(re.now.modes.VD.frame),i._farPlane=new pc(i._mesh,2,2),i.add(i._farPlane.getMesh()),i}return y()(n,[{key:"getBoundaries",value:function(){var e=this._dataSource.getBox(),t=new d.Sphere;return e.getBoundingSphere(t),{boundingBox:e,boundingSphere:t}}},{key:"getMesh",value:function(){return this._mesh}},{key:"showFrame",value:function(e){this._frame.getMesh().material.visible=e}}]),n}($n);function yc(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var _c=function(e){S()(n,e);var t=yc(n);function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return m()(this,n),t.call(this,e,["types"])}return y()(n,[{key:"find",value:function(e){var t=[];if(e.type)t=this._dict.types[e.type.toLowerCase()]||[];else if(e.source)return this._list.filter((function(t){return t.canProbablyLoad&&t.canProbablyLoad(e.source)}));return Zn()(t)}}]),n}(Jn);function gc(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var xc=function(e){S()(n,e);var t=gc(n);function n(e,r){var i;return m()(this,n),(i=t.call(this))._source=e,i._options=r||{},i._abort=!1,i._agent=null,i}return y()(n,[{key:"load",value:function(){return Promise.reject(new Error("Loading from this source is not implemented"))}},{key:"abort",value:function(){this._abort=!0,this._agent&&this._agent.abort()}}],[{key:"extractName",value:function(e){}}]),n}(I);function bc(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}er(xc.prototype);var wc=function(e){S()(n,e);var t=bc(n);function n(e,r){var i;return m()(this,n),r=(i=t.call(this,e,r))._options,i._binary=!0===r.binary,i}return y()(n,[{key:"load",value:function(){var e=this;return new Promise((function(t,n){if(e._abort)throw new Error("Loading aborted");var r=e._source,i=e._agent=new FileReader;i.addEventListener("load",(function(){t(i.result)})),i.addEventListener("error",(function(){n(i.error)})),i.addEventListener("abort",(function(){n(new Error("Loading aborted"))})),i.addEventListener("progress",(function(t){e.dispatchEvent(t)})),e._binary?i.readAsArrayBuffer(r):i.readAsText(r)}))}}],[{key:"canProbablyLoad",value:function(e){return File&&e instanceof File||Blob&&e instanceof Blob}},{key:"extractName",value:function(e){return e&&e.name}}]),n}(xc);function Sc(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}wc.types=["file","blob"];var Cc=/^(https?|ftp):\/\//i,Rc=function(e){S()(n,e);var t=Sc(n);function n(e,r){var i;return m()(this,n),r=(i=t.call(this,e,r))._options,i._binary=!0===r.binary,i}return y()(n,[{key:"load",value:function(){var e=this;return new Promise((function(t,n){if(e._abort)throw new Error("Loading aborted");var r=e._source,i=e._agent=new XMLHttpRequest;i.addEventListener("load",(function(){200===i.status?t(i.response):n(new Error("HTTP ".concat(i.status," while fetching ").concat(r)))})),i.addEventListener("error",(function(){n(new Error("HTTP request failed"))})),i.addEventListener("abort",(function(){n(new Error("Loading aborted"))})),i.addEventListener("progress",(function(t){e.dispatchEvent(t)})),i.open("GET",r),e._binary?i.responseType="arraybuffer":i.responseType="text",i.send()}))}}],[{key:"canProbablyLoad",value:function(e){return h.a.isString(e)&&Cc.test(e)}},{key:"extractName",value:function(e){if(e){var t=(e.indexOf("?")+1||e.lastIndexOf("#")+1||e.length+1)-1;return e.slice(e.lastIndexOf("/",t)+1,t)}}}]),n}(xc);function Ac(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}Rc.types=["url"];var Ec=function(e){S()(n,e);var t=Ac(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"load",value:function(){var e=this;return new Promise((function(t){if(e._abort)throw new Error("Loading aborted");t(e._source)}))}}],[{key:"canProbablyLoad",value:function(e){return!1}}]),n}(xc);Ec.types=["immediate"];var kc=new _c([wc,Rc,Ec]);function Tc(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var Pc=function(e){S()(n,e);var t=Tc(n);function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return m()(this,n),t.call(this,e,["formats","extensions"])}return y()(n,[{key:"find",value:function(e){var t=[];return e.format?t=this._dict.formats[e.format.toLowerCase()]||[]:e.ext&&(t=this._dict.extensions[e.ext.toLowerCase()]||[]),0===t.length&&!e.format&&e.data?this._list.filter((function(t){return t.canProbablyParse&&t.canProbablyParse(e.data)})):Zn()(t)}}]),n}(Jn),Mc=function(){function e(t,n){m()(this,e),this._data=t,this._options=n||{},this._abort=!1}return y()(e,[{key:"parseSync",value:function(){throw new Error("Parsing this type of data is not implemented")}},{key:"parse",value:function(){var e=this;return new Promise((function(t,n){setTimeout((function(){try{return e._abort?n(new Error("Parsing aborted")):t(e.parseSync())}catch(e){return n(e)}}))}))}},{key:"getModel",value:function(){return this.model._parseHeader(this._data),this.model}},{key:"abort",value:function(){this._abort=!0}}]),e}();er(Mc.prototype);var Ic=function(){function e(){m()(this,e),this.matrices=[],this._matrix=null,this._matrixIndex=-1}return y()(e,[{key:"parse",value:function(e){var t=this._matrix;if("  SMTRY"===e.readString(12,18)){var n=e.readCharCode(19)-49,r=e.readString(20,80).trim().split(/\s+/),i=parseInt(r[0],10);null!==this._matrix&&i===this._matrixIndex||(this._matrixIndex=i,this._matrix=t=new d.Matrix4,this.matrices[this.matrices.length]=t);var o=t.elements;o[n]=parseFloat(r[1]),o[n+4]=parseFloat(r[2]),o[n+8]=parseFloat(r[3]),o[n+12]=parseFloat(r[4])}}}]),e}();Ic.prototype.id=290;var Nc=Ic,Lc=kn.Assembly,Dc=function(){function e(t){m()(this,e),this._complex=t,this.assemblies=[],this._assembly=null,this._matrix=null,this._matrixIndex=-1}return y()(e,[{key:"parse",value:function(e){var t=this._assembly,n=this._matrix;if(t&&"  BIOMT"===e.readString(12,18)){var r=e.readCharCode(19)-49,i=e.readString(20,80).trim().split(/\s+/),o=parseInt(i[0],10);null!==this._matrix&&o===this._matrixIndex||(this._matrixIndex=o,this._matrix=n=new d.Matrix4,t.addMatrix(n));var a=n.elements;a[r]=parseFloat(i[1]),a[r+4]=parseFloat(i[2]),a[r+8]=parseFloat(i[3]),a[r+12]=parseFloat(i[4])}else if(t&&"CHAINS:"===e.readString(35,41))for(var s=e.readString(42,80).split(","),l=0,c=s.length;l<c;++l){var u=s[l].trim();u.length>0&&t.addChain(u)}else"BIOMOLECULE:"===e.readString(12,23)&&(this._matrix=null,this._matrixIndex=-1,this._assembly=t=new Lc(this._complex),this.assemblies.push(t))}}]),e}();Dc.prototype.id=350;var Oc=Dc,Vc=function(){function e(t){m()(this,e),this._data=t,this._start=0,this._nextCR=-1,this._nextLF=-1,this._next=-1,this._end=t.length,this.next()}return y()(e,[{key:"readLine",value:function(){return this._data.slice(this._start,this._next)}},{key:"readChar",value:function(e){return(e=this._start+e-1)<this._next?this._data[e]:" "}},{key:"readCharCode",value:function(e){return(e=this._start+e-1)<this._next?this._data.charCodeAt(e):32}},{key:"readString",value:function(e,t){var n=this._start+e-1,r=this._start+t;return this._data.slice(n,r<this._next?r:this._next)}},{key:"readInt",value:function(e,t){return parseInt(this.readString(e,t),10)}},{key:"readFloat",value:function(e,t){return parseFloat(this.readString(e,t))}},{key:"end",value:function(){return this._start>=this._end}},{key:"next",value:function(){var e=this._next+1;this._start=e<this._end?e:this._end,this._start>this._nextCR&&(this._nextCR=(this._data.indexOf("\r",this._start)+1||this._end+1)-1),this._start>this._nextLF&&(this._nextLF=(this._data.indexOf("\n",this._start)+1||this._end+1)-1),this._next=this._nextCR+1<this._nextLF?this._nextCR:this._nextLF}}]),e}();function zc(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var Fc=kn.Complex,Bc=kn.Element,Uc=kn.Helix,Gc=kn.Sheet,jc=kn.Strand,Hc=kn.Bond,Wc=kn.Molecule;var Yc=/^(HEADER\s|COMPND\s|REMARK\s|ATOM {2}|HETATM|MODEL )/i,qc={290:Nc,350:Oc},Xc=function(e){S()(n,e);var t=zc(n);function n(e,r){var i;return m()(this,n),(i=t.call(this,e,r))._complex=null,i._chain=null,i._residue=null,i._sheet=null,i._serialAtomMap=null,i._modelId=1,i._compaundFound=!1,i._biomoleculeFound=!1,i._allowedChainsIDs=null,i._lastMolId=-1,i._remarks={},i._remark=null,i._molecules=[],i._molecule=null,i._compndCurrToken="",i._options.fileType="pdb",i}return y()(n,[{key:"_finalize",value:function(){this._fixBondsArray(),this._fixChains();var e=this._remarks[290];this._complex.symmetry=h.a.isUndefined(e)?[]:e.matrices;var t=this._remarks[350];this._complex.units=this._complex.units.concat(h.a.isUndefined(t)?[]:t.assemblies),this._finalizeMolecules(),this._complex.finalize({needAutoBonding:!0,detectAromaticLoops:this.settings.now.aromatic,enableEditing:this.settings.now.editing,serialAtomMap:this._serialAtomMap})}},{key:"_finalizeMolecules",value:function(){var e,t={},n=this._complex._chains;for(e=0;e<n.length;++e){var r=n[e];t[r._name]=r}for(e=0;e<this._molecules.length;e++){for(var i=this._molecules[e],o=[],a=0;a<i._chains.length;a++){var s=t[i._chains[a]];o=o.concat(s._residues.slice())}var l=new Wc(this._complex,i._name,e+1);l.residues=o,this._complex._molecules[e]=l}}},{key:"_fixChains",value:function(){for(var e={},t=this._complex,n=0;n<t._chains.length;n++){var r=t._chains[n];e[r._name.charCodeAt(0)]=r}}},{key:"_fixBondsArray",value:function(){for(var e=this._serialAtomMap={},t=this._complex,n=t._atoms,r=0,i=n.length;r<i;++r){var o=n[r];e[o.serial]=o}for(var a=t._bonds,s=this.logger,l=0,c=a.length;l<c;++l){var u=a[l];u._right<u._left&&s.debug("_fixBondsArray: Logic error."),u._left=e[u._left]||null,u._right=e[u._right]||null}}},{key:"_parseATOM",value:function(e){if(1===this._modelId){var t=72===e.readCharCode(1),n=t?e.readInt(7,11):e.readInt(6,11),r=e.readString(13,16),i=e.readChar(17),o=e.readString(18,20).trim(),a=e.readChar(22),s=e.readInt(23,26),l=e.readChar(27),c=e.readFloat(31,38),u=e.readFloat(39,46),h=e.readFloat(47,54),f=e.readFloat(55,60),p=e.readFloat(61,66),m=e.readString(77,78).trim()||function(e){var t=4===e.trim().length;return e.slice(0,t?1:2).trim()}(r),v=e.readInt(79,80)||0;if(!this.settings.now.nowater||"HOH"!==o&&"WAT"!==o){r=r.trim();var y=Bc.getByName(m),_=Bc.Role[r],g=this._chain;g&&g.getName()===a||(this._chain=g=this._complex.getChain(a)||this._complex.addChain(a),this._residue=null);var x=this._residue;x&&x.getSequence()===s&&x.getICode()===l||(this._residue=x=g.addResidue(o,s,l));var b=new d.Vector3(c,u,h);x.addAtom(r,y,b,_,t,n,i,f,p,v)}}}},{key:"_parseENDMDL",value:function(){this._modelId+=1}},{key:"_parseCONECT",value:function(e){var t=e.readInt(7,11),n=e.readInt(12,16),r=e.readInt(17,21),i=e.readInt(22,26),o=e.readInt(27,31),a=this._complex;n&&n>t&&a.addBond(t,n,0,Hc.BondType.UNKNOWN,!0),r&&r>t&&a.addBond(t,r,0,Hc.BondType.UNKNOWN,!0),i&&i>t&&a.addBond(t,i,0,Hc.BondType.UNKNOWN,!0),o&&o>t&&a.addBond(t,o,0,Hc.BondType.UNKNOWN,!0)}},{key:"_parseCOMPND",value:function(e){var t=e.readString(11,80),n=t.indexOf(":");if(this._compndCurrToken=n>0?t.substring(0,n).trim():this._compndCurrToken,"MOL_ID"===this._compndCurrToken)this._molecule={_index:"",_chains:[]},this._molecule._index=parseInt(t.substring(n+1,t.indexOf(";")),10),this._molecules.push(this._molecule);else if("MOLECULE"===this._compndCurrToken&&null!=this._molecule)this._molecule._name=t.substring(n+1,t.indexOf(";")).trim();else if("CHAIN"===this._compndCurrToken&&null!=this._molecule){var r=t.substring(n+1,80).trim(),i=r[r.length-1];";"!==i&&","!==i||(r=r.slice(0,-1));var o=(r=r.replace(/\s+/g,"")).split(",");this._molecule._chains=this._molecule._chains.concat(o)}}},{key:"_parseREMARK",value:function(e){var t=e.readInt(8,10),n=this._remarks[t];if(h.a.isUndefined(n)){var r=qc[t];h.a.isFunction(r)&&(this._remarks[t]=n=new r(this._complex))}h.a.isUndefined(n)||n.parse(e)}},{key:"_parseHELIX",value:function(e){var t=this;this._parseSTRUCTURE(e,[20,22,32,34],(function(e){t._complex.addHelix(e),t._complex.structures.push(e)}))}},{key:"_parseSHEET",value:function(e){var t=this;this._parseSTRUCTURE(e,[22,23,33,34],(function(e){t._complex.addSheet(e)}))}},{key:"_parseSTRUCTURE",value:function(e,t,n){var r=e.readInt(8,10),i=e.readString(12,14).trim(),o=e.readString(41,70).trim(),a=e.readInt(72,76),s=e.readInt(39,40),l=e.readInt(15,16),c=e.readInt(42,45),u=e.readInt(57,60),h=e.readString(t[0],t[2]+1).charCodeAt(0),d=e.readString(t[2],t[2]+1).charCodeAt(0),f=e.readInt(t[1],t[1]+3),p=e.readString(t[1]+4,t[1]+4),m=0;p.length>0&&(m=p.charCodeAt(0));var v,y=e.readInt(t[3],t[3]+3),_=0;(p=e.readString(t[3]+4,t[3]+4)).length>0&&(_=p.charCodeAt(0));var g=this._sheet;if(83===e.readCharCode(1)){null!==g&&g.getName()!==i&&(g=null,this._sheet=null),null===g?(this._sheet=v=new Gc(i,l),n(v)):v=g;var x=new jc(v,this._complex.getUnifiedSerial(h,f,m),this._complex.getUnifiedSerial(d,y,_),s,c,u);v.addStrand(x),this._complex.structures.push(x)}else n(v=new Uc(s,this._complex.getUnifiedSerial(h,f,m),this._complex.getUnifiedSerial(d,y,_),r,i,o,a))}},{key:"_parseHEADER",value:function(e){var t=this._complex.metadata;t.classification=e.readString(11,50).trim(),t.date=e.readString(51,59).trim();var n=e.readString(63,66).trim();t.id=n,n&&(this._complex.name=n),t.format="pdb"}},{key:"_parseTITLE",value:function(e){var t=this._complex.metadata;t.title=t.title||[];var n=e.readInt(9,10)||1;t.title[n-1]=e.readString(11,80).trim()}},{key:"parseSync",value:function(){for(var e=new Vc(this._data),t=this._complex=new Fc;!e.end();){var r=e.readString(1,6),i=n.tagParsers[r];h.a.isFunction(i)&&i.call(this,e),e.next()}if(this._finalize(),this._serialAtomMap=null,this._sheet=null,this._residue=null,this._chain=null,this._complex=null,0===t.getAtomCount())throw new Error("The data does not contain valid atoms");return t}}],[{key:"canProbablyParse",value:function(e){return h.a.isString(e)&&Yc.test(e)}}]),n}(Mc);Re()(Xc,"tagParsers",{HEADER:Xc.prototype._parseHEADER,"TITLE ":Xc.prototype._parseTITLE,"ATOM  ":Xc.prototype._parseATOM,HETATM:Xc.prototype._parseATOM,ENDMDL:Xc.prototype._parseENDMDL,CONECT:Xc.prototype._parseCONECT,COMPND:Xc.prototype._parseCOMPND,REMARK:Xc.prototype._parseREMARK,"HELIX ":Xc.prototype._parseHELIX,"SHEET ":Xc.prototype._parseSHEET,"ATOM 1":Xc.prototype._parseATOM,"ATOM 2":Xc.prototype._parseATOM,"ATOM 3":Xc.prototype._parseATOM,"ATOM 4":Xc.prototype._parseATOM,"ATOM 5":Xc.prototype._parseATOM,"ATOM 6":Xc.prototype._parseATOM,"ATOM 7":Xc.prototype._parseATOM,"ATOM 8":Xc.prototype._parseATOM,"ATOM 9":Xc.prototype._parseATOM}),Xc.formats=["pdb"],Xc.extensions=[".pdb",".ent"];var $c=Xc;function Kc(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var Zc=kn.Complex,Qc=kn.Element,Jc=kn.SGroup,eu=kn.Bond,tu={A:0,S:1,D:2,T:3},nu=/\s*<\?xml\b[^?>]*\?>\s*<(?:cml|molecule)\b/i,ru=function(e){S()(n,e);var t=Kc(n);function n(e,r){var i;return m()(this,n),(i=t.call(this,e,r))._complex=null,i._residue=null,i._serialAtomMap=null,i._modelId=1,i._lastMolId=-1,i._readOnlyOneMolecule=!1,i._options.fileType="cml",i}return y()(n,[{key:"_rebuidBondIndexes",value:function(e,t){for(var n=e.length,r=0;r<n;r++)for(var i=e[r].id,o=t.length,a=0;a<o;a++){var s=t[a].atomRefs2.split(" ");s[0]===i&&(t[a].start=r),s[1]===i&&(t[a].end=r)}}},{key:"_createSGroup",value:function(e,t){var n=new Jc(e.id,e.fieldData,new d.Vector3(parseFloat(e.x),parseFloat(e.y),0),e.atomRefs,e);"Relative"===e.placement&&(n._center=new d.Vector3(0,0,0)),"MDLBG_FRAGMENT_CHARGE"===e.fieldName&&(n._charge=parseInt(e.fieldData,10)||0),"MDLBG_FRAGMENT_COEFFICIENT"===e.fieldName&&(n._repeat=parseInt(e.fieldData,10)||1),t.push(n)}},{key:"_extractSGroup",value:function(e,t){if(Array.isArray(t)||(t=[]),e)if(Array.isArray(e))for(var n=e.length,r=0;r<n;r++)e[r].molecule&&(t=t.concat(this._extractSGroup(e[r].molecule))),this._createSGroup(e[r],t);else e.molecule&&e.molecule&&(t=t.concat(this._extractSGroup(e.molecule))),this._createSGroup(e,t);return t}},{key:"_extractSGroups",value:function(e,t){var n,r,i=this._extractSGroup(e),o=t.length;for(n=0;n<o;n++){var a=t[n].id;for(r=0;r<i.length;r++){i[r]._atoms.split(" ")[0]===a&&(t[n].sgroupRef||(t[n].sgroupRef=[]),t[n].sgroupRef.push(i[r]))}}var s,l={},c=null,u=1e8,h=new d.Vector3(u,u,u),f=new d.Vector3(-u,-u,-u);function p(e){(c=l[e])&&i[r]._atoms.push(c.a)}function m(e){(c=l[e])&&(h.set(Math.min(h.x,c.x),Math.min(h.y,c.y),Math.min(h.z,c.z)),f.set(Math.max(f.x,c.x),Math.max(f.y,c.y),Math.max(f.z,c.z)),p(e))}for(n=0;n<t.length;n++)l[t[n].id]={},l[t[n].id].x=t[n].x2,t[n].x3&&(l[t[n].id].x=t[n].x3),l[t[n].id].x=parseFloat(l[t[n].id].x),l[t[n].id].y=t[n].y2,t[n].y3&&(l[t[n].id].y=t[n].y3),l[t[n].id].y=parseFloat(l[t[n].id].y),l[t[n].id].z="0.0",t[n].z3&&(l[t[n].id].z=t[n].z3),l[t[n].id].z=parseFloat(l[t[n].id].z),l[t[n].id].a=t[n];for(r=0;r<i.length;r++)null!==i[r]._center?(h.set(u,u,u),f.set(-u,-u,-u),s=i[r]._atoms.split(" "),i[r]._atoms=[],s.forEach(m),i[r]._center.addVectors(h,f),i[r]._center.multiplyScalar(.5)):(s=i[r]._atoms.split(" "),i[r]._atoms=[],s.forEach(p));l=null}},{key:"_traverseData",value:function(e){var t={};return e.childNodes.length&&function e(t,n){if("#text"!==t.nodeName||""!==t.nodeValue.trim()){var r={};r.xmlNode=t;var i,o,a,s=n[t.nodeName];if(s?(i=s,"[object Array]"!==Object.prototype.toString.apply(i)?n[t.nodeName]=[s,r]:n[t.nodeName].push(r)):n[t.nodeName]=r,t.attributes)for(o=t.attributes.length,a=0;a<o;a++){var l=t.attributes[a];r[l.nodeName]=l.nodeValue}for(o=t.childNodes.length,a=0;a<o;a++)e(t.childNodes[a],r)}}(e.childNodes[0],t),t}},{key:"_findSuitableMolecule",value:function(e,t){for(var n in e)if("xmlNode"!==n)if("molecule"===n){if(e.molecule&&(e.molecule.atomArray&&e.molecule.atomArray.atom&&t.push(e),Array.isArray(e.molecule)))for(var r=0;r<e.molecule.length;r++)e.molecule[r].atomArray&&e.molecule[r].atomArray.atom&&t.push({molecule:e.molecule[r]})}else e[n]&&null!==e[n]&&"object"===ee()(e[n])&&this._findSuitableMolecule(e[n],t)}},{key:"_selectComponents",value:function(e){var t,n=(new DOMParser).parseFromString(e,"application/xml"),r=this._traverseData(n),i=this;t=r.cml?r.cml:r;var o=[],a=[];return this._findSuitableMolecule(t,a),this._readOnlyOneMolecule&&a.length>1&&a.splice(1,a.length-1),a.forEach((function(e){var t=function(e){var t,r=[];if(e.molecule&&e.molecule.atomArray&&e.molecule.atomArray.atom)Array.isArray(e.molecule.atomArray.atom)?r=e.molecule.atomArray.atom:r.push(e.molecule.atomArray.atom);else if(!e.molecule){var o={atomLabels:null,labelsCount:1};return o}e.molecule.molecule&&i._extractSGroups(e.molecule.molecule,r);for(var a=r.length,s=0;s<a;s++)(t=r[s]).edges=[];var l,c=[];e.molecule.bondArray&&e.molecule.bondArray.bond&&(Array.isArray(e.molecule.bondArray.bond)?c=e.molecule.bondArray.bond:c.push(e.molecule.bondArray.bond)),a=c.length,i._rebuidBondIndexes(r,c);for(var u=0;u<a;u++)if(l=c[u],(t=r[l.start])&&(t.edges.push(l.end),(t=r[l.end])&&(t.edges.push(l.start),1))){var h=l.xmlNode.getAttribute("order"),d=parseInt(h,10);if(c[u].order=0,c[u].type=eu.BondType.UNKNOWN,d>1)c[u].order=d;else{var f=tu[h];void 0!==f&&(c[u].order=f,"A"===h&&(c[u].type=eu.BondType.AROMATIC))}}a=r.length;for(var p=0;p<a;p++)(t=r[p]).edges.sort();var m=i._breadWidthSearch(r,0),v={};return v.atoms=r,v.bonds=c,v.labels=m.atomLabels,v.count=Math.min(1,m.labelsCount),v.curr=-1,v.originalCML=n,v}(e);t.atoms.length>0&&o.push(t)})),o}},{key:"_packLabel",value:function(e,t){return(t<<16)+e}},{key:"_unpackLabel",value:function(e){return{molId:e>>>16,compId:65535&e}}},{key:"_breadWidthSearch",value:function(e,t){var n,r=new Array(e.length);for(n=0;n<r.length;n++)r[n]=this._packLabel(0,t);for(var i=[],o=0,a=e.length;a>0;){o++;var s=-1;for(n=0;n<r.length;n++)if(0===this._unpackLabel(r[n]).compId){s=n;break}if(s<0)break;for(i.push(e[s]),r[s]=this._packLabel(o,t),a--;i.length>0;){var l=i.shift();if(l)for(var c=0;c<l.edges.length;c++)r[l.edges[c]]!==o&&(i.push(e[l.edges[c]]),r[l.edges[c]]=o,a--)}}var u={};return u.atomLabels=r,u.labelsCount=o,u}},{key:"_parseBond",value:function(e,t,n,r){if(e>=0){var i=[Math.min(e,t),Math.max(e,t)];this._complex.addBond(i[0],i[1],n,r,!0)}}},{key:"_fixBondsArray",value:function(){for(var e=this._serialAtomMap={},t=this._complex,n=t._atoms,r=0,i=n.length;r<i;++r){var o=n[r];e[o.serial]=o}for(var a=t._bonds,s=this.logger,l=0,c=a.length;l<c;++l){var u=a[l];u._right<u._left&&s.debug("_fixBondsArray: Logic error."),u._left=e[u._left]||null,u._right=e[u._right]||null}}},{key:"_parseSet",value:function(e){var t,n,r=this._complex=new Zc,i=e,o=i.curr,a=i.atoms,s=i.labels,l=null,c=a.length;var u,h={},f=[];for(t=0;t<c;t++)f.push(t);for(f.sort((function(e,t){return s[e]-s[t]})),t=0;t<c;t++){var p=s[f[t]];if(this._unpackLabel(p).molId===this._unpackLabel(o).molId){var m=(l=a[f[t]]).elementType;if(l.sgroupRef)for(var v=l.sgroupRef.length,y=0;y<v;++y)r._sgroups.push(l.sgroupRef[y]);if(l.x3||l.x2){var _=this._unpackLabel(p).compId,g=_,x=_.toString();1===x.length&&(x="0".concat(x));var b="N".concat(x),w=h[" "];w&&" "===w.getName()||(h[" "]=w=this._complex.getChain(" ")||this._complex.addChain(" "),this._residue=null);var S=this._residue;S&&S.getSequence()===g&&" "===S.getICode()||(this._residue=S=w.addResidue(b,g," "));var C=null;l.x3?C=new d.Vector3(parseFloat(l.x3),parseFloat(l.y3),parseFloat(l.z3)):l.x2&&(C=new d.Vector3(parseFloat(l.x2),parseFloat(l.y2),0));var R=Qc.ByName[l.elementType.toUpperCase()];R||((R=JSON.parse(JSON.stringify(Qc.ByName[Object.keys(Qc.ByName)[Object.keys(Qc.ByName).length-1]]))).number+=1,R.name=l.elementType.toUpperCase(),R.fullName="Unknown",Qc.ByName[l.elementType.toUpperCase()]=R);var A=parseInt(l.id.replace(/[^0-9]/,""),10),E=S.addAtom(m,R,C,Qc.Role.SG,!0,A," ",1,0,0);l.hydrogenCount&&(E.hydrogenCount=parseInt(l.hydrogenCount,10)),l.mrvValence&&(E.valence=parseInt(l.mrvValence,10)),(u=E).xmlNodeRef=l,l.x2&&(l.x3=l.x2,delete l.x2),l.y2&&(l.y3=l.y2,delete l.y2),l.z3||(l.z3="0.0"),l.complexAtom=u}}}for(h=null,t=0;t<i.bonds.length;t++){var k=i.bonds[t];if(this._unpackLabel(s[k.start]).molId===this._unpackLabel(o).molId&&this._unpackLabel(s[k.end]).molId===this._unpackLabel(o).molId){if(!(l=a[k.start])||!a[k.end])continue;this._parseBond(parseInt(l.id.replace(/[^0-9]/,""),10),parseInt(a[k.end].id.replace(/[^0-9]/,""),10),k.order,k.type)}}for(t=0;t<this._complex.getSGroupCount();t++){var T=this._complex.getSGroups()[t];for(n=0;n<T._atoms.length;n++)T._atoms[n]=T._atoms[n].complexAtom}for(t=0;t<c;t++)this._unpackLabel(s[t]).molId===this._unpackLabel(o).molId&&((l=a[t]).complexAtom=null,delete l.complexAtom);return this._complex.originalCML=i.originalCML,this._fixBondsArray(),r.finalize({needAutoBonding:!1,detectAromaticLoops:this.settings.now.aromatic,enableEditing:this.settings.now.editing,serialAtomMap:this._serialAtomMap}),this._serialAtomMap=null,this._complex=null,r}},{key:"parseSync",value:function(){var e=[],t=this;this._selectComponents(this._data).forEach((function(n){n.curr=2,0===n.count&&(n.count=1);for(var r=0;r<n.count;r++)n.curr=r+1,e.push(t._parseSet(n,!1))}));var n=0;if(e.forEach((function(e){n+=e.getAtomCount()})),n<=0)throw new Error("The data does not contain valid atoms");if(e.length>1){var r=new Zc;return r.joinComplexes(e),r.originalCML=e[0].originalCML,r}return 1===e.length?e[0]:new Zc}}],[{key:"canProbablyParse",value:function(e){return h.a.isString(e)&&nu.test(e)}}]),n}(Mc);ru.formats=["cml"],ru.extensions=[".cml"];var iu=ru,ou=n("rVTi"),au=n.n(ou);function su(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var lu=kn.Complex,cu=kn.Chain,uu=kn.Atom,hu=kn.Element,du=kn.Helix,fu=kn.Sheet,pu=kn.Strand,mu=kn.Bond,vu=kn.Assembly,yu=kn.Molecule,_u=function(){function e(t){m()(this,e),this._original=Array.from(t),this._original.sort(),this._sum=0;for(var n=0;n<this._original.length;++n)this._sum+=this._original[n]}return y()(e,[{key:"compare",value:function(e){var t=e.length;if(t!==this._original.length)return!1;var n,r=0;for(n=0;n<t;++n)r+=e[n];if(r!==this._sum)return!1;var i=Array.from(e);for(i.sort(),n=0;n<t;++n)if(i[n]!==this._original[n])return!1;return!0}}]),e}();_u.prototype.constructor=_u;var gu=Qe.Type,xu=[gu.HELIX_PI,gu.BEND,gu.HELIX_ALPHA,gu.STRAND,gu.HELIX_310,gu.BRIDGE,gu.TURN,gu.COIL];var bu=function(e){S()(n,e);var t=su(n);function n(e,r){var i;return m()(this,n),(i=t.call(this,e,r))._options.fileType="mmtf",i}return y()(n,[{key:"_onModel",value:function(e){}},{key:"_onChain",value:function(e){if(0===e.modelIndex){var t=new cu(this._complex,e.chainName);this._complex._chains[e.chainIndex]=t,t._index=e.chainIndex}}},{key:"_onGroup",value:function(e){if(0===e.modelIndex&&(!this.settings.now.nowater||"HOH"!==e.groupName&&"WAT"!==e.groupName)){var t=this._complex._chains[e.chainIndex],n=e.insCode.charCodeAt(0)?e.insCode:"",r=t.addResidue(e.groupName,e.groupId,n);r._index=e.groupIndex,this._updateSecStructure(this._complex,r,e)}}},{key:"_onAtom",value:function(e){if(0===e.modelIndex){var t=e.altLoc.charCodeAt(0)?e.altLoc:"",n=new uu(e.groupIndex,e.atomName,hu.getByName(e.element.toUpperCase()),new d.Vector3(e.xCoord,e.yCoord,e.zCoord),hu.Role[e.atomName],!1,e.atomId,t,e.occupancy,e.bFactor,e.formalCharge);this._complex._atoms[e.atomIndex]=n,n.index=e.atomIndex,this._serialAtomMap[e.atomId]=n}}},{key:"_onBond",value:function(e){var t=Math.max(e.atomIndex1,e.atomIndex2);if(!(t>=this._complex._atoms.length)){var n=Math.min(e.atomIndex1,e.atomIndex2);this._complex.addBond(this._complex._atoms[n],this._complex._atoms[t],e.bondOrder,mu.BondType.UNKNOWN,!0)}}},{key:"_updateSecStructure",value:function(e,t,n){if(!h.a.isUndefined(n)&&n.secStruct===this._ssType)return t._secondary=this._ssStruct,void(this._ssStruct&&(this._ssStruct.term=t));if(!h.a.isUndefined(n)){var r=xu[n.secStruct];this._ssType=n.secStruct,this._ssStart=t;var i=null;switch(this._ssType){case-1:case 7:break;case 0:case 2:case 4:i=new du([3,-1,1,-1,5][this._ssType],t,t,0,"","",0),e._helices.push(i);break;case 3:var o=new fu("",0);e._sheets.push(o),i=new pu(o,t,t,0,null,null);break;default:void 0!==r&&(i=new Qe(r,t,t))}this._ssStruct=i,t._secondary=i,i&&e.structures.push(i)}}},{key:"_updateMolecules",value:function(e){var t=e.entityList;if(t)for(var n=e.chainsPerModel[0],r=0;r<t.length;r++){for(var i=t[r],o=i.chainIndexList,a=[],s=0;s<o.length;s++){var l=o[s];if(!(l>=n)){var c=this._complex._chains[l];a=a.concat(c._residues.slice())}}var u=new yu(this._complex,i.description,r+1);u.residues=a,this._complex._molecules[r]=u}}},{key:"_traverse",value:function(e){var t=this,n=this._complex.metadata;n.id=e.structureId,n.title=[],n.title[0]=e.title,n.date=e.releaseDate,n.format="mmtf";var r={onModel:function(e){t._onModel(e)},onChain:function(e){t._onChain(e)},onGroup:function(e){t._onGroup(e)},onAtom:function(e){t._onAtom(e)},onBond:function(e){t._onBond(e)}};this._ssType=-1,this._ssStruct=null,this._ssStart=null,au.a.traverse(e,r),this._updateSecStructure(this._complex),this._updateMolecules(e)}},{key:"_linkAtomsToResidues",value:function(){for(var e=0;e<this._complex._atoms.length;++e){var t=this._complex._atoms[e],n=this._complex._residues[t.residue];t.residue=n,n._atoms.push(t)}}},{key:"_findSynonymousChains",value:function(){for(var e={},t=0;t<this._complex._chains.length;++t){var n=this._complex._chains[t],r=n.getName();e.hasOwnProperty(r)||(e[r]=[]),e[r].push(n._index)}return e}},{key:"_parseAssemblyInfo",value:function(e){var t,n,r,i=[],o=this.logger;for(t=0;t<e.bioAssemblyList.length;++t){var a=e.bioAssemblyList[t];if(0!==a.transformList.length){var s=a.transformList[0].chainIndexList,l=new _u(s),c={};for(n=0;n<s.length;++n)c[this._complex._chains[s[n]].getName()]=1;var u=[],h=void 0;for(h in c)c.hasOwnProperty(h)&&Array.prototype.push.apply(u,this._chainsByName[h]);l.compare(u)||o.debug("MMTF: Assembly is missing some of the synonymous chains. Skipping...");var f=new vu(this._complex);for(h in c)c.hasOwnProperty(h)&&f.addChain(h);for(f.addMatrix((new d.Matrix4).fromArray(a.transformList[0].matrix).transpose()),n=1;n<a.transformList.length;++n){var p=a.transformList[n];if(l.compare(p.chainIndexList)){var m=(new d.Matrix4).fromArray(p.matrix).transpose();for(r=0;r<f.matrices.length&&!f.matrices[r].equals(m);++r);r===f.matrices.length&&f.addMatrix(m)}else o.debug("MMTF: Chain lists differ for different transforms in one assembly. Skipping...")}f.finalize(),i.push(f)}}return i}},{key:"_markHeteroAtoms",value:function(e){for(var t=e.chainsPerModel[0],n=0;n<e.entityList.length;++n){var r=e.entityList[n];if("polymer"!==r.type)for(var i=0;i<r.chainIndexList.length;++i){var o=r.chainIndexList[i];if(!(o>=t))for(var a=this._complex._chains[o],s=0;s<a._residues.length;++s)for(var l=a._residues[s],c=0;c<l._atoms.length;++c)l._atoms[c].het=!0}}}},{key:"_joinSynonymousChains",value:function(){var e,t,n=[],r={};for(e=0;e<this._complex._chains.length;++e){var i=this._complex._chains[e],o=i.getName();if(r.hasOwnProperty(o)){var a=r[o];for(t=0;t<i._residues.length;++t){var s=i._residues[t];a._residues.push(s),s._chain=a}}else r[o]=i,i._index=n.length,n.push(i)}this._complex._chains=n}},{key:"parseSync",value:function(){var e=au.a.decode(this._data);return this._complex=new lu,this._serialAtomMap={},this._traverse(e),this._linkAtomsToResidues(),this._markHeteroAtoms(e),this._chainsByName=this._findSynonymousChains(),Array.prototype.push.apply(this._complex.units,this._parseAssemblyInfo(e)),this._joinSynonymousChains(),this._complex.finalize({needAutoBonding:!1,detectAromaticLoops:this.settings.now.aromatic,enableEditing:this.settings.now.editing,serialAtomMap:this._serialAtomMap}),this._complex}}],[{key:"canProbablyParse",value:function(e){return h.a.isArrayBuffer(e)&&223==(1|new Uint8Array(e,0,1)[0])}}]),n}(Mc);bu.formats=["mmtf"],bu.extensions=[".mmtf"],bu.binary=!0;var wu=bu;function Su(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var Cu=function(e){S()(n,e);var t=Su(n);function n(e,r,i){var o;return m()(this,n),o=t.call(this,"data:".concat(r,":").concat(i,": ").concat(e)),Error.captureStackTrace&&Error.captureStackTrace(Pn()(o),n),o.name="ParsingError",o.parseLine=r,o.parseColumn=i,o}return n}(T()(Error));function Ru(e){return 32===e||10===e||13===e||9===e}function Au(e,t,n){for(var r=t.length,i=-1;n<r&&(i=t.charCodeAt(n))!==e&&10!==i;)++n;return i===e?n:-1}function Eu(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var ku=kn.Complex,Tu=kn.Element,Pu=kn.Helix,Mu=kn.Sheet,Iu=kn.Strand,Nu=kn.Assembly,Lu=kn.Molecule,Du=["auth_seq_id","Cartn_x","Cartn_y","Cartn_z","label_atom_id"],Ou={helx:"helix",turn:"turn",strn:"strand"};function Vu(e){return null==e||h.a.isArray(e)?e:[e]}function zu(e){var t=4===e.trim().length;return e.slice(0,t?1:2).trim()}var Fu=function(e){S()(n,e);var t=Eu(n);function n(e){var r;return m()(this,n),(r=t.call(this)).name="AtomDataError",r.message=e,r}return n}(T()(Error));function Bu(e,t){for(var n=(e=h.a.isString(e)?e:"".concat(e)).replace(/\)\s*\(/g,"!").replace(/[()']/g,"").split("!"),r=[],i=0,o=n.length;i<o;++i){for(var a=n[i].split(","),s=[],l=0,c=0,u=a.length;c<u;++c){var f=a[c];if(f.includes("-"))for(var p=f.split("-"),m=parseInt(p[0],10),v=parseInt(p[1],10);m<=v;++m)s[l++]=t[m];else s[l++]=t[f]}r.push(s)}var y=[],_=0;return function e(t,n){for(var i=0,o=r[t].length;i<o;++i){var a=n?n.clone():new d.Matrix4;a.multiplyMatrices(r[t][i],a),0===t?y[_++]=a:e(t-1,a)}}(r.length-1),y}var Uu=function(e){S()(n,e);var t=Eu(n);function n(e,r){var i;return m()(this,n),(i=t.call(this,e,r)).asymDict={},i.molecules=[],i._options.fileType="cif",i}return y()(n,[{key:"parseSync",value:function(){this.logger.info("Parsing CIF file..");var e=function(e){var t,n,r,i,o=0,a=0,s=e.length,l=NaN,c=!0,u=1,d=1,f=0,p={},m={},v=[],y=0,_="",g=[],x=0;function b(){var t;if((46===l||63===l)&&(o+1>=s||Ru(e.charCodeAt(o+1))))return++d,void++o;if(c&&59===l){a=o;var n=0;do{if(-1===(a=Au(10,e,a+1)))throw new Cu("Unterminated text block found",u,d);++n}while(a+1<s&&e.charCodeAt(a+1)!==l||a+1>=s);return t=e.substring(o+1,a).replace(/\r/g,""),o=a+2,u+=n,d=1,c=!1,t}if(39===l||34===l){a=o;do{if(-1===(a=Au(l,e,a+1)))throw new Cu("Unterminated quoted string found",u,d)}while(a+1<s&&!Ru(e.charCodeAt(a+1)));return t=e.substring(o+1,a),d+=a-o+1,o=a+1,t}for(a=o;a<s&&!Ru(e.charCodeAt(a));)++a;t=e.substring(o,a),d+=a-o,o=a;var r=Number(t);return Number.isNaN(r)?t:r}for(;o<=s;){if(13===(l=e.charCodeAt(o)));else if(10===l)c=!0,++u,d=1;else{if(32!==l&&9!==l){if(35===l){if(-1===(o=Au(10,e,o+1)))break;continue}if(0===f){if(68!==l&&100!==l||"ata_"!==e.substr(o+1,4).toLowerCase()){if(Number.isNaN(l))break;throw new Cu("Unexpected character in state ".concat(f),u,d)}for(t=a=o+5;a<s&&!Ru(e.charCodeAt(a));)++a;if(d+=a-o,t<(o=a)){p[e.substring(t,o)]=m={},f=1;continue}throw new Cu("Data block name missing",u,d)}if(1===f){if(68!==l&&100!==l||"ata_"!==e.substr(o+1,4).toLowerCase()){if(95===l){for(t=a=o+1;a<s&&!Ru(e.charCodeAt(a));)++a;if(d+=a-o,t<(o=a)){_=e.substring(t,o),f=2;continue}throw new Cu("Tag name missing",u,d)}if(76!==l&&108!==l||"oop_"!==e.substr(o+1,4).toLowerCase()){if(Number.isNaN(l))break;throw new Cu("Unexpected character in state ".concat(f),u,d)}if(d+=5,(o+=5)<s&&!Ru(e.charCodeAt(o)))throw new Cu("Unexpected character in state ".concat(f),u,d);v=[],y=0,g=[],x=0,f=3;continue}f=0;continue}if(2===f){if(Number.isNaN(l))break;n=b(),h.a.set(m,_,n),f=1;continue}if(3===f){if(95===l){for(t=a=o+1;a<s&&!Ru(e.charCodeAt(a));)++a;if(d+=a-o,t<(o=a)){i=e.substring(t,o),v[y++]=i;continue}throw new Cu("Tag name missing",u,d)}if(y>0){for(var w=0;w<y;++w)n=[],g[w]=n,h.a.set(m,v[w],n);f=4;continue}throw new Cu("Data tags are missing inside a loop",u,d)}if(4===f){68!==l&&100!==l||"ata_"!==e.substr(o+1,4).toLowerCase()?95===l?f=1:76!==l&&108!==l||"oop_"!==e.substr(o+1,4).toLowerCase()?Number.isNaN(l)?f=0:(r=b(),g[x%y].push(r),++x):f=1:f=0;continue}throw new Cu("Unexpected internal state ".concat(f),u,d)}c=!1,++d}++o}if(2===f)throw new Cu("Unexpected end of file in state ".concat(f),u,d);return p}(this._data);return this._toComplex(e)}},{key:"_toComplex",value:function(e){var t=new ku,n=e[Object.keys(e)[0]];return this._extractAtoms(t,n),this._extractSecondary(t,n),this._extractAssemblies(t,n),this._extractMolecules(t,n),this._extractMetadata(t,n),t.finalize({needAutoBonding:!0,detectAromaticLoops:this.settings.now.aromatic,enableEditing:this.settings.now.editing}),t}},{key:"_extractMetadata",value:function(e,t){var n=e.metadata;n.id=t.entry.id,n.classification=t.struct_keywords.pdbx_keywords;var r=t.database_PDB_rev;n.date=r&&r.date_original?r.date_original:"",n.format="cif",n.title=[],n.title[0]=t.struct.title}},{key:"_extractMolecules",value:function(e,t){var n,r=Vu(t.entity.pdbx_description),i=r.length;for(n=0;n<i;n++)this.molecules[n]?this.molecules[n].name=r[n]:this.molecules[n]={name:r[n],residues:[]};var o=e.getMolecules();for(n=0;n<i;n++){var a=this.molecules[n];o[n]=new Lu(e,a.name,n+1),o[n].residues=a.residues}}},{key:"_extractAtoms",value:function(e,t){var n=t.atom_site;if(!n)throw new Fu("CIF parsing error: atom_site is not specified!");for(var r=0,i=Du.length;r<i;++r)if(!n[Du[r]])throw new Fu("CIF parsing error: requires field ".concat(Du[r]," not found!"));for(var o=this.asymDict,a=Vu(n.auth_seq_id),s=Vu(n.Cartn_x),l=Vu(n.Cartn_y),c=Vu(n.Cartn_z),u=Vu(n.label_atom_id),h=u.length,f=Vu(n.group_PDB)||[],p=Vu(n.auth_asym_id)||[],m=Vu(n.label_asym_id)||[],v=Vu(n.id)||[],y=Vu(n.pdbx_PDB_ins_code)||[],_=Vu(n.label_comp_id)||[],g=Vu(n.type_symbol)||[],x=Vu(n.B_iso_or_equiv)||[],b=Vu(n.occupancy)||[],w=Vu(n.pdbx_formal_charge)||[],S=Vu(n.label_alt_id)||[],C=Vu(n.pdbx_PDB_model_num)||[],R=Vu(n.label_entity_id)||[],A=null,E=null,k=0;k<h;++k){if(1===(C[k]||1)){var T=String(p[k]||" ");A&&A.getName()===T||(A=e.getChain(T)||e.addChain(T)),o[String(m[k]||" ")]=T;var P=a[k],M=String(y[k]||" "),I=String(_[k]||"");if(!E||E.getSequence()!==P||E.getICode()!==M){E=A.addResidue(I,P,M);var N=R[k]-1,L=this.molecules[N];L||(this.molecules[N]={name:"",residues:[]},L=this.molecules[N]),L.residues.push(E)}var D=u[k],O=g[k]||zu(D),V=Tu.getByName(O),z=Tu.Role[D.trim()],F=new d.Vector3(s[k],l[k],c[k]),B="HETATM"===f[k]||!1,U=v[k]||k,G=x[k]||0,j=b[k]||0,H=String(S[k]||""),W=w[k]||0;E.addAtom(D,V,F,z,B,U,H,j,G,W)}}}},{key:"_extractSecondary",value:function(e,t){t.struct_conf&&this._extractConfs(e,t.struct_conf),t.struct_sheet_range&&this._extractSheets(e,t.struct_sheet_range)}},{key:"_extractSheets",value:function(e,t){var n=this.asymDict;if(t.sheet_id&&t.id&&t.beg_label_seq_id&&t.end_label_seq_id&&t.beg_label_asym_id)for(var r=e._sheets,i=Vu(t.sheet_id),o=Vu(t.id),a=Vu(t.beg_auth_seq_id),s=Vu(t.end_auth_seq_id),l=Vu(t.beg_label_asym_id),c=Vu(t.pdbx_beg_PDB_ins_code)||[],u=Vu(t.pdbx_end_PDB_ins_code)||[],h=0,d=o.length;h<d;++h){var f=e.getChain(n[l[h]]),p=C(i[h]),m=a[h],v=s[h],y=c[h]||" ",_=u[h]||" ",g=f.findResidue(m,y),x=f.findResidue(v,_);if(g&&x){for(var b=new Iu(p,g[0],x[0],0,null,null),w=f.getResidues(),S=g[1];S<=x[1];++S)w[S]._secondary=b;p.addStrand(b),e.structures.push(b)}}function C(e){for(var t=r.length,n=0;n<t;++n)if(r[n]._name===e)return r[n];return r[t]=new Mu(e,0),r[t]}}},{key:"_extractConfs",value:function(e,t){var n=this.asymDict;if(t.conf_type_id&&t.beg_label_seq_id&&t.end_label_seq_id&&t.beg_label_asym_id)for(var r,i,o=Vu(t.conf_type_id),a=Vu(t.beg_auth_seq_id),s=Vu(t.pdbx_beg_PDB_ins_code)||[],l=Vu(t.end_auth_seq_id),c=Vu(t.pdbx_end_PDB_ins_code)||[],u=Vu(t.details)||[],h=Vu(t.pdbx_PDB_helix_length)||[],d=Vu(t.pdbx_PDB_helix_class)||[],f=Vu(t.id)||[],p=Vu(t.beg_label_asym_id),m=0,v=o.length;m<v;++m){var y=(r=o[m],i=void 0,(i=/[A-Za-z]+/.exec(r))?Ou[i[0].toLowerCase()]:null);if(y){var _=f[m]||o[m],g=e.getChain(n[p[m]]),x=a[m],b=l[m],w=s[m]||" ",S=c[m]||" ",C=g.findResidue(x,w),R=g.findResidue(b,S);if(C&&R){var A=u[m]||"",E=h[m]||0,k=d[m]||" ",T=void 0;if("helix"===y){var P=e._helices.length;T=new Pu(k,C[0],R[0],P,_,A,E),e.addHelix(T),e.structures.push(T)}else"turn"===y?(T=new Qe(Qe.Type.TURN,C[0],R[0]),e.structures.push(T)):T=null;if(T)for(var M=g.getResidues(),I=C[1];I<=R[1];++I)M[I]._secondary=T}}}}},{key:"_extractAssemblies",value:function(e,t){var n=this.asymDict,r=t.pdbx_struct_assembly_gen;if(r){var i=Vu(r.assembly_id),o=Vu(r.oper_expression),a=Vu(r.asym_id_list);if(i&&o&&a){var s=function(e){if(!e)return null;var t=Vu(e.id),n=e.matrix,r=e.vector;if(!t||!n||!r)return null;for(var i=[],o=0,a=t.length;o<a;++o){for(var s=new d.Matrix4,l=s.elements,c=0;c<3;++c){var u=n[c+1];l[c]=Vu(u[1])[o],l[c+4]=Vu(u[2])[o],l[c+8]=Vu(u[3])[o],l[c+12]=Vu(r[c+1])[o]}i[t[o]]=s}return i}(t.pdbx_struct_oper_list);if(s)for(var l=0,c=i.length;l<c;++l){for(var u=new Nu(e),h=Bu(o[l],s),f=a[l].split(","),p=0,m=f.length;p<m;++p){var v=f[p].trim();v.length>0&&u.addChain(n[v])}u.matrices=h,e.units.push(u)}}}}}],[{key:"canProbablyParse",value:function(e){return h.a.isString(e)&&/^\s*data_/i.test(e)}}]),n}(Mc);Uu.formats=["cif","mmcif"],Uu.extensions=[".cif",".mmcif"];var Gu=Uu,ju=0,Hu=1,Wu=2,Yu=3,qu=function(){function e(){m()(this,e),Re()(this,"_xyz2crs",[]),Re()(this,"_origin",new d.Vector3(0,0,0)),this._header={},this._boxSize=new d.Vector3,this._boxStart=new d.Vector3,this._header.delta={},this._header.extent=[],this._header.nstart=[],this._header.grid=[],this._header.crs2xyz=[],this._header.cellDims=new d.Vector3,this._header.angles=[],this._header.origin=new d.Vector3(0,0,0),this._header.dmin=0,this._header.dmean=0,this._header.dmax=0}return y()(e,[{key:"_typedCheck",value:function(){if(h.a.isTypedArray(this._buff))this._buff=this._buff.buffer;else if(!h.a.isArrayBuffer(this._buff))throw new TypeError("Expected ArrayBuffer or TypedArray")}},{key:"_fillHeader",value:function(e,t){for(var n in e)if(e.hasOwnProperty(n))switch(e[n][0]){case ju:this._header[n]=t[e[n][1]][e[n][2]];break;case Wu:this._parseArray(this._header[n],t[e[n][1]],e[n][2]);break;case Hu:this._parseVector(this._header[n],t[e[n][1]],e[n][2]);break;case Yu:this._header[n]=new Uint8Array(t[e[n][1]],4*[e[n][2]],4*[e[n][3]])}}},{key:"_parseVector",value:function(e,t,n){var r=[t[n],t[n+1],t[n+2]];e.x=r[0],e.y=r[1],e.z=r[2]}},{key:"_parseArray",value:function(e,t,n){e[0]=t[n],e[1]=t[n+1],e[2]=t[n+2]}},{key:"_parseHeader",value:function(e){}},{key:"_setAxisIndices",value:function(){}},{key:"_setOrigins",value:function(){}},{key:"_getAxis",value:function(){var e=this._header,t=e.cellDims.x/e.grid[0],n=e.cellDims.y/e.grid[1],r=e.cellDims.z/e.grid[2],i=c()(e.angles,3),o=i[0],a=i[1],s=i[2],l=Math.cos(a),u=(Math.cos(o)-Math.cos(a)*Math.cos(s))/Math.sin(s),h=Math.sqrt(1-l*l-u*u);return[new d.Vector3(t,0,0),new d.Vector3(Math.cos(s)*n,Math.sin(s)*n,0),new d.Vector3(l*r,u*r,h*r)]}},{key:"_getXYZdim",value:function(){return[this._header.extent[this._xyz2crs[0]],this._header.extent[this._xyz2crs[1]],this._header.extent[this._xyz2crs[2]]]}},{key:"_getVolumeInfo",value:function(){var e=h.a.pick(this._header,["dmean","dmin","dmax","sd","delta"]);return e.obtuseAngle=this._header.angles.map((function(e){return Number(e>=Math.PI/2)})),e}},{key:"_setBoxParams",value:function(e,t,n){var r=this,i=0,o=0,a=c()(this._header.angles,3),s=a[0],l=a[1];a[2]>=Math.PI/2&&(i+=Math.abs(t.x)),l>=Math.PI/2&&(i+=Math.abs(n.x)),s>=Math.PI/2&&(o+=Math.abs(n.y)),this._boxStart=new d.Vector3(this._origin.x-i,this._origin.y-o,this._origin.z),this._boxSize=new d.Vector3(Math.abs(e.x)+Math.abs(t.x)+Math.abs(n.x),Math.abs(t.y)+Math.abs(n.y),Math.abs(n.z));var u=function(e,t){return Math.abs(e[t])/r._boxSize[t]};this._header.delta.x=u(t,"x"),this._header.delta.y=u(n,"x"),this._header.delta.z=u(n,"y")}},{key:"_getXYZbox",value:function(){return new d.Box3(this._boxStart.clone(),this._boxStart.clone().add(this._boxSize))}},{key:"_toXYZData",value:function(){}},{key:"parse",value:function(e){return this._parseHeader(e),this._setOrigins(),new En(Float32Array,this._getXYZdim(),this._getXYZbox(),1,this._toXYZData(),this._getVolumeInfo())}}]),e}();function Xu(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var $u={extent:[Wu,"u32",0],type:[ju,"u32",3],nstart:[Wu,"i32",4],grid:[Wu,"u32",7],cellDims:[Hu,"f32",10],angles:[Wu,"f32",13],crs2xyz:[Wu,"i32",16],dmin:[ju,"f32",19],dmax:[ju,"f32",20],dmean:[ju,"f32",21],ispg:[ju,"u32",22],nsymbt:[ju,"u32",23],lksflg:[ju,"u32",24],customData:[Yu,"buffer",25,9],origin:[Hu,"f32",34],map:[Yu,"buffer",52,1],machine:[ju,"u32",53],sd:[ju,"f32",54],nlabel:[ju,"f32",55],label:[Yu,"buffer",56,200]},Ku=function(e){S()(n,e);var t=Xu(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"_parseHeader",value:function(e){this._buff=e,this._typedCheck();var t={};t.u32=new Uint32Array(this._buff,0,56),t.i32=new Int32Array(this._buff,0,56),t.f32=new Float32Array(this._buff,0,56),t.buffer=this._buff;var n=this._header;this._fillHeader($u,t),n.angles.forEach((function(e,t,n){n[t]*=Math.PI/180}))}},{key:"_setAxisIndices",value:function(){var e=this._header;0===e.cellDims.x&&0===e.cellDims.y&&0===e.cellDims.z&&e.cellDims.set(1,1,1);var t=this._header.crs2xyz;0===t[0]&&0===t[1]&&0===t[2]&&(t[0]=1,t[1]=2,t[2]=3);var n=this._xyz2crs;n[t[0]-1]=0,n[t[1]-1]=1,n[t[2]-1]=2}},{key:"_setOrigins",value:function(){var e=this._getAxis(),t=c()(e,3),n=t[0],r=t[1],i=t[2];this._setAxisIndices();var o=this._header,a=this._xyz2crs;if(0===o.origin.x&&0===o.origin.y&&0===o.origin.z?(this._origin.addScaledVector(n,o.nstart[a[0]]),this._origin.addScaledVector(r,o.nstart[a[1]]),this._origin.addScaledVector(i,o.nstart[a[2]])):this._origin=o.origin,n.multiplyScalar(o.extent[a[0]]-1),r.multiplyScalar(o.extent[a[1]]-1),i.multiplyScalar(o.extent[a[2]]-1),2!==o.type)throw new Error("CCP4: Unsupported format ".concat(o.type));this._data=new Float32Array(this._buff,1024+o.nsymbt,o.extent[0]*o.extent[1]*o.extent[2]),this._setBoxParams(n,r,i)}},{key:"_toXYZData",value:function(){var e=this._header,t=this._data,n=this._xyz2crs,r=new Float32Array(t.length),i=this._getXYZdim(),o=i[0],a=i[1],s=0,l=[];for(l[2]=0;l[2]<e.extent[2];l[2]++)for(l[1]=0;l[1]<e.extent[1];l[1]++)for(l[0]=0;l[0]<e.extent[0];l[0]++,s++)r[l[n[0]]+o*(l[n[1]]+a*l[n[2]])]=t[s];return r}}]),n}(qu),Zu=function(e){S()(n,e);var t=Xu(n);function n(e,r){var i;return m()(this,n),(i=t.call(this,e,r))._options.fileType="ccp4",i.model=new Ku,i}return y()(n,[{key:"parseSync",value:function(){return this.model.parse(this._data)}}],[{key:"canProbablyParse",value:function(e){return!1}}]),n}(Mc);Zu.formats=["ccp4"],Zu.extensions=[".ccp4",".map",".mrc"],Zu.binary=!0;var Qu=Zu;function Ju(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var eh=kn.Complex,th=kn.Element,nh=kn.Molecule,rh=function(e){S()(n,e);var t=Ju(n);function n(e,r){var i;return m()(this,n),(i=t.call(this,e,r))._complex=null,i._atomsInf=null,i._options.fileType="xyz",i._fileName=r.name,i}return y()(n,[{key:"_parseToAtomsInf",value:function(e){var t=e.indexOf("\n"),n=parseInt(e.substring(0,t),10),r=e.indexOf("\n",t+1),i=e.slice(t+1,r).trim();0===i.length&&(i=this._fileName);var o=r+e.substring(r).search(/\S/);this._atomsInf=e.substring(o).split(/[\s,]*\n[\s,]*/),Number.isNaN(n)||this._atomsInf.length-1===n?(this._complex.metadata.format="xyz",this._complex.name=i):this._complex.error={message:"wrong number of atoms"}}},{key:"_parseAtomsInf",value:function(){for(var e=this._complex.addChain("A").addResidue("UNK",1," "),t=0;t<this._atomsInf.length-1;t++){var n=this._atomsInf[t].split(/[\s,]+/);if(4!==n.length){this._complex.error={message:"missed parameters"};break}var r=t+1,i=n[0],o=new d.Vector3(parseFloat(n[1]),parseFloat(n[2]),parseFloat(n[3])),a=th.getByName(i);e.addAtom(i,a,o,void 0,!0,r," ",1,1,0)}var s=new nh(this._complex,this._complex.name,1);s.residues=e,this._complex._molecules[0]=s}},{key:"parseSync",value:function(){var e=this._complex=new eh;if(this._parseToAtomsInf(this._data),this._parseAtomsInf(),this._complex.finalize({needAutoBonding:!0,detectAromaticLoops:this.settings.now.aromatic,enableEditing:this.settings.now.editing,serialAtomMap:this._serialAtomMap}),this._complex=null,this._atomsInf=null,e.error)throw new Error(e.error.message);return e}}],[{key:"canProbablyParse",value:function(e){return h.a.isString(e)&&/^\s*\d+ *\n[^\n]*\n\s*\w{1,3}\s+-?\d/.test(e)}}]),n}(Mc);Re()(rh,"formats",["xyz"]),Re()(rh,"extensions",[".xyz"]);var ih=rh;function oh(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var ah=kn.Complex,sh=kn.Element,lh=function(e){S()(n,e);var t=oh(n);function n(e,r){var i;return m()(this,n),(i=t.call(this,e,r))._options.fileType="pubchem+json",i}return y()(n,[{key:"parseSync",value:function(){return this.logger.info("Parsing PubChem JSON file..."),this._toComplex(JSON.parse(this._data))}},{key:"_toComplex",value:function(e){var t=new ah,n=e.PC_Compounds&&e.PC_Compounds[0];return n&&(this._extractAtoms(t,n),t.finalize({needAutoBonding:!1,detectAromaticLoops:this.settings.now.aromatic,enableEditing:this.settings.now.editing})),t}},{key:"_extractAtoms",value:function(e,t){var n=t.atoms&&t.atoms.aid,r=n&&t.atoms.element;if(!r||n.length!==r.length)throw new Error("Unable to parse atom elements");r=h.a.fromPairs(h.a.zip(n,r));var i={},o=t.coords&&t.coords[0],a=o&&o.conformers&&o.conformers[0],s=a&&a.x,l=a&&a.y,c=a&&a.z||[];if(!(n=o&&o.aid)||!s||!l)throw new Error("Coordinates are not found in the file");for(var u=e.addChain(" ").addResidue("UNK",1," "),f=0,p=n.length;f<p;++f){var m=n[f],v=sh.ByAtomicNumber[r[m]],y=new d.Vector3(s[f],l[f],c[f]||0);i[m]=u.addAtom(v.name,v,y,void 0,!0,m," ",1,0,0)}var _=t.bonds&&t.bonds.aid1,g=t.bonds&&t.bonds.aid2,x=t.bonds&&t.bonds.order||[];if(_&&g&&_.length===g.length)for(var b=0,w=_.length;b<w;++b)e.addBond(i[_[b]],i[g[b]],x[b]||1,0,!0)}}],[{key:"canProbablyParse",value:function(e){return h.a.isString(e)&&"{"===e[0]}}]),n}(Mc);lh.formats=["pubchem","pubchem+json","pc"],lh.extensions=[".json"];var ch=lh,uh=function(){function e(t){m()(this,e),this._strings=t.split(/\r?\n|\r/),this._currentStart=0,this._currentStringIndx=0}return y()(e,[{key:"setStart",value:function(e){e>=this._strings.length?(this._currentStart=this._strings.length-1,this._currentStringIndx=this._strings.length-1):(this._currentStart=e,this._currentStringIndx=e)}},{key:"getNextString",value:function(){return this._strings[++this._currentStringIndx]}},{key:"getCurrentString",value:function(){return this._strings[this._currentStringIndx]}},{key:"getStringFromStart",value:function(e){return this._currentStringIndx=this._currentStart+e,this._strings[this._currentStart+e]}},{key:"findNextDataItem",value:function(){for(var e=this.getNextString(),t=!1;!h.a.isUndefined(e)&&"$$$$"!==e.trim();){if(e.match(/>\s+<(.*)>/)){t=!0;break}e=this.getNextString()}return t}},{key:"findNextCompoundStart",value:function(){for(var e=this.getCurrentString();!h.a.isUndefined(e)&&"$$$$"!==e.trim();)e=this.getNextString();return this.setStart(++this._currentStringIndx),this.probablyHaveDataToParse()}},{key:"probablyHaveDataToParse",value:function(){return this._currentStringIndx<this._strings.length-2}}]),e}();function hh(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var dh=kn.Complex,fh=kn.Element,ph=kn.Bond,mh=kn.Molecule,vh=[0,3,2,1,0,-1,-2,-3],yh=[0,1,2,3,1,1,1,2],_h=[ph.BondType.UNKNOWN,ph.BondType.COVALENT,ph.BondType.COVALENT,ph.BondType.COVALENT,ph.BondType.AROMATIC,ph.BondType.UNKNOWN,ph.BondType.AROMATIC,ph.BondType.AROMATIC],gh=/.*(M\s\sEND).*|.*(^$$$$).*|.*>\s+<(.+)>.*/,xh=/.*($$$$).*|.*>\s+<(.+)>.*/,bh="sdf",wh="mol",Sh=["name","id","title"],Ch={name:["PUBCHEM_IUPAC_TRADITIONAL_NAME",/PUBCHEM_(.+)_NAME/,/(.+)name/,/(.+)NAME/],id:["PUBCHEM_COMPOUND_CID","id","ID",/.*CID/,/.*ID/,/.*id/],title:["msg","MSG","message","title","description","desc"]};var Rh=function(e){S()(n,e);var t=hh(n);function n(e,r){var i;return m()(this,n),(i=t.call(this,e,r))._format="sdf",i._complex=null,i._chain=null,i._residue=null,i._molecules=null,i._metadata={},i._metadata.molecules=[],i._currentMolProps={},i._compoundIndx=-1,i._assemblies=[],i._atomsParsed=0,i._atomsIndexes=[],i}return y()(n,[{key:"canProbablyParse",value:function(e){return h.a.isString(e)&&gh.test(e)}},{key:"_parseHeader",value:function(e){var t={};t.name=e.getStringFromStart(0);var n=parseInt(e.getStringFromStart(1).substr(10,6).trim(),10);t.date=n.toString()||"",t.title=e.getStringFromStart(2),this._metadata.molecules.push(t)}},{key:"_parseAtoms",value:function(e,t){var n,r=this._atomsParsed,i=function(e){if(!e)return"A";for(var t=[];e;)t.push(65+e%26),e=Math.trunc(e/26);return t.length>1&&(t.reverse(),t[0]-=1),String.fromCharCode.apply(String,t)}(this._compoundIndx);this._chain=this._complex.getChain(i)||this._complex.addChain(i),this._residue=this._chain.addResidue("UNK",1," ");for(var o=0;o<t;o++){n=e.getNextString(),r++;var a=parseFloat(n.substr(0,10)),s=parseFloat(n.substr(10,10)),l=parseFloat(n.substr(20,10)),c=vh[parseInt(n.substr(36,3),10)],u=new d.Vector3(a,s,l),h=n.substr(31,3).trim().toUpperCase(),f=fh.getByName(h);this._atomsIndexes[h]||(this._atomsIndexes[h]=0),this._atomsIndexes[h]+=1,h+=this._atomsIndexes[h],this._residue.addAtom(h,f,u,void 0,!0,r," ",1,0,c)}}},{key:"_parseBonds",value:function(e,t){for(var n,r=0;r<t;r++){n=e.getNextString();var i=parseInt(n.substr(0,3),10)+this._atomsParsed,o=parseInt(n.substr(3,3),10)+this._atomsParsed,a=parseInt(n.substr(6,3),10);if(i>o){var s=[o,i];i=s[0],o=s[1]}this._complex.addBond(i,o,yh[a]||1,_h[a]||ph.BondType.UNKNOWN,!0)}}},{key:"_parseMOL",value:function(e){this._compoundIndx++,this._parseHeader(e);var t=e.getStringFromStart(3),n=parseInt(t.substr(0,3),10),r=parseInt(t.substr(3,3),10);this._parseAtoms(e,n),this._parseBonds(e,r),this._atomsParsed+=n,this._metadata.molecules[this._compoundIndx]._residues=[],this._metadata.molecules[this._compoundIndx]._residues.push(this._residue)}},{key:"_parseDataItem",value:function(e){for(var t=e.getCurrentString(),n=[],r=e.getNextString();""!==r.trim();)n.push(r),r=e.getNextString();if(1===n.length){var i=n;n=c()(i,1)[0]}this._currentMolProps[t.replace(/[<>]/g,"").trim()]=n}},{key:"_parseCompound",value:function(e){if(this._parseMOL(e),this._format===bh){for(this._currentMolProps={};e.findNextDataItem();)this._parseDataItem(e);if(0!==Object.keys(this._currentMolProps).length){var t=this._metadata.molecules[this._compoundIndx];t.props=this._currentMolProps,this._tryToUpdateMoleculeData(t)}}}},{key:"_fixBondsArray",value:function(){for(var e=this._serialAtomMap,t=this._complex._bonds,n=0;n<t.length;n++){var r=t[n];r._right<r._left&&console.log("_fixBondsArray: Logic error."),r._left=e[r._left]||null,r._right=e[r._right]||null}}},{key:"_buildAssemblies",value:function(){var e=this._complex._chains;if(1===e.length)return this._assemblies;for(var t=0;t<e.length;t++){var n=new Ft(this._complex),r=new d.Matrix4;n.addMatrix(r),n.addChain(e[t]._name),this._assemblies.push(n)}return this._assemblies}},{key:"_buildMolecules",value:function(){this._complex._molecules=[];for(var e=this._metadata.molecules,t=0;t<e.length;t++){var n=new mh(this._complex,e[t].name,t+1);n.residues=e[t]._residues,this._complex._molecules[t]=n}return this._complex._molecules}},{key:"_searchTag",value:function(e,t){for(var n=0;n<t.length;n++)if(e instanceof RegExp&&e.test(t[n].tag)||e===t[n].tag)return t[n].data}},{key:"_tryToFind",value:function(e,t){for(var n=0;n<e.length;n++){var r=this._searchTag(e[n],t);if(r)return r}}},{key:"_tryToUpdateMoleculeData",value:function(e){for(var t=!1,n=0;n<Sh.length;n++){var r=Ch[Sh[n]],i=this._tryToFind(r,e.props);i&&(e[Sh[n]]=i,t=!0)}return e.name=e.name||e.id,e.name.match(/^\d+$/)&&(e.name="CID: ".concat(e.name)),t}},{key:"_finalizeMetadata",value:function(){var e=this._metadata.molecules,t=this._complex.metadata,n=this._complex;if(1===e.length)n.name=e[0].name,t.title=e[0].title,t.date=e[0].date,t.properties=e[0].props;else if(e.length>1){t.molecules=[];for(var r=0;r<e.length;r++)t.molecules.push({name:e[r].name,date:e[r].date,title:e[r].title,properties:e[r].props})}}},{key:"_finalize",value:function(){for(var e=this._serialAtomMap={},t=this._complex._atoms,n=0;n<t.length;n++){var r=t[n];e[r.serial]=r}this._complex._finalizeBonds(),this._fixBondsArray(),this._finalizeMetadata(),this._buildAssemblies(),this._complex.units=this._complex.units.concat(this._assemblies),this._buildMolecules(),this._complex.finalize({needAutoBonding:!1,detectAromaticLoops:!1,enableEditing:!1,serialAtomMap:this._serialAtomMap})}},{key:"defineFormat",value:function(e){return xh.test(e)?bh:wh}},{key:"parseSync",value:function(){var e=this._complex=new dh,t=new uh(this._data);this._format=this.defineFormat(this._data),e.metadata.format=this._format;do{this._parseCompound(t)}while(t.findNextCompoundStart());return this._finalize(),e}}]),n}(Mc);function Ah(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}Rh.formats=["mol","sdf"],Rh.extensions=[".mol",".sdf"];var Eh={nstart:[Wu,"i16",0],extent:[Wu,"i16",3],grid:[Wu,"i16",6],cellDims:[Hu,"i16",9],angles:[Wu,"i16",12],div:[ju,"i16",15],adder:[ju,"i16",16],scaleFactor:[ju,"i16",17]},kh=function(e){S()(n,e);var t=Ah(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"_parseHeader",value:function(e){this._buff=e,this._typedCheck();var t={};if(t.i16=new Int16Array(this._buff),100!==t.i16[18])for(var n=0,r=t.i16.length;n<r;++n){var i=t.i16[n];t.i16[n]=(255&i)<<8|i>>8&255}if(100!==t.i16[18])throw new Error("DSN6: Incorrect format ");var o=this._header;this._fillHeader(Eh,t),o.cellDims.multiplyScalar(1/o.scaleFactor),o.angles.forEach((function(e,t,n){n[t]*=Math.PI/180/o.scaleFactor})),o.div/=100}},{key:"_setAxisIndices",value:function(){this._xyz2crs[0]=0,this._xyz2crs[1]=1,this._xyz2crs[2]=2}},{key:"_setOrigins",value:function(){var e=this._header,t=this._getAxis(),n=c()(t,3),r=n[0],i=n[1],o=n[2];this._setAxisIndices(),this._origin.addScaledVector(r,e.nstart[0]),this._origin.addScaledVector(i,e.nstart[1]),this._origin.addScaledVector(o,e.nstart[2]),r.multiplyScalar(e.extent[0]),i.multiplyScalar(e.extent[1]),o.multiplyScalar(e.extent[2]),this._setBoxParams(r,i,o)}},{key:"_pointCalculate",value:function(e,t,n,r,i,o,a){var s=this._header;return i<s.extent[0]&&r<s.extent[1]&&n<s.extent[2]?(e[i+s.extent[0]*(r+s.extent[1]*n)]=(t[o.counter]-s.adder)/s.div,++o.counter,!0):(o.counter+=8-a,!1)}},{key:"_blockCalculate",value:function(e,t,n,r,i,o){for(var a=0;a<8;++a)for(var s=8*n+a,l=0;l<8;++l)for(var c=8*r+l,u=!0,h=0;u&&h<8;){var d=8*i+h;u=this._pointCalculate(e,t,s,c,d,o,h),h++}}},{key:"_toXYZData",value:function(){for(var e=this._header,t=new Uint8Array(this._buff),n=new Float32Array(e.extent[0]*e.extent[1]*e.extent[2]),r=new d.Vector3(e.extent[0]/8,e.extent[1]/8,e.extent[2]/8),i={counter:512},o=0;o<r.z;++o)for(var a=0;a<r.y;++a)for(var s=0;s<r.x;++s)this._blockCalculate(n,t,o,a,s,i);return this._calculateInfoParams(n),n}},{key:"_calculateInfoParams",value:function(e){this._header.dmean/=e.length;for(var t=0,n=e[0],r=e[0],i=0;i<e.length;i++)t+=Math.pow(this._header.dmean-e[i],2),e[i]<n&&(n=e[i]),e[i]>r&&(r=e[i]);this._header.sd=Math.sqrt(t/e.length),this._header.dmax=r,this._header.dmin=n}}]),n}(qu),Th=function(e){S()(n,e);var t=Ah(n);function n(e,r){var i;return m()(this,n),(i=t.call(this,e,r))._options.fileType="dsn6",i.model=new kh,i}return y()(n,[{key:"parseSync",value:function(){return this.model.parse(this._data)}}],[{key:"canParse",value:function(e,t){return!!e&&(e instanceof ArrayBuffer&&Mc.checkDataTypeOptions(t,"dsn6"))}},{key:"canProbablyParse",value:function(e){return!1}}]),n}(Mc);Th.formats=["dsn6"],Th.extensions=[".dsn6",".omap"],Th.binary=!0;var Ph=Th;function Mh(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var Ih=function(e){S()(n,e);var t=Mh(n);function n(e){var r;return m()(this,n),(r=t.call(this,e))._next=-1,r.next(),r}return y()(n,[{key:"getNext",value:function(){return this._next}}]),n}(Vc);function Nh(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var Lh=kn.Complex,Dh=kn.Element,Oh=kn.Molecule,Vh=function(e){S()(n,e);var t=Nh(n);function n(e,r){var i;return m()(this,n),(i=t.call(this,e,r))._time=null,i._numAtoms=null,i._residueNumber=null,i._residueName="",i._atomName="",i._atomNumber=null,i._atomPosition=[],i._atomVelocity=[],i._complex=null,i._molecules=[],i._molecule=null,i._options.filetype="gro",i}return y()(n,[{key:"canProbablyParse",value:function(e){return h.a.isString(this._data)&&/^\s*[^\n]*\n\s*\d+ *\n\s*\d+[^\n\d]{3}\s*\w+\s*\d+\s*-?\d/.test(e)}},{key:"_parseTitle",value:function(e){var t=this._complex.metadata;t.id=e.readLine().trim(),t.name=t.id.slice(t.id.lastIndexOf("\\")+1,t.id.lastIndexOf(".")),t.format="gro"}},{key:"_parseNumberOfAtoms",value:function(e){if(this._numAtoms=e.readInt(0,e.getNext()),Number.isNaN(this._numAtoms))throw new Error("Line 2 is not representing atom number. Consider checking input file")}},{key:"_parseAtom",value:function(e){this._residueNumber=e.readInt(1,5),this._residueName=e.readString(6,10).trim(),this._atomName=e.readString(11,15).trim(),this._atomNumber=e.readInt(16,20);var t=10*e.readFloat(21,28),n=10*e.readFloat(29,36),r=10*e.readFloat(37,45);if(Number.isNaN(t)||Number.isNaN(n)||Number.isNaN(r))this._complex.error={message:'Atom position is invalid in "'.concat(e.readLine(),'"')};else{var i=Dh.getByName(this._atomName[0]);if("Unknown"!==i.fullName){var o=Dh.Role[this._atomName],a=this._chain;a||(this._chain=a=this._complex.addChain("A"));var s=this._residue;s&&s.getSequence()===this._residueNumber||(this._residue=s=a.addResidue(this._residueName,this._residueNumber," ")),this._atomPosition=new d.Vector3(t,n,r);s.addAtom(this._atomName,i,this._atomPosition,o,!0,this._atomNumber," ",1,1,0)}else this._complex.error={message:"".concat(this._atomName[0]," hasn't been recognised as an atom name.")}}}},{key:"_finalize",value:function(){var e=new Oh(this._complex,this._complex.metadata.name,1);e.residues=this._chain._residues,e._chains=this._chain,this._complex._molecules[0]=e,this._molecules.push(e),this._complex.finalize({needAutoBonding:!0,detectAromaticLoops:this.settings.now.aromatic,enableEditing:this.settings.now.editing,serialAtomMap:this._serialAtomMap})}},{key:"parseSync",value:function(){var e=this._complex=new Lh,t=new Ih(this._data),n=0;for(this._parseTitle(t),t.next(),this._parseNumberOfAtoms(t),t.next(),n=0;n<this._numAtoms&&!t.end();++n)this._parseAtom(t),t.next();if(n<this._numAtoms&&(this._complex.error={message:"File ended unexpectedly."}),e.error)throw new Error(e.error.message);return this._finalize(),this._atomPosition=null,this._complex=null,this._molecules=null,this._molecule=null,e}}]),n}(Mc);Vh.formats=["gro"],Vh.extensions=[".gro"];var zh=Vh;function Fh(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var Bh=kn.Complex,Uh=kn.Element,Gh=kn.Bond,jh=kn.Molecule,Hh={un:0,1:1,2:2,3:3,ar:1,am:1,nc:0,du:1},Wh={un:Gh.BondType.UNKNOWN,1:Gh.BondType.COVALENT,2:Gh.BondType.COVALENT,3:Gh.BondType.COVALENT,ar:Gh.BondType.AROMATIC,am:Gh.BondType.COVALENT,nc:Gh.BondType.UNKNOWN,du:Gh.BondType.COVALENT},Yh=/\d+$/,qh=/\s+/;function Xh(e){return e.trim().split(qh)}var $h=function(e){S()(n,e);var t=Fh(n);function n(e,r){var i;return m()(this,n),(i=t.call(this,e,r))._complex=null,i._chain=null,i._residue=null,i._compoundIndx=-1,i._molecules=[],i._molecule=null,i._currPosIdx=0,i._currStartIdx=0,i._serialAtomMap={},i._options.fileType="mol2",i}return y()(n,[{key:"_parseRawStrings",value:function(e){return e.split(/\r?\n|\r/)}},{key:"_toStringFromStart",value:function(e,t){var n=this._currStartIdx+e;this._currPosIdx=n<t.length?n:this._currStartIdx}},{key:"_toHeaderString",value:function(e,t){for(this._toStringFromStart(0,t);this._currPosIdx<t.length;){if(t[this._currPosIdx].match("@<TRIPOS>".concat(e)))return;this._currPosIdx++}this._toStringFromStart(0,t)}},{key:"_toStringFromHeader",value:function(e,t,n){this._toHeaderString(e,n);var r=this._currPosIdx+t;n[this._currPosIdx].match("@<TRIPOS>".concat(e))&&r<n.length&&(this._currPosIdx=r)}},{key:"_setStart",value:function(e,t){e>=t.length?this._currStartIdx=this._currPosIdx=t.length-1:this._currStartIdx=this._currPosIdx=e}},{key:"_probablyHaveDataToParse",value:function(e){return this._currPosIdx<e.length-2}},{key:"_findNextCompoundStart",value:function(e){for(;this._currPosIdx<e.length&&"@<TRIPOS>MOLECULE>"!==e[this._currPosIdx].trim();)this._currPosIdx++;return this._setStart(++this._currPosIdx,e),this._probablyHaveDataToParse(e)}},{key:"_parseMolecule",value:function(e){this._toHeaderString("MOLECULE",e);var t=this._complex.metadata;t.name=e[++this._currPosIdx],t.format="mol2",this._molecule={_index:"",_chains:[]},this._molecule._index=this._compoundIndx+1,this._molecules.push(this._molecule)}},{key:"_parseAtoms",value:function(e,t){this._toHeaderString("ATOM",t);for(var n=0;n<e;n++){var r=Xh(t[++this._currPosIdx]);if(r.length<6)throw new Error("MOL2 parsing error: Not enough information to create atom!");var i=parseInt(r[0],10),o=r[1],a=parseFloat(r[2]),s=parseFloat(r[3]),l=parseFloat(r[4]),c=r[5].split(".")[0].toUpperCase(),u=0;r.length>=9&&(u=parseFloat(r[8])||0);var h=this._chain;if(h||(this._chain=h=this._complex.getChain("A")||this._complex.addChain("A"),this._residue=null),this._setResidue(r)){var f=Uh.getByName(c),p=Uh.Role[o],m=new d.Vector3(a,s,l);this._residue.addAtom(o,f,m,p,!1,i," ",1,0,u)}}}},{key:"_setResidue",value:function(e){var t=1,n="UNK";if(e.length>=7&&(t=parseInt(e[6],10)),e.length>=8&&"<0>"!==e[7]&&(n=e[7].replace(Yh,"")),this.settings.now.nowater&&("HOH"===n||"WAT"===n))return!1;var r=this._residue,i=this._chain;return r&&r.getSequence()===t||(this._residue=i.addResidue(n,t,"A")),!0}},{key:"_parseBonds",value:function(e,t){this._toHeaderString("BOND",t);for(var n=0;n<e;n++){var r=Xh(t[++this._currPosIdx]);if(r.length<3)throw new Error("MOL2 parsing error: Missing information about bonds!");var i=parseInt(r[1],10),o=parseInt(r[2],10),a=r[3];if(i>o){var s=[o,i];i=s[0],o=s[1]}this._complex.addBond(i,o,Hh[a]||0,Wh[a]||Gh.BondType.UNKNOWN,!0)}}},{key:"_fixSerialAtoms",value:function(){for(var e=this._complex._atoms,t=0;t<e.length;t++){var n=e[t];this._serialAtomMap[n.serial]=n}}},{key:"_fixBondsArray",value:function(){var e=this._serialAtomMap,t=this._complex;if(0===Object.keys(e).length)throw new Error("MOL2 parsing error: Missing atom information!");for(var n=t._bonds,r=0;r<n.length;r++){var i=n[r];i._left=e[i._left]||null,i._right=e[i._right]||null}}},{key:"_finalizeMolecules",value:function(){var e=this._complex._chains[0];this._complex._molecules=[];for(var t=0;t<this._molecules.length;t++){var n=this._molecules[t],r=e._residues,i=new jh(this._complex,n._name,t+1);i.residues=r,this._complex._molecules[t]=i}}},{key:"_finalize",value:function(){this._complex._finalizeBonds(),this._fixSerialAtoms(),this._fixBondsArray(),this._finalizeMolecules(),this._complex.finalize({needAutoBonding:!1,detectAromaticLoops:this.settings.now.aromatic,enableEditing:this.settings.now.editing,serialAtomMap:this._serialAtomMap})}},{key:"_parseCompound",value:function(e){this._compoundIndx++,this._parseMolecule(e),this._toStringFromHeader("MOLECULE",2,e);var t=e[this._currPosIdx].trim().split(qh),n=t[0],r=t[1];this._parseAtoms(n,e),this._parseBonds(r,e)}},{key:"parseSync",value:function(){var e=this._complex=new Bh,t=this._parseRawStrings(this._data);do{this._parseCompound(t)}while(this._findNextCompoundStart(t));return this._finalize(),e}}]),n}(Mc);$h.formats=["mol2"],$h.extensions=[".mol2",".ml2",".sy2"];var Kh=new Pc([$c,Gu,wu,ih,iu,ch,Rh,Qu,Ph,zh,$h]);function Zh(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var Qh=function(e){S()(n,e);var t=Zh(n);function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return m()(this,n),t.call(this,e,["formats"])}return y()(n,[{key:"find",value:function(e){var t=[];return e.format&&(t=this._dict.formats[e.format.toLowerCase()]||[]),Zn()(t)}}]),n}(Jn),Jh=function(){function e(t,n){m()(this,e),this._source=t,this._options=n||{},this._abort=!1}return y()(e,[{key:"exportSync",value:function(){throw new Error("Exporting to this source is not implemented")}},{key:"export",value:function(){var e=this;return new Promise((function(t,n){setTimeout((function(){try{return e._abort?n(new Error("Export aborted")):t(e.exportSync())}catch(e){return n(e)}}))}))}},{key:"abort",value:function(){this._abort=!0}}]),e}();er(Jh.prototype);var ed=function(){function e(){m()(this,e),this._resultArray=[],this._currentStr=-1,this._tag=null,this._fixedNumeration=!1,this._numeration=!1,this._tagStrNum=0}return y()(e,[{key:"getResult",value:function(){return this.writeString("\n",81,81),this._resultArray.join("")}},{key:"_currentStrLength",value:function(){var e=this._resultArray[this._currentStr];return e?e.length:0}},{key:"newTag",value:function(e,t){this._tag=e||null,h.a.isUndefined(t)?(this._numeration=!1,this._fixedNumeration=!1,this._tagStrNum=0):h.a.isNumber(t)?(this._tagStrNum=t,this._numeration=!0,this._fixedNumeration=!0):h.a.isBoolean(t)&&(this._tagStrNum=0,this._numeration=t,this._fixedNumeration=!1)}},{key:"newString",value:function(e){this.writeString("\n",81,81),this._currentStr++,this._resultArray.push(""),e?this.writeString(e,1,6):this._tag&&this.writeString(this._tag,1,6),this._numeration&&(this._fixedNumeration||this._tagStrNum++,1!==this._tagStrNum&&this.writeString(this._tagStrNum.toString(),10,8))}},{key:"writeEntireString",value:function(e,t,n){t||(t=81);for(var r=0;r<e.length;r++)this._currentStrLength()===t&&r!==e.length-1&&(this.newString(),n&&this.writeString(n.tag,n.begin,n.end)),"\n"===e[r]?this.newString():this.writeString(e[r])}},{key:"writeString",value:function(e,t,n){var r,i=this._resultArray[this._currentStr],o=i?i.length:0;if(!h.a.isUndefined(e)){h.a.isNumber(t)||(t=o+1),h.a.isNumber(n)||(n=o+e.length);var a=t<n?n:t,s=t<n?t:n;if((r=h.a.isString(e)?e:e.toString()).length>Math.abs(t-n)+1&&(r=r.substr(0,Math.abs(t-n+1))),s>o+1)this._resultArray[this._currentStr]+=" ".repeat(s-o-1);else if(s<=o){var l=this._resultArray[this._currentStr];this._resultArray[this._currentStr]=l.slice(0,s-1)}if(n<t)r=" ".repeat(t-n+1-r.length)+r;11===s&&this._numeration&&1!==this._tagStrNum&&(r=" ".concat(r)),this._resultArray[this._currentStr]+=r,a>(i=this._resultArray[this._currentStr]).length&&(this._resultArray[this._currentStr]+=" ".repeat(a-i.length))}}},{key:"writeBondsArray",value:function(e,t){for(var n=this._getSubArrays(e,4),r=0;r<n.length;r++){this.newString(),this.writeString(t.serial,11,7);for(var i=0;i<n[r].length;i++){var o=n[r][i]._left.serial===t.serial?n[r][i]._right.serial:n[r][i]._left.serial;this.writeString(o,16+5*i,12+5*i)}}}},{key:"_getSubArrays",value:function(e,t){for(var n=[],r=0;r<e.length;r+=t)n.push(e.slice(r,r+t));return n}},{key:"writeMatrix",value:function(e,t,n){for(var r=0;r<3;r++){this.newString(),this.writeString(n,14,18),this.writeString((r+1).toString(),19,19),this.writeString(t.toString(),23,20);for(var i=0;i<3;i++){var o=parseFloat(e.elements[4*r+i]).toFixed(6);this.writeString(o.toString(),33+10*i,24+10*i)}var a=parseFloat(e.elements[4*r+3]).toFixed(5);this.writeString(a.toString(),68,55)}}},{key:"writeMatrices",value:function(e,t){if(e)for(var n=new d.Matrix4,r=0;r<e.length;r++)n.copy(e[r]).transpose(),this.writeMatrix(n,r+1,t)}}]),e}();function td(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var nd=function(e){S()(n,e);var t=td(n);function n(e,r){var i;return m()(this,n),(i=t.call(this,e,r))._tags=["HEADER","TITLE","COMPND","REMARK","HELIX","SHEET","ATOM and HETATM","CONECT"],i._result=null,i._tagExtractors={HEADER:i._extractHEADER,TITLE:i._extractTITLE,"ATOM and HETATM":i._extractATOM,CONECT:i._extractCONECT,COMPND:i._extractCOMPND,REMARK:i._extractREMARK,HELIX:i._extractHELIX,SHEET:i._extractSHEET},i._stringForRemark350="COORDINATES FOR A COMPLETE MULTIMER REPRESENTING THE KNOWN\nBIOLOGICALLY SIGNIFICANT OLIGOMERIZATION STATE OF THE\nMOLECULE CAN BE GENERATED BY APPLYING BIOMT TRANSFORMATIONS\nGIVEN BELOW.  BOTH NON-CRYSTALLOGRAPHIC AND\nCRYSTALLOGRAPHIC OPERATIONS ARE GIVEN.",i._stringForRemark290="CRYSTALLOGRAPHIC SYMMETRY TRANSFORMATIONS\nTHE FOLLOWING TRANSFORMATIONS OPERATE ON THE ATOM/HETATM\nRECORDS IN THIS ENTRY TO PRODUCE CRYSTALLOGRAPHICALLY\nRELATED MOLECULES.",i}return y()(n,[{key:"exportSync",value:function(){var e=new ed;if(!this._source)return this._result;for(var t=0;t<this._tags.length;t++){var n=this._tags[t],r=this._tagExtractors[n];h.a.isFunction(r)&&r.call(this,e)}return this._result=e.getResult(),this._result}},{key:"_extractHEADER",value:function(e){if(this._source.metadata){var t=this._source.metadata;e.newTag("HEADER"),e.newString(),t.classification&&e.writeString(t.classification,11,50),t.date&&e.writeString(t.date,51,59),t.id&&e.writeString(t.id,63,66)}}},{key:"_extractTITLE",value:function(e){if(this._source.metadata){var t=this._source.metadata;if(t.title){e.newTag("TITLE",!0);for(var n=0;n<t.title.length;n++)e.newString(),e.writeString(t.title[n],11,80)}}}},{key:"_extractCONECT",value:function(e){if(this._source._atoms){var t=this._source._atoms;e.newTag("CONECT");for(var n=0;n<t.length;n++){var r=t[n].bonds.filter((function(e){return e._fixed}));0!==r.length&&e.writeBondsArray(r.reverse(),t[n])}}}},{key:"_extractSHEET",value:function(e){if(this._source._sheets){e.newTag("SHEET");for(var t=this._source._sheets,n=0;n<t.length;n++)if(t[n]._strands)for(var r=t[n]._strands,i=0;i<r.length;i++)e.newString(),e.writeString(i+1,10,8),e.writeString(t[n]._name,14,12),e.writeString(r.length,16,15),e.writeString(r[i].init._type._name,18,20),e.writeString(r[i].init._chain._name,22,22),e.writeString(r[i].init._sequence,26,23),e.writeString(r[i].init._icode,27,27),e.writeString(r[i].term._type._name,29,31),e.writeString(r[i].init._chain._name,33,33),e.writeString(r[i].term._sequence,37,34),e.writeString(r[i].term._icode,38,38),e.writeString(r[i].sense,40,39)}}},{key:"_extractHELIX",value:function(e){if(this._source._helices){e.newTag("HELIX");for(var t=this._source._helices,n=0;n<t.length;n++){var r=t[n],i=h.a.invert(tt);e.newString(),e.writeString(r.serial,10,8),e.writeString(r.name,14,12),e.writeString(r.init._type._name,16,18),e.writeString(r.init._chain._name,20,20),e.writeString(r.init._sequence,25,22),e.writeString(r.init._icode,26,26),e.writeString(r.term._type._name,28,30),e.writeString(r.term._chain._name,32,32),e.writeString(r.term._sequence,37,34),e.writeString(r.term._icode,38,38),e.writeString(i[r.type],40,39),e.writeString(r.comment,41,70),e.writeString(r.length,76,72)}}}},{key:"_extractATOM",value:function(e){if(this._source._atoms)for(var t=this._source._atoms,n=0;n<t.length;n++){var r=t[n].het?"HETATM":"ATOM";e.newString(r);var i=t[n].element.name.length>1||t[n].name.length>3?13:14;e.writeString(t[n].serial,11,7),e.writeString(t[n].name,i,16),e.writeString(String.fromCharCode(t[n].location),17,17),e.writeString(t[n].residue._type._name,20,18),e.writeString(t[n].residue._chain._name,22,22),e.writeString(t[n].residue._sequence,26,23),e.writeString(t[n].residue._icode,27,27),e.writeString(t[n].position.x.toFixed(3),38,31),e.writeString(t[n].position.y.toFixed(3),46,39),e.writeString(t[n].position.z.toFixed(3),54,47),e.writeString(t[n].occupancy.toFixed(2),60,55),e.writeString(t[n].temperature.toFixed(2),66,61),e.writeString(t[n].element.name,78,77),t[n].charge&&e.writeString(t[n].charge,79,80)}}},{key:"_extractCOMPND",value:function(e){if(this._source._molecules){var t=this._source._molecules;e.newTag("COMPND",!0);for(var n=0;n<t.length;n++){var r=this._getMoleculeChains(t[n]);e.newString(),e.writeString("MOL_ID: ".concat(t[n].index,";"),11,80),e.newString(),e.writeString("MOLECULE: ".concat(t[n].name,";"),11,80),e.newString(),e.writeString("CHAIN: ",11,18);var i="".concat(r.join(", "),";");e.writeEntireString(i,81)}}}},{key:"_extractREMARK",value:function(e){this._Remark290(e),this._Remark350(e)}},{key:"_Remark290",value:function(e){if(this._source.symmetry&&0!==this._source.symmetry.length){var t=this._source.symmetry;e.newTag("REMARK",290),e.newString(),e.newString(),e.writeEntireString(this._stringForRemark290),e.writeMatrices(t,"SMTRY"),e.newString(),e.newString(),e.writeString("REMARK: NULL",11,80)}}},{key:"_Remark350",value:function(e){if(this._source.units){var t=this._source.units,n=0;e.newTag("REMARK",350),e.newString(),e.newString(),e.writeEntireString(this._stringForRemark350);for(var r=t.filter((function(e){return e instanceof Ft})),i=0;i<r.length;i++){e.newString(),e.newString(),n++,e.writeString("BIOMOLECULE: ".concat(n),11,80);var o=r[i].chains.join(", ");e.newString(),e.writeString("APPLY THE FOLLOWING TO CHAINS: "),e.writeEntireString(o,69,{tag:"AND CHAINS: ",begin:31,end:42});var a=r[i].matrices;e.writeMatrices(a,"BIOMT")}}}},{key:"_getMoleculeChains",value:function(e){var t=e.residues.map((function(e){return e._chain._name}));return t.filter((function(e,n){return t.indexOf(e)===n}))}}]),n}(Jh);nd.formats=["pdb"],nd.SourceClass=Cn;function rd(e,t,n,r){n[r]=e[t],n[r+1]=e[t+1],n[r+2]=e[t+2]}function id(e,t,n,r,i){n[r]=e[t],n[r+1]=e[t+1],n[r+2]=e[t+2],n[r+3]=i}var od=new d.Vector4;function ad(e,t,n,r,i){od.set(e[t],e[t+1],e[t+2],i.w),od.applyMatrix4(i.matrix),n[r]=od.x,n[r+1]=od.y,n[r+2]=od.z}function sd(e,t,n,r,i){if(!((t.array.length-t.start)/t.stride<n||(e.array.length-e.start)/e.stride<n))if(e.stride===t.stride)t.array.set(e.array,t.start);else for(var o=t.start,a=e.start,s=0;s<n;++s,o+=t.stride,a+=e.stride)r(e.array,a,t.array,o,i)}var ld=function(){function e(){m()(this,e),this.positions=null,this.normals=null,this.colors=null,this.indices=null,this.lastPos=0,this.lastNorm=0,this.lastCol=0,this.lastIdx=0}return y()(e,[{key:"init",value:function(e,t){this.positions=new Float32Array(3*e),this.normals=new Float32Array(3*e),this.colors=new Float32Array(4*e),this.indices=new Int32Array(t)}},{key:"setPositions",value:function(e,t,n,r){sd({array:e,start:t,stride:r},{array:this.positions,start:this.lastPos,stride:3},n,rd),this.lastPos+=3*n}},{key:"setTransformedPositions",value:function(e,t,n,r,i){for(var o=this.lastPos,a=t,s={matrix:i,w:1},l=0;l<n;++l,a+=r,o+=3)ad(e,a,this.positions,o,s);this.lastPos+=3*n}},{key:"setNormals",value:function(e,t,n,r){sd({array:e,start:t,stride:r},{array:this.normals,start:this.lastNorm,stride:3},n,rd),this.lastNorm+=3*n}},{key:"setTransformedNormals",value:function(e,t,n,r,i){for(var o=this.lastNorm,a=t,s={matrix:i,w:0},l=0;l<n;++l,a+=r,o+=3)ad(e,a,this.normals,o,s);this.lastNorm+=3*n}},{key:"setColors",value:function(e,t,n,r){sd({array:e,start:t,stride:r},{array:this.colors,start:this.lastCol,stride:4},n,id,1),this.lastCol+=4*n}},{key:"setIndices",value:function(e,t,n){this.indices.set(e,this.lastIdx),this.lastIdx+=n}},{key:"setShiftedIndices",value:function(e,t,n){var r=e.map((function(e){return e+n}));this.setIndices(r,0,t)}},{key:"getVerticesNumber",value:function(){return this.lastPos/3}},{key:"addInstance",value:function(e,t){var n=this.getVerticesNumber();this.setShiftedIndices(t.indices,t.indices.length,n);var r=t.itemSize;this.setTransformedPositions(t.positions,0,t.vertsCount,r.position,e),this.setTransformedNormals(t.normals,0,t.vertsCount,r.normal,e),this.setColors(t.colors,0,t.vertsCount,r.color)}}]),e}(),cd=function(){function e(){m()(this,e),this.positions=null,this.normals=null,this.colors=null,this.indices=null,this.vertsCount=0,this.itemSize=null}return y()(e,[{key:"init",value:function(e,t){var n=e.attributes;this.itemSize={position:n.position.itemSize,normal:n.normal.itemSize,color:n.color.itemSize}}}]),e}();function ud(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var hd=function(e){S()(n,e);var t=ud(n);function n(){return m()(this,n),t.apply(this,arguments)}return y()(n,[{key:"init",value:function(e,t){it()(E()(n.prototype),"init",this).call(this,e,t);var r=e.attributes,i=r.position,o=r.normal,a=e.index;this.vertsCount=i.count,this.positions=i.array,this.normals=o.array,this.colors=new Float32Array(this.vertsCount*this.itemSize.color),this.indices=a.array}},{key:"setColors",value:function(e){for(var t=0,n=0,r=this.colors.length,i=this.itemSize.color;n<r;n+=i)this.colors[t++]=e.r,this.colors[t++]=e.g,this.colors[t++]=e.b}}]),n}(cd);function dd(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var fd=function(e){S()(n,e);var t=dd(n);function n(){var e;return m()(this,n),(e=t.call(this))._cutRawStart=0,e._cutRawEnd=0,e._facesPerSlice=0,e}return y()(n,[{key:"init",value:function(e,t){it()(E()(n.prototype),"init",this).call(this,e,t);var r=e.attributes.position,i=e.index;this.vertsCount=r.count+t.addPerCylinder,this._facesPerSlice=t.addPerCylinder,this.positions=new Float32Array(this.vertsCount*r.itemSize),this.normals=new Float32Array(this.vertsCount*this.itemSize.normal),this.colors=new Float32Array(this.vertsCount*this.itemSize.color),this._extendVertices(e,t),this.indices=new Uint32Array(i.count),this._extendIndices(e,t)}},{key:"_extendVertices",value:function(e,t){var n=e.attributes.position,r=e.attributes.normal,i=e.getGeoParams();this._cutRawStart=1*i.radialSegments,this._cutRawEnd=this._cutRawStart+t.addPerCylinder;var o=n.array.slice(0,this._cutRawEnd*n.itemSize);this.positions.set(o,0),o=r.array.slice(0,this._cutRawEnd*r.itemSize),this.normals.set(o,0);var a=n.array.slice(this._cutRawStart*n.itemSize,n.array.length);this.positions.set(a,this._cutRawEnd*n.itemSize),a=r.array.slice(this._cutRawStart*r.itemSize,r.array.length),this.normals.set(a,this._cutRawEnd*r.itemSize)}},{key:"_extendIndices",value:function(e,t){var n=e.index,r=6*t.addPerCylinder,i=t.addPerCylinder,o=n.array.slice(r,n.count);o=o.map((function(e){return e+i})),this.indices.set(n.array,0),this.indices.set(o,r)}},{key:"_setColorRange",value:function(e,t,n,r){for(var i=r.length,o=e;o<t;o+=i)n.set(r,o)}},{key:"setColors",value:function(e,t){var n=this.itemSize.color,r=this._cutRawEnd*n,i=2*r;if(this._setColorRange(0,r,this.colors,e.toArray()),this._setColorRange(r,i,this.colors,t.toArray()),i<this.colors.length){var o=(this._facesPerSlice+1)*n,a=i+o;this._setColorRange(i,a,this.colors,t.toArray());var s=a+o;this._setColorRange(a,s,this.colors,e.toArray())}}}]),n}(cd),pd=function(){function e(){m()(this,e),this._materials=[],this._models=[]}return y()(e,[{key:"process",value:function(e){this._extractModelsAndMaterials(e);var t=this._flattenModels();return{name:e.name,models:t,materials:this._materials}}},{key:"_extractModelsAndMaterials",value:function(e){var t=this,n=new d.Layers;n.set(Yn.LAYERS.DEFAULT),n.enable(Yn.LAYERS.TRANSPARENT),e.traverse((function(e){e instanceof d.Mesh&&e.layers.test(n)&&t.checkExportAbility(e)&&("InstancedBufferGeometry"===e.geometry.type?t._collectInstancedGeoInfo(e):t._collectGeoInfo(e))}))}},{key:"_reworkIndices",value:function(e){for(var t=2;t<e.length;t+=3)e[t]*=-1,e[t]--}},{key:"_flattenModels",value:function(){var e=0;function t(t){return t+e}for(var n=[],r=0,i=this._models.length;r<i;r++){var o=this._models[r],a=[],s=[],l=[],c=[];e=0;for(var u=0;u<o.length;u++){var h=o[u];a.push(h.indices.map(t)),e+=h.getVerticesNumber(),s.push(h.positions),l.push(h.normals),c.push(h.colors)}a=K.mergeTypedArraysUnsafe(a),this._reworkIndices(a),s=K.mergeTypedArraysUnsafe(s),l=K.mergeTypedArraysUnsafe(l),c=K.mergeTypedArraysUnsafe(c),n.push({indices:a,positions:s,normals:l,colors:c,verticesCount:e})}return n}},{key:"checkExportAbility",value:function(e){return 0!==e.geometry.attributes.position.count&&(e instanceof no?(O.warn("Currently we cannot export 'sprites' modes, like BS, WV, LC. Please turn of settings 'zSprites' and try again"),!1):!(e instanceof mo)||(O.warn("Currently we cannot export Lines mode"),!1))}},{key:"_collectGeoInfo",value:function(e){var t=e.geometry,n=t.attributes,r=n.position,i=n.color,o=n.normal,a=t.index,s=e.matrix,l=new ld,c=r.count;l.init(c,a.count),s.isIdentity()?(l.setPositions(r.array,0,c,r.itemSize),l.setNormals(o.array,0,c,o.itemSize)):(l.setTransformedPositions(r.array,0,c,r.itemSize,s),l.setTransformedNormals(o.array,0,c,o.itemSize,s)),l.setColors(i.array,0,c,i.itemSize),l.setIndices(a.array,0,a.count);var u=this._collectMaterialInfo(e);this._addToPool(l,u)}},{key:"_collectSpheresInfo",value:function(e){var t=e.geometry,n=t.attributes,r=n.position,i=n.color,o=t.index,a=e.matrix,s=new ld,l=e.geometry.instanceCount,c=r.count,u=o.count;s.init(l*c,l*u);var h=new hd;h.init(e.geometry);for(var f=new d.Matrix4,p=new d.Matrix4,m=new d.Color,v=0;v<l;++v){var y=v*i.itemSize;m.fromArray(i.array,y),h.setColors(m),this._getSphereInstanceMatrix(e.geometry,v,f),p.multiplyMatrices(a,f),s.addInstance(p,h)}var _=this._collectMaterialInfo(e);this._addToPool(s,_)}},{key:"_collectCylindersInfo",value:function(e){var t=e.geometry,n=t.attributes,r=n.position,i=n.color,o=n.color2,a=t.index,s=e.matrix,l=new ld,c=e.geometry.instanceCount,u=new hd;u.init(e.geometry);var h=this._gatherCylindersColoringInfo(e.geometry),f=null;h.needToSplit>0&&(f=new fd).init(e.geometry,h);var p=h.addPerCylinder*h.needToSplit,m=r.count,v=a.count;l.init(c*m+p,c*v);for(var y=new d.Matrix4,_=new d.Matrix4,g=new d.Color,x=new d.Color,b={},w=0;w<c;++w){var S=w*i.itemSize;h.is2Colored[w]?(g.fromArray(o.array,S),x.fromArray(i.array,S),f&&(f.setColors(g,x),b=f)):(g.fromArray(i.array,S),u.setColors(g),b=u),this._getCylinderInstanceMatrix(e.geometry,w,y),_.multiplyMatrices(s,y),l.addInstance(_,b)}var C=this._collectMaterialInfo(e);this._addToPool(l,C)}},{key:"_addToPool",value:function(e,t){var n=this._checkExistingMaterial(t);n<0?(this._models.push([e]),this._materials.push(t)):this._models[n].push(e)}},{key:"_checkExistingMaterial",value:function(e){return h.a.findIndex(this._materials,(function(t){return h.a.isEqual(t,e)}))}},{key:"_gatherCylindersColoringInfo",value:function(e){for(var t=e.instanceCount,n=e.attributes.color.array,r=e.attributes.color2.array,i=e.attributes.color.itemSize,o=new Array(t),a=0,s=0,l=0;l<t;l++,s+=i){var c=Math.abs(n[s]-r[s])>1e-7||Math.abs(n[s+1]-r[s+1])>1e-7||Math.abs(n[s+2]-r[s+2])>1e-7;o[l]=c,a+=c}return{is2Colored:o,needToSplit:a,addPerCylinder:e.getGeoParams().radialSegments}}},{key:"_collectInstancedGeoInfo",value:function(e){e.geometry instanceof sr?this._collectSpheresInfo(e):e.geometry instanceof Pr&&this._collectCylindersInfo(e)}},{key:"_collectMaterialInfo",value:function(e){var t=e.material.uberOptions;return{diffuse:t.diffuse.toArray(),opacity:t.opacity,shininess:t.shininess,specular:t.specular.toArray()}}},{key:"_getCylinderInstanceMatrix",value:function(e,t,n){var r=e.attributes.matVector1.array,i=e.attributes.matVector2.array,o=e.attributes.matVector3.array,a=4*t;n.set(r[a],r[a+1],r[a+2],r[a+3],i[a],i[a+1],i[a+2],i[a+3],o[a],o[a+1],o[a+2],o[a+3],0,0,0,1)}},{key:"_getSphereInstanceMatrix",value:function(e,t,n){var r=e.attributes.offset,i=t*r.itemSize,o=r.array[i],a=r.array[i+1],s=r.array[i+2],l=r.array[i+3];n.set(l,0,0,o,0,l,0,a,0,0,l,s,0,0,0,1)}}]),e}(),md=function(){function e(){m()(this,e),this._resultArray=[],this._info=null}return y()(e,[{key:"getResult",value:function(e){return this._info=e,this._resultArray.push(this._writeHeader()),this._resultArray.push(this._writeDefinitions()),this._resultArray.push(this._writeObjects(e.models,e.materials)),this._resultArray.push(this._writeRelations()),this._resultArray.push(this._writeConnections()),this._info=null,this._resultArray.join("")}},{key:"_writeHeader",value:function(){var e=new Date,t="Miew FBX Exporter v".concat(this._info.version);return"; FBX 6.1.0 project file\n; Created by ".concat(t," Copyright (c) 2015-2020 EPAM Systems, Inc.\n; For support please contact miew@epam.com\n; ----------------------------------------------------\n\nFBXHeaderExtension:  {\n  FBXHeaderVersion: ").concat(1003,"\n  FBXVersion: ").concat(6100,"\n  CreationTimeStamp:  {\n    Version: ").concat(1e3,"\n    Year: ").concat(e.getFullYear(),"\n    Month: ").concat(e.getMonth()+1," \n    Day: ").concat(e.getDate(),"\n    Hour: ").concat(e.getHours(),"\n    Minute: ").concat(e.getMinutes(),"\n    Second: ").concat(e.getSeconds(),"\n    Millisecond: ").concat(e.getMilliseconds(),'\n  }\n  Creator: "').concat(t,'"\n  OtherFlags:  {\n    FlagPLE: 0\n  }\n}\nCreationTime: "').concat(e,'"\nCreator: "').concat(t,'"  \n')}},{key:"_writeDefinitions",value:function(){return"\n; Object definitions\n;------------------------------------------------------------------\n\n".concat('\nDefinitions:  {\n  Version: 100\n  Count: 3\n  ObjectType: "Model" {\n    Count: 1\n  }\n  ObjectType: "Geometry" {\n    Count: 1\n  }\n  ObjectType: "Material" {\n    Count: 1\n  }\n  ObjectType: "Pose" {\n    Count: 1\n  }\n  ObjectType: "GlobalSettings" {\n    Count: 1\n  }\n} ',"\n")}},{key:"_models",value:function(){for(var e="",t=this._info.models,n=0;n<t.length;++n){var r=t[n],i=r.verticesCount;e+='\n  Model: "Model::'.concat(this._info.name,"_").concat(n,'", "Mesh" {\n    Version: ').concat(232," \n    ").concat('Properties60: {\n      Property: "QuaternionInterpolate", "bool", "",0\n      Property: "Visibility", "Visibility", "A",1\n      Property: "Lcl Translation", "Lcl Translation", "A",0.000000000000000,0.000000000000000,-1789.238037109375000\n      Property: "Lcl Rotation", "Lcl Rotation", "A",0.000009334667643,-0.000000000000000,0.000000000000000\n      Property: "Lcl Scaling", "Lcl Scaling", "A",1.000000000000000,1.000000000000000,1.000000000000000\n      Property: "RotationOffset", "Vector3D", "",0,0,0\n      Property: "RotationPivot", "Vector3D", "",0,0,0\n      Property: "ScalingOffset", "Vector3D", "",0,0,0\n      Property: "ScalingPivot", "Vector3D", "",0,0,0\n      Property: "TranslationActive", "bool", "",0\n      Property: "TranslationMin", "Vector3D", "",0,0,0\n      Property: "TranslationMax", "Vector3D", "",0,0,0\n      Property: "TranslationMinX", "bool", "",0\n      Property: "TranslationMinY", "bool", "",0\n      Property: "TranslationMinZ", "bool", "",0\n      Property: "TranslationMaxX", "bool", "",0\n      Property: "TranslationMaxY", "bool", "",0\n      Property: "TranslationMaxZ", "bool", "",0\n      Property: "RotationOrder", "enum", "",0\n      Property: "RotationSpaceForLimitOnly", "bool", "",0\n      Property: "AxisLen", "double", "",10\n      Property: "PreRotation", "Vector3D", "",0,0,0\n      Property: "PostRotation", "Vector3D", "",0,0,0\n      Property: "RotationActive", "bool", "",0\n      Property: "RotationMin", "Vector3D", "",0,0,0\n      Property: "RotationMax", "Vector3D", "",0,0,0\n      Property: "RotationMinX", "bool", "",0\n      Property: "RotationMinY", "bool", "",0\n      Property: "RotationMinZ", "bool", "",0\n      Property: "RotationMaxX", "bool", "",0\n      Property: "RotationMaxY", "bool", "",0\n      Property: "RotationMaxZ", "bool", "",0\n      Property: "RotationStiffnessX", "double", "",0\n      Property: "RotationStiffnessY", "double", "",0\n      Property: "RotationStiffnessZ", "double", "",0\n      Property: "MinDampRangeX", "double", "",0\n      Property: "MinDampRangeY", "double", "",0\n      Property: "MinDampRangeZ", "double", "",0\n      Property: "MaxDampRangeX", "double", "",0\n      Property: "MaxDampRangeY", "double", "",0\n      Property: "MaxDampRangeZ", "double", "",0\n      Property: "MinDampStrengthX", "double", "",0\n      Property: "MinDampStrengthY", "double", "",0\n      Property: "MinDampStrengthZ", "double", "",0\n      Property: "MaxDampStrengthX", "double", "",0\n      Property: "MaxDampStrengthY", "double", "",0\n      Property: "MaxDampStrengthZ", "double", "",0\n      Property: "PreferedAngleX", "double", "",0\n      Property: "PreferedAngleY", "double", "",0\n      Property: "PreferedAngleZ", "double", "",0\n      Property: "InheritType", "enum", "",0\n      Property: "ScalingActive", "bool", "",0\n      Property: "ScalingMin", "Vector3D", "",1,1,1\n      Property: "ScalingMax", "Vector3D", "",1,1,1\n      Property: "ScalingMinX", "bool", "",0\n      Property: "ScalingMinY", "bool", "",0\n      Property: "ScalingMinZ", "bool", "",0\n      Property: "ScalingMaxX", "bool", "",0\n      Property: "ScalingMaxY", "bool", "",0\n      Property: "ScalingMaxZ", "bool", "",0\n      Property: "GeometricTranslation", "Vector3D", "",0,0,0\n      Property: "GeometricRotation", "Vector3D", "",0,0,0\n      Property: "GeometricScaling", "Vector3D", "",1,1,1\n      Property: "LookAtProperty", "object", ""\n      Property: "UpVectorProperty", "object", ""\n      Property: "Show", "bool", "",1\n      Property: "NegativePercentShapeSupport", "bool", "",1\n      Property: "DefaultAttributeIndex", "int", "",0\n      Property: "Color", "Color", "A+",0,0,0\n      Property: "Size", "double", "",100\n      Property: "Look", "enum", "",1\n    }',"\n    ").concat(this._verticesIndices(r.positions,r.indices),"\n    ").concat(this._normalLayer(r.normals)," \n    ").concat(this._colorLayer(r.colors,i)," \n    ").concat('\n    LayerElementMaterial: 0 {\n      Version: 101\n      Name: ""\n      MappingInformationType: "AllSame"\n      ReferenceInformationType: "Direct"\n      Materials: 0\n    }',"  \n    ").concat('\n    Layer: 0 {\n      Version: 100\n      LayerElement:  {\n        Type: "LayerElementNormal"\n        TypedIndex: 0\n      }\n      LayerElement:  {\n        Type: "LayerElementColor"\n        TypedIndex: 0\n      }\n      LayerElement:  {\n        Type: "LayerElementMaterial"\n        TypedIndex: 0\n      }\n    }',"\n  }")}return e}},{key:"_materials",value:function(){for(var e="",t=this._info.materials,n=0;n<t.length;++n){var r=t[n];e+='\n  Material: "Material::'.concat(this._info.name,"_").concat(n,'_default", "" {\n    Version: ').concat(102,'\n    ShadingModel: "lambert"\n    MultiLayer: 0\n    ').concat(this._materialProperties(r),"\n  }")}return e}},{key:"_writeObjects",value:function(){return"\n; Object properties\n;------------------------------------------------------------------\n\nObjects:  {\n  ".concat(this._models(),"\n  ").concat(this._materials(),"\n  ").concat('GlobalSettings: {\n    Version: 1000\n    Properties60:  {\n      Property: "UpAxis", "int", "",1\n      Property: "UpAxisSign", "int", "",1\n      Property: "FrontAxis", "int", "",2\n      Property: "FrontAxisSign", "int", "",1\n      Property: "CoordAxis", "int", "",0\n      Property: "CoordAxisSign", "int", "",1\n      Property: "UnitScaleFactor", "double", "",1\n    }\n  }',"\n}\n")}},{key:"_writeRelations",value:function(){for(var e="",t=0;t<this._info.models.length;++t)e+='\n  Model: "Model::'.concat(this._info.name,"_").concat(t,'", "Mesh" {\n  }');for(var n="",r=0;r<this._info.materials.length;++r)n+='\n  Material: "Material::'.concat(this._info.name,"_").concat(r,'_default", "" {\n  }');return"\n; Object relations\n;------------------------------------------------------------------\n\nRelations:  {\n  ".concat(e,'\n  Model: "Model::Producer Perspective", "Camera" {\n  }\n  Model: "Model::Producer Top", "Camera" {\n  }\n  Model: "Model::Producer Bottom", "Camera" {\n  }\n  Model: "Model::Producer Front", "Camera" {\n  }\n  Model: "Model::Producer Back", "Camera" {\n  }\n  Model: "Model::Producer Right", "Camera" {\n  }\n  Model: "Model::Producer Left", "Camera" {\n  }\n  Model: "Model::Camera Switcher", "CameraSwitcher" {\n  }\n  ').concat(n,"\n}")}},{key:"_writeConnections",value:function(){for(var e="",t=this._info.name,n=0;n<this._info.models.length;++n)e+='\n  Connect: "OO", "Model::'.concat(t,"_").concat(n,'", "Model::Scene"');for(var r="",i=0;i<this._info.materials.length;++i)r+='\n  Connect: "OO", "Material::'.concat(t,"_").concat(i,'_default", "Model::').concat(t,"_").concat(i,'"');return"\n; Object connections\n;------------------------------------------------------------------\n\nConnections:  {\n  ".concat(e,"\n  ").concat(r,"\n}")}},{key:"_floatArrayToString",value:function(e){for(var t=[],n=0;n<e.length;++n)t[n]=e[n].toFixed(6);return t.join(",")}},{key:"_colorLayer",value:function(e,t){var n=this._floatArrayToString(e),r=Zn()(Array(t).keys());return"\n    LayerElementColor: ".concat(0," {\n      Version: ").concat(101,'\n      Name: "').concat("",'"\n      MappingInformationType: "ByVertice"\n      ReferenceInformationType: "Direct"\n      Colors: ').concat(n,"\n      ColorIndex: ").concat(r,"\n    }")}},{key:"_normalLayer",value:function(e){var t=this._floatArrayToString(e);return"\n    LayerElementNormal: ".concat(0," {\n      Version: ").concat(101,'\n      Name: "').concat("",'"\n      MappingInformationType: "ByVertice"\n      ReferenceInformationType: "Direct" \n      Normals: ').concat(t,"\n    }")}},{key:"_verticesIndices",value:function(e,t){var n=this._floatArrayToString(e);return"MultiLayer: ".concat(0,"\n    MultiTake: ").concat(1,"\n    Shading: ").concat("Y",'\n    Culling: "').concat("CullingOff",'"\n    Vertices: ').concat(n,"\n    PolygonVertexIndex: ").concat(t,"\n    GeometryVersion: ").concat(124)}},{key:"_materialProperties",value:function(e){return'Properties60:  {\n      Property: "ShadingModel", "KString", "", "Lambert"\n      Property: "MultiLayer", "bool", "",0\n      Property: "EmissiveColor", "ColorRGB", "",0,0,0\n      Property: "EmissiveFactor", "double", "",0.0000\n      Property: "AmbientColor", "ColorRGB", "",1,1,1\n      Property: "AmbientFactor", "double", "",0.0000\n      Property: "DiffuseColor", "ColorRGB", "",'.concat(e.diffuse,'\n      Property: "DiffuseFactor", "double", "",1.0000\n      Property: "Bump", "Vector3D", "",0,0,0\n      Property: "TransparentColor", "ColorRGB", "",1,1,1\n      Property: "TransparencyFactor", "double", "",0.0000\n      Property: "SpecularColor", "ColorRGB", "",').concat(e.specular,'\n      Property: "SpecularFactor", "double", "",1.0000\n      Property: "ShininessExponent", "double", "",').concat(e.shininess,'\n      Property: "ReflectionColor", "ColorRGB", "",0,0,0\n      Property: "ReflectionFactor", "double", "",1\n      Property: "Ambient", "ColorRGB", "",1,1,1\n      Property: "Diffuse", "ColorRGB", "",').concat(e.diffuse,'\n      Property: "Specular", "ColorRGB", "",').concat(e.specular,'\n      Property: "Shininess", "double", "",').concat(e.shininess,'\n      Property: "Opacity", "double", "",').concat(e.opacity,'\n      Property: "Reflectivity", "double", "",0\n    }')}}]),e}();function vd(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var yd=function(e){S()(n,e);var t=vd(n);function n(e,r){var i;return m()(this,n),(i=t.call(this,e,r))._data=e,i._version=r.miewVersion||"0.0-UNSPECIFIED",i._extractor=new pd,i}return y()(n,[{key:"exportSync",value:function(){var e=new md;if(!this._source)return this._result;var t=this._extractor.process(this._data);return t.version=this._version,this._result=e.getResult(t),this._result}}]),n}(Jh);yd.formats=["fbx"],yd.SourceClass=tc;var _d,gd,xd,bd,wd,Sd,Cd,Rd,Ad,Ed,kd,Td,Pd,Md,Id={loaders:kc,parsers:Kh,exporters:new Qh([nd,yd])},Nd=new d.Color,Ld=function(){function e(){m()(this,e),this._width=0,this._height=0,this._widthHalf=0,this._heightHalf=0,this._vector=new d.Vector3,this._viewMatrix=new d.Matrix4,this._projectionMatrix=new d.Matrix4,this._domElement=document.createElement("div"),this._domElement.style.overflow="hidden",this._domElement.style.position="absolute",this._domElement.style.top="0",this._domElement.style.zIndex="0",this._domElement.style.pointerEvents="none"}return y()(e,[{key:"getElement",value:function(){return this._domElement}},{key:"reset",value:function(){for(var e=this.getElement();e.firstChild;)e.removeChild(e.firstChild)}},{key:"setSize",value:function(e,t){this._width=e,this._height=t,this._widthHalf=this._width/2,this._heightHalf=this._height/2,this._domElement.style.width="".concat(e,"px"),this._domElement.style.height="".concat(t,"px")}},{key:"_renderObject",value:function(e,t,n){function r(e,t,n){return Nd.setHex(e),Nd.lerp(t,n),"#".concat(Nd.getHexString())}function i(e){return Nd.setHex(e),"#".concat(Nd.getHexString())}if(e instanceof In){if(this._vector.setFromMatrixPosition(e.matrixWorld),void 0!==e.userData&&void 0!==e.userData.offset){var o=new d.Vector3(e.userData.offset.x,e.userData.offset.y,0);this._vector.add(o.multiplyScalar(e.matrixWorld.getMaxScaleOnAxis()))}this._vector.applyMatrix4(this._viewMatrix);var a=this._vector.z>-t.near?"hidden":"visible",s=1e4*(t.far- -this._vector.z)/(t.far-t.near),l=e.getElement();if(void 0===n.fog)l.style.color=i(e.userData.color),"transparent"!==e.userData.background&&(l.style.background=i(e.userData.background));else{var c=d.MathUtils.smoothstep(-this._vector.z,n.fog.near,n.fog.far);l.style.color=r(e.userData.color,n.fog.color,c),"transparent"!==e.userData.background&&(l.style.background=r(e.userData.background,n.fog.color,c))}this._vector.applyMatrix4(this._projectionMatrix);var u="".concat(e.userData!=={}?e.userData.translation:"translate(-50%, -50%) ","translate(").concat(this._vector.x*this._widthHalf+this._widthHalf,"px,").concat(-this._vector.y*this._heightHalf+this._heightHalf,"px)");l.style.visibility=a,l.style.WebkitTransform=u,l.style.MozTransform=u,l.style.oTransform=u,l.style.transform=u,l.style.zIndex=Number(s).toFixed(0),l.parentNode!==this._domElement&&this._domElement.appendChild(l)}for(var h=0,f=e.children.length;h<f;h++)this._renderObject(e.children[h],t,n)}},{key:"render",value:function(e,t){e.updateMatrixWorld(),null===t.parent&&t.updateMatrixWorld(),t.matrixWorldInverse.copy(t.matrixWorld).invert(),this._viewMatrix.copy(t.matrixWorldInverse),this._projectionMatrix.copy(t.projectionMatrix),this._renderObject(e,t,e)}}]),e}(),Dd=-1,Od=0,Vd=1,zd=2,Fd=3,Bd=new d.Quaternion,Ud=new d.Matrix4;function Gd(e,t,n,r){this.objects=e;var i=c()(e,1);this.object=i[0],this.camera=t,this.pivot=n,this.axis=new d.Vector3(0,0,1),this.options=r,this.lastRotation={axis:new d.Vector3,angle:0}}function jd(e,t,n,r,i){I.call(this);var o=this;this.object=e,this.objectPivot=t,this.camera=n,this.domElement=void 0!==r?r:document,this.getAltObj=i,this.enabled=!0,this.hotkeysEnabled=!0,this.screen={left:0,top:0,width:0,height:0},this.options={rotateFactor:Math.PI,axisRotateFactor:4*Math.PI,intertia:!0,dynamicDampingFactor:.1,intertiaThreshold:.001},this._state=Dd,this._mousePrevPos=new d.Vector2,this._mouseCurPos=new d.Vector2,this._mainObj=new Gd([this.object],this.camera,new d.Vector3(0,0,0),this.options),this._altObj=new Gd([this.object],this.camera,new d.Vector3(0,0,0),this.options),this._affectedObj=this._mainObj,this._isAltObjFreeRotationAllowed=!0,this._isTranslationAllowed=!0,this._isKeysTranslatingObj=!1,this._pressedKeys=[],this._clock=new _,this._clock.start(),this._lastUpdateTime=this._clock.getElapsedTime(),this._listeners=[{obj:o.domElement,type:"mousedown",handler:function(e){o.mousedown(e)}},{obj:o.domElement,type:"mouseup",handler:function(e){o.mouseup(e)}},{obj:o.domElement,type:"mousemove",handler:function(e){o.mousemove(e)}},{obj:o.domElement,type:"mousewheel",handler:function(e){o.mousewheel(e)}},{obj:o.domElement,type:"DOMMouseScroll",handler:function(e){o.mousewheel(e)}},{obj:o.domElement,type:"mouseout",handler:function(e){o.mouseup(e)}},{obj:o.domElement,type:"touchstart",handler:function(e){o.touchstartend(e)}},{obj:o.domElement,type:"touchend",handler:function(e){o.touchstartend(e)}},{obj:o.domElement,type:"touchmove",handler:function(e){o.touchmove(e)}},{obj:o.getKeyBindObject(),type:"keydown",handler:function(e){o.keydownup(e)}},{obj:o.getKeyBindObject(),type:"keyup",handler:function(e){o.keydownup(e)}},{obj:window,type:"resize",handler:function(){o.handleResize()}},{obj:window,type:"blur",handler:function(){o.resetKeys()}},{obj:o.domElement,type:"contextmenu",handler:function(e){o.contextmenu(e)}}];for(var a=0;a<this._listeners.length;a++){var s=this._listeners[a];s.obj.addEventListener(s.type,s.handler)}this.handleResize(),this.resetKeys(),this.update()}Gd.prototype._rotate=function(){var e=new d.Vector3,t=new d.Quaternion,n=new d.Vector3,r=new d.Matrix4;return function(i){var o=0===this.pivot.x&&0===this.pivot.y&&0===this.pivot.z;if(r.copy(this.object.matrix),o?r.multiply(Ud.makeRotationFromQuaternion(i)):(r.multiply(Ud.makeTranslation(this.pivot.x,this.pivot.y,this.pivot.z)),r.multiply(Ud.makeRotationFromQuaternion(i)),r.multiply(Ud.makeTranslation(-this.pivot.x,-this.pivot.y,-this.pivot.z))),r.decompose(e,t,n),!o)for(var a=0;a<this.objects.length;++a)this.objects[a].position.copy(e);for(var s=0;s<this.objects.length;++s)this.objects[s].quaternion.copy(t),this.objects[s].updateMatrix()}}(),Gd.prototype.setObjects=function(e){this.objects=e;var t=c()(e,1);this.object=t[0]},Gd.prototype.rotate=(_d={axis:new d.Vector3,angle:0},function(e,t,n,r){this.mouse2rotation(_d,t,n,r),e.setFromAxisAngle(_d.axis,_d.angle),_d.angle&&this._rotate(e),this.lastRotation=_d}),Gd.prototype.translate=(gd=new d.Vector3,xd=new d.Vector3,function(e){gd.set(e.x/this.camera.projectionMatrix.elements[0],e.y/this.camera.projectionMatrix.elements[5],0);var t=gd.length();gd.normalize(),gd.transformDirection(Ud.copy(this.object.matrixWorld).invert()),xd.copy(this.pivot),this.object.localToWorld(xd),t*=Math.abs(xd.z-this.camera.position.z),t/=this.object.matrixWorld.getMaxScaleOnAxis();for(var n=0;n<this.objects.length;++n)this.objects[n].translateOnAxis(gd,t)}),Gd.prototype.update=(bd=new d.Vector3,function(e,t){if(0!==re.now.autoRotation)return re.now.autoRotationAxisFixed||0===this.lastRotation.axis.length()?bd.set(0,1,0).transformDirection(Ud.copy(this.object.matrixWorld).invert()):bd.copy(this.lastRotation.axis),this._rotate(Bd.setFromAxisAngle(bd,re.now.autoRotation*e)),!0;if(this.options.intertia&&this.lastRotation.angle){var n=this.lastRotation.angle*Math.pow(1-this.options.dynamicDampingFactor,40*t);if(!(Math.abs(n)<=this.options.intertiaThreshold))return this._rotate(Bd.setFromAxisAngle(this.lastRotation.axis,n)),!0;this.lastRotation.angle=0}return!1}),Gd.prototype.stop=function(){this.lastRotation.angle=0},Gd.prototype.mouse2rotation=(wd=new d.Vector3,Sd=new d.Vector3,Cd=new d.Vector3,Rd=new d.Vector3,Ad=new d.Vector3,Ed=new d.Vector3,kd=new d.Vector2,function(e,t,n,r){if(r)e.axis.copy(this.axis),e.angle=this.options.axisRotateFactor*(n.y-t.y);else{kd.subVectors(n,t);var i=kd.length();if(0===i)return;wd.copy(this.pivot),this.object.localToWorld(wd),Sd.subVectors(this.camera.position,wd),Cd.copy(Sd).normalize(),Rd.copy(this.camera.up).normalize(),Ad.crossVectors(Rd,Cd).normalize(),Rd.setLength(kd.y),Ad.setLength(kd.x),Ed.copy(Rd.add(Ad)),e.axis.crossVectors(Ed,Sd),e.angle=-i*this.options.rotateFactor}e.axis.transformDirection(Ud.copy(this.object.matrixWorld).invert()),e.angle<0&&(e.axis.negate(),e.angle=-e.angle)}),jd.prototype=Object.create(I.prototype),jd.prototype.constructor=jd,jd.prototype.resetKeys=function(){this._pressedKeys[37]=!1,this._pressedKeys[38]=!1,this._pressedKeys[39]=!1,this._pressedKeys[40]=!1},jd.prototype.contextmenu=function(e){e.stopPropagation(),e.preventDefault()},jd.prototype.handleResize=function(){if(this.domElement===document)this.screen.left=0,this.screen.top=0,this.screen.width=window.innerWidth,this.screen.height=window.innerHeight;else{var e=this.domElement.getBoundingClientRect(),t=this.domElement.ownerDocument.documentElement;this.screen.left=e.left+window.pageXOffset-t.clientLeft,this.screen.top=e.top+window.pageYOffset-t.clientTop,this.screen.width=e.width,this.screen.height=e.height}},jd.prototype.enable=function(e){this.enabled=e},jd.prototype.enableHotkeys=function(e){this.hotkeysEnabled=e},jd.prototype.allowTranslation=function(e){this._isTranslationAllowed=e},jd.prototype.allowAltObjFreeRotation=function(e){this._isAltObjFreeRotationAllowed=e},jd.prototype.keysTranslateObj=function(e){this._isKeysTranslatingObj=e},jd.prototype.isEditingAltObj=function(){return(this._state===Od||this._state===Vd)&&this._affectedObj===this._altObj},jd.prototype.convertMouseToOnCircle=function(e,t,n){var r=Math.min(this.screen.width,this.screen.height);0!==r?e.set((t-.5*this.screen.width-this.screen.left)/r,(.5*this.screen.height+this.screen.top-n)/r):e.set(0,0)},jd.prototype.convertMouseToViewport=function(e,t,n){0!==this.screen.width&&0!==this.screen.height?e.set(2*(t-.5*this.screen.width-this.screen.left)/this.screen.width,2*(.5*this.screen.height+this.screen.top-n)/this.screen.height):e.set(0,0)},jd.prototype.stop=function(){this._mainObj.stop(),this._altObj.stop()},jd.prototype.rotateByMouse=(Td=new d.Quaternion,function(e){this._affectedObj.rotate(Td,this._mousePrevPos,this._mouseCurPos,e),this.dispatchEvent({type:"change",action:"rotate",quaternion:Td})}),jd.prototype.rotate=function(e){this.object.quaternion.multiply(e),this.dispatchEvent({type:"change",action:"rotate",quaternion:e})},jd.prototype.getOrientation=function(){return this.object.quaternion},jd.prototype.setOrientation=function(e){this.object.quaternion.copy(e)},jd.prototype.translate=(Pd=new d.Vector2,function(){Pd.subVectors(this._mouseCurPos,this._mousePrevPos),this._affectedObj.translate(Pd),this.dispatchEvent({type:"change",action:"translate"})}),jd.prototype.getScale=function(){return this.object.scale.x},jd.prototype.setScale=function(e){this.object.scale.set(e,e,e)},jd.prototype.scale=function(e){e<=0||(this.setScale(this.object.scale.x*e),this.dispatchEvent({type:"change",action:"zoom",factor:e}))},jd.prototype.update=(Md=new d.Vector2,function(){var e=this._clock.getElapsedTime(),t=e-this._lastUpdateTime;if(this._state===Dd){var n=e-this._lastMouseMoveTime;(this._mainObj.update(t,n)||this._altObj.update(t,n))&&this.dispatchEvent({type:"change",action:"auto"})}if(this._isKeysTranslatingObj){var r=Number(this._pressedKeys[39])-Number(this._pressedKeys[37]),i=Number(this._pressedKeys[38])-Number(this._pressedKeys[40]);if(0!==r||0!==i){var o=t,a=this.getAltObj();a.objects.length>0&&(this._altObj.setObjects(a.objects),this._altObj.pivot=a.pivot,"axis"in a?this._altObj.axis=a.axis.clone():this._altObj.axis.set(0,0,1),Md.set(o*r,o*i),this._altObj.translate(Md),this.dispatchEvent({type:"change",action:"translate"}))}}this._lastUpdateTime=e}),jd.prototype.reset=function(){this._state=Dd,this.object.quaternion.copy(Bd.set(0,0,0,1))},jd.prototype.mousedown=function(e){if(!1!==this.enabled&&this._state===Dd){if(e.preventDefault(),e.stopPropagation(),this._state===Dd)if(0===e.button){this._affectedObj.stop();var t=!1;if(e.altKey){var n=this.getAltObj();(t=n.objects.length>0)&&(this._altObj.setObjects(n.objects),this._altObj.pivot=n.pivot,"axis"in n?this._altObj.axis=n.axis.clone():this._altObj.axis.set(0,0,1))}this._affectedObj=t?this._altObj:this._mainObj,this._state=t&&e.ctrlKey&&this._isTranslationAllowed?Vd:Od}else 2===e.button&&(this._state=Fd);this._state===Od&&(this.convertMouseToOnCircle(this._mouseCurPos,e.pageX,e.pageY),this._mousePrevPos.copy(this._mouseCurPos)),this._state!==Vd&&this._state!==Fd||(this.convertMouseToViewport(this._mouseCurPos,e.pageX,e.pageY),this._mousePrevPos.copy(this._mouseCurPos))}},jd.prototype.mousemove=function(e){if(!1!==this.enabled&&this._state!==Dd)switch(e.preventDefault(),e.stopPropagation(),this._state){case Od:this._mousePrevPos.copy(this._mouseCurPos),this.convertMouseToOnCircle(this._mouseCurPos,e.pageX,e.pageY),this.rotateByMouse(e.altKey&&!this._isAltObjFreeRotationAllowed||e.shiftKey),this._lastMouseMoveTime=this._clock.getElapsedTime();break;case Vd:this._mousePrevPos.copy(this._mouseCurPos),this.convertMouseToViewport(this._mouseCurPos,e.pageX,e.pageY),this.translate();break;case Fd:this._mousePrevPos.copy(this._mouseCurPos),this.convertMouseToViewport(this._mouseCurPos,e.pageX,e.pageY),this.translatePivotByMouse()}},jd.prototype.mousewheel=function(e){if(!1!==this.enabled&&re.now.zooming&&this._state===Dd&&!e.shiftKey){e.preventDefault();var t=0;e.wheelDelta?t=e.wheelDelta/40:e.detail&&(t=-e.detail/3);var n=1+.05*t;n=Math.max(n,.01),this.scale(n)}},jd.prototype.mouseup=function(e){!1!==this.enabled&&this._state!==Dd&&(e.preventDefault(),e.stopPropagation(),this._state=Dd,this._clock.getElapsedTime()-this._lastMouseMoveTime>.1&&this._affectedObj.stop())},jd.prototype.touchstartend=function(e){if(!1!==this.enabled)switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:this._state=Od,this.convertMouseToOnCircle(this._mouseCurPos,e.touches[0].pageX,e.touches[0].pageY),this._mousePrevPos.copy(this._mouseCurPos);break;case 2:this._mainObj.stop(),this._altObj.stop(),this._state=zd;var t=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY;this._touchDistanceCur=this._touchDistanceStart=Math.sqrt(t*t+n*n),this._scaleStart=this.object.scale.x;break;default:this._state=Dd}},jd.prototype.touchmove=function(e){if(!1!==this.enabled&&this._state!==Dd)switch(e.preventDefault(),e.stopPropagation(),this._state){case Od:this._mousePrevPos.copy(this._mouseCurPos),this.convertMouseToOnCircle(this._mouseCurPos,e.touches[0].pageX,e.touches[0].pageY),this.rotateByMouse(!1),this._lastMouseMoveTime=this._clock.getElapsedTime();break;case zd:if(re.now.zooming){var t=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY;this._touchDistanceCur=Math.sqrt(t*t+n*n);var r=this._scaleStart*this._touchDistanceCur/this._touchDistanceStart/this.object.scale.x;this.scale(r)}}},jd.prototype.keydownup=function(e){if(!1!==this.enabled&&!1!==this.hotkeysEnabled)switch(e.keyCode){case 37:case 38:case 39:case 40:this._pressedKeys[e.keyCode]="keydown"===e.type,e.preventDefault(),e.stopPropagation()}},jd.prototype.getKeyBindObject=function(){return window.top},jd.prototype.dispose=function(){for(var e=0;e<this._listeners.length;e++){var t=this._listeners[e];t.obj.removeEventListener(t.type,t.handler)}},jd.prototype.translatePivotByMouse=function(){var e=new d.Vector2;return function(){e.subVectors(this._mouseCurPos,this._mousePrevPos),this.translatePivotInWorld(re.now.translationSpeed*e.x,re.now.translationSpeed*e.y,0)}}(),jd.prototype.translatePivotInWorld=function(e,t,n){var r=this.objectPivot.position;r.applyMatrix4(this.object.matrixWorld),r.setX(r.x+e),r.setY(r.y+t),r.setZ(r.z+n),r.applyMatrix4(Ud.copy(this.object.matrixWorld).invert()),this.dispatchEvent({type:"change",action:"translatePivot"})},jd.prototype.translatePivot=function(e,t,n){var r=this.objectPivot.position;r.setX(r.x+e),r.setY(r.y+t),r.setZ(r.z+n),this.dispatchEvent({type:"change",action:"translatePivot"})},jd.prototype.setPivot=function(e){this.objectPivot.position.copy(e),this.dispatchEvent({type:"change",action:"translatePivot"})};var Hd=jd;function Wd(e,t,n){I.call(this);var r=this;this.gfxObj=e,this.camera=t,this.domElement=void 0!==n?n:document,this.screen={left:0,top:0,width:0,height:0},this._lastMousePos=new d.Vector2(0,0),this._mouseTotalDist=0,this._lastClickBeginTime=-1e3,this._lastClickPos=new d.Vector2(0,0),this._clickBeginTime=0,this._clock=new _,this._clock.start(),this._listeners=[{obj:r.domElement,type:"mousedown",handler:function(e){r.mousedown(e)}},{obj:r.domElement,type:"mouseup",handler:function(e){r.mouseup(e)}},{obj:r.domElement,type:"mousemove",handler:function(e){r.mousemove(e)}},{obj:r.domElement,type:"touchstart",handler:function(e){r.touchstart(e)}},{obj:r.domElement,type:"touchend",handler:function(e){r.touchend(e)}},{obj:window,type:"resize",handler:function(){r.handleResize()}}];for(var i=0;i<this._listeners.length;i++){var o=this._listeners[i];o.obj.addEventListener(o.type,o.handler)}this.handleResize()}Wd.prototype=Object.create(I.prototype),Wd.prototype.constructor=Wd,Wd.prototype.reset=function(){this.picked={},this.dispatchEvent({type:"newpick",obj:{}})},Wd.prototype.handleResize=function(){if(this.domElement===document)this.screen.left=0,this.screen.top=0,this.screen.width=window.innerWidth,this.screen.height=window.innerHeight;else{var e=this.domElement.getBoundingClientRect(),t=this.domElement.ownerDocument.documentElement;this.screen.left=e.left+window.pageXOffset-t.clientLeft,this.screen.top=e.top+window.pageYOffset-t.clientTop,this.screen.width=e.width,this.screen.height=e.height}},Wd.prototype.pickObject=function(e){if(!this.gfxObj)return this.picked={},void this.dispatchEvent({type:"newpick",obj:{}});var t=this.gfxObj,n=new d.Raycaster;n.ray.origin.setFromMatrixPosition(this.camera.matrixWorld),n.ray.direction.set(e.x,e.y,.5).unproject(this.camera).sub(n.ray.origin).normalize();var r=re.now.draft.clipPlane&&this.clipPlaneValue?this.clipPlaneValue:1/0,i=re.now.fog&&this.fogFarValue?this.fogFarValue:1/0,o=n.intersectVisibleObject(t,this.camera,r,i);if(!o)return this.picked={},void this.dispatchEvent({type:"newpick",obj:{}});var a={};if(o.residue||o.atom){var s=o.residue||o.atom.residue;"chain"===re.now.pick?a={chain:s.getChain()}:"molecule"===re.now.pick?a={molecule:s.getMolecule()}:o.residue||"residue"===re.now.pick?a={residue:s}:o.atom&&(a={atom:o.atom})}this.picked=a,this.dispatchEvent({type:"newpick",obj:a})},Wd.prototype.getMouseInViewport=function(e,t){return new d.Vector2((e-this.screen.left)/this.screen.width*2-1,-(t-this.screen.top)/this.screen.height*2+1)},Wd.prototype.mousedown=function(e){e.preventDefault(),e.stopPropagation(),0===e.button&&(this._lastMousePos=this.getMouseInViewport(e.pageX,e.pageY),this._mouseTotalDist=0,this._clickBeginTime=this._clock.getElapsedTime())},Wd.prototype.mousemove=function(e){e.preventDefault(),e.stopPropagation();var t=this.getMouseInViewport(e.pageX,e.pageY);this._mouseTotalDist+=t.sub(this._lastMousePos).length()},Wd.prototype.mouseup=function(e){var t=this;if(e.preventDefault(),e.stopPropagation(),0===e.button&&this._mouseTotalDist<.01){var n=this._clock.getElapsedTime(),r=this.getMouseInViewport(e.pageX,e.pageY);if(n-this._lastClickBeginTime<.7)if((new d.Vector2).subVectors(r,this._lastClickPos).length()<.01)return this.dispatchEvent({type:"dblclick",obj:this.picked}),this._lastClickPos=r,void(this._lastClickBeginTime=-1e3);setTimeout((function(){t.pickObject(r)}),0),this._lastClickPos=r,this._lastClickBeginTime=this._clickBeginTime}},Wd.prototype.touchstart=function(e){e.preventDefault(),e.stopPropagation(),1===e.touches.length&&(this._lastTouchdownPos=this.getMouseInViewport(e.touches[0].pageX,e.touches[0].pageY))},Wd.prototype.touchend=function(e){var t=this;(e.preventDefault(),e.stopPropagation(),0===e.touches.length&&1===e.changedTouches.length)&&(this.getMouseInViewport(e.changedTouches[0].pageX,e.changedTouches[0].pageY).sub(this._lastTouchdownPos).length()<.01&&setTimeout((function(){t.pickObject(t._lastTouchdownPos)}),0))},Wd.prototype.dispose=function(){for(var e=0;e<this._listeners.length;e++){var t=this._listeners[e];t.obj.removeEventListener(t.type,t.handler)}};var Yd=Wd,qd=function(){function e(t,n){m()(this,e),this._target=t,this._targetCamera=n,this._camera=new d.PerspectiveCamera(n.fov,n.aspect,1,100),this._object=new d.AxesHelper(1),this._scene=new d.Scene,this._scene.add(this._object),this._full=new d.Vector2,this._update()}return y()(e,[{key:"_update",value:function(){var e=this._targetCamera.fov,t=this._camera;t.aspect=this._targetCamera.aspect,t.setMinimalFov(e),t.setDistanceToFit(1,e),t.updateProjectionMatrix(),this._object.quaternion.copy(this._target.quaternion)}},{key:"render",value:function(e){this._update(),e.getSize(this._full);var t=.25*this._full.width,n=.25*this._full.height,r=e.autoClear;e.autoClear=!1,e.setViewport(0,0,t,n),e.clear(!1,!0,!1),e.render(this._scene,this._camera),e.setViewport(0,0,this._full.width,this._full.height),e.autoClear=r}}]),e}(),Xd=["helix","strand"],$d=["fs","ps","ns","us"];function Kd(e,t){for(var n=t._residues,r=n.length,i=new Uint8Array(r),o=t._atoms,a=0,s=e.length;a<s;++a){i[o[a].residue._index]=e[a]}for(var l=[],c=0;c<r;){if(0!==i[c]){for(var u=c,h=i[c];c<r-1&&i[c+1]===h&&n[c].isConnected(n[c+1]);)++c;l.push({start:u,end:c,type:Xd[h-1]})}++c}return l}function Zd(e){return e>=1<<19?e-(1<<20):e}var Qd=function(){function e(t,n,r){m()(this,e),this._complex=t,this._secondary=null,this.isLoading=!1,this._framesRange={start:0,end:-1},this.frameIsReady=!1,this._buffer=null,this._frameRequest=null,this._callbacks=r,"function"==typeof n?(this._framesRequestLength=1,this._downloadDataFn=n):this.parseBinaryData(n,!0),this.reset(),this.setFrame(0)}return y()(e,[{key:"_prepareBuffer",value:function(e,t){if(null==e&&(e=0),null==t&&(t=e+this._framesRequestLength),void 0!==this._framesCount&&(t=Math.min(this._framesCount-1,t)),this._downloadDataFn){var n=this;this._buffer||(this._buffer={}),this._buffer.state="downloading",this.isLoading=!0,n._callbacks&&"function"==typeof n._callbacks.onLoadStatusChanged&&n._callbacks.onLoadStatusChanged(),this._downloadDataFn({start:e,end:t+1},(function(r){if(n.isLoading=!1,n._callbacks&&"function"==typeof n._callbacks.onLoadStatusChanged&&n._callbacks.onLoadStatusChanged(),n._buffer={data:r,state:"ready",start:e,end:t},null!==n._frameRequest){var i=n._frameRequest;n._frameRequest=null,n.setFrame(i)}}),(function(){n.isLoading=!1,n._callbacks&&"function"==typeof n._callbacks.onError&&n._callbacks.onError("Streaming failed")}))}}},{key:"_parseBuffer",value:function(){if(this._buffer&&"ready"===this._buffer.state){this._framesRange={start:this._buffer.start,end:this._buffer.end},this.parseBinaryData(this._buffer.data,!1);var e=(this._buffer.end+1)%this._framesCount;if(e>=this._framesCount&&(e=0),this._buffer={state:"none"},this._prepareBuffer(e,e+this._framesRequestLength),null!==this._frameRequest){var t=this._frameRequest;this._frameRequest=null,this.setFrame(t)}}}},{key:"parseBinaryData",value:function(e){var t=new DataView(e),n=0,r=t.getUint32(n,!0);n+=4;var i=t.getUint32(n,!0);this._framesCount=i,this._framesRange.end=this._framesRange.end>0?Math.min(this._framesRange.end,i-1):i-1,n+=4,this._atomsCount=r;this._framesRequestLength=Math.ceil(1048576/(8*r));var o=this._framesRange.end-this._framesRange.start+1;if(r!==this._complex._atoms.length||e.byteLength!==12+o*r*8)throw new Error;for(var a=this._complex,s=t.getUint32(n,!0),l=0;s>1e3&&l<$d.length-1;)s/=1e3,++l;this._timeStep="".concat(s.toString()," ").concat($d[l]),n+=4;for(var c=[],u=new Float32Array(o*r*3),h=0,d=new Int8Array(r),f=0;f<o;++f){for(var p=0;p<r;++p){var m=t.getUint32(n,!0);n+=4;var v=t.getUint32(n,!0);n+=4;var y=(4026531840&v)>>>28,_=Zd((268435200&v)>>>8>>0),g=Zd(((255&v)<<12|(4293918720&m)>>>20)>>0),x=Zd((1048575&m)>>0);d[p]=0,y>0&&y<4?d[p]=1:4===y&&(d[p]=2),u[h++]=_/100,u[h++]=g/100,u[h++]=x/100}c.push(Kd(d,a))}this._secondaryData=c,this._data=u}},{key:"nextFrame",value:function(){this.setFrame((this._currFrame+1)%this._framesCount)}},{key:"needsColorUpdate",value:function(e){return e instanceof pl}},{key:"getAtomColor",value:function(e,t){return e.getResidueColor(this._residues[t.residue._index],this._complex)}},{key:"getResidueColor",value:function(e,t){return e.getResidueColor(this._residues[t._index],this._complex)}},{key:"_updateSecondary",value:function(){var e,t=this._residues,n=t.length;for(e=0;e<n;++e)t[e]._secondary=null;var r=this._secondaryData[this._currFrame-this._framesRange.start];for(e=0,n=r.length;e<n;++e)for(var i=r[e],o=i.start,a=i.end,s={_start:t[o],_end:t[a],type:i.type,generic:i.generic},l=o;l<=a;++l)t[l]._secondary=s}},{key:"reset",value:function(){var e=this._complex._residues,t=e.length;this._residues=new Array(t);for(var n=this._residues,r=function(){return this._secondary},i=0;i<t;++i)n[i]={_type:e[i]._type,_isValid:e[i]._isValid,_controlPoint:null,_wingVector:null,_secondary:null,getSecondary:r}}},{key:"setFrame",value:function(e){if(this.frameIsReady=!1,e>=this._framesRange.start&&e<=this._framesRange.end)this._currFrame=e,this._cachedResidues=!1,this._updateSecondary(),this.frameIsReady=!0;else if(this._frameRequest=e,this._buffer){switch(this._buffer.state){case"none":this._prepareBuffer(e);break;case"ready":this._parseBuffer()}}else this._prepareBuffer(e)}},{key:"disableEvents",value:function(){this._callbacks=null}},{key:"getAtomPos",value:function(t){var n=e._vec,r=this._data,i=3*(this._atomsCount*(this._currFrame-this._framesRange.start)+t);return n.set(r[i],r[i+1],r[i+2]),n}},{key:"getResidues",value:function(){return this._cachedResidues||this._complex.updateToFrame(this),this._residues}}]),e}();Re()(Qd,"_vec",new d.Vector3);var Jd=Qd,ef=function(){function e(t,n){if(m()(this,e),this.constructor===e)throw new Error("Can not instantiate abstract class!");this.params=t,this.opts=h.a.merge(K.deriveDeep(re.now.objects[this.type],!0),n),this.needsRebuild=!1,this._mesh=null,this.id=null}return y()(e,[{key:"identify",value:function(){var e={type:this.type,params:this.params},t=K.objectsDiff(this.opts,re.now.modes[this.id]);return h.a.isEmpty(t)||(e.opts=t),e}},{key:"toString",value:function(){return"o=".concat(this.type,",").concat(this.params.join(","))+K.compareOptionsWithDefaults(this.opts,re.defaults.objects[this.type])}},{key:"getGeometry",value:function(){return this._mesh}},{key:"destroy",value:function(){this._mesh&&Yn.destroyObject(this._mesh)}}]),e}();function tf(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}ef.prototype.type="__";var nf=function(e){S()(n,e);var t=tf(n);function n(e,r){var i;if(m()(this,n),i=t.call(this,e,r),e.length<2)throw new Error("Wrong number of argumets on line object creation!");var o=c()(e,2);return i._id1=o[0],i._id2=o[1],i}return y()(n,[{key:"_getAtomFromName",value:function(e,t){var n=e.getAtomByFullname(t);if(!n)throw new Error(t+" - Wrong atom format it must be '#CHAIN_NAME.#RESIDUE_NUMBER.#ATOM_NAME' (e.g. 'A.38.CO1')");return n}},{key:"build",value:function(e){var t=new d.BufferGeometry;this._atom1=this._getAtomFromName(e,this._id1),this._atom2=this._getAtomFromName(e,this._id2);var n=this._atom1.position,r=this._atom2.position,i=new Float32Array([n.x,n.y,n.z,r.x,r.y,r.z]);t.setAttribute("position",new d.BufferAttribute(i,3)),t.computeBoundingBox(),this._line=new _o.Line(t,new Zi({lights:!1,overrideColor:!0,dashedLine:!0,fogTransparent:re.now.bg.transparent})),this._line.computeLineDistances(),this._line.material.setUberOptions({fixedColor:new d.Color(this.opts.color),dashedLineSize:this.opts.dashSize,dashedLinePeriod:this.opts.dashSize+this.opts.gapSize}),this._line.material.updateUniforms(),this._line.raycast=function(e,t){},this._mesh=this._line;var o=e.getTransforms();o.length>0&&(this._mesh=new d.Group,this._mesh.add(this._line),Wl.applyTransformsToMeshes(this._mesh,o))}},{key:"updateToFrame",value:function(e){if(this._atom1&&this._atom2&&this._line){var t=this._line.geometry;t.vertices[0].copy(e.getAtomPos(this._atom1.index)),t.vertices[1].copy(e.getAtomPos(this._atom2.index)),this._line.computeLineDistances(),t.computeBoundingSphere(),t.verticesNeedUpdate=!0}}}]),n}(ef);nf.prototype.constructor=nf,nf.prototype.type="line";var rf=nf;function of(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var af=function(e){S()(n,e);var t=of(n);function n(e){var r;m()(this,n),r=t.call(this,e);var i={uniforms:{srcTex:{type:"t",value:null},srcDepthTex:{type:"t",value:null},srcTexSize:{type:"v2",value:new d.Vector2(512,512)},color:{type:"v3",value:null},threshold:{type:"f",value:null},opacity:{type:"f",value:1},thickness:{type:"v2",value:new d.Vector2(1,1)}},vertexShader:Dn,fragmentShader:"precision highp float;\n\nuniform sampler2D srcTex;\nuniform vec2 srcTexSize;\nuniform vec2 thickness;\nvarying vec2 vUv;\n\n#ifdef DEPTH_OUTLINE\n  uniform sampler2D srcDepthTex; //depthTexture\n  uniform vec3 color;\n  uniform float threshold;\n#endif\n\nvoid main() {\n\n  vec2 pixelSize = thickness / srcTexSize;\n\n  #ifdef DEPTH_OUTLINE\n    float c00 = texture2D(srcDepthTex, vUv + vec2(-pixelSize.x,-pixelSize.y)).x;\n    float c01 = texture2D(srcDepthTex, vUv + vec2(0,-pixelSize.y)).x;\n    float c02 = texture2D(srcDepthTex, vUv + vec2(pixelSize.x,-pixelSize.y)).x;\n    float c10 = texture2D(srcDepthTex, vUv + vec2(-pixelSize.x,0)).x;\n    float c12 = texture2D(srcDepthTex, vUv + vec2(pixelSize.x,0)).x;\n    float c20 = texture2D(srcDepthTex, vUv + vec2(-pixelSize.x,pixelSize.y)).x;\n    float c21 = texture2D(srcDepthTex, vUv + vec2(0,pixelSize.y)).x;\n    float c22 = texture2D(srcDepthTex, vUv + vec2(pixelSize.x,pixelSize.y)).x;\n\n    float horizEdge = - c00 - 2.0 * c01 - c02 + c20 + 2.0 * c21 + c22;\n    float vertEdge  = - c00 - 2.0 * c10 - c20 + c02 + 2.0 * c12 + c22;\n\n    float grad = sqrt(horizEdge * horizEdge + vertEdge * vertEdge);\n\n    gl_FragColor = ( grad > threshold ) ? vec4(color.rgb, 1.0) : gl_FragColor = texture2D(srcTex, vUv);\n\n  #else\n    vec4 c00 = texture2D(srcTex, vUv + vec2(-pixelSize.x,-pixelSize.y));\n    vec4 c01 = texture2D(srcTex, vUv + vec2(0,-pixelSize.y));\n    vec4 c02 = texture2D(srcTex, vUv + vec2(pixelSize.x,-pixelSize.y));\n    vec4 c10 = texture2D(srcTex, vUv + vec2(-pixelSize.x,0));\n    vec4 c12 = texture2D(srcTex, vUv + vec2(pixelSize.x,0));\n    vec4 c20 = texture2D(srcTex, vUv + vec2(-pixelSize.x,pixelSize.y));\n    vec4 c21 = texture2D(srcTex, vUv + vec2(0,pixelSize.y));\n    vec4 c22 = texture2D(srcTex, vUv + vec2(pixelSize.x,pixelSize.y));\n\n    vec4 horizEdge = - c00 - 2.0 * c01 - c02 + c20 + 2.0 * c21 + c22;\n    vec4 vertEdge  = - c00 - 2.0 * c10 - c20 + c02 + 2.0 * c12 + c22;\n\n    vec4 grad = sqrt(horizEdge * horizEdge + vertEdge * vertEdge);\n    gl_FragColor = grad;\n  #endif\n}\n",transparent:!0,depthTest:!1,depthWrite:!1};return r.setValues(i),r}return y()(n,[{key:"copy",value:function(e){it()(E()(n.prototype),"copy",this).call(this,e),this.depth=e.depth}},{key:"setValues",value:function(e){if(void 0!==e){it()(E()(n.prototype),"setValues",this).call(this,e);var t={};this.depth&&(t.DEPTH_OUTLINE=1),this.defines=t}}}]),n}(d.RawShaderMaterial);af.prototype.depth=!1;var sf=af;function lf(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var cf=function(e){S()(n,e);var t=lf(n);function n(e){var r;return m()(this,n),(r=t.call(this,e)).setValues.call(Pn()(r),{uniforms:{srcTex:{type:"t",value:null},srcTexelSize:{type:"v2",value:new d.Vector2(1/512,1/512)},bgColor:{type:"c",value:new d.Color(16777215)}},vertexShader:Dn,fragmentShader:"precision highp float;\n\n// edge end finding algorithm parameters\n#define FXAA_QUALITY_PS 8\n#define FXAA_QUALITY_P0 1.0\n#define FXAA_QUALITY_P1 1.5\n#define FXAA_QUALITY_P2 2.0\n#define FXAA_QUALITY_P3 2.0\n#define FXAA_QUALITY_P4 2.0\n#define FXAA_QUALITY_P5 2.0\n#define FXAA_QUALITY_P6 4.0\n#define FXAA_QUALITY_P7 12.0\n// constants\nfloat fxaaQualityEdgeThreshold = 0.125;\nfloat fxaaQualityEdgeThresholdMin = 0.0625;\nfloat fxaaQualitySubpix = 0.7; //0.65;\n// global params\nuniform sampler2D srcTex;\nuniform vec2 srcTexelSize;\nuniform vec3 bgColor;\n// from vs\nvarying vec2 vUv;\n//=====================================================================//\n// calc luminance from rgb\n//'float FxaaLuma(vec3 rgb) {return rgb.y * (0.587/0.299) + rgb.x; } // Lotte's idea about game luminance\nfloat FxaaLuma(vec3 rgb) {return dot(rgb, vec3(0.299, 0.587, 0.114)); } // real luminance calculation\n                                                                           // for non-real scene rendering\n// texture sampling by pixel position(coords) and offset(in pixels)\n vec3 FxaaTex(sampler2D tex, vec2 pos, vec2 off,  vec2 res ) {\n  #ifdef BG_TRANSPARENT\n    vec4 color = texture2D( tex, pos + off * res );\n    return mix(color.rgb, bgColor, 1.0 - color.a);\n  #else\n    return texture2D( tex, pos + off * res ).xyz;\n  #endif\n}\nvec3 FxaaTexTop(sampler2D tex, vec2 pos) {\n  #ifdef BG_TRANSPARENT\n    vec4 color = texture2D( tex, pos );\n    return mix(color.rgb, bgColor, 1.0 - color.a);\n  #else\n    return texture2D( tex, pos).xyz;\n  #endif\n}\nvec4 FxaaTexTopAlpha(sampler2D tex, vec2 pos) {\n  return texture2D( tex, pos);\n}\n\n//=====================================================================//\nvoid main() {\n  // renaming\n  vec2 posM = vUv;\n  // get luminance for neighbours\n  float lumaS = FxaaLuma(FxaaTex(srcTex, posM, vec2( 0.0, 1.0 ), srcTexelSize));\n  float lumaE = FxaaLuma(FxaaTex(srcTex, posM, vec2( 1.0, 0.0 ), srcTexelSize));\n  float lumaN = FxaaLuma(FxaaTex(srcTex, posM, vec2( 0.0, -1.0 ), srcTexelSize));\n  float lumaW = FxaaLuma(FxaaTex(srcTex, posM, vec2( -1.0, 0.0 ), srcTexelSize));\n  float lumaM = FxaaLuma(FxaaTexTop(srcTex, posM));\n  // find max and min luminance\n  float rangeMax = max(max(lumaN, lumaW), max(lumaE, max(lumaS, lumaM)));\n  float rangeMin = min(min(lumaN, lumaW), min(lumaE, min(lumaS, lumaM)));\n  // calc maximum non-edge range\n  float rangeMaxScaled = rangeMax * fxaaQualityEdgeThreshold;\n  float range = rangeMax - rangeMin;\n  float rangeMaxClamped = max(fxaaQualityEdgeThresholdMin, rangeMaxScaled);\n  // exit when luma contrast is small (is not edge)\n  if(range < rangeMaxClamped){\n    gl_FragColor = FxaaTexTopAlpha(srcTex, posM);\n    return;\n  }\n  float subpixRcpRange = 1.0/range;\n  // note: the sampling coordinates can be calculated in vertex shader but the approach doesn't affect performance\n  // visibly, thus we decided to leave calculation here for better readability.\n  // calc other neighbours luminance\n  float lumaNE = FxaaLuma(FxaaTex(srcTex, posM, vec2(  1.0, -1.0 ), srcTexelSize));\n  float lumaSW = FxaaLuma(FxaaTex(srcTex, posM, vec2( -1.0,  1.0 ), srcTexelSize));\n  float lumaSE = FxaaLuma(FxaaTex(srcTex, posM, vec2(  1.0,  1.0 ), srcTexelSize));\n  float lumaNW = FxaaLuma(FxaaTex(srcTex, posM, vec2( -1.0, -1.0 ), srcTexelSize));\n/*--------------span calculation and subpix amount calulation-----------------*/\n  float lumaNS = lumaN + lumaS;\n  float lumaWE = lumaW + lumaE;\n  float subpixNSWE = lumaNS + lumaWE;\n  float edgeHorz1 = (-2.0 * lumaM) + lumaNS;\n  float edgeVert1 = (-2.0 * lumaM) + lumaWE;\n/*--------------------------------------------------------------------------*/\n  float lumaNESE = lumaNE + lumaSE;\n  float lumaNWNE = lumaNW + lumaNE;\n  float edgeHorz2 = (-2.0 * lumaE) + lumaNESE;\n  float edgeVert2 = (-2.0 * lumaN) + lumaNWNE;\n/*--------------------------------------------------------------------------*/\n  float lumaNWSW = lumaNW + lumaSW;\n  float lumaSWSE = lumaSW + lumaSE;\n  float edgeHorz4 = (abs(edgeHorz1) * 2.0) + abs(edgeHorz2);\n  float edgeVert4 = (abs(edgeVert1) * 2.0) + abs(edgeVert2);\n  float edgeHorz3 = (-2.0 * lumaW) + lumaNWSW;\n  float edgeVert3 = (-2.0 * lumaS) + lumaSWSE;\n  float edgeHorz = abs(edgeHorz3) + edgeHorz4;\n  float edgeVert = abs(edgeVert3) + edgeVert4;\n/*--------------------subpix amount calulation------------------------------*/\n  float subpixNWSWNESE = lumaNWSW + lumaNESE;\n  float lengthSign = srcTexelSize.x;\n  bool horzSpan = edgeHorz >= edgeVert;\n   // debug  code edge span visualization\n/*'  if (horzSpan)\n      gl_FragColor = vec4(0.0, 0.0, 1.0, 1.0);\n  else\n    gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);\n  return;*/\n  float subpixA = subpixNSWE * 2.0 + subpixNWSWNESE;\n/*--------------------------------------------------------------------------*/\n  if(!horzSpan) lumaN = lumaW;\n  if(!horzSpan) lumaS = lumaE;\n  if(horzSpan) lengthSign = srcTexelSize.y;\n  float subpixB = (subpixA * (1.0/12.0)) - lumaM;\n/*--------------------------------------------------------------------------*/\n  float gradientN = lumaN - lumaM;\n  float gradientS = lumaS - lumaM;\n  float lumaNN = lumaN + lumaM;\n  float lumaSS = lumaS + lumaM;\n  bool pairN = abs(gradientN) >= abs(gradientS);\n  float gradient = max(abs(gradientN), abs(gradientS));\n  if(pairN) lengthSign = -lengthSign;\n  float subpixC = clamp(abs(subpixB) * subpixRcpRange, 0.0, 1.0);\n/*--------------------------------------------------------------------------*/\n  vec2 posB;\n  posB = posM;\n  vec2 offNP;\n  offNP.x = (!horzSpan) ? 0.0 : srcTexelSize.x;\n  offNP.y = ( horzSpan) ? 0.0 : srcTexelSize.y;\n  if(!horzSpan) posB.x += lengthSign * 0.5;\n  if( horzSpan) posB.y += lengthSign * 0.5;\n/*--------------------------------------------------------------------------*/\n  vec2 posN;\n  posN = posB - offNP * FXAA_QUALITY_P0;\n  vec2 posP;\n  posP = posB + offNP * FXAA_QUALITY_P0;\n  float subpixD = ((-2.0)*subpixC) + 3.0;\n  float lumaEndN = FxaaLuma(FxaaTexTop(srcTex, posN));\n  float subpixE = subpixC * subpixC;\n  float lumaEndP = FxaaLuma(FxaaTexTop(srcTex, posP));\n/*--------------------------------------------------------------------------*/\n  if(!pairN) lumaNN = lumaSS;\n  float gradientScaled = gradient * 1.0/4.0;\n  float lumaMM = lumaM - lumaNN * 0.5;\n  float subpixF = subpixD * subpixE;\n  bool lumaMLTZero = lumaMM < 0.0;\n/*---------------------looped edge-end search-------------------------------*/\n  lumaEndN -= lumaNN * 0.5;\n  lumaEndP -= lumaNN * 0.5;\n  bool doneN = abs(lumaEndN) >= gradientScaled;\n  bool doneP = abs(lumaEndP) >= gradientScaled;\n  if(!doneN) posN -= offNP * FXAA_QUALITY_P1;\n  bool doneNP = (!doneN) || (!doneP);\n  if(!doneP) posP += offNP * FXAA_QUALITY_P1;\n/*--------------------------------------------------------------------------*/\n  if(doneNP) {\n    if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(srcTex, posN.xy));\n    if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(srcTex, posP.xy));\n    if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;\n    if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;\n    doneN = abs(lumaEndN) >= gradientScaled;\n    doneP = abs(lumaEndP) >= gradientScaled;\n    if(!doneN) posN -= offNP * FXAA_QUALITY_P2;\n    doneNP = (!doneN) || (!doneP);\n    if(!doneP) posP += offNP * FXAA_QUALITY_P2;\n/*--------------------------------------------------------------------------*/\n    #if (FXAA_QUALITY_PS > 3)\n      if(doneNP) {\n        if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(srcTex, posN.xy));\n        if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(srcTex, posP.xy));\n        if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;\n        if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;\n        doneN = abs(lumaEndN) >= gradientScaled;\n        doneP = abs(lumaEndP) >= gradientScaled;\n        if(!doneN) posN -= offNP * FXAA_QUALITY_P3;\n        doneNP = (!doneN) || (!doneP);\n        if(!doneP) posP += offNP * FXAA_QUALITY_P3;\n/*--------------------------------------------------------------------------*/\n        #if (FXAA_QUALITY_PS > 4)\n          if(doneNP) {\n            if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(srcTex, posN.xy));\n            if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(srcTex, posP.xy));\n            if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;\n            if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;\n            doneN = abs(lumaEndN) >= gradientScaled;\n            doneP = abs(lumaEndP) >= gradientScaled;\n            if(!doneN) posN -= offNP * FXAA_QUALITY_P4;\n            doneNP = (!doneN) || (!doneP);\n            if(!doneP) posP += offNP * FXAA_QUALITY_P4;\n/*--------------------------------------------------------------------------*/\n            #if (FXAA_QUALITY_PS > 5)\n               if(doneNP) {\n                 if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(srcTex, posN.xy));\n                 if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(srcTex, posP.xy));\n                 if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;\n                 if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;\n                 doneN = abs(lumaEndN) >= gradientScaled;\n                 doneP = abs(lumaEndP) >= gradientScaled;\n                 if(!doneN) posN -= offNP * FXAA_QUALITY_P5;\n                 doneNP = (!doneN) || (!doneP);\n                 if(!doneP) posP += offNP * FXAA_QUALITY_P5;\n/*--------------------------------------------------------------------------*/\n                 #if (FXAA_QUALITY_PS > 6)\n                   if(doneNP) {\n                     if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(srcTex, posN.xy));\n                     if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(srcTex, posP.xy));\n                     if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;\n                     if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;\n                     doneN = abs(lumaEndN) >= gradientScaled;\n                     doneP = abs(lumaEndP) >= gradientScaled;\n                     if(!doneN) posN -= offNP * FXAA_QUALITY_P6;\n                     doneNP = (!doneN) || (!doneP);\n                     if(!doneP) posP += offNP * FXAA_QUALITY_P6;\n/*--------------------------------------------------------------------------*/\n                     #if (FXAA_QUALITY_PS > 7)\n                       if(doneNP) {\n                         if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(srcTex, posN.xy));\n                         if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(srcTex, posP.xy));\n                         if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;\n                         if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;\n                         doneN = abs(lumaEndN) >= gradientScaled;\n                         doneP = abs(lumaEndP) >= gradientScaled;\n                         if(!doneN) posN -= offNP * FXAA_QUALITY_P7;\n                         doneNP = (!doneN) || (!doneP);\n                         if(!doneP) posP += offNP * FXAA_QUALITY_P7;\n/*--------------------------------------------------------------------------*/\n                       }\n                     #endif\n                   }\n                 #endif\n               }\n             #endif\n           }\n         #endif\n      }\n    #endif\n  }\n/*----------------calculate subpix offset due to edge ends-------------------*/\n  float dstN = posM.x - posN.x;\n  float dstP = posP.x - posM.x;\n  if(!horzSpan) dstN = posM.y - posN.y;\n  if(!horzSpan) dstP = posP.y - posM.y;\n/*--------------------------------------------------------------------------*/\n  bool goodSpanN = (lumaEndN < 0.0) != lumaMLTZero;\n  float spanLength = (dstP + dstN);\n  bool goodSpanP = (lumaEndP < 0.0) != lumaMLTZero;\n  float spanLengthRcp = 1.0 / spanLength;\n/*--------------------------------------------------------------------------*/\n  bool directionN = dstN < dstP;\n  float dst = min(dstN, dstP);\n  bool goodSpan = directionN ? goodSpanN : goodSpanP;\n  float subpixG = subpixF * subpixF;\n  float pixelOffset = (dst * (-spanLengthRcp)) + 0.5;\n  float subpixH = subpixG * fxaaQualitySubpix;\n/*-----------------calc texture offest using subpix-------------------------*/\n  float pixelOffsetGood = goodSpan ? pixelOffset : 0.0;\n  float pixelOffsetSubpix = max(pixelOffsetGood, subpixH);\n\n  float offset = pixelOffsetSubpix * lengthSign;\n  #ifdef BG_TRANSPARENT\n    // get original texel\n    vec4 rgbaA = FxaaTexTopAlpha(srcTex, posM);\n    // calc step to blended texel\n    vec2 step = sign((!horzSpan) ? vec2 (offset, 0.0) : vec2 (0.0, offset));\n    // get neighboring texel\n    vec4 rgbaB = FxaaTexTopAlpha(srcTex, posM + step * srcTexelSize);\n    //  calc blend factor from offset\n    float f = (!horzSpan) ? offset / srcTexelSize.x : offset / srcTexelSize.y;\n    f = abs(f);\n    // calc alpha (special formula to emulate blending with bg)\n    gl_FragColor.a = 1.0 - mix(1.0 - rgbaA.a, 1.0 - rgbaB.a, f);\n    // calc color (special formula to emulate blending with bg)\n    gl_FragColor.rgb = mix(rgbaA.rgb * rgbaA.a, rgbaB.rgb * rgbaB.a, f) / gl_FragColor.a;\n  #else\n    if(!horzSpan) {\n       posM.x += offset;\n    } else {\n       posM.y += offset;\n    }\n    gl_FragColor = FxaaTexTopAlpha(srcTex, posM);\n  #endif\n  return;\n}\n",transparent:!1,depthTest:!1,depthWrite:!1}),r.setValues(e),r}return y()(n,[{key:"copy",value:function(e){it()(E()(n.prototype),"copy",this).call(this,e),this.depth=e.depth}},{key:"setValues",value:function(e){if(void 0!==e){it()(E()(n.prototype),"setValues",this).call(this,e);var t={};this.bgTransparent&&(t.BG_TRANSPARENT=1),this.defines=t}}}]),n}(d.RawShaderMaterial);cf.prototype.bgTransparent=!1;var uf=cf;function hf(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var df=[new d.Vector3(.295184,.077723,.068429),new d.Vector3(-.271976,-.365221,.838363),new d.Vector3(.547713,.467576,.488515),new d.Vector3(.662808,-.031733,.584758),new d.Vector3(-.025717,.218955,.657094),new d.Vector3(-.310153,-.365223,.370701),new d.Vector3(-.101407,-.006313,.747665),new d.Vector3(-.769138,.360399,.086847),new d.Vector3(-.271988,-.27514,.905353),new d.Vector3(.09674,-.566901,.700151),new d.Vector3(.562872,-.735136,.094647),new d.Vector3(.379877,.359278,.190061),new d.Vector3(.519064,-.023055,.405068),new d.Vector3(-.301036,.114696,.088885),new d.Vector3(-.282922,.598305,.487214),new d.Vector3(-.181859,.25167,.679702),new d.Vector3(-.191463,-.635818,.512919),new d.Vector3(-.293655,.427423,.078921),new d.Vector3(-.267983,.680534,.13288),new d.Vector3(.139611,.319637,.477439),new d.Vector3(-.352086,.31104,.653913),new d.Vector3(.321032,.805279,.487345),new d.Vector3(.073516,.820734,.414183),new d.Vector3(-.155324,.589983,.41146),new d.Vector3(.335976,.170782,.527627),new d.Vector3(.46346,-.355658,.167689),new d.Vector3(.222654,.59655,.769406),new d.Vector3(.922138,-.04207,.147555),new d.Vector3(-.72705,-.329192,.369826),new d.Vector3(-.090731,.53382,.463767),new d.Vector3(-.323457,-.876559,.238524),new d.Vector3(-.663277,-.372384,.342856)],ff=function(e){S()(n,e);var t=hf(n);function n(){var e;return m()(this,n),(e=t.call(this)).setValues.call(Pn()(e),{uniforms:{noiseTexture:{type:"t",value:Wi.noiseTexture},noiseTexelSize:{type:"v2",value:new d.Vector2(1/Wi.noiseWidth,1/Wi.noiseHeight)},diffuseTexture:{type:"t",value:null},normalTexture:{type:"t",value:null},depthTexture:{type:"t",value:null},srcTexelSize:{type:"v2",value:new d.Vector2(1/512,1/512)},camNearFar:{type:"v2",value:new d.Vector2(1,10)},projMatrix:{type:"mat4",value:new d.Matrix4},aspectRatio:{type:"f",value:0},tanHalfFOV:{type:"f",value:0},samplesKernel:{type:"v3v",value:df},kernelRadius:{type:"f",value:1},depthThreshold:{type:"f",value:1},factor:{type:"f",value:1}},vertexShader:Dn,fragmentShader:"precision highp float;\n#define EPSILON 0.0000001\n\n#define MAX_SAMPLES_COUNT 32\nuniform vec3 samplesKernel[MAX_SAMPLES_COUNT];\nuniform sampler2D noiseTexture;\nuniform vec2      noiseTexelSize;\nuniform sampler2D diffuseTexture;\nuniform sampler2D depthTexture;\nuniform sampler2D normalTexture;\nuniform vec2      srcTexelSize;\nuniform vec2      camNearFar;\nuniform mat4      projMatrix;\n\nuniform float aspectRatio;\nuniform float tanHalfFOV;\n\nuniform float kernelRadius;\nuniform float depthThreshold;\nuniform float factor;\n\nvarying vec2 vUv;\n\nfloat CalcViewZ(vec2 screenPos)\n{\n  float depth = texture2D(depthTexture, screenPos).x;\n  // [0, 1]->[-1, 1]\n  float clipedZ = 2.0 * depth - 1.0;\n  // see THREE.js camera.makeFrustum for projection details\n  return (-projMatrix[3][2] / (clipedZ + projMatrix[2][2]));\n}\n\nvec3 ViewPosFromDepth(vec2 screenPos)\n{\n  vec3 viewPos;\n  viewPos.z = CalcViewZ(screenPos);\n  //[0, 1]->[-1, 1]\n  vec2 projPos = 2.0 * screenPos - 1.0;\n  // reconstruct viewposition in right-handed sc with z to viewer\n  viewPos.xy = vec2(\n                    projPos.x * aspectRatio * tanHalfFOV * abs(viewPos.z),\n                    projPos.y * tanHalfFOV * abs(viewPos.z)\n                   );\n  return viewPos;\n}\n\nvoid main() {\n  vec3 viewPos = ViewPosFromDepth(vUv);\n  // remap coordinates to prevent noise exture rescale\n  vec2 vUvNoise = vUv / srcTexelSize * noiseTexelSize;\n  vec4 normalData = texture2D(normalTexture, vUv);\n  // return for background fragments (their normals are zero vectors)\n  if (length(normalData.rgb) < EPSILON) {\n    // 0.0 in alpha component means that it is background fragment\n    gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);\n    return;\n  }\n  //[0, 1] -> [-1, 1]\n  vec3 normal = (normalData.rgb * 2.0 - 1.0);\n  // normalData.a store 1.0 if normal was build for frontfaced surface\n  // and 0.0 in other case\n  if (normalData.a < EPSILON) {\n    normal *= -1.0;\n  }\n  // get random vector for sampling sphere rotation\n  vec3 randN = texture2D(noiseTexture, vUvNoise).rgb * 2.0 - 1.0;\n  randN = normalize(randN);\n  // build TBN (randomly rotated around normal)\n  vec3 tangent   = normalize(randN - normal * dot(randN, normal));\n  vec3 bitangent = cross(tangent, normal);\n  mat3 TBN = mat3(tangent, bitangent, normal);\n  // calc AO value\n  float AO = 0.0;\n  for (int i = 0 ; i < MAX_SAMPLES_COUNT ; i++) {\n    // rotate sampling kernel around normal\n    vec3 reflectedSample = TBN * samplesKernel[i];\n    // get sample\n    vec3 samplePos = viewPos + reflectedSample * kernelRadius;\n\n    // project sample to screen to get sample's screen pos\n    vec4 SampleScrPos = vec4(samplePos, 1.0);\n    // eye -> clip\n    SampleScrPos = projMatrix * SampleScrPos;\n    // normalize\n    SampleScrPos.xy /= SampleScrPos.w;\n    //[-1, 1] -> [0, 1]\n    SampleScrPos.xy = (SampleScrPos.xy + vec2(1.0)) * 0.5;\n\n    // get view z for sample projected to the objct surface\n    float sampleDepth = CalcViewZ(SampleScrPos.xy);\n    // calc occlusion made by object surface at the sample\n    AO += step(samplePos.z, sampleDepth);\n  }\n  // calc result AO-map color\n  AO = 1.0 - max(0.0, AO / float(MAX_SAMPLES_COUNT) * factor);\n  // write value to AO-map\n  gl_FragColor = vec4(AO, AO, AO, 1.0);\n}\n",transparent:!1,depthTest:!1,depthWrite:!1}),e}return n}(d.RawShaderMaterial);function pf(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var mf=[-2,-1,0,1,2],vf=function(e){S()(n,e);var t=pf(n);function n(){var e;return m()(this,n),(e=t.call(this)).setValues.call(Pn()(e),{uniforms:{depthTexture:{type:"t",value:null},srcTexelSize:{type:"v2",value:new d.Vector2(1/512,1/512)},aoMap:{type:"t",value:null},samplesOffsets:{type:"fv1",value:mf}},vertexShader:Dn,fragmentShader:"precision highp float;\n#define EPSILON 0.0000001\n\n#define MAX_SAMPLES_COUNT 5\nuniform float samplesOffsets[MAX_SAMPLES_COUNT];\nuniform sampler2D aoMap;\nuniform sampler2D depthTexture;\nuniform vec2      srcTexelSize;\n\nvarying vec2 vUv;\n\nvoid main() {\n  float x = vUv.x;\n  float y = vUv.y;\n  vec4 res = vec4(0.0);\n  res.a = texture2D(aoMap, vec2(x, y )).a;\n  // return for background fragments (0.0 in alpha component means that it is background fragment)\n  if (res.a < EPSILON) {\n    gl_FragColor = res;\n    return;\n  }\n\n  float pixelDepth = texture2D(depthTexture, vec2(x, y)).x;\n  float weightSum = 0.0;\n  for (int i = 0; i < MAX_SAMPLES_COUNT; ++i) {\n    if (texture2D(aoMap, vec2(x + samplesOffsets[i] * srcTexelSize.x, y )).a < EPSILON) {\n      continue;\n    }\n    vec2 samplePos = vec2(x + samplesOffsets[i] * srcTexelSize.x, y);\n    float depth = texture2D(depthTexture, samplePos).x;\n    float weight = (1.0 / (0.0001 + abs(depth - pixelDepth)));\n    res.rgb += texture2D(aoMap, vec2(x + samplesOffsets[i] * srcTexelSize.x, y )).rgb * weight;\n    weightSum += weight;\n  }\n  res.rgb = res.rgb / weightSum;\n  gl_FragColor = res;\n}\n",transparent:!1,depthTest:!1,depthWrite:!1}),e}return n}(d.RawShaderMaterial);function yf(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var _f=[-2,-1,0,1,2],gf=function(e){S()(n,e);var t=yf(n);function n(e){var r;return m()(this,n),(r=t.call(this,e)).setValues.call(Pn()(r),{uniforms:{diffuseTexture:{type:"t",value:null},depthTexture:{type:"t",value:null},srcTexelSize:{type:"v2",value:new d.Vector2(1/512,1/512)},aoMap:{type:"t",value:null},samplesOffsets:{type:"fv1",value:_f},projMatrix:{type:"mat4",value:new d.Matrix4},aspectRatio:{type:"f",value:0},tanHalfFOV:{type:"f",value:0},fogNearFar:{type:"v2",value:new d.Vector2(100,100)},fogColor:{type:"v4",value:new d.Vector4(0,.5,0,1)}},vertexShader:Dn,fragmentShader:"precision highp float;\n#define EPSILON 0.0000001\n\n#define MAX_SAMPLES_COUNT 5\nuniform float samplesOffsets[MAX_SAMPLES_COUNT];\nuniform sampler2D diffuseTexture;\nuniform sampler2D aoMap;\nuniform sampler2D depthTexture;\nuniform vec2      srcTexelSize;\n\nuniform mat4  projMatrix;\nuniform float aspectRatio;\nuniform float tanHalfFOV;\n\n#ifdef USE_FOG\n  uniform vec2 fogNearFar;\n  uniform vec4 fogColor;\n#endif\nvarying vec2 vUv;\n\nfloat CalcViewZ(vec2 screenPos)\n{\n  float depth = texture2D(depthTexture, screenPos).x;\n  // [0, 1]->[-1, 1]\n  float clipedZ = 2.0 * depth - 1.0;\n  // see THREE.js camera.makeFrustum for projection details\n  return (-projMatrix[3][2] / (clipedZ + projMatrix[2][2]));\n}\n\nvec3 ViewPosFromDepth(vec2 screenPos)\n{\n  vec3 viewPos;\n  viewPos.z = CalcViewZ(screenPos);\n  //[0, 1]->[-1, 1]\n  vec2 projPos = 2.0 * screenPos - 1.0;\n  // reconstruct viewposition in right-handed sc with z to viewer\n  viewPos.xy = vec2(\n  projPos.x * aspectRatio * tanHalfFOV * abs(viewPos.z),\n  projPos.y * tanHalfFOV * abs(viewPos.z)\n  );\n  return viewPos;\n}\n\nvoid main() {\n  vec3 viewPos = ViewPosFromDepth(vUv);\n  float x = vUv.x;\n  float y = vUv.y;\n  vec4 color = texture2D(diffuseTexture, vec2(x, y));\n  vec4 res = vec4(0.0);\n  res.a = texture2D(aoMap, vec2(x, y )).a;\n  // return for background fragments (0.0 in alpha component means that it is background fragment)\n  if (res.a < EPSILON) {\n    gl_FragColor = color;\n    return;\n  }\n\n  float pixelDepth = texture2D(depthTexture, vec2(x, y)).x;\n  float weightSum = 0.0;\n  for (int i = 0; i < MAX_SAMPLES_COUNT; ++i) {\n    if (texture2D(aoMap, vec2(x, y + samplesOffsets[i] * srcTexelSize.y)).a < EPSILON) {\n      continue;\n    }\n    vec2 samplePos = vec2(x, y + samplesOffsets[i] * srcTexelSize.y);\n    float depth = texture2D(depthTexture, samplePos).x;\n    float weight = (1.0 / (0.0001 + abs(depth - pixelDepth)));\n    res.rgb += texture2D(aoMap, vec2(x, y + samplesOffsets[i] * srcTexelSize.y)).rgb * weight;\n    weightSum += weight;\n  }\n  res.rgb /= weightSum;\n\n  #if defined(USE_FOG) && !defined(FOG_TRANSPARENT)\n    // Add fog to the result value\n    // Proper way to get an image with fog and ao requires formula:\n    //          gl_FragColor = fragColor*AO*(1-fogFactor) + fogColor*fogFactor\n    // But we have already fogged molecule to add AO too. Let's split the straight formula into our real steps!\n    // We have:  AO, fogFactor, fogColor,\n    //          color = fragColor*(1-fogFactor) + fogColor*fogFactor (it comes from diffuseTexture,\n    //                                                                where molecule has been already drawn with fog)\n    // Transform:\n    //          fragColor*AO*(1-fogFactor) + fogColor*fogFactor =\n    //        = [fragColor*(1-fogFactor) = color - fogColor*fogFactor] =\n    //        = (color - fogColor*fogFactor)*AO + fogColor*fogFactor =\n    //        = color*AO + fogColor*fogFactor*(1 - AO)\n    // Result:  gl_FragColor = color*AO + fogColor*fogFactor*(1 - AO)\n    float fogFactor = smoothstep(fogNearFar.x, fogNearFar.y, - viewPos.z) * fogColor.a;\n    gl_FragColor.rgb = color.rgb * res.rgb + fogColor.rgb * fogFactor *(vec3(1.0, 1.0, 1.0) - res.rgb);\n  #else\n    gl_FragColor.rgb = color.rgb * res.rgb;\n  #endif\n  gl_FragColor.a = color.a;\n}\n",transparent:!1,depthTest:!1,depthWrite:!1}),r.setValues(e),r}return y()(n,[{key:"setValues",value:function(e){if(void 0!==e){it()(E()(n.prototype),"setValues",this).call(this,e);var t={};this.useFog&&(t.USE_FOG=1),this.fogTransparent&&(t.FOG_TRANSPARENT=1),this.defines=t}}}]),n}(d.RawShaderMaterial);gf.prototype.useFog=!0,gf.prototype.fogTransparent=!1;var xf=gf;function bf(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E()(e);if(t){var i=E()(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R()(this,n)}}var wf=function(e){S()(n,e);var t=bf(n);function n(){var e;m()(this,n),e=t.call(this);var r={uniforms:{srcL:{type:"t",value:null},srcR:{type:"t",value:null}},vertexShader:Dn,fragmentShader:"precision highp float;\n\nuniform sampler2D srcL;\nuniform sampler2D srcR;\nvarying vec2 vUv;\n\nvoid main() {\n  vec4 l = texture2D(srcL, vUv);\n  vec4 r = texture2D(srcR, vUv);\n  gl_FragColor = vec4(l.r, r.g, r.b, 1.0);\n}\n",transparent:!1,depthTest:!1,depthWrite:!1};return e.setValues(r),e}return n}(d.RawShaderMaterial),Sf=function(){function e(){m()(this,e),this.position=new d.Vector3(0,0,0),this.scale=1,this.orientation=new d.Quaternion(0,0,0,1)}return y()(e,[{key:"set",value:function(e,t,n){this.position=e,this.scale=t,this.orientation=n}}]),e}(),Cf=function(){function e(){m()(this,e)}return y()(e,[{key:"setup",value:function(e,t){this._startTime=void 0,this._endTime=void 0,this._isPaused=!1,this._srcView=e,this._dstView=t,this._isMoving=!1}},{key:"isMoving",value:function(){return this._isMoving}},{key:"wasStarted",value:function(){return void 0!==this._startTime&&void 0!==this._endTime}},{key:"start",value:function(){this._startTime=Date.now();var e=re.now.interpolateViews?1500:0;this._endTime=this._startTime+e,this._isMoving=!0}},{key:"getCurrentView",value:function(){if(void 0===this._srcView||void 0===this._dstView||!this._isMoving||!this.wasStarted())return{success:!1};var e=this.createView(),t=Date.now();if(t>this._endTime)return e=this._dstView,this.reset(),{success:!0,view:e};var n=(t-this._startTime)/(this._endTime-this._startTime);return e.position.copy(this._srcView.position),e.position.lerp(this._dstView.position,n),e.scale=(1-n)*this._srcView.scale+n*this._dstView.scale,e.orientation.copy(this._srcView.orientation),e.orientation.slerp(this._dstView.orientation,n),{success:!0,view:e}}},{key:"reset",value:function(){this._startTime=this._endTime=0,this._isMoving=!1}},{key:"pause",value:function(){this._isPaused||(this.setup(this.getCurrentView().view,this._dstView),this._isPaused=!0)}},{key:"resume",value:function(){this._isPaused=!1}},{key:"createView",value:function(){return new Sf}}]),e}();function Rf(e,t){this.context=e,this._opts=h.a.merge({path:"/"},t)}er(Rf.prototype),Rf.prototype.removeCookie=function(e){var t=this._toCount(e),n=this._getSimpleCookie(t);if(n){this._removeSimpleCookie(t),n=parseInt(n,10);for(var r=0;r<n;++r)this._removeSimpleCookie(e+r)}else this._removeSimpleCookie(e)},Rf.prototype.setCookie=function(e,t){this.removeCookie(e);var n=function(e,t){for(var n=e.length,r=[],i=0,o=0;o<n;i++,o+=t)r[i]=e.slice(o,o+t);return r}(t=encodeURIComponent(t),4e3-e.length-1),r=n.length;if(1!==r){var i=this._toCount(e);this._setSimpleCookie(i,r.toString());for(var o=0;o<r;++o)this._setSimpleCookie(e+o,n[o])}else this._setSimpleCookie(e,t)},Rf.prototype.getCookie=function(e){var t=this._toCount(e),n=this._getSimpleCookie(t);if(!n)return this._getSimpleCookie(e);n=parseInt(n,10);for(var r=[],i=0;i<n;++i)r[i]=this._getSimpleCookie(e+i);return r.join("")},Rf.prototype._toCount=function(e){return e+"Cnt"},Rf.prototype._removeSimpleCookie=function(e){document.cookie="".concat(e,"=; expires=Thu, 01 Jan 1970 00:00:01 GMT;")},Rf.prototype._getExpirationDate=function(){var e=new Date;return e.setFullYear(e.getFullYear()+10),e},Rf.prototype._setSimpleCookie=function(e,t){document.cookie="".concat(e,"=").concat(t,";expires=").concat(this._getExpirationDate().toUTCString(),";path=").concat(this._opts.path)},Rf.prototype._getSimpleCookie=function(e){var t=document.cookie.match(new RegExp("(?:^|; )".concat(e,"=([^;]*)")));return t?decodeURIComponent(t[1]):""},Rf.prototype._exists=function(e){return document.cookie.match(new RegExp("(?:^|; )".concat(e,"=([^;]*)")))};var Af,Ef,kf,Tf,Pf,Mf,If,Nf,Lf,Df,Of,Vf,zf,Ff,Bf,Uf,Gf,jf,Hf,Wf,Yf,qf,Xf=Rf,$f=function(e){function t(e){e.style.position="absolute",e.style.bottom="20px",e.style.padding="12px 6px",e.style.border="1px solid #fff",e.style.borderRadius="4px",e.style.background="transparent",e.style.color="#fff",e.style.font="normal 13px sans-serif",e.style.textAlign="center",e.style.opacity="0.5",e.style.outline="none",e.style.zIndex="999"}if("xr"in navigator){var n=document.createElement("button");return n.style.display="none",t(n),navigator.xr.isSessionSupported("immersive-vr").then((function(t){return t?function(t){t.style.display="",t.style.cursor="pointer",t.style.left="calc(50% - 50px)",t.style.width="100px",t.textContent="ENTER VR";var n=null;function r(){n.removeEventListener("end",r),t.textContent="ENTER VR",n=null}function i(i){i.addEventListener("end",r),e._gfx.renderer.xr.setReferenceSpaceType("local"),e._gfx.renderer.xr.setSession(i),t.textContent="EXIT VR",n=i}t.onmouseenter=function(){t.style.opacity="1.0"},t.onmouseleave=function(){t.style.opacity="0.5"},t.onclick=function(){if(null===n){navigator.xr.requestSession("immersive-vr",{optionalFeatures:["local-floor","bounded-floor"]}).then(i),e.moveSceneBehindHeadset()}else n.end()}}(n):function(e){e.style.display="",e.style.cursor="auto",e.style.left="calc(50% - 75px)",e.style.width="150px",e.textContent="VR NOT FOUND",e.onmouseenter=null,e.onmouseleave=null,e.onclick=null}(n)})),n}var r=document.createElement("a");return r.href="https://webvr.info",r.innerHTML="WEBXR NOT SUPPORTED",r.style.left="calc(50% - 90px)",r.style.width="180px",r.style.textDecoration="none",t(r),r},Kf=function(){function e(t){m()(this,e),this._mainCamera=new d.PerspectiveCamera,this._button=null,this._onToggle=t,this._molContainer=new Yn.RCGroup,this._user=new Yn.RCGroup,this._scalingPivot=new d.Object3D,this._user.add(this._scalingPivot),this._controller1=null,this._controller2=null,this._pressedGripsCounter=0,this._distance=0,this._gfx=null}return y()(e,[{key:"startScalingByControllers",value:function(){this._distance=this._controller1.position.distanceTo(this._controller2.position),Yn.getMiddlePoint(this._controller1.position,this._controller2.position,this._scalingPivot.position),this._scalingPivot.scale.set(1,1,1),this._scalingPivot.updateMatrix(),this._scalingPivot.updateMatrixWorld(),this._scalingPivot.addSavingWorldTransform(this._molContainer)}},{key:"stopScalingByControllers",value:function(){this._gfx.scene.addSavingWorldTransform(this._molContainer)}},{key:"handleGripsDown",value:function(e){this._pressedGripsCounter++,2===this._pressedGripsCounter?this.startScalingByControllers():1===this._pressedGripsCounter&&e.target.addSavingWorldTransform(this._molContainer)}},{key:"handleGripsUp",value:function(e){(this._pressedGripsCounter--,1===this._pressedGripsCounter)?(this.stopScalingByControllers(),(e.target===this._controller1?this._controller2:this._controller1).addSavingWorldTransform(this._molContainer)):0===this._pressedGripsCounter&&this._gfx.scene.addSavingWorldTransform(this._molContainer)}},{key:"enable",value:function(e){if(e){this._gfx=e;var t=e.renderer,n=e.camera;if(!t)throw new Error("No renderer is available to toggle WebVR");if(!n)throw new Error("No camera is available to toggle WebVR");t.xr.enabled=!0,this._button?this._button.style.display="block":(this._button=$f(this),document.body.appendChild(this._button)),this._mainFog=re.now.fog,re.set("fog",!1),this._plugVRNodesIntoScene(e,t),this._setControllersListeners(),this._onToggle&&this._onToggle(!0)}else O.warn("WebVR couldn't be enabled, because gfx is not defined")}},{key:"_plugVRNodesIntoScene",value:function(e,t){this._mainCamera.copy(e.camera),e.scene.add(this._user),e.scene.add(this._molContainer),this._molContainer.add(e.root),this._controller1=t.xr.getController(0),this._controller2=t.xr.getController(1);var n=this._createControllerMesh();this._controller1.add(n),this._controller2.add(n.clone()),this._user.add(this._controller1),this._user.add(this._controller2)}},{key:"_setControllersListeners",value:function(){var e=this;this._controller1.addEventListener("selectstart",(function(t){e.handleGripsDown(t)})),this._controller1.addEventListener("selectend",(function(t){e.handleGripsUp(t)})),this._controller2.addEventListener("selectstart",(function(t){e.handleGripsDown(t)})),this._controller2.addEventListener("selectend",(function(t){e.handleGripsUp(t)})),this._controller1.addEventListener("squeezestart",(function(t){e.handleGripsDown(t)})),this._controller1.addEventListener("squeezeend",(function(t){e.handleGripsUp(t)})),this._controller2.addEventListener("squeezestart",(function(t){e.handleGripsDown(t)})),this._controller2.addEventListener("squeezeend",(function(t){e.handleGripsUp(t)}))}},{key:"disable",value:function(){if(this._gfx){var e=this._gfx,t=e.renderer,n=e.camera;if(!t)throw new Error("No renderer is available to toggle WebVR");t.setAnimationLoop(null);var r=t.xr.getSession();r&&r.end(),t.xr.enabled=!1,this._button&&(this._button.style.display="none"),re.set("fog",this._mainFog),this._unplugVRNodesFromScene(n),this._onToggle&&this._onToggle(!1)}}},{key:"_unplugVRNodesFromScene",value:function(e){this._mainCamera&&e&&e.copy(this._mainCamera);var t=this._molContainer.children[0];t&&this._gfx.scene.add(t),this._molContainer.parent.remove(this._molContainer),this._user&&this._gfx.scene.remove(this._user),this._molContainer=null,this._user=null,this._scalingPivot=null,this._user=null,this._controller1=null,this._controller2=null}},{key:"_createControllerMesh",value:function(){var e=new d.CylinderGeometry(.04,.04,.3),t=new Zi({lights:!1,overrideColor:!0});t.setUberOptions({fixedColor:new d.Color(4474111)}),t.updateUniforms();var n=new d.Mesh(e,t);return n.rotateX(-Math.PI/2),n}},{key:"updateMoleculeScale",value:function(){if(this._controller1&&this._controller2){if(2===this._pressedGripsCounter){Yn.getMiddlePoint(this._controller1.position,this._controller2.position,this._scalingPivot.position);var e=this._controller1.position.distanceTo(this._controller2.position),t=e/this._distance;this._scalingPivot.scale.multiplyScalar(t),this._distance=e}}}},{key:"moveSceneBehindHeadset",value:function(){var e=this._gfx,t=e.camera,n=this._molContainer;n.matrix.identity(),n.position.set(0,0,-4),n.updateMatrix(),n.matrixWorld.multiplyMatrices(t.matrixWorld,n.matrix),e.scene.addSavingWorldTransform(n),this._onToggle&&this._onToggle(!0)}},{key:"getCanvas",value:function(){var e=this._gfx;return e&&e.renderer?e.renderer.domElement:null}}]),e}(),Zf=kn.selectors,Qf=kn.Atom,Jf=kn.Residue,ep=kn.Chain,tp=kn.Molecule,np=0,rp=1,ip=2,op="Could not find suitable loader for this source",ap=K.createElement;function sp(e){var t=e.lastIndexOf(".");return t>=0&&(e=e.substr(0,t)),e}function lp(e,t,n){void 0!==n?e.debug("".concat(t,"... ").concat(Math.floor(100*n),"%")):e.debug("".concat(t,"..."))}function cp(){return re.now.fogColorEnable?re.now.fogColor:re.now.bg.color}function up(e){I.call(this),this._opts=h.a.merge({settingsCookie:"settings",cookiePath:"/"},e),this._gfx=null,this._interpolator=new Cf,this._container=e&&e.container||document.getElementById("miew-container")||h.a.head(document.getElementsByClassName("miew-container"))||document.body,this._containerRoot=this._container,this._running=!1,this._halting=!1,this._building=!1,this._needRender=!0,this._hotKeysEnabled=!0,this.settings=re;var t=O;t.console=!1,t.level="info",this.logger=t,this._cookies=new Xf(this),this.restoreSettings(),e&&e.settings&&this.settings.set(e.settings),this._spinner=null,this._loading=[],this._animInterval=null,this._visuals={},this._curVisualName=null,this._objects=[],this._sourceWindow=null,this.reset(),this._repr&&t.debug("Selected ".concat(this._repr.mode.name," mode with ").concat(this._repr.colorer.name," colorer."));var n=this;up.registeredPlugins.forEach((function(e){e.call(n)})),this._initOnSettingsChanged()}function hp(e,t){for(var n=e;n.firstChild;)n.removeChild(n.firstChild);n.appendChild(t)}function dp(e){return e.getExtension("EXT_frag_depth")}function fp(e){return e.getExtension("WEBGL_depth_texture")&&e.getExtension("WEBGL_draw_buffers")}up.prototype=Object.create(I.prototype),up.prototype.constructor=up,up.prototype.getMaxRepresentationCount=function(){return tc.NUM_REPRESENTATION_BITS},up.prototype._updateShadowCamera=(Af=new d.Matrix4,Ef=new d.Vector3,kf={center:new d.Vector3,halfSize:new d.Vector3},function(){this._gfx.scene.updateMatrixWorld();for(var e=0;e<this._gfx.scene.children.length;e++)if("DirectionalLight"===this._gfx.scene.children[e].type){var t=this._gfx.scene.children[e];Af.copy(t.shadow.camera.matrixWorldInverse),this.getOBB(Af,kf),Ef.subVectors(t.target.position,t.position),t.position.subVectors(kf.center,Ef),t.target.position.copy(kf.center),t.shadow.bias=.09,t.shadow.camera.bottom=-kf.halfSize.y,t.shadow.camera.top=kf.halfSize.y,t.shadow.camera.right=kf.halfSize.x,t.shadow.camera.left=-kf.halfSize.x,t.shadow.camera.near=Ef.length()-kf.halfSize.z,t.shadow.camera.far=Ef.length()+kf.halfSize.z,t.shadow.camera.updateProjectionMatrix()}}),up.prototype.init=function(){var e=this._container,t=K.createElement("div",{class:"miew-canvas"});hp(e,t),this._container=t;var n=document.createDocumentFragment();if(n.appendChild(this._msgMode=ap("div",{class:"mode-message overlay"},ap("p",{},"COMPONENT EDIT MODE"))),n.appendChild(this._msgAtomInfo=ap("div",{class:"atom-info overlay"},ap("p",{},""))),e.appendChild(n),null!==this._gfx)return!0;var r=this;this._showMessage("Viewer is being initialized...");try{this._initGfx(),this._initListeners(),this._spinner=new f.a({lines:13,length:28,width:14,radius:42,color:"#fff",zIndex:700}),window.top.addEventListener("keydown",(function(e){r._onKeyDown(e)})),window.top.addEventListener("keyup",(function(e){r._onKeyUp(e)})),this._objectControls=new Hd(this._gfx.root,this._gfx.pivot,this._gfx.camera,this._gfx.renderer.domElement,(function(){return r._getAltObj()})),this._objectControls.addEventListener("change",(function(e){switch(re.now.shadow.on&&r._updateShadowCamera(),e.action){case"rotate":r.dispatchEvent({type:"rotate",quaternion:e.quaternion});break;case"zoom":r.dispatchEvent({type:"zoom",factor:e.factor});break;default:r.dispatchEvent({type:e.action})}r.dispatchEvent({type:"transform"}),r._needRender=!0}));var i=this._gfx;this._picker=new Yd(i.root,i.camera,i.renderer.domElement),this._picker.addEventListener("newpick",(function(e){r._onPick(e)})),this._picker.addEventListener("dblclick",(function(e){r.center(e)}))}catch(e){if("TypeError"===e.name&&"Cannot read property 'getExtension' of null"===e.message)this._showMessage("Could not create WebGL context.");else{if(!(e.message.search(/webgl/i)>1))throw this._showMessage("Viewer initialization failed."),e;this._showMessage(e.message)}return!1}var o=this._opts&&this._opts.load;if(o){var a=this._opts&&this._opts.type;this.load(o,{fileType:a,keepRepsInfo:!0})}return!0},up.prototype.term=function(){this._showMessage("Viewer has been terminated."),this._loading.forEach((function(e){e.cancel()})),this._loading.length=0,this.halt(),this._gfx=null},up.prototype._showMessage=function(e){var t=document.createElement("div");t.setAttribute("class","miew-message"),t.appendChild(document.createElement("p")).appendChild(document.createTextNode(e)),hp(this._container,t)},up.prototype._showCanvas=function(){hp(this._container,this._gfx.renderer.domElement)},up.prototype._requestAnimationFrame=function(e){var t=this._gfx.renderer.xr;t&&t.enabled?this._gfx.renderer.setAnimationLoop(e):requestAnimationFrame(e)},up.prototype._initGfx=function(){var e={width:this._container.clientWidth,height:this._container.clientHeight},t={preserveDrawingBuffer:!0,alpha:!0,premultipliedAlpha:!1};re.now.antialias&&(t.antialias=!0),e.renderer2d=new Ld,e.renderer=new d.WebGL1Renderer(t),e.renderer.shadowMap.enabled=re.now.shadow.on,e.renderer.shadowMap.autoUpdate=!1,e.renderer.shadowMap.type=d.PCFShadowMap,Vi.init(e.renderer),dp(e.renderer.getContext())||re.set("zSprites",!1),fp(e.renderer.getContext())||re.set("ao",!1),e.renderer.autoClear=!1,e.renderer.setPixelRatio(window.devicePixelRatio),e.renderer.setSize(e.width,e.height),e.renderer.setClearColor(re.now.bg.color,Number(!re.now.bg.transparent)),e.renderer.clearColor(),e.renderer2d.setSize(e.width,e.height),e.camera=new d.PerspectiveCamera(re.now.camFov,e.width/e.height,re.now.camNear,re.now.camFar),e.camera.setMinimalFov(re.now.camFov),e.camera.position.z=re.now.camDistance,e.camera.updateProjectionMatrix(),e.camera.layers.set(Yn.LAYERS.DEFAULT),e.camera.layers.enable(Yn.LAYERS.VOLUME),e.camera.layers.enable(Yn.LAYERS.VOLUME_BFPLANE),e.stereoCam=new d.StereoCamera,e.scene=new d.Scene;var n=cp();e.scene.fog=new d.Fog(n,re.now.camNear,re.now.camFar),e.root=new Yn.RCGroup,e.scene.add(e.root),e.pivot=new Yn.RCGroup,e.root.add(e.pivot),e.selectionScene=new d.Scene,e.selectionRoot=new d.Group,e.selectionRoot.matrixAutoUpdate=!1,e.selectionScene.add(e.selectionRoot),e.selectionPivot=new d.Group,e.selectionPivot.matrixAutoUpdate=!1,e.selectionRoot.add(e.selectionPivot);var r=new d.DirectionalLight(16777215,.45);r.position.set(0,.414,1),r.layers.enable(Yn.LAYERS.TRANSPARENT),r.castShadow=!0,r.shadow.bias=.09,r.shadow.radius=re.now.shadow.radius,r.shadow.camera.layers.set(Yn.LAYERS.SHADOWMAP);var i=e.renderer.getPixelRatio(),o=Math.max(e.width,e.height)*i;r.shadow.mapSize.width=o,r.shadow.mapSize.height=o,r.target.position.set(0,0,0),e.scene.add(r),e.scene.add(r.target);var a=new d.AmbientLight(6710886);a.layers.enable(Yn.LAYERS.TRANSPARENT),e.scene.add(a),e.axes=new qd(e.root,e.camera);var s=e.width*i,l=e.height*i;e.offscreenBuf=new d.WebGLRenderTarget(s,l,{minFilter:d.LinearFilter,magFilter:d.NearestFilter,format:d.RGBAFormat,depthBuffer:!0}),e.renderer.getContext().getExtension("WEBGL_depth_texture")&&(e.offscreenBuf.depthTexture=new d.DepthTexture,e.offscreenBuf.depthTexture.type=d.UnsignedShortType),e.offscreenBuf2=new d.WebGLRenderTarget(s,l,{minFilter:d.LinearFilter,magFilter:d.LinearFilter,format:d.RGBAFormat,depthBuffer:!1}),e.offscreenBuf3=new d.WebGLRenderTarget(s,l,{minFilter:d.LinearFilter,magFilter:d.LinearFilter,format:d.RGBAFormat,depthBuffer:!1}),e.offscreenBuf4=new d.WebGLRenderTarget(s,l,{minFilter:d.LinearFilter,magFilter:d.LinearFilter,format:d.RGBAFormat,depthBuffer:!1}),e.volBFTex=e.offscreenBuf3,e.volFFTex=e.offscreenBuf4,e.volWFFTex=e.offscreenBuf,e.renderer.getContext().getExtension("OES_texture_float")?(e.offscreenBuf5=new d.WebGLRenderTarget(s,l,{minFilter:d.LinearFilter,magFilter:d.LinearFilter,format:d.RGBAFormat,type:d.FloatType,depthBuffer:!1}),e.offscreenBuf6=new d.WebGLRenderTarget(s,l,{minFilter:d.LinearFilter,magFilter:d.LinearFilter,format:d.RGBAFormat,type:d.FloatType,depthBuffer:!1}),e.offscreenBuf7=new d.WebGLRenderTarget(s,l,{minFilter:d.LinearFilter,magFilter:d.LinearFilter,format:d.RGBAFormat,type:d.FloatType,depthBuffer:!0}),e.volBFTex=e.offscreenBuf5,e.volFFTex=e.offscreenBuf6,e.volWFFTex=e.offscreenBuf7):this.logger.warn("Device doesn't support OES_texture_float extension"),e.stereoBufL=new d.WebGLRenderTarget(s,l,{minFilter:d.LinearFilter,magFilter:d.LinearFilter,format:d.RGBAFormat,depthBuffer:!1}),e.stereoBufR=new d.WebGLRenderTarget(s,l,{minFilter:d.LinearFilter,magFilter:d.LinearFilter,format:d.RGBAFormat,depthBuffer:!1}),this._gfx=e,this._showCanvas(),this._embedWebXR("WEBVR"===re.now.stereo),this._container.appendChild(e.renderer2d.getElement());var c=new b;c.domElement.style.position="absolute",c.domElement.style.right="0",c.domElement.style.bottom="0",this._container.appendChild(c.domElement),this._fps=c,this._fps.show(re.now.fps)},up.prototype._initListeners=function(){var e=this;window.addEventListener("resize",(function(){e._onResize()}))},up.prototype._makeUniqueVisualName=function(e){if(!e)return Math.random().toString();for(var t=e,n=1;this._visuals.hasOwnProperty(t);)t="".concat(e," (").concat(n.toString(),")"),n++;return t},up.prototype._addVisual=function(e){if(!e)return null;var t=this._makeUniqueVisualName(e.name);return e.name=t,this._visuals[t]=e,this._gfx.pivot.add(e),e.getSelectionGeo&&this._gfx.selectionPivot.add(e.getSelectionGeo()),t},up.prototype._removeVisual=function(e){var t="",n=null;e instanceof $n?(t=e.name,n=e):"string"==typeof e&&(t=e,n=this._visuals[t]),n&&this._visuals.hasOwnProperty(t)&&this._visuals[t]===n&&(t===this._curVisualName&&(this._curVisualName=void 0),delete this._visuals[t],n.release(),this._needRender=!0)},up.prototype._forEachVisual=function(e){for(var t in this._visuals)this._visuals.hasOwnProperty(t)&&e(this._visuals[t])},up.prototype._releaseAllVisuals=function(){if(this._gfx&&this._gfx.pivot){for(var e in this._visuals)this._visuals.hasOwnProperty(e)&&this._visuals[e].release();this._visuals={}}},up.prototype._forEachComplexVisual=function(e){if(this._gfx&&this._gfx.pivot)for(var t in this._visuals)this._visuals.hasOwnProperty(t)&&this._visuals[t]instanceof tc&&e(this._visuals[t])},up.prototype._getComplexVisual=function(e){e=e||this._curVisualName;var t=null,n=null;return this._forEachComplexVisual((function(r){t=r,r.name===e&&(n=r)})),n||t},up.prototype._getVolumeVisual=function(){var e=null;return this._forEachVisual((function(t){t instanceof vc&&(e=t)})),e},up.prototype._getVisualForComplex=function(e){if(!e)return null;var t=null;return this._forEachComplexVisual((function(n){n.getComplex()===e&&(t=n)})),t},up.prototype.getVisuals=function(){return Object.keys(this._visuals)},up.prototype.getComplexVisualsCount=function(){var e=0;return this._forEachComplexVisual((function(){return e++})),e},up.prototype.getCurrentVisual=function(){return this._curVisualName},up.prototype.setCurrentVisual=function(e){this._visuals[e]&&(this._curVisualName=e)},up.prototype.run=function(){var e=this;if(!this._running){if(this._running=!0,this._halting)return void(this._halting=!1);this._objectControls.enable(!0),this._interpolator.resume(),this._requestAnimationFrame((function(){return e._onTick()}))}},up.prototype.halt=function(){this._running&&(this._discardComponentEdit(),this._discardFragmentEdit(),this._objectControls.enable(!1),this._interpolator.pause(),this._halting=!0)},up.prototype.enableHotKeys=function(e){this._hotKeysEnabled=e,this._objectControls.enableHotkeys(e)},up.prototype._onResize=function(){this._needRender=!0;var e=this._gfx;e.width=this._container.clientWidth,e.height=this._container.clientHeight,e.camera.aspect=e.width/e.height,e.camera.setMinimalFov(re.now.camFov),e.camera.updateProjectionMatrix(),e.renderer.setSize(e.width,e.height),e.renderer2d.setSize(e.width,e.height),this.dispatchEvent({type:"resize"})},up.prototype._resizeOffscreenBuffers=function(e,t,n){var r=this._gfx,i="NONE"===(n=n||"NONE")||"ANAGLYPH"===n,o=i?1:.5;r.offscreenBuf.setSize(o*e,t),r.offscreenBuf2.setSize(o*e,t),r.offscreenBuf3.setSize(o*e,t),r.offscreenBuf4.setSize(o*e,t),r.offscreenBuf5&&r.offscreenBuf5.setSize(o*e,t),r.offscreenBuf6&&r.offscreenBuf6.setSize(o*e,t),r.offscreenBuf7&&r.offscreenBuf7.setSize(o*e,t),i&&(r.stereoBufL.setSize(e,t),r.stereoBufR.setSize(e,t))},up.prototype._onTick=function(){var e=this;if(this._halting)return this._running=!1,void(this._halting=!1);this._fps.update(),this._requestAnimationFrame((function(){return e._onTick()})),this._onUpdate(),this._needRender&&(this._onRender(),this._needRender=!re.now.suspendRender||"WEBVR"===re.now.stereo)},up.prototype._getBSphereRadius=function(){var e=0;return this._forEachVisual((function(t){e=Math.max(e,t.getBoundaries().boundingSphere.radius)})),e*this._objectControls.getScale()},up.prototype.getOBB=(Tf=new d.Sphere,Pf=new d.Box3,Mf=new d.Box3,If=new d.Matrix4,Nf=[new d.Vector3,new d.Vector3,new d.Vector3,new d.Vector3],function(e,t){Mf.makeEmpty(),this._forEachVisual((function(t){Tf.copy(t.getBoundaries().boundingSphere),Tf.applyMatrix4(t.matrixWorld).applyMatrix4(e),Tf.getBoundingBox(Pf),Mf.union(Pf)})),Mf.getCenter(t.center),If.copy(e).invert(),t.center.applyMatrix4(If);var n=Mf.min,r=Mf.max;Nf[0].set(n.x,n.y,n.z),Nf[1].set(r.x,n.y,n.z),Nf[2].set(n.x,r.y,n.z),Nf[3].set(n.x,n.y,r.z);for(var i=0,o=Nf.length;i<o;i++)Nf[i].applyMatrix4(If);t.halfSize.set(Math.abs(Nf[0].x-Nf[1].x),Math.abs(Nf[0].y-Nf[2].y),Math.abs(Nf[0].z-Nf[3].z)).multiplyScalar(.5)}),up.prototype._updateFog=function(){var e=this._gfx;if(re.now.fog){if(void 0===e.scene.fog||null===e.scene.fog){var t=cp();e.scene.fog=new d.Fog(t),this._setUberMaterialValues({fog:re.now.fog})}!function(e,t,n){e.near=t-n*re.now.fogNearFactor,e.far=t+n*re.now.fogFarFactor}(e.scene.fog,e.camera.position.z,this._getBSphereRadius())}else e.scene.fog&&(e.scene.fog=void 0,this._setUberMaterialValues({fog:re.now.fog}))},up.prototype._onUpdate=function(){void 0!==this.isScriptingCommandAvailable&&this.isScriptingCommandAvailable()&&!this._building&&this.callNextCmd(),this._objectControls.update(),this._forEachComplexVisual((function(e){e.getComplex().update()})),re.now.autobuild&&!this._loading.length&&!this._building&&this._needRebuild()&&this.rebuild(),this._loading.length||this._building||this._needRebuild()||this._updateView(),this._updateFog(),this._gfx.renderer.xr.enabled&&this.webVR.updateMoleculeScale()},up.prototype._onRender=function(){var e=this._gfx;e.scene.updateMatrixWorld(),e.camera.updateMatrixWorld(),this._clipPlaneUpdateValue(this._getBSphereRadius()),this._fogFarUpdateValue(),e.renderer.setRenderTarget(null),e.renderer.clear(),this._renderFrame(re.now.stereo)},up.prototype._renderFrame=(Lf=new wf,Df=new d.Vector2,function(e){var t=this._gfx,n=t.renderer;n.getSize(Df),"NONE"!==e&&(t.camera.focus=t.camera.position.z,t.stereoCam.aspect=1,"ANAGLYPH"===e?t.stereoCam.update(t.camera):t.stereoCam.updateHalfSized(t.camera,re.now.camFov));var r=t.renderer.getPixelRatio();switch(this._resizeOffscreenBuffers(Df.width*r,Df.height*r,e),this._renderShadowMap(),e){case"WEBVR":case"NONE":this._renderScene(t.camera,!1);break;case"SIMPLE":case"DISTORTED":n.setScissorTest(!0),n.setScissor(0,0,Df.width/2,Df.height),n.setViewport(0,0,Df.width/2,Df.height),this._renderScene(this._gfx.stereoCam.cameraL,"DISTORTED"===e),n.setScissor(Df.width/2,0,Df.width/2,Df.height),n.setViewport(Df.width/2,0,Df.width/2,Df.height),this._renderScene(this._gfx.stereoCam.cameraR,"DISTORTED"===e),n.setScissorTest(!1);break;case"ANAGLYPH":this._renderScene(this._gfx.stereoCam.cameraL,!1,t.stereoBufL),this._renderScene(this._gfx.stereoCam.cameraR,!1,t.stereoBufR),n.setRenderTarget(null),Lf.uniforms.srcL.value=t.stereoBufL.texture,Lf.uniforms.srcR.value=t.stereoBufR.texture,t.renderer.renderScreenQuad(Lf)}t.renderer2d.render(t.scene,t.camera),re.now.axes&&t.axes&&!t.renderer.xr.enabled&&t.axes.render(n)}),up.prototype._onBgColorChanged=function(){var e=this._gfx,t=cp();e&&(e.scene.fog&&e.scene.fog.color.set(t),e.renderer.setClearColor(re.now.bg.color,Number(!re.now.bg.transparent))),this._needRender=!0},up.prototype._onFogColorChanged=function(){var e=this._gfx,t=cp();e&&e.scene.fog&&e.scene.fog.color.set(t),this._needRender=!0},up.prototype._setUberMaterialValues=function(e){this._gfx.root.traverse((function(t){(t instanceof d.Mesh||t instanceof d.LineSegments||t instanceof d.Line)&&t.material instanceof Zi&&(t.material.setValues(e),t.material.needsUpdate=!0)}))},up.prototype._enableMRT=function(e,t,n){var r=this._gfx,i=r.renderer.getContext(),o=i.getExtension("WEBGL_draw_buffers"),a=r.renderer.properties;if(e){r.renderer.setRenderTarget(n);var s=a.get(n.texture).__webglTexture;i.bindTexture(i.TEXTURE_2D,s),r.renderer.setRenderTarget(t);var l=a.get(t).__webglFramebuffer,c=a.get(t.texture).__webglTexture;i.bindFramebuffer(i.FRAMEBUFFER,l),l.width=t.width,l.height=t.height,i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,c,0),i.framebufferTexture2D(i.FRAMEBUFFER,o.COLOR_ATTACHMENT1_WEBGL,i.TEXTURE_2D,s,0),o.drawBuffersWEBGL([i.COLOR_ATTACHMENT0,o.COLOR_ATTACHMENT1_WEBGL])}else o.drawBuffersWEBGL([i.COLOR_ATTACHMENT0,null])},up.prototype._renderScene=function(e,t,n){t=t||!1,n=n||null;var r=this._gfx;if(r.renderer.setClearColor(re.now.bg.color,Number(!re.now.bg.transparent)),r.renderer.setRenderTarget(n),r.renderer.clear(),r.renderer.xr.enabled)r.renderer.render(r.scene,e);else{r.renderer.setClearColor(0,0),r.renderer.setRenderTarget(r.offscreenBuf4),r.renderer.clearColor(),r.renderer.setClearColor(re.now.bg.color,Number(!re.now.bg.transparent)),r.renderer.setRenderTarget(r.offscreenBuf),r.renderer.clear();var i=null!==this._getComplexVisual(),o=this._getVolumeVisual(),a=i&&re.now.ao;a&&this._enableMRT(!0,r.offscreenBuf,r.offscreenBuf4),"prepass"===re.now.transparency?this._renderWithPrepassTransparency(e,r.offscreenBuf):"standard"===re.now.transparency&&(r.renderer.setRenderTarget(r.offscreenBuf),r.renderer.render(r.scene,e)),a&&this._enableMRT(!1,null,null);var s=i&&re.now.outline.on,l=i&&re.now.fxaa,c=null!==o&&null!=o.getMesh().material,u=a||s||c||l||t?r.offscreenBuf2:n,h=r.offscreenBuf;a?(this._performAO(h,r.offscreenBuf4,r.offscreenBuf.depthTexture,u,r.offscreenBuf3,r.offscreenBuf2),l||t||c||s||(h=u,u=n,r.renderer.setRenderTarget(u),r.renderer.renderScreenQuadFromTex(h.texture,1))):(r.renderer.setRenderTarget(u),r.renderer.renderScreenQuadFromTex(h.texture,1)),s&&(h=u,u=c||l||t?r.offscreenBuf3:n,null!=h&&this._renderOutline(e,r.offscreenBuf,h,u)),this._renderSelection(e,r.offscreenBuf,u),c&&(r.renderer.setRenderTarget(r.offscreenBuf),r.renderer.renderScreenQuadFromTex(u.texture,1),u=r.offscreenBuf,this._renderVolume(o,e,u,r.volBFTex,r.volFFTex,r.volWFFTex),l||t||(r.renderer.setRenderTarget(n),r.renderer.renderScreenQuadFromTex(u.texture,1))),h=u,l&&(u=t?r.offscreenBuf4:n,this._performFXAA(h,u),h=u),t&&(u=n,this._performDistortion(h,u,!0))}},up.prototype._performDistortion=function(){var e=new d.Scene,t=new d.OrthographicCamera(-1,1,1,-1,-500,1e3),n=new d.RawShaderMaterial({uniforms:{srcTex:{type:"t",value:null},aberration:{type:"fv3",value:new d.Vector3(1)}},vertexShader:Dn,fragmentShader:"precision highp float;\n\nvarying vec2 vUv;\nuniform sampler2D srcTex;\nuniform vec3 aberration;\n\nvoid main() {\n  vec2 uv = vUv * 2.0 - 1.0;\n  \n  gl_FragColor.r = texture2D(srcTex, 0.5 * (uv * aberration[0] + 1.0)).r;\n  gl_FragColor.g = texture2D(srcTex, 0.5 * (uv * aberration[1] + 1.0)).g;\n  gl_FragColor.b = texture2D(srcTex, 0.5 * (uv * aberration[2] + 1.0)).b;\n  gl_FragColor.a = 1.0;\n}",transparent:!1,depthTest:!1,depthWrite:!1}),r=Yn.buildDistorionMesh(10,10,re.now.debug.stereoBarrel);return e.add(new _o.Mesh(r,n)),function(r,i,o){this._gfx.renderer.setRenderTarget(i),this._gfx.renderer.clear(),o?(n.uniforms.srcTex.value=r.texture,n.uniforms.aberration.value.set(.995,1,1.01),this._gfx.renderer.render(e,t)):this._gfx.renderer.renderScreenQuadFromTexWithDistortion(r,re.now.debug.stereoBarrel)}}(),up.prototype._renderOutline=(Of=new sf({depth:!0}),function(e,t,n,r){var i=this._gfx;Of.uniforms.srcTex.value=n.texture,Of.uniforms.srcDepthTex.value=t.depthTexture,Of.uniforms.srcTexSize.value.set(t.width,t.height),Of.uniforms.color.value=new d.Color(re.now.outline.color),Of.uniforms.threshold.value=re.now.outline.threshold,Of.uniforms.thickness.value=new d.Vector2(re.now.outline.thickness,re.now.outline.thickness),i.renderer.setRenderTarget(r),i.renderer.renderScreenQuad(Of)}),up.prototype._renderShadowMap=(Vf={minFilter:d.NearestFilter,magFilter:d.NearestFilter,format:d.RGBAFormat},function(){if(re.now.shadow.on){var e=this._gfx,t=e.renderer.getRenderTarget(),n=e.renderer.getActiveCubeFace(),r=e.renderer.getActiveMipmapLevel(),i=e.renderer.state;i.setBlending(d.NoBlending),i.buffers.color.setClear(1,1,1,1),i.buffers.depth.setTest(!0),i.setScissorTest(!1);for(var o=0;o<e.scene.children.length;o++)if("DirectionalLight"===e.scene.children[o].type){var a=e.scene.children[o];null==a.shadow.map&&(a.shadow.map=new d.WebGLRenderTarget(a.shadow.mapSize.width,a.shadow.mapSize.height,Vf),a.shadow.camera.updateProjectionMatrix()),a.shadow.updateMatrices(a),e.renderer.setRenderTarget(a.shadow.map),e.renderer.clear(),e.renderer.render(e.scene,a.shadow.camera)}e.renderer.setRenderTarget(t,n,r)}}),up.prototype._hasSelectionToRender=function(){for(var e=this._gfx.selectionPivot,t=0;t<e.children.length;t++){if(e.children[t].children.length>0)return!0}return!1},up.prototype._renderSelection=function(){var e=new sf;return function(t,n,r){var i=this._gfx;i.renderer.setClearColor("black",0),i.renderer.setRenderTarget(n),i.renderer.clear(!0,!1,!1),this._hasSelectionToRender()?(i.selectionRoot.matrix=i.root.matrix,i.selectionPivot.matrix=i.pivot.matrix,i.renderer.render(i.selectionScene,t)):i.renderer.renderDummyQuad(),i.renderer.setRenderTarget(r),i.renderer.renderScreenQuadFromTex(n.texture,.6),e.uniforms.srcTex.value=n.texture,e.uniforms.srcTexSize.value.set(n.width,n.height),i.renderer.renderScreenQuad(e)}}(),up.prototype._checkVolumeRenderingSupport=function(e){if(!e)return!1;var t=this._gfx,n=t.renderer.getRenderTarget();t.renderer.setRenderTarget(e);var r=t.renderer.getContext(),i=r.checkFramebufferStatus(r.FRAMEBUFFER);return t.renderer.setRenderTarget(n),i===r.FRAMEBUFFER_COMPLETE||(this.logger.warn("Device doesn't support electron density rendering"),!1)},up.prototype._renderVolume=(Ff=new lc.BackFacePosMaterial,Bf=new lc.FrontFacePosMaterial,Uf=(new d.Matrix4).makeTranslation(.5,.5,.5),Gf=new d.Matrix4,function(e,t,n,r,i,o){var a=this._gfx;if(void 0===zf&&(zf=this._checkVolumeRenderingSupport(r)),zf){var s=e.getMesh();s.rebuild(a.camera),a.renderer.setClearColor("black",0),a.renderer.setRenderTarget(r),a.renderer.clear(),a.renderer.setRenderTarget(i),a.renderer.clear(),a.renderer.setRenderTarget(o),a.renderer.clear(),a.renderer.setRenderTarget(r),t.layers.set(Yn.LAYERS.VOLUME_BFPLANE),a.renderer.render(a.scene,t),t.layers.set(Yn.LAYERS.VOLUME),a.scene.overrideMaterial=Ff,a.renderer.render(a.scene,t),a.renderer.setRenderTarget(i),t.layers.set(Yn.LAYERS.VOLUME),a.scene.overrideMaterial=Bf,a.renderer.render(a.scene,t),a.scene.overrideMaterial=null,t.layers.set(Yn.LAYERS.DEFAULT),Gf.copy(s.matrixWorld).invert(),Zi.prototype.uberOptions.world2colorMatrix.multiplyMatrices(Uf,Gf),t.layers.set(Yn.LAYERS.COLOR_FROM_POSITION),a.renderer.setRenderTarget(o),a.renderer.render(a.scene,t);var l=s.material;l.uniforms._BFRight.value=r.texture,l.uniforms._FFRight.value=i.texture,l.uniforms._WFFRight.value=o.texture,t.layers.set(Yn.LAYERS.VOLUME),a.renderer.setRenderTarget(n),a.renderer.render(a.scene,t),t.layers.set(Yn.LAYERS.DEFAULT)}}),up.prototype._renderWithPrepassTransparency=function(e,t){var n=this._gfx;n.renderer.setRenderTarget(t),e.layers.set(Yn.LAYERS.DEFAULT),n.renderer.render(n.scene,e),e.layers.set(Yn.LAYERS.PREPASS_TRANSPARENT),n.renderer.getContext().colorMask(!1,!1,!1,!1),n.renderer.render(n.scene,e),n.renderer.getContext().colorMask(!0,!0,!0,!0),e.layers.set(Yn.LAYERS.TRANSPARENT),n.renderer.render(n.scene,e),e.layers.set(Yn.LAYERS.DEFAULT)},up.prototype._performFXAA=(jf=new uf,function(e,t){if(void 0!==e&&void 0!==t){var n=this._gfx;n.renderer.setClearColor(re.now.bg.color,Number(!re.now.bg.transparent)),n.renderer.setRenderTarget(t),n.renderer.clear(),jf.uniforms.srcTex.value=e.texture,jf.uniforms.srcTexelSize.value.set(1/e.width,1/e.height),jf.uniforms.bgColor.value.set(re.now.bg.color),jf.bgTransparent!==re.now.bg.transparent&&(jf.setValues({bgTransparent:re.now.bg.transparent}),jf.needsUpdate=!0),n.renderer.renderScreenQuad(jf)}}),up.prototype._performAO=(Hf=new ff,Wf=new vf,Yf=new xf,qf=new d.Vector3,function(e,t,n,r,i,o){if(e&&t&&n&&r&&i&&o){var a=this._gfx,s=Math.tan(.5*d.MathUtils.DEG2RAD*a.camera.fov);Hf.uniforms.diffuseTexture.value=e.texture,Hf.uniforms.depthTexture.value=n,Hf.uniforms.normalTexture.value=t.texture,Hf.uniforms.srcTexelSize.value.set(1/e.width,1/e.height),Hf.uniforms.camNearFar.value.set(a.camera.near,a.camera.far),Hf.uniforms.projMatrix.value=a.camera.projectionMatrix,Hf.uniforms.aspectRatio.value=a.camera.aspect,Hf.uniforms.tanHalfFOV.value=s,a.root.matrix.extractScale(qf),Hf.uniforms.kernelRadius.value=re.now.debug.ssaoKernelRadius*qf.x,Hf.uniforms.depthThreshold.value=2*this._getBSphereRadius(),Hf.uniforms.factor.value=re.now.debug.ssaoFactor,a.renderer.setRenderTarget(o),a.renderer.renderScreenQuad(Hf),Wf.uniforms.aoMap.value=o.texture,Wf.uniforms.srcTexelSize.value.set(1/o.width,1/o.height),Wf.uniforms.depthTexture.value=n,a.renderer.setRenderTarget(i),a.renderer.renderScreenQuad(Wf),Yf.uniforms.aoMap.value=i.texture,Yf.uniforms.diffuseTexture.value=e.texture,Yf.uniforms.srcTexelSize.value.set(1/i.width,1/i.height),Yf.uniforms.depthTexture.value=n,Yf.uniforms.projMatrix.value=a.camera.projectionMatrix,Yf.uniforms.aspectRatio.value=a.camera.aspect,Yf.uniforms.tanHalfFOV.value=s;var l=a.scene.fog;l&&(Yf.uniforms.fogNearFar.value.set(l.near,l.far),Yf.uniforms.fogColor.value.set(l.color.r,l.color.g,l.color.b,re.now.fogAlpha)),Yf.useFog===re.now.fog&&Yf.fogTransparent===re.now.bg.transparent||(Yf.setValues({useFog:re.now.fog,fogTransparent:re.now.bg.transparent}),Yf.needsUpdate=!0),a.renderer.setRenderTarget(r),a.renderer.renderScreenQuad(Yf)}}),up.prototype.reset=function(){this._picker&&this._picker.reset(),this._lastPick=null,this._releaseAllVisuals(),this._setEditMode(np),this._resetObjects(),this._gfx&&(Yn.clearTree(this._gfx.pivot),this._gfx.renderer2d.reset()),this.setNeedRender()},up.prototype._resetScene=function(){this._objectControls.reset(),this._objectControls.allowTranslation(!0),this._objectControls.allowAltObjFreeRotation(!0),this.resetReps(),this.resetPivot(),this.rebuildAll()},up.prototype.resetView=function(){this._picker&&this._picker.reset(),this._setEditMode(np),this._resetScene(),this._forEachComplexVisual((function(e){e.updateSelectionMask({}),e.rebuildSelectionGeometry()}))},up.prototype._export=function(e){var t=h.a.head(Id.exporters.find({format:e}));if(!t)return this.logger.error("Could not find suitable exporter for this source"),Promise.reject(new Error("Could not find suitable exporter for this source"));if(this.dispatchEvent({type:"exporting"}),this._visuals[this._curVisualName]instanceof tc){var n=null;return t.SourceClass===tc?n=this._visuals[this._curVisualName]:t.SourceClass===Cn&&(n=this._visuals[this._curVisualName]._complex),new t(n,{miewVersion:up.VERSION}).export().then((function(e){return e}))}return this._visuals[this._curVisualName]instanceof vc?Promise.reject(new Error("Sorry, exporter for volume data not implemented yet")):Promise.reject(new Error("Unexpected format of data"))};var pp,mp=/^(?:(pdb|cif|mmtf|ccp4|dsn6):\s*)?(\d[a-z\d]{3})$/i,vp=/^(?:pc|pubchem):\s*([a-z]+)$/i,yp=/^([a-z][a-z\d\-+.]*):/i;function _p(e,t,n){return new Promise((function(r){if(n.shouldCancel())throw new Error("Operation cancelled");n.notify({type:"fetching"}),e=function(e,t){if(!h.a.isString(e))return e;var n=mp.exec(e);if(n){var r=c()(n,3),i=r[1],o=void 0===i?"pdb":i,a=r[2];switch(o=o.toLowerCase(),a=a.toUpperCase(),o){case"pdb":e="https://files.rcsb.org/download/".concat(a,".pdb");break;case"cif":e="https://files.rcsb.org/download/".concat(a,".cif");break;case"mmtf":e="https://mmtf.rcsb.org/v1.0/full/".concat(a);break;case"ccp4":e="https://www.ebi.ac.uk/pdbe/coordinates/files/".concat(a.toLowerCase(),".ccp4");break;case"dsn6":e="https://edmaps.rcsb.org/maps/".concat(a.toLowerCase(),"_2fofc.dsn6");break;default:throw new Error("Unexpected data format shortcut")}return t.fileType=o,t.fileName="".concat(a,".").concat(o),t.sourceType="url",e}var s=vp.exec(e);if(s){var l=s[1].toLowerCase();return e="https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/".concat(l,"/JSON?record_type=3d"),t.fileType="pubchem",t.fileName="".concat(l,".json"),t.sourceType="url",e}return"url"!==t.sourceType&&void 0!==t.sourceType||(t.sourceType="url",yp.test(e)||(e=K.resolveURL(e))),e}(e,t);var i=h.a.head(Id.loaders.find({type:t.sourceType,source:e}));if(!i)throw new Error(op);var o=t.fileName||i.extractName(e);if(o){var a=K.splitFileName(o),s=c()(a,2),l=s[0],u=s[1];h.a.defaults(t,{name:l,fileExt:u,fileName:o})}!function(e){var t=e.binary;if(void 0!==e.fileType){var n=h.a.head(Id.parsers.find({format:e.fileType}));if(!n)throw new Error("Could not find suitable parser for this format");t=n.binary||!1}if(void 0===t&&void 0!==e.fileExt){var r=h.a.head(Id.parsers.find({ext:e.fileExt}));r&&(t=r.binary||!1)}void 0!==e.fileExt&&".man"===e.fileExt.toLowerCase()&&(e.binary=!0,e.animation=!0),void 0!==t&&void 0!==e.binary&&e.binary!==t&&e.context.logger.warn("Overriding incorrect binary mode"),e.binary=t||!1}(t);var d=h.a.get(t,"preset.expression");if(!h.a.isUndefined(d)&&(d=JSON.parse(d))&&d.settings)for(var f=["singleUnit"],p=0,m=f.length;p<m;++p){var v=f[p],y=h.a.get(d.settings,v);h.a.isUndefined(y)||re.set(v,y)}var _=new i(e,t);_.context=t.context,n.addEventListener("cancel",(function(){return _.abort()})),_.addEventListener("progress",(function(e){e.lengthComputable&&e.total>0?lp(_.logger,"Fetching",e.loaded/e.total):lp(_.logger,"Fetching")})),console.time("fetch"),r(_.load().then((function(e){return console.timeEnd("fetch"),t.context.logger.info("Fetching finished"),n.notify({type:"fetchingDone",data:e}),e})).catch((function(e){throw console.timeEnd("fetch"),t.context.logger.debug(e.message),e.stack&&t.context.logger.debug(e.stack),t.context.logger.error("Fetching failed"),n.notify({type:"fetchingDone",error:e}),e})))}))}up.prototype.load=function(e,t){var n=this;t=h.a.merge({},t,{context:this}),this.settings.now.use.multiFile||(this._loading.length&&(this._loading.forEach((function(e){e.cancel()})),this._loading.length=0),t.animation||this.reset(!0)),this._interpolator.reset(),this.dispatchEvent({type:"loading",options:t,source:e});var r=new Q;this._loading.push(r),r.addEventListener("notification",(function(e){n.dispatchEvent(e.slaveEvent)})),this._spinner.spin(this._container);var i=function(e){var t=n._loading.indexOf(r);return-1!==t&&n._loading.splice(t,1),n._spinner.stop(),n._refreshTitle(),r.notify({type:"loadingDone",anything:e}),e};return _p(e,t,r).then((function(e){return function(e,t,n){if(n.shouldCancel())return Promise.reject(new Error("Operation cancelled"));n.notify({type:"parsing"});var r=h.a.head(Id.parsers.find({format:t.fileType,ext:t.fileExt,data:e}));if(!r)return Promise.reject(new Error("Could not find suitable parser"));var i=new r(e,t);return i.context=t.context,n.addEventListener("cancel",(function(){return i.abort()})),console.time("parse"),i.parse().then((function(e){return console.timeEnd("parse"),n.notify({type:"parsingDone",data:e}),e})).catch((function(e){throw console.timeEnd("parse"),t.error=e,t.context.logger.debug(e.message),e.stack&&t.context.logger.debug(e.stack),t.context.logger.error("Parsing failed"),n.notify({type:"parsingDone",error:e}),e}))}(e,t,r)})).then((function(e){var r=n._onLoad(e,t);return i(r)})).catch((function(e){throw n.logger.error("Could not load data"),n.logger.debug(e),i(e)}))},up.prototype.unload=function(e){this._removeVisual(e||this.getCurrentVisual()),this.resetPivot(),re.now.shadow.on&&this._updateShadowCamera()},up.prototype._startAnimation=function(e){this._stopAnimation();var t=this,n=this._getComplexVisual();if(null!==n){try{this._frameInfo=new Jd(n.getComplex(),e,{onLoadStatusChanged:function(){t.dispatchEvent({type:"mdPlayerStateChanged",state:{isPlaying:t._isAnimating,isLoading:!t._frameInfo||t._frameInfo.isLoading}})},onError:function(e){t._stopAnimation(),t.logger.error(e)}})}catch(e){return void this.logger.error("Animation file does not fit to current complex!")}this._continueAnimation()}else this.logger.error("Unable to start animation - no molecule is loaded.")},up.prototype._pauseAnimation=function(){null!==this._animInterval&&(this._isAnimating=!1,clearInterval(this._animInterval),this._animInterval=null,this._frameInfo&&this.dispatchEvent({type:"mdPlayerStateChanged",state:{isPlaying:this._isAnimating,isLoading:this._frameInfo.isLoading}}))},up.prototype._continueAnimation=function(){this._isAnimating=!0;var e=1e3/re.now.maxfps;e=Number.isNaN(e)?0:e;var t=this,n=t._gfx.pivot,r=this._getComplexVisual();r&&(r.resetSelectionMask(),r.rebuildSelectionGeometry(),this._msgAtomInfo.style.opacity=0),this._animInterval=setInterval((function(){if(t.dispatchEvent({type:"mdPlayerStateChanged",state:{isPlaying:t._isAnimating,isLoading:t._frameInfo.isLoading}}),t._frameInfo.frameIsReady){n.updateToFrame(t._frameInfo),t._updateObjsToFrame(t._frameInfo),t._refreshTitle(" Frame ".concat(t._frameInfo._currFrame," of ").concat(t._frameInfo._framesCount," time interval - ").concat(t._frameInfo._timeStep));try{t._frameInfo.nextFrame()}catch(e){return t.logger.error("Error during animation"),void t._stopAnimation()}t._needRender=!0}}),e)},up.prototype._stopAnimation=function(){null!==this._animInterval&&(clearInterval(this._animInterval),this._frameInfo.disableEvents(),this._frameInfo=null,this._animInterval=null,this.dispatchEvent({type:"mdPlayerStateChanged",state:null}))},up.prototype._onLoad=function(e,t){var n=this._gfx,r=null;if(t.animation)return this._refreshTitle(),this._startAnimation(e),null;if(this._stopAnimation(),t&&t.keepRepsInfo||(this._opts.reps=null,this._opts._objects=null),"Complex"===e.id){var i=e;t.fileName?i.name=i.name||sp(t.fileName).toUpperCase():t.amberFileName?i.name=i.name||sp(t.amberFileName).toUpperCase():i.name="Dynamic ".concat(t.fileType," molecule"),r=this._addVisual(new tc(i.name,i)),this._curVisualName=r;var o=this.info();if(this.logger.info("Parsed ".concat(t.fileName," (").concat(o.atoms," atoms, ").concat(o.bonds," bonds, ").concat(o.residues," residues, ").concat(o.chains," chains).")),h.a.isNumber(this._opts.unit)&&i.setCurrentUnit(this._opts.unit),t.preset);else if(re.now.autoPreset)switch(t.fileType){case"cml":this.resetReps("small");break;case"pdb":case"mmtf":case"cif":!function(e){var t=!1;return e.forEachComponent((function(e){e.forEachResidue((function(e){e._isValid&&(t=!0)}))})),t}(i)?this.resetReps("small"):this.resetReps("macro");break;default:this.resetReps("default")}else this.resetReps("default")}else"Volume"===e.id&&(this.resetEd(),r=this._onLoadEd(e));return n.camera.updateProjectionMatrix(),this._updateFog(),n.root.resetTransform(),this.resetPivot(),this._objectControls.setScale(re.now.radiusToFit/this._getBSphereRadius()),this._resetObjects(),re.now.autoResolution&&this._tweakResolution(),re.now.shadow.on&&this._updateShadowCamera(),this._opts.view&&(this.view(this._opts.view),delete this._opts.view),this._refreshTitle(),r},up.prototype.resetEd=function(){this._edLoader&&(this._edLoader.abort(),this._edLoader=null),this._removeVisual(this._getVolumeVisual()),this._needRender=!0},up.prototype.loadEd=function(e){var t=this;this.resetEd();var n=h.a.head(Id.loaders.find({source:e}));if(!n)return this.logger.error(op),Promise.reject(new Error(op));var r=this._edLoader=new n(e,{binary:!0});return r.context=this,r.load().then((function(e){var n=h.a.head(Id.parsers.find({format:"ccp4"}));if(!n)throw new Error("Could not find suitable parser for this source");var r=new n(e);return r.context=t,r.parse().then((function(e){t._onLoadEd(e)}))})).catch((function(e){t.logger.error("Could not load ED data"),t.logger.debug(e)}))},up.prototype._onLoadEd=function(e){e.normalize();var t=new vc("volume",e);t.getMesh().layers.set(Yn.LAYERS.VOLUME);var n=this._addVisual(t);return this._needRender=!0,n},up.prototype._needRebuild=function(){var e=!1;return this._forEachComplexVisual((function(t){e=e||t.needsRebuild()})),e},up.prototype._rebuildObjects=function(){var e,t,n=this,r=this._gfx,i=[];for(e=0;e<r.pivot.children.length;++e){var o=r.pivot.children[e];o instanceof $n||i.push(o)}for(e=0;e<i.length;++e)i[e].parent.remove(i[e]);setTimeout((function(){var i=n._objects;for(e=0,t=i.length;e<t;++e){var o=i[e];o.needsRebuild&&o.build(),o.getGeometry()&&r.pivot.add(o.getGeometry())}}),10)},up.prototype.changeUnit=function(e,t){var n=this._getComplexVisual(t);if(!n)throw new Error("There is no complex to change!");function r(){var e=n?n.getComplex().getCurrentUnit():0,t=e>0?"Bio molecule ".concat(e):"Asymmetric unit";return"Current unit: ".concat(e," (").concat(t,")")}return void 0===e||(h.a.isString(e)&&(e=Math.max(parseInt(e,10),0)),n.getComplex().setCurrentUnit(e)&&(this._resetScene(),this._updateInfoPanel())),r()},up.prototype.rebuild=function(){var e=this;if(this._building)this.logger.warn("Miew.rebuild(): already building!");else{this._building=!0,this.dispatchEvent({type:"rebuilding"}),this._rebuildObjects(),this._gfx.renderer2d.reset();var t=[];this._forEachComplexVisual((function(e){e.needsRebuild()&&t.push(e.rebuild().then((function(){return new Promise((function(t){e.rebuildSelectionGeometry(),t()}))})))}));var n=this;this._spinner.spin(this._container),Promise.all(t).then((function(){n._spinner.stop(),n._needRender=!0,n._refreshTitle(),e.dispatchEvent({type:"buildingDone"}),n._building=!1}))}},up.prototype.rebuildAll=function(){this._forEachComplexVisual((function(e){e.setNeedsRebuild()}))},up.prototype._refreshTitle=function(e){var t;e=void 0===e?"":e;var n=this._getComplexVisual();if(n){t=n.getComplex().name;var r=n.repGet(n.repCurrent());t+=r?"  ".concat(r.mode.name," Mode"):""}else t=Object.keys(this._visuals).length>0?"Unknown":"No Data";t+=e,this.dispatchEvent({type:"titleChanged",data:t})},up.prototype.setNeedRender=function(){this._needRender=!0},up.prototype._extractRepresentation=function(){var e=this,t=[];this._forEachComplexVisual((function(n){if(0!==n.getSelectionCount()){var r=n.buildSelectorFromMask(1<<n.getSelectionBit()),i=re.now.presets.default,o=n.repAdd({selector:r,mode:i[0].mode.id,colorer:i[0].colorer.id,material:i[0].material.id});o?(e.dispatchEvent({type:"repAdded",index:o.index,name:n.name}),n.repCurrent(o.index),t.push(n.name)):n.repCount()===tc.NUM_REPRESENTATION_BITS&&e.logger.warn("Number of representations is limited to ".concat(tc.NUM_REPRESENTATION_BITS))}})),t.length>0&&this.logger.report("New representation from selection for complexes: ".concat(t.join(", ")))},up.prototype._setReps=function(e){e=e||this._opts&&this._opts.reps||[],this._forEachComplexVisual((function(t){return t.resetReps(e)}))},up.prototype.applyPreset=function(e){for(var t=re.now.presets,n=[e||re.defaults.preset,re.defaults.preset,Object.keys(t)[0]],r=null,i=0;!r&&i<n.length;++i)re.set("preset",n[i]),(r=t[re.now.preset])||this.logger.warn('Unknown preset "'.concat(re.now.preset,'"'));this._setReps(r)},up.prototype.resetReps=function(e){var t=this._opts&&this._opts.reps;t?this._setReps(t):this.applyPreset(e)},up.prototype.repCount=function(e){var t=this._getComplexVisual(e);return t?t.repCount():0},up.prototype.repCurrent=function(e,t){var n=this._getComplexVisual(t),r=n?n.repCurrent(e):-1;return e&&r!==e&&this.logger.warn("Representation ".concat(e," was not found. Current rep remains unchanged.")),r},up.prototype.rep=function(e,t){var n=this._getComplexVisual("");if(!n)return null;var r=n.rep(e,t);return"created"===r.status?this.dispatchEvent({type:"repAdded",index:r.index,name:n.name}):"changed"===r.status&&this.dispatchEvent({type:"repChanged",index:r.index,name:n.name}),r.desc},up.prototype.repGet=function(e,t){var n=this._getComplexVisual(t);return n?n.repGet(e):null},up.prototype.repAdd=function(e,t){var n=this._getComplexVisual(t);if(!n)return-1;var r=n.repAdd(e);return r?(this.dispatchEvent({type:"repAdded",index:r.index,name:t}),r.index):-1},up.prototype.repRemove=function(e,t){var n=this._getComplexVisual(t);n&&(n.repRemove(e),this.dispatchEvent({type:"repRemoved",index:e,name:t}))},up.prototype.repHide=function(e,t,n){this._needRender=!0;var r=this._getComplexVisual(n);return r?r.repHide(e,t):null},up.prototype._setEditMode=function(e){this._editMode=e;var t=this._msgMode;t&&(t.style.opacity=e===np?0:1,e!==np&&(t.getElementsByTagName("p")[0].innerHTML=e===rp?"COMPONENT EDIT MODE":"FRAGMENT EDIT MODE"));this.dispatchEvent({type:"editModeChanged",data:e===np})},up.prototype._enterComponentEditMode=function(){if(this._editMode===np){var e=[];this._forEachComplexVisual((function(t){var n=t.beginComponentEdit();n&&e.push(n)})),e!==[]&&(this._editors=e,this.logger.info("COMPONENT EDIT MODE -- ON"),this._setEditMode(rp),this._objectControls.keysTranslateObj(!0))}},up.prototype._applyComponentEdit=function(){if(this._editMode===rp){this._objectControls.stop(),this._objectControls.keysTranslateObj(!1);for(var e=0;e<this._editors.length;++e)this._editors[e].apply();this._editors=[],this.logger.info("COMPONENT EDIT MODE -- OFF (applied)"),this._setEditMode(np),this.rebuildAll()}},up.prototype._discardComponentEdit=function(){if(this._editMode===rp){this._objectControls.stop(),this._objectControls.keysTranslateObj(!1);for(var e=0;e<this._editors.length;++e)this._editors[e].discard();this._editors=[],this.logger.info("COMPONENT EDIT MODE -- OFF (discarded)"),this._setEditMode(np),this._needRender=!0,this.rebuildAll()}},up.prototype._enterFragmentEditMode=function(){if(this._editMode===np){var e=[];if(this._forEachComplexVisual((function(t){t instanceof tc&&t.getSelectionCount()>0&&e.push(t)})),1===e.length){var t=e[0].beginFragmentEdit();t&&(this._editors=[t],this.logger.info("FRAGMENT EDIT MODE -- ON (single bond)"),this._setEditMode(ip),this._objectControls.allowTranslation(!1),this._objectControls.allowAltObjFreeRotation(t.isFreeRotationAllowed()),this._needRender=!0)}}},up.prototype._applyFragmentEdit=function(){if(this._editMode===ip){this._objectControls.stop();for(var e=0;e<this._editors.length;++e)this._editors[e].apply();this._editors=[],this.logger.info("FRAGMENT EDIT MODE -- OFF (applied)"),this._setEditMode(np),this._objectControls.allowTranslation(!0),this._objectControls.allowAltObjFreeRotation(!0),this.rebuildAll()}},up.prototype._discardFragmentEdit=function(){if(this._editMode===ip){this._objectControls.stop();for(var e=0;e<this._editors.length;++e)this._editors[e].discard();this._editors=[],this.logger.info("FRAGMENT EDIT MODE -- OFF (discarded)"),this._setEditMode(np),this._objectControls.allowTranslation(!0),this._objectControls.allowAltObjFreeRotation(!0),this._needRender=!0}},up.prototype._onPick=function(e){if(re.now.picking&&null===this._animInterval&&this._editMode!==ip&&!this._objectControls.isEditingAltObj()){var t=null;if(e.obj.atom?(t=e.obj.atom.residue.getChain().getComplex(),this._lastPick=e.obj.atom):e.obj.residue?(t=e.obj.residue.getChain().getComplex(),this._lastPick=e.obj.residue):e.obj.chain?(t=e.obj.chain.getComplex(),this._lastPick=e.obj.chain):e.obj.molecule?(t=e.obj.molecule.complex,this._lastPick=e.obj.molecule):this._lastPick=null,t){var n=this._getVisualForComplex(t);n&&(r(n),this._needRender=!0)}else this._forEachComplexVisual(r),this._needRender=!0;this._updateInfoPanel(),this.dispatchEvent(e)}function r(t){t.updateSelectionMask(e.obj),t.rebuildSelectionGeometry()}},up.prototype._onKeyDown=function(e){if(this._running&&this._hotKeysEnabled)switch(e.keyCode){case"C".charCodeAt(0):re.now.editing&&this._enterComponentEditMode();break;case"F".charCodeAt(0):re.now.editing&&this._enterFragmentEditMode();break;case"A".charCodeAt(0):switch(this._editMode){case rp:this._applyComponentEdit();break;case ip:this._applyFragmentEdit()}break;case"D".charCodeAt(0):switch(this._editMode){case rp:this._discardComponentEdit();break;case ip:this._discardFragmentEdit()}break;case"S".charCodeAt(0):e.preventDefault(),e.stopPropagation(),re.set("ao",!re.now.ao),this._needRender=!0;break;case 107:e.preventDefault(),e.stopPropagation(),this._forEachComplexVisual((function(e){e.expandSelection(),e.rebuildSelectionGeometry()})),this._updateInfoPanel(),this._needRender=!0;break;case 109:e.preventDefault(),e.stopPropagation(),this._forEachComplexVisual((function(e){e.shrinkSelection(),e.rebuildSelectionGeometry()})),this._updateInfoPanel(),this._needRender=!0}},up.prototype._onKeyUp=function(e){this._running&&this._hotKeysEnabled&&e.keyCode==="X".charCodeAt(0)&&this._extractRepresentation()},up.prototype._updateInfoPanel=function(){var e,t,n=this._msgAtomInfo.getElementsByTagName("p")[0],r=0;for(this._forEachComplexVisual((function(e){r+=e.getSelectionCount()}));n.firstChild;)n.removeChild(n.firstChild);if(0!==r){var i="".concat(String(r)," atom").concat(1!==r?"s":""," selected");null!==this._lastPick&&(i+=", the last pick:");var o="",a="",s="";if(this._lastPick instanceof Qf){t=(e=this._lastPick).residue,a=e.name;var l=32!==e.location?String.fromCharCode(e.location):"";o="".concat(e.element.fullName," #").concat(e.serial).concat(l,":       ").concat(t._chain._name,".").concat(t._type._name).concat(t._sequence).concat(t._icode.trim(),"."),o+=a,s="Coord: (".concat(e.position.x.toFixed(2).toString(),",     ").concat(e.position.y.toFixed(2).toString(),",     ").concat(e.position.z.toFixed(2).toString(),")")}else this._lastPick instanceof Jf?(t=this._lastPick,o="".concat(t._type._fullName,":       ").concat(t._chain._name,".").concat(t._type._name).concat(t._sequence).concat(t._icode.trim())):this._lastPick instanceof ep?o="chain ".concat(this._lastPick._name):this._lastPick instanceof tp&&(o="molecule ".concat(this._lastPick._name));n.appendChild(document.createTextNode(i)),""!==o&&(n.appendChild(document.createElement("br")),n.appendChild(document.createTextNode(o))),""!==s&&(n.appendChild(document.createElement("br")),n.appendChild(document.createTextNode(s))),this._msgAtomInfo.style.opacity=1}else this._msgAtomInfo.style.opacity=0},up.prototype._getAltObj=function(){if(this._editors){for(var e=null,t=0;t<this._editors.length;++t){var n=this._editors[t].getAltObj();if(n.objects.length>0){if(e){e=null;break}e=n}}if(e)return e}return{objects:[],pivot:new d.Vector3(0,0,0)}},up.prototype.resetPivot=function(){var e=new d.Box3,t=new d.Vector3;return function(){e.makeEmpty(),this._forEachVisual((function(t){e.union(t.getBoundaries().boundingBox)})),e.getCenter(t),this._objectControls.setPivot(t.negate()),this.dispatchEvent({type:"transform"})}}(),up.prototype.setPivotResidue=function(){var e=new d.Vector3;return function(t){var n=this._getVisualForComplex(t.getChain().getComplex());if(n){if(t._controlPoint)e.copy(t._controlPoint);else{for(var r=0,i=0,o=0,a=t._atoms.length,s=0;s<a;++s){var l=t._atoms[s].position;r+=l.x/a,i+=l.y/a,o+=l.z/a}e.set(r,i,o)}e.applyMatrix4(n.matrix).negate(),this._objectControls.setPivot(e),this.dispatchEvent({type:"transform"})}}}(),up.prototype.setPivotAtom=function(){var e=new d.Vector3;return function(t){var n=this._getVisualForComplex(t.residue.getChain().getComplex());n&&(e.copy(t.position),e.applyMatrix4(n.matrix).negate(),this._objectControls.setPivot(e),this.dispatchEvent({type:"transform"}))}}(),up.prototype.getSelectionCenter=(pp=new d.Vector3(0,0,0),function(e,t,n){e.set(0,0,0);var r=0;return this._forEachComplexVisual((function(i){i.getSelectionCenter(pp,t,n||i.getSelectionBit())&&(e.add(pp),r++)})),0!==r&&(e.divideScalar(r),e.negate(),!0)}),up.prototype.setPivotSubset=function(){var e=new d.Vector3(0,0,0);function t(e,t){return e.mask&1<<t}function n(e,t){return t.selector.includesAtom(e)}return function(r){var i=r?n:t;this.getSelectionCenter(e,i,r)?(this._objectControls.setPivot(e),this.dispatchEvent({type:"transform"})):this.logger.warn("selection is empty. Center operation not performed")}}(),up.prototype.screenshot=function(e,t){var n,r,i,o=this._gfx,a=o.renderer.domElement.width,s=o.renderer.domElement.height;function l(){var n;if(K.getBrowser()===K.browserType.SAFARI){var r=document.createElement("canvas"),i=r.getContext("2d");r.width=void 0===e?a:e,r.height=void 0===t?s:t,i.drawImage(o.renderer.domElement,0,0,r.width,r.height),n=r.toDataURL("image/png")}else n=o.renderer.domElement.toDataURL("image/png");return n}if(t=t||e,void 0===e&&void 0===t||e===a&&t===s)n=l();else{var c=o.camera.aspect,u=o.camera.fov,h=(i=o.camera.fov,Math.tan(d.MathUtils.degToRad(.5*i)))*Math.min(o.width,o.height)/o.height,f=e/t;o.renderer.setPixelRatio(1),o.camera.aspect=f,o.camera.fov=(r=h/Math.min(f,1),2*d.MathUtils.radToDeg(Math.atan(r))),o.camera.updateProjectionMatrix(),o.renderer.setDrawingBufferSize(e,t,1),this._renderFrame(re.now.stereo),n=l(),o.renderer.setPixelRatio(window.devicePixelRatio),o.camera.aspect=c,o.camera.fov=u,o.camera.updateProjectionMatrix(),o.renderer.setDrawingBufferSize(o.width,o.height,window.devicePixelRatio),this._needRender=!0}return n},up.prototype.screenshotSave=function(e,t,n){var r=this.screenshot(t,n);K.shotDownload(r,e)},up.prototype.save=function(e){var t=this;this._export(e.fileType).then((function(n){var r=t._visuals[t._curVisualName]._complex.name;K.download(n,r,e.fileType),t._refreshTitle(),t.dispatchEvent({type:"exportingDone"})})).catch((function(e){t.logger.error("Could not export data"),t.logger.debug(e),t._refreshTitle(),t.dispatchEvent({type:"exportingDone",error:e})}))},up.prototype._tweakResolution=function(){var e=[["poor",100],["low",500],["medium",1e3],["high",5e3],["ultra",Number.MAX_VALUE]],t=0;if(this._forEachComplexVisual((function(e){t+=e.getComplex().getAtomCount()})),t>0)for(var n=1e6*this._gfxScore/t,r=0;r<e.length;++r)if(n<e[r][1]){this._autoChangeResolution(e[r][0]);break}},up.prototype._autoChangeResolution=function(e){e!==re.now.resolution&&this.logger.report('Your rendering resolution was changed to "'.concat(e,'" for best performance.')),re.now.resolution=e},up.prototype.saveSettings=function(){this._cookies.setCookie(this._opts.settingsCookie,JSON.stringify(this.settings.getDiffs(!0)))},up.prototype.restoreSettings=function(){try{var e=this._cookies.getCookie(this._opts.settingsCookie),t=e?JSON.parse(e):{};this.settings.applyDiffs(t,!0)}catch(e){this.logger.error("Cookies parse error: ".concat(e.message))}},up.prototype.resetSettings=function(){this.settings.reset()},up.prototype.setOptions=function(e){"string"==typeof e&&(e=up.options.fromAttr(e)),e.reps&&(this._opts.reps=null),h.a.merge(this._opts,e),e.settings&&this.set(e.settings),this._opts._objects=e._objects,this._resetObjects(),e.load&&this.load(e.load,{fileType:e.type}),e.preset&&(re.now.preset=e.preset),e.reps&&this.resetReps(e.preset),this._opts.view&&(this.view(this._opts.view),delete this._opts.view);var t=this._getComplexVisual();t&&(t.getComplex().resetCurrentUnit(),h.a.isNumber(e.unit)&&t.getComplex().setCurrentUnit(e.unit),this.resetView(),this.rebuildAll())},up.prototype.info=function(e){var t=this._getComplexVisual(e);if(!t)return{};var n=t.getComplex(),r=n.metadata;return{id:r.id||n.name||"UNKNOWN",title:r.title&&r.title.join(" ")||"UNKNOWN DATA",atoms:n.getAtomCount(),bonds:n.getBondCount(),residues:n.getResidueCount(),chains:n.getChainCount()}},up.prototype.addObject=function(e,t){var n=null;if(e.type===rf.prototype.type&&(n=rf),null===n)throw new Error("Unknown scene object type - ".concat(e.type));try{var r=new n(e.params,e.opts);this._addSceneObject(r)}catch(e){if(t)throw e;this.logger.debug("Error during scene object creation: ".concat(e.message))}this._needRender=!0},up.prototype._addSceneObject=function(e){var t=this._getComplexVisual();e.build&&t&&(e.build(t.getComplex()),this._gfx.pivot.add(e.getGeometry()));var n=this._objects;n[n.length]=e},up.prototype._updateObjsToFrame=function(e){for(var t=this._objects,n=0,r=t.length;n<r;++n)t[n].updateToFrame&&t[n].updateToFrame(e)},up.prototype._resetObjects=function(){var e=this._opts._objects;if(this._objects=[],e)for(var t=0,n=e.length;t<n;++t)this.addObject(e[t],!1)},up.prototype.removeObject=function(e){var t=this._objects[e];if(!t)throw new Error("Scene object with index ".concat(e," does not exist"));t.destroy(),this._objects.splice(e,1),this._needRender=!0},up.prototype.getURL=function(e){return Se.toURL(this.getState(h.a.defaults(e,{compact:!0,settings:!1,view:!1})))},up.prototype.getScript=function(e){return Se.toScript(this.getState(h.a.defaults(e,{compact:!0,settings:!0,view:!0})))},up.prototype._compareReps=function(e,t){var n={},r=0;e&&(r=e.repCount());var i=re.defaults.presets[re.now.preset],o=t;void 0===i||i.length>r?(o=!1,n.preset="empty"):re.now.preset!==re.defaults.preset&&(n.preset=re.now.preset);for(var a=[],s=!0,l=0,c=r;l<c;++l)a[l]=e.repGet(l).compare(o?i[l]:null),h.a.isEmpty(a[l])||(s=!1);return s||(n.reps=a),n},up.prototype.getState=function(e){var t={};e=h.a.defaults(e,{compact:!0,settings:!1,view:!1});var n=this._getComplexVisual();if(null!==n){var r=n.getComplex(),i=r.metadata;if(i.id){var o=i.format?"".concat(i.format,":"):"";t.load=o+i.id}var a=r.getCurrentUnit();1!==a&&(t.unit=a)}var s=this._compareReps(n,e.compact);s.preset&&(t.preset=s.preset),s.reps&&(t.reps=s.reps);for(var l=this._objects,c=[],u=0,d=l.length;u<d;++u)c[u]=l[u].identify();if(l.length>0&&(t._objects=c),e.view&&(t.view=this.view()),e.settings){var f=this.settings.getDiffs(!1);h.a.isEmpty(f)||(t.settings=f)}return t},up.prototype.get=function(e,t){return re.get(e,t)},up.prototype._clipPlaneUpdateValue=function(e){var t=Math.max(this._gfx.camera.position.z-e*re.now.draft.clipPlaneFactor,re.now.camNear),n={clipPlaneValue:t};this._forEachComplexVisual((function(e){e.setUberOptions(n)}));for(var r=0,i=this._objects.length;r<i;++r){var o=this._objects[r];o._line&&o._line.material.setUberOptions(n)}null!==this._picker&&(this._picker.clipPlaneValue=t)},up.prototype._fogFarUpdateValue=function(){null!==this._picker&&(this._gfx.scene.fog?this._picker.fogFarValue=this._gfx.scene.fog.far:this._picker.fogFarValue=void 0)},up.prototype._updateShadowmapMeshes=function(e){this._forEachComplexVisual((function(t){for(var n=t._reprList,r=0,i=n.length;r<i;++r){var o=n[r];e(o.geo,o.material)}}))},up.prototype._updateMaterials=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0;this._forEachComplexVisual((function(r){return r.setMaterialValues(e,t,n)}));for(var r=0,i=this._objects.length;r<i;++r){var o=this._objects[r];o._line&&(o._line.material.setValues(e),o._line.material.needsUpdate=!0)}},up.prototype._fogAlphaChanged=function(){this._forEachComplexVisual((function(e){e.setUberOptions({fogAlpha:re.now.fogAlpha})}))},up.prototype._embedWebXR=function(){var e=this;if("WEBVR"!==re.now.stereo)return this.webVR&&this.webVR.disable(),void(this.webVR=null);this.webVR||(this.webVR=new Kf((function(){e._requestAnimationFrame((function(){return e._onTick()})),e._needRender=!0,e._onResize()}))),this.webVR.enable(this._gfx)},up.prototype._initOnSettingsChanged=function(){var e=this,t=function(t,n){(t=h.a.isArray(t)?t:[t]).forEach((function(t){e.settings.addEventListener("change:".concat(t),n)}))};t("modes.VD.frame",(function(){var t=e._getVolumeVisual();null!==t&&(t.showFrame(re.now.modes.VD.frame),e._needRender=!0)})),t("modes.VD.isoMode",(function(){var t=e._getVolumeVisual();null!==t&&(t.getMesh().material.updateDefines(),e._needRender=!0)})),t("bg.color",(function(){e._onBgColorChanged()})),t("ao",(function(){if(re.now.ao&&!fp(e._gfx.renderer.getContext()))e.logger.warn("Your device or browser does not support ao"),re.set("ao",!1);else{var t={normalsToGBuffer:re.now.ao};e._setUberMaterialValues(t)}})),t("zSprites",(function(){re.now.zSprites&&!dp(e._gfx.renderer.getContext())&&(e.logger.warn("Your device or browser does not support zSprites"),re.set("zSprites",!1)),e.rebuildAll()})),t("fogColor",(function(){e._onFogColorChanged()})),t("fogColorEnable",(function(){e._onFogColorChanged()})),t("bg.transparent",(function(t){var n=e._gfx;n&&n.renderer.setClearColor(re.now.bg.color,Number(!re.now.bg.transparent)),e._updateMaterials({fogTransparent:t.value}),e.rebuildAll()})),t("draft.clipPlane",(function(t){e._updateMaterials({clipPlane:t.value}),e.rebuildAll()})),t("shadow.on",(function(t){var n={shadowmap:t.value,shadowmapType:re.now.shadow.type},r=e._gfx;r&&(r.renderer.shadowMap.enabled=Boolean(n.shadowmap)),e._updateMaterials(n,!0),n.shadowmap?(e._updateShadowCamera(),e._updateShadowmapMeshes(Wl.createShadowmapMaterial)):e._updateShadowmapMeshes(Wl.removeShadowmapMaterial),e._needRender=!0})),t("shadow.type",(function(t){re.now.shadow.on&&(e._updateMaterials({shadowmapType:t.value},!0),e._needRender=!0)})),t("shadow.radius",(function(t){for(var n=0;n<e._gfx.scene.children.length;n++){if(void 0!==e._gfx.scene.children[n].shadow)e._gfx.scene.children[n].shadow.radius=t.value,e._needRender=!0}})),t("fps",(function(){e._fps.show(re.now.fps)})),t(["fog","fogNearFactor","fogFarFactor"],(function(){e._updateFog(),e._needRender=!0})),t("fogAlpha",(function(){var t=re.now.fogAlpha;(t<0||t>1)&&e.logger.warn("fogAlpha must belong range [0,1]"),e._fogAlphaChanged(),e._needRender=!0})),t("autoResolution",(function(t){t.value&&!e._gfxScore&&e.logger.warn("Benchmarks are missed, autoresolution will not work! Autoresolution should be set during miew startup.")})),t("stereo",(function(){e._embedWebXR("WEBVR"===re.now.stereo),e._needRender=!0})),t(["transparency","palette"],(function(){e.rebuildAll()})),t("resolution",(function(){e.rebuildAll();var t=e._getVolumeVisual();t&&(t.getMesh().material.updateDefines(),e._needRender=!0)})),t(["axes","fxaa","ao","outline.on","outline.color","outline.threshold","outline.thickness"],(function(){e._needRender=!0}))},up.prototype.set=function(e,t){re.set(e,t)},up.prototype.select=function(e,t){var n=this._getComplexVisual();if(n){var r=e;h.a.isString(e)&&(r=Zf.parse(e).selector),n.select(r,t),this._lastPick=null,this._updateInfoPanel(),this._needRender=!0}};up.prototype.view=function(e){var t,n,r,i=this,o=this._gfx.pivot,a=[];return void 0===e?(t=o.position,n=i._objectControls.getScale()/re.now.radiusToFit,(r=new d.Euler).setFromQuaternion(i._objectControls.getOrientation(),"ZXY"),a=[t.x,t.y,t.z,n,r.x,r.y,r.z],"1"+K.arrayToBase64(a,Float32Array)):(function(){40===e.length&&(e="0".concat(e));var t=e[0];if(a=K.arrayFromBase64(e.substr(1),Float32Array),"1"!==t){if("0"!==t)return void i.logger.warn("Encoded view version mismatch, stored as ".concat(t," vs ").concat("1"," expected"));a[3]/=8}var n=i._interpolator,r=n.createView();r.position.copy(o.position),r.scale=i._objectControls.getScale(),r.orientation.copy(i._objectControls.getOrientation());var s=n.createView();s.position.set(a[0],a[1],a[2]),i._getComplexVisual()&&s.position.sub(i._getComplexVisual().position),s.scale=a[3],s.orientation.setFromEuler(new d.Euler(a[4],a[5],a[6],"ZXY")),n.setup(r,s)}(),e)},up.prototype._updateView=function(){var e=this._gfx.pivot,t=this._interpolator;if(t.wasStarted()||t.start(),t.isMoving()){var n=t.getCurrentView();if(n.success){var r=n.view;e.position.copy(r.position),this._objectControls.setScale(r.scale*re.now.radiusToFit),this._objectControls.setOrientation(r.orientation),this.dispatchEvent({type:"transform"}),this._needRender=!0}}},up.prototype.translate=function(e,t,n){this._objectControls.translatePivot(e,t,n),this.dispatchEvent({type:"transform"}),this._needRender=!0},up.prototype.rotate=function(e,t,n){this._objectControls.rotate((new d.Quaternion).setFromEuler(new d.Euler(e,t,n,"XYZ"))),this.dispatchEvent({type:"transform"}),this._needRender=!0},up.prototype.scale=function(e){if(e<=0)throw new RangeError("Scale should be greater than zero");this._objectControls.scale(e),this.dispatchEvent({type:"transform"}),this._needRender=!0},up.prototype.center=function(e){if(void 0===e)return this.setPivotSubset(),void(this._needRender=!0);if(void 0!==e.obj&&("atom"in e.obj||"residue"in e.obj))return"atom"in e.obj?this.setPivotAtom(e.obj.atom):this.setPivotResidue(e.obj.residue),void(this._needRender=!0);if(void 0===e.obj&&""!==e){var t=Zf.parse(e);if(void 0===t.error)return this.setPivotSubset(t),void(this._needRender=!0)}this.resetPivot(),this._needRender=!0},up.prototype.within=function(e,t){var n=this._getComplexVisual();if(!n)return Zf.None();e instanceof String&&(e=Zf.parse(e));var r=n.within(e,t);return r&&(n.rebuildSelectionGeometry(),this._needRender=!0),r},up.prototype.projected=function(e,t){var n=this._getComplexVisual(t);if(!n)return!1;var r=n.getComplex().getAtomByFullname(e);if(null===r)return!1;var i=r.position.clone();return this._gfx.pivot.updateMatrixWorldRecursive(),this._gfx.camera.updateMatrixWorldRecursive(),this._gfx.pivot.localToWorld(i),i.project(this._gfx.camera),{x:.5*(i.x+1)*this._gfx.width,y:.5*(1-i.y)*this._gfx.height}},up.prototype.dssp=function(e){var t=this._getComplexVisual(e);t&&(t.getComplex().dssp(),t._reprList.forEach((function(e){"CA"!==e.mode.id&&"SS"!==e.colorer.id||(e.needsRebuild=!0)})))},up.prototype.exportCML=function(){var e=this;var t=e._getComplexVisual(),n=t?t.getComplex():null;return n&&n.originalCML?(function(t){var n=function(e){var t=new d.Vector3,n=new d.Vector3,r=new d.Vector3;e.extractBasis(t,n,r),t.normalize(),n.normalize(),r.normalize();var i=new d.Matrix4;return i.identity(),i.makeBasis(t,n,r),i}(e._gfx.root.matrixWorld),r=new d.Vector4(0,0,0,0),i=new d.Vector4(0,0,0,0),o=null,a=null;t.forEachAtom((function(e){e.xmlNodeRef&&e.xmlNodeRef.xmlNode&&(o=e.xmlNodeRef.xmlNode,a=e.position,r.set(a.x,a.y,a.z,1),r.applyMatrix4(n),o.setAttribute("x3",r.x.toString()),o.setAttribute("y3",r.y.toString()),o.setAttribute("z3",r.z.toString()),o.removeAttribute("x2"),o.removeAttribute("y2"))})),t.forEachSGroup((function(e){if(e.xmlNodeRef&&e.xmlNodeRef.xmlNode){o=e.xmlNodeRef.xmlNode,a=e.getPosition(),r.set(a.x,a.y,a.z,1);var t=e.getCentralPoint();null===t?r.applyMatrix4(n):(i.set(t.x,t.y,t.z,0),r.add(i),r.applyMatrix4(n),i.set(t.x,t.y,t.z,1),i.applyMatrix4(n),r.sub(i)),o.setAttribute("x",r.x.toString()),o.setAttribute("y",r.y.toString()),o.setAttribute("z",r.z.toString())}}))}(n),(new XMLSerializer).serializeToString(n.originalCML)):null},up.prototype.motm=function(){re.set({fogColorEnable:!0,fogColor:0,outline:{on:!0,threshold:.01},bg:{color:16777215}}),this._forEachComplexVisual((function(e){for(var t=[],n=e.getComplex(),r=Zs.get(re.now.palette),i=0;i<n.getChainCount();i++){var o=n._chains[i]._name,a=r.getChainColor(o);t[i]={selector:"chain ".concat(o),mode:"VW",colorer:["CB",{color:a,factor:.9}],material:"FL"}}e.resetReps(t)}))},up.prototype.VERSION="0.9.0+20230822.103938.6b542ed",h.a.assign(up,{VERSION:up.prototype.VERSION,registeredPlugins:[],chem:kn,io:Id,modes:Ps,colorers:zl,materials:Ul,palettes:Zs,options:Se,settings:re,utils:K,gfx:{Representation:ql},thirdParty:{lodash:h.a,three:d}});var gp=up,xp=n("2zIC"),bp={$help:["Rendering mode shortcut","    BS - balls and sticks mode","    LN - lines mode","    LC - licorice mode","    VW - van der waals mode","    TR - trace mode","    TU - tube mode","    CA - cartoon mode","    SA - isosurface mode","    QS - quick surface mode","    SE - solvent excluded mode","    TX - text mode"],BS:{$help:["   Balls and sticks","      aromrad = <number> #aromatic radius","      atom = <number>    #atom radius","      bond = <number>    #bond radius","      multibond = <bool> #use multibond","      showarom = <bool>  #show aromatic","      space = <number>   #space value\n"]},CA:{$help:["   Cartoon","      arrow = <number>   #arrow size","      depth = <number>   #depth of surface","      heightSegmentsRatio = <number>","      radius = <number>  #tube radius","      tension = <number> #","      width = <number>  #secondary width\n"]},LN:{$help:["   Lines","      atom = <number>    #atom radius","      chunkarom = <number>","      multibond = <bool> #use multibond","      showarom = <bool>  #show aromatic","      offsarom = <number>\n"]},LC:{$help:["   Licorice","      aromrad = <number> #aromatic radius","      bond = <number>    #bond radius","      multibond = <bool> #use multibond","      showarom = <bool>  #show aromatic","      space = <number>   #space value\n"]},VW:{$help:["   Van der Waals","      nothing\n"]},TR:{$help:["   Trace","      radius = <number>  #tube radius\n"]},TU:{$help:["   Tube","      heightSegmentsRatio = <number>","      radius = <number>  #tube radius","      tension = <number> \n"]},SA:{$help:["   Surface","      zClip = <bool> #clip z plane\n"]},QS:{$help:["   Quick surface","      isoValue = <number>","      scale = <number>","      wireframe = <bool>","      zClip = <bool> #clip z plane\n"]},SE:{$help:["   Solvent excluded surface","      zClip = <bool> #clip z plane\n"]},TX:{$help:["   Text mode",'      template = <format string> string that can include "{{ id }}"',"          it will be replaced by value, id can be one of next:","          serial, name, type, sequence, residue, chain, hetatm, water\n",'      horizontalAlign = <string> {"left", "right", "center"}','      verticalAlign = <string> {"top", "bottom", "middle"}',"      dx = <number> #offset along x","      dy = <number> #offset along y","      dz = <number> #offset along z","      fg = <string> #text color modificator","           could be keyword, named color or hex","      fg = <string> #back color modificator","           could be keyword, named color or hex","      showBg = <bool> #if set show background","           plate under text"]}},wp={$help:["Coloring mode shortcut","    EL - color by element","    CH - color by chain","    SQ - color by sequence","    RT - color by residue type","    SS - color by secondary structure","    UN - uniform"],UN:{$help:["Parameters of coloring modes customization","   Uniform","      color = <number|color> #RGB->HEX->dec\n"],color:{$help:Object.keys(Zs.get(re.now.palette).namedColors).sort().join("\n")}}},Sp={$help:["Material shortcut","    DF - diffuse","    TR - transparent","    SF - soft plastic","    PL - glossy plastic","    ME - metal","    GL - glass"]},Cp={$help:["Short (packed) representation description as a set of variables","    s=<EXPRESSION>","        selector property","    m=<MODE_ID>[!<PARAMETER>:<VALUE>[,...]]","        render mode property","    c=<COLORER_ID>[!<PARAMETER>:<VALUE>[,...]]","        color mode property","    mt=<MATERIAL_ID>","        material property"],s:{$help:"Selection expression string as it is in menu->representations->selection"},m:bp,c:wp,mt:Sp},Rp={$help:["Parameters of rendering modes customization: modes","Parameters of colorer customization: colorers","Autobuild: autobuild = (<number>|<bool>)"],modes:bp,colorers:wp},Ap={$help:["help (<cmd name>| <path to property>)","You can get detailed information about command options",'   using "help cmd.opt.opt.[...]"\n',"   you can use one line comments","   everything started from (#|//) will be skipped","   Example: >build //some comment\n","List of available commands:"],reset:{$help:["Reload current object, delete all representations","    Nothing will work until load new object"]},load:{$help:["load (<PDBID>|<URL>|-f [<*.NC FILE URL STRING>])","    Load new pdb object from selected source"],PDBID:{$help:"pdb id in remote molecule database"},URL:{$help:"url to source file"},f:{$help:["open file system dialog to fetch local file","optionally you can determine trajectory file","via URL for *.top model"]}},clear:{$help:"No args. Clear terminal"},add:{$help:["add [<REP_NAME>] [<DESCRIPTION>]","    Add new item to representation set with","    default or <DESCRIPTION> params"],REP_NAME:{$help:"Identifier string [_,a-z,A-Z,0-9] can not start from digit"},DESCRIPTION:Cp},rep:{$help:["rep [<REP_NAME>|<REP_INDEX>] [<DESCRIPTION>]","    set current representation by name or index","    edit current representation by <DESCRIPTION>"],REP_NAME:{$help:["Identifier string [_,a-z,A-Z,0-9] can not start from digit","Must be declared before"]},REP_INDEX:{$help:"Index of available representation"},DESCRIPTION:Cp},remove:{$help:["remove (<REP_NAME>|<REP_INDEX>)","Remove representation by name or index"],REP_NAME:{$help:["Identifier string [_,a-z,A-Z,0-9] can not start from digit","Must be declared before"]},REP_INDEX:{$help:"Index of available representation"}},selector:{$help:["selector <EXPRESSION>","   set selector from EXPRESSION to current representation"],EXPRESSION:{$help:"Selection expression string as it is in menu->representations->selection"}},mode:{$help:["mode <MODE_ID> [<PARAMETER>=<VALUE>...]","   set rendering mode and apply parameters to current representation"],MODE_ID:bp},color:{$help:["color <COLORER_ID> [<PARAMETER>=<VALUE>...]","   set colorer and apply parameters to current representation"],COLORER_ID:wp},material:{$help:["material <MATERIAL_ID>","   set material to current representation"],MATERIAL_ID:Sp},build:{$help:"build help str",add:{$help:"build.add",new:{$help:["add.new","add.new new line 1","add.new new line 2","add.new new line 3"]}},del:{$help:"build.del"}},list:{$help:["list [-e|-s|<REP_NAME>|<REP_INDEX>]","Print representations if no args print list of representations","    -e expand list and show all representations","    -s show all user-registered selectors","    <REP_NAME>|<REP_INDEX> show only current representation"]},hide:{$help:["hide (<REP_NAME>|<REP_INDEX>)","Hide representation referenced in args"]},show:{$help:["show (<REP_NAME>|<REP_INDEX>)","Show representation referenced in args"]},get:{$help:["get <PARAMETER>","Print <PARAMETER> value","    <PARAMETER> - path to option use get.PARAMETER to get more info"],PARAMETER:Rp},set:{$help:["set <PARAMETER> <VALUE>","Set <PARAMETER> with <VALUE>","    <PARAMETER> - path to option use set.PARAMETER to get more info"],PARAMETER:Rp},set_save:{$help:["set_save","Save current settings to cookie"]},set_restore:{$help:["set_restore","Load and apply settings from cookie"]},set_reset:{$help:["set_reset","Reset current settings to the defaults"]},preset:{$help:["preset [<PRESET>]","Reset current representation or set preset to <PRESET>"],PRESET:{$help:["default","wire","small","macro"]}},unit:{$help:["unit [<unit_id>]","Change current biological structure view. Zero <unit_id> value means asymmetric unit,","positive values set an assembly with corresponding number.","Being called with no parameters command prints current unit information."]},view:{$help:["view [<ENCODED_VIEW>]","Get current encoded view or set if ENCODED_VIEW placed as argument"],ENCODED_VIEW:{$help:["encoded view matrix string (binary code)"]}},rotate:{$help:["rotate (x|y|z) [<DEGREES>] [(x|y|z) [<DEGREES>]]...","Rotate scene"]},scale:{$help:["scale <SCALE>","Scale scene"]},select:{$help:["select <SELECTOR_STRING> [as <SELECTOR_NAME>]","Select atoms using selector defined in SELECTOR_STRING","    and if SELECTOR_NAME is defined register it in viewer","    you can use it later as a complex selector"]},within:{$help:["within <DISTANCE> of <SELECTOR_STRING> as <SELECTOR_NAME>","Build within named selector","    DISTANCE        <number>","    SELECTOR_STRING <string(selection language)>","    SELECTOR_NAME   <identifier>"]},url:{$help:["url [-s] [-v]","Report URL encoded scene","    if -s set that include settings in the URL","    if -v set that include view in the URL"]},screenshot:{$help:["screenshot [<WIDTH> [<HEIGHT>]]","Make a screenshot of the scene","    WIDTH  <number> in pixels","    HEIGHT <number> in pixels, equal to WIDTH by default"]},line:{$help:["line <first_atom_path> <second_atom_path> [<PARAMETER>=<VALUE>]","Draw dashed line between two specified atoms"]},removeobj:{$help:["removeobj <id>","Remove scene object by its index. Indices could be obtained by <listobj> command"]},listobj:{$help:["listobj","Display the list of all existing scene objects"]}},Ep=gp.chem.selectors,kp=gp.modes,Tp=gp.colorers,Pp=gp.materials,Mp=gp.palettes,Ip=gp.options,Np=gp.settings;function Lp(){}var Dp,Op=(Dp=new Lp,function(){return Dp}),Vp=new(function(){function e(){m()(this,e),this.representationMap={},this.representationID={}}return y()(e,[{key:"get",value:function(e){return this.representationMap[e]||this.representationID[e]||"<no name>"}},{key:"add",value:function(e,t){if(-1===e)return"Can not create representation: there is no data";if(void 0!==t){if(this.representationMap.hasOwnProperty(e))return"This name has already existed, registered without name";this.representationMap[e.toString()]=t,this.representationID[t]=e.toString()}return"Representation ".concat(e," successfully added")}},{key:"remove",value:function(e){e&&this.representationID.hasOwnProperty(e)&&(delete this.representationMap[this.representationID[e]],delete this.representationID[e]);var t=Object.keys(this.representationID).sort();for(var n in t)if(t.hasOwnProperty(n)){var r=t[n];r>e&&(this.representationID[r-1]=this.representationID[r],this.representationMap[this.representationID[r]]-=1,delete this.representationID[r])}}},{key:"clear",value:function(){this.representationMap={},this.representationID={}}}]),e}());function zp(e){var t={s:"selector",m:"mode",c:"colorer",mt:"material",mode:"modes",color:"colorers",colorer:"colorers",select:"selector",material:"materials",selector:"selector"}[e];return void 0===t?e:t}var Fp=new(function(){function e(){m()(this,e)}return y()(e,[{key:"list",value:function(e,t,n){var r="";if(e&&void 0!==t&&(void 0===n||"-e"===n))for(var i=e.repCount(),o=0;o<i;o++)r+=this.listRep(e,t,o,n);return r}},{key:"listRep",value:function(e,t,n,r){var i="",o=e.repGet(n);if(!o)return O.warn("Rep ".concat(n," does not exist!")),i;var a=n,s=t.get(a),l=o.mode,c=o.colorer,u=o.selectorString,h=o.materialPreset;return i+="#".concat(a," : ").concat(l.name).concat("<no name>"===s?"":", ".concat(s),"\n"),void 0!==r&&(i+='    selection : "'.concat(u,'"\n'),i+="    mode      : (".concat(l.id,"), ").concat(l.name,"\n"),i+="    colorer   : (".concat(c.id,"), ").concat(c.name,"\n"),i+="    material  : (".concat(h.id,"), ").concat(h.name,"\n")),i}},{key:"listSelector",value:function(e,t){var n="";for(var r in t)t.hasOwnProperty(r)&&(n+="".concat(r,' : "').concat(t[r],'"\n'));return n}},{key:"listObjs",value:function(e){var t=e._objects;if(!t||!Array.isArray(t)||0===t.length)return"There are no objects on the scene";for(var n=[],r=0,i=t.length;r<i;++r)n[r]="".concat(r,": ").concat(t[r].toString());return n.join("\n")}},{key:"joinHelpStr",value:function(e){return e instanceof Array?e.join("\n"):e}},{key:"help",value:function(e){if(h.a.isUndefined(e))return"".concat(this.joinHelpStr(Ap.$help),"\n").concat(h.a.slice(h.a.sortBy(h.a.keys(Ap)),1).join(", "),"\n");var t=h.a.get(Ap,e);return h.a.isUndefined(t)?this.help():"".concat(this.joinHelpStr(t.$help),"\n")}},{key:"load",value:function(e,t){if(void 0!==e&&void 0!==t&&"-f"!==t){e.awaitWhileCMDisInProcess();var n=function(){return e.finishAwaitingCMDInProcess()};e.load(t).then(n,n)}}},{key:"checkArg",value:function(e,t,n){if(void 0!==e&&void 0!==t){if("selector"===zp(e)){var r=Ep.parse(t);if(void 0!==r.error)throw{message:r.error};return void 0!==n&&n?r.selector:t}for(var i,o={colorers:Tp,modes:kp,materials:Pp},a=e;a!==i;)a=zp(i=a);if(void 0===o[a].get(t))throw{message:"".concat(t," is not existed in ").concat(a)};return t}return Op}},{key:"propagateProp",value:function(e,t){if(void 0!==e){var n=Ip.adapters[ee()(h.a.get(Np.defaults,e))];if(void 0===n)throw{message:"".concat(e," is not existed")};if((e.endsWith(".color")||e.endsWith(".baseColor")||e.endsWith(".EL.carbon"))&&"number"!=typeof t&&(t=Mp.get(Np.now.palette).getNamedColor(t)),e.endsWith(".fg")||e.endsWith(".bg"))if("number"!=typeof t){var r=Mp.get(Np.now.palette).getNamedColor(t,!0);void 0!==r&&(t="0x".concat(r.toString(16)))}else t="0x".concat(t.toString(16));if(e.endsWith(".template")&&(t=t.replace(/\\n/g,"\n")),void 0!==t&&n(t)!==t&&n(t)!==t>0)throw{message:"".concat(e,' must be a "').concat(ee()(h.a.get(Np.defaults,e)),'"')}}return t}},{key:"unquoteString",value:function(e){return K.unquoteString(e)}}]),e}());function Bp(e){if(e instanceof this.constructor)return e;this._values=e instanceof Array?e.slice(0):e?[e]:[]}Bp.prototype.append=function(e){var t=this._values;return t[t.length]=e,this},Bp.prototype.remove=function(e){var t=this._values,n=t.indexOf(e);return n>=0&&t.splice(n,1),this},Bp.prototype.toJSO=function(e,t,n){for(var r={},i=this._values,o=0,a=i.length;o<a;++o)h.a.set(r,i[o].id,e.propagateProp("".concat(zp(t),".").concat(n,".").concat(i[o].id),i[o].val));return r};var Up=Object.create({});Up.Arg=function(e,t){this.id=e,this.val=t},Up.ArgList=Bp,Up.miew=null,Up.echo=null,Up.representations=Vp,Up.utils=Fp,Up._=h.a,Up.CreateObjectPair=function(e,t){var n={};return n[e]=t,n},Up.keyRemap=zp,Up.Context=Ep.Context,Up.ClearContext=Ep.ClearContext,Up.NULL=Op,Up.notimplemented=function(){return this.NULL},gp.prototype.script=function(e,t,n){xp.parser.yy.miew=this,xp.parser.yy.echo=t,xp.parser.yy.error=n,void 0===this.cmdQueue&&(this.cmdQueue=[]),void 0===this.commandInAction&&(this.commandInAction=!1),this.cmdQueue=this.cmdQueue.concat(e.split("\n"))},gp.prototype.awaitWhileCMDisInProcess=function(){this.commandInAction=!0},gp.prototype.finishAwaitingCMDInProcess=function(){this.commandInAction=!1},gp.prototype.isScriptingCommandAvailable=function(){return void 0!==this.commandInAction&&!this.commandInAction&&void 0!==this.cmdQueue&&this.cmdQueue.length>0},gp.prototype.callNextCmd=function(){if(this.isScriptingCommandAvailable()){var e=this.cmdQueue.shift(),t={success:!1};try{xp.parser.parse(e),t.success=!0}catch(e){t.error=e.message,xp.parser.yy.error(t.error),this.finishAwaitingCMDInProcess()}return t}return""},xp.parser.yy=Up,xp.parser.yy.parseError=xp.parser.parseError;var Gp=gp,jp=(n("CE5c"),n("5fcn"),n("Jszv"),Gp.chem.selectors),Hp=Gp.io.parsers,Wp=Gp.gfx.Representation,Yp=Gp.modes,qp=Gp.colorers,Xp=Gp.palettes,$p=Gp.materials,Kp=Gp.settings,Zp=Gp.utils,Qp=Zp.createElement,Jp=Zp.hexColor;function em(e){return e instanceof Array&&(e=e[0]),e}function tm(e){var t=!1;return e._forEachComplexVisual((function(){t=!0})),t}function nm(e,t){var n=e._getComplexVisual();return n?n.getComplex().getNumAtomsBySelector(t):-1}function rm(e,t){h.a.forEach(o.a.parseHTML('<div id="miew-menu">\n  \x3c!-- Title bar --\x3e\n\n  <div class="titlebar" style="display: none">\n    <span data-field="title">3D Molecular Viewer</span>\n\n    <div class="btns-miew-titlebar btns-miew-titlebar-left btns-miew-titlebar-main-menu">\n      <button class="btn btn-default btn-titlebar" data-toggle="miew-main-menu" data-state="on" data-tooltip="tooltip" data-placement="bottom" title="Open menu">\n        <span class="glyphicon glyphicon-menu-hamburger"></span>\n      </button>\n\n      <button id="miew-terminal-btn" type="button" class="btn btn-default btn-titlebar" data-toggle="miew-terminal" data-state="on" data-tooltip="tooltip" data-placement="bottom" title="Terminal">\n        <span class="glyphicon glyphicon-menu-right"></span>\n      </button>\n    </div>\n    <div class="blog-nav btns-miew-titlebar btns-miew-titlebar-right btns-miew-titlebar-toolbar">\n\n      <button type="button" class="btn btn-default btn-titlebar blog-nav-item" data-toggle="toolbar" data-value="miew-menu-toolbar-mode"  data-tooltip="tooltip" data-placement="bottom" title="Display mode">\n        <span class="glyphicon glyphicon-picture"></span>\n      </button>\n\n      <button type="button" class="btn btn-default btn-titlebar blog-nav-item" data-toggle="toolbar" data-value="miew-menu-toolbar-colorer"  data-tooltip="tooltip" data-placement="bottom" title="Display color">\n        <span class="glyphicon glyphicon-tint"></span>\n      </button>\n\n      \x3c!-- button type="button" class="btn btn-default btn-titlebar blog-nav-item" data-toggle="toolbar" data-value="miew-menu-toolbar-resolution"  data-tooltip="tooltip" data-placement="bottom" title="Resolution">\n        <span class="glyphicon glyphicon-stats"></span>\n      </button --\x3e\n\n    </div>\n\n  </div>\n  <div class="toolbar container-fluid" data-toolbar-type="miew-menu-toolbar-mode" style="display: none">\n    <div class="pseudo-row">\n      <div class="row">\n        <h5 class="text-center">Display mode</h5>\n      </div>\n      <div class="row">\n\n      </div>\n    </div>\n  </div>\n  <div class="toolbar container-fluid" data-toolbar-type="miew-menu-toolbar-colorer" style="display: none">\n    <div class="pseudo-row">\n      <div class="row">\n        <h5 class="text-center">Display color</h5>\n      </div>\n      <div class="row">\n\n      </div>\n    </div>\n  </div>\n\n  \x3c!-- div class="toolbar container-fluid" data-toolbar-type="miew-menu-toolbar-resolution" style="display: none">\n    <div class="pseudo-row">\n      <div class="row">\n        <h5 class="text-center">Resolution</h5>\n      </div>\n      <div class="row">\n        <a href="#" class="thumbnail" data-toggle="resolution-immediate" data-value="poor">\n          <img src="images/resolution/poor.png">\n          <div class="caption text-center"><small>Poor</small></div>\n        </a>\n        <a href="#" class="thumbnail" data-toggle="resolution-immediate" data-value="low">\n          <img src="images/resolution/low.png">\n          <div class="caption text-center"><small>Low</small></div>\n        </a>\n        <a href="#" class="thumbnail" data-toggle="resolution-immediate" data-value="medium">\n          <img src="images/resolution/medium.png">\n          <div class="caption text-center"><small>Medium</small></div>\n        </a>\n        <a href="#" class="thumbnail" data-toggle="resolution-immediate" data-value="high">\n          <img src="images/resolution/high.png">\n          <div class="caption text-center"><small>High</small></div>\n        </a>\n        <a href="#" class="thumbnail" data-toggle="resolution-immediate" data-value="ultra">\n          <img src="images/resolution/ultra.png">\n          <div class="caption text-center"><small>Ultra</small></div>\n        </a>\n      </div>\n    </div>\n  </div --\x3e\n\n  <div class="container miew-terminal" style="display: none;">\n      <div class="row col-xs-12 col-sm-12 panel panel-default panel-menu panel-dark" data-panel-type="miew-menu-panel-terminal" style="background-color: transparent">\n        <div class="miew-terminal-body">\n          <div class="terminal-window"></div>\n        </div>\n      </div>\n  </div>\n\n  \x3c!-- Main menu --\x3e\n\n  <div class="container main-menu" style="display: none">\n    <div class="row">\n\n      \x3c!-- Left panel --\x3e\n\n      <div class="col-xs-12 col-sm-3 panel panel-default panel-menu panel-dark" data-panel-type="miew-menu-panel-main">\n        <div class="panel-heading">\n          <button class="btn btn-default btn-titlebar pull-left" data-toggle="miew-main-menu" data-state="off"><span class="glyphicon glyphicon-menu-hamburger"></span></button>\n          <h3 class="panel-title visible-xs">Menu</h3>\n        </div>\n        <div class="panel-body list-group">\n          <a href="#" class="list-group-item" data-toggle="panel" data-value="miew-menu-panel-info">\n            <span class="glyphicon glyphicon-info-sign"></span>&nbsp;\x3c!-- span class="glyphicon glyphicon-menu-right pull-right"></span --\x3e\n            Info</a>\n          <a href="#" class="list-group-item" data-toggle="panel" data-value="miew-menu-panel-presets">\n            <span class="glyphicon glyphicon-folder-open"></span>&nbsp;\x3c!-- span class="glyphicon glyphicon-menu-right pull-right"></span --\x3e\n            Load</a>\n          <a href="#" class="list-group-item" data-toggle="panel" data-value="miew-menu-panel-gallery">\n            <span class="glyphicon glyphicon-star"></span>&nbsp;\x3c!-- span class="glyphicon glyphicon-menu-right pull-right"></span --\x3e\n            Gallery</a>\n          <a href="#" class="list-group-item" data-toggle="panel" data-value="miew-menu-panel-representation">\n            <span class="glyphicon glyphicon-picture"></span>&nbsp;\x3c!-- span class="glyphicon glyphicon-menu-right pull-right"></span --\x3e\n            Representations</a>\n          <a href="#" class="list-group-item" data-toggle="panel" data-value="miew-menu-panel-render">\n            <span class="glyphicon glyphicon-eye-open"></span>&nbsp;\x3c!-- span class="glyphicon glyphicon-menu-right pull-right"></span --\x3e\n            Render settings</a>\n          <a href="#" class="list-group-item" data-toggle="panel" data-value="miew-menu-panel-tools">\n            <span class="glyphicon glyphicon-wrench"></span>&nbsp;\x3c!-- span class="glyphicon glyphicon-menu-right pull-right"></span --\x3e\n            Tools</a>\n          <a href="#" class="list-group-item" data-toggle="panel" data-value="miew-menu-panel-about">\n            <span class="glyphicon glyphicon-question-sign"></span>&nbsp;\x3c!-- span class="glyphicon glyphicon-menu-right pull-right"></span --\x3e\n            About</a>\n        </div>\n      </div>\n\n      \x3c!-- Info panel --\x3e\n\n      <div class="col-xs-12 col-sm-9 panel panel-default panel-menu" data-panel-type="miew-menu-panel-info">\n        <div class="panel-heading">\n          <button class="btn btn-default btn-titlebar pull-left visible-xs" data-toggle="main-panel" data-value="miew-menu-panel-main"><span class="glyphicon glyphicon-menu-left"></span></button>\n          <h3 class="panel-title">Info</h3>\n        </div>\n        <div class="panel-body"></div>\n      </div>\n\n      \x3c!-- Load panel --\x3e\n\n      <div class="col-xs-12 col-sm-9 panel panel-default panel-menu" data-panel-type="miew-menu-panel-presets" style="display: none">\n        <div class="panel-heading">\n          <button class="btn btn-default btn-titlebar pull-left main-back-button visible-xs" data-toggle="main-panel" data-value="miew-menu-panel-main"><span class="glyphicon glyphicon-menu-left"></span></button>\n          <h3 class="panel-title">Load</h3>\n        </div>\n        <div class="panel-body">\n          <div class="main">\n            <form data-form-type="miew-menu-form-load-pdb" style="margin-bottom:20px; " onsubmit="return false;">\n              <div class="form-group">\n                <label class="control-label">Data to load</label>\n                <div class="input-group" style="margin-bottom: 10px;">\n                  <input type="text" class="form-control presets-panel-action" placeholder="PDB ID or URL..." data-pdb-url-type="main" data-presets-panel-action="pdb-inputs-text" data-presets-panel-events="input,propertychange,paste,keyup">\n                  <span class="input-group-btn">\n                    <span class="btn btn-primary miew-panel-btn-tooltip"><span class="glyphicon glyphicon-folder-open"></span><input type="file" class="form-control presets-panel-action" data-pdb-url-type="main" data-presets-panel-action="pdb-inputs-file"  data-presets-panel-events="change"></span>\n                    <span data-btn-type="miew-menu-btn-browse-file" style="visibility:hidden;"><input type="file"></span>\n                  </span>\n                </div>\n                <div class="alert alert-warning" role="alert" data-pdb-url-type="main"></div>\n                <div class="alert alert-danger" role="alert" data-pdb-url-type="main"></div>\n              </div>\n              <div class="row">\n                <div class="col-sm-6 col-xs-6" style="padding:0px">\n                </div>\n                <div class="col-sm-6 col-xs-6" style="padding:0px">\n                  <span class="pull-right btn btn-danger presets-panel-action" data-tooltip="tooltip" data-presets-panel-action="pdb-inputs-clear" style="min-width: 150px; margin-left: 10px;">Cancel</span>\n                  <span class="pull-right btn btn-primary presets-panel-action" data-tooltip="tooltip" data-presets-panel-action="pdb-load" style="min-width: 150px; margin-left: 10px;">Load</span>\n                </div>\n              </div>\n            </form>\n\n            <form data-form-type="miew-menu-form-auto-preset">\n              <ul class="list-group">\n                <li class="list-group-item"><label>Automatic preset on load</label> <div class="pull-right">\n                  <input type="checkbox" data-dir="settings" data-toggle="autoPreset" data-size="mini" title="Automatic preset">\n                </div></li>\n              </ul>\n            </form>\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- Gallery panel --\x3e\n\n      <div class="col-xs-12 col-sm-9 panel panel-default panel-menu" data-panel-type="miew-menu-panel-gallery" style="display: none">\n        <div class="panel-heading">\n          <button class="btn btn-default btn-titlebar pull-left visible-xs" data-toggle="main-panel" data-value="miew-menu-panel-main"><span class="glyphicon glyphicon-menu-left"></span></button>\n          <h3 class="panel-title">Gallery</h3>\n        </div>\n        <div class="panel-body">\n          <div class="container-fluid">\n            <div class="row-fluid">\n              <div class="col-xs-6 col-sm-4" data-toggle="preset-pdb" data-value="pc:serotonin" data-query="p=small&mt=ME&v=1P1erPnlYqD3sL7u8kNxQPmZl0L4NUDlA0c6VPg%3D%3D">\n                <a href="#" class="thumbnail">\n                  <img src="images/serotonin.png">\n                  <div class="caption text-center">Serotonin</div>\n                </a>\n              </div>\n              <div class="col-xs-6 col-sm-4" data-toggle="preset-pdb" data-value="data/1CRN.pdb" data-query="p=macro">\n                <a href="#" class="thumbnail">\n                  <img src="images/1CRN.png">\n                  <div class="caption text-center">1CRN <small>(0.3k)</small></div>\n                </a>\n              </div>\n              <div class="col-xs-6 col-sm-4" data-toggle="preset-pdb" data-value="1AID" data-query="p=macro&m=CS&c=CH&r=1&s=hetatm+and+altloc+A&v=1XA99wmIQG8LRIls%2BLXGoPRDqTb%2BdvOC/PEyQPg%3D%3D">\n                <a href="#" class="thumbnail">\n                  <img src="images/1AID.png">\n                  <div class="caption text-center">1AID <small>(1.6k)</small></div>\n                </a>\n              </div>\n              <div class="col-xs-6 col-sm-4" data-toggle="preset-pdb" data-value="2BFU" data-query="p=macro&c=CH&r=2&s=all&m=CS&c=CH&mt=TR&v=1AAAAgAAAAIAAAACAAtq6O7plpT4VEF6%2B1/WQPQ%3D%3D">\n                <a href="#" class="thumbnail">\n                  <img src="images/2BFU.png">\n                  <div class="caption text-center">2BFU <small>(5.2k)</small></div>\n                </a>\n              </div>\n              <div class="col-xs-6 col-sm-4" data-toggle="preset-pdb" data-value="5B40" data-query="p=macro&r=2&s=nucleic&m=CS&c=SS&mt=TR&v=1EBjRwvhTz0CYbo7BE0KGPBxejb/3yk2//Wb1vg%3D%3D">\n                <a href="#" class="thumbnail">\n                  <img src="images/5B40.png">\n                  <div class="caption text-center">5B40 <small>(11.8k)</small></div>\n                </a>\n              </div>\n              <div class="col-xs-6 col-sm-4" data-toggle="preset-pdb" data-value="mmtf:4TNW" data-query="p=macro&c=SQ&v=1xQCuQgIrbUHD9arAmmsnPIj8NL/mF6u%2Bx26BPg%3D%3D">\n                <a href="#" class="thumbnail">\n                  <img src="images/4TNW.png">\n                  <div class="caption text-center">4TNW <small>(30.4k)</small></div>\n                </a>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- Representation panel --\x3e\n\n      <div class="col-xs-12 col-sm-9 panel panel-default panel-menu" data-panel-type="miew-menu-panel-representation" style="display: none">\n        <div class="panel-heading">\n          <button class="btn btn-default btn-titlebar pull-left visible-xs" data-toggle="main-panel" data-value="miew-menu-panel-main"><span class="glyphicon glyphicon-menu-left"></span></button>\n          <h3 class="panel-title">Representations</h3>\n        </div>\n        <div class="panel-body">\n          <div class="dropdown" id="miew-source-dropdown" style="margin-bottom: 0.5em; display: none">\n            <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">\n              <span class="glyphicon glyphicon-file"></span> <span id="miew-source-name">File</span>\n              <span class="caret"></span>\n            </button>\n            <ul class="dropdown-menu" id="miew-source-list">\n            </ul>\n          </div>\n\n          <div class="panel-group miew-repr-list" role="tablist" aria-multiselectable="true" style="padding-bottom: 5px; margin-bottom: 0;">\n\n          </div>\n\n          <div class="btn-group miew-repr-list-controls" role="group">\n            <a class="btn btn-primary" type="button" data-btn-type="miew-menu-btn-add-repr">\n              <span class="glyphicon glyphicon-plus"></span>\n              Add new representation\n            </a>\n            <a class="btn btn-default" type="button" data-btn-type="miew-menu-btn-del-repr">\n              <span class="glyphicon glyphicon-trash"></span>\n              Delete current representation\n            </a>\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- Render panel --\x3e\n\n      <div class="col-xs-12 col-sm-9 panel panel-default panel-menu" data-panel-type="miew-menu-panel-render" style="display: none">\n        <div class="panel-heading">\n          <button class="btn btn-default btn-titlebar pull-left visible-xs" data-toggle="main-panel" data-value="miew-menu-panel-main"><span class="glyphicon glyphicon-menu-left"></span></button>\n          <h3 class="panel-title">Render settings</h3>\n        </div>\n        <div class="panel-body">\n\n          <form data-form-type="miew-menu-form-render">\n\n            <ul class="list-group">\n              \x3c!-- Resolution --\x3e\n              <li class="list-group-item" data-toggle="combobox-panel" data-value="miew-menu-panel-resolution">Resolution\n              <span class="pull-right">\n                <span class="text-muted"></span>\n                <span class="glyphicon glyphicon-menu-right"></span>\n              </span>\n              </li>\n              \x3c!-- Resolution autodetection --\x3e\n              <li class="list-group-item"><label>Resolution autodetection</label> <span class="pull-right">\n                <input type="checkbox" data-dir="settings" data-toggle="autoResolution" data-size="mini" title="Resolution autodetection">\n              </span></li>\n              \x3c!-- Fog --\x3e\n              <li class="list-group-item"><label>Fog</label> <span class="pull-right">\n                <input type="checkbox" data-dir="settings" data-toggle="fog" data-size="mini" title="Fog">\n              </span></li>\n              \x3c!-- Axes --\x3e\n              <li class="list-group-item"><label>Axes</label> <div class="pull-right">\n                <input type="checkbox" data-dir="settings" data-toggle="axes" data-size="mini" title="Axes">\n              </div></li>\n              \x3c!-- FPS --\x3e\n              <li class="list-group-item"><label>FPS counter</label> <div class="pull-right">\n                <input type="checkbox" data-dir="settings" data-toggle="fps" data-size="mini" title="FPS counter">\n              </div></li>\n              \x3c!-- Palette --\x3e\n              <li class="list-group-item" data-toggle="combobox-panel" data-value="miew-menu-panel-palette">Palette\n              <span class="pull-right">\n                <span class="text-muted"></span>\n                <span class="glyphicon glyphicon-menu-right"></span>\n              </span>\n              </li>\n              \x3c!-- Background color --\x3e\n              <li class="list-group-item"><label>Background color</label> <div class="checkbox-background pull-right">\n                <input type="checkbox" data-dir="settings" data-toggle="bg.color" data-size="mini" data-on-text="Dark" data-off-text="Light" data-handle-width="46" data-label-width="0"  title="Background color">\n              </div></li>\n              \x3c!-- FXAA --\x3e\n              <li class="list-group-item"><label>FXAA</label> <span class="pull-right">\n                <input type="checkbox" data-dir="settings" data-toggle="fxaa" data-size="mini"  title="FXAA">\n              </span></li>\n              \x3c!-- Amient Occlusion --\x3e\n              <li class="list-group-item"><label>Ambient Occlusion</label> <span class="pull-right">\n                <input type="checkbox" data-dir="settings" data-toggle="ao" data-size="mini"  title="Ambient Occlusion">\n              </span></li>\n              \x3c!-- Shadow Map --\x3e\n              <li class="list-group-item"><label>Shadow Map</label> <span class="pull-right">\n                <input type="checkbox" data-dir="settings" data-toggle="shadow.on" data-size="mini"  title="ShadowMap">\n              </span></li>\n              \x3c!-- Clip plane --\x3e\n              <li class="list-group-item"><label>Clip Plane</label> <span class="pull-right">\n                <input type="checkbox" data-dir="settings" data-toggle="draft.clipPlane" data-size="mini" title="Clip Plane">\n              </span></li>\n              \x3c!-- Outline --\x3e\n              <li class="list-group-item"><label>Outline</label> <span class="pull-right">\n                <input type="checkbox" data-dir="settings" data-toggle="outline.on" data-size="mini"  title="Outline">\n              </span></li>\n\n            </ul>\n\n          </form>\n\n        </div>\n      </div>\n\n      \x3c!-- Tools panel --\x3e\n\n      <div class="col-xs-12 col-sm-9 panel panel-default panel-menu" data-panel-type="miew-menu-panel-tools" style="display: none">\n        <div class="panel-heading">\n          <button class="btn btn-default btn-titlebar pull-left visible-xs" data-toggle="main-panel" data-value="miew-menu-panel-main"><span class="glyphicon glyphicon-menu-left"></span></button>\n          <h3 class="panel-title">Tools</h3>\n        </div>\n        <div class="panel-body">\n          <div class="list-group">\n            <a href="#" class="list-group-item" data-toggle="miew-menu-tools" data-value="dssp"><span class="glyphicon glyphicon-sort"></span>&nbsp;\n              Assign secondary structure\n            </a>\n            <a href="#" class="list-group-item" data-toggle="miew-menu-tools" data-value="reset-view"><span class="glyphicon glyphicon-refresh"></span>&nbsp;\n              Reset view\n            </a>\n            <a href="#" class="list-group-item" data-toggle="miew-menu-tools" data-value="screenshot"><span class="glyphicon glyphicon-camera"></span>&nbsp;\n              Screenshot\n            </a>\n            <a href="#" class="list-group-item" data-toggle="miew-menu-tools" data-value="get-url"><span class="glyphicon glyphicon-link"></span>&nbsp;\n              Get URL\n            </a>\n            <a href="#" class="list-group-item" data-toggle="miew-menu-tools" data-value="get-script"><span class="glyphicon glyphicon-list-alt"></span>&nbsp;\n              Get script\n            </a>\n            <a href="#" class="list-group-item" data-toggle="miew-menu-tools" data-value="save-settings"><span class="glyphicon glyphicon-log-in"></span>&nbsp;\n              Save settings\n            </a>\n            <a href="#" class="list-group-item" data-toggle="miew-menu-tools" data-value="restore-settings"><span class="glyphicon glyphicon-log-out"></span>&nbsp;\n              Restore settings\n            </a>\n            <a href="#" class="list-group-item" data-toggle="miew-menu-tools" data-value="reset-settings"><span class="glyphicon glyphicon-refresh"></span>&nbsp;\n              Reset settings\n            </a>\n            <a href="#" class="list-group-item" data-toggle="miew-menu-tools" data-value="fbx-export" style="display: block"><span class="glyphicon glyphicon-floppy-save"></span>&nbsp;\n              Export FBX\n            </a>\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- About panel --\x3e\n\n      <div class="col-xs-12 col-sm-9 panel panel-default panel-menu" data-panel-type="miew-menu-panel-about" style="display: none">\n        <div class="panel-heading">\n          <button class="btn btn-default btn-titlebar pull-left visible-xs" data-toggle="main-panel" data-value="miew-menu-panel-main"><span class="glyphicon glyphicon-menu-left"></span></button>\n          <h3 class="panel-title">About</h3>\n        </div>\n        <div class="panel-body">\n          <div style="left: 0;top: 40px;position: absolute;">\n            <a href="https://github.com/epam/miew">\n              <img style="position: absolute; top: 0; left: 0; border: 0;" src="https://camo.githubusercontent.com/82b228a3648bf44fc1163ef44c62fcc60081495e/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f7265645f6161303030302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_left_red_aa0000.png">\n            </a>\n          </div>\n          <div class="text-center">\n            <img src="images/logo.svg">\n            <h3 class="text-center" style="max-width:35ex;margin:20px auto 10px">\n              <span style="white-space:nowrap;">Miew &ndash; 3D Molecular Viewer</span>\n              <small class="PACKAGE_VERSION" style="white-space:nowrap;"></small>\n            </h3>\n\n            <p>Copyright  20152020 EPAM Systems, Inc.</p>\n            <p><a href="https://epa.ms/miew">https://epa.ms/miew</a></p>\n          </div>\n          <hr>\n          <h2>Keyboard and mouse shortcuts</h2>\n          <div>\n            <table class="table">\n            <thead>\n              <tr><th>Key</th><th>Action</th></tr>\n            </thead>\n            <tbody>\n              <tr><td colspan="2"><b>Camera and object controls</b></td></tr>\n              <tr><td><kbd>LMB</kbd></td><td>Click to select object part</td></tr>\n              <tr><td>&nbsp;</td><td>Double click to change object rotation center</td></tr>\n              <tr><td>&nbsp;</td><td>Drag to rotate object in 3D</td></tr>\n              <tr><td><kbd>Shift</kbd> + <kbd>LMB</kbd></td><td>Drag to rotate object in Z plane</td></tr>\n              <tr><td><kbd>Mouse Wheel</kbd></td><td>Scale object</td></tr>\n              <tr><td><kbd>RMB</kbd></td><td>Drag to shift molecule</td></tr>\n\n              <tr><td colspan="2"><b>Component / fragment edit mode</b></td></tr>\n              <tr><td><kbd>C</kbd> / <kbd>F</kbd></td><td>Enter the component or fragment edit mode</td></tr>\n              <tr><td><kbd>A</kbd> / <kbd>D</kbd></td><td>Apply or discard changes</td></tr>\n              <tr><td><kbd>Alt</kbd> + <kbd>LMB</kbd></td><td>Drag to rotate component / fragment in 3D</td></tr>\n              <tr><td><kbd>Alt</kbd> + <kbd>Shift</kbd> + <kbd>LMB</kbd></td><td>Drag to rotate component / fragment in Z plane</td></tr>\n              <tr><td><kbd>Alt</kbd> + <kbd>Ctrl</kbd> + <kbd>LMB</kbd></td><td>Drag to translate component in Z plane</td></tr>\n\n              <tr><td colspan="2"><b>Other</b></td></tr>\n              <tr><td><kbd>X</kbd></td><td>Extract selection as a new representation</td></tr>\n            </tbody>\n            </table>\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- Mode panel --\x3e\n\n      <div class="col-xs-12 col-sm-9 panel panel-default panel-menu" data-panel-type="miew-menu-panel-mode" style="display: none">\n        <div class="panel-heading">\n          <button class="btn btn-default btn-titlebar pull-left" data-toggle="panel" data-value="miew-menu-panel-representation"><span class="glyphicon glyphicon-menu-left"></span></button>\n          <h3 class="panel-title">Display mode</h3>\n        </div>\n        <div class="panel-body">\n          <div class="list-group">\n\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- Color panel --\x3e\n\n      <div class="col-xs-12 col-sm-9 panel panel-default panel-menu" data-panel-type="miew-menu-panel-color" style="display: none">\n        <div class="panel-heading">\n          <button class="btn btn-default btn-titlebar pull-left" data-toggle="panel" data-value="miew-menu-panel-representation"><span class="glyphicon glyphicon-menu-left"></span></button>\n          <h3 class="panel-title">Display color</h3>\n        </div>\n        <div class="panel-body">\n          <div class="list-group">\n\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- Palette panel --\x3e\n\n      <div class="col-xs-12 col-sm-9 panel panel-default panel-menu" data-panel-type="miew-menu-panel-palette" style="display: none">\n        <div class="panel-heading">\n          <button class="btn btn-default btn-titlebar pull-left" data-toggle="panel" data-value="miew-menu-panel-render"><span class="glyphicon glyphicon-menu-left"></span></button>\n          <h3 class="panel-title">Display palette</h3>\n        </div>\n        <div class="panel-body">\n          <div class="list-group">\n\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- Material presets panel --\x3e\n\n      <div class="col-xs-12 col-sm-9 panel panel-default panel-menu" data-panel-type="miew-menu-panel-matpreset" style="display: none">\n        <div class="panel-heading">\n          <button class="btn btn-default btn-titlebar pull-left" data-toggle="panel" data-value="miew-menu-panel-representation"><span class="glyphicon glyphicon-menu-left"></span></button>\n          <h3 class="panel-title">Material</h3>\n        </div>\n        <div class="panel-body">\n          <div class="list-group">\n\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- Color panel --\x3e\n\n      <div class="col-xs-12 col-sm-9 panel panel-default panel-menu" data-panel-type="miew-menu-panel-select-color" style="display: none">\n        <div class="panel-heading">\n          <button class="btn btn-default btn-titlebar pull-left" data-toggle="panel" data-value="miew-menu-panel-representation"><span class="glyphicon glyphicon-menu-left"></span></button>\n          <h3 class="panel-title">Choose color</h3>\n        </div>\n        <div class="panel-body">\n          <div class="row">\n\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- Resolution panel --\x3e\n\n      <div class="col-xs-12 col-sm-9 panel panel-default panel-menu" data-panel-type="miew-menu-panel-resolution" style="display: none">\n        <div class="panel-heading">\n          <button class="btn btn-default btn-titlebar pull-left" data-toggle="panel" data-value="miew-menu-panel-render"><span class="glyphicon glyphicon-menu-left"></span></button>\n          <h3 class="panel-title">Render resolution</h3>\n        </div>\n        <div class="panel-body">\n          <div class="list-group">\n            <a href="#" class="list-group-item" data-toggle="resolution" data-value="poor">Poor</a>\n            <a href="#" class="list-group-item" data-toggle="resolution" data-value="low">Low</a>\n            <a href="#" class="list-group-item" data-toggle="resolution" data-value="medium">Medium</a>\n            <a href="#" class="list-group-item" data-toggle="resolution" data-value="high">High</a>\n            <a href="#" class="list-group-item" data-toggle="resolution" data-value="ultra">Ultra</a>\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- Selection panel --\x3e\n\n      <div class="col-xs-12 col-sm-9 panel panel-default panel-menu" data-panel-type="miew-menu-panel-selection" style="display: none">\n        <div class="panel-heading">\n          <button class="btn btn-default btn-titlebar pull-left" data-toggle="panel" data-value="miew-menu-panel-representation"><span class="glyphicon glyphicon-menu-left"></span></button>\n          <h3 class="panel-title">Selection</h3>\n        </div>\n        <div class="panel-body">\n            <div class="form-group">\n              <label>Selection string</label>\n              <div class="input-group">\n                <input type="text" class="form-control">\n                <span class="input-group-btn"><button class="btn btn-primary" type="button" data-btn-type="miew-menu-btn-apply-sel">Apply</button></span>\n              </div>\n              <span class="help-block">For example:\n                "<a href="#">all</a>",\n                "<a href="#">not hetatm</a>",\n                "<a href="#">hetatm and not water</a>",\n                "<a href="#">residue ALA, CYS</a>",\n                "<a href="#">serial 1:10, 20:30 and elem C,N</a>".\n                </span>\n            </div>\n            <div class="alert alert-danger" style="display:none; font-family: \'Anonymous Pro\',\'Consolas\',\'Courier New\',Courier,monospace; white-space: pre"></div>\n\n          <div class="row">\n            <div class="col-xs-6 col-sm-6 column">\n              <ul class="nav nav-tabs">\n                <li class="active"><a data-toggle="tab" href="[data-tab-content=singleword]">Single</a></li>\n                <li><a data-toggle="tab" href="[data-tab-content=keyword]">Key</a></li>\n                <li><a data-toggle="tab" href="[data-tab-content=value]">Value</a></li>\n              </ul>\n\n              <div class="tab-content">\n                <div data-tab-content="singleword" class="tab-pane fade in active">\n                  <div class="list-group">\n\n                  </div>\n                </div>\n                <div data-tab-content="keyword" class="tab-pane fade">\n                  <div class="list-group">\n\n                  </div>\n                </div>\n                <div data-tab-content="value" class="tab-pane fade">\n                  <div class="list-group">\n\n                  </div>\n                </div>\n              </div>\n            </div>\n            <div class="col-xs-6 col-sm-6 column calc">\n              <a class="col-xs-6 btn btn-default btn-calc" data-toggle="selection-input" data-value=" ">SPACE</a>\n              <a class="col-xs-3 btn btn-default btn-calc delete" data-delete-type="clear">CLEAR</a>\n              <a class="col-xs-3 btn btn-default btn-calc delete" data-delete-type="backspace"><span class="glyphicon glyphicon-arrow-left"></span></a>\n              <a class="col-xs-3 btn btn-default btn-calc" data-toggle="selection-input" data-value="and ">and</a>\n              <a class="col-xs-3 btn btn-default btn-calc" data-toggle="selection-input" data-value="or ">or</a>\n              <a class="col-xs-3 btn btn-default btn-calc" data-toggle="selection-input" data-value="not ">not</a>\n              <a class="col-xs-3 btn btn-default btn-calc char" data-toggle="selection-input" data-value="A">A</a>\n              <a class="col-xs-3 btn btn-default btn-calc digit" data-toggle="selection-input" data-value="7">7</a>\n              <a class="col-xs-3 btn btn-default btn-calc digit" data-toggle="selection-input" data-value="8">8</a>\n              <a class="col-xs-3 btn btn-default btn-calc digit" data-toggle="selection-input" data-value="9">9</a>\n              <a class="col-xs-3 btn btn-default btn-calc char" data-toggle="selection-input" data-value="B">B</a>\n              <a class="col-xs-3 btn btn-default btn-calc digit" data-toggle="selection-input" data-value="4">4</a>\n              <a class="col-xs-3 btn btn-default btn-calc digit" data-toggle="selection-input" data-value="5">5</a>\n              <a class="col-xs-3 btn btn-default btn-calc digit" data-toggle="selection-input" data-value="6">6</a>\n              <a class="col-xs-3 btn btn-default btn-calc char" data-toggle="selection-input" data-value="C">C</a>\n              <a class="col-xs-3 btn btn-default btn-calc digit" data-toggle="selection-input" data-value="1">1</a>\n              <a class="col-xs-3 btn btn-default btn-calc digit" data-toggle="selection-input" data-value="2">2</a>\n              <a class="col-xs-3 btn btn-default btn-calc digit" data-toggle="selection-input" data-value="3">3</a>\n              <a class="col-xs-3 btn btn-default btn-calc char" data-toggle="selection-input" data-value="D">D</a>\n              <a class="col-xs-3 btn btn-default btn-calc digit" data-toggle="selection-input" data-value="0">0</a>\n              <a class="col-xs-3 btn btn-default btn-calc" data-toggle="selection-input" data-value="(">(</a>\n              <a class="col-xs-3 btn btn-default btn-calc" data-toggle="selection-input" data-value=")">)</a>\n              <a class="col-xs-3 btn btn-default btn-calc char" data-toggle="selection-input" data-value="H">H</a>\n              <a class="col-xs-3 btn btn-default btn-calc" data-toggle="selection-input" data-value=",">,</a>\n              <a class="col-xs-3 btn btn-default btn-calc" data-toggle="selection-input" data-value=":">:</a>\n              <a class="col-xs-3 btn btn-default btn-calc" data-toggle="selection-input" data-value="&#34;">"</a>\n              <a class="col-xs-3 btn btn-default btn-calc char" data-toggle="selection-input" data-value="O">O</a>\n          </div>\n          </div>\n          <div></div>\n        </div>\n      </div>\n\n    </div>\n\n    \x3c!--Tooltips panel container--\x3e\n    <div class="miew-menu-panel-tooltips">\n    </div>\n  </div>\n\n  \x3c!-- Modals --\x3e\n  <div class="miew-menu-modals">\n    \x3c!-- URL Modal --\x3e\n    <div class="modal fade" data-modal-type="miew-menu-modal-url" tabindex="-1" role="dialog">\n      <div class="modal-dialog modal-lg" role="document">\n        <div class="modal-content">\n          <div class="modal-header">\n            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>\n            <h4 class="modal-title">Url</h4>\n          </div>\n          <div class="modal-body">\n\n          </div>\n          <div class="modal-footer">\n            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>\n          </div>\n        </div>\n      </div>\n    </div>\n\n    \x3c!-- Script modal --\x3e\n    <div class="modal fade" data-modal-type="miew-menu-modal-script" tabindex="-1" role="dialog">\n      <div class="modal-dialog modal-lg" role="document">\n        <div class="modal-content">\n          <div class="modal-header">\n            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>\n            <h4 class="modal-title">Script</h4>\n          </div>\n          <div class="modal-body">\n          </div>\n          <div class="modal-footer">\n            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>\n          </div>\n        </div>\n      </div>\n    </div>\n\n    <div class="modal fade" data-modal-type="miew-menu-modal-global-error" tabindex="-1" role="dialog">\n      <div class="modal-dialog modal-lg" role="document">\n        <div class="modal-content">\n          <div class="modal-header">\n            <h4 class="modal-title"></h4>\n          </div>\n          <div class="modal-body">\n          </div>\n          <div class="modal-footer">\n            <button type="button" class="btn btn-default" data-dismiss="modal">OK</button>\n          </div>\n        </div>\n      </div>\n    </div>\n\n  </div>\n</div>\n'),(function(t){return e.parentNode.appendChild(t)})),this._viewer=t,this._menuId="#miew-menu",this._titlebar=o()("".concat(this._menuId," .titlebar")),this._menu=o()("".concat(this._menuId," .main-menu")),this._curPanelID="miew-menu-panel-info",this._curMenuItem="miew-menu-panel-info",this._xs=!1,this._curReprIdx=0,this._menu.find(".PACKAGE_VERSION").text(Gp.VERSION),this._singleWordsPrimary=["all","none","water","hetatm","protein","basic","acidic","charged","polar","nonpolar","aromatic","nucleic","purine","pyrimidine","polarh","nonpolarh"],this._singleWords=["all","none","water","hetatm","protein","basic","acidic","charged","polar","nonpolar","aromatic","nucleic","purine","pyrimidine","polarh","nonpolarh"],this._keyWordsPrimary=["serial","name","elem","residue","sequence","chain","altloc"],this._init(),this._initializeTerminal()}rm.prototype._initializeTerminal=function(){var e=this,t=this,n=null,r="",i=o()("#miew-menu [data-btn-type=miew-menu-btn-browse-file] input");i.change((function(){if(o()(i).val()){var e,a=o()(i)[0].files;if(a.length>0)null!==n&&(e={mdFile:n[1]}),t._viewer.load(a[0],e)}r="",o()(i).val("")})),this._terminal=o()("".concat(this._menuId," .miew-terminal")),this._terminalWindow=this._terminal.find(".terminal-window"),this._terminalWindow.on("click",(function(){return e._hideToolbarPanel()})),this._term=this._terminalWindow.terminal((function(e,o){if(t._viewer){var a=(e=e.trim()).split(/\s+/);"load"===a[0]&&"-f"===a[1]?(r=e.substr(e.indexOf("-f")+2),n=r.match(/(?:"([^"]*)"|'([^']*)')/),""!==r?null!==n&&n[0]===r.trim()&&n[1].indexOf(".nc")===n[1].length-3?i.click():o.error("You can use only URL string to *.nc file to determine trajectory"):(n=null,i.click())):t._viewer.script(e,(function(e){o.echo(e)}),(function(e){o.error(e)}))}else o.error("Miew is not initialized.")}),{greetings:"Miew - 3D Molecular Viewer\nCopyright  2015-2020 EPAM Systems, Inc.\n",prompt:"miew> ",name:"miew",scrollOnEcho:!0,height:"100%",keydown:function(e,t){if(192===e.keyCode)return!1},onInit:function(e){if(t._viewer){var n={error:"#f00",warn:"#990",report:"#1a9cb0"};t._viewer.logger.addEventListener("message",(function(t){var r=t.message.replace("[","(").replace("]",")");e.echo("[[b;".concat(n[t.level]||"#666",";]").concat(r,"]"))}))}}})},rm.prototype._fillSelectionColorCombo=function(e){for(var t=this,n=document.createDocumentFragment(),r=(Xp.get(e)||Xp.first).namedColorsArray,i=o()("".concat(t._menuId," [data-panel-type=miew-menu-panel-select-color]")),a=0,s=r.length;a<s;a++){var l=Jp(r[a][1]),c=Qp("div",{class:"col-xs-2 col-sm-2","data-toggle":"selectcolor","data-value":l},[Qp("a",{href:"#",class:"thumbnail",style:"text-align:center;"},Qp("img",{src:"images/empty_icon.png",style:"background-color: ".concat(l,";"),"data-tooltip":"tooltip","data-placement":"bottom",title:r[a][0]}))]);n.appendChild(c)}o()(i.get(0).lastElementChild.firstElementChild).empty(),i.get(0).lastElementChild.firstElementChild.appendChild(n),o()("".concat(t._menuId," [data-toggle=selectcolor]")).on("click",(function(){var e=t._getCurReprPropertyId("miew-menu-panel-select-color");o()("".concat(t._menuId,' [data-value="').concat(e,'"]')).removeClass("active"),i.get(0).firstElementChild.firstElementChild.click();var n=o()("".concat(t._menuId," [data-panel-type=miew-menu-panel-representation] .miew-repr-list ")+".panel.valid:eq(".concat(t._curReprIdx,") [data-value=miew-menu-panel-select-color]")),r=this.getAttribute("data-value");n[0].lastChild.firstElementChild.setAttribute("data-id",r),n[0].lastChild.firstElementChild.firstElementChild.style.backgroundColor=r})),i.find(".panel-heading:first-of-type button:first-of-type").on("click",(function(){var e=t._getCurReprPropertyId("miew-menu-panel-select-color");o()("".concat(t._menuId,' [data-toggle=selectcolor][data-value="').concat(e,'"]')).removeClass("active")}))},rm.prototype._fillCombo=function(e,t,n,r){for(var i,a=this,s=document.createDocumentFragment(),l=o()("".concat(a._menuId," [data-panel-type=").concat(e,"]")).get(0),c=r.all,u=0,h=c.length;u<h;u++){var d=c[u];d=d.prototype||d,i=Qp("a",{href:"#",class:"list-group-item","data-toggle":t,"data-value":d.id},[Qp("div",{class:"media-left"},Qp("img",{class:"media-object",src:"images/".concat(t,"/").concat(d.id,".png"),width:"48",height:"48"})),Qp("div",{class:"media-body media-middle"},d.name)]),s.appendChild(i)}l.lastElementChild.firstElementChild.appendChild(s),o()("".concat(a._menuId," [data-toggle=").concat(t,"]")).on("click",(function(){var t,r=this.getAttribute("data-value");"miew-menu-panel-palette"===e?(t=Kp.get(n),Kp.set(n,r)):t=a._getCurReprPropertyId(e),o()("".concat(a._menuId,' [data-value="').concat(t,'"]')).removeClass("active"),l.firstElementChild.firstElementChild.click()})),o()("".concat(a._menuId,' [data-toggle=combobox-panel][data-value="').concat(e,'"]')).on("click",(function(){var t;t="miew-menu-panel-palette"===e?Kp.get(n):a._getCurReprPropertyId(e),o()("".concat(a._menuId,' a[data-value="').concat(t,'"]')).addClass("active")})),o()("".concat(a._menuId," [data-panel-type=").concat(e,"] .panel-heading:first-of-type button:first-of-type")).on("click",(function(){var t;t="miew-menu-panel-palette"===e?Kp.get(n):a._getCurReprPropertyId(e),o()("".concat(a._menuId,' a[data-value="').concat(t,'"]')).removeClass("active")}))},rm.prototype._initReprListItemListeners=function(e){var t=this,n=o()("".concat(t._menuId," [data-panel-type=miew-menu-panel-representation] .miew-repr-list"));n.find(".panel:eq(".concat(e,") .panel-heading")).on("click",(function(e){var r=n.find(".panel.valid").index(o()(e.currentTarget).parent()),i=n.find(".panel.valid:eq(".concat(r,") .panel-heading .btn span"));if(e.target!==i[0]&&e.target!==i[1]){var a=n.find(".panel.valid:eq(".concat(t._curReprIdx,") .panel-heading"));a.removeClass("active"),(a=n.find(".panel.valid:eq(".concat(t._curReprIdx,") .panel-collapse"))).collapse("hide"),t._curReprIdx=r,(a=n.find(".panel.valid:eq(".concat(t._curReprIdx,") .panel-heading"))).addClass("active"),n.find(".panel.valid:eq(".concat(t._curReprIdx,") .panel-collapse")).collapse("show")}})),n.find(".panel:eq(".concat(e,") input[type=checkbox]")).bootstrapSwitch(),n.find(".panel:eq(".concat(e,") .panel-heading .btn-visible")).on("click",(function(){n.find(".panel:eq(".concat(e,") .panel-heading .btn-visible")).hide(),n.find(".panel:eq(".concat(e,") .panel-heading .btn-invisible")).show()})),n.find(".panel:eq(".concat(e,") .panel-heading .btn-invisible")).on("click",(function(){n.find(".panel:eq(".concat(e,") .panel-heading .btn-invisible")).hide(),n.find(".panel:eq(".concat(e,") .panel-heading .btn-visible")).show()})),n.find(".panel:eq(".concat(e,') [data-toggle="combobox-panel"]')).on("click",(function(){return t._getPanelSelector(t._curPanelID).hide(),t._curPanelID=this.getAttribute("data-value"),t._getPanelSelector(t._curPanelID).show(),!1})),n.find(" .panel:eq(".concat(e,") input[type=number]")).on("input",(function(e){var t=o()(e.currentTarget);parseFloat(t.attr("min"))>parseFloat(t.val())&&(t.val(parseFloat(t.attr("min"))),t.change()),parseFloat(t.attr("max"))<parseFloat(t.val())&&(t.val(parseFloat(t.attr("max"))),t.change())})),n.find(".panel:eq(".concat(e,") .spinner-dec-btn")).on("click",(function(t){var r=t.currentTarget.getAttribute("data-value"),i=n.find(".panel:eq(".concat(e,") [data-type=").concat(r,"]"));parseFloat(i.attr("min"))<parseFloat(i.val())&&(i.val((10*i.val()-10*i.attr("step"))/10),i.change())})),n.find(".panel:eq(".concat(e,") .spinner-inc-btn")).on("click",(function(t){var r=t.currentTarget.getAttribute("data-value"),i=n.find(".panel:eq(".concat(e,") [data-type=").concat(r,"]"));parseFloat(i.attr("max"))>parseFloat(i.val())&&(i.val((10*i.val()+10*i.attr("step"))/10),i.change())})),n.find(".panel:eq(".concat(e,") [data-toggle=combobox-panel][data-value=miew-menu-panel-mode]")).on("click",(function(){var e=this.firstElementChild.firstElementChild.getAttribute("data-id");o()("".concat(t._menuId,' a[data-value="').concat(e,'"][data-toggle=mode]')).addClass("active")})),n.find(".panel:eq(".concat(e,") [data-toggle=combobox-panel][data-value=miew-menu-panel-color]")).on("click",(function(){var e=this.firstElementChild.firstElementChild.getAttribute("data-id");o()("".concat(t._menuId,' a[data-value="').concat(e,'"][data-toggle=colorer]')).addClass("active")})),n.find(".panel:eq(".concat(e,") [data-toggle=combobox-panel][data-value=miew-menu-panel-matpreset]")).on("click",(function(){var e=this.firstElementChild.firstElementChild.getAttribute("data-id");o()("".concat(t._menuId,' a[data-value="').concat(e,'"]')).addClass("active")})),n.find(".panel:eq(".concat(e,") [data-toggle=combobox-panel][data-value=miew-menu-panel-select-color]")).on("click",(function(){var e=this.lastChild.firstElementChild.getAttribute("data-id");o()("".concat(t._menuId,' [data-toggle=selectcolor][data-value="').concat(e,'"]')).addClass("active")})),n.find(".panel:eq(".concat(e,") [data-toggle=combobox-panel][data-value=miew-menu-panel-selection]")).on("click",(function(){var e=n.find(".panel.valid:eq(".concat(t._curReprIdx,") [data-value=miew-menu-panel-selection]")),r=o()("".concat(t._menuId," [data-panel-type=miew-menu-panel-selection]"));r.find("input").val("".concat(e[0].firstElementChild.firstElementChild.textContent," ")),r.find('.nav-tabs a[href="[data-tab-content=singleword]"]').tab("show"),t._onSelectorChanged(r)}))},rm.prototype._addReprListItem=function(e,t,n){var r=o()("".concat(this._menuId," [data-panel-type=miew-menu-panel-representation] .miew-repr-list")),i=r.find(".panel.valid").length,a=Qp("div",{class:"panel panel-default valid"},[Qp("div",{class:"panel-heading",role:"tab"},Qp("h4",{class:"panel-title"},[Qp("button",{class:"btn btn-default btn-invisible"},Qp("span",{class:"glyphicon glyphicon-unchecked"})),Qp("button",{class:"btn btn-default btn-visible"},Qp("span",{class:"glyphicon glyphicon-check"})),Qp("a",{role:"button","data-toggle":"collapse","data-parent":".panel-menu[data-panel-type=miew-menu-panel-representation] .miew-repr-list",href:"#repr".concat(t+1),"aria-expanded":"true","aria-controls":"[data-number=repr-".concat(String(t+1),"]")},"#".concat(String(i+1),": ").concat(n.mode.name)),Qp("div",{class:"pseudo-div"},Qp("span",{class:"pull-right badge"},String(tm(this._viewer)?nm(this._viewer,n.selector):"0")))])),Qp("div",{"data-number":"repr-".concat(String(t+1)),class:"panel-collapse collapse",role:"tabpanel","aria-labelledby":"head-repr-".concat(String(t+1))},Qp("ul",{class:"list-group row"},[Qp("li",{class:"list-group-item col-xs-12 col-sm-12","data-toggle":"combobox-panel","data-value":"miew-menu-panel-selection"},["Selection",Qp("span",{class:"pull-right"},[Qp("label",{class:"text-muted","data-type":"selection-target",style:"word-break: break-all"},String(n.selector)),Qp("span",{class:"glyphicon glyphicon-menu-right"})])]),Qp("li",{class:"list-group-item col-xs-12 col-sm-12","data-toggle":"combobox-panel","data-value":"miew-menu-panel-mode"},["Mode",Qp("span",{class:"pull-right"},[Qp("span",{class:"text-muted","data-id":n.mode.id},n.mode.shortName),Qp("span",{class:"glyphicon glyphicon-menu-right"})])]),Qp("li",{class:"list-group-item col-xs-12 col-sm-12","data-toggle":"combobox-panel","data-value":"miew-menu-panel-color"},["Color",Qp("span",{class:"pull-right"},[Qp("span",{class:"text-muted","data-id":n.colorer.id},n.colorer.shortName),Qp("span",{class:"glyphicon glyphicon-menu-right"})])]),Qp("li",{class:"list-group-item col-xs-12 col-sm-12","data-toggle":"combobox-panel","data-value":"miew-menu-panel-select-color"},[Qp("span",{},"Color name"),Qp("span",{class:"pull-right"},[Qp("a",{href:"#ucolor",class:"thumbnail","data-id":Jp(16777215)},Qp("img",{src:"images/empty_icon.png",style:"background-color: ".concat(Jp(16777215),";")})),Qp("span",{class:"glyphicon glyphicon-menu-right"})])]),Qp("li",{class:"list-group-item col-xs-12 col-sm-12","data-toggle":"combobox-panel","data-value":"miew-menu-panel-matpreset"},["Material",Qp("span",{class:"pull-right"},[Qp("span",{class:"text-muted","data-id":n.materialPreset.id},n.materialPreset.shortName),Qp("span",{class:"glyphicon glyphicon-menu-right"})])]),Qp("li",{class:"list-group-item col-xs-12 col-sm-12","data-type":"surf-param-rad"},["Radius scale",Qp("span",{class:"input-group pull-right"},[Qp("span",{class:"input-group-addon spinner-dec-btn","data-toggle":"spinner","data-value":"rad"},Qp("span",{class:"glyphicon glyphicon-minus"})),Qp("input",{type:"number",class:"form-control","data-type":"rad",value:"1.0",min:"0",max:"2",step:"0.1"}),Qp("span",{class:"input-group-addon spinner-inc-btn","data-toggle":"spinner","data-value":"rad"},Qp("span",{class:"glyphicon glyphicon-plus"}))])]),Qp("li",{class:"list-group-item col-xs-12 col-sm-12","data-type":"surf-param-iso"},["Isosurface threshold",Qp("span",{class:"input-group pull-right"},[Qp("span",{class:"input-group-addon spinner-dec-btn","data-toggle":"spinner","data-value":"iso"},Qp("span",{class:"glyphicon glyphicon-minus"})),Qp("input",{type:"number",class:"form-control","data-type":"iso",value:"0.5",min:"0",max:"10",step:"0.5"}),Qp("span",{class:"input-group-addon spinner-inc-btn","data-toggle":"spinner","data-value":"iso"},Qp("span",{class:"glyphicon glyphicon-plus"}))])]),Qp("li",{class:"list-group-item col-xs-12 col-sm-12","data-type":"surf-param-zclip"},[Qp("label",{},"Z clipping"),Qp("span",{class:"pull-right"},Qp("input",{type:"checkbox","data-dir":"representation","data-toggle":"zClip","data-size":"mini",title:"Z clipping"}))])]))]);if(e.appendChild(a),"SA"===n.mode.id||"SE"===n.mode.id||"QS"===n.mode.id||"CS"===n.mode.id?r.find(".panel:eq(".concat(t,") .panel-collapse [data-type=surf-param-zclip]")).show():r.find(".panel:eq(".concat(t,") .panel-collapse [data-type=surf-param-zclip]")).hide(),"QS"===n.mode.id?r.find(".panel:eq(".concat(t,") .panel-collapse [data-type=surf-param-rad]")).show():r.find(".panel:eq(".concat(t,") .panel-collapse [data-type=surf-param-rad]")).hide(),"QS"===n.mode.id||"CS"===n.mode.id?r.find(".panel:eq(".concat(t,") .panel-collapse [data-type=surf-param-iso]")).show():r.find(".panel:eq(".concat(t,") .panel-collapse [data-type=surf-param-iso]")).hide(),"UN"===n.colorer.id||"CB"===n.colorer.id){var s=r.find(".panel:eq(".concat(t,") [data-value=miew-menu-panel-select-color]")),l=Jp(n.colorer.opts.color);s[0].firstElementChild.innerHTML="".concat(n.colorer.name," color"),s[0].lastChild.firstElementChild.setAttribute("data-id",l),s[0].lastChild.firstElementChild.firstElementChild.style.backgroundColor=l,s.show()}else r.find(".panel:eq(".concat(t,") [data-value=miew-menu-panel-select-color]")).hide();r.find(".panel:eq(".concat(t,") input[type=checkbox]")).bootstrapSwitch("state",n.mode.opts.zClip),r.find(".panel:eq(".concat(t,") [data-type=rad]")).val(n.mode.opts.scale),r.find(".panel:eq(".concat(t,") [data-type=iso]")).val(n.mode.opts.isoValue);var c=r.find(".panel:eq(".concat(t,") [data-value=miew-menu-panel-mode]"));c.removeData("mvdata"),c.data("mvdata",n.mode.opts);var u=r.find(".panel:eq(".concat(t,") [data-value=miew-menu-panel-color]"));u.removeData("mvdata"),u.data("mvdata",n.colorer.opts),"SA"!==n.mode.id&&"SE"!==n.mode.id||r.find(".panel:eq(".concat(t,") [data-type=rad]")).val(n.mode._radScale),n.visible?(r.find(".panel:eq(".concat(t,") .panel-heading .btn-visible")).show(),r.find(".panel:eq(".concat(t,") .panel-heading .btn-invisible")).hide()):(r.find(".panel:eq(".concat(t,") .panel-heading .btn-visible")).hide(),r.find(".panel:eq(".concat(t,") .panel-heading .btn-invisible")).show()),this._initReprListItemListeners(t)},rm.prototype._getCurReprPropertyId=function(e){return o()("".concat(this._menuId," .panel-menu[data-panel-type=miew-menu-panel-representation] .miew-repr-list")).find(".panel.valid:eq(".concat(this._curReprIdx,') [data-value="').concat(e,'"]'))[0].lastChild.firstElementChild.getAttribute("data-id")},rm.prototype._getCurReprSelector=function(){return o()("".concat(this._menuId," .panel-menu[data-panel-type=miew-menu-panel-representation] .miew-repr-list")).find(".panel.valid:eq(".concat(this._curReprIdx,") [data-type=selection-target]"))[0].textContent},rm.prototype._copyCurReprListItem=function(e){var t=o()("".concat(this._menuId," .panel-menu[data-panel-type=miew-menu-panel-representation] .miew-repr-list")),n=t.find(".panel.valid:eq(".concat(this._curReprIdx,")"));n.find(".panel-heading").removeClass("active"),n.find(".panel-collapse").collapse("hide");var r=t.find(".panel.valid:eq(".concat(this._curReprIdx,") .panel-collapse")).attr("data-number"),i=r.substr(0,r.lastIndexOf("-")+1)+(e+1);n.clone().appendTo(t),n.find(".panel-heading").addClass("active"),n.find(".panel-collapse").collapse("show");var a=t.find(".panel:eq(".concat(e,")")),s=a.html().replace(new RegExp(r.replace("-","\\-"),"g"),i);a.html(s),a.addClass("added");var l=(a=a.find(".panel-heading a")).html(),c=t.find(".panel.valid").length;a.html("#".concat(String(c)).concat(l.substring(l.indexOf(":"))));var u=n.find("[type=checkbox][data-toggle=zClip]")[0].checked,h=t.find(".panel:eq(".concat(e,") [data-type=surf-param-zclip]"));h.empty(),a.find("[type=checkbox]").bootstrapSwitch("state",u),h[0].appendChild(Qp("label",{},"Z clipping")),h[0].appendChild(Qp("span",{class:"pull-right"},Qp("input",{type:"checkbox","data-dir":"representation","data-toggle":"zClip","data-size":"mini",title:"Z clipping"}))),t.find(".panel:eq(".concat(e,") input[type=checkbox]")).bootstrapSwitch("state",u);var d=n.find("[data-type=iso]").val();t.find(".panel:eq(".concat(e,") [data-type=iso]")).val(d);var f=n.find("[data-type=rad]").val();t.find(".panel:eq(".concat(e,") [data-type=rad]")).val(f),this._initReprListItemListeners(e)},rm.prototype._fillSourceList=function(){var e=this,t=this._viewer.getVisuals();o()("#miew-source-dropdown").toggle(t.length>1);var n=this._viewer.getCurrentVisual();function r(t){return function(n){e._viewer.setCurrentVisual(t),e._fillSourceList(),e._initReprList(),n.preventDefault()}}document.getElementById("miew-source-name").textContent=n;for(var i=document.getElementById("miew-source-list"),a=document.createDocumentFragment(),s=0,l=t.length;s<l;++s){var c=t[s],u=Qp("a",{href:"#"},c!==n?c:[Qp("b",null,c),Qp("span",{class:"glyphicon glyphicon-ok pull-right"})]);u.addEventListener("click",r(c)),a.appendChild(Qp("li",null,u))}i.innerHTML="",i.appendChild(a)},rm.prototype._fillReprList=function(){var e=this,t=o()("".concat(e._menuId," .panel-menu[data-panel-type=miew-menu-panel-representation] .miew-repr-list"));t.empty();for(var n=t.get(0),r=0,i=e._viewer.repCount();r<i;r++){var a=e._viewer.repGet(r);e._addReprListItem(n,r,a)}o()("".concat(e._menuId," [data-toggle=mode]")).on("click",(function(){var n=t.find(".panel.valid:eq(".concat(e._curReprIdx,") [data-value=miew-menu-panel-mode]")),r=this.getAttribute("data-value"),i=Yp.get(r);n[0].firstElementChild.firstElementChild.textContent=i.prototype.shortName,n[0].firstElementChild.firstElementChild.setAttribute("data-id",r);var o=t.find(".panel.valid:eq(".concat(e._curReprIdx,") .panel-heading a")),a=o.html();o.html("".concat(a.substring(0,a.indexOf(":")+1)," ").concat(i.prototype.name));var s=t.find(".panel.valid:eq(".concat(e._curReprIdx,") .panel-collapse [data-type=surf-param-zclip]"));"SA"===r||"SE"===r||"QS"===r||"CS"===r?(s.show(),s.find("[type=checkbox][data-toggle=zClip]").bootstrapSwitch("state",Kp.defaults.modes[r].zClip)):s.hide();var l=t.find(".panel.valid:eq(".concat(e._curReprIdx,") .panel-collapse [data-type=surf-param-iso]"));"QS"===r||"CS"===r?(l.show(),l.find("[data-type=iso]").val(Kp.defaults.modes[r].isoValue)):l.hide();var c=t.find(".panel.valid:eq(".concat(e._curReprIdx,") .panel-collapse [data-type=surf-param-rad]"));"QS"===r?(c.show(),c.find("[data-type=rad]").val(Kp.defaults.modes[r].scale)):c.hide()})),o()("".concat(e._menuId," [data-toggle=colorer]")).on("click",(function(){var n=t.find(".panel.valid:eq(".concat(e._curReprIdx,") [data-value=miew-menu-panel-color]")),r=this.getAttribute("data-value"),i=qp.get(r);if(n[0].firstElementChild.firstElementChild.textContent=i.prototype.shortName,n[0].firstElementChild.firstElementChild.setAttribute("data-id",r),"UN"===r||"CB"===r){var o="UN"===r?"Uniform color":"Carbon color",a="UN"===r?Kp.now.colorers.UN.color:Kp.now.colorers.CB.color,s=t.find(".panel:eq(".concat(e._curReprIdx,") [data-value=miew-menu-panel-select-color]"));s[0].firstElementChild.innerHTML=o,s[0].lastElementChild.firstElementChild.setAttribute("data-id",Jp(a)),s[0].lastElementChild.firstElementChild.firstElementChild.style.backgroundColor=Jp(a),s.show()}else t.find(".panel:eq(".concat(e._curReprIdx,") [data-value=miew-menu-panel-select-color]")).hide()})),o()("".concat(e._menuId," [data-toggle=material]")).on("click",(function(){var n=t.find(".panel.valid:eq(".concat(e._curReprIdx,") [data-value=miew-menu-panel-matpreset]")),r=this.getAttribute("data-value"),i=$p.get(r);n[0].firstElementChild.firstElementChild.textContent=i.shortName,n[0].firstElementChild.firstElementChild.setAttribute("data-id",r)}))},rm.prototype._getPanelSelector=function(e){return o()("".concat(this._menuId," .panel-menu[data-panel-type=").concat(e,"]"))},rm.prototype._init=function(){var e=this,t=null;o()((function(){o()("".concat(e._menuId,' .titlebar [data-tooltip="tooltip"]')).tooltip({trigger:"hover"})})),e._xs=e._isXS(),o()("".concat(e._menuId,' [data-value="').concat(e._curPanelID,'"]')).toggleClass("active"),o()("".concat(e._menuId," [data-toggle=miew-main-menu]")).on("click",(function(){var t=this.getAttribute("data-state");return"on"===t?e._onMenuOn():"off"===t&&e._onMenuOff(),!1})),o()("".concat(e._menuId," [data-toggle=miew-terminal]")).on("click",(function(){var t=this.getAttribute("data-state");return this.blur(),"on"===t?(e._onTerminalOn(),this.setAttribute("data-state","off")):"off"===t&&(e._onTerminalOff(),this.setAttribute("data-state","on")),!1})),o()("".concat(e._menuId," [data-toggle=miew-terminal]")).on("mousedown",(function(e){return e.preventDefault(),!1})),o()(document).on("keydown",(function(t){27!==t.keyCode||t.isDefaultPrevented()||!0===o()("".concat(e._menuId," .main-menu")).is(":visible")&&(!0===o()("".concat(e._menuId," .panel-menu[data-panel-type=miew-menu-panel-main]")).is(":visible")&&e._curMenuItem===e._curPanelID?e._onMenuOff():e._getPanelSelector(e._curPanelID).get(0).firstElementChild.firstElementChild.click())})),o()("".concat(e._menuId,' [data-toggle="panel"]')).on("click",(function(){return!0===e._xs&&o()("".concat(e._menuId," .panel-menu[data-panel-type=miew-menu-panel-main]")).hide(),e._getPanelSelector(e._curPanelID).hide(),o()("".concat(e._menuId,' a[data-value="').concat(e._curMenuItem,'"]')).removeClass("active"),e._curMenuItem=e._curPanelID=t=this.getAttribute("data-value"),e._getPanelSelector(e._curPanelID).show(),o()("".concat(e._menuId,' a[data-value="').concat(t,'"]')).addClass("active"),!1})),o()("".concat(e._menuId,' [data-toggle="main-panel"]')).on("click",(function(){return o()("".concat(e._menuId," .panel-menu[data-panel-type=miew-menu-panel-main]")).show(),e._getPanelSelector(e._curPanelID).hide(),e._xs&&o()("".concat(e._menuId,' a[data-value="').concat(e._curMenuItem,'"]')).removeClass("active"),!1})),o()("".concat(e._menuId,' [data-toggle="combobox-panel"]')).on("click",(function(){return e._getPanelSelector(e._curPanelID).hide(),e._curPanelID=t=this.getAttribute("data-value"),e._getPanelSelector(e._curPanelID).show(),!1})),o()("".concat(e._menuId,' [data-toggle="toolbar"]')).on("click",(function(){if(!this.classList.contains("disabled")){this.blur();var t=this.getAttribute("data-value");o()("".concat(e._menuId,' [data-toggle="toolbar"]')).each((function(e,n){n.getAttribute("data-value")!==t&&n.classList.contains("active")&&n.click()}));var n=o()("".concat(e._menuId," [data-toolbar-type=").concat(t,"]"));if("miew-menu-toolbar-resolution"===t){n.toggle(),this.classList.toggle("active");var r=o()("".concat(e._menuId,' [data-toggle="resolution-immediate"]')+'[data-value="'.concat(Kp.now.resolution,'"]'));!0===this.classList.contains("active")?r.addClass("active"):r.removeClass("active")}else{var i=e._viewer.rep();if(null!==i){n.toggle(),this.classList.toggle("active");var a=t.substr(t.lastIndexOf("-")+1,t.length),s=o()("".concat(e._menuId,' [data-toggle="').concat(a,'-immediate"]')+'[data-value="'.concat(em(i[a]),'"]'));!0===this.classList.contains("active")?s.addClass("active"):s.removeClass("active")}else e._viewer.logger.error("No representation")}}})),e._menu.on("click",(function(t){o()(t.target).hasClass("main-menu")&&e._onMenuOff()}));var n=o()("".concat(e._menuId," input[type=checkbox][data-dir=settings]"));n.bootstrapSwitch(),n.on("switchChange.bootstrapSwitch",(function(){var t=this.getAttribute("data-toggle");"bg.color"===t?e._viewer.set("bg.color",this.checked?2105376:13421772):e._viewer.set(t,this.checked)}));var r=!1;function i(t){if(r){var n=0,i=t.originalEvent;i.wheelDelta?n=i.wheelDelta:i.detail&&(n=10*-i.detail);var o=e._viewer.settings.now.draft;e._viewer.set({draft:{clipPlaneFactor:o.clipPlaneFactor-n*o.clipPlaneSpeed}})}}o()(document).on("keyup keydown",(function(e){r=e.shiftKey})),o()(document).on("mousewheel",(function(e){return i(e)})),o()(document).on("DOMMouseScroll",(function(e){return i(e)})),this._initMiewEventListeners(),this._initToolbar(),this._initInfoPanel(),this._initLoadPanel(),this._initReprPanel(),this._initRenderPanel(),this._initToolsPanel(),this._initSelectionPanel()},rm.prototype._initMiewEventListeners=function(){var e=this;this._viewer.addEventListener("loading",(function(){e._setTitle("Loading")})),this._viewer.addEventListener("fetching",(function(){e._setTitle("Fetching")})),this._viewer.addEventListener("parsing",(function(){e._setTitle("Parsing")})),this._viewer.addEventListener("rebuilding",(function(){e._setTitle("Building geometry")})),this._viewer.addEventListener("exporting",(function(){e._setTitle("Exporting")})),this._viewer.addEventListener("resize",(function(){e._onResize()})),this._viewer.addEventListener("fetchingDone",(function(t){t.error&&e._updateInfo(t.data)})),this._viewer.addEventListener("parsingDone",(function(t){e._updateInfo(t.data),e._fillSourceList(),e._fillReprList(),e.presetsPanel.actions.pdb.inputs.refresh(e)})),this._viewer.addEventListener("titleChanged",(function(t){e._setTitle(t.data)})),this._viewer.addEventListener("editModeChanged",(function(t){e._enableToolbar(t.data)}))},rm.prototype._initInfoPanel=function(){this._updateInfo()},rm.prototype._initLoadPanel=function(){var e=this;o()("".concat(e._menuId,' [data-form-type=miew-menu-form-load-pdb] [data-tooltip="tooltip"]')).tooltip({trigger:"hover"}),o()("".concat(e._menuId,' [data-toggle="preset-pdb"]')).on("click",(function(t){var n=this.getAttribute("data-value"),r=this.getAttribute("data-query");return o()("".concat(e._menuId," .panel-menu[data-panel-type=miew-menu-panel-representation] .miew-repr-list")).empty(),e._viewer.load(n).then((function(){e._viewer.setOptions(r||"")})),e._onMenuOff(),t.preventDefault(),!1})),o()("".concat(this._menuId,' .list-group-item[data-value="miew-menu-panel-presets"]')).on("click",(function(){e._presetsPanelActionsPdbInputsClear(e)})),this._initPresetsPanelActions()},rm.prototype._initReprPanel=function(){var e=this,t=o()("".concat(e._menuId," .panel-menu[data-panel-type=miew-menu-panel-representation] .miew-repr-list"));o()("".concat(e._menuId," .miew-repr-list-controls [data-btn-type=miew-menu-btn-add-repr]")).on("click",(function(){if(0!==e._viewer.getComplexVisualsCount()){var n=t.find(".panel").length;if(n>0)e._copyCurReprListItem(n);else{var r=Yp.first,i=qp.first,a=new Wp(0,new r,new i,jp.all());e._addReprListItem(t.get(0),n,a),t.find(".panel:eq(".concat(n,")")).addClass("added")}var s=t.find(".panel.valid").length;2===s?o()("".concat(e._menuId," .miew-repr-list-controls [data-btn-type=miew-menu-btn-del-repr]")).removeClass("disabled"):s===e._viewer.getMaxRepresentationCount()&&o()("".concat(e._menuId," .miew-repr-list-controls [data-btn-type=miew-menu-btn-add-repr]")).addClass("disabled"),t.find(".panel.valid:eq(".concat(s-1,") .panel-heading")).click(),e._reprListChanged=!0}})),o()("".concat(e._menuId," .miew-repr-list-controls [data-btn-type=miew-menu-btn-del-repr]")).on("click",(function(){var n=t.find(".panel.valid").length,r=e._curReprIdx,i=t.find(".panel.valid:eq(".concat(r,")"));if(i.addClass("deleted"),i.hide(),i.removeClass("valid"),e._curReprIdx===n-1)t.find(".panel.valid:eq(".concat(e._curReprIdx-1,") .panel-heading")).click();else{t.find(".panel.valid:eq(".concat(e._curReprIdx,") .panel-heading")).click();for(var a=e._curReprIdx;a<n-1;++a){var s=t.find(".panel.valid:eq(".concat(a,") .panel-heading a")),l=s.html();s.html("#".concat(String(a+1)).concat(l.substring(l.indexOf(":"))))}}1===(n=t.find(".panel.valid").length)?o()("".concat(e._menuId," .miew-repr-list-controls [data-btn-type=miew-menu-btn-del-repr]")).addClass("disabled"):n===e._viewer.getMaxRepresentationCount()-1&&o()("".concat(e._menuId," .miew-repr-list-controls [data-btn-type=miew-menu-btn-add-repr]")).removeClass("disabled"),e._reprListChanged=!0})),e._fillCombo("miew-menu-panel-mode","mode","mode",Yp),e._fillCombo("miew-menu-panel-color","colorer","colorer",qp),e._fillCombo("miew-menu-panel-matpreset","material","materialPreset",$p)},rm.prototype._displayGlobalErrorDialog=function(e,t){var n=o()("".concat(this._menuId," .miew-menu-modals [data-modal-type=miew-menu-modal-global-error]")),r=n.find(".modal-title").get(0),i=n.find(".modal-body").get(0);o()(r).html(e),o()(i).html(t||"Some error occured."),n.modal({keyboard:!0},"show")},rm.prototype.presetsPanel={inputs:{main:null},actions:{pdb:{load:null,inputs:{clear:null,refresh:null,file:null,text:null}}}},rm.prototype._presetsPanelActionsPdbInputsRefresh=function(e){var t,n=o()("".concat(e._menuId," .presets-panel-action[data-presets-panel-action=pdb-load]")),r=o()("".concat(e._menuId," .presets-panel-action[data-presets-panel-action=pdb-inputs-clear]")),i=o()(o()("[data-form-type=miew-menu-form-load-pdb] input[type=text][data-pdb-url-type=main]").get(0)),a=o()(o()("[data-form-type=miew-menu-form-load-pdb] .alert-danger[data-pdb-url-type=main]").get(0)),s=o()(o()("[data-form-type=miew-menu-form-load-pdb] .alert-warning[data-pdb-url-type=main]").get(0)),l=function(e){var t=e.toLowerCase().split("/"),n=t[t.length-1];return t=n.split("\\"),1===(t=(n=t[t.length-1]).split(".")).length?"":t[t.length-1]},c=null,u=function(e){e?(a.html(e),a.removeClass("hidden")):(a.html(e),a.addClass("hidden"))};if(e.presetsPanel.inputs.isCorrect=!1,e.presetsPanel.inputs&&e.presetsPanel.inputs.main){if(e.presetsPanel.inputs.main){var h;e.presetsPanel.inputs.main instanceof File?(i.val(e.presetsPanel.inputs.main.name),i.attr("disabled","disabled"),h=l(e.presetsPanel.inputs.main.name)):(i.removeAttr("disabled"),h=l(e.presetsPanel.inputs.main));var d=Hp.keys("extensions").sort(),f=new RegExp("^(".concat(d.map((function(e){return e.substr(1)})).join("|"),")$")),p=d.join(", ");e.presetsPanel.inputs.main instanceof File&&!h.match(f)?(e.presetsPanel.inputs.mainIsCorrect=!1,e.presetsPanel.inputs.isCorrect=!1,c="Only the following filename extensions are supported: ".concat(p)):(e.presetsPanel.inputs.mainIsCorrect=!0,e.presetsPanel.inputs.isCorrect=!1)}e.presetsPanel.inputs.isCorrect=!0,e.presetsPanel.inputs.isCorrect?n.removeClass("disabled"):n.addClass("disabled"),e.presetsPanel.inputs.main?r.removeClass("hidden"):r.addClass("hidden"),u(c)}else n.addClass("disabled"),r.addClass("hidden"),i.val(""),i.removeAttr("disabled"),u(null),(t=null)?(s.html(t),s.removeClass("hidden")):(s.html(t),s.addClass("hidden"))},rm.prototype._presetsPanelActionsPdbInputsClear=function(e){e.presetsPanel.inputs={main:null},e.presetsPanel.actions.pdb.inputs.refresh(e)},rm.prototype._presetsPanelActionsPdbLoad=function(e){e._onMenuOff(),e.presetsPanel.inputs&&e._viewer.load(e.presetsPanel.inputs.main),e.presetsPanel.actions.pdb.inputs.clear(e)},rm.prototype._presetsPanelActionsPdbInputsFile=function(e,t){var n=o()(t).data("pdb-url-type"),r=o()("[data-form-type=miew-menu-form-load-pdb] input[type=text][data-pdb-url-type=".concat(n,"]")).get(0);if(o()(t).val()){var i=o()(t)[0].files;i.length>0&&(e.presetsPanel.inputs[n]=i[0],o()(r).val(i[0].name),o()(r).attr("disabled","disabled"))}o()(t).val(""),e.presetsPanel.actions.pdb.inputs.refresh(e)},rm.prototype._presetsPanelActionsPdbInputsText=function(e,t,n){var r=o()(t).data("pdb-url-type");e.presetsPanel.inputs[r]=o()(t).val(),e.presetsPanel.actions.pdb.inputs.refresh(e),n&&"keyup"===n.type&&13===n.keyCode&&e.presetsPanel.inputs.isCorrect&&e.presetsPanel.actions.pdb.load(e)},rm.prototype._initPresetsPanelActions=function(){var e=this;e.presetsPanel.actions.pdb.inputs.refresh=e._presetsPanelActionsPdbInputsRefresh,e.presetsPanel.actions.pdb.inputs.clear=e._presetsPanelActionsPdbInputsClear,e.presetsPanel.actions.pdb.inputs.file=e._presetsPanelActionsPdbInputsFile,e.presetsPanel.actions.pdb.inputs.text=e._presetsPanelActionsPdbInputsText,e.presetsPanel.actions.pdb.load=e._presetsPanelActionsPdbLoad,e.presetsPanel.actions.pdb.inputs.refresh(e);var t=o()("".concat(e._menuId," [data-panel-type=miew-menu-panel-presets] button.main-back-button")),n=o()("".concat(e._menuId," [data-panel-type=miew-menu-panel-presets] button.presets-back-button"));t.removeClass("hidden"),n.addClass("hidden");o()(document).on("click input propertychange paste keyup change",".presets-panel-action",(function(t){if(o()(this).hasClass("disabled"))return!1;if(o()(this).data("presets-panel-action")){var n=o()(this).data("presets-panel-events");if(n&&-1===(n=n.split(",")).indexOf(t.type.toLowerCase()))return!0;var r=o()(this).data("presets-panel-action").split("-"),i=function e(t,n){if(!t)return null;if(1===n.length)return t[n[0]];var r=n[0];return n.splice(0,1),e(t[r],n)}(e.presetsPanel.actions,r);if(i)return i(e,this,t),"paste"===t.type.toLowerCase()}return!0}))},rm.prototype._initPresetsPanel=function(){this.presetsPanel.actions.pdb.inputs.refresh(this)},rm.prototype._initRenderPanel=function(){var e=this;o()("".concat(e._menuId," [data-toggle=resolution]")).on("click",(function(){var t=o()("".concat(e._menuId," [data-value=miew-menu-panel-resolution]")),n=this.getAttribute("data-value"),r=Kp.now.resolution;o()("".concat(e._menuId,' [data-value="').concat(r,'"]')).removeClass("active"),t[0].firstElementChild.firstElementChild.textContent=this.textContent,Kp.set("resolution",n),o()("".concat(e._menuId,' [data-value="').concat(n,'"]')).addClass("active"),o()("".concat(e._menuId," button[data-value=miew-menu-panel-render]")).click()})),this._fillCombo("miew-menu-panel-palette","palette","palette",Xp),o()("".concat(e._menuId," [data-toggle=palette]")).on("click",(function(){var t=o()("".concat(e._menuId," .list-group-item[data-value=miew-menu-panel-palette]")),n=this.getAttribute("data-value"),r=Xp.get(n);t[0].firstElementChild.firstElementChild.textContent=r?r.name:"Unknown",e._fillSelectionColorCombo(n)}))},rm.prototype._initToolsPanel=function(){var e=this;o()("".concat(e._menuId," .miew-menu-modals [data-modal-type=miew-menu-modal-url]")).on("shown.bs.modal",(function(){var t=o()("".concat(e._menuId," .miew-menu-modals [data-modal-type=miew-menu-modal-url] .modal-body"))[0].firstChild,n=t.nodeValue;if(document.createRange){var r=document.createRange();r.setStart(t,0),r.setEnd(t,n.length);var i=window.getSelection();i.removeAllRanges(),i.addRange(r)}})),o()("".concat(e._menuId," .miew-menu-modals [data-modal-type=miew-menu-modal-url]")).on("keydown",(function(e){27===e.keyCode&&e.preventDefault()})),o()("".concat(e._menuId," [data-toggle=miew-menu-tools]")).on("click",(function(){switch(this.getAttribute("data-value")){case"dssp":e._viewer.dssp(),e._onMenuOff();break;case"reset-view":e._viewer.resetView(),e._initReprList(),e._onMenuOff();break;case"screenshot":e._viewer.screenshotSave(),e._onMenuOff();break;case"get-url":var t=o()("".concat(e._menuId," .miew-menu-modals [data-modal-type=miew-menu-modal-url]"));t.find(".modal-body")[0].textContent=e._viewer.getURL({settings:!0,view:!0}),t.modal({keyboard:!0},"show");break;case"get-script":var n=o()("".concat(e._menuId," .miew-menu-modals [data-modal-type=miew-menu-modal-script]"));n.find(".modal-body")[0].innerHTML=e._viewer.getScript().replace(/(?:\r\n|\r|\n)/g,"<br />"),n.modal({keyboard:!0},"show");break;case"fbx-export":e._viewer.save({fileType:"fbx"}),e._onMenuOff();break;case"save-settings":e._viewer.saveSettings(),e._onMenuOff();break;case"restore-settings":e._viewer.restoreSettings(),e._onMenuOff();break;case"reset-settings":e._viewer.resetSettings(),e._onMenuOff();break;default:e._onMenuOff()}return!1}))},rm.prototype._onSelectorChanged=function(e){var t=e.find("input").get(0).value.trim()||"all",n=e.find(".alert-danger").get(0),r=jp.parse(t),i=e.find("[data-btn-type=miew-menu-btn-apply-sel]");r.error?(i.addClass("disabled"),n.style.display="block",n.textContent=r.error):(i.removeClass("disabled"),n.style.display="none",n.textContent="")},rm.prototype._initSelectionPanel=function(){var e=this,t=this,n=o()("".concat(t._menuId," [data-panel-type=miew-menu-panel-selection]"));!function(){var e,r,i,o=document.createDocumentFragment(),a=n.find("[data-tab-content=singleword]").get(0);for(r=0,i=t._singleWordsPrimary.length;r<i;r++){var s=t._singleWordsPrimary[r];e=Qp("a",{href:"#",class:"list-group-item frequent","data-toggle":"selection-input","data-value":"".concat(s," ")},s),o.appendChild(e)}for(t._singleWords.sort(),r=0,i=t._singleWords.length;r<i;r++){var l=t._singleWords[r];-1===t._singleWordsPrimary.indexOf(l)&&(e=Qp("a",{href:"#",class:"list-group-item","data-toggle":"selection-input","data-value":"".concat(l," ")},l),o.appendChild(e))}a.firstElementChild.appendChild(o)}(),function(){for(var e,r=document.createDocumentFragment(),i=n.find("[data-tab-content=keyword]").get(0),o=0,a=t._keyWordsPrimary.length;o<a;o++){var s=t._keyWordsPrimary[o];e=Qp("a",{href:"#",class:"list-group-item frequent keyword-item","data-toggle":"selection-input","data-value":"".concat(s," ")},s),r.appendChild(e)}i.firstElementChild.appendChild(r)}();var r=n.find("input").get(0);r.addEventListener("input",(function(){return e._onSelectorChanged(n)})),r.addEventListener("change",(function(){return e._onSelectorChanged(n)})),n.find(".help-block a").on("click",(function(e){return n.find("input").get(0).value=e.target.textContent,t._onSelectorChanged(n),!1})),n.find("[data-toggle=selection-input]").on("click",(function(e){var r=e.target.getAttribute("data-value"),i=o()("".concat(t._menuId," .panel-menu[data-panel-type=miew-menu-panel-selection] input"));i.val(i.val()+r),t._onSelectorChanged(n)})),n.find(".calc .delete").on("click",(function(){var e=n.find("input");switch(this.getAttribute("data-delete-type")){case"clear":e.val("");break;case"backspace":e.val(e.val().slice(0,-1))}t._onSelectorChanged(n)})),o()("".concat(t._menuId," .keyword-item")).on("click",(function(e){var r=n.find("[data-tab-content=value] div");r.empty(),r.off("click",".value[data-toggle=selection-input]");var i,a,s,l=document.createDocumentFragment(),c=n.find("[data-tab-content=value]").get(0),u=e.target.getAttribute("data-value").slice(0,-1),h=[];if(tm(t._viewer))switch(u){case"name":a=t._viewer,h=(s=a._getComplexVisual())?s.getComplex().getAtomNames():0;break;case"type":case"elem":h=function(e){var t=e._getComplexVisual();return t?t.getComplex().getElements():0}(t._viewer);break;case"residue":h=function(e){var t=e._getComplexVisual();return t?t.getComplex().getResidueNames():0}(t._viewer);break;case"chain":h=function(e){var t=e._getComplexVisual();return t?t.getComplex().getChainNames():0}(t._viewer);break;case"altloc":h=function(e){var t=e._getComplexVisual();return t?t.getComplex().getAltLocNames():0}(t._viewer);break;default:h=["1","2","3","4","5"]}for(var d=0,f=h.length;d<f;d++){var p=h[d];i=Qp("a",{href:"#",class:"list-group-item value","data-toggle":"selection-input","data-value":p},p),l.appendChild(i)}c.firstElementChild.appendChild(l),n.find('.nav-tabs a[href="[data-tab-content=value]"]').tab("show"),o()("".concat(t._menuId," .value[data-toggle=selection-input]")).on("click",(function(e){var r=Zp.correctSelectorIdentifier(e.target.getAttribute("data-value")),i=n.find("input");i.val(i.val()+r),t._onSelectorChanged(n)}))})),n.find("[data-btn-type=miew-menu-btn-apply-sel]").on("click",(function(){if(!n.find("[data-btn-type=miew-menu-btn-apply-sel]").hasClass("disabled")){var e=n.find("input").val().trim()||"all";o()("".concat(t._menuId," [data-panel-type=miew-menu-panel-representation] .miew-repr-list ")+".panel.valid:eq(".concat(t._curReprIdx,") .panel-collapse [data-value=miew-menu-panel-selection]"))[0].firstElementChild.firstElementChild.textContent=e;var r=o()("".concat(t._menuId," [data-panel-type=miew-menu-panel-representation] .miew-repr-list ")+".panel.valid:eq(".concat(t._curReprIdx,") .panel-heading .badge")),i=jp.parse(e),a=nm(t._viewer,i.selector);r[0].textContent=String(a),n.get(0).firstElementChild.firstElementChild.click()}}))},rm.prototype._initToolbar=function(){var e,t=this,n=document.createDocumentFragment();function r(r,i,a,s){for(var l=o()("".concat(t._menuId," [data-toolbar-type=").concat(r,"]")).get(0),c=s.all,u=0,h=c.length;u<h;u++){var d=c[u];d=d.prototype||d,e=Qp("a",{href:"#",class:"thumbnail","data-toggle":i,"data-value":d.id},[Qp("div",{class:"toolbar-thumb",style:"background:url(images/".concat(i.substring(0,i.indexOf("-")),"/").concat(d.id,".png)")}),Qp("div",{class:"caption text-center"},Qp("small",{},d.shortName))]),n.appendChild(e)}l.lastElementChild.lastElementChild.appendChild(n)}r("miew-menu-toolbar-mode","mode-immediate",0,Yp),r("miew-menu-toolbar-colorer","colorer-immediate",0,qp),o()("".concat(t._menuId,' [data-toggle="mode-immediate"]')).each((function(e,n){var r=n.getAttribute("data-value");n.addEventListener("click",(function(e){o()("".concat(t._menuId,' [data-value="').concat(em(t._viewer.rep().mode),'"]')).removeClass("active"),o()("".concat(t._menuId," [data-value=miew-menu-toolbar-mode]")).click(),t._viewer.rep({mode:r}),e.preventDefault(),t._fixKeyboard()}))})),o()("".concat(t._menuId,' [data-toggle="colorer-immediate"]')).each((function(e,n){var r=n.getAttribute("data-value");n.addEventListener("click",(function(e){o()("".concat(t._menuId,' [data-value="').concat(em(t._viewer.rep().colorer),'"]')).removeClass("active"),o()("".concat(t._menuId," [data-value=miew-menu-toolbar-colorer]")).click(),t._viewer.rep({colorer:r}),e.preventDefault(),t._fixKeyboard()}))})),o()("".concat(t._menuId,' [data-toggle="resolution-immediate"]')).each((function(e,n){var r=n.getAttribute("data-value");n.addEventListener("click",(function(e){o()("".concat(t._menuId,' [data-value="').concat(Kp.now.resolution,'"]')).removeClass("active"),Kp.set("resolution",r),o()("".concat(t._menuId," [data-value=miew-menu-toolbar-resolution]")).click(),t._viewer.rebuildAll(),e.preventDefault(),t._fixKeyboard()}))})),o()("".concat(t._menuId," .titlebar [data-toggle=panel]")).on("click",(function(){t._onMenuOn()})),o()("".concat(t._menuId," .toolbar")).on("click",(function(e){var n=o()(e.target);if(n.is(".toolbar")){var r=n.attr("data-toolbar-type");o()("".concat(t._menuId,' [data-value="').concat(r,'"]')).click(),t._fixKeyboard()}}))},rm.prototype._initReprList=function(){this._fillReprList(),this._curReprIdx=this._viewer.repCurrent(),o()("".concat(this._menuId," .panel-menu[data-panel-type=miew-menu-panel-representation] .miew-repr-list .panel.valid:eq(").concat(this._curReprIdx,") .panel-heading")).addClass("active"),o()("".concat(this._menuId," .panel-menu[data-panel-type=miew-menu-panel-representation] .miew-repr-list .panel.valid:eq(").concat(this._curReprIdx,") .panel-collapse")).collapse("show"),this._viewer.repCount()>1?o()("".concat(this._menuId," .miew-repr-list-controls [data-btn-type=miew-menu-btn-del-repr]")).removeClass("disabled"):o()("".concat(this._menuId," .miew-repr-list-controls [data-btn-type=miew-menu-btn-del-repr]")).addClass("disabled"),this._viewer.repCount()<this._viewer.getMaxRepresentationCount()?o()("".concat(this._menuId," .miew-repr-list-controls [data-btn-type=miew-menu-btn-add-repr]")).removeClass("disabled"):o()("".concat(this._menuId," .miew-repr-list-controls [data-btn-type=miew-menu-btn-add-repr]")).addClass("disabled")},rm.prototype._updateResolutionCombo=function(){this._removeActiveFromCombo("resolution");var e=o()("".concat(this._menuId," [data-value=miew-menu-panel-resolution]")),t=o()("".concat(this._menuId,' [data-toggle=resolution][data-value="').concat(Kp.now.resolution,'"]'));e[0].firstElementChild.firstElementChild.textContent=t.text(),t.addClass("active")},rm.prototype.setBlur=function(e){var t=this._viewer._container;e?t.classList.add("blur"):t.classList.remove("blur")},rm.prototype.show=function(e,t){var n=this;(this.setBlur(!0),this._titlebar.hide(),n._getPanelSelector(n._curPanelID).hide(),o()("".concat(n._menuId,' a[data-value="').concat(n._curMenuItem,'"]')).removeClass("active"),n._curPanelID=e,n._curMenuItem=t,!1===this._xs)&&(n._getPanelSelector(n._curPanelID).show(),o()("".concat(n._menuId,' a[data-value="').concat(t,'"]')).addClass("active"));if(Kp.checkpoint(),n._updateDisplayOptions("miew-menu-panel-palette","palette",Xp),n._fillSelectionColorCombo(Kp.get("palette")),n._fillSourceList(),n._initReprList(),n._updateResolutionCombo(),o()("".concat(n._menuId," input[type=checkbox][data-dir=settings]")).each((function(e,t){var r=t.getAttribute("data-toggle");"bg.color"===r?o()("".concat(n._menuId,' [data-toggle="').concat(r,'"]')).bootstrapSwitch("state",2105376===Kp.get(r)):o()("".concat(n._menuId,' [data-toggle="').concat(r,'"]')).bootstrapSwitch("state",Kp.get(r))})),-1!==n._curPanelID.indexOf("selection")||-1!==n._curPanelID.indexOf("mode")||-1!==n._curPanelID.indexOf("color")||-1!==n._curPanelID.indexOf("matpreset")){var r=o()("".concat(n._menuId," [data-panel-type=miew-menu-panel-representation] .miew-repr-list")).find(".panel:eq(".concat(n._curReprIdx,') [data-value="').concat(n._curPanelID,'"]'));r&&r.click()}o()("".concat(n._menuId," .panel-menu[data-panel-type=miew-menu-panel-main]")).show(),this._menu.show()},rm.prototype.showTerminal=function(){this._terminal.show(),this._terminalWindow.focus(),this._term.resize()},rm.prototype._removeActiveFromCombo=function(e){o()("".concat(this._menuId," [data-toggle=").concat(e,"].active")).removeClass("active")},rm.prototype.hide=function(){o()("".concat(this._menuId,' [data-toggle=resolution][data-value="').concat(Kp.now.resolution,'"]')).removeClass("active"),-1!==this._curPanelID.indexOf("mode")?this._removeActiveFromCombo("mode"):-1!==this._curPanelID.indexOf("color")?this._removeActiveFromCombo("colorer"):-1!==this._curPanelID.indexOf("matpreset")&&this._removeActiveFromCombo("material"),this.setBlur(!1),this._titlebar.show(),this._menu.hide()},rm.prototype.hideTerminal=function(){this._terminal.hide(),this._terminalWindow.focus(!1)},rm.prototype._hideToolbarPanel=function(){o()("".concat(this._menuId,' [data-toggle="toolbar"].active')).trigger("click")},rm.prototype._onMenuOn=function(){this._viewer.halt(),o()("".concat(this._menuId," .overlay")).hide(),this._reprListChanged=!1,this._initPresetsPanel(),this._hideToolbarPanel(),this.show(this._curPanelID,this._curMenuItem)},rm.prototype._onTerminalOn=function(){o()("".concat(this._menuId," .overlay")).hide(),this._viewer.enableHotKeys(!1),this._hideToolbarPanel(),this.showTerminal()},rm.prototype._onMenuOff=function(){this._updateReprList(),this._reprListChanged&&(this._viewer.repGet().needsRebuild=!0),this.hide(),this._viewer.run(),o()("".concat(this._menuId," .overlay")).show(),this._fixKeyboard()},rm.prototype._onTerminalOff=function(){this.hideTerminal(),this._viewer.enableHotKeys(!0),o()("".concat(this._menuId," .overlay")).show(),this._fixKeyboard()},rm.prototype._fixKeyboard=function(){if(window!==window.top){var e=window.top.document,t=e.querySelector("button");if(!t){var n=e.querySelector("body");n&&((t=e.createElement("button")).style.visibility="hidden",n.appendChild(t),t=e.querySelector("button"))}if(!t)throw new Error("Some input element should be defined in parent frame. Hidden one is ok.");t.focus()}},rm.prototype.showOverlay=function(){this._titlebar.show()},rm.prototype.hideOverlay=function(){this._titlebar.hide()},rm.prototype._isXS=function(){return document.documentElement.clientWidth<768},rm.prototype._updateDisplayOptions=function(e,t,n){var r=n.get(Kp.get(t))||n.first;r=r.prototype||r,o()("".concat(this._menuId,' .list-group-item[data-value="').concat(e,'"]'))[0].firstElementChild.firstElementChild.textContent=r.name},rm.prototype._setTitle=function(e){o()("".concat(this._menuId,' [data-field="title"]')).text(e)},rm.prototype._updateInfo=function(e){if(!e||"Complex"===e.id){for(var t=e,n=o()(".panel-menu[data-panel-type=miew-menu-panel-info]").children(".panel-body")[0],r=n;r.firstChild;)r.removeChild(r.firstChild);var i=document.createDocumentFragment();if(!t)return i.appendChild(Qp("p",null,"No data loaded yet.")),void n.appendChild(i);var a=t.metadata,s=Qp("h1",null,"".concat(a.id||t.name||"Unknown data"," "));a.classification&&s.appendChild(Qp("small",null,"/ ".concat(a.classification))),i.appendChild(s),a.title&&i.appendChild(Qp("p",null,a.title.join(" "))),i.appendChild(Qp("hr")),i.appendChild(Qp("table",{class:"table"},[Qp("thead",null,Qp("tr",null,[Qp("th",{class:"col-xs-10"},"Statistics"),Qp("th",{class:"col-xs-2 text-center"},"Value")])),Qp("tbody",null,[h("Atoms",t.getAtomCount()),h("Bonds",t.getBondCount()),h("Residues",t.getResidueCount()),h("Chains",t.getChainCount()),h("Molecules",t.getMoleculeCount())])])),i.appendChild(Qp("hr"));for(var l=t.getMolecules(),c=Qp("ol"),u=0;u<l.length;u++)c.appendChild(Qp("li",null,l[u].name));i.appendChild(Qp("table",{class:"table"},[Qp("thead",null,Qp("tr",null,[Qp("th",{class:"col-xs-10"},"Molecules")])),Qp("tbody",null,Qp("tr",null,Qp("td",null,c)))])),n.appendChild(i)}function h(e,t){return Qp("tr",null,[Qp("td",null,e),Qp("td",{class:"text-center"},String(t))])}},rm.prototype._onResize=function(){!1===this._xs&&!0===this._isXS()&&(this._xs=!0,o()("".concat(this._menuId," .panel-menu[data-panel-type=miew-menu-panel-main]")).hide()),!0===this._xs&&!1===this._isXS()&&(this._xs=!1,o()("".concat(this._menuId," .panel-menu[data-panel-type=miew-menu-panel-main]")).show(),o()("".concat(this._menuId,' a[data-value="').concat(this._curMenuItem,'"]')).addClass("active"),this._getPanelSelector(this._curPanelID).show()),this._term&&this._term.resize()},rm.prototype._updateReprList=function(){var e=this;function t(t,n,r,i){if(e._viewer.repGet(t)[n].id!==i)return o()(r).removeData(),i;var a=o()(r).data().mvdata;if(void 0===a||h.a.isEmpty(a))return i;var s=Zp.objectsDiff(a,Kp.now["".concat(n,"s")][i]);return h.a.isEmpty(s)?i:[i,s]}var n=[],r=null,i=null,a=null,s=null,l=null,c=null,u=null,d=null,f=null,p=null,m=null,v=null,y=null,_=null,g=null,x=null;function b(){"zClip"in x.mode.opts&&x.mode.opts.zClip!==v&&(x.mode.opts.zClip=v,x.needsRebuild=!0),"scale"in x.mode.opts&&x.mode.opts.scale!==_&&(x.mode.opts.scale=_,x.needsRebuild=!0),"isoValue"in x.mode.opts&&x.mode.opts.isoValue!==y&&(x.mode.opts.isoValue=y,x.needsRebuild=!0)}o()("".concat(e._menuId," [data-panel-type=miew-menu-panel-representation] ")+".miew-repr-list .panel").each((function(h,w){if(f=o()(w).hasClass("deleted"),p=o()(w).hasClass("added"),!f||!p)if(m="none"!==o()(w).find(".panel-heading .btn-visible").css("display"),r=o()(w).find("[data-type=selection-target]")[0].textContent,i=o()(w).find("[data-value=miew-menu-panel-mode]")[0],a=o()(w).find("[data-value=miew-menu-panel-color]")[0],s=o()(w).find("[data-value=miew-menu-panel-matpreset]")[0],l=o()(w).find("[data-value=miew-menu-panel-select-color]")[0],c=i.firstElementChild.firstElementChild.getAttribute("data-id"),u=a.firstElementChild.firstElementChild.getAttribute("data-id"),d=s.firstElementChild.firstElementChild.getAttribute("data-id"),A=l.lastChild.firstElementChild.getAttribute("data-id"),E="0x".concat(A.substr(-6)),g=parseInt(E,16),v=o()(w).find("[type=checkbox][data-toggle=zClip]")[0].checked,_=parseFloat(o()(w).find("[data-type=rad]").val()),y=parseFloat(o()(w).find("[data-type=iso]").val()),f)n.push(h);else if(p){var S=e._viewer.repAdd({selector:r,mode:c,colorer:u});S>=0&&(x=e._viewer.repGet(S),b(),"UN"!==u&&"CB"!==u||(x.colorer.opts.color=g),x.setMaterialPreset($p.get(d)),x.visible!==m&&e._viewer.setNeedRender(),x.show(m))}else{var C=t(h,"mode",i,c),R=t(h,"colorer",a,u);h=e._viewer.repCurrent(h),e._viewer.rep(h,{selector:r,mode:C,colorer:R,material:d}),x=e._viewer.repGet(),"UN"!==u&&"CB"!==u||x.colorer.opts.color!==g&&(x.needsRebuild=!0,x.colorer.opts.color=g),b(),x.visible!==m&&e._viewer.setNeedRender(),x.show(m)}var A,E}));for(var w=n.length-1;w>-1;--w)e._viewer.repRemove(n[w]);e._viewer.repCurrent(e._curReprIdx)},rm.prototype._enableToolbar=function(e){e?o()("".concat(this._menuId," [data-toggle=toolbar]")).removeClass("disabled"):o()("".concat(this._menuId," [data-toggle=toolbar]")).addClass("disabled")};var im=rm;window.DEBUG=!0;window.onerror=function(e,t,n,r,i){throw function(e){var t=document.createDocumentFragment(),n=document.getElementsByClassName("miew-container"),r=n.length>0?n[0]:null,i=document.getElementById("miew-error");if(!i){for(;r&&r.firstChild;)r.removeChild(r.firstChild);(i=document.createElement("div")).setAttribute("class","miew-message"),t.appendChild(i);var o=i.appendChild(document.createElement("p"));o.appendChild(document.createTextNode("We are sorry")),o.appendChild(document.createElement("br")),o.appendChild(document.createElement("small")).textContent="for the failure",(i=document.createElement("div")).setAttribute("class","miew-error"),i.id="miew-error",t.appendChild(i)}var a=i.appendChild(document.createElement("p"));a.appendChild(document.createTextNode("Error details:")),a=i.appendChild(document.createElement("pre")),e.stack&&-1!==String(e.stack).indexOf(String(e))||a.appendChild(document.createTextNode("".concat(e,"\n"))),e.stack&&a.appendChild(document.createTextNode("".concat(e.stack,"\n"))),r&&r.appendChild(t)}(i=i||{name:"window.onerror",message:e,sourceURL:t,line:n,column:r}),i},window.addEventListener("load",(function(){o()(".miew-container").each((function(e,t){var n=window.miew=new Gp(o.a.extend(!0,{container:t,load:"data/1CRN.pdb",cookiePath:"/"},Gp.options.fromAttr(t.getAttribute("data-miew")),Gp.options.fromURL(window.location.search))),r={error:"error",warn:"warning",report:"info"};s.a.options.newestOnTop=!1,n.logger.addEventListener("message",(function(e){var t=r[e.level];t&&s.a[t](e.message)}));var i=new im(t,n);n.init()&&(i.showOverlay(),n.run())}))}))}},[["xGHL",1,2]]]);
//# sourceMappingURL=demo.977b8ac5030b84f0758f.js.map