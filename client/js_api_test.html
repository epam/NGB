<html>
<head>
    <title>Api test</title>
</head>
<body>
<input type="text" id="dataSetId" value="4" placeholder="DataSet id">
<input type="button" id="loadDataSet" value="loadDataSet">&nbsp;
<input type="text" id="coordinatesText" value="" placeholder="chromosome: coordinates">
<input type="button" id="navigateToCoordinate" value="navigateToCoordinate">&nbsp;
<select name="loadTrackMode" id="loadTrackMode">
    <option value="id">id</option>
    <option value="url">url</option>
    <option value="ngbServer">ngbServer</option>
</select>
<input type="button" id="loadTrackBtn" value="loadTrack"><br>
</p>
<textarea rows="10" cols="35" id="globalSettings"></textarea>
<input type="button" id="setGlobalSettings" value="setGlobalSettings">
<textarea rows="10" cols="35" id="trackSettings"></textarea>
<select name="typeTrack" id="typeTrack">
    <option value="vcf">vcf</option>
    <option value="referense">referense</option>
    <option value="wig">wig</option>
    <option value="bam">bam</option>
    <option value="gene">gene</option>
</select>
<input type="button" id="setTrackSettings" value="setTrackSettings">
</p>
<iframe height="90%" width="100%" id="ngbIframe" src="http://localhost:8080/#"></iframe>
<script type="text/javascript">
    var dataSetId = document.getElementById('dataSetId'),
        btnLoadDataSet = document.getElementById('loadDataSet'),
        btnNavigateToCoordinate = document.getElementById('navigateToCoordinate'),
        coordinatesInput = document.getElementById('coordinatesText'),
        btnLoadTrack = document.getElementById('loadTrackBtn'),
        loadTrackModeSelect = document.getElementById('loadTrackMode'),
        globalSettings = document.getElementById('globalSettings'),
        btnSetGlobalSettings = document.getElementById('setGlobalSettings'),
        trackSettings = document.getElementById('trackSettings'),
        typeTrackSelect = document.getElementById('typeTrack'),
        btnSetTrackSettings = document.getElementById('setTrackSettings'),
        iframe = document.getElementById('ngbIframe');

    function guid() {
        function s4() {
            return Math.floor((1 + Math.random()) * 0x10000)
                .toString(16)
                .substring(1);
        }
        return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
            s4() + '-' + s4() + s4() + s4();
    }

    globalSettings.value = JSON.stringify({
        showCenterLine: false,
        hotkeys: {
            "layout>variants": {
                "hotkey": "ALT + !"
            },
            'gene>transcript>expanded': {
                "hotkey": "ALT + $"
            }
        },
        colors: {
            strand: {forward: 14363949}
        }
    });

    trackSettings.value = JSON.stringify({
        id: 23, // id or path "http://ngb.opensource.epam.com/distr/data/demo/ngb_demo_data/sample_1-lumpy.vcf.gz"
        settings: [
            {name: "vcf>variantsView>expanded"}
        ]
    });

    btnLoadDataSet.onclick = function () {
        iframe.contentWindow.postMessage({
            callerId: guid(),
            method: "loadDataSet",
            params: {id: dataSetId.value}
            }, "*");
    };

    btnNavigateToCoordinate.onclick = function () {
        iframe.contentWindow.postMessage({
            callerId: guid(),
            method: "navigateToCoordinate",
            params: {coordinates: coordinatesInput.value}
        }, "*");
    };

    btnLoadTrack.onclick = function () {
        if(loadTrackModeSelect.value === 'ngbServer') {
            iframe.contentWindow.postMessage({
                callerId: guid(),
                method: "loadTrack",
                params: {
                    tracks: [{
                            path: "/opt/catgenome/MCF7-PIK3CA.bam",
                            index: "/opt/catgenome/MCF7-PIK3CA.bam.bai",
                        }, {
                            path: "/opt/catgenome/beds-test/1.bed.gz",
                            index: "/opt/catgenome/beds-test/1.bed.gz.tbi",
                        }, {
                            path: "/opt/catgenome/beds-test/2.bed.gz",
                            index: "/opt/catgenome/beds-test/2.bed.gz.tbi",
                        }, {
                            path: "/opt/catgenome/beds-test/3.bed.gz",
                            index: "/opt/catgenome/beds-test/3.bed.gz.tbi",
                        }, {
                            path: "/opt/catgenome/beds-test/BRD4_primers_names.bed.gz",
                            index: "/opt/catgenome/beds-test/BRD4_primers_names.bed.gz.tbi",
                        },
                    ],
                    referenceId: 1,
                    mode: loadTrackModeSelect.value
                }
            }, "*");
        } else if(loadTrackModeSelect.value === 'url') {
            iframe.contentWindow.postMessage({
                callerId: guid(),
                method: "loadTrack",
                params: {
                    tracks: [{
                            path: "http://ngb.opensource.epam.com/distr/data/demo/ngb_demo_data/sample_1-lumpy.vcf.gz",
                            index: "http://ngb.opensource.epam.com/distr/data/demo/ngb_demo_data/sample_1-lumpy.vcf.gz.tbi",
                        }, {
                            path: "http://ngb.opensource.epam.com/distr/data/genome/dm6/dmel-all-r6.06.sorted.gtf.gz",
                            index: "http://ngb.opensource.epam.com/distr/data/genome/dm6/dmel-all-r6.06.sorted.gtf.gz.tbi",
                        }, {
                            path: "http://ngb.opensource.epam.com/distr/data/genome/grch38/Homo_sapiens.GRCh38.gff3.gz",
                            index: "http://ngb.opensource.epam.com/distr/data/genome/grch38/Homo_sapiens.GRCh38.gff3.gz.tbi",
                        }, {
                            path: "http://ngb.opensource.epam.com/distr/data/demo/ngb_demo_data/PIK3CA-E545K.bam",
                            index: "http://ngb.opensource.epam.com/distr/data/demo/ngb_demo_data/PIK3CA-E545K.bam.bai",
                        }, {
                            path: "http://ngb.opensource.epam.com/distr/data/genome/grch38/Homo_sapiens.GRCh38.domains.bed.gz",
                            index: "http://ngb.opensource.epam.com/distr/data/genome/grch38/Homo_sapiens.GRCh38.domains.bed.gz.tbi",
                        },
                    ],
                    referenceId: 1,
                    mode: loadTrackModeSelect.value
                }
            }, "*");
        } else {
            iframe.contentWindow.postMessage({
                callerId: guid(),
                method: "loadTrack",
                params: {
                    tracks: ['21','23','25'],
                    mode: loadTrackModeSelect.value
                }
            }, "*");
        }
    };

    btnSetGlobalSettings.onclick = function () {
        iframe.contentWindow.postMessage({
            callerId: guid(),
            method: "setGlobalSettings",
            params: globalSettings.value ? JSON.parse(globalSettings.value) : null
        }, "*");
    };

    btnSetTrackSettings.onclick = function () {
        iframe.contentWindow.postMessage({
            callerId: guid(),
            method: "setTrackSettings",
            params: trackSettings.value ? JSON.parse(trackSettings.value) : null
        }, "*");
    };

    typeTrackSelect.onchange = function () {
        switch (typeTrackSelect.value) {
            case 'vcf':
                trackSettings.value = JSON.stringify({
                    id: 23, // id or path "http://ngb.opensource.epam.com/distr/data/demo/ngb_demo_data/sample_1-lumpy.vcf.gz"
                    settings: [
                        {name: "vcf>variantsView>expanded"}
                    ]
                });
                break;
            case 'referense':
                trackSettings.value = JSON.stringify({
                    id: 5,
                    settings: [
                        {name: "reference>showTranslation", value: true},
                        {name: "reference>showForwardStrand", value: true},
                        {name: "reference>showReverseStrand", value: true}
                    ]
                });
                break;
            case 'wig':
                trackSettings.value = JSON.stringify({
                    id: 28,
                    settings: [
                        {
                            name: "coverage>scale>manual", value: true, extraOptions: {
                            from: 10,
                            to: 150
                        }
                        },
                        {name: "coverage>scale>log", value: true}
                    ]
                });
                break;
            case 'bam':
                trackSettings.value = JSON.stringify({
                    id: 43,
                    settings: [
                        {name: "bam>color>firstInPairStrand", value: true},
                        {name: "bam>color>shadeByQuality", value: true},

                        {name: "bam>group>firstInPairStrand", value: true},

                        {name: "bam>readsView>expanded"},
                        {name: "bam>readsView>pairs", value: true},

                        {name: "bam>sort>mappingQuality"},

                        {name: "bam>showAlignments", value: true},
                        {name: "bam>showMismatchedBases", value: true},
                        {name: "bam>showCoverage", value: true},
                        {name: "bam>showSpliceJunctions", value: true},

                        {name: "coverage>scale>default", value: false},
                        {
                            name: "coverage>scale>manual", value: true, extraOptions: {
                            from: 10,
                            to: 150
                        }
                        },
                        {name: "coverage>scale>log", value: true}
                    ]
                });
                break;
            case 'gene':
                trackSettings.value = JSON.stringify({
                    id: 59,
                    settings: [
                        {name: "gene>transcript>expanded"},
                        {name: "shortenIntrons", value: true}
                    ]
                });
                break;
        }
    };

    if (window.addEventListener) {
        window.addEventListener("message", () => {
            if (event.data) {
                console.log(event.data.callerId);
                console.log(event.data.message);
            }
        });
    } else {
        // IE8
        window.attachEvent("onmessage", () => {
            if (event.data) {
                console.log(event.data.callerId);
                console.log(event.data.message);
            }
        });
    }
</script>
</body>
</html>